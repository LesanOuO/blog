<!doctype html><html lang=zh-cn dir=auto><head><script src="/blog/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=blog/livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>SpringBoot+Rediså®ç°æ¥å£é™æµ | Lesan's Blog</title><meta name=keywords content="SpringBoot,Redis"><meta name=description content="Redis ä½œä¸º21ä¸–çºªæœ€æµè¡Œçš„ç¼“å­˜ä¸­é—´ä»¶ï¼Œå®ƒä¹Ÿèƒ½å¤Ÿå®ç°æ¥å£é™æµçš„ä½œç”¨ï¼Œæœ¬ç‰‡æ–‡ç« ä¸»è¦è®°å½•ä¸ªäººå®ç°è¿‡ç¨‹ã€‚
åœ¨åˆ†å¸ƒå¼é«˜å¹¶å‘ç³»ç»Ÿä¸­ï¼Œå¸¸å¸¸éœ€è¦ç”¨åˆ° ç¼“å­˜ ã€é™çº§ ã€ é™æµã€‚"><meta name=author content="Lesan"><link rel=canonical href=http://localhost:1313/blog/posts/operation/springboot+redis%E5%AE%9E%E7%8E%B0%E6%8E%A5%E5%8F%A3%E9%99%90%E6%B5%81/><link crossorigin=anonymous href=/blog/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=http://localhost:1313/blog/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://localhost:1313/blog/favicon.ico><link rel=icon type=image/png sizes=32x32 href=http://localhost:1313/blog/favicon.ico><link rel=apple-touch-icon href=http://localhost:1313/blog/favicon.ico><link rel=mask-icon href=http://localhost:1313/blog/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-cn href=http://localhost:1313/blog/posts/operation/springboot+redis%E5%AE%9E%E7%8E%B0%E6%8E%A5%E5%8F%A3%E9%99%90%E6%B5%81/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:url" content="http://localhost:1313/blog/posts/operation/springboot+redis%E5%AE%9E%E7%8E%B0%E6%8E%A5%E5%8F%A3%E9%99%90%E6%B5%81/"><meta property="og:site_name" content="Lesan's Blog"><meta property="og:title" content="SpringBoot+Rediså®ç°æ¥å£é™æµ"><meta property="og:description" content="Redis ä½œä¸º21ä¸–çºªæœ€æµè¡Œçš„ç¼“å­˜ä¸­é—´ä»¶ï¼Œå®ƒä¹Ÿèƒ½å¤Ÿå®ç°æ¥å£é™æµçš„ä½œç”¨ï¼Œæœ¬ç‰‡æ–‡ç« ä¸»è¦è®°å½•ä¸ªäººå®ç°è¿‡ç¨‹ã€‚
åœ¨åˆ†å¸ƒå¼é«˜å¹¶å‘ç³»ç»Ÿä¸­ï¼Œå¸¸å¸¸éœ€è¦ç”¨åˆ° ç¼“å­˜ ã€é™çº§ ã€ é™æµã€‚"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-26T00:00:00+00:00"><meta property="article:modified_time" content="2022-11-26T00:00:00+00:00"><meta property="article:tag" content="SpringBoot"><meta property="article:tag" content="Redis"><meta name=twitter:card content="summary"><meta name=twitter:title content="SpringBoot+Rediså®ç°æ¥å£é™æµ"><meta name=twitter:description content="Redis ä½œä¸º21ä¸–çºªæœ€æµè¡Œçš„ç¼“å­˜ä¸­é—´ä»¶ï¼Œå®ƒä¹Ÿèƒ½å¤Ÿå®ç°æ¥å£é™æµçš„ä½œç”¨ï¼Œæœ¬ç‰‡æ–‡ç« ä¸»è¦è®°å½•ä¸ªäººå®ç°è¿‡ç¨‹ã€‚
åœ¨åˆ†å¸ƒå¼é«˜å¹¶å‘ç³»ç»Ÿä¸­ï¼Œå¸¸å¸¸éœ€è¦ç”¨åˆ° ç¼“å­˜ ã€é™çº§ ã€ é™æµã€‚"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"ğŸ“š åšå®¢","item":"http://localhost:1313/blog/posts/"},{"@type":"ListItem","position":2,"name":"SpringBoot+Rediså®ç°æ¥å£é™æµ","item":"http://localhost:1313/blog/posts/operation/springboot+redis%E5%AE%9E%E7%8E%B0%E6%8E%A5%E5%8F%A3%E9%99%90%E6%B5%81/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"SpringBoot+Rediså®ç°æ¥å£é™æµ","name":"SpringBoot\u002bRediså®ç°æ¥å£é™æµ","description":"Redis ä½œä¸º21ä¸–çºªæœ€æµè¡Œçš„ç¼“å­˜ä¸­é—´ä»¶ï¼Œå®ƒä¹Ÿèƒ½å¤Ÿå®ç°æ¥å£é™æµçš„ä½œç”¨ï¼Œæœ¬ç‰‡æ–‡ç« ä¸»è¦è®°å½•ä¸ªäººå®ç°è¿‡ç¨‹ã€‚\nåœ¨åˆ†å¸ƒå¼é«˜å¹¶å‘ç³»ç»Ÿä¸­ï¼Œå¸¸å¸¸éœ€è¦ç”¨åˆ° ç¼“å­˜ ã€é™çº§ ã€ é™æµã€‚\n","keywords":["SpringBoot","Redis"],"articleBody":"Redis ä½œä¸º21ä¸–çºªæœ€æµè¡Œçš„ç¼“å­˜ä¸­é—´ä»¶ï¼Œå®ƒä¹Ÿèƒ½å¤Ÿå®ç°æ¥å£é™æµçš„ä½œç”¨ï¼Œæœ¬ç‰‡æ–‡ç« ä¸»è¦è®°å½•ä¸ªäººå®ç°è¿‡ç¨‹ã€‚\nåœ¨åˆ†å¸ƒå¼é«˜å¹¶å‘ç³»ç»Ÿä¸­ï¼Œå¸¸å¸¸éœ€è¦ç”¨åˆ° ç¼“å­˜ ã€é™çº§ ã€ é™æµã€‚\nç¼“å­˜ï¼šç¼“å­˜çš„ç›®çš„æ˜¯æå‡ç³»ç»Ÿè®¿é—®é€Ÿåº¦å’Œå¢å¤§ç³»ç»Ÿå¤„ç†å®¹é‡ é™çº§ï¼šé™çº§æ˜¯å½“æœåŠ¡å‡ºç°é—®é¢˜æˆ–è€…å½±å“åˆ°æ ¸å¿ƒæµç¨‹æ—¶ï¼Œéœ€è¦æš‚æ—¶å±è”½æ‰ï¼Œå¾…é«˜å³°æˆ–è€…é—®é¢˜è§£å†³åå†æ‰“å¼€ é™æµï¼šé™æµçš„ç›®çš„æ˜¯é€šè¿‡å¯¹å¹¶å‘è®¿é—®/è¯·æ±‚è¿›è¡Œé™é€Ÿï¼Œæˆ–è€…å¯¹ä¸€ä¸ªæ—¶é—´çª—å£å†…çš„è¯·æ±‚è¿›è¡Œé™é€Ÿæ¥ä¿æŠ¤ç³»ç»Ÿï¼Œä¸€æ—¦è¾¾åˆ°é™åˆ¶é€Ÿç‡åˆ™å¯ä»¥æ‹’ç»æœåŠ¡ã€æ’é˜Ÿæˆ–ç­‰å¾…ã€é™çº§ç­‰å¤„ç† å‡†å¤‡å·¥ä½œ Maven æ·»åŠ ä¾èµ– org.springframework.boot spring-boot-starter-data-redis org.springframework.boot spring-boot-starter-web org.springframework.boot spring-boot-starter-aop å®‰è£… Redis æœ¬æ–‡å°±ä¸å¤šèµ˜è¿°è¿™ä¸€éƒ¨åˆ†äº† QAQ\nSpring Boot ä¸­é›†æˆ Redis 1. åœ¨applicationé…ç½®æ–‡ä»¶ä¸­é…ç½®Redis # Redisæ•°æ®åº“ç´¢å¼•ï¼ˆé»˜è®¤ä¸º0ï¼‰ spring.redis.database=0 # RedisæœåŠ¡å™¨åœ°å€ spring.redis.host=127.0.0.1 # RedisæœåŠ¡å™¨è¿æ¥ç«¯å£ spring.redis.port=6379 # RedisæœåŠ¡å™¨è¿æ¥å¯†ç ï¼ˆé»˜è®¤ä¸ºç©ºï¼‰ spring.redis.password= # è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ spring.redis.timeout=1000 # è¿æ¥æ± æœ€å¤§è¿æ¥æ•°ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰ spring.redis.jedis.pool.max-active=20 # è¿æ¥æ± æœ€å¤§é˜»å¡ç­‰å¾…æ—¶é—´ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰ spring.redis.jedis.pool.max-wait=-1 # è¿æ¥æ± ä¸­çš„æœ€å¤§ç©ºé—²è¿æ¥ spring.redis.jedis.pool.max-idle=10 # è¿æ¥æ± ä¸­çš„æœ€å°ç©ºé—²è¿æ¥ spring.redis.jedis.pool.min-idle=0 2. é…ç½®RedisTemplate @Configuration @EnableCaching public class RedisConfig extends CachingConfigurerSupport { /** * RedisTemplateç›¸å…³é…ç½® * ä½¿redisæ”¯æŒæ’å…¥å¯¹è±¡ */ @Bean public RedisTemplate\u003cString, Object\u003e redisTemplate(RedisConnectionFactory factory) { RedisTemplate\u003cString, Object\u003e template = new RedisTemplate\u003c\u003e(); // é…ç½®è¿æ¥å·¥å‚ template.setConnectionFactory(factory); // è®¾ç½®keyçš„åºåˆ—åŒ–å™¨ template.setKeySerializer(new StringRedisSerializer()); // è®¾ç½®valueçš„åºåˆ—åŒ–å™¨ //ä½¿ç”¨Jackson 2ï¼Œå°†å¯¹è±¡åºåˆ—åŒ–ä¸ºJSON Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = new Jackson2JsonRedisSerializer(Object.class); //Jsonè½¬å¯¹è±¡ç±»ï¼Œä¸è®¾ç½®é»˜è®¤çš„ä¼šå°†Jsonè½¬æˆHashMap ObjectMapper om = new ObjectMapper(); om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY); om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL); jackson2JsonRedisSerializer.setObjectMapper(om); template.setValueSerializer(jackson2JsonRedisSerializer); return template; } } è‡ªæ­¤ï¼ŒSpring Boot å·²å®Œæˆé›†æˆRedisï¼Œå¯ä»¥é€šè¿‡ä¾èµ–æ³¨å…¥ä½¿ç”¨RedisTemplateï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n@Autowired private RedisTemplate\u003cString, Object\u003e redisTemplate; å®ç°é™æµï¼ˆæ–¹å¼1ï¼‰ 1. é™æµæ€è·¯ ç¼–å†™è‡ªå®šä¹‰æ³¨è§£ï¼Œä¸ºåç»­è¿‡æ»¤æ¥å£æä¾›æ ‡è¯† é€šè¿‡IP+æ–¹æ³•åä½œä¸ºkeyï¼Œè®¿é—®æ¬¡æ•°ä½œä¸ºvalueçš„æ–¹å¼å¯¹æŸä¸€ç”¨æˆ·çš„è¯·æ±‚è¿›è¡Œæ ‡è¯† æ¯æ¬¡è®¿é—®çš„æ—¶å€™åˆ¤æ–­keyæ˜¯å¦å­˜åœ¨ï¼Œcountæ˜¯å¦è¶…è¿‡é™åˆ¶çš„æ¬¡æ•° è‹¥è®¿é—®è¶…å‡ºé™åˆ¶ï¼Œåˆ™é€šè¿‡æ‹¦æˆªå™¨ç›´æ¥è¿”å›é”™è¯¯ä¿¡æ¯ï¼šè¯·æ±‚è¿‡äºé¢‘ç¹ 2. æ·»åŠ è‡ªå®šä¹‰æ³¨è§£ AccessLimit @Inherited @Documented @Retention(RetentionPolicy.RUNTIME) @Target(ElementType.METHOD) public @interface AccessLimit { /** * è¯·æ±‚æ¬¡æ•°çš„æŒ‡å®šæ—¶é—´èŒƒå›´ : ç§’æ•°(redisæ•°æ®è¿‡æœŸæ—¶é—´) */ int second() default 60; /** * æŒ‡å®šsecond æ—¶é—´å†… : APIè¯·æ±‚æ¬¡æ•° */ int maxCount() default 3; } 3. ç¼–å†™æ‹¦æˆªå™¨ @Slf4j @Component public class AccessLimitInterceptor implements HandlerInterceptor { @Autowired private RedisTemplate\u003cString, Object\u003e redisTemplate; @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception { // Handler æ˜¯å¦ä¸º HandlerMethod å®ä¾‹ if (handler instanceof HandlerMethod) { HandlerMethod handlerMethod = (HandlerMethod) handler; // è·å–æ–¹æ³• Method method = handlerMethod.getMethod(); // æ˜¯å¦æœ‰AccessLimitæ³¨è§£ if (!method.isAnnotationPresent(AccessLimit.class)) { return true; } // è·å–æ³¨è§£å†…å®¹ä¿¡æ¯ AccessLimit accessLimit = method.getAnnotation(AccessLimit.class); if (accessLimit == null) { return true; } // è·å–æ¬¡æ•°å’Œè¶…æ—¶ int seconds = accessLimit.second(); int maxCount = accessLimit.maxCount(); // å­˜å‚¨key String key = IpUtil.getIpAddr(request)+method.getName(); // ä»Redisä¸­è·å–ç”¨æˆ·å·²ç»è®¿é—®çš„æ¬¡æ•° try { Integer count = (Integer) redisTemplate.opsForValue().get(key); System.out.println(\"å·²ç»è®¿é—®çš„æ¬¡æ•°:\" + count); // Redisä¸å­˜åœ¨ç”¨æˆ·è®¿é—®è®°å½• if (null == count || -1 == count) { redisTemplate.opsForValue().set(key, 1, seconds, TimeUnit.SECONDS); return true; } if (count \u003c maxCount) { // è®¿é—®æ¬¡æ•°+1 redisTemplate.opsForValue().increment(key); return true; } if (count \u003e= maxCount) { // è¶…å‡ºè®¿é—®é™åˆ¶ response.setContentType(\"application/json;charset=UTF-8\"); OutputStream out = response.getOutputStream(); out.write(\"è¯·æ±‚è¿‡äºé¢‘ç¹è¯·ç¨åå†è¯•\".getBytes(\"UTF-8\")); out.flush(); out.close(); log.warn(\"è¯·æ±‚è¿‡äºé¢‘ç¹è¯·ç¨åå†è¯•\"); return false; } }catch (RedisConnectionFailureException e){ log.error(\"redis error\" + e.getMessage().toString()); return true; } } return true; } } 4. æ³¨å†Œæ‹¦æˆªå™¨ @Configuration public class IntercepterConfig implements WebMvcConfigurer { @Autowired private AccessLimitInterceptor accessLimitInterceptor; @Override public void addInterceptors(InterceptorRegistry registry) { registry.addInterceptor(accessLimitInterceptor) .addPathPatterns(\"/**\") // æ‹¦æˆªè·¯å¾„ .excludePathPatterns(\"/user/login\"); // ä¸æ‹¦æˆªè·¯å¾„ } } 5. é€šè¿‡AccessLimitæ³¨è§£æµ‹è¯•æœ€ç»ˆæ•ˆæœ @RestController public class TestController { @AccessLimit(second = 60,maxCount = 5) @GetMapping(\"test\") public String test(){ return \"TEST\"; } } å®ç°é™æµï¼ˆæ–¹å¼2ï¼‰ 1. é™æµæ³¨è§£ é¦–å…ˆéœ€è¦åˆ›å»ºä¸€ä¸ªé™æµæ³¨è§£ï¼Œé™æµå°†åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š\né’ˆå¯¹å½“å‰æ¥å£çš„å…¨å±€æ€§é™æµï¼Œä¾‹å¦‚è¯¥æ¥å£å¯ä»¥åœ¨ 1 åˆ†é’Ÿå†…è®¿é—® 100 æ¬¡ã€‚ é’ˆå¯¹æŸä¸€ä¸ª IP åœ°å€çš„é™æµï¼Œä¾‹å¦‚æŸä¸ª IP åœ°å€å¯ä»¥åœ¨ 1 åˆ†é’Ÿå†…è®¿é—® 100 æ¬¡ã€‚ é’ˆå¯¹è¿™ä¸¤ç§æƒ…å†µï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæšä¸¾ç±»ï¼š\npublic enum LimitType { /** * é»˜è®¤ç­–ç•¥å…¨å±€é™æµ */ DEFAULT, /** * æ ¹æ®è¯·æ±‚è€…IPè¿›è¡Œé™æµ */ IP } ä¸‹ä¸€æ­¥ï¼Œåˆ›å»ºé™æµæ³¨è§£ï¼š\n@Target(ElementType.METHOD) @Retention(RetentionPolicy.RUNTIME) @Documented public @interface RateLimiter { /** * é™æµkeyå‰ç¼€ */ String key() default \"rate_limit:\"; /** * é™æµæ—¶é—´,å•ä½ç§’ */ int time() default 60; /** * é™æµæ¬¡æ•° */ int count() default 100; /** * é™æµç±»å‹ */ LimitType limitType() default LimitType.DEFAULT; } 2. å®šåˆ¶ RedisTemplate åœ¨ Spring Boot ä¸­ï¼Œæˆ‘ä»¬å…¶å®æ›´ä¹ æƒ¯ä½¿ç”¨ Spring Data Redis æ¥æ“ä½œ Redisï¼Œä¸è¿‡é»˜è®¤çš„ RedisTemplate æœ‰ä¸€ä¸ªå°å‘ï¼Œå°±æ˜¯åºåˆ—åŒ–ç”¨çš„æ˜¯ JdkSerializationRedisSerializerï¼Œä¸çŸ¥é“å°ä¼™ä¼´ä»¬æœ‰æ²¡æœ‰æ³¨æ„è¿‡ï¼Œç›´æ¥ç”¨è¿™ä¸ªåºåˆ—åŒ–å·¥å…·å°†æ¥å­˜åˆ° Redis ä¸Šçš„ key å’Œ value éƒ½ä¼šè«åå…¶å¦™å¤šä¸€äº›å‰ç¼€ï¼Œè¿™å°±å¯¼è‡´ä½ ç”¨å‘½ä»¤è¯»å–çš„æ—¶å€™å¯èƒ½ä¼šå‡ºé”™ã€‚\nä¿®æ”¹ RedisTemplate åºåˆ—åŒ–æ–¹æ¡ˆï¼Œä»£ç å¦‚ä¸‹ï¼š\n@Configuration public class RedisConfig { @Bean public RedisTemplate\u003cObject, Object\u003e redisTemplate(RedisConnectionFactory connectionFactory) { RedisTemplate\u003cObject, Object\u003e redisTemplate = new RedisTemplate\u003c\u003e(); redisTemplate.setConnectionFactory(connectionFactory); // ä½¿ç”¨Jackson2JsonRedisSerialize æ›¿æ¢é»˜è®¤åºåˆ—åŒ–(é»˜è®¤é‡‡ç”¨çš„æ˜¯JDKåºåˆ—åŒ–) Jackson2JsonRedisSerializer\u003cObject\u003e jackson2JsonRedisSerializer = new Jackson2JsonRedisSerializer\u003c\u003e(Object.class); ObjectMapper om = new ObjectMapper(); om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY); om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL); jackson2JsonRedisSerializer.setObjectMapper(om); redisTemplate.setKeySerializer(jackson2JsonRedisSerializer); redisTemplate.setValueSerializer(jackson2JsonRedisSerializer); redisTemplate.setHashKeySerializer(jackson2JsonRedisSerializer); redisTemplate.setHashValueSerializer(jackson2JsonRedisSerializer); return redisTemplate; } } 3. å¼€å‘ Lua è„šæœ¬ Redis ä¸­çš„ä¸€äº›åŸå­æ“ä½œæˆ‘ä»¬å¯ä»¥å€ŸåŠ© Lua è„šæœ¬æ¥å®ç°ï¼Œæƒ³è¦è°ƒç”¨ Lua è„šæœ¬ï¼Œæˆ‘ä»¬æœ‰ä¸¤ç§ä¸åŒçš„æ€è·¯ï¼š\nåœ¨ Redis æœåŠ¡ç«¯å®šä¹‰å¥½ Lua è„šæœ¬ï¼Œç„¶åè®¡ç®—å‡ºæ¥ä¸€ä¸ªæ•£åˆ—å€¼ï¼Œåœ¨ Java ä»£ç ä¸­ï¼Œé€šè¿‡è¿™ä¸ªæ•£åˆ—å€¼é”å®šè¦æ‰§è¡Œå“ªä¸ª Lua è„šæœ¬ã€‚ ç›´æ¥åœ¨ Java ä»£ç ä¸­å°† Lua è„šæœ¬å®šä¹‰å¥½ï¼Œç„¶åå‘é€åˆ° Redis æœåŠ¡ç«¯å»æ‰§è¡Œã€‚ Spring Data Redis ä¸­ä¹Ÿæä¾›äº†æ“ä½œ Lua è„šæœ¬çš„æ¥å£ï¼Œè¿˜æ˜¯æ¯”è¾ƒæ–¹ä¾¿çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œå°±é‡‡ç”¨ç¬¬äºŒç§æ–¹æ¡ˆã€‚\nåœ¨ resources ç›®å½•ä¸‹æ–°å»º lua æ–‡ä»¶å¤¹ä¸“é—¨ç”¨æ¥å­˜æ”¾ lua è„šæœ¬ï¼Œè„šæœ¬å†…å®¹å¦‚ä¸‹ï¼š\nlocal key = KEYS[1] local count = tonumber(ARGV[1]) local time = tonumber(ARGV[2]) local current = redis.call('get', key) if current and tonumber(current) \u003e count then return tonumber(current) end current = redis.call('incr', key) if tonumber(current) == 1 then redis.call('expire', key, time) end return tonumber(current) KEYS å’Œ ARGV éƒ½æ˜¯ä¸€ä¼šè°ƒç”¨æ—¶å€™ä¼ è¿›æ¥çš„å‚æ•°ï¼Œtonumber å°±æ˜¯æŠŠå­—ç¬¦ä¸²è½¬ä¸ºæ•°å­—ï¼Œredis.call å°±æ˜¯æ‰§è¡Œå…·ä½“çš„ redis æŒ‡ä»¤ï¼Œå…·ä½“æµç¨‹æ˜¯è¿™æ ·ï¼š\né¦–å…ˆè·å–åˆ°ä¼ è¿›æ¥çš„ key ä»¥åŠ é™æµçš„ count å’Œæ—¶é—´ timeã€‚ é€šè¿‡ get è·å–åˆ°è¿™ä¸ª key å¯¹åº”çš„å€¼ï¼Œè¿™ä¸ªå€¼å°±æ˜¯å½“å‰æ—¶é—´çª—å†…è¿™ä¸ªæ¥å£å¯ä»¥è®¿é—®å¤šå°‘æ¬¡ã€‚ å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è®¿é—®ï¼Œæ­¤æ—¶æ‹¿åˆ°çš„ç»“æœä¸º nilï¼Œå¦åˆ™æ‹¿åˆ°çš„ç»“æœåº”è¯¥æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥å°±åˆ¤æ–­ï¼Œ å¦‚æœæ‹¿åˆ°çš„ç»“æœæ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå¹¶ä¸”è¿™ä¸ªæ•°å­—è¿˜å¤§äº countï¼Œé‚£å°±è¯´æ˜å·²ç»è¶…è¿‡æµé‡é™åˆ¶äº†ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›æŸ¥è¯¢çš„ç»“æœå³å¯ã€‚ å¦‚æœæ‹¿åˆ°çš„ç»“æœä¸º nilï¼Œè¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡è®¿é—®ï¼Œæ­¤æ—¶å°±ç»™å½“å‰ key è‡ªå¢ 1ï¼Œç„¶åè®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ã€‚ æœ€åæŠŠè‡ªå¢ 1 åçš„å€¼è¿”å›å°±å¯ä»¥äº†ã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬åœ¨ä¸€ä¸ª Bean ä¸­æ¥åŠ è½½è¿™æ®µ Lua è„šæœ¬ï¼Œå¦‚ä¸‹ï¼š\n@Bean public DefaultRedisScript\u003cLong\u003e limitScript() { DefaultRedisScript\u003cLong\u003e redisScript = new DefaultRedisScript\u003c\u003e(); redisScript.setScriptSource(new ResourceScriptSource(new ClassPathResource(\"lua/limit.lua\"))); redisScript.setResultType(Long.class); return redisScript; } 4. æ³¨è§£è§£æï¼ˆé€šè¿‡AspectJè‡ªå®šä¹‰åˆ‡é¢ï¼‰ @Aspect @Component public class RateLimiterAspect { private static final Logger log = LoggerFactory.getLogger(RateLimiterAspect.class); @Autowired private RedisTemplate\u003cObject, Object\u003e redisTemplate; @Autowired private RedisScript\u003cLong\u003e limitScript; @Before(\"@annotation(rateLimiter)\") public void doBefore(JoinPoint point, RateLimiter rateLimiter) throws Throwable { String key = rateLimiter.key(); int time = rateLimiter.time(); int count = rateLimiter.count(); String combineKey = getCombineKey(rateLimiter, point); List\u003cObject\u003e keys = Collections.singletonList(combineKey); try { Long number = redisTemplate.execute(limitScript, keys, count, time); if (number==null || number.intValue() \u003e count) { throw new ServiceException(\"è®¿é—®è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨å€™å†è¯•\"); } log.info(\"é™åˆ¶è¯·æ±‚'{}',å½“å‰è¯·æ±‚'{}',ç¼“å­˜key'{}'\", count, number.intValue(), key); } catch (ServiceException e) { throw e; } catch (Exception e) { throw new RuntimeException(\"æœåŠ¡å™¨é™æµå¼‚å¸¸ï¼Œè¯·ç¨å€™å†è¯•\"); } } public String getCombineKey(RateLimiter rateLimiter, JoinPoint point) { StringBuffer stringBuffer = new StringBuffer(rateLimiter.key()); if (rateLimiter.limitType() == LimitType.IP) { stringBuffer.append(IpUtils.getIpAddr(((ServletRequestAttributes) RequestContextHolder.currentRequestAttributes()).getRequest())).append(\"-\"); } MethodSignature signature = (MethodSignature) point.getSignature(); Method method = signature.getMethod(); Class\u003c?\u003e targetClass = method.getDeclaringClass(); stringBuffer.append(targetClass.getName()).append(\"-\").append(method.getName()); return stringBuffer.toString(); } } è¿™ä¸ªåˆ‡é¢å°±æ˜¯æ‹¦æˆªæ‰€æœ‰åŠ äº† @RateLimiter æ³¨è§£çš„æ–¹æ³•ï¼Œåœ¨å‰ç½®é€šçŸ¥ä¸­å¯¹æ³¨è§£è¿›è¡Œå¤„ç†ã€‚\né¦–å…ˆè·å–åˆ°æ³¨è§£ä¸­çš„ keyã€time ä»¥åŠ count ä¸‰ä¸ªå‚æ•°ã€‚ è·å–ä¸€ä¸ªç»„åˆçš„ keyï¼Œæ‰€è°“çš„ç»„åˆçš„ keyï¼Œå°±æ˜¯åœ¨æ³¨è§£çš„ key å±æ€§åŸºç¡€ä¸Šï¼Œå†åŠ ä¸Šæ–¹æ³•çš„å®Œæ•´è·¯å¾„ï¼Œå¦‚æœæ˜¯ IP æ¨¡å¼çš„è¯ï¼Œå°±å†åŠ ä¸Š IP åœ°å€ã€‚ä»¥ IP æ¨¡å¼ä¸ºä¾‹ï¼Œæœ€ç»ˆç”Ÿæˆçš„ key ç±»ä¼¼è¿™æ ·ï¼šrate_limit:127.0.0.1-com.demo.ratelimiter.controller.HelloController-helloï¼ˆå¦‚æœä¸æ˜¯ IP æ¨¡å¼ï¼Œé‚£ä¹ˆç”Ÿæˆçš„ key ä¸­å°±ä¸åŒ…å« IP åœ°å€ï¼‰ã€‚ å°†ç”Ÿæˆçš„ key æ”¾åˆ°é›†åˆä¸­ã€‚ é€šè¿‡ redisTemplate.execute æ–¹æ³•å–æ‰§è¡Œä¸€ä¸ª Lua è„šæœ¬ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è„šæœ¬æ‰€å°è£…çš„å¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ keyï¼Œå¯¹åº”äº†è„šæœ¬ä¸­çš„ KEYSï¼Œåé¢æ˜¯å¯å˜é•¿åº¦çš„å‚æ•°ï¼Œå¯¹åº”äº†è„šæœ¬ä¸­çš„ ARGVã€‚ å°† Lua è„šæœ¬æ‰§è¡Œçš„ç»“æœä¸ count è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå¤§äº countï¼Œå°±è¯´æ˜è¿‡è½½äº†ï¼ŒæŠ›å¼‚å¸¸å°±è¡Œäº†ã€‚ 5. æ¥å£æµ‹è¯• @RestController public class HelloController { @GetMapping(\"/hello\") @RateLimiter(time = 5,count = 3,limitType = LimitType.IP) public String hello() { return \"hello\u003e\u003e\u003e\"+new Date(); } } æ¯ä¸€ä¸ª IP åœ°å€ï¼Œåœ¨ 5 ç§’å†…åªèƒ½è®¿é—® 3 æ¬¡ã€‚\n","wordCount":"3075","inLanguage":"zh-cn","datePublished":"2022-11-26T00:00:00Z","dateModified":"2022-11-26T00:00:00Z","author":{"@type":"Person","name":"Lesan"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:1313/blog/posts/operation/springboot+redis%E5%AE%9E%E7%8E%B0%E6%8E%A5%E5%8F%A3%E9%99%90%E6%B5%81/"},"publisher":{"@type":"Organization","name":"Lesan's Blog","logo":{"@type":"ImageObject","url":"http://localhost:1313/blog/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://localhost:1313/blog/ accesskey=h title="Lesan's Blog (Alt + H)">Lesan's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://localhost:1313/blog/archives title="ğŸ“š å½’æ¡£"><span>ğŸ“š å½’æ¡£</span></a></li><li><a href=http://localhost:1313/blog/categories/ title="ğŸ—ƒï¸ åˆ†ç±»"><span>ğŸ—ƒï¸ åˆ†ç±»</span></a></li><li><a href=http://localhost:1313/blog/tags/ title="ğŸ·ï¸ æ ‡ç­¾"><span>ğŸ·ï¸ æ ‡ç­¾</span></a></li><li><a href=http://localhost:1313/blog/search/ title="ğŸ” æœç´¢"><span>ğŸ” æœç´¢</span></a></li><li><a href=http://localhost:1313/blog/about/ title="ğŸ‘¨â€ğŸ’» å…³äºæˆ‘"><span>ğŸ‘¨â€ğŸ’» å…³äºæˆ‘</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://localhost:1313/blog/>Home</a>&nbsp;Â»&nbsp;<a href=http://localhost:1313/blog/posts/>ğŸ“š åšå®¢</a></div><h1 class="post-title entry-hint-parent">SpringBoot+Rediså®ç°æ¥å£é™æµ</h1><div class=post-meta><span title='2022-11-26 00:00:00 +0000 UTC'>2022-11-26</span>&nbsp;Â·&nbsp;7 min&nbsp;Â·&nbsp;Lesan</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%87%86%e5%a4%87%e5%b7%a5%e4%bd%9c aria-label=å‡†å¤‡å·¥ä½œ>å‡†å¤‡å·¥ä½œ</a><ul><li><a href=#maven-%e6%b7%bb%e5%8a%a0%e4%be%9d%e8%b5%96 aria-label="Maven æ·»åŠ ä¾èµ–">Maven æ·»åŠ ä¾èµ–</a></li><li><a href=#%e5%ae%89%e8%a3%85-redis aria-label="å®‰è£… Redis">å®‰è£… Redis</a></li></ul></li><li><a href=#spring-boot-%e4%b8%ad%e9%9b%86%e6%88%90-redis aria-label="Spring Boot ä¸­é›†æˆ Redis">Spring Boot ä¸­é›†æˆ Redis</a><ul><li><a href=#1-%e5%9c%a8application%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e4%b8%ad%e9%85%8d%e7%bd%aeredis aria-label="1. åœ¨applicationé…ç½®æ–‡ä»¶ä¸­é…ç½®Redis">1. åœ¨applicationé…ç½®æ–‡ä»¶ä¸­é…ç½®Redis</a></li><li><a href=#2-%e9%85%8d%e7%bd%aeredistemplate aria-label="2. é…ç½®RedisTemplate">2. é…ç½®RedisTemplate</a></li></ul></li><li><a href=#%e5%ae%9e%e7%8e%b0%e9%99%90%e6%b5%81%e6%96%b9%e5%bc%8f1 aria-label=å®ç°é™æµï¼ˆæ–¹å¼1ï¼‰>å®ç°é™æµï¼ˆæ–¹å¼1ï¼‰</a><ul><li><a href=#1-%e9%99%90%e6%b5%81%e6%80%9d%e8%b7%af aria-label="1. é™æµæ€è·¯">1. é™æµæ€è·¯</a></li><li><a href=#2-%e6%b7%bb%e5%8a%a0%e8%87%aa%e5%ae%9a%e4%b9%89%e6%b3%a8%e8%a7%a3-accesslimit aria-label="2. æ·»åŠ è‡ªå®šä¹‰æ³¨è§£ AccessLimit">2. æ·»åŠ è‡ªå®šä¹‰æ³¨è§£ AccessLimit</a></li><li><a href=#3-%e7%bc%96%e5%86%99%e6%8b%a6%e6%88%aa%e5%99%a8 aria-label="3. ç¼–å†™æ‹¦æˆªå™¨">3. ç¼–å†™æ‹¦æˆªå™¨</a></li><li><a href=#4-%e6%b3%a8%e5%86%8c%e6%8b%a6%e6%88%aa%e5%99%a8 aria-label="4. æ³¨å†Œæ‹¦æˆªå™¨">4. æ³¨å†Œæ‹¦æˆªå™¨</a></li><li><a href=#5-%e9%80%9a%e8%bf%87accesslimit%e6%b3%a8%e8%a7%a3%e6%b5%8b%e8%af%95%e6%9c%80%e7%bb%88%e6%95%88%e6%9e%9c aria-label="5. é€šè¿‡AccessLimitæ³¨è§£æµ‹è¯•æœ€ç»ˆæ•ˆæœ">5. é€šè¿‡AccessLimitæ³¨è§£æµ‹è¯•æœ€ç»ˆæ•ˆæœ</a></li></ul></li><li><a href=#%e5%ae%9e%e7%8e%b0%e9%99%90%e6%b5%81%e6%96%b9%e5%bc%8f2 aria-label=å®ç°é™æµï¼ˆæ–¹å¼2ï¼‰>å®ç°é™æµï¼ˆæ–¹å¼2ï¼‰</a><ul><li><a href=#1-%e9%99%90%e6%b5%81%e6%b3%a8%e8%a7%a3 aria-label="1. é™æµæ³¨è§£">1. é™æµæ³¨è§£</a></li><li><a href=#2-%e5%ae%9a%e5%88%b6-redistemplate aria-label="2. å®šåˆ¶ RedisTemplate">2. å®šåˆ¶ RedisTemplate</a></li><li><a href=#3-%e5%bc%80%e5%8f%91-lua-%e8%84%9a%e6%9c%ac aria-label="3. å¼€å‘ Lua è„šæœ¬">3. å¼€å‘ Lua è„šæœ¬</a></li><li><a href=#4-%e6%b3%a8%e8%a7%a3%e8%a7%a3%e6%9e%90%e9%80%9a%e8%bf%87aspectj%e8%87%aa%e5%ae%9a%e4%b9%89%e5%88%87%e9%9d%a2 aria-label="4. æ³¨è§£è§£æï¼ˆé€šè¿‡AspectJè‡ªå®šä¹‰åˆ‡é¢ï¼‰">4. æ³¨è§£è§£æï¼ˆé€šè¿‡AspectJè‡ªå®šä¹‰åˆ‡é¢ï¼‰</a></li><li><a href=#5-%e6%8e%a5%e5%8f%a3%e6%b5%8b%e8%af%95 aria-label="5. æ¥å£æµ‹è¯•">5. æ¥å£æµ‹è¯•</a></li></ul></li></ul></div></details></div><div class=post-content><p>Redis ä½œä¸º21ä¸–çºªæœ€æµè¡Œçš„ç¼“å­˜ä¸­é—´ä»¶ï¼Œå®ƒä¹Ÿèƒ½å¤Ÿå®ç°æ¥å£é™æµçš„ä½œç”¨ï¼Œæœ¬ç‰‡æ–‡ç« ä¸»è¦è®°å½•ä¸ªäººå®ç°è¿‡ç¨‹ã€‚</p><p>åœ¨åˆ†å¸ƒå¼é«˜å¹¶å‘ç³»ç»Ÿä¸­ï¼Œå¸¸å¸¸éœ€è¦ç”¨åˆ° <code>ç¼“å­˜</code> ã€<code>é™çº§</code> ã€ <code>é™æµ</code>ã€‚</p><ul><li>ç¼“å­˜ï¼šç¼“å­˜çš„ç›®çš„æ˜¯æå‡ç³»ç»Ÿè®¿é—®é€Ÿåº¦å’Œå¢å¤§ç³»ç»Ÿå¤„ç†å®¹é‡</li><li>é™çº§ï¼šé™çº§æ˜¯å½“æœåŠ¡å‡ºç°é—®é¢˜æˆ–è€…å½±å“åˆ°æ ¸å¿ƒæµç¨‹æ—¶ï¼Œéœ€è¦æš‚æ—¶å±è”½æ‰ï¼Œå¾…é«˜å³°æˆ–è€…é—®é¢˜è§£å†³åå†æ‰“å¼€</li><li>é™æµï¼šé™æµçš„ç›®çš„æ˜¯é€šè¿‡å¯¹å¹¶å‘è®¿é—®/è¯·æ±‚è¿›è¡Œé™é€Ÿï¼Œæˆ–è€…å¯¹ä¸€ä¸ªæ—¶é—´çª—å£å†…çš„è¯·æ±‚è¿›è¡Œé™é€Ÿæ¥ä¿æŠ¤ç³»ç»Ÿï¼Œä¸€æ—¦è¾¾åˆ°é™åˆ¶é€Ÿç‡åˆ™å¯ä»¥æ‹’ç»æœåŠ¡ã€æ’é˜Ÿæˆ–ç­‰å¾…ã€é™çº§ç­‰å¤„ç†</li></ul><h2 id=å‡†å¤‡å·¥ä½œ>å‡†å¤‡å·¥ä½œ<a hidden class=anchor aria-hidden=true href=#å‡†å¤‡å·¥ä½œ>#</a></h2><h3 id=maven-æ·»åŠ ä¾èµ–>Maven æ·»åŠ ä¾èµ–<a hidden class=anchor aria-hidden=true href=#maven-æ·»åŠ ä¾èµ–>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>   <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>   <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-web<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl><span class=c>&lt;!-- æ–¹å¼2éœ€è¦ç”¨åˆ° --&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-aop<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div><h3 id=å®‰è£…-redis>å®‰è£… Redis<a hidden class=anchor aria-hidden=true href=#å®‰è£…-redis>#</a></h3><p>æœ¬æ–‡å°±ä¸å¤šèµ˜è¿°è¿™ä¸€éƒ¨åˆ†äº† QAQ</p><h2 id=spring-boot-ä¸­é›†æˆ-redis>Spring Boot ä¸­é›†æˆ Redis<a hidden class=anchor aria-hidden=true href=#spring-boot-ä¸­é›†æˆ-redis>#</a></h2><h3 id=1-åœ¨applicationé…ç½®æ–‡ä»¶ä¸­é…ç½®redis>1. åœ¨applicationé…ç½®æ–‡ä»¶ä¸­é…ç½®Redis<a hidden class=anchor aria-hidden=true href=#1-åœ¨applicationé…ç½®æ–‡ä»¶ä¸­é…ç½®redis>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=c1># Redisæ•°æ®åº“ç´¢å¼•ï¼ˆé»˜è®¤ä¸º0ï¼‰</span>
</span></span><span class=line><span class=cl><span class=na>spring.redis.database</span><span class=o>=</span><span class=s>0</span>
</span></span><span class=line><span class=cl><span class=c1># RedisæœåŠ¡å™¨åœ°å€</span>
</span></span><span class=line><span class=cl><span class=na>spring.redis.host</span><span class=o>=</span><span class=s>127.0.0.1</span>
</span></span><span class=line><span class=cl><span class=c1># RedisæœåŠ¡å™¨è¿æ¥ç«¯å£</span>
</span></span><span class=line><span class=cl><span class=na>spring.redis.port</span><span class=o>=</span><span class=s>6379</span>
</span></span><span class=line><span class=cl><span class=c1># RedisæœåŠ¡å™¨è¿æ¥å¯†ç ï¼ˆé»˜è®¤ä¸ºç©ºï¼‰</span>
</span></span><span class=line><span class=cl><span class=na>spring.redis.password</span><span class=o>=</span>
</span></span><span class=line><span class=cl><span class=c1># è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</span>
</span></span><span class=line><span class=cl><span class=na>spring.redis.timeout</span><span class=o>=</span><span class=s>1000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è¿æ¥æ± æœ€å¤§è¿æ¥æ•°ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰</span>
</span></span><span class=line><span class=cl><span class=na>spring.redis.jedis.pool.max-active</span><span class=o>=</span><span class=s>20</span>
</span></span><span class=line><span class=cl><span class=c1># è¿æ¥æ± æœ€å¤§é˜»å¡ç­‰å¾…æ—¶é—´ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰</span>
</span></span><span class=line><span class=cl><span class=na>spring.redis.jedis.pool.max-wait</span><span class=o>=</span><span class=s>-1</span>
</span></span><span class=line><span class=cl><span class=c1># è¿æ¥æ± ä¸­çš„æœ€å¤§ç©ºé—²è¿æ¥</span>
</span></span><span class=line><span class=cl><span class=na>spring.redis.jedis.pool.max-idle</span><span class=o>=</span><span class=s>10</span>
</span></span><span class=line><span class=cl><span class=c1># è¿æ¥æ± ä¸­çš„æœ€å°ç©ºé—²è¿æ¥</span>
</span></span><span class=line><span class=cl><span class=na>spring.redis.jedis.pool.min-idle</span><span class=o>=</span><span class=s>0</span>
</span></span></code></pre></div><h3 id=2-é…ç½®redistemplate>2. é…ç½®RedisTemplate<a hidden class=anchor aria-hidden=true href=#2-é…ç½®redistemplate>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@EnableCaching</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>RedisConfig</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>CachingConfigurerSupport</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * RedisTemplateç›¸å…³é…ç½®
</span></span></span><span class=line><span class=cl><span class=cm>     * ä½¿redisæ”¯æŒæ’å…¥å¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>RedisTemplate</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=nf>redisTemplate</span><span class=p>(</span><span class=n>RedisConnectionFactory</span><span class=w> </span><span class=n>factory</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>RedisTemplate</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>template</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RedisTemplate</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// é…ç½®è¿æ¥å·¥å‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>template</span><span class=p>.</span><span class=na>setConnectionFactory</span><span class=p>(</span><span class=n>factory</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è®¾ç½®keyçš„åºåˆ—åŒ–å™¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>template</span><span class=p>.</span><span class=na>setKeySerializer</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>StringRedisSerializer</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è®¾ç½®valueçš„åºåˆ—åŒ–å™¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//ä½¿ç”¨Jackson 2ï¼Œå°†å¯¹è±¡åºåˆ—åŒ–ä¸ºJSON</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Jackson2JsonRedisSerializer</span><span class=w> </span><span class=n>jackson2JsonRedisSerializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Jackson2JsonRedisSerializer</span><span class=p>(</span><span class=n>Object</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//Jsonè½¬å¯¹è±¡ç±»ï¼Œä¸è®¾ç½®é»˜è®¤çš„ä¼šå°†Jsonè½¬æˆHashMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ObjectMapper</span><span class=w> </span><span class=n>om</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ObjectMapper</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>om</span><span class=p>.</span><span class=na>setVisibility</span><span class=p>(</span><span class=n>PropertyAccessor</span><span class=p>.</span><span class=na>ALL</span><span class=p>,</span><span class=w> </span><span class=n>JsonAutoDetect</span><span class=p>.</span><span class=na>Visibility</span><span class=p>.</span><span class=na>ANY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>om</span><span class=p>.</span><span class=na>enableDefaultTyping</span><span class=p>(</span><span class=n>ObjectMapper</span><span class=p>.</span><span class=na>DefaultTyping</span><span class=p>.</span><span class=na>NON_FINAL</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>jackson2JsonRedisSerializer</span><span class=p>.</span><span class=na>setObjectMapper</span><span class=p>(</span><span class=n>om</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>template</span><span class=p>.</span><span class=na>setValueSerializer</span><span class=p>(</span><span class=n>jackson2JsonRedisSerializer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>template</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>è‡ªæ­¤ï¼ŒSpring Boot å·²å®Œæˆé›†æˆRedisï¼Œå¯ä»¥é€šè¿‡ä¾èµ–æ³¨å…¥ä½¿ç”¨<code>RedisTemplate</code>ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=n>RedisTemplate</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h2 id=å®ç°é™æµæ–¹å¼1>å®ç°é™æµï¼ˆæ–¹å¼1ï¼‰<a hidden class=anchor aria-hidden=true href=#å®ç°é™æµæ–¹å¼1>#</a></h2><h3 id=1-é™æµæ€è·¯>1. é™æµæ€è·¯<a hidden class=anchor aria-hidden=true href=#1-é™æµæ€è·¯>#</a></h3><ul><li>ç¼–å†™è‡ªå®šä¹‰æ³¨è§£ï¼Œä¸ºåç»­è¿‡æ»¤æ¥å£æä¾›æ ‡è¯†</li><li>é€šè¿‡IP+æ–¹æ³•åä½œä¸ºkeyï¼Œè®¿é—®æ¬¡æ•°ä½œä¸ºvalueçš„æ–¹å¼å¯¹æŸä¸€ç”¨æˆ·çš„è¯·æ±‚è¿›è¡Œæ ‡è¯†</li><li>æ¯æ¬¡è®¿é—®çš„æ—¶å€™åˆ¤æ–­keyæ˜¯å¦å­˜åœ¨ï¼Œcountæ˜¯å¦è¶…è¿‡é™åˆ¶çš„æ¬¡æ•°</li><li>è‹¥è®¿é—®è¶…å‡ºé™åˆ¶ï¼Œåˆ™é€šè¿‡æ‹¦æˆªå™¨ç›´æ¥è¿”å›é”™è¯¯ä¿¡æ¯ï¼šè¯·æ±‚è¿‡äºé¢‘ç¹</li></ul><h3 id=2-æ·»åŠ è‡ªå®šä¹‰æ³¨è§£-accesslimit>2. æ·»åŠ è‡ªå®šä¹‰æ³¨è§£ <code>AccessLimit</code><a hidden class=anchor aria-hidden=true href=#2-æ·»åŠ è‡ªå®šä¹‰æ³¨è§£-accesslimit>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Inherited</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Documented</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Retention</span><span class=p>(</span><span class=n>RetentionPolicy</span><span class=p>.</span><span class=na>RUNTIME</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Target</span><span class=p>(</span><span class=n>ElementType</span><span class=p>.</span><span class=na>METHOD</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=nd>@interface</span><span class=w> </span><span class=n>AccessLimit</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è¯·æ±‚æ¬¡æ•°çš„æŒ‡å®šæ—¶é—´èŒƒå›´ : ç§’æ•°(redisæ•°æ®è¿‡æœŸæ—¶é—´)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=nf>second</span><span class=p>()</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=n>60</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æŒ‡å®šsecond æ—¶é—´å†… : APIè¯·æ±‚æ¬¡æ•°
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=nf>maxCount</span><span class=p>()</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=n>3</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=3-ç¼–å†™æ‹¦æˆªå™¨>3. ç¼–å†™æ‹¦æˆªå™¨<a hidden class=anchor aria-hidden=true href=#3-ç¼–å†™æ‹¦æˆªå™¨>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AccessLimitInterceptor</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>HandlerInterceptor</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>RedisTemplate</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>preHandle</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>handler</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Handler æ˜¯å¦ä¸º HandlerMethod å®ä¾‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>handler</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>HandlerMethod</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>HandlerMethod</span><span class=w> </span><span class=n>handlerMethod</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>HandlerMethod</span><span class=p>)</span><span class=w> </span><span class=n>handler</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// è·å–æ–¹æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Method</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>handlerMethod</span><span class=p>.</span><span class=na>getMethod</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// æ˜¯å¦æœ‰AccessLimitæ³¨è§£</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>method</span><span class=p>.</span><span class=na>isAnnotationPresent</span><span class=p>(</span><span class=n>AccessLimit</span><span class=p>.</span><span class=na>class</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// è·å–æ³¨è§£å†…å®¹ä¿¡æ¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>AccessLimit</span><span class=w> </span><span class=n>accessLimit</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>method</span><span class=p>.</span><span class=na>getAnnotation</span><span class=p>(</span><span class=n>AccessLimit</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>accessLimit</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// è·å–æ¬¡æ•°å’Œè¶…æ—¶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>seconds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>accessLimit</span><span class=p>.</span><span class=na>second</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>maxCount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>accessLimit</span><span class=p>.</span><span class=na>maxCount</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å­˜å‚¨key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>IpUtil</span><span class=p>.</span><span class=na>getIpAddr</span><span class=p>(</span><span class=n>request</span><span class=p>)</span><span class=o>+</span><span class=n>method</span><span class=p>.</span><span class=na>getName</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// ä»Redisä¸­è·å–ç”¨æˆ·å·²ç»è®¿é—®çš„æ¬¡æ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Integer</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Integer</span><span class=p>)</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForValue</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;å·²ç»è®¿é—®çš„æ¬¡æ•°:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>count</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Redisä¸å­˜åœ¨ç”¨æˆ·è®¿é—®è®°å½•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=kc>null</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>count</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForValue</span><span class=p>().</span><span class=na>set</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>seconds</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>count</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>maxCount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// è®¿é—®æ¬¡æ•°+1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForValue</span><span class=p>().</span><span class=na>increment</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>count</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>maxCount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// è¶…å‡ºè®¿é—®é™åˆ¶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>response</span><span class=p>.</span><span class=na>setContentType</span><span class=p>(</span><span class=s>&#34;application/json;charset=UTF-8&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>OutputStream</span><span class=w> </span><span class=n>out</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>response</span><span class=p>.</span><span class=na>getOutputStream</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>out</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=s>&#34;è¯·æ±‚è¿‡äºé¢‘ç¹è¯·ç¨åå†è¯•&#34;</span><span class=p>.</span><span class=na>getBytes</span><span class=p>(</span><span class=s>&#34;UTF-8&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>out</span><span class=p>.</span><span class=na>flush</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>out</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&#34;è¯·æ±‚è¿‡äºé¢‘ç¹è¯·ç¨åå†è¯•&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RedisConnectionFailureException</span><span class=w> </span><span class=n>e</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;redis error&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>().</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=4-æ³¨å†Œæ‹¦æˆªå™¨>4. æ³¨å†Œæ‹¦æˆªå™¨<a hidden class=anchor aria-hidden=true href=#4-æ³¨å†Œæ‹¦æˆªå™¨>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>IntercepterConfig</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>WebMvcConfigurer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>AccessLimitInterceptor</span><span class=w> </span><span class=n>accessLimitInterceptor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>addInterceptors</span><span class=p>(</span><span class=n>InterceptorRegistry</span><span class=w> </span><span class=n>registry</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>registry</span><span class=p>.</span><span class=na>addInterceptor</span><span class=p>(</span><span class=n>accessLimitInterceptor</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>addPathPatterns</span><span class=p>(</span><span class=s>&#34;/**&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>// æ‹¦æˆªè·¯å¾„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>excludePathPatterns</span><span class=p>(</span><span class=s>&#34;/user/login&#34;</span><span class=p>);</span><span class=w> </span><span class=c1>// ä¸æ‹¦æˆªè·¯å¾„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=5-é€šè¿‡accesslimitæ³¨è§£æµ‹è¯•æœ€ç»ˆæ•ˆæœ>5. é€šè¿‡<code>AccessLimit</code>æ³¨è§£æµ‹è¯•æœ€ç»ˆæ•ˆæœ<a hidden class=anchor aria-hidden=true href=#5-é€šè¿‡accesslimitæ³¨è§£æµ‹è¯•æœ€ç»ˆæ•ˆæœ>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RestController</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TestController</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@AccessLimit</span><span class=p>(</span><span class=n>second</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>60</span><span class=p>,</span><span class=n>maxCount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>5</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;test&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>test</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&#34;TEST&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=å®ç°é™æµæ–¹å¼2>å®ç°é™æµï¼ˆæ–¹å¼2ï¼‰<a hidden class=anchor aria-hidden=true href=#å®ç°é™æµæ–¹å¼2>#</a></h2><h3 id=1-é™æµæ³¨è§£>1. é™æµæ³¨è§£<a hidden class=anchor aria-hidden=true href=#1-é™æµæ³¨è§£>#</a></h3><p>é¦–å…ˆéœ€è¦åˆ›å»ºä¸€ä¸ªé™æµæ³¨è§£ï¼Œé™æµå°†åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š</p><ol><li>é’ˆå¯¹å½“å‰æ¥å£çš„å…¨å±€æ€§é™æµï¼Œä¾‹å¦‚è¯¥æ¥å£å¯ä»¥åœ¨ 1 åˆ†é’Ÿå†…è®¿é—® 100 æ¬¡ã€‚</li><li>é’ˆå¯¹æŸä¸€ä¸ª IP åœ°å€çš„é™æµï¼Œä¾‹å¦‚æŸä¸ª IP åœ°å€å¯ä»¥åœ¨ 1 åˆ†é’Ÿå†…è®¿é—® 100 æ¬¡ã€‚</li></ol><p>é’ˆå¯¹è¿™ä¸¤ç§æƒ…å†µï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæšä¸¾ç±»ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>enum</span><span class=w> </span><span class=n>LimitType</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * é»˜è®¤ç­–ç•¥å…¨å±€é™æµ
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DEFAULT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æ ¹æ®è¯·æ±‚è€…IPè¿›è¡Œé™æµ
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>IP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>ä¸‹ä¸€æ­¥ï¼Œåˆ›å»ºé™æµæ³¨è§£ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Target</span><span class=p>(</span><span class=n>ElementType</span><span class=p>.</span><span class=na>METHOD</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Retention</span><span class=p>(</span><span class=n>RetentionPolicy</span><span class=p>.</span><span class=na>RUNTIME</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Documented</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=nd>@interface</span><span class=w> </span><span class=n>RateLimiter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * é™æµkeyå‰ç¼€
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=nf>key</span><span class=p>()</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=s>&#34;rate_limit:&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * é™æµæ—¶é—´,å•ä½ç§’
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=nf>time</span><span class=p>()</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=n>60</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * é™æµæ¬¡æ•°
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=nf>count</span><span class=p>()</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=n>100</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * é™æµç±»å‹
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LimitType</span><span class=w> </span><span class=nf>limitType</span><span class=p>()</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=n>LimitType</span><span class=p>.</span><span class=na>DEFAULT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=2-å®šåˆ¶-redistemplate>2. å®šåˆ¶ RedisTemplate<a hidden class=anchor aria-hidden=true href=#2-å®šåˆ¶-redistemplate>#</a></h3><p>åœ¨ <code>Spring Boot</code> ä¸­ï¼Œæˆ‘ä»¬å…¶å®æ›´ä¹ æƒ¯ä½¿ç”¨ <code>Spring Data Redis</code> æ¥æ“ä½œ <code>Redis</code>ï¼Œä¸è¿‡é»˜è®¤çš„ <code>RedisTemplate</code> æœ‰ä¸€ä¸ªå°å‘ï¼Œå°±æ˜¯åºåˆ—åŒ–ç”¨çš„æ˜¯ <code>JdkSerializationRedisSerializer</code>ï¼Œä¸çŸ¥é“å°ä¼™ä¼´ä»¬æœ‰æ²¡æœ‰æ³¨æ„è¿‡ï¼Œç›´æ¥ç”¨è¿™ä¸ªåºåˆ—åŒ–å·¥å…·å°†æ¥å­˜åˆ° <code>Redis</code> ä¸Šçš„ <code>key</code> å’Œ <code>value</code> éƒ½ä¼šè«åå…¶å¦™å¤šä¸€äº›å‰ç¼€ï¼Œè¿™å°±å¯¼è‡´ä½ ç”¨å‘½ä»¤è¯»å–çš„æ—¶å€™å¯èƒ½ä¼šå‡ºé”™ã€‚</p><p>ä¿®æ”¹ <code>RedisTemplate</code> åºåˆ—åŒ–æ–¹æ¡ˆï¼Œä»£ç å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>RedisConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>RedisTemplate</span><span class=o>&lt;</span><span class=n>Object</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=nf>redisTemplate</span><span class=p>(</span><span class=n>RedisConnectionFactory</span><span class=w> </span><span class=n>connectionFactory</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>RedisTemplate</span><span class=o>&lt;</span><span class=n>Object</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>redisTemplate</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RedisTemplate</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>setConnectionFactory</span><span class=p>(</span><span class=n>connectionFactory</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ä½¿ç”¨Jackson2JsonRedisSerialize æ›¿æ¢é»˜è®¤åºåˆ—åŒ–(é»˜è®¤é‡‡ç”¨çš„æ˜¯JDKåºåˆ—åŒ–)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Jackson2JsonRedisSerializer</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>jackson2JsonRedisSerializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Jackson2JsonRedisSerializer</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>Object</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ObjectMapper</span><span class=w> </span><span class=n>om</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ObjectMapper</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>om</span><span class=p>.</span><span class=na>setVisibility</span><span class=p>(</span><span class=n>PropertyAccessor</span><span class=p>.</span><span class=na>ALL</span><span class=p>,</span><span class=w> </span><span class=n>JsonAutoDetect</span><span class=p>.</span><span class=na>Visibility</span><span class=p>.</span><span class=na>ANY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>om</span><span class=p>.</span><span class=na>enableDefaultTyping</span><span class=p>(</span><span class=n>ObjectMapper</span><span class=p>.</span><span class=na>DefaultTyping</span><span class=p>.</span><span class=na>NON_FINAL</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>jackson2JsonRedisSerializer</span><span class=p>.</span><span class=na>setObjectMapper</span><span class=p>(</span><span class=n>om</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>setKeySerializer</span><span class=p>(</span><span class=n>jackson2JsonRedisSerializer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>setValueSerializer</span><span class=p>(</span><span class=n>jackson2JsonRedisSerializer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>setHashKeySerializer</span><span class=p>(</span><span class=n>jackson2JsonRedisSerializer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>setHashValueSerializer</span><span class=p>(</span><span class=n>jackson2JsonRedisSerializer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=3-å¼€å‘-lua-è„šæœ¬>3. å¼€å‘ Lua è„šæœ¬<a hidden class=anchor aria-hidden=true href=#3-å¼€å‘-lua-è„šæœ¬>#</a></h3><p>Redis ä¸­çš„ä¸€äº›åŸå­æ“ä½œæˆ‘ä»¬å¯ä»¥å€ŸåŠ© Lua è„šæœ¬æ¥å®ç°ï¼Œæƒ³è¦è°ƒç”¨ Lua è„šæœ¬ï¼Œæˆ‘ä»¬æœ‰ä¸¤ç§ä¸åŒçš„æ€è·¯ï¼š</p><ol><li>åœ¨ Redis æœåŠ¡ç«¯å®šä¹‰å¥½ Lua è„šæœ¬ï¼Œç„¶åè®¡ç®—å‡ºæ¥ä¸€ä¸ªæ•£åˆ—å€¼ï¼Œåœ¨ Java ä»£ç ä¸­ï¼Œé€šè¿‡è¿™ä¸ªæ•£åˆ—å€¼é”å®šè¦æ‰§è¡Œå“ªä¸ª Lua è„šæœ¬ã€‚</li><li>ç›´æ¥åœ¨ Java ä»£ç ä¸­å°† Lua è„šæœ¬å®šä¹‰å¥½ï¼Œç„¶åå‘é€åˆ° Redis æœåŠ¡ç«¯å»æ‰§è¡Œã€‚</li></ol><p>Spring Data Redis ä¸­ä¹Ÿæä¾›äº†æ“ä½œ Lua è„šæœ¬çš„æ¥å£ï¼Œè¿˜æ˜¯æ¯”è¾ƒæ–¹ä¾¿çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œå°±é‡‡ç”¨ç¬¬äºŒç§æ–¹æ¡ˆã€‚</p><p>åœ¨ resources ç›®å½•ä¸‹æ–°å»º lua æ–‡ä»¶å¤¹ä¸“é—¨ç”¨æ¥å­˜æ”¾ lua è„šæœ¬ï¼Œè„šæœ¬å†…å®¹å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=kd>local</span> <span class=n>key</span> <span class=o>=</span> <span class=n>KEYS</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>count</span> <span class=o>=</span> <span class=n>tonumber</span><span class=p>(</span><span class=n>ARGV</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>time</span> <span class=o>=</span> <span class=n>tonumber</span><span class=p>(</span><span class=n>ARGV</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>current</span> <span class=o>=</span> <span class=n>redis.call</span><span class=p>(</span><span class=s1>&#39;get&#39;</span><span class=p>,</span> <span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>if</span> <span class=n>current</span> <span class=ow>and</span> <span class=n>tonumber</span><span class=p>(</span><span class=n>current</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>count</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>    <span class=kr>return</span> <span class=n>tonumber</span><span class=p>(</span><span class=n>current</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl><span class=n>current</span> <span class=o>=</span> <span class=n>redis.call</span><span class=p>(</span><span class=s1>&#39;incr&#39;</span><span class=p>,</span> <span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>if</span> <span class=n>tonumber</span><span class=p>(</span><span class=n>current</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>    <span class=n>redis.call</span><span class=p>(</span><span class=s1>&#39;expire&#39;</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>time</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl><span class=kr>return</span> <span class=n>tonumber</span><span class=p>(</span><span class=n>current</span><span class=p>)</span>
</span></span></code></pre></div><p>KEYS å’Œ ARGV éƒ½æ˜¯ä¸€ä¼šè°ƒç”¨æ—¶å€™ä¼ è¿›æ¥çš„å‚æ•°ï¼Œtonumber å°±æ˜¯æŠŠå­—ç¬¦ä¸²è½¬ä¸ºæ•°å­—ï¼Œredis.call å°±æ˜¯æ‰§è¡Œå…·ä½“çš„ redis æŒ‡ä»¤ï¼Œå…·ä½“æµç¨‹æ˜¯è¿™æ ·ï¼š</p><ol><li>é¦–å…ˆè·å–åˆ°ä¼ è¿›æ¥çš„ key ä»¥åŠ é™æµçš„ count å’Œæ—¶é—´ timeã€‚</li><li>é€šè¿‡ get è·å–åˆ°è¿™ä¸ª key å¯¹åº”çš„å€¼ï¼Œè¿™ä¸ªå€¼å°±æ˜¯å½“å‰æ—¶é—´çª—å†…è¿™ä¸ªæ¥å£å¯ä»¥è®¿é—®å¤šå°‘æ¬¡ã€‚</li><li>å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è®¿é—®ï¼Œæ­¤æ—¶æ‹¿åˆ°çš„ç»“æœä¸º nilï¼Œå¦åˆ™æ‹¿åˆ°çš„ç»“æœåº”è¯¥æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥å°±åˆ¤æ–­ï¼Œ å¦‚æœæ‹¿åˆ°çš„ç»“æœæ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå¹¶ä¸”è¿™ä¸ªæ•°å­—è¿˜å¤§äº countï¼Œé‚£å°±è¯´æ˜å·²ç»è¶…è¿‡æµé‡é™åˆ¶äº†ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›æŸ¥è¯¢çš„ç»“æœå³å¯ã€‚</li><li>å¦‚æœæ‹¿åˆ°çš„ç»“æœä¸º nilï¼Œè¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡è®¿é—®ï¼Œæ­¤æ—¶å°±ç»™å½“å‰ key è‡ªå¢ 1ï¼Œç„¶åè®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ã€‚</li><li>æœ€åæŠŠè‡ªå¢ 1 åçš„å€¼è¿”å›å°±å¯ä»¥äº†ã€‚</li></ol><p>æ¥ä¸‹æ¥æˆ‘ä»¬åœ¨ä¸€ä¸ª Bean ä¸­æ¥åŠ è½½è¿™æ®µ Lua è„šæœ¬ï¼Œå¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>DefaultRedisScript</span><span class=o>&lt;</span><span class=n>Long</span><span class=o>&gt;</span><span class=w> </span><span class=nf>limitScript</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DefaultRedisScript</span><span class=o>&lt;</span><span class=n>Long</span><span class=o>&gt;</span><span class=w> </span><span class=n>redisScript</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DefaultRedisScript</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>redisScript</span><span class=p>.</span><span class=na>setScriptSource</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ResourceScriptSource</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ClassPathResource</span><span class=p>(</span><span class=s>&#34;lua/limit.lua&#34;</span><span class=p>)));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>redisScript</span><span class=p>.</span><span class=na>setResultType</span><span class=p>(</span><span class=n>Long</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>redisScript</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=4-æ³¨è§£è§£æé€šè¿‡aspectjè‡ªå®šä¹‰åˆ‡é¢>4. æ³¨è§£è§£æï¼ˆé€šè¿‡AspectJè‡ªå®šä¹‰åˆ‡é¢ï¼‰<a hidden class=anchor aria-hidden=true href=#4-æ³¨è§£è§£æé€šè¿‡aspectjè‡ªå®šä¹‰åˆ‡é¢>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Aspect</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>RateLimiterAspect</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Logger</span><span class=w> </span><span class=n>log</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LoggerFactory</span><span class=p>.</span><span class=na>getLogger</span><span class=p>(</span><span class=n>RateLimiterAspect</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>RedisTemplate</span><span class=o>&lt;</span><span class=n>Object</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>RedisScript</span><span class=o>&lt;</span><span class=n>Long</span><span class=o>&gt;</span><span class=w> </span><span class=n>limitScript</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Before</span><span class=p>(</span><span class=s>&#34;@annotation(rateLimiter)&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doBefore</span><span class=p>(</span><span class=n>JoinPoint</span><span class=w> </span><span class=n>point</span><span class=p>,</span><span class=w> </span><span class=n>RateLimiter</span><span class=w> </span><span class=n>rateLimiter</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rateLimiter</span><span class=p>.</span><span class=na>key</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>time</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rateLimiter</span><span class=p>.</span><span class=na>time</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rateLimiter</span><span class=p>.</span><span class=na>count</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>combineKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getCombineKey</span><span class=p>(</span><span class=n>rateLimiter</span><span class=p>,</span><span class=w> </span><span class=n>point</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>keys</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Collections</span><span class=p>.</span><span class=na>singletonList</span><span class=p>(</span><span class=n>combineKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Long</span><span class=w> </span><span class=n>number</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=n>limitScript</span><span class=p>,</span><span class=w> </span><span class=n>keys</span><span class=p>,</span><span class=w> </span><span class=n>count</span><span class=p>,</span><span class=w> </span><span class=n>time</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>number</span><span class=o>==</span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>number</span><span class=p>.</span><span class=na>intValue</span><span class=p>()</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>count</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ServiceException</span><span class=p>(</span><span class=s>&#34;è®¿é—®è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨å€™å†è¯•&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;é™åˆ¶è¯·æ±‚&#39;{}&#39;,å½“å‰è¯·æ±‚&#39;{}&#39;,ç¼“å­˜key&#39;{}&#39;&#34;</span><span class=p>,</span><span class=w> </span><span class=n>count</span><span class=p>,</span><span class=w> </span><span class=n>number</span><span class=p>.</span><span class=na>intValue</span><span class=p>(),</span><span class=w> </span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>ServiceException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=s>&#34;æœåŠ¡å™¨é™æµå¼‚å¸¸ï¼Œè¯·ç¨å€™å†è¯•&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>getCombineKey</span><span class=p>(</span><span class=n>RateLimiter</span><span class=w> </span><span class=n>rateLimiter</span><span class=p>,</span><span class=w> </span><span class=n>JoinPoint</span><span class=w> </span><span class=n>point</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>StringBuffer</span><span class=w> </span><span class=n>stringBuffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StringBuffer</span><span class=p>(</span><span class=n>rateLimiter</span><span class=p>.</span><span class=na>key</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>rateLimiter</span><span class=p>.</span><span class=na>limitType</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>LimitType</span><span class=p>.</span><span class=na>IP</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>stringBuffer</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>IpUtils</span><span class=p>.</span><span class=na>getIpAddr</span><span class=p>(((</span><span class=n>ServletRequestAttributes</span><span class=p>)</span><span class=w> </span><span class=n>RequestContextHolder</span><span class=p>.</span><span class=na>currentRequestAttributes</span><span class=p>()).</span><span class=na>getRequest</span><span class=p>())).</span><span class=na>append</span><span class=p>(</span><span class=s>&#34;-&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>MethodSignature</span><span class=w> </span><span class=n>signature</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>MethodSignature</span><span class=p>)</span><span class=w> </span><span class=n>point</span><span class=p>.</span><span class=na>getSignature</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Method</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>signature</span><span class=p>.</span><span class=na>getMethod</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>targetClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>method</span><span class=p>.</span><span class=na>getDeclaringClass</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>stringBuffer</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>targetClass</span><span class=p>.</span><span class=na>getName</span><span class=p>()).</span><span class=na>append</span><span class=p>(</span><span class=s>&#34;-&#34;</span><span class=p>).</span><span class=na>append</span><span class=p>(</span><span class=n>method</span><span class=p>.</span><span class=na>getName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>stringBuffer</span><span class=p>.</span><span class=na>toString</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>è¿™ä¸ªåˆ‡é¢å°±æ˜¯æ‹¦æˆªæ‰€æœ‰åŠ äº† @RateLimiter æ³¨è§£çš„æ–¹æ³•ï¼Œåœ¨å‰ç½®é€šçŸ¥ä¸­å¯¹æ³¨è§£è¿›è¡Œå¤„ç†ã€‚</p><ol><li>é¦–å…ˆè·å–åˆ°æ³¨è§£ä¸­çš„ keyã€time ä»¥åŠ count ä¸‰ä¸ªå‚æ•°ã€‚</li><li>è·å–ä¸€ä¸ªç»„åˆçš„ keyï¼Œæ‰€è°“çš„ç»„åˆçš„ keyï¼Œå°±æ˜¯åœ¨æ³¨è§£çš„ key å±æ€§åŸºç¡€ä¸Šï¼Œå†åŠ ä¸Šæ–¹æ³•çš„å®Œæ•´è·¯å¾„ï¼Œå¦‚æœæ˜¯ IP æ¨¡å¼çš„è¯ï¼Œå°±å†åŠ ä¸Š IP åœ°å€ã€‚ä»¥ IP æ¨¡å¼ä¸ºä¾‹ï¼Œæœ€ç»ˆç”Ÿæˆçš„ key ç±»ä¼¼è¿™æ ·ï¼šrate_limit:127.0.0.1-com.demo.ratelimiter.controller.HelloController-helloï¼ˆå¦‚æœä¸æ˜¯ IP æ¨¡å¼ï¼Œé‚£ä¹ˆç”Ÿæˆçš„ key ä¸­å°±ä¸åŒ…å« IP åœ°å€ï¼‰ã€‚</li><li>å°†ç”Ÿæˆçš„ key æ”¾åˆ°é›†åˆä¸­ã€‚</li><li>é€šè¿‡ redisTemplate.execute æ–¹æ³•å–æ‰§è¡Œä¸€ä¸ª Lua è„šæœ¬ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è„šæœ¬æ‰€å°è£…çš„å¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ keyï¼Œå¯¹åº”äº†è„šæœ¬ä¸­çš„ KEYSï¼Œåé¢æ˜¯å¯å˜é•¿åº¦çš„å‚æ•°ï¼Œå¯¹åº”äº†è„šæœ¬ä¸­çš„ ARGVã€‚</li><li>å°† Lua è„šæœ¬æ‰§è¡Œçš„ç»“æœä¸ count è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå¤§äº countï¼Œå°±è¯´æ˜è¿‡è½½äº†ï¼ŒæŠ›å¼‚å¸¸å°±è¡Œäº†ã€‚</li></ol><h3 id=5-æ¥å£æµ‹è¯•>5. æ¥å£æµ‹è¯•<a hidden class=anchor aria-hidden=true href=#5-æ¥å£æµ‹è¯•>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RestController</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>HelloController</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/hello&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@RateLimiter</span><span class=p>(</span><span class=n>time</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>5</span><span class=p>,</span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>3</span><span class=p>,</span><span class=n>limitType</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LimitType</span><span class=p>.</span><span class=na>IP</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>hello</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&#34;hello&gt;&gt;&gt;&#34;</span><span class=o>+</span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>æ¯ä¸€ä¸ª IP åœ°å€ï¼Œåœ¨ 5 ç§’å†…åªèƒ½è®¿é—® 3 æ¬¡ã€‚</p></div><footer class=post-footer><ul class=post-tags><li><a href=http://localhost:1313/blog/tags/springboot/>SpringBoot</a></li><li><a href=http://localhost:1313/blog/tags/redis/>Redis</a></li></ul><nav class=paginav><a class=prev href=http://localhost:1313/blog/posts/operation/nginx%E9%85%8D%E7%BD%AEhttp%E5%92%8Chttps%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86/><span class=title>Â«</span><br><span>Nginxé…ç½®Httpå’ŒHttpsæ­£å‘ä»£ç†</span>
</a><a class=next href=http://localhost:1313/blog/posts/knowledge/springboot%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3%E6%80%BB%E7%BB%93/><span class=title>Â»</span><br><span>SpringBootå¸¸ç”¨æ³¨è§£æ€»ç»“</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=http://localhost:1313/blog/>Lesan's Blog</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>