<!doctype html><html lang=zh-cn dir=auto><head><script src="/blog/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=blog/livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>SpringBoot+Redis实现接口限流 | Lesan's Blog</title><meta name=keywords content="SpringBoot,Redis"><meta name=description content="Redis 作为21世纪最流行的缓存中间件，它也能够实现接口限流的作用，本片文章主要记录个人实现过程。
在分布式高并发系统中，常常需要用到 缓存 、降级 、 限流。"><meta name=author content="Lesan"><link rel=canonical href=http://localhost:1313/blog/posts/operation/springboot+redis%E5%AE%9E%E7%8E%B0%E6%8E%A5%E5%8F%A3%E9%99%90%E6%B5%81/><link crossorigin=anonymous href=/blog/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=http://localhost:1313/blog/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://localhost:1313/blog/favicon.ico><link rel=icon type=image/png sizes=32x32 href=http://localhost:1313/blog/favicon.ico><link rel=apple-touch-icon href=http://localhost:1313/blog/favicon.ico><link rel=mask-icon href=http://localhost:1313/blog/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-cn href=http://localhost:1313/blog/posts/operation/springboot+redis%E5%AE%9E%E7%8E%B0%E6%8E%A5%E5%8F%A3%E9%99%90%E6%B5%81/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:url" content="http://localhost:1313/blog/posts/operation/springboot+redis%E5%AE%9E%E7%8E%B0%E6%8E%A5%E5%8F%A3%E9%99%90%E6%B5%81/"><meta property="og:site_name" content="Lesan's Blog"><meta property="og:title" content="SpringBoot+Redis实现接口限流"><meta property="og:description" content="Redis 作为21世纪最流行的缓存中间件，它也能够实现接口限流的作用，本片文章主要记录个人实现过程。
在分布式高并发系统中，常常需要用到 缓存 、降级 、 限流。"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-26T00:00:00+00:00"><meta property="article:modified_time" content="2022-11-26T00:00:00+00:00"><meta property="article:tag" content="SpringBoot"><meta property="article:tag" content="Redis"><meta name=twitter:card content="summary"><meta name=twitter:title content="SpringBoot+Redis实现接口限流"><meta name=twitter:description content="Redis 作为21世纪最流行的缓存中间件，它也能够实现接口限流的作用，本片文章主要记录个人实现过程。
在分布式高并发系统中，常常需要用到 缓存 、降级 、 限流。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"📚 博客","item":"http://localhost:1313/blog/posts/"},{"@type":"ListItem","position":2,"name":"SpringBoot+Redis实现接口限流","item":"http://localhost:1313/blog/posts/operation/springboot+redis%E5%AE%9E%E7%8E%B0%E6%8E%A5%E5%8F%A3%E9%99%90%E6%B5%81/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"SpringBoot+Redis实现接口限流","name":"SpringBoot\u002bRedis实现接口限流","description":"Redis 作为21世纪最流行的缓存中间件，它也能够实现接口限流的作用，本片文章主要记录个人实现过程。\n在分布式高并发系统中，常常需要用到 缓存 、降级 、 限流。\n","keywords":["SpringBoot","Redis"],"articleBody":"Redis 作为21世纪最流行的缓存中间件，它也能够实现接口限流的作用，本片文章主要记录个人实现过程。\n在分布式高并发系统中，常常需要用到 缓存 、降级 、 限流。\n缓存：缓存的目的是提升系统访问速度和增大系统处理容量 降级：降级是当服务出现问题或者影响到核心流程时，需要暂时屏蔽掉，待高峰或者问题解决后再打开 限流：限流的目的是通过对并发访问/请求进行限速，或者对一个时间窗口内的请求进行限速来保护系统，一旦达到限制速率则可以拒绝服务、排队或等待、降级等处理 准备工作 Maven 添加依赖 org.springframework.boot spring-boot-starter-data-redis org.springframework.boot spring-boot-starter-web org.springframework.boot spring-boot-starter-aop 安装 Redis 本文就不多赘述这一部分了 QAQ\nSpring Boot 中集成 Redis 1. 在application配置文件中配置Redis # Redis数据库索引（默认为0） spring.redis.database=0 # Redis服务器地址 spring.redis.host=127.0.0.1 # Redis服务器连接端口 spring.redis.port=6379 # Redis服务器连接密码（默认为空） spring.redis.password= # 连接超时时间（毫秒） spring.redis.timeout=1000 # 连接池最大连接数（使用负值表示没有限制） spring.redis.jedis.pool.max-active=20 # 连接池最大阻塞等待时间（使用负值表示没有限制） spring.redis.jedis.pool.max-wait=-1 # 连接池中的最大空闲连接 spring.redis.jedis.pool.max-idle=10 # 连接池中的最小空闲连接 spring.redis.jedis.pool.min-idle=0 2. 配置RedisTemplate @Configuration @EnableCaching public class RedisConfig extends CachingConfigurerSupport { /** * RedisTemplate相关配置 * 使redis支持插入对象 */ @Bean public RedisTemplate\u003cString, Object\u003e redisTemplate(RedisConnectionFactory factory) { RedisTemplate\u003cString, Object\u003e template = new RedisTemplate\u003c\u003e(); // 配置连接工厂 template.setConnectionFactory(factory); // 设置key的序列化器 template.setKeySerializer(new StringRedisSerializer()); // 设置value的序列化器 //使用Jackson 2，将对象序列化为JSON Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = new Jackson2JsonRedisSerializer(Object.class); //Json转对象类，不设置默认的会将Json转成HashMap ObjectMapper om = new ObjectMapper(); om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY); om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL); jackson2JsonRedisSerializer.setObjectMapper(om); template.setValueSerializer(jackson2JsonRedisSerializer); return template; } } 自此，Spring Boot 已完成集成Redis，可以通过依赖注入使用RedisTemplate，如下所示：\n@Autowired private RedisTemplate\u003cString, Object\u003e redisTemplate; 实现限流（方式1） 1. 限流思路 编写自定义注解，为后续过滤接口提供标识 通过IP+方法名作为key，访问次数作为value的方式对某一用户的请求进行标识 每次访问的时候判断key是否存在，count是否超过限制的次数 若访问超出限制，则通过拦截器直接返回错误信息：请求过于频繁 2. 添加自定义注解 AccessLimit @Inherited @Documented @Retention(RetentionPolicy.RUNTIME) @Target(ElementType.METHOD) public @interface AccessLimit { /** * 请求次数的指定时间范围 : 秒数(redis数据过期时间) */ int second() default 60; /** * 指定second 时间内 : API请求次数 */ int maxCount() default 3; } 3. 编写拦截器 @Slf4j @Component public class AccessLimitInterceptor implements HandlerInterceptor { @Autowired private RedisTemplate\u003cString, Object\u003e redisTemplate; @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception { // Handler 是否为 HandlerMethod 实例 if (handler instanceof HandlerMethod) { HandlerMethod handlerMethod = (HandlerMethod) handler; // 获取方法 Method method = handlerMethod.getMethod(); // 是否有AccessLimit注解 if (!method.isAnnotationPresent(AccessLimit.class)) { return true; } // 获取注解内容信息 AccessLimit accessLimit = method.getAnnotation(AccessLimit.class); if (accessLimit == null) { return true; } // 获取次数和超时 int seconds = accessLimit.second(); int maxCount = accessLimit.maxCount(); // 存储key String key = IpUtil.getIpAddr(request)+method.getName(); // 从Redis中获取用户已经访问的次数 try { Integer count = (Integer) redisTemplate.opsForValue().get(key); System.out.println(\"已经访问的次数:\" + count); // Redis不存在用户访问记录 if (null == count || -1 == count) { redisTemplate.opsForValue().set(key, 1, seconds, TimeUnit.SECONDS); return true; } if (count \u003c maxCount) { // 访问次数+1 redisTemplate.opsForValue().increment(key); return true; } if (count \u003e= maxCount) { // 超出访问限制 response.setContentType(\"application/json;charset=UTF-8\"); OutputStream out = response.getOutputStream(); out.write(\"请求过于频繁请稍后再试\".getBytes(\"UTF-8\")); out.flush(); out.close(); log.warn(\"请求过于频繁请稍后再试\"); return false; } }catch (RedisConnectionFailureException e){ log.error(\"redis error\" + e.getMessage().toString()); return true; } } return true; } } 4. 注册拦截器 @Configuration public class IntercepterConfig implements WebMvcConfigurer { @Autowired private AccessLimitInterceptor accessLimitInterceptor; @Override public void addInterceptors(InterceptorRegistry registry) { registry.addInterceptor(accessLimitInterceptor) .addPathPatterns(\"/**\") // 拦截路径 .excludePathPatterns(\"/user/login\"); // 不拦截路径 } } 5. 通过AccessLimit注解测试最终效果 @RestController public class TestController { @AccessLimit(second = 60,maxCount = 5) @GetMapping(\"test\") public String test(){ return \"TEST\"; } } 实现限流（方式2） 1. 限流注解 首先需要创建一个限流注解，限流将分为两种情况：\n针对当前接口的全局性限流，例如该接口可以在 1 分钟内访问 100 次。 针对某一个 IP 地址的限流，例如某个 IP 地址可以在 1 分钟内访问 100 次。 针对这两种情况，我们创建一个枚举类：\npublic enum LimitType { /** * 默认策略全局限流 */ DEFAULT, /** * 根据请求者IP进行限流 */ IP } 下一步，创建限流注解：\n@Target(ElementType.METHOD) @Retention(RetentionPolicy.RUNTIME) @Documented public @interface RateLimiter { /** * 限流key前缀 */ String key() default \"rate_limit:\"; /** * 限流时间,单位秒 */ int time() default 60; /** * 限流次数 */ int count() default 100; /** * 限流类型 */ LimitType limitType() default LimitType.DEFAULT; } 2. 定制 RedisTemplate 在 Spring Boot 中，我们其实更习惯使用 Spring Data Redis 来操作 Redis，不过默认的 RedisTemplate 有一个小坑，就是序列化用的是 JdkSerializationRedisSerializer，不知道小伙伴们有没有注意过，直接用这个序列化工具将来存到 Redis 上的 key 和 value 都会莫名其妙多一些前缀，这就导致你用命令读取的时候可能会出错。\n修改 RedisTemplate 序列化方案，代码如下：\n@Configuration public class RedisConfig { @Bean public RedisTemplate\u003cObject, Object\u003e redisTemplate(RedisConnectionFactory connectionFactory) { RedisTemplate\u003cObject, Object\u003e redisTemplate = new RedisTemplate\u003c\u003e(); redisTemplate.setConnectionFactory(connectionFactory); // 使用Jackson2JsonRedisSerialize 替换默认序列化(默认采用的是JDK序列化) Jackson2JsonRedisSerializer\u003cObject\u003e jackson2JsonRedisSerializer = new Jackson2JsonRedisSerializer\u003c\u003e(Object.class); ObjectMapper om = new ObjectMapper(); om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY); om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL); jackson2JsonRedisSerializer.setObjectMapper(om); redisTemplate.setKeySerializer(jackson2JsonRedisSerializer); redisTemplate.setValueSerializer(jackson2JsonRedisSerializer); redisTemplate.setHashKeySerializer(jackson2JsonRedisSerializer); redisTemplate.setHashValueSerializer(jackson2JsonRedisSerializer); return redisTemplate; } } 3. 开发 Lua 脚本 Redis 中的一些原子操作我们可以借助 Lua 脚本来实现，想要调用 Lua 脚本，我们有两种不同的思路：\n在 Redis 服务端定义好 Lua 脚本，然后计算出来一个散列值，在 Java 代码中，通过这个散列值锁定要执行哪个 Lua 脚本。 直接在 Java 代码中将 Lua 脚本定义好，然后发送到 Redis 服务端去执行。 Spring Data Redis 中也提供了操作 Lua 脚本的接口，还是比较方便的，所以我们这里就采用第二种方案。\n在 resources 目录下新建 lua 文件夹专门用来存放 lua 脚本，脚本内容如下：\nlocal key = KEYS[1] local count = tonumber(ARGV[1]) local time = tonumber(ARGV[2]) local current = redis.call('get', key) if current and tonumber(current) \u003e count then return tonumber(current) end current = redis.call('incr', key) if tonumber(current) == 1 then redis.call('expire', key, time) end return tonumber(current) KEYS 和 ARGV 都是一会调用时候传进来的参数，tonumber 就是把字符串转为数字，redis.call 就是执行具体的 redis 指令，具体流程是这样：\n首先获取到传进来的 key 以及 限流的 count 和时间 time。 通过 get 获取到这个 key 对应的值，这个值就是当前时间窗内这个接口可以访问多少次。 如果是第一次访问，此时拿到的结果为 nil，否则拿到的结果应该是一个数字，所以接下来就判断， 如果拿到的结果是一个数字，并且这个数字还大于 count，那就说明已经超过流量限制了，那么直接返回查询的结果即可。 如果拿到的结果为 nil，说明是第一次访问，此时就给当前 key 自增 1，然后设置一个过期时间。 最后把自增 1 后的值返回就可以了。 接下来我们在一个 Bean 中来加载这段 Lua 脚本，如下：\n@Bean public DefaultRedisScript\u003cLong\u003e limitScript() { DefaultRedisScript\u003cLong\u003e redisScript = new DefaultRedisScript\u003c\u003e(); redisScript.setScriptSource(new ResourceScriptSource(new ClassPathResource(\"lua/limit.lua\"))); redisScript.setResultType(Long.class); return redisScript; } 4. 注解解析（通过AspectJ自定义切面） @Aspect @Component public class RateLimiterAspect { private static final Logger log = LoggerFactory.getLogger(RateLimiterAspect.class); @Autowired private RedisTemplate\u003cObject, Object\u003e redisTemplate; @Autowired private RedisScript\u003cLong\u003e limitScript; @Before(\"@annotation(rateLimiter)\") public void doBefore(JoinPoint point, RateLimiter rateLimiter) throws Throwable { String key = rateLimiter.key(); int time = rateLimiter.time(); int count = rateLimiter.count(); String combineKey = getCombineKey(rateLimiter, point); List\u003cObject\u003e keys = Collections.singletonList(combineKey); try { Long number = redisTemplate.execute(limitScript, keys, count, time); if (number==null || number.intValue() \u003e count) { throw new ServiceException(\"访问过于频繁，请稍候再试\"); } log.info(\"限制请求'{}',当前请求'{}',缓存key'{}'\", count, number.intValue(), key); } catch (ServiceException e) { throw e; } catch (Exception e) { throw new RuntimeException(\"服务器限流异常，请稍候再试\"); } } public String getCombineKey(RateLimiter rateLimiter, JoinPoint point) { StringBuffer stringBuffer = new StringBuffer(rateLimiter.key()); if (rateLimiter.limitType() == LimitType.IP) { stringBuffer.append(IpUtils.getIpAddr(((ServletRequestAttributes) RequestContextHolder.currentRequestAttributes()).getRequest())).append(\"-\"); } MethodSignature signature = (MethodSignature) point.getSignature(); Method method = signature.getMethod(); Class\u003c?\u003e targetClass = method.getDeclaringClass(); stringBuffer.append(targetClass.getName()).append(\"-\").append(method.getName()); return stringBuffer.toString(); } } 这个切面就是拦截所有加了 @RateLimiter 注解的方法，在前置通知中对注解进行处理。\n首先获取到注解中的 key、time 以及 count 三个参数。 获取一个组合的 key，所谓的组合的 key，就是在注解的 key 属性基础上，再加上方法的完整路径，如果是 IP 模式的话，就再加上 IP 地址。以 IP 模式为例，最终生成的 key 类似这样：rate_limit:127.0.0.1-com.demo.ratelimiter.controller.HelloController-hello（如果不是 IP 模式，那么生成的 key 中就不包含 IP 地址）。 将生成的 key 放到集合中。 通过 redisTemplate.execute 方法取执行一个 Lua 脚本，第一个参数是脚本所封装的对象，第二个参数是 key，对应了脚本中的 KEYS，后面是可变长度的参数，对应了脚本中的 ARGV。 将 Lua 脚本执行的结果与 count 进行比较，如果大于 count，就说明过载了，抛异常就行了。 5. 接口测试 @RestController public class HelloController { @GetMapping(\"/hello\") @RateLimiter(time = 5,count = 3,limitType = LimitType.IP) public String hello() { return \"hello\u003e\u003e\u003e\"+new Date(); } } 每一个 IP 地址，在 5 秒内只能访问 3 次。\n","wordCount":"3075","inLanguage":"zh-cn","datePublished":"2022-11-26T00:00:00Z","dateModified":"2022-11-26T00:00:00Z","author":{"@type":"Person","name":"Lesan"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:1313/blog/posts/operation/springboot+redis%E5%AE%9E%E7%8E%B0%E6%8E%A5%E5%8F%A3%E9%99%90%E6%B5%81/"},"publisher":{"@type":"Organization","name":"Lesan's Blog","logo":{"@type":"ImageObject","url":"http://localhost:1313/blog/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://localhost:1313/blog/ accesskey=h title="Lesan's Blog (Alt + H)">Lesan's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://localhost:1313/blog/archives title="📚 归档"><span>📚 归档</span></a></li><li><a href=http://localhost:1313/blog/categories/ title="🗃️ 分类"><span>🗃️ 分类</span></a></li><li><a href=http://localhost:1313/blog/tags/ title="🏷️ 标签"><span>🏷️ 标签</span></a></li><li><a href=http://localhost:1313/blog/search/ title="🔎 搜索"><span>🔎 搜索</span></a></li><li><a href=http://localhost:1313/blog/about/ title="👨‍💻 关于我"><span>👨‍💻 关于我</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://localhost:1313/blog/>Home</a>&nbsp;»&nbsp;<a href=http://localhost:1313/blog/posts/>📚 博客</a></div><h1 class="post-title entry-hint-parent">SpringBoot+Redis实现接口限流</h1><div class=post-meta><span title='2022-11-26 00:00:00 +0000 UTC'>2022-11-26</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;Lesan</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%87%86%e5%a4%87%e5%b7%a5%e4%bd%9c aria-label=准备工作>准备工作</a><ul><li><a href=#maven-%e6%b7%bb%e5%8a%a0%e4%be%9d%e8%b5%96 aria-label="Maven 添加依赖">Maven 添加依赖</a></li><li><a href=#%e5%ae%89%e8%a3%85-redis aria-label="安装 Redis">安装 Redis</a></li></ul></li><li><a href=#spring-boot-%e4%b8%ad%e9%9b%86%e6%88%90-redis aria-label="Spring Boot 中集成 Redis">Spring Boot 中集成 Redis</a><ul><li><a href=#1-%e5%9c%a8application%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e4%b8%ad%e9%85%8d%e7%bd%aeredis aria-label="1. 在application配置文件中配置Redis">1. 在application配置文件中配置Redis</a></li><li><a href=#2-%e9%85%8d%e7%bd%aeredistemplate aria-label="2. 配置RedisTemplate">2. 配置RedisTemplate</a></li></ul></li><li><a href=#%e5%ae%9e%e7%8e%b0%e9%99%90%e6%b5%81%e6%96%b9%e5%bc%8f1 aria-label=实现限流（方式1）>实现限流（方式1）</a><ul><li><a href=#1-%e9%99%90%e6%b5%81%e6%80%9d%e8%b7%af aria-label="1. 限流思路">1. 限流思路</a></li><li><a href=#2-%e6%b7%bb%e5%8a%a0%e8%87%aa%e5%ae%9a%e4%b9%89%e6%b3%a8%e8%a7%a3-accesslimit aria-label="2. 添加自定义注解 AccessLimit">2. 添加自定义注解 AccessLimit</a></li><li><a href=#3-%e7%bc%96%e5%86%99%e6%8b%a6%e6%88%aa%e5%99%a8 aria-label="3. 编写拦截器">3. 编写拦截器</a></li><li><a href=#4-%e6%b3%a8%e5%86%8c%e6%8b%a6%e6%88%aa%e5%99%a8 aria-label="4. 注册拦截器">4. 注册拦截器</a></li><li><a href=#5-%e9%80%9a%e8%bf%87accesslimit%e6%b3%a8%e8%a7%a3%e6%b5%8b%e8%af%95%e6%9c%80%e7%bb%88%e6%95%88%e6%9e%9c aria-label="5. 通过AccessLimit注解测试最终效果">5. 通过AccessLimit注解测试最终效果</a></li></ul></li><li><a href=#%e5%ae%9e%e7%8e%b0%e9%99%90%e6%b5%81%e6%96%b9%e5%bc%8f2 aria-label=实现限流（方式2）>实现限流（方式2）</a><ul><li><a href=#1-%e9%99%90%e6%b5%81%e6%b3%a8%e8%a7%a3 aria-label="1. 限流注解">1. 限流注解</a></li><li><a href=#2-%e5%ae%9a%e5%88%b6-redistemplate aria-label="2. 定制 RedisTemplate">2. 定制 RedisTemplate</a></li><li><a href=#3-%e5%bc%80%e5%8f%91-lua-%e8%84%9a%e6%9c%ac aria-label="3. 开发 Lua 脚本">3. 开发 Lua 脚本</a></li><li><a href=#4-%e6%b3%a8%e8%a7%a3%e8%a7%a3%e6%9e%90%e9%80%9a%e8%bf%87aspectj%e8%87%aa%e5%ae%9a%e4%b9%89%e5%88%87%e9%9d%a2 aria-label="4. 注解解析（通过AspectJ自定义切面）">4. 注解解析（通过AspectJ自定义切面）</a></li><li><a href=#5-%e6%8e%a5%e5%8f%a3%e6%b5%8b%e8%af%95 aria-label="5. 接口测试">5. 接口测试</a></li></ul></li></ul></div></details></div><div class=post-content><p>Redis 作为21世纪最流行的缓存中间件，它也能够实现接口限流的作用，本片文章主要记录个人实现过程。</p><p>在分布式高并发系统中，常常需要用到 <code>缓存</code> 、<code>降级</code> 、 <code>限流</code>。</p><ul><li>缓存：缓存的目的是提升系统访问速度和增大系统处理容量</li><li>降级：降级是当服务出现问题或者影响到核心流程时，需要暂时屏蔽掉，待高峰或者问题解决后再打开</li><li>限流：限流的目的是通过对并发访问/请求进行限速，或者对一个时间窗口内的请求进行限速来保护系统，一旦达到限制速率则可以拒绝服务、排队或等待、降级等处理</li></ul><h2 id=准备工作>准备工作<a hidden class=anchor aria-hidden=true href=#准备工作>#</a></h2><h3 id=maven-添加依赖>Maven 添加依赖<a hidden class=anchor aria-hidden=true href=#maven-添加依赖>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>   <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>   <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-web<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl><span class=c>&lt;!-- 方式2需要用到 --&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-aop<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div><h3 id=安装-redis>安装 Redis<a hidden class=anchor aria-hidden=true href=#安装-redis>#</a></h3><p>本文就不多赘述这一部分了 QAQ</p><h2 id=spring-boot-中集成-redis>Spring Boot 中集成 Redis<a hidden class=anchor aria-hidden=true href=#spring-boot-中集成-redis>#</a></h2><h3 id=1-在application配置文件中配置redis>1. 在application配置文件中配置Redis<a hidden class=anchor aria-hidden=true href=#1-在application配置文件中配置redis>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=c1># Redis数据库索引（默认为0）</span>
</span></span><span class=line><span class=cl><span class=na>spring.redis.database</span><span class=o>=</span><span class=s>0</span>
</span></span><span class=line><span class=cl><span class=c1># Redis服务器地址</span>
</span></span><span class=line><span class=cl><span class=na>spring.redis.host</span><span class=o>=</span><span class=s>127.0.0.1</span>
</span></span><span class=line><span class=cl><span class=c1># Redis服务器连接端口</span>
</span></span><span class=line><span class=cl><span class=na>spring.redis.port</span><span class=o>=</span><span class=s>6379</span>
</span></span><span class=line><span class=cl><span class=c1># Redis服务器连接密码（默认为空）</span>
</span></span><span class=line><span class=cl><span class=na>spring.redis.password</span><span class=o>=</span>
</span></span><span class=line><span class=cl><span class=c1># 连接超时时间（毫秒）</span>
</span></span><span class=line><span class=cl><span class=na>spring.redis.timeout</span><span class=o>=</span><span class=s>1000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 连接池最大连接数（使用负值表示没有限制）</span>
</span></span><span class=line><span class=cl><span class=na>spring.redis.jedis.pool.max-active</span><span class=o>=</span><span class=s>20</span>
</span></span><span class=line><span class=cl><span class=c1># 连接池最大阻塞等待时间（使用负值表示没有限制）</span>
</span></span><span class=line><span class=cl><span class=na>spring.redis.jedis.pool.max-wait</span><span class=o>=</span><span class=s>-1</span>
</span></span><span class=line><span class=cl><span class=c1># 连接池中的最大空闲连接</span>
</span></span><span class=line><span class=cl><span class=na>spring.redis.jedis.pool.max-idle</span><span class=o>=</span><span class=s>10</span>
</span></span><span class=line><span class=cl><span class=c1># 连接池中的最小空闲连接</span>
</span></span><span class=line><span class=cl><span class=na>spring.redis.jedis.pool.min-idle</span><span class=o>=</span><span class=s>0</span>
</span></span></code></pre></div><h3 id=2-配置redistemplate>2. 配置RedisTemplate<a hidden class=anchor aria-hidden=true href=#2-配置redistemplate>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@EnableCaching</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>RedisConfig</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>CachingConfigurerSupport</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * RedisTemplate相关配置
</span></span></span><span class=line><span class=cl><span class=cm>     * 使redis支持插入对象
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>RedisTemplate</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=nf>redisTemplate</span><span class=p>(</span><span class=n>RedisConnectionFactory</span><span class=w> </span><span class=n>factory</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>RedisTemplate</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>template</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RedisTemplate</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 配置连接工厂</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>template</span><span class=p>.</span><span class=na>setConnectionFactory</span><span class=p>(</span><span class=n>factory</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 设置key的序列化器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>template</span><span class=p>.</span><span class=na>setKeySerializer</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>StringRedisSerializer</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 设置value的序列化器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//使用Jackson 2，将对象序列化为JSON</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Jackson2JsonRedisSerializer</span><span class=w> </span><span class=n>jackson2JsonRedisSerializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Jackson2JsonRedisSerializer</span><span class=p>(</span><span class=n>Object</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//Json转对象类，不设置默认的会将Json转成HashMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ObjectMapper</span><span class=w> </span><span class=n>om</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ObjectMapper</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>om</span><span class=p>.</span><span class=na>setVisibility</span><span class=p>(</span><span class=n>PropertyAccessor</span><span class=p>.</span><span class=na>ALL</span><span class=p>,</span><span class=w> </span><span class=n>JsonAutoDetect</span><span class=p>.</span><span class=na>Visibility</span><span class=p>.</span><span class=na>ANY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>om</span><span class=p>.</span><span class=na>enableDefaultTyping</span><span class=p>(</span><span class=n>ObjectMapper</span><span class=p>.</span><span class=na>DefaultTyping</span><span class=p>.</span><span class=na>NON_FINAL</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>jackson2JsonRedisSerializer</span><span class=p>.</span><span class=na>setObjectMapper</span><span class=p>(</span><span class=n>om</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>template</span><span class=p>.</span><span class=na>setValueSerializer</span><span class=p>(</span><span class=n>jackson2JsonRedisSerializer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>template</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>自此，Spring Boot 已完成集成Redis，可以通过依赖注入使用<code>RedisTemplate</code>，如下所示：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=n>RedisTemplate</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h2 id=实现限流方式1>实现限流（方式1）<a hidden class=anchor aria-hidden=true href=#实现限流方式1>#</a></h2><h3 id=1-限流思路>1. 限流思路<a hidden class=anchor aria-hidden=true href=#1-限流思路>#</a></h3><ul><li>编写自定义注解，为后续过滤接口提供标识</li><li>通过IP+方法名作为key，访问次数作为value的方式对某一用户的请求进行标识</li><li>每次访问的时候判断key是否存在，count是否超过限制的次数</li><li>若访问超出限制，则通过拦截器直接返回错误信息：请求过于频繁</li></ul><h3 id=2-添加自定义注解-accesslimit>2. 添加自定义注解 <code>AccessLimit</code><a hidden class=anchor aria-hidden=true href=#2-添加自定义注解-accesslimit>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Inherited</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Documented</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Retention</span><span class=p>(</span><span class=n>RetentionPolicy</span><span class=p>.</span><span class=na>RUNTIME</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Target</span><span class=p>(</span><span class=n>ElementType</span><span class=p>.</span><span class=na>METHOD</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=nd>@interface</span><span class=w> </span><span class=n>AccessLimit</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 请求次数的指定时间范围 : 秒数(redis数据过期时间)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=nf>second</span><span class=p>()</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=n>60</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 指定second 时间内 : API请求次数
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=nf>maxCount</span><span class=p>()</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=n>3</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=3-编写拦截器>3. 编写拦截器<a hidden class=anchor aria-hidden=true href=#3-编写拦截器>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AccessLimitInterceptor</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>HandlerInterceptor</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>RedisTemplate</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>preHandle</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>handler</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Handler 是否为 HandlerMethod 实例</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>handler</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>HandlerMethod</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>HandlerMethod</span><span class=w> </span><span class=n>handlerMethod</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>HandlerMethod</span><span class=p>)</span><span class=w> </span><span class=n>handler</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 获取方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Method</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>handlerMethod</span><span class=p>.</span><span class=na>getMethod</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 是否有AccessLimit注解</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>method</span><span class=p>.</span><span class=na>isAnnotationPresent</span><span class=p>(</span><span class=n>AccessLimit</span><span class=p>.</span><span class=na>class</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 获取注解内容信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>AccessLimit</span><span class=w> </span><span class=n>accessLimit</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>method</span><span class=p>.</span><span class=na>getAnnotation</span><span class=p>(</span><span class=n>AccessLimit</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>accessLimit</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 获取次数和超时</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>seconds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>accessLimit</span><span class=p>.</span><span class=na>second</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>maxCount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>accessLimit</span><span class=p>.</span><span class=na>maxCount</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 存储key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>IpUtil</span><span class=p>.</span><span class=na>getIpAddr</span><span class=p>(</span><span class=n>request</span><span class=p>)</span><span class=o>+</span><span class=n>method</span><span class=p>.</span><span class=na>getName</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 从Redis中获取用户已经访问的次数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Integer</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Integer</span><span class=p>)</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForValue</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;已经访问的次数:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>count</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Redis不存在用户访问记录</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=kc>null</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>count</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForValue</span><span class=p>().</span><span class=na>set</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>seconds</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>count</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>maxCount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// 访问次数+1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForValue</span><span class=p>().</span><span class=na>increment</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>count</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>maxCount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// 超出访问限制</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>response</span><span class=p>.</span><span class=na>setContentType</span><span class=p>(</span><span class=s>&#34;application/json;charset=UTF-8&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>OutputStream</span><span class=w> </span><span class=n>out</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>response</span><span class=p>.</span><span class=na>getOutputStream</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>out</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=s>&#34;请求过于频繁请稍后再试&#34;</span><span class=p>.</span><span class=na>getBytes</span><span class=p>(</span><span class=s>&#34;UTF-8&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>out</span><span class=p>.</span><span class=na>flush</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>out</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&#34;请求过于频繁请稍后再试&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RedisConnectionFailureException</span><span class=w> </span><span class=n>e</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;redis error&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>().</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=4-注册拦截器>4. 注册拦截器<a hidden class=anchor aria-hidden=true href=#4-注册拦截器>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>IntercepterConfig</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>WebMvcConfigurer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>AccessLimitInterceptor</span><span class=w> </span><span class=n>accessLimitInterceptor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>addInterceptors</span><span class=p>(</span><span class=n>InterceptorRegistry</span><span class=w> </span><span class=n>registry</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>registry</span><span class=p>.</span><span class=na>addInterceptor</span><span class=p>(</span><span class=n>accessLimitInterceptor</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>addPathPatterns</span><span class=p>(</span><span class=s>&#34;/**&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>// 拦截路径</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>excludePathPatterns</span><span class=p>(</span><span class=s>&#34;/user/login&#34;</span><span class=p>);</span><span class=w> </span><span class=c1>// 不拦截路径</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=5-通过accesslimit注解测试最终效果>5. 通过<code>AccessLimit</code>注解测试最终效果<a hidden class=anchor aria-hidden=true href=#5-通过accesslimit注解测试最终效果>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RestController</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TestController</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@AccessLimit</span><span class=p>(</span><span class=n>second</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>60</span><span class=p>,</span><span class=n>maxCount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>5</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;test&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>test</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&#34;TEST&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=实现限流方式2>实现限流（方式2）<a hidden class=anchor aria-hidden=true href=#实现限流方式2>#</a></h2><h3 id=1-限流注解>1. 限流注解<a hidden class=anchor aria-hidden=true href=#1-限流注解>#</a></h3><p>首先需要创建一个限流注解，限流将分为两种情况：</p><ol><li>针对当前接口的全局性限流，例如该接口可以在 1 分钟内访问 100 次。</li><li>针对某一个 IP 地址的限流，例如某个 IP 地址可以在 1 分钟内访问 100 次。</li></ol><p>针对这两种情况，我们创建一个枚举类：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>enum</span><span class=w> </span><span class=n>LimitType</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 默认策略全局限流
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DEFAULT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 根据请求者IP进行限流
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>IP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>下一步，创建限流注解：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Target</span><span class=p>(</span><span class=n>ElementType</span><span class=p>.</span><span class=na>METHOD</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Retention</span><span class=p>(</span><span class=n>RetentionPolicy</span><span class=p>.</span><span class=na>RUNTIME</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Documented</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=nd>@interface</span><span class=w> </span><span class=n>RateLimiter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 限流key前缀
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=nf>key</span><span class=p>()</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=s>&#34;rate_limit:&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 限流时间,单位秒
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=nf>time</span><span class=p>()</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=n>60</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 限流次数
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=nf>count</span><span class=p>()</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=n>100</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 限流类型
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LimitType</span><span class=w> </span><span class=nf>limitType</span><span class=p>()</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=n>LimitType</span><span class=p>.</span><span class=na>DEFAULT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=2-定制-redistemplate>2. 定制 RedisTemplate<a hidden class=anchor aria-hidden=true href=#2-定制-redistemplate>#</a></h3><p>在 <code>Spring Boot</code> 中，我们其实更习惯使用 <code>Spring Data Redis</code> 来操作 <code>Redis</code>，不过默认的 <code>RedisTemplate</code> 有一个小坑，就是序列化用的是 <code>JdkSerializationRedisSerializer</code>，不知道小伙伴们有没有注意过，直接用这个序列化工具将来存到 <code>Redis</code> 上的 <code>key</code> 和 <code>value</code> 都会莫名其妙多一些前缀，这就导致你用命令读取的时候可能会出错。</p><p>修改 <code>RedisTemplate</code> 序列化方案，代码如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>RedisConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>RedisTemplate</span><span class=o>&lt;</span><span class=n>Object</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=nf>redisTemplate</span><span class=p>(</span><span class=n>RedisConnectionFactory</span><span class=w> </span><span class=n>connectionFactory</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>RedisTemplate</span><span class=o>&lt;</span><span class=n>Object</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>redisTemplate</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RedisTemplate</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>setConnectionFactory</span><span class=p>(</span><span class=n>connectionFactory</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 使用Jackson2JsonRedisSerialize 替换默认序列化(默认采用的是JDK序列化)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Jackson2JsonRedisSerializer</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>jackson2JsonRedisSerializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Jackson2JsonRedisSerializer</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>Object</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ObjectMapper</span><span class=w> </span><span class=n>om</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ObjectMapper</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>om</span><span class=p>.</span><span class=na>setVisibility</span><span class=p>(</span><span class=n>PropertyAccessor</span><span class=p>.</span><span class=na>ALL</span><span class=p>,</span><span class=w> </span><span class=n>JsonAutoDetect</span><span class=p>.</span><span class=na>Visibility</span><span class=p>.</span><span class=na>ANY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>om</span><span class=p>.</span><span class=na>enableDefaultTyping</span><span class=p>(</span><span class=n>ObjectMapper</span><span class=p>.</span><span class=na>DefaultTyping</span><span class=p>.</span><span class=na>NON_FINAL</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>jackson2JsonRedisSerializer</span><span class=p>.</span><span class=na>setObjectMapper</span><span class=p>(</span><span class=n>om</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>setKeySerializer</span><span class=p>(</span><span class=n>jackson2JsonRedisSerializer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>setValueSerializer</span><span class=p>(</span><span class=n>jackson2JsonRedisSerializer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>setHashKeySerializer</span><span class=p>(</span><span class=n>jackson2JsonRedisSerializer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>setHashValueSerializer</span><span class=p>(</span><span class=n>jackson2JsonRedisSerializer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=3-开发-lua-脚本>3. 开发 Lua 脚本<a hidden class=anchor aria-hidden=true href=#3-开发-lua-脚本>#</a></h3><p>Redis 中的一些原子操作我们可以借助 Lua 脚本来实现，想要调用 Lua 脚本，我们有两种不同的思路：</p><ol><li>在 Redis 服务端定义好 Lua 脚本，然后计算出来一个散列值，在 Java 代码中，通过这个散列值锁定要执行哪个 Lua 脚本。</li><li>直接在 Java 代码中将 Lua 脚本定义好，然后发送到 Redis 服务端去执行。</li></ol><p>Spring Data Redis 中也提供了操作 Lua 脚本的接口，还是比较方便的，所以我们这里就采用第二种方案。</p><p>在 resources 目录下新建 lua 文件夹专门用来存放 lua 脚本，脚本内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=kd>local</span> <span class=n>key</span> <span class=o>=</span> <span class=n>KEYS</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>count</span> <span class=o>=</span> <span class=n>tonumber</span><span class=p>(</span><span class=n>ARGV</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>time</span> <span class=o>=</span> <span class=n>tonumber</span><span class=p>(</span><span class=n>ARGV</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>current</span> <span class=o>=</span> <span class=n>redis.call</span><span class=p>(</span><span class=s1>&#39;get&#39;</span><span class=p>,</span> <span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>if</span> <span class=n>current</span> <span class=ow>and</span> <span class=n>tonumber</span><span class=p>(</span><span class=n>current</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>count</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>    <span class=kr>return</span> <span class=n>tonumber</span><span class=p>(</span><span class=n>current</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl><span class=n>current</span> <span class=o>=</span> <span class=n>redis.call</span><span class=p>(</span><span class=s1>&#39;incr&#39;</span><span class=p>,</span> <span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>if</span> <span class=n>tonumber</span><span class=p>(</span><span class=n>current</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>    <span class=n>redis.call</span><span class=p>(</span><span class=s1>&#39;expire&#39;</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>time</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl><span class=kr>return</span> <span class=n>tonumber</span><span class=p>(</span><span class=n>current</span><span class=p>)</span>
</span></span></code></pre></div><p>KEYS 和 ARGV 都是一会调用时候传进来的参数，tonumber 就是把字符串转为数字，redis.call 就是执行具体的 redis 指令，具体流程是这样：</p><ol><li>首先获取到传进来的 key 以及 限流的 count 和时间 time。</li><li>通过 get 获取到这个 key 对应的值，这个值就是当前时间窗内这个接口可以访问多少次。</li><li>如果是第一次访问，此时拿到的结果为 nil，否则拿到的结果应该是一个数字，所以接下来就判断， 如果拿到的结果是一个数字，并且这个数字还大于 count，那就说明已经超过流量限制了，那么直接返回查询的结果即可。</li><li>如果拿到的结果为 nil，说明是第一次访问，此时就给当前 key 自增 1，然后设置一个过期时间。</li><li>最后把自增 1 后的值返回就可以了。</li></ol><p>接下来我们在一个 Bean 中来加载这段 Lua 脚本，如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>DefaultRedisScript</span><span class=o>&lt;</span><span class=n>Long</span><span class=o>&gt;</span><span class=w> </span><span class=nf>limitScript</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DefaultRedisScript</span><span class=o>&lt;</span><span class=n>Long</span><span class=o>&gt;</span><span class=w> </span><span class=n>redisScript</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DefaultRedisScript</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>redisScript</span><span class=p>.</span><span class=na>setScriptSource</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ResourceScriptSource</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ClassPathResource</span><span class=p>(</span><span class=s>&#34;lua/limit.lua&#34;</span><span class=p>)));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>redisScript</span><span class=p>.</span><span class=na>setResultType</span><span class=p>(</span><span class=n>Long</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>redisScript</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=4-注解解析通过aspectj自定义切面>4. 注解解析（通过AspectJ自定义切面）<a hidden class=anchor aria-hidden=true href=#4-注解解析通过aspectj自定义切面>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Aspect</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>RateLimiterAspect</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Logger</span><span class=w> </span><span class=n>log</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LoggerFactory</span><span class=p>.</span><span class=na>getLogger</span><span class=p>(</span><span class=n>RateLimiterAspect</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>RedisTemplate</span><span class=o>&lt;</span><span class=n>Object</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>RedisScript</span><span class=o>&lt;</span><span class=n>Long</span><span class=o>&gt;</span><span class=w> </span><span class=n>limitScript</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Before</span><span class=p>(</span><span class=s>&#34;@annotation(rateLimiter)&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doBefore</span><span class=p>(</span><span class=n>JoinPoint</span><span class=w> </span><span class=n>point</span><span class=p>,</span><span class=w> </span><span class=n>RateLimiter</span><span class=w> </span><span class=n>rateLimiter</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rateLimiter</span><span class=p>.</span><span class=na>key</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>time</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rateLimiter</span><span class=p>.</span><span class=na>time</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rateLimiter</span><span class=p>.</span><span class=na>count</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>combineKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getCombineKey</span><span class=p>(</span><span class=n>rateLimiter</span><span class=p>,</span><span class=w> </span><span class=n>point</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>keys</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Collections</span><span class=p>.</span><span class=na>singletonList</span><span class=p>(</span><span class=n>combineKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Long</span><span class=w> </span><span class=n>number</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=n>limitScript</span><span class=p>,</span><span class=w> </span><span class=n>keys</span><span class=p>,</span><span class=w> </span><span class=n>count</span><span class=p>,</span><span class=w> </span><span class=n>time</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>number</span><span class=o>==</span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>number</span><span class=p>.</span><span class=na>intValue</span><span class=p>()</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>count</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ServiceException</span><span class=p>(</span><span class=s>&#34;访问过于频繁，请稍候再试&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;限制请求&#39;{}&#39;,当前请求&#39;{}&#39;,缓存key&#39;{}&#39;&#34;</span><span class=p>,</span><span class=w> </span><span class=n>count</span><span class=p>,</span><span class=w> </span><span class=n>number</span><span class=p>.</span><span class=na>intValue</span><span class=p>(),</span><span class=w> </span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>ServiceException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=s>&#34;服务器限流异常，请稍候再试&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>getCombineKey</span><span class=p>(</span><span class=n>RateLimiter</span><span class=w> </span><span class=n>rateLimiter</span><span class=p>,</span><span class=w> </span><span class=n>JoinPoint</span><span class=w> </span><span class=n>point</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>StringBuffer</span><span class=w> </span><span class=n>stringBuffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StringBuffer</span><span class=p>(</span><span class=n>rateLimiter</span><span class=p>.</span><span class=na>key</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>rateLimiter</span><span class=p>.</span><span class=na>limitType</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>LimitType</span><span class=p>.</span><span class=na>IP</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>stringBuffer</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>IpUtils</span><span class=p>.</span><span class=na>getIpAddr</span><span class=p>(((</span><span class=n>ServletRequestAttributes</span><span class=p>)</span><span class=w> </span><span class=n>RequestContextHolder</span><span class=p>.</span><span class=na>currentRequestAttributes</span><span class=p>()).</span><span class=na>getRequest</span><span class=p>())).</span><span class=na>append</span><span class=p>(</span><span class=s>&#34;-&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>MethodSignature</span><span class=w> </span><span class=n>signature</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>MethodSignature</span><span class=p>)</span><span class=w> </span><span class=n>point</span><span class=p>.</span><span class=na>getSignature</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Method</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>signature</span><span class=p>.</span><span class=na>getMethod</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>targetClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>method</span><span class=p>.</span><span class=na>getDeclaringClass</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>stringBuffer</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>targetClass</span><span class=p>.</span><span class=na>getName</span><span class=p>()).</span><span class=na>append</span><span class=p>(</span><span class=s>&#34;-&#34;</span><span class=p>).</span><span class=na>append</span><span class=p>(</span><span class=n>method</span><span class=p>.</span><span class=na>getName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>stringBuffer</span><span class=p>.</span><span class=na>toString</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>这个切面就是拦截所有加了 @RateLimiter 注解的方法，在前置通知中对注解进行处理。</p><ol><li>首先获取到注解中的 key、time 以及 count 三个参数。</li><li>获取一个组合的 key，所谓的组合的 key，就是在注解的 key 属性基础上，再加上方法的完整路径，如果是 IP 模式的话，就再加上 IP 地址。以 IP 模式为例，最终生成的 key 类似这样：rate_limit:127.0.0.1-com.demo.ratelimiter.controller.HelloController-hello（如果不是 IP 模式，那么生成的 key 中就不包含 IP 地址）。</li><li>将生成的 key 放到集合中。</li><li>通过 redisTemplate.execute 方法取执行一个 Lua 脚本，第一个参数是脚本所封装的对象，第二个参数是 key，对应了脚本中的 KEYS，后面是可变长度的参数，对应了脚本中的 ARGV。</li><li>将 Lua 脚本执行的结果与 count 进行比较，如果大于 count，就说明过载了，抛异常就行了。</li></ol><h3 id=5-接口测试>5. 接口测试<a hidden class=anchor aria-hidden=true href=#5-接口测试>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RestController</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>HelloController</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/hello&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@RateLimiter</span><span class=p>(</span><span class=n>time</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>5</span><span class=p>,</span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>3</span><span class=p>,</span><span class=n>limitType</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LimitType</span><span class=p>.</span><span class=na>IP</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>hello</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&#34;hello&gt;&gt;&gt;&#34;</span><span class=o>+</span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>每一个 IP 地址，在 5 秒内只能访问 3 次。</p></div><footer class=post-footer><ul class=post-tags><li><a href=http://localhost:1313/blog/tags/springboot/>SpringBoot</a></li><li><a href=http://localhost:1313/blog/tags/redis/>Redis</a></li></ul><nav class=paginav><a class=prev href=http://localhost:1313/blog/posts/operation/nginx%E9%85%8D%E7%BD%AEhttp%E5%92%8Chttps%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86/><span class=title>«</span><br><span>Nginx配置Http和Https正向代理</span>
</a><a class=next href=http://localhost:1313/blog/posts/knowledge/springboot%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3%E6%80%BB%E7%BB%93/><span class=title>»</span><br><span>SpringBoot常用注解总结</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=http://localhost:1313/blog/>Lesan's Blog</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>