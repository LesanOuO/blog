<!doctype html><html lang=zh-cn dir=auto><head><script src="/blog/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=blog/livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>记一次搭建GitLab+Jenkins实现CI&amp;CD | Lesan's Blog</title><meta name=keywords content="CI&amp;CD,GitLab,Jenkins"><meta name=description content="本篇文章记录本人搭建CI&amp;CD实现持续集成和持续部署
1.使用docker安装gitlab
下载镜像 （使用中文社区版）

docker pull twang2218/gitlab-ce-zh
创建所需目录为后续挂载文件
进入所需目录后，打开PowerShell，通过以下命令进行目录创建"><meta name=author content="Lesan"><link rel=canonical href=http://localhost:1313/blog/posts/operation/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%90%AD%E5%BB%BAgitlab+jenkins%E5%AE%9E%E7%8E%B0cicd/><link crossorigin=anonymous href=/blog/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=http://localhost:1313/blog/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://localhost:1313/blog/favicon.ico><link rel=icon type=image/png sizes=32x32 href=http://localhost:1313/blog/favicon.ico><link rel=apple-touch-icon href=http://localhost:1313/blog/favicon.ico><link rel=mask-icon href=http://localhost:1313/blog/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-cn href=http://localhost:1313/blog/posts/operation/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%90%AD%E5%BB%BAgitlab+jenkins%E5%AE%9E%E7%8E%B0cicd/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:url" content="http://localhost:1313/blog/posts/operation/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%90%AD%E5%BB%BAgitlab+jenkins%E5%AE%9E%E7%8E%B0cicd/"><meta property="og:site_name" content="Lesan's Blog"><meta property="og:title" content="记一次搭建GitLab+Jenkins实现CI&CD"><meta property="og:description" content="本篇文章记录本人搭建CI&amp;CD实现持续集成和持续部署
1.使用docker安装gitlab 下载镜像 （使用中文社区版） docker pull twang2218/gitlab-ce-zh
创建所需目录为后续挂载文件 进入所需目录后，打开PowerShell，通过以下命令进行目录创建"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-01T00:00:00+00:00"><meta property="article:modified_time" content="2022-04-01T00:00:00+00:00"><meta property="article:tag" content="CI&CD"><meta property="article:tag" content="GitLab"><meta property="article:tag" content="Jenkins"><meta name=twitter:card content="summary"><meta name=twitter:title content="记一次搭建GitLab+Jenkins实现CI&amp;CD"><meta name=twitter:description content="本篇文章记录本人搭建CI&amp;CD实现持续集成和持续部署
1.使用docker安装gitlab
下载镜像 （使用中文社区版）

docker pull twang2218/gitlab-ce-zh
创建所需目录为后续挂载文件
进入所需目录后，打开PowerShell，通过以下命令进行目录创建"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"📚 博客","item":"http://localhost:1313/blog/posts/"},{"@type":"ListItem","position":2,"name":"记一次搭建GitLab+Jenkins实现CI\u0026CD","item":"http://localhost:1313/blog/posts/operation/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%90%AD%E5%BB%BAgitlab+jenkins%E5%AE%9E%E7%8E%B0cicd/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"记一次搭建GitLab+Jenkins实现CI\u0026CD","name":"记一次搭建GitLab\u002bJenkins实现CI\u0026CD","description":"本篇文章记录本人搭建CI\u0026amp;CD实现持续集成和持续部署\n1.使用docker安装gitlab 下载镜像 （使用中文社区版） docker pull twang2218/gitlab-ce-zh\n创建所需目录为后续挂载文件 进入所需目录后，打开PowerShell，通过以下命令进行目录创建\n","keywords":["CI\u0026CD","GitLab","Jenkins"],"articleBody":"本篇文章记录本人搭建CI\u0026CD实现持续集成和持续部署\n1.使用docker安装gitlab 下载镜像 （使用中文社区版） docker pull twang2218/gitlab-ce-zh\n创建所需目录为后续挂载文件 进入所需目录后，打开PowerShell，通过以下命令进行目录创建\nmkdir -p gitlab/etc 、 mkdir -p gitlab/etc 、 mkdir -p gitlab/etc\n目录结构如下图所示\n启动容器 镜像下载完成后可通过 docker images查看下载结果，再通过镜像启动为容器\ndocker run -d -p 9443:443 -p 9080:80 -p 9022:22 \\ --restart always --name testgitlab \\ -v D:\\testgitlab\\gitlab\\etc:/etc/gitlab \\ -v D:\\testgitlab\\gitlab\\log:/var/log/gitlab \\ -v D:\\testgitlab\\gitlab\\data:/var/opt/gitlab \\ --privileged=true twang2218/gitlab-ce-zh # 执行完成后会返回一串字符串 其中：\n-d：后台执行\n-p：端口映射\n--restart：重启机制\n--name：容器名称\n-v：挂载文件，使得容器内文件在宿主机内有映射\n--privileged：使得容器获取宿主机root权限\n进入容器，修改配置 输入命令 docker exec -it testgitlab bash 即可进入刚刚创建好的容器\n1.修改 gitlab.rb配置的两种方式：1. 进入挂载好的etc目录下找到 gitlab.rb文件进行修改；2. 通过进入容器内进行命令行 vi /etc/gitlab/gitlab.rb 修改\n# 整个gitlab.rb都是注释了的，我们可以按需加入我们的配置\r# 1. gitlab访问地址，可以写域名。如果端口不写的话默认为80端口\reaxternal_url 'http://192.168.3.12:9080'\r# 2. ssh主机ip\rgitlab_rails['gitlab_ssh_host'] = '192.168.3.12'\r# 3. ssh连接端口\rgitlab_rails['gitlab_shell_ssh_port'] = 9022\r# 4. 防止内存占用过大，限制线程数\runicorn['worker_processes'] = 2 2.修改 gitlab.yml配置（这一步原本不是必须的，因为 gitlab.rb内配置会覆盖这个，为了防止没有成功覆盖所以我在这里进行配置，当然你也可以选择不修改 gitlab.rb直接修改这里）\n通过命令行 vi /opt/gitlab/embedded/service/gitlab-rails/config/gitlab.yml修改，或者找到挂载文件修改\n修改上图红框配置\n3.让修改后的配置生效，并重启\ngitlab-ctl reconfigure 、 gitlab-ctl restart 、 exit（退出容器命令行）\n或者重启容器 docker restart testgitlab\n访问gitlab 输入http://192.168.3.12:9080打开页面（ip请输入前面设置的），默认账户root，密码需要重新设置至少8位\n2.使用docker安装jenkins 下载镜像 docker pull jenkins/jenkins\n创建所需目录为后续挂载文件 在服务器上先创建一个jenkins工作目录 /var/jenkins_mount，赋予相应权限，稍后我们将jenkins容器目录挂载到这个目录上，这样我们就可以很方便地对容器内的配置文件进行修改。如何后续在容器内修改的话会非常麻烦，由于容器中无vi命令。\nmkdir -p /var/jenkins_mount 、 chmod 777 /var/jenkins_mount\n启动容器 docker run -d -p 10240:8080 -p 10241:50000 -v D:\\testjenkins\\jenkins_mount:/var/jenkins_home -v /etc/localtime:/etc/localtime --name testjenkins jenkins/jenkins # 其中-v /etc/localtime:/etc/localtime让容器使用和服务器同样的时间设置 可以通过 docker ps来查看启动情况\n可以通过 docker logs testjenkins来查看容器日志\n修改配置 进入刚刚挂载的文件，修改 hudson.model.UpdateCenter.xml文件\n将 url 修改为 清华大学官方镜像：https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json ，配置镜像加速\n还需要修改 default.json文件，位置为 cd /var/jenkins_home/updates\n使用sed命令修改 default.json\nlinux下：\nsed -i 's/http:\\/\\/updates.jenkins-ci.org\\/download/https:\\/\\/mirrors.tuna.tsinghua.edu.cn\\/jenkins/g' default.json \u0026\u0026 sed -i 's/http:\\/\\/www.google.com/https:\\/\\/www.baidu.com/g' default.json mac下：\nsed -i \"\" 's/http:\\/\\/updates.jenkins-ci.org\\/download/https:\\/\\/mirrors.tuna.tsinghua.edu.cn\\/jenkins/g' default.json \u0026\u0026 sed -i \"\" 's/http:\\/\\/www.google.com/https:\\/\\/www.baidu.com/g' default.json 重启容器 docker restart testjenkins\n访问jenkins 输入http://localhost:10240打开页面\n选择默认插件安装即可\n3.gitlab + jenkins 为了实现自动持续构建, 不需要人工操作 ( 留人工操作用于处理特殊情况 )，通过gitlab+jenkins实现CI\u0026CD，具体流程如下\n开发提交代码 开发对需要发布的版本打上 Tag 触发 GitLab 的 tag push 事件, 调用 Webhook Webhook 触发 Jenkins 的构建任务 Jenkins 构建完项目可以按版本号上传到仓库、部署、通知相关人员等等 配置gitlab 建一个测试项目 test ，随便 commit 一些内容，比如通过网页添加 README.md 创建账号的 access token ，用于 Jenkins 调用 GitLab 的 API 记下生成的 access token , 后面需要用到！！！且它只会展示一次，请记录好！！！ 配置jenkins 安装环境所需插件 Git Parameter ( 用于参数化构建中动态获取项目分支 ) Generic Webhook Trigger ( 用于解析 Webhook 传过来的参数 ) GitLab ( 用于推送构建结果给 GitLab ) 添加 GitLab 凭据 在系统配置中配置gitlab 创建新的FreeStyle任务 General 勾选 参数化构建过程, 添加 Git Parameter 类型的参数 ref , 这样构建的时候就可以指定分支进行构建\n源码管理 选择 Git , 添加项目地址和授权方式 ( 帐号密码 或者 ssh key ) , 分支填写构建参数 $ref\n构建触发器 选择 Generic Webhook Trigger 方式用于解析 GitLab 推过来的详细参数 ( jsonpath 在线测试 ) 。其他触发方式中: Trigger builds remotely 是 Jenkins 自带的, Build when a change is pushed to GitLab 是 GitLab 插件 提供的, 都属于简单的触发构建, 无法做复杂的处理\nOptional filter 虽然 Generic Webhook Trigger 提供了 Token 参数进行鉴权, 但为了避免不同项目进行混调 ( 比如 A 项目提交代码却触发了 B 项目的构建) , 还要对请求做下过滤。Optional filter 中 Text 填写需要校验的内容 ( 可使用变量 ) , Expression 使用正则表达式对 Text 进行匹配, 匹配成功才允许触发构建\n构建 构建内容按自己实际的项目类型进行调整, 使用 Maven 插件 或 脚本 等等\n构建后操作 构建后操作添加 Publish build status to GitLab 动作, 实现构建结束后通知构建结果给 GitLab\n在GitLab的项目页面中, 添加一个Webhook 添加一个 Webhook ( http://JENKINS_URL/generic-webhook-trigger/invoke?token=\u003c上面 Jenkins 项目配置中的 token\u003e ) , 触发器选择 标签推送事件。因为日常开发中 push 操作比较频繁而且不是每个版本都需要构建, 所以只针对需要构建的版本打上 Tag 就好了\nhttp://172.20.10.7:10240//generic-webhook-trigger/invoke?token=d63ad84eb18cb04d4459ec347a196dce\n创建完使用 test 按钮 先测试下, 可能会出现下面的错误\nRequests to the local network are not allowed 通过下面方法解决\n测试效果 将代码拉下来在本地操作通过IDEA进行操作\n然后使用快捷键 Cmd + Shift + K 调出 Push 窗口 , 把 Tag 推送到 GitLab 中\n回到 GitLab 页面可以看到触发了 Webhook , View details 查看请求详情, Response body 中 triggered 字段值为 true 则表示成功触发了 Jenkins 进行构建\n注意: 每添加一个 Tag 就会触发一次事件, 不管是不是一起 push 的。所以一次 push 多个 Tag 会触发 Jenkins 进行多次构建。不过 Jenkins 已经做了处理, 默认串行执行任务 ( 一个任务结束再执行下一个 ) , 而且在构建前有一个 pending 状态, 此时被多次触发会进行合并, 并取首次触发的参数, 如下图所示:\n关于 Tag 的几点说明 推送 Tag 到远端的时候, 远端已存在 ( 同名 ) 的 Tag 不会被添加到远端 拉取远端的 Tag 时, 本地已存在 ( 同名 ) 的 Tag 不会添加到本地 拉取远端的 Tag 时, 本地不会删除远端已删除的 Tag , 需要同步远端的 Tag 可以先删除本地所有 Tag 再 pull 删除 Tag 也会推送事件, 要做好过滤 ( 上面配置中已使用 commitsId 字段进行过滤 ) 本篇文章产考下列文章：\ndocker安装gitlab\ndocker安装jenkins\ndocker中jenkins插件加速\n整合gitlab+jenkins\n","wordCount":"2647","inLanguage":"zh-cn","datePublished":"2022-04-01T00:00:00Z","dateModified":"2022-04-01T00:00:00Z","author":{"@type":"Person","name":"Lesan"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:1313/blog/posts/operation/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%90%AD%E5%BB%BAgitlab+jenkins%E5%AE%9E%E7%8E%B0cicd/"},"publisher":{"@type":"Organization","name":"Lesan's Blog","logo":{"@type":"ImageObject","url":"http://localhost:1313/blog/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://localhost:1313/blog/ accesskey=h title="Lesan's Blog (Alt + H)">Lesan's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://localhost:1313/blog/archives title="📚 归档"><span>📚 归档</span></a></li><li><a href=http://localhost:1313/blog/categories/ title="🗃️ 分类"><span>🗃️ 分类</span></a></li><li><a href=http://localhost:1313/blog/tags/ title="🏷️ 标签"><span>🏷️ 标签</span></a></li><li><a href=http://localhost:1313/blog/search/ title="🔎 搜索"><span>🔎 搜索</span></a></li><li><a href=http://localhost:1313/blog/about/ title="👨‍💻 关于我"><span>👨‍💻 关于我</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://localhost:1313/blog/>Home</a>&nbsp;»&nbsp;<a href=http://localhost:1313/blog/posts/>📚 博客</a></div><h1 class="post-title entry-hint-parent">记一次搭建GitLab+Jenkins实现CI&amp;CD</h1><div class=post-meta><span title='2022-04-01 00:00:00 +0000 UTC'>2022-04-01</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;Lesan</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#1%e4%bd%bf%e7%94%a8docker%e5%ae%89%e8%a3%85gitlab aria-label=1.使用docker安装gitlab>1.使用docker安装gitlab</a><ul><li><a href=#%e4%b8%8b%e8%bd%bd%e9%95%9c%e5%83%8f-%e4%bd%bf%e7%94%a8%e4%b8%ad%e6%96%87%e7%a4%be%e5%8c%ba%e7%89%88 aria-label="下载镜像 （使用中文社区版）">下载镜像 （使用中文社区版）</a></li><li><a href=#%e5%88%9b%e5%bb%ba%e6%89%80%e9%9c%80%e7%9b%ae%e5%bd%95%e4%b8%ba%e5%90%8e%e7%bb%ad%e6%8c%82%e8%bd%bd%e6%96%87%e4%bb%b6 aria-label=创建所需目录为后续挂载文件>创建所需目录为后续挂载文件</a></li><li><a href=#%e5%90%af%e5%8a%a8%e5%ae%b9%e5%99%a8 aria-label=启动容器>启动容器</a></li><li><a href=#%e8%bf%9b%e5%85%a5%e5%ae%b9%e5%99%a8%e4%bf%ae%e6%94%b9%e9%85%8d%e7%bd%ae aria-label=进入容器，修改配置>进入容器，修改配置</a></li><li><a href=#%e8%ae%bf%e9%97%aegitlab aria-label=访问gitlab>访问gitlab</a></li></ul></li><li><a href=#2%e4%bd%bf%e7%94%a8docker%e5%ae%89%e8%a3%85jenkins aria-label=2.使用docker安装jenkins>2.使用docker安装jenkins</a><ul><li><a href=#%e4%b8%8b%e8%bd%bd%e9%95%9c%e5%83%8f aria-label=下载镜像>下载镜像</a></li><li><a href=#%e5%88%9b%e5%bb%ba%e6%89%80%e9%9c%80%e7%9b%ae%e5%bd%95%e4%b8%ba%e5%90%8e%e7%bb%ad%e6%8c%82%e8%bd%bd%e6%96%87%e4%bb%b6-1 aria-label=创建所需目录为后续挂载文件>创建所需目录为后续挂载文件</a></li><li><a href=#%e5%90%af%e5%8a%a8%e5%ae%b9%e5%99%a8-1 aria-label=启动容器>启动容器</a></li><li><a href=#%e4%bf%ae%e6%94%b9%e9%85%8d%e7%bd%ae aria-label=修改配置>修改配置</a></li><li><a href=#%e8%ae%bf%e9%97%aejenkins aria-label=访问jenkins>访问jenkins</a></li></ul></li><li><a href=#3gitlab--jenkins aria-label="3.gitlab + jenkins">3.gitlab + jenkins</a><ul><li><a href=#%e9%85%8d%e7%bd%aegitlab aria-label=配置gitlab>配置gitlab</a></li><li><a href=#%e9%85%8d%e7%bd%aejenkins aria-label=配置jenkins>配置jenkins</a><ul><li><a href=#%e5%ae%89%e8%a3%85%e7%8e%af%e5%a2%83%e6%89%80%e9%9c%80%e6%8f%92%e4%bb%b6 aria-label=安装环境所需插件>安装环境所需插件</a></li><li><a href=#%e6%b7%bb%e5%8a%a0-gitlab-%e5%87%ad%e6%8d%ae aria-label="添加 GitLab 凭据">添加 GitLab 凭据</a></li><li><a href=#%e5%9c%a8%e7%b3%bb%e7%bb%9f%e9%85%8d%e7%bd%ae%e4%b8%ad%e9%85%8d%e7%bd%aegitlab aria-label=在系统配置中配置gitlab>在系统配置中配置gitlab</a></li><li><a href=#%e5%88%9b%e5%bb%ba%e6%96%b0%e7%9a%84freestyle%e4%bb%bb%e5%8a%a1 aria-label=创建新的FreeStyle任务>创建新的FreeStyle任务</a></li><li><a href=#%e5%9c%a8gitlab%e7%9a%84%e9%a1%b9%e7%9b%ae%e9%a1%b5%e9%9d%a2%e4%b8%ad-%e6%b7%bb%e5%8a%a0%e4%b8%80%e4%b8%aawebhook aria-label="在GitLab的项目页面中, 添加一个Webhook">在GitLab的项目页面中, 添加一个Webhook</a></li></ul></li><li><a href=#%e6%b5%8b%e8%af%95%e6%95%88%e6%9e%9c aria-label=测试效果>测试效果</a></li><li><a href=#%e5%85%b3%e4%ba%8e-tag-%e7%9a%84%e5%87%a0%e7%82%b9%e8%af%b4%e6%98%8e aria-label="关于 Tag 的几点说明">关于 Tag 的几点说明</a></li></ul></li></ul></div></details></div><div class=post-content><p>本篇文章记录本人搭建CI&amp;CD实现持续集成和持续部署</p><h2 id=1使用docker安装gitlab>1.使用docker安装gitlab<a hidden class=anchor aria-hidden=true href=#1使用docker安装gitlab>#</a></h2><h3 id=下载镜像-使用中文社区版>下载镜像 （使用中文社区版）<a hidden class=anchor aria-hidden=true href=#下载镜像-使用中文社区版>#</a></h3><p><img loading=lazy src=images/1.png></p><p><code>docker pull twang2218/gitlab-ce-zh</code></p><h3 id=创建所需目录为后续挂载文件>创建所需目录为后续挂载文件<a hidden class=anchor aria-hidden=true href=#创建所需目录为后续挂载文件>#</a></h3><p>进入所需目录后，打开PowerShell，通过以下命令进行目录创建</p><p><code>mkdir -p gitlab/etc </code>、 <code>mkdir -p gitlab/etc</code> 、 <code>mkdir -p gitlab/etc</code></p><p>目录结构如下图所示</p><p><img loading=lazy src=images/2.png></p><h3 id=启动容器>启动容器<a hidden class=anchor aria-hidden=true href=#启动容器>#</a></h3><p>镜像下载完成后可通过 <code>docker images</code>查看下载结果，再通过镜像启动为容器</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run -d -p 9443:443 -p 9080:80 -p 9022:22 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--restart always --name testgitlab <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-v D:<span class=se>\t</span>estgitlab<span class=se>\g</span>itlab<span class=se>\e</span>tc:/etc/gitlab <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-v D:<span class=se>\t</span>estgitlab<span class=se>\g</span>itlab<span class=se>\l</span>og:/var/log/gitlab <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-v D:<span class=se>\t</span>estgitlab<span class=se>\g</span>itlab<span class=se>\d</span>ata:/var/opt/gitlab <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--privileged<span class=o>=</span><span class=nb>true</span> twang2218/gitlab-ce-zh
</span></span><span class=line><span class=cl><span class=c1># 执行完成后会返回一串字符串</span>
</span></span></code></pre></div><p>其中：</p><p><code>-d：</code>后台执行</p><p><code>-p：</code>端口映射</p><p><code>--restart：</code>重启机制</p><p><code>--name：</code>容器名称</p><p><code>-v：</code>挂载文件，使得容器内文件在宿主机内有映射</p><p><code>--privileged：</code>使得容器获取宿主机root权限</p><h3 id=进入容器修改配置>进入容器，修改配置<a hidden class=anchor aria-hidden=true href=#进入容器修改配置>#</a></h3><p>输入命令 <code>docker exec -it testgitlab bash</code> 即可进入刚刚创建好的容器</p><p>1.修改 <code>gitlab.rb</code>配置的两种方式：1. 进入挂载好的etc目录下找到 <code>gitlab.rb</code>文件进行修改；2. 通过进入容器内进行命令行 <code>vi /etc/gitlab/gitlab.rb </code>修改</p><pre tabindex=0><code># 整个gitlab.rb都是注释了的，我们可以按需加入我们的配置
# 1. gitlab访问地址，可以写域名。如果端口不写的话默认为80端口
eaxternal_url &#39;http://192.168.3.12:9080&#39;
# 2. ssh主机ip
gitlab_rails[&#39;gitlab_ssh_host&#39;] = &#39;192.168.3.12&#39;
# 3. ssh连接端口
gitlab_rails[&#39;gitlab_shell_ssh_port&#39;] = 9022
# 4. 防止内存占用过大，限制线程数
unicorn[&#39;worker_processes&#39;] = 2
</code></pre><p>2.修改 <code>gitlab.yml</code>配置（这一步原本不是必须的，因为 <code>gitlab.rb</code>内配置会覆盖这个，为了防止没有成功覆盖所以我在这里进行配置，当然你也可以选择不修改 <code>gitlab.rb</code>直接修改这里）</p><p>通过命令行 <code>vi /opt/gitlab/embedded/service/gitlab-rails/config/gitlab.yml</code>修改，或者找到挂载文件修改</p><p><img loading=lazy src=images/3.png></p><p><img loading=lazy src=images/4.png></p><p>修改上图红框配置</p><p>3.让修改后的配置生效，并重启</p><p><code>gitlab-ctl reconfigure</code> 、 <code>gitlab-ctl restart</code> 、 <code>exit</code>（退出容器命令行）</p><p>或者重启容器 <code>docker restart testgitlab</code></p><h3 id=访问gitlab>访问gitlab<a hidden class=anchor aria-hidden=true href=#访问gitlab>#</a></h3><p>输入http://192.168.3.12:9080打开页面（ip请输入前面设置的），默认账户root，密码需要重新设置至少8位</p><p><img loading=lazy src=images/5.png></p><h2 id=2使用docker安装jenkins>2.使用docker安装jenkins<a hidden class=anchor aria-hidden=true href=#2使用docker安装jenkins>#</a></h2><h3 id=下载镜像>下载镜像<a hidden class=anchor aria-hidden=true href=#下载镜像>#</a></h3><p><code>docker pull jenkins/jenkins</code></p><h3 id=创建所需目录为后续挂载文件-1>创建所需目录为后续挂载文件<a hidden class=anchor aria-hidden=true href=#创建所需目录为后续挂载文件-1>#</a></h3><p>在服务器上先创建一个jenkins工作目录 /var/jenkins_mount，赋予相应权限，稍后我们将jenkins容器目录挂载到这个目录上，这样我们就可以很方便地对容器内的配置文件进行修改。如何后续在容器内修改的话会非常麻烦，由于容器中无vi命令。</p><p><code>mkdir -p /var/jenkins_mount</code> 、 <code>chmod 777 /var/jenkins_mount</code></p><h3 id=启动容器-1>启动容器<a hidden class=anchor aria-hidden=true href=#启动容器-1>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run -d -p 10240:8080 -p 10241:50000 -v D:<span class=se>\t</span>estjenkins<span class=se>\j</span>enkins_mount:/var/jenkins_home -v /etc/localtime:/etc/localtime --name testjenkins jenkins/jenkins
</span></span><span class=line><span class=cl><span class=c1># 其中-v /etc/localtime:/etc/localtime让容器使用和服务器同样的时间设置</span>
</span></span></code></pre></div><p>可以通过 <code>docker ps</code>来查看启动情况</p><p>可以通过 <code>docker logs testjenkins</code>来查看容器日志</p><h3 id=修改配置>修改配置<a hidden class=anchor aria-hidden=true href=#修改配置>#</a></h3><p>进入刚刚挂载的文件，修改 <code>hudson.model.UpdateCenter.xml</code>文件</p><p>将 url 修改为 清华大学官方镜像：https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json ，配置镜像加速</p><p><img loading=lazy src=images/6.png></p><p>还需要修改 <code>default.json</code>文件，位置为 <code>cd /var/jenkins_home/updates</code></p><p>使用sed命令修改 <code>default.json</code></p><p>linux下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sed -i <span class=s1>&#39;s/http:\/\/updates.jenkins-ci.org\/download/https:\/\/mirrors.tuna.tsinghua.edu.cn\/jenkins/g&#39;</span> default.json <span class=o>&amp;&amp;</span> sed -i <span class=s1>&#39;s/http:\/\/www.google.com/https:\/\/www.baidu.com/g&#39;</span> default.json
</span></span></code></pre></div><p>mac下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sed -i <span class=s2>&#34;&#34;</span> <span class=s1>&#39;s/http:\/\/updates.jenkins-ci.org\/download/https:\/\/mirrors.tuna.tsinghua.edu.cn\/jenkins/g&#39;</span> default.json <span class=o>&amp;&amp;</span> sed -i <span class=s2>&#34;&#34;</span> <span class=s1>&#39;s/http:\/\/www.google.com/https:\/\/www.baidu.com/g&#39;</span> default.json
</span></span></code></pre></div><p>重启容器 <code>docker restart testjenkins</code></p><h3 id=访问jenkins>访问jenkins<a hidden class=anchor aria-hidden=true href=#访问jenkins>#</a></h3><p>输入http://localhost:10240打开页面</p><p><img loading=lazy src=images/7.png></p><p>选择默认插件安装即可</p><h2 id=3gitlab--jenkins>3.gitlab + jenkins<a hidden class=anchor aria-hidden=true href=#3gitlab--jenkins>#</a></h2><p>为了实现自动持续构建, 不需要人工操作 ( 留人工操作用于处理特殊情况 )，通过gitlab+jenkins实现CI&amp;CD，具体流程如下</p><p><img loading=lazy src=images/8.png></p><ol><li>开发提交代码</li><li>开发对需要发布的版本打上 <strong>Tag</strong></li><li>触发 <strong>GitLab</strong> 的 <strong>tag push</strong> 事件, 调用 <strong>Webhook</strong></li><li><strong>Webhook</strong> 触发 <strong>Jenkins</strong> 的构建任务</li><li><strong>Jenkins</strong> 构建完项目可以按版本号上传到仓库、部署、通知相关人员等等</li></ol><h3 id=配置gitlab>配置gitlab<a hidden class=anchor aria-hidden=true href=#配置gitlab>#</a></h3><ol><li>建一个测试项目 <strong>test</strong> ，随便 <strong>commit</strong> 一些内容，比如通过网页添加 <code>README.md</code></li></ol><p><img loading=lazy src=images/9.png></p><ol start=2><li>创建账号的 <strong>access token</strong> ，用于 <strong>Jenkins</strong> 调用 <strong>GitLab</strong> 的 <strong>API</strong></li></ol><p><img loading=lazy src=images/10.png></p><ol start=3><li>记下生成的 <strong>access token</strong> , 后面需要用到！！！且它只会展示一次，请记录好！！！</li></ol><p><img loading=lazy src=images/11.png></p><h3 id=配置jenkins>配置jenkins<a hidden class=anchor aria-hidden=true href=#配置jenkins>#</a></h3><h4 id=安装环境所需插件>安装环境所需插件<a hidden class=anchor aria-hidden=true href=#安装环境所需插件>#</a></h4><ul><li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fwiki.jenkins.io%2Fdisplay%2FJENKINS%2FGit%2BParameter%2BPlugin">Git Parameter</a> ( 用于参数化构建中动态获取项目分支 )</li><li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fwiki.jenkins-ci.org%2Fdisplay%2FJENKINS%2FGeneric%2BWebhook%2BTrigger%2BPlugin">Generic Webhook Trigger</a> ( 用于解析 <strong>Webhook</strong> 传过来的参数 )</li><li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fwiki.jenkins-ci.org%2Fdisplay%2FJENKINS%2FGitLab%2BPlugin">GitLab</a> ( 用于推送构建结果给 <strong>GitLab</strong> )</li></ul><h4 id=添加-gitlab-凭据>添加 GitLab 凭据<a hidden class=anchor aria-hidden=true href=#添加-gitlab-凭据>#</a></h4><p><img loading=lazy src=images/12.png></p><p><img loading=lazy src=images/13.png></p><p><img loading=lazy src=images/14.png></p><h4 id=在系统配置中配置gitlab>在系统配置中配置gitlab<a hidden class=anchor aria-hidden=true href=#在系统配置中配置gitlab>#</a></h4><p><img loading=lazy src=images/15.png></p><p><img loading=lazy src=images/16.png></p><h4 id=创建新的freestyle任务>创建新的FreeStyle任务<a hidden class=anchor aria-hidden=true href=#创建新的freestyle任务>#</a></h4><ul><li><strong>General</strong></li></ul><p><strong>勾选</strong> 参数化构建过程, 添加 <strong>Git Parameter</strong> 类型的参数 <strong>ref</strong> , 这样构建的时候就可以指定分支进行构建</p><p><img loading=lazy src=images/17.png></p><ul><li><strong>源码管理</strong></li></ul><p>选择 <strong>Git</strong> , 添加项目地址和授权方式 ( <strong>帐号密码</strong> 或者 <strong>ssh key</strong> ) , 分支填写构建参数 <strong>$ref</strong></p><p><img loading=lazy src=images/18.png></p><ul><li><strong>构建触发器</strong></li></ul><p>选择 <strong>Generic Webhook Trigger</strong> 方式用于解析 <strong>GitLab</strong> 推过来的详细参数 ( <a href="https://links.jianshu.com/go?to=http%3A%2F%2Fjsonpath.com">jsonpath 在线测试</a> ) 。其他触发方式中: <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fwww.cnblogs.com%2Fjwentest%2Fp%2F8204421.html">Trigger builds remotely</a> 是 <strong>Jenkins</strong> 自带的, <strong>Build when a change is pushed to GitLab</strong> 是 <strong>GitLab 插件</strong> 提供的, 都属于简单的触发构建, 无法做复杂的处理</p><p><img loading=lazy src=images/19.png></p><ul><li><strong>Optional filter</strong></li></ul><p>虽然 <strong>Generic Webhook Trigger</strong> 提供了 <strong>Token</strong> 参数进行鉴权, 但为了避免不同项目进行混调 ( 比如 A 项目提交代码却触发了 B 项目的构建) , 还要对请求做下过滤。<strong>Optional filter</strong> 中 <strong>Text</strong> 填写需要校验的内容 ( 可使用变量 ) , <strong>Expression</strong> 使用正则表达式对 <strong>Text</strong> 进行匹配, 匹配成功才允许触发构建</p><p><img loading=lazy src=images/20.png></p><ul><li><strong>构建</strong></li></ul><p>构建内容按自己实际的项目类型进行调整, 使用 <strong>Maven 插件</strong> 或 <strong>脚本</strong> 等等</p><p><img loading=lazy src=images/21.png></p><ul><li><strong>构建后操作</strong></li></ul><p>构建后操作添加 <strong>Publish build status to GitLab</strong> 动作, 实现构建结束后通知构建结果给 <strong>GitLab</strong></p><p><img loading=lazy src=images/22.png></p><h4 id=在gitlab的项目页面中-添加一个webhook>在GitLab的项目页面中, 添加一个Webhook<a hidden class=anchor aria-hidden=true href=#在gitlab的项目页面中-添加一个webhook>#</a></h4><p>添加一个 <strong>Webhook</strong> ( <a href="https://links.jianshu.com/go?to=http%3A%2F%2FJENKINS_URL%2Fgeneric-webhook-trigger%2Finvoke%3Ftoken%3D">http://JENKINS_URL/generic-webhook-trigger/invoke?token=</a>&lt;上面 <strong>Jenkins</strong> 项目配置中的 <strong>token</strong>> ) , 触发器选择 <strong>标签推送事件</strong>。因为日常开发中 <strong>push</strong> 操作比较频繁而且不是每个版本都需要构建, 所以只针对需要构建的版本打上 <strong>Tag</strong> 就好了</p><p><code>http://172.20.10.7:10240//generic-webhook-trigger/invoke?token=d63ad84eb18cb04d4459ec347a196dce</code></p><p><img loading=lazy src=images/23.png></p><p>创建完使用 <strong>test 按钮</strong> 先测试下, 可能会出现下面的错误</p><p><code>Requests to the local network are not allowed</code> 通过下面方法解决</p><p><img loading=lazy src=images/24.png></p><h3 id=测试效果>测试效果<a hidden class=anchor aria-hidden=true href=#测试效果>#</a></h3><p>将代码拉下来在本地操作通过IDEA进行操作</p><p><img loading=lazy src=images/25.png></p><p>然后使用快捷键 <strong>Cmd + Shift + K</strong> 调出 <strong>Push 窗口</strong> , 把 <strong>Tag</strong> 推送到 <strong>GitLab</strong> 中</p><p><img loading=lazy src=images/26.png></p><p>回到 <strong>GitLab</strong> 页面可以看到触发了 <strong>Webhook</strong> , <strong>View details</strong> 查看请求详情, <strong>Response body</strong> 中 <code>triggered</code> 字段值为 <code>true</code> 则表示成功触发了 <strong>Jenkins</strong> 进行构建</p><p><img loading=lazy src=images/27.png></p><p><strong>注意:</strong> 每添加一个 <strong>Tag</strong> 就会触发一次事件, 不管是不是一起 <strong>push</strong> 的。所以一次 <strong>push</strong> 多个 <strong>Tag</strong> 会触发 <strong>Jenkins</strong> 进行多次构建。不过 <strong>Jenkins</strong> 已经做了处理, 默认串行执行任务 ( 一个任务结束再执行下一个 ) , 而且在构建前有一个 <strong>pending</strong> 状态, 此时被多次触发会进行合并, 并取首次触发的参数, 如下图所示:</p><p><img loading=lazy src=images/28.png></p><h3 id=关于-tag-的几点说明>关于 Tag 的几点说明<a hidden class=anchor aria-hidden=true href=#关于-tag-的几点说明>#</a></h3><ul><li>推送 <strong>Tag</strong> 到远端的时候, 远端已存在 ( 同名 ) 的 <strong>Tag</strong> 不会被添加到远端</li><li>拉取远端的 <strong>Tag</strong> 时, 本地已存在 ( 同名 ) 的 <strong>Tag</strong> 不会添加到本地</li><li>拉取远端的 <strong>Tag</strong> 时, 本地不会删除远端已删除的 <strong>Tag</strong> , 需要同步远端的 <strong>Tag</strong> 可以先删除本地所有 <strong>Tag</strong> 再 <strong>pull</strong></li><li>删除 <strong>Tag</strong> 也会推送事件, 要做好过滤 ( 上面配置中已使用 <strong>commitsId</strong> 字段进行过滤 )</li></ul><blockquote><p>本篇文章产考下列文章：<br><a href=https://www.cnblogs.com/hanease/p/15690227.html>docker安装gitlab</a><br><a href=https://www.cnblogs.com/fuzongle/p/12834080.html>docker安装jenkins</a><br><a href=https://juejin.cn/post/6844904137570648072>docker中jenkins插件加速</a><br><a href=https://www.jianshu.com/p/7e8037c63d63>整合gitlab+jenkins</a></p></blockquote></div><footer class=post-footer><ul class=post-tags><li><a href=http://localhost:1313/blog/tags/cicd/>CI&amp;CD</a></li><li><a href=http://localhost:1313/blog/tags/gitlab/>GitLab</a></li><li><a href=http://localhost:1313/blog/tags/jenkins/>Jenkins</a></li></ul><nav class=paginav><a class=prev href=http://localhost:1313/blog/posts/share/%E5%88%86%E4%BA%AB%E5%8F%AF%E7%A7%81%E6%9C%89%E9%83%A8%E7%BD%B2%E7%9A%84%E6%8E%A5%E5%8F%A3%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9Fyapi/><span class=title>«</span><br><span>分享可私有部署的接口管理系统Yapi</span>
</a><a class=next href=http://localhost:1313/blog/posts/operation/164831040001/><span class=title>»</span><br><span>构建一个带libgdiplus的.NET基础Docker镜像</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=http://localhost:1313/blog/>Lesan's Blog</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>