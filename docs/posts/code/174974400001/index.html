<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>dynamic-datasource文档 | Lesan's Blog</title><meta name=keywords content="数据库"><meta name=description content="本文为 dynamic-datasource-spring-boot-starter （基于SpringBoot的快速集成多数据源框架）的使用文档。
特性

支持 数据源分组 ，适用于多种场景，纯粹多库、读写分离、一主多从、混合模式。
支持数据库敏感配置信息 加密(可自定义) ENC()。
支持每个数据库独立初始化表结构schema和数据库database。
支持无数据源启动，支持 懒加载数据源 （需要的时候再创建连接）。
支持 自定义注解 ，需继承DS(3.2.0+)。
提供并简化对Druid，HikariCp，BeeCp，Dbcp2的快速集成。
提供对 Mybatis-Plus ，Quartz，ShardingJdbc，P6sy，Jndi等组件的集成方案。
提供 自定义数据源来源 方案（如全从数据库加载）。
提供项目启动后 动态增加移除数据源 方案。
提供Mybatis环境下的 纯读写分离 方案。
提供使用 spel动态参数 解析数据源方案。内置spel，session，header，支持自定义。
支持 多层数据源嵌套切换 。（ServiceA &#187;> ServiceB &#187;> ServiceC）。
提供 基于seata的分布式事务方案 。
提供 本地多数据源事务方案 。

约定

dynamic-datasource只做 切换数据源 这件核心的事情，并 不限制你的具体操作 ，切换了数据源可以做任何CRUD。
配置文件所有以下划线 _ 分割的数据源 首部 即为组的名称，相同组名称的数据源会放在一个组下。
切换数据源可以是组名，也可以是具体数据源名称。 组名则切换时采用负载均衡算法切换 。
默认的数据源名称为 master ，你可以通过 spring.datasource.dynamic.primary 修改。
方法上的注解优先于类上注解。
DS支持继承抽象类上的DS，暂不支持继承接口上的DS。

使用方法

引入dynamic-datasource-spring-boot-starter

spring-boot 1.5.x、2.x.x"><meta name=author content="Lesan"><link rel=canonical href=https://lesanouo.github.io/blog/posts/code/174974400001/><link crossorigin=anonymous href=/blog/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://lesanouo.github.io/blog/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://lesanouo.github.io/blog/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://lesanouo.github.io/blog/favicon.ico><link rel=apple-touch-icon href=https://lesanouo.github.io/blog/favicon.ico><link rel=mask-icon href=https://lesanouo.github.io/blog/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-cn href=https://lesanouo.github.io/blog/posts/code/174974400001/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:url" content="https://lesanouo.github.io/blog/posts/code/174974400001/"><meta property="og:site_name" content="Lesan's Blog"><meta property="og:title" content="dynamic-datasource文档"><meta property="og:description" content="本文为 dynamic-datasource-spring-boot-starter （基于SpringBoot的快速集成多数据源框架）的使用文档。
特性 支持 数据源分组 ，适用于多种场景，纯粹多库、读写分离、一主多从、混合模式。 支持数据库敏感配置信息 加密(可自定义) ENC()。 支持每个数据库独立初始化表结构schema和数据库database。 支持无数据源启动，支持 懒加载数据源 （需要的时候再创建连接）。 支持 自定义注解 ，需继承DS(3.2.0+)。 提供并简化对Druid，HikariCp，BeeCp，Dbcp2的快速集成。 提供对 Mybatis-Plus ，Quartz，ShardingJdbc，P6sy，Jndi等组件的集成方案。 提供 自定义数据源来源 方案（如全从数据库加载）。 提供项目启动后 动态增加移除数据源 方案。 提供Mybatis环境下的 纯读写分离 方案。 提供使用 spel动态参数 解析数据源方案。内置spel，session，header，支持自定义。 支持 多层数据源嵌套切换 。（ServiceA »> ServiceB »> ServiceC）。 提供 基于seata的分布式事务方案 。 提供 本地多数据源事务方案 。 约定 dynamic-datasource只做 切换数据源 这件核心的事情，并 不限制你的具体操作 ，切换了数据源可以做任何CRUD。 配置文件所有以下划线 _ 分割的数据源 首部 即为组的名称，相同组名称的数据源会放在一个组下。 切换数据源可以是组名，也可以是具体数据源名称。 组名则切换时采用负载均衡算法切换 。 默认的数据源名称为 master ，你可以通过 spring.datasource.dynamic.primary 修改。 方法上的注解优先于类上注解。 DS支持继承抽象类上的DS，暂不支持继承接口上的DS。 使用方法 引入dynamic-datasource-spring-boot-starter spring-boot 1.5.x、2.x.x"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-06-13T00:00:00+00:00"><meta property="article:modified_time" content="2025-06-13T00:00:00+00:00"><meta property="article:tag" content="数据库"><meta name=twitter:card content="summary"><meta name=twitter:title content="dynamic-datasource文档"><meta name=twitter:description content="本文为 dynamic-datasource-spring-boot-starter （基于SpringBoot的快速集成多数据源框架）的使用文档。
特性

支持 数据源分组 ，适用于多种场景，纯粹多库、读写分离、一主多从、混合模式。
支持数据库敏感配置信息 加密(可自定义) ENC()。
支持每个数据库独立初始化表结构schema和数据库database。
支持无数据源启动，支持 懒加载数据源 （需要的时候再创建连接）。
支持 自定义注解 ，需继承DS(3.2.0+)。
提供并简化对Druid，HikariCp，BeeCp，Dbcp2的快速集成。
提供对 Mybatis-Plus ，Quartz，ShardingJdbc，P6sy，Jndi等组件的集成方案。
提供 自定义数据源来源 方案（如全从数据库加载）。
提供项目启动后 动态增加移除数据源 方案。
提供Mybatis环境下的 纯读写分离 方案。
提供使用 spel动态参数 解析数据源方案。内置spel，session，header，支持自定义。
支持 多层数据源嵌套切换 。（ServiceA &#187;> ServiceB &#187;> ServiceC）。
提供 基于seata的分布式事务方案 。
提供 本地多数据源事务方案 。

约定

dynamic-datasource只做 切换数据源 这件核心的事情，并 不限制你的具体操作 ，切换了数据源可以做任何CRUD。
配置文件所有以下划线 _ 分割的数据源 首部 即为组的名称，相同组名称的数据源会放在一个组下。
切换数据源可以是组名，也可以是具体数据源名称。 组名则切换时采用负载均衡算法切换 。
默认的数据源名称为 master ，你可以通过 spring.datasource.dynamic.primary 修改。
方法上的注解优先于类上注解。
DS支持继承抽象类上的DS，暂不支持继承接口上的DS。

使用方法

引入dynamic-datasource-spring-boot-starter

spring-boot 1.5.x、2.x.x"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"📚 博客","item":"https://lesanouo.github.io/blog/posts/"},{"@type":"ListItem","position":2,"name":"dynamic-datasource文档","item":"https://lesanouo.github.io/blog/posts/code/174974400001/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"dynamic-datasource文档","name":"dynamic-datasource文档","description":"本文为 dynamic-datasource-spring-boot-starter （基于SpringBoot的快速集成多数据源框架）的使用文档。\n特性 支持 数据源分组 ，适用于多种场景，纯粹多库、读写分离、一主多从、混合模式。 支持数据库敏感配置信息 加密(可自定义) ENC()。 支持每个数据库独立初始化表结构schema和数据库database。 支持无数据源启动，支持 懒加载数据源 （需要的时候再创建连接）。 支持 自定义注解 ，需继承DS(3.2.0+)。 提供并简化对Druid，HikariCp，BeeCp，Dbcp2的快速集成。 提供对 Mybatis-Plus ，Quartz，ShardingJdbc，P6sy，Jndi等组件的集成方案。 提供 自定义数据源来源 方案（如全从数据库加载）。 提供项目启动后 动态增加移除数据源 方案。 提供Mybatis环境下的 纯读写分离 方案。 提供使用 spel动态参数 解析数据源方案。内置spel，session，header，支持自定义。 支持 多层数据源嵌套切换 。（ServiceA \u0026raquo;\u0026gt; ServiceB \u0026raquo;\u0026gt; ServiceC）。 提供 基于seata的分布式事务方案 。 提供 本地多数据源事务方案 。 约定 dynamic-datasource只做 切换数据源 这件核心的事情，并 不限制你的具体操作 ，切换了数据源可以做任何CRUD。 配置文件所有以下划线 _ 分割的数据源 首部 即为组的名称，相同组名称的数据源会放在一个组下。 切换数据源可以是组名，也可以是具体数据源名称。 组名则切换时采用负载均衡算法切换 。 默认的数据源名称为 master ，你可以通过 spring.datasource.dynamic.primary 修改。 方法上的注解优先于类上注解。 DS支持继承抽象类上的DS，暂不支持继承接口上的DS。 使用方法 引入dynamic-datasource-spring-boot-starter spring-boot 1.5.x、2.x.x\n","keywords":["数据库"],"articleBody":"本文为 dynamic-datasource-spring-boot-starter （基于SpringBoot的快速集成多数据源框架）的使用文档。\n特性 支持 数据源分组 ，适用于多种场景，纯粹多库、读写分离、一主多从、混合模式。 支持数据库敏感配置信息 加密(可自定义) ENC()。 支持每个数据库独立初始化表结构schema和数据库database。 支持无数据源启动，支持 懒加载数据源 （需要的时候再创建连接）。 支持 自定义注解 ，需继承DS(3.2.0+)。 提供并简化对Druid，HikariCp，BeeCp，Dbcp2的快速集成。 提供对 Mybatis-Plus ，Quartz，ShardingJdbc，P6sy，Jndi等组件的集成方案。 提供 自定义数据源来源 方案（如全从数据库加载）。 提供项目启动后 动态增加移除数据源 方案。 提供Mybatis环境下的 纯读写分离 方案。 提供使用 spel动态参数 解析数据源方案。内置spel，session，header，支持自定义。 支持 多层数据源嵌套切换 。（ServiceA »\u003e ServiceB »\u003e ServiceC）。 提供 基于seata的分布式事务方案 。 提供 本地多数据源事务方案 。 约定 dynamic-datasource只做 切换数据源 这件核心的事情，并 不限制你的具体操作 ，切换了数据源可以做任何CRUD。 配置文件所有以下划线 _ 分割的数据源 首部 即为组的名称，相同组名称的数据源会放在一个组下。 切换数据源可以是组名，也可以是具体数据源名称。 组名则切换时采用负载均衡算法切换 。 默认的数据源名称为 master ，你可以通过 spring.datasource.dynamic.primary 修改。 方法上的注解优先于类上注解。 DS支持继承抽象类上的DS，暂不支持继承接口上的DS。 使用方法 引入dynamic-datasource-spring-boot-starter spring-boot 1.5.x、2.x.x\ncom.baomidou dynamic-datasource-spring-boot-starter ${version} spring-boot3及以上\ncom.baomidou dynamic-datasource-spring-boot3-starter ${version} 配置数据源 spring: datasource: dynamic: primary: master # 设置默认的数据源或者数据源组,默认值即为master strict: false # 严格匹配数据源,默认false. true未匹配到指定数据源时抛异常,false使用默认数据源 datasource: master: url: jdbc:mysql://xx.xx.xx.xx:3306/dynamic username: root password: 123456 driver-class-name: com.mysql.cj.jdbc.Driver # 3.2.0开始支持SPI可省略此配置 slave_1: url: jdbc:mysql://xx.xx.xx.xx:3307/dynamic username: root password: 123456 driver-class-name: com.mysql.cj.jdbc.Driver slave_2: url: ENC(xxxxx) # 内置加密,使用请查看详细文档 username: ENC(xxxxx) password: ENC(xxxxx) driver-class-name: com.mysql.cj.jdbc.Driver # ......省略 # 以上会配置一个默认库master，一个组slave下有两个子库slave_1,slave_2 # 多主多从 spring: datasource: dynamic: datasource: master_1: master_2: slave_1: slave_2: slave_3: # 纯粹多库（记得设置primary） spring: datasource: dynamic: datasource: mysql: oracle: sqlserver: postgresql: h2: # 混合配置 spring: datasource: dynamic: datasource: master: slave_1: slave_2: oracle_1: oracle_2: 使用 @DS 切换数据源 @DS 可以注解在方法上或类上，同时存在 就近原则，方法上注解 优先于 类上注解。\n注解 结果 没有@DS 默认数据源 @DS(“dsName”) dsName可以为组名也可以为具体某个库的名称，组名则切换时采用负载均衡算法切换 @Service @DS(\"slave\") public class UserServiceImpl implements UserService { @Autowired private JdbcTemplate jdbcTemplate; // 使用slave数据源 public List selectAll() { return jdbcTemplate.queryForList(\"select * from user\"); } // 使用slave_1数据源 @Override @DS(\"slave_1\") public List selectByCondition() { return jdbcTemplate.queryForList(\"select * from user where age \u003e10\"); } } DS放在哪里合适 DS作为切换数据源核心注解，我应该把他注解在哪里合适？\n这其实是初次接触多数据源的人常问的问题。\n这其实没有一定的要求，只是有一些经验之谈。\n首先开发者要了解的基础知识是，DS注解是基于AOP的原理实现的，aop的常见失效场景应清楚，比如内部调用失效，shiro代理失效。\n通常建议DS放在serviceImpl的方法上，如事务注解一样。\n注解在Controller的方法上或类上 并不是不可以，作者并不建议的原因主要是controller主要作用是参数的检验等一些基础逻辑的处理，这部分操作常常并不涉及数据库。\n注解在service的实现类的方法或类上 这是作者建议的方式，service主要是对业务的处理， 在复杂的场景涉及连续切换不同的数据库。\n如果你的方法有通用性，其他service也会调用你的方法。 这样别人就不用重复处理切换数据源。\n注解在Mapper上 通常如果你某个Mapper对应的表只在确定的一个库，也是可以的，但是建议只注解在Mapper的类上。\n我之前出现多线程失效场景的时候，就是在Mapper上加了注解解决的。\n其他使用方式 继承抽象类上的DS\n比如我有一个抽象Service，我想实现继承我这个抽象Service下的子Service的所有方法除非重新指定，都用我抽象Service上注解的数据源。是否支持？\n答：支持。\n继承接口上的DS\n3.4.1开始支持， 但是需要注意的是，一个类能实现多个接口，如果多个接口都有DS会如何？\n不知道，别这么干。一般不会有人这么干吧，想一想都知道会出问题。\n连接池集成 传统多数据源集成连接池如果需要配置的参数较多，则手动编码量大，编程复杂。\ndynamic-datasource实现了常见数据源的参数配置，支持全局配置每个数据源继承。\n通过本章您可以快速掌握不同连接池的集成配置方案和继承中可能遇见的问题。\n连接池必读 每个数据源都有一个type来指定连接池。\n每个数据源甚至可以使用不同的连接池，如无特殊需要并不建议。\ntype 不是必填字段。\n在没有设置type的时候系统会自动按以下顺序查找并使用连接池：\nDruid \u003e HikariCp \u003e BeeCp \u003e DBCP2 \u003e Spring Basic。\nspring: datasource: dynamic: primary: db1 datasource: db1: url: jdbc:mysql://xx.xx.xx.xx:3306/dynamic username: root password: 123456 driver-class-name: com.mysql.cj.jdbc.Driver type: com.zaxxer.hikari.HikariDataSource # 使用Hikaricp db2: url: jdbc:mysql://xx.xx.xx.xx:3307/dynamic username: root password: 123456 driver-class-name: com.mysql.cj.jdbc.Driver type: com.alibaba.druid.pool.DruidDataSource # 使用Druid db3: url: jdbc:mysql://xx.xx.xx.xx:3308/dynamic username: root password: 123456 driver-class-name: com.mysql.cj.jdbc.Driver type: cn.beecp.BeeDataSource # 使用beecp 集成Druid 基础介绍 Druid Github：点我跳转\nDruid 文档：点我跳转\ndynamic-datasource能简单高效完成对Druid的集成并完成其参数的多元化配置。\n各个库可以使用不同的数据库连接池，如 master使用Druid，slave使用HikariCP。\n如果项目同时存在Druid和HikariCP并且未配置连接池type类型，默认Druid优先于HikariCP。\n集成步骤 1、项目引入 druid-spring-boot-starter 依赖\ncom.alibaba druid-spring-boot-starter ${version} 2、排除原生Druid的快速配置类\n注意：v3.3.3及以上 版本不用排除了。\n@SpringBootApplication(exclude = DruidDataSourceAutoConfigure.class) public class Application { public static void main(String[] args) { SpringApplication.run(Application.class, args); } } 某些SpringBoot的版本上面可能无法排除可用以下方式排除。\nspring: autoconfigure: exclude: com.alibaba.druid.spring.boot.autoconfigure.DruidDataSourceAutoConfigure 3、参数配置\n如果参数都未配置，则保持原组件默认值。 如果配置了全局参数，则每一个数据源都会继承对应参数。 每一个数据源可以单独设置参数覆盖全局参数。 spring: datasource: druid: stat-view-servlet: enabled: true loginUsername: admin loginPassword: 123456 dynamic: druid: # 以下是支持的全局默认值 initial-size: max-active: min-idle: max-wait: time-between-eviction-runs-millis: time-between-log-stats-millis: stat-sqlmax-size: min-evictable-idle-time-millis: max-evictable-idle-time-millis: test-while-idle: test-on-borrow: test-on-return: validation-query: validation-query-timeout: use-global-datasource-stat: async-init: clear-filters-enable: reset-stat-enable: not-full-timeout-retry-count: max-wait-thread-count: fail-fast: phyTimeout-millis: keep-alive: pool-prepared-statements: init-variants: init-global-variants: use-unfair-lock: kill-when-socket-read-timeout: connection-properties: max-pool-prepared-statement-per-connection-size: init-connection-sqls: share-prepared-statements: connection-errorretry-attempts: break-after-acquire-failure: filters: stat # 注意这个值和druid原生不一致，默认启动了stat wall: noneBaseStatementAllow: callAllow: selectAllow: selectIntoAllow: selectIntoOutfileAllow: selectWhereAlwayTrueCheck: selectHavingAlwayTrueCheck: selectUnionCheck: selectMinusCheck: selectExceptCheck: selectIntersectCheck: createTableAllow: dropTableAllow: alterTableAllow: renameTableAllow: hintAllow: lockTableAllow: startTransactionAllow: blockAllow: conditionAndAlwayTrueAllow: conditionAndAlwayFalseAllow: conditionDoubleConstAllow: conditionLikeTrueAllow: selectAllColumnAllow: deleteAllow: deleteWhereAlwayTrueCheck: deleteWhereNoneCheck: updateAllow: updateWhereAlayTrueCheck: updateWhereNoneCheck: insertAllow: mergeAllow: minusAllow: intersectAllow: replaceAllow: setAllow: commitAllow: rollbackAllow: useAllow: multiStatementAllow: truncateAllow: commentAllow: strictSyntaxCheck: constArithmeticAllow: limitZeroAllow: describeAllow: showAllow: schemaCheck: tableCheck: functionCheck: objectCheck: variantCheck: mustParameterized: doPrivilegedAllow: dir: tenantTablePattern: tenantColumn: wrapAllow: metadataAllow: conditionOpXorAllow: conditionOpBitwseAllow: caseConditionConstAllow: completeInsertValuesCheck: insertValuesCheckSize: selectLimit: stat: merge-sql: log-slow-sql: slow-sql-millis: datasource: master: username: root password: 123456 driver-class-name: com.mysql.cj.jdbc.Driver url: jdbc:mysql://xx.xx.xx.xx:3306/dynamic?characterEncoding=utf8\u0026useSSL=false druid: # 以下是独立参数，每个库可以重新设置 initial-size: 20 validation-query: select 1 FROM DUAL # 比如oracle就需要重新设置这个 public-key: #（非全局参数）设置即表示启用加密,底层会自动帮你配置相关的连接参数和filter，推荐使用本项目自带的加密方法。 以下是我曾经配置过的示例：\n# 数据源配置 spring: # 排除掉druid原生的自动配置 autoconfigure: exclude: com.alibaba.druid.spring.boot.autoconfigure.DruidDataSourceAutoConfigure datasource: druid: # 初始连接数 initialSize: 5 # 最小连接池数量 minIdle: 10 # 最大连接池数量 maxActive: 20 # 配置获取连接等待超时的时间 maxWait: 60000 # 配置连接超时时间 connectTimeout: 30000 # 配置网络超时时间 socketTimeout: 60000 # 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒 timeBetweenEvictionRunsMillis: 60000 # 配置一个连接在池中最小生存的时间，单位是毫秒 minEvictableIdleTimeMillis: 300000 # 配置一个连接在池中最大生存的时间，单位是毫秒 maxEvictableIdleTimeMillis: 900000 # 配置检测连接是否有效 validationQuery: SELECT 1 FROM DUAL testWhileIdle: true testOnBorrow: false testOnReturn: false webStatFilter: enabled: true statViewServlet: enabled: true # 设置白名单，不填则允许所有访问 allow: url-pattern: /druid/* # 控制台管理用户名和密码 login-username: admin login-password: 123456 filter: stat: enabled: true # 慢SQL记录 log-slow-sql: true slow-sql-millis: 2000 merge-sql: true wall: config: multi-statement-allow: true dynamic: druid: # 初始连接数 initial-size: 5 # 最小连接池数量 min-idle: 10 # 最大连接池数量 max-active: 20 # 配置获取连接等待超时的时间 max-wait: 60000 # 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒 time-between-eviction-runs-millis: 60000 # 配置一个连接在池中最小生存的时间，单位是毫秒 min-evictable-idle-time-millis: 300000 # 配置一个连接在池中最大生存的时间，单位是毫秒 max-evictable-idle-time-millis: 900000 # 配置检测连接是否有效 validation-query: SELECT 1 FROM DUAL test-while-idle: true test-on-borrow: false test-on-return: false # 打开PSCache，并指定每个连接上PSCache的大小。 # oracle设为true，mysql设为false。分库分表较多推荐设置为false pool-prepared-statements: false max-pool-prepared-statement-per-connection-size: 20 filters: stat # 注意这个值和druid原生不一致，默认启动了stat stat: merge-sql: true log-slow-sql: true slow-sql-millis: 2000 primary: master # 设置默认的数据源或者数据源组 strict: false # 设置严格模式,默认false不启动,启动后在未匹配到指定数据源时候回抛出异常,不启动会使用默认数据源 datasource: master: url: jdbc:mysql://192.168.56.101:3306/master?useUnicode=true\u0026characterEncoding=utf8\u0026zeroDateTimeBehavior=convertToNull\u0026useSSL=true\u0026serverTimezone=GMT%2B8 username: root password: root driver-class-name: com.mysql.cj.jdbc.Driver slave_1: url: jdbc:mysql://192.168.56.102:3306/slave_1?useUnicode=true\u0026characterEncoding=utf8\u0026zeroDateTimeBehavior=convertToNull\u0026useSSL=true\u0026serverTimezone=GMT%2B8\u0026rewriteBatchedStatements=true username: root password: root driver-class-name: com.mysql.cj.jdbc.Driver slave_2: url: jdbc:mysql://192.168.56.103:3306/slave_2?useUnicode=true\u0026characterEncoding=utf8\u0026zeroDateTimeBehavior=convertToNull\u0026useSSL=true\u0026serverTimezone=GMT%2B8\u0026rewriteBatchedStatements=true username: root password: root driver-class-name: com.mysql.cj.jdbc.Driver druid: # 以下参数针对每个库可以重新设置druid参数 initial-size: validation-query: select 1 FROM DUAL # 比如oracle就需要重新设置这个 public-key: #（非全局参数）设置即表示启用加密,底层会自动帮你配置相关的连接参数和filter。 如上即可配置访问用户和密码，访问 http://ip:端口/druid/index.html 查看druid监控。\n示例项目 点我跳转\n核心源码 Druid数据源创建器：点我跳转\nDruid参数源码：点我跳转\n集成HikariCP 基础介绍 HikariCP Github：点我跳转\nHikariCP 文档：点我跳转\n集成步骤 1、项目引入 HikariCP 依赖\nSpringBoot2.x.x默认引入了HikariCP，除非对版本有要求无需再次引入。\nSpringBoot 1.5.x需手动引入，对应的版本请根据自己环境和HikariCP官方文档自行选择。\ncom.zaxxer HikariCP ${version} 2、参数配置\n如果参数都未配置，则保持原组件默认值。 如果配置了全局参数，则每一个数据源都会继承对应参数。 每一个数据源可以单独设置参数覆盖全局参数。 特别注意，hikaricp原生设置某些字段名和dynamic-datasource不一致，dynamic-datasource是根据参数反射设置，而原生hikaricp字段名称和set名称不一致。\nspring: datasource: dynamic: hikari: # 全局hikariCP参数，所有值和默认保持一致。(现已支持的参数如下,不清楚含义不要乱设置) catalog: connection-timeout: validation-timeout: idle-timeout: leak-detection-threshold: max-lifetime: max-pool-size: min-idle: initialization-fail-timeout: connection-init-sql: connection-test-query: dataSource-class-name: dataSource-jndi-name: schema: transaction-isolation-name: is-auto-commit: is-read-only: is-isolate-internal-queries: is-register-mbeans: is-allow-pool-suspension: data-source-properties: health-check-properties: datasource: master: username: root password: 123456 driver-class-name: com.mysql.cj.jdbc.Driver url: jdbc:mysql://xx.xx.xx.xx:3306/dynamic?characterEncoding=utf8\u0026useSSL=false hikari: # 以下参数针对每个库可以重新设置hikari参数 max-pool-size: idle-timeout: # ...... 常见问题 Failed to validate connection com.mysql.jdbc.JDBC4Connection@xxxxx (No operations allowed after connection closed.)\nhttps://github.com/brettwooldridge/HikariCP/issues/1034\n核心意思就是HikariCP要设置 connection-test-query 并且max-lifetime要小于mysql的默认时间。\n核心源码 HikariCP数据源创建器：点我跳转\nHikariCP参数配置类：点我跳转\n第三方集成 通过本章您可以掌握数据源在集成MybatisPlus，Quartz，ShardingJdbc的方案。\n集成MybatisPlus 基础介绍 MybatisPlus Github：点我跳转\nMybatisPlus 文档： 点我跳转\n只要引入了MybatisPlus相关jar包，项目自动集成，兼容MybatisPlus2.x和3.x的版本。\n集成步骤 1、项目引入 Mybatis-Plus 依赖\ncom.baomidou mybatis-plus-boot-starter ${version} 2、使用DS注解进行切换数据源\n@Service @DS(\"mysql\") public class UserServiceImpl extends ServiceImpl\u003cUserMapper, User\u003e implements UserService { @DS(\"oracle\") publid void addUser(User user){ //do something baseMapper.insert(user); } } 3、分页配置\n@Bean public MybatisPlusInterceptor mybatisPlusInterceptor() { MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor(); //如果是不同类型的库，请不要指定DbType，其会自动判断。 interceptor.addInnerInterceptor(new PaginationInnerInterceptor()); // interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL)); return interceptor; } 注意事项 MybatisPlus内置的ServiceImpl在新增，更改，删除等一些方法上自带事物导致不能切换数据源。\n解决方法：\n方法1：复制ServiceImpl出来为自己的MyServiceImpl，并去掉所有事务注解。\n方法2：创建一个新方法，并在此方法上加DS注解. 如上面的addUser方法。\nFAQ 为什么要单独拿出来说和MybatisPlus的集成？\n因为MybatisPlus重写了一些核心类，必须通过解析获得真实的代理对象。\n如果自己写多数据源，则很难完成与mp的集成。\n核心解析源码：点我跳转\n示例项目 点我跳转\n其他集成 集成P6spy、集成Quartz、集成ShardingJdbc\n由于以上场景暂时没用到，文章中暂时不体现了，如有用到，后面会补充上。\n进阶使用 动态添加移除数据源：指在系统运行过程中动态的添加数据源，删除数据源，多使用于基于数据库的多租户系统。\n动态解析数据源：指数据源切换是不固定的，可以根据域名，根据header参数，根据session参数，根据方法变量等来动态切换。多使用于多租户系统，支持扩展。\n数据库加密：指数据库的url，username，password需要加密，长用于安全性较高系统，不让普通开发通过配置知道生产库的连接配置。\n启动初始化脚本：指数据源启动的时候可以执行schema和data的脚本来初始化结构和数据，dynamic-datasource组件支持每个数据源加载不同的schema和data。\n自动读写分离：适用于mybatis环境，基于mybatis插件实现无注解自动读写分离。\n懒启动数据源：指配置的数据源不立即启动，等需要建立连接的时候再真正初始化连接池。\n无数据源启动：指启动的时候不配置任何数据源，全靠后期系统动态添加。\n手动切换数据源：指某些情况无法根据注解切换，通过工具类手动切换数据源。\n动态添加移除数据源 基础介绍 主要在多租户场景中，常常新的一个租户进来需要动态的添加一个数据源到库中，使得系统不用重启即可切换数据源。\n使用步骤 import com.baomidou.dynamic.datasource.DynamicRoutingDataSource; import com.baomidou.dynamic.datasource.creator.*; import com.baomidou.dynamic.datasource.spring.boot.autoconfigure.DataSourceProperty; import com.baomidou.samples.ds.dto.DataSourceDTO; import io.swagger.annotations.Api; import io.swagger.annotations.ApiOperation; import org.springframework.beans.BeanUtils; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.validation.annotation.Validated; import org.springframework.web.bind.annotation.*; import javax.sql.DataSource; import java.util.Set; @RestController @RequestMapping(\"/datasources\") @Api(tags = \"添加删除数据源\") public class DataSourceController { @Autowired private DataSource dataSource; // private final DataSourceCreator dataSourceCreator; // 3.3.1及以下版本使用这个通用，强烈推荐sb2用户至少升级到3.5.2版本 @Autowired private DefaultDataSourceCreator dataSourceCreator; @Autowired private BasicDataSourceCreator basicDataSourceCreator; @Autowired private JndiDataSourceCreator jndiDataSourceCreator; @Autowired private DruidDataSourceCreator druidDataSourceCreator; @Autowired private HikariDataSourceCreator hikariDataSourceCreator; @Autowired private BeeCpDataSourceCreator beeCpDataSourceCreator; @Autowired private Dbcp2DataSourceCreator dbcp2DataSourceCreator; @GetMapping @ApiOperation(\"获取当前所有数据源\") public Set\u003cString\u003e now() { DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource; return ds.getDataSources().keySet(); } // 通用数据源会根据maven中配置的连接池根据顺序依次选择。 // 默认的顺序为druid\u003ehikaricp\u003ebeecp\u003edbcp\u003espring basic @PostMapping(\"/add\") @ApiOperation(\"通用添加数据源（推荐）\") public Set\u003cString\u003e add(@Validated @RequestBody DataSourceDTO dto) { DataSourceProperty dataSourceProperty = new DataSourceProperty(); BeanUtils.copyProperties(dto, dataSourceProperty); DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource; DataSource dataSource = dataSourceCreator.createDataSource(dataSourceProperty); ds.addDataSource(dto.getPoolName(), dataSource); return ds.getDataSources().keySet(); } @PostMapping(\"/addBasic(强烈不推荐，除了用了马上移除)\") @ApiOperation(value = \"添加基础数据源\", notes = \"调用Springboot内置方法创建数据源，兼容1,2\") public Set\u003cString\u003e addBasic(@Validated @RequestBody DataSourceDTO dto) { DataSourceProperty dataSourceProperty = new DataSourceProperty(); BeanUtils.copyProperties(dto, dataSourceProperty); DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource; DataSource dataSource = basicDataSourceCreator.createDataSource(dataSourceProperty); ds.addDataSource(dto.getPoolName(), dataSource); return ds.getDataSources().keySet(); } @PostMapping(\"/addJndi\") @ApiOperation(\"添加JNDI数据源\") public Set\u003cString\u003e addJndi(String pollName, String jndiName) { DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource; DataSource dataSource = jndiDataSourceCreator.createDataSource(jndiName); ds.addDataSource(poolName, dataSource); return ds.getDataSources().keySet(); } @PostMapping(\"/addDruid\") @ApiOperation(\"基础Druid数据源\") public Set\u003cString\u003e addDruid(@Validated @RequestBody DataSourceDTO dto) { DataSourceProperty dataSourceProperty = new DataSourceProperty(); BeanUtils.copyProperties(dto, dataSourceProperty); dataSourceProperty.setLazy(true); DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource; DataSource dataSource = druidDataSourceCreator.createDataSource(dataSourceProperty); ds.addDataSource(dto.getPoolName(), dataSource); return ds.getDataSources().keySet(); } @PostMapping(\"/addHikariCP\") @ApiOperation(\"基础HikariCP数据源\") public Set\u003cString\u003e addHikariCP(@Validated @RequestBody DataSourceDTO dto) { DataSourceProperty dataSourceProperty = new DataSourceProperty(); BeanUtils.copyProperties(dto, dataSourceProperty); dataSourceProperty.setLazy(true); // 3.4.0版本以下如果有此属性，需手动设置，不然会空指针。 DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource; DataSource dataSource = hikariDataSourceCreator.createDataSource(dataSourceProperty); ds.addDataSource(dto.getPoolName(), dataSource); return ds.getDataSources().keySet(); } @PostMapping(\"/addBeeCp\") @ApiOperation(\"基础BeeCp数据源\") public Set\u003cString\u003e addBeeCp(@Validated @RequestBody DataSourceDTO dto) { DataSourceProperty dataSourceProperty = new DataSourceProperty(); BeanUtils.copyProperties(dto, dataSourceProperty); dataSourceProperty.setLazy(true); // 3.4.0版本以下如果有此属性，需手动设置，不然会空指针。 DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource; DataSource dataSource = beeCpDataSourceCreator.createDataSource(dataSourceProperty); ds.addDataSource(dto.getPoolName(), dataSource); return ds.getDataSources().keySet(); } @PostMapping(\"/addDbcp\") @ApiOperation(\"基础Dbcp数据源\") public Set\u003cString\u003e addDbcp(@Validated @RequestBody DataSourceDTO dto) { DataSourceProperty dataSourceProperty = new DataSourceProperty(); BeanUtils.copyProperties(dto, dataSourceProperty); dataSourceProperty.setLazy(true); // 3.4.0版本以下如果有此属性，需手动设置，不然会空指针。 DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource; DataSource dataSource = dbcp2DataSourceCreator.createDataSource(dataSourceProperty); ds.addDataSource(dto.getPoolName(), dataSource); return ds.getDataSources().keySet(); } @DeleteMapping @ApiOperation(\"删除数据源\") public String remove(String name) { DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource; ds.removeDataSource(name); return \"删除成功\"; } } 示例项目 点我跳转\n源码分析 public interface DataSourceCreator { /** * 通过属性创建数据源 * * @param dataSourceProperty 数据源属性 * @return 被创建的数据源 */ DataSource createDataSource(DataSourceProperty dataSourceProperty); /** * 当前创建器是否支持根据此属性创建 * * @param dataSourceProperty 数据源属性 * @return 是否支持 */ boolean support(DataSourceProperty dataSourceProperty); } DataSourceCreator是一个接口，定义了根据参数创建数据源的接口。\n其他creator实现此接口，dynamic-datasource项目暂时实现了Druid和Hikaricp的等连接池的实现。\nBasicDataSourceCreator 是调用Spring原生的创建方式，只支持最最原始的基础配置。\nDefaultDataSourceCreator 是一个通用的创建器，其根据环境自动选择连接池。\n动态解析数据源 基础介绍 默认有三个职责链来处理动态参数解析器 header -\u003e session -\u003e spel\n所有以 # 开头的参数都会从参数中获取数据源\n@DS(\"#session.tenantName\") // 从session获取 public List selectSpelBySession() { return userMapper.selectUsers(); } @DS(\"#header.tenantName\") // 从header获取 public List selectSpelByHeader() { return userMapper.selectUsers(); } @DS(\"#tenantName\") // 使用spel从参数获取 public List selectSpelByKey(String tenantName) { return userMapper.selectUsers(); } @DS(\"#user.tenantName\") // 使用spel从复杂参数获取 public List selecSpelByTenant(User user) { return userMapper.selectUsers(); } 如何扩展 我想从cookie中获取参数解析? 我想从其他环境属性中来计算? 参考header解析器，继承DsProcessor，如果matches返回true则匹配成功，调用doDetermineDatasource返回匹配到的数据源，否则跳到下一个解析器。\n1、自定义一个处理器\npublic class DsHeaderProcessor extends DsProcessor { private static final String HEADER_PREFIX = \"#header\"; @Override public boolean matches(String key) { return key.startsWith(HEADER_PREFIX); } @Override public String doDetermineDatasource(MethodInvocation invocation, String key) { HttpServletRequest request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest(); return request.getHeader(key.substring(8)); } } 2、重写完后重新注入一个根据自己解析顺序的解析处理器\n@Configuration public class MyDynamicDataSourceConfig{ @Bean public DsProcessor dsProcessor() { DsHeaderProcessor headerProcessor = new DsHeaderProcessor(); DsSessionProcessor sessionProcessor = new DsSessionProcessor(); DsSpelExpressionProcessor spelExpressionProcessor = new DsSpelExpressionProcessor(); headerProcessor.setNextProcessor(sessionProcessor); sessionProcessor.setNextProcessor(spelExpressionProcessor); return headerProcessor; } } 注意 如果在Mapper接口下面的方法使用：\npublic interface UserMapper{ // 前缀可以是p0,a0 @DS(\"#p0.tenantName\") public List selecSpelByTenant(User user); } 对于在接口下面的使用, 由于编译器的默认配置没有将接口参数的元数据写入字节码文件中 所以spring el会无法识别参数名称, 只能用默认的参数命名方式\n第一个参数: p0，a0,(加入-parameters后，可以使用参数具体的名字，例如这里的#user) 第二个参数: p1，a1 第三个参数: P2,，a2 可以通过修改maven配置和java编译配置将接口参数信息写入字节码文件\norg.apache.maven.plugins maven-compiler-plugin 3.6.2 ${java.version} ${java.version} true idea java编译配置: -parameters\njava 支持-parameters的最低版本为 1.8\n数据库加密 基础介绍 在一些项目中，有对数据库关键字段加密的需求，大家熟悉的是Druid的加密方式。\n在连接池集成中的Druid章节里有对应的加密方式，但是如果我不用Druid也想用加密呢？\n所以作者copy了Druid的加密相关源码，嘿嘿。\ndynamic-datasource项目也支持支持url , username, password 的加密。\n使用的RAS加密，相关原理文章 https://www.cnblogs.com/pcheng/p/9629621.html。\n简单来说就是生成两把钥匙，私钥加密，公钥解密。\n公钥可以发布出去，解密也是用的公钥。\n具体使用 1、获得加密字符串\nimport com.baomidou.dynamic.datasource.toolkit.CryptoUtils; public class Demo { public static void main(String[] args) throws Exception { String password = \"123456\"; // 使用默认的publicKey ，建议还是使用下面的自定义 String encodePassword = CryptoUtils.encrypt(password); System.out.println(encodePassword); } // 自定义publicKey public static void main(String[] args) throws Exception { String[] arr = CryptoUtils.genKeyPair(512); System.out.println(\"privateKey: \" + arr[0]); System.out.println(\"publicKey: \" + arr[1]); System.out.println(\"url: \" + CryptoUtils.encrypt(arr[0], \"jdbc:mysql://127.0.0.1:3306/order\")); System.out.println(\"username: \" + CryptoUtils.encrypt(arr[0], \"root\")); System.out.println(\"password: \" + CryptoUtils.encrypt(arr[0], \"123456\")); } } 2、配置加密yml\nENC(xxx) 中包裹的xxx即为使用上面加密方法后生成的字符串\nspring: datasource: dynamic: public-key: # 有默认值，强烈建议更换 datasource: master: url: ENC(xxx) username: ENC(xxx) password: ENC(xxx) driver-class-name: com.mysql.cj.jdbc.Driver public-key: # 每个数据源可以独立设置，没有就继承上面的。 自定义解密 一些公司要求使用自己的方式加密，解密。\n从3.5.0版本开始，扩展了一个event，用户自行实现注入即可。\npublic interface DataSourceInitEvent { /** * 连接池创建前执行（可用于参数解密） * * @param dataSourceProperty 数据源基础信息 */ void beforeCreate(DataSourceProperty dataSourceProperty); /** * 连接池创建后执行 * * @param dataSource 连接池 */ void afterCreate(DataSource dataSource); } 默认的实现是EncDataSourceInitEvent，即ENC方式的。\n为什么不是公钥加密，私钥解密 根据RSA的设计，大部分人会认为应该是公钥加密，私钥解密。 为什么Druid设计相反？\n建议更高的安全，可以把publicKey在启动时候传进去，或者配置中心配好，不让普通开发接触到就好。\n查询了Druid的ISSUE和一些文章：\n1、Druid作者wenshao自己的回答：点我跳转\n2、知乎一些文章片段\n启动初始化执行脚本 3.5.0 之前版本\nspring: datasource: dynamic: primary: order datasource: order: # 基础配置省略... schema: db/order/schema.sql # 配置则生效,自动初始化表结构 data: db/order/data.sql # 配置则生效,自动初始化数据 continue-on-error: true # 默认true,初始化失败是否继续 separator: \";\" # sql默认分号分隔符，一般无需更改 product: schema: classpath*:db/product/schema.sql data: classpath*:db/product/data.sql user: schema: classpath*:db/user/schema/**/*.sql data: classpath*:db/user/data/**/*.sql 3.5.0（含） 之后版本 (层级多了一层init，保持和新版springboot一致)\nspring: datasource: dynamic: primary: order datasource: order: # 基础配置省略... init: schema: db/order/schema.sql # 配置则生效,自动初始化表结构 data: db/order/data.sql # 配置则生效,自动初始化数据 continue-on-error: true # 默认true,初始化失败是否继续 separator: \";\" # sql默认分号分隔符，一般无需更改 懒启动数据源 懒启动：连接池创建出来后并不会立即初始化连接池，等需要使用connection的时候再初始化。\n暂时只支持Druid和HikariCp和BeeCp连接池。\n主要场景可能适合于数据源很多，又不需要启动立即初始化的情况，可以减少系统启动时间。\n缺点在于，如果参数配置有误，则启动的时候不知道，初始化的时候失败，可能一直抛异常。\n配置使用 spring: datasource: dynamic: primary: master # 设置默认的数据源或者数据源组,默认值即为master strict: false # 设置严格模式,默认false不启动. 启动后在未匹配到指定数据源时候会抛出异常,不启动则使用默认数据源. lazy: true # 默认false非懒启动，系统加载到数据源立即初始化连接池 datasource: master: url: jdbc:mysql://xx.xx.xx.xx:3306/dynamic username: root password: 123456 driver-class-name: com.mysql.cj.jdbc.Driver lazy: true #表示这个数据源懒启动 db1: url: jdbc:mysql://xx.xx.xx.xx:3307/dynamic username: root password: 123456 driver-class-name: com.mysql.cj.jdbc.Driver db2: url: jdbc:mysql://xx.xx.xx.xx:3307/dynamic username: root password: 123456 driver-class-name: com.mysql.cj.jdbc.Driver 无数据源启动 基础介绍 场景：部分系统可能启动的时候完全不需要数据源，全靠启动后动态添加。\n配置方式 即基本不需要配置，可能根据需要配置一些类似Druid和HikariCp全局参数。\n如需配置Druid和HikariCp全局参数可参考对应章节文档。\nspring: datasource: dynamic: primary: master # 设置默认的数据源或者数据源组,默认值即为master strict: false # 设置严格模式,默认false不启动. 启动后在未匹配到指定数据源时候会抛出异常,不启动则使用默认数据源. 因为没有匹配的主数据源，启动的时候你会见到类似如下日志。\ndynamic-datasource initial loaded 0 datasource,Please add your primary datasource or check your configuration 手动切换数据源 在某些情况您可能需要手动切换数据源。\nimport com.baomidou.dynamic.datasource.toolkit.DynamicDataSourceContextHolder; @Service public class UserServiceImpl implements UserService { @Autowired private JdbcTemplate jdbcTemplate; public List selectAll() { DynamicDataSourceContextHolder.push(\"slave\"); // 手动切换 return jdbcTemplate.queryForList(\"select * from user\"); } } 需要注意的是手动切换的数据源，最好自己在合适的位置调用DynamicDataSourceContextHolder.clear()清空当前线程的数据源信息，防止内存泄漏，因为一层使用的是ThreadLocal\n如果你不太清楚什么时候调用，那么可以参考下面写一个拦截器，注册进spring里即可。\n@Slf4j public class DynamicDatasourceClearInterceptor implements HandlerInterceptor { @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) { // 入口处清空看个人，有的新人在异步里切了数据源但是忘记清除了，下一个请求遇到这个线程就会带进来。 // DynamicDataSourceContextHolder.clear(); return true; } @Override public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) { } @Override public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) { DynamicDataSourceContextHolder.clear(); } } 手动注入多数据源 什么时候需要手动注入多数据源？\n绝大部分是因为您的系统需要和其他数据源共同存在使用。\n如Quartz和ShardingJdbc等都需要使用独立的数据源。\ndynamic-datasource 3.4.0及以上版本和老版本注入方式有一定差别，根据自己版本注入。\n注意一定要让多数据源使用 @Primary ，让其成为主数据源。\n// 3.4.0版本以下 @Primary @Bean public DataSource dataSource(DynamicDataSourceProvider dynamicDataSourceProvider) { DynamicRoutingDataSource dataSource = new DynamicRoutingDataSource(); dataSource.setPrimary(properties.getPrimary()); dataSource.setStrict(properties.getStrict()); dataSource.setStrategy(properties.getStrategy()); dataSource.setProvider(dynamicDataSourceProvider); dataSource.setP6spy(properties.getP6spy()); dataSource.setSeata(properties.getSeata()); return dataSource; } // 3.4.0版本及以上 @Primary @Bean public DataSource dataSource() { DynamicRoutingDataSource dataSource = new DynamicRoutingDataSource(); dataSource.setPrimary(properties.getPrimary()); dataSource.setStrict(properties.getStrict()); dataSource.setStrategy(properties.getStrategy()); dataSource.setP6spy(properties.getP6spy()); dataSource.setSeata(properties.getSeata()); return dataSource; } 主要变更是因为3.4.0支持了多个provider同时生效，采取了内部注入，具体源码改动。\n自定义 自定义注解：不满足于默认DS注解，希望自定义注解。\n自定义数据源来源：默认的数据源来源是基于yml或者properties配置来的，组件支持同时从多个地方来加载初始化数据源。常用于多租户系统，从一个租户信息库多加载不同租户的数据源。\n自定义负载均衡策略：常用的有轮询，随机。支持扩展。\n自定义切面：支持不使用注解，通过配置来切换数据源。如某个包下所有service方法以select*开头的都走slave库，以add*开头的都走master库。\n自定义注解 基础介绍 如果你只有几个确定的库，可以尝试自定义注解替换掉@DS。\n建议从3.2.1版本开始使用自定义注解，另外组件自带了@Master和@Slave注解。\n使用方法 下面我们自定义一个产品库的注解，方便我们后面程序的使用。\n1、需要自己定义一个注解并继承自DS\nimport com.baomidou.dynamic.datasource.annotation.DS; import java.lang.annotation.*; @Target({ElementType.TYPE, ElementType.METHOD}) @Retention(RetentionPolicy.RUNTIME) @Documented @DS(\"product\") public @interface Product { } 2、注解在需要切换数据源的方法上或类上\n@Service @Product public class ProductServiceImpl implements ProductService { @Product public List selectAll() { return jdbcTemplate.queryForList(\"select * from products\"); } } 自定义数据源来源 基础介绍 数据源来源的默认实现是YmlDynamicDataSourceProvider，其从yaml或properties中读取信息并解析出所有数据源信息。\npublic interface DynamicDataSourceProvider { /** * 加载所有数据源 * * @return 所有数据源，key为数据源名称 */ Map\u003cString, DataSource\u003e loadDataSources(); } 自定义示例 可以参考 AbstractJdbcDataSourceProvider （仅供参考）来实现从JDBC数据库中获取数据库连接信息。\n@Bean public DynamicDataSourceProvider jdbcDynamicDataSourceProvider() { return new AbstractJdbcDataSourceProvider(\"com.mysql.cj.jdbc.Driver\", \"jdbc:mysql://xx.xx.xx.xx:3306/dynamic\", \"root\", \"root\") { @Override protected Map\u003cString, DataSourceProperty\u003e executeStmt(Statement statement) throws SQLException { ResultSet rs = statement.executeQuery(\"select * from DB\"); while (rs.next()) { String name = rs.getString(\"name\"); String username = rs.getString(\"username\"); String password = rs.getString(\"password\"); String url = rs.getString(\"url\"); String driver = rs.getString(\"driver\"); DataSourceProperty property = new DataSourceProperty(); property.setUsername(username); property.setPassword(password); property.setUrl(url); property.setDriverClassName(driver); map.put(name, property); } return map; } }; } PS: 从3.4.0开始，可以注入多个DynamicDataSourceProvider的Bean以实现同时从多个不同来源加载数据源，注意同名会被覆盖。\n自定义负载均衡策略 基础介绍 如下slave组下有三个数据源，当用户使用slave切换数据源时会使用负载均衡算法。\n系统自带了两个负载均衡算法:\nLoadBalanceDynamicDataSourceStrategy 轮询,是默认的。 RandomDynamicDataSourceStrategy 随机的。 spring: datasource: dynamic: datasource: master: username: root password: root url: jdbc:mysql://xx.xx.xx.xx:3306/dynamic driver-class-name: com.mysql.cj.jdbc.Driver schema: db/schema.sql slave_1: username: root password: root url: jdbc:mysql://xx.xx.xx.xx:3307/dynamic driver-class-name: com.mysql.cj.jdbc.Driver slave_2: username: root password: root url: jdbc:mysql://xx.xx.xx.xx:3308/dynamic driver-class-name: com.mysql.cj.jdbc.Driver slave_3: username: root password: root url: jdbc:mysql://xx.xx.xx.xx:3309/dynamic driver-class-name: com.mysql.cj.jdbc.Driver strategy: com.baomidou.dynamic.datasource.strategy.LoadBalanceDynamicDataSourceStrategy 如何自定义 如果默认的两个都不能满足要求，可以参考源码自定义，暂时只能全局更改。\nimport java.util.List; import java.util.concurrent.ThreadLocalRandom; import javax.sql.DataSource; public class RandomDynamicDataSourceStrategy implements DynamicDataSourceStrategy { public RandomDynamicDataSourceStrategy() { } public DataSource determineDataSource(List\u003cDataSource\u003e dataSources) { return (DataSource)dataSources.get(ThreadLocalRandom.current().nextInt(dataSources.size())); } } 无注解方案 不管是出于注解侵入性还是代码整洁等理由，我们都有需求不想使用注解的需求。\n但是需要理解多数据源实现的核心。\npublic class DynamicRoutingDataSource { @Override public DataSource determineDataSource() { // 这里是核心，是从ThreadLocal中获取当前数据源。 String dsKey = DynamicDataSourceContextHolder.peek(); return getDataSource(dsKey); } 所以我们就可以根据需求，选择合适的时机调用DynamicDataSourceContextHolder.push(\"对应数据源\")。\n默认的@DS注解来切换数据源是根据spring AOP的特性，在方法开启前设置数据源KEY，方法执行完成后移除对应数据源KEY。\nfilter切换数据源 目标：拦截以filter/**开头的所有请求，如果后面的方法以a开头就切换到db1，以b开头就切换到db2，其余使用默认数据源。\n实现如下：\n@Slf4j @WebFilter(filterName = \"dsFilter\", urlPatterns = {\"/filter/*\"}) public class DynamicDatasourceFilter implements Filter { @Override public void init(FilterConfig filterConfig) throws ServletException { log.info(\"loading filter {}\", filterConfig.getFilterName()); } @Override public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException { HttpServletRequest request = (HttpServletRequest) servletRequest; HttpServletResponse response = (HttpServletResponse) servletResponse; String requestURI = request.getRequestURI(); log.info(\"经过多数据源filter,当前路径是{}\", requestURI); // String headerDs = request.getHeader(\"ds\"); // Object sessionDs = request.getSession().getAttribute(\"ds\"); String s = requestURI.replaceFirst(\"/filter/\", \"\"); String dsKey = \"master\"; if (s.startsWith(\"a\")) { dsKey = \"db1\"; } else if (s.startsWith(\"b\")) { dsKey = \"db2\"; } else { } // 执行 try { DynamicDataSourceContextHolder.push(dsKey); filterChain.doFilter(servletRequest, servletResponse); } finally { DynamicDataSourceContextHolder.poll(); } } @Override public void destroy() { } } @SpringBootApplication @ServletComponentScan // filter必须使用这个 @MapperScan(\"com.baomidou.samples.ds.mapper\") public class AllDataSourceApplication { public static void main(String[] args) { SpringApplication.run(AllDataSourceApplication.class, args); } } 扩展：从request中还能获取到很多东西，如header和session，同理可以根据自己业务需求根据header值和session里对应的用户来动态设置和切换数据源。\nintercepror切换数据源 目标：拦截以interceptor/**开头的所有请求，如果后面的方法以a开头就切换到db1，以b开头就切换到db2，其余使用默认数据源。\n实现如下：\nimport com.baomidou.dynamic.datasource.toolkit.DynamicDataSourceContextHolder; import lombok.extern.slf4j.Slf4j; import org.springframework.web.servlet.HandlerInterceptor; import org.springframework.web.servlet.ModelAndView; import javax.servlet.http.HttpServletRequest; import javax.servlet.http.HttpServletResponse; @Slf4j public class DynamicDatasourceInterceptor implements HandlerInterceptor { /** * 在请求处理之前进行调用（Controller方法调用之前） */ @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) { String requestURI = request.getRequestURI(); log.info(\"经过多数据源Interceptor,当前路径是{}\", requestURI); // String headerDs = request.getHeader(\"ds\"); // Object sessionDs = request.getSession().getAttribute(\"ds\"); String s = requestURI.replaceFirst(\"/interceptor/\", \"\"); String dsKey = \"master\"; if (s.startsWith(\"a\")) { dsKey = \"db1\"; } else if (s.startsWith(\"b\")) { dsKey = \"db2\"; } else { } DynamicDataSourceContextHolder.push(dsKey); return true; } /** * 请求处理之后进行调用，但是在视图被渲染之前（Controller方法调用之后） */ @Override public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) { } /** * 在整个请求结束之后被调用，也就是在DispatcherServlet渲染了对应的视图之后执行（主要是用于进行资源清理工作） */ @Override public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) { DynamicDataSourceContextHolder.clear(); } } import org.springframework.context.annotation.Configuration; import org.springframework.web.servlet.config.annotation.InterceptorRegistry; import org.springframework.web.servlet.config.annotation.WebMvcConfigurer; @Configuration public class MyWebAutoConfig implements WebMvcConfigurer { @Override public void addInterceptors(InterceptorRegistry registry) { registry.addInterceptor(new DynamicDatasourceInterceptor()).addPathPatterns(\"/interceptor/**\"); } } 自定义切面 从3.4.0开始支持自定义切面。\n使用这个方式，原注解方式并不会失效。 注意：不要在同一个切面同时使用注解又使用自定义切面。 @Configuration public class MyConfig { @Bean public DynamicDatasourceNamedInterceptor dsAdvice(DsProcessor dsProcessor) { DynamicDatasourceNamedInterceptor interceptor = new DynamicDatasourceNamedInterceptor(dsProcessor); Map\u003cString, String\u003e patternMap = new HashMap\u003c\u003e(); patternMap.put(\"select*\", \"slave\"); patternMap.put(\"add*\", \"master\"); patternMap.put(\"update*\", \"master\"); patternMap.put(\"delete*\", \"master\"); interceptor.addPatternMap(patternMap); return interceptor; } @Bean public Advisor dsAdviceAdvisor(DynamicDatasourceNamedInterceptor dsAdvice) { AspectJExpressionPointcut pointcut = new AspectJExpressionPointcut(); pointcut.setExpression(\"execution (* com.baomidou.samples.pattern..service.*.*(..))\"); return new DefaultPointcutAdvisor(pointcut, dsAdvice); } } 以上实现com.baomidou.samples.pattern包service下所有类的add/update/delete开头的方法使用master数据源，select使用slave数据源。\n更复杂的切点表达式语法需自行学习。\nmybatis下读写分离 场景：\n在纯的读写分离环境，写操作全部是master，读操作全部是slave。 不想通过注解配置完成以上功能。 答：在mybatis环境下可以基于mybatis插件结合dynamic-datasource完成以上功能。\n手动注入插件：\n@Bean public MasterSlaveAutoRoutingPlugin masterSlaveAutoRoutingPlugin(){ return new MasterSlaveAutoRoutingPlugin(); } 默认主库名称master，从库名称slave。\n暂不支持更多，源码简单可参考重写。\n@Intercepts({@Signature(type = Executor.class, method = \"query\", args = {MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class}), @Signature(type = Executor.class, method = \"update\", args = {MappedStatement.class, Object.class})}) @Slf4j public class MasterSlaveAutoRoutingPlugin implements Interceptor { private static final String MASTER = \"master\"; private static final String SLAVE = \"slave\"; @Override public Object intercept(Invocation invocation) throws Throwable { Object[] args = invocation.getArgs(); MappedStatement ms = (MappedStatement) args[0]; try { DynamicDataSourceContextHolder.push(SqlCommandType.SELECT == ms.getSqlCommandType() ? SLAVE : MASTER); return invocation.proceed(); } finally { DynamicDataSourceContextHolder.clear(); } } @Override public Object plugin(Object target) { return target instanceof Executor ? Plugin.wrap(target, this) : target; } @Override public void setProperties(Properties properties) { } } 事务专栏 使用多数据源的你一定会遇到事务问题：\n为什么使用了事务就切换不了数据源了啊？ 有没有什么解决方案啊？ 有没有使用案例和注意事项啊。 以上问题都能在本章节得到解答。\n方案一：dynamic-datasource集成了alibaba分布式事务组件seata。\n方案二：dynamic-datasource提供了无需外部组件的本地多数据源事务。\n各有各的优劣，总有一款适合你。\n事务概念 什么是事务？ 事务：是数据库操作的最小工作单元，是作为单个逻辑工作单元执行的一系列操作；这些操作作为一个整体一起向系统提交，要么都执行、要么都不执行；事务是一组不可再分割的操作集合（工作逻辑单元）。\n事务的四大特性：\n原子性 事务是数据库的逻辑工作单位，事务中包含的各操作要么都做，要么都不做 。\n一致性 事务执行的结果必须是使数据库从一个一致性状态变到另一个一致性状态。因此当数据库只包含成功事务提交的结果时，就说数据库处于一致性状态。如果数据库系统 运行中发生故障，有些事务尚未完成就被迫中断，这些未完成事务对数据库所做的修改有一部分已写入物理数据库，这时数据库就处于一种不正确的状态，或者说是 不一致的状态。\n隔离性 一个事务的执行不能其它事务干扰。即一个事务内部的操作及使用的数据对其它并发事务是隔离的，并发执行的各个事务之间不能互相干扰。\n持续性 也称永久性，指一个事务一旦提交，它对数据库中的数据的改变就应该是永久性的。接下来的其它操作或故障不应该对其执行结果有任何影响。\n原生JDBC处理事务 try { connection.setAutoCommit(false); // 这里用connection对数据库做了一系列操作，CRUD connection.commit(); // 没有异常就提交 } catch(Exception ex){ connection.rollback(); // 异常回滚 } finally { connection.setAutoCommit(true); } 以上是事务的核心，所有操作要一起成功，只要出错就回滚。\nSpring处理事务 spring开启事务很简单，在需要事务的方法和类上添加@Transactional注解。\n@Transactional public void test() { Aservice.dosometing(); Bservice.dosometing(); } 使用了@Transactional，spring会保证整个事务下都复用同一个connection。\n在默认配置下，只要事务中发生RuntimeException，就会回滚。\n基础知识 问：使用了事务如@Transational无法切换数据源？\n答： 是的，本组件是基于springAop的方案来进行多数据源的管理和切换的，要想保证多个库的整体事务则需要分布式事务。\n问：为什么使用了事务如@Transational就无法切换数据源？\n答：开启了事务后，spring事务管理器会保证在事务下整个线程后续拿到的都是同一个connection。\n问：事务下无法切换数据源我知道了，那我单库的事务的可以用吗？\n答：完全可以的。只要事务下不切换数据源就OK。\n问：我的业务必须要保证事务，还有什么解决办法？\n方案一：seata就是解决此问题，本组件已完成和seata的自动集成。\n方案二：本组件从3.3.0开始支持本地多数据源事务，无需第三方。\n本地事务 背景 多数据源事务方案一直是一个难题，通常的解决方案有以下二种。\n利用atomiks手动构建多数据源事务，适合数据源较少，配置的参数也不太多,性能要求不高的项目。难点就是手动配置量大，需要耗费一定时间。\n用seata类似的分布式事务解决方案，难点就是需要搭建维护如seata-server的统一管理中心。 每一种方案都有其适用场景。你可能遇到最多的问题就是：\n为什么我加了事务注解，切换数据源失败？\n我了解涉及了分布式事务了，但我不想用seata，我场景简单，有没有不依赖第三方的方案？\n基础介绍 自从3.3.0开始，由seata的核心贡献者 https://github.com/a364176773 贡献了基于connection代理的方案。\n建议从3.4.0版本开始使用，其修复了一个功能，老版本不加@DS只加@DSTransactional会报错。\n注意事项 本地事务实现很简单，就是循环提交，发生错误，循环回滚。\n我们默认的前提是数据库本身不会异常，比如宕机。\n如数据在回滚的过程突然宕机，本地事务就会有问题。如果你需要完整分布式方案请使用seata方案。\n不支持spring原生事务，不支持spring事务，不支持spring事务，可分别使用，千万不能混用。 再次强调不支持spring事务注解，可理解成独立写了一套事务方案。 只适合简单本地多数据源场景， 如果涉及异步和微服务等完整事务场景，请使用seata方案。 暂时不支持更多配置，如只读，如spring的传播特性。 后续会根据反馈考虑支持。 使用方法 在最外层的方法添加 @DSTransactional，底下调用的各个类该切数据源就正常使用DS切换数据源即可，就是这么简单。\n// 如AService调用BService和CService的方法，A,B,C分别对应不同数据源。 @Service public class AService { @DS(\"a\") // 如果a是默认数据源则不需要DS注解。 @DSTransactional public void dosomething(){ BService.dosomething(); CService.dosomething(); } } @Service public class BService { @DS(\"b\") public void dosomething(){ // dosomething } } @Service public class CService { @DS(\"c\") public void dosomething(){ // dosomething } } 只要@DSTransactional注解下任一环节发生异常，则全局多数据源事务回滚。\n如果BC上也有@DSTransactional会有影响吗？答：没有影响的。\n示例项目 点我跳转\n完整示例项目，数据库都已准备好，可以直接运行测试。\n示例项目A,B,C分别对应OrderService,ProductService，AccountService，分别是独立的数据库。\n用户下单分别调用产品库扣库存，账户库扣余额。\n如果库存不足，或用户余额不足都抛出RuntimeException，触发整体回滚。\n@Slf4j @Service @AllArgsConstructor public class OrderService { private final OrderMapper orderMapper; private final AccountService accountService; private final ProductService productService; // @DS(\"order\") 这里不需要，因为order是默认库，如果开启事务的不是默认库则必须加 @DSTransactional // 注意这里开启事务 public void placeOrder(PlaceOrderRequest request) { log.info(\"=============ORDER START=================\"); Long userId = request.getUserId(); Long productId = request.getProductId(); Integer amount = request.getAmount(); log.info(\"收到下单请求,用户:{}, 商品:{},数量:{}\", userId, productId, amount); log.info(\"当前 XID: {}\", TransactionContext.getXID()); Order order = Order.builder() .userId(userId) .productId(productId) .status(OrderStatus.INIT) .amount(amount) .build(); orderMapper.insert(order); log.info(\"订单一阶段生成，等待扣库存付款中\"); // 扣减库存并计算总价 Double totalPrice = productService.reduceStock(productId, amount); // 扣减余额 accountService.reduceBalance(userId, totalPrice); order.setStatus(OrderStatus.SUCCESS); order.setTotalPrice(totalPrice); orderMapper.updateById(order); log.info(\"订单已成功下单\"); log.info(\"=============ORDER END=================\"); } } @Slf4j @Service @RequiredArgsConstructor public class ProductService { private final ProductMapper productMapper; @DS(\"product\") public Double reduceStock(Long productId, Integer amount) { log.info(\"=============PRODUCT START=================\"); log.info(\"当前 XID: {}\", TransactionContext.getXID()); // 检查库存 Product product = productMapper.selectById(productId); Assert.notNull(product, \"商品不存在\"); Integer stock = product.getStock(); log.info(\"商品编号为 {} 的库存为{},订单商品数量为{}\", productId, stock, amount); if (stock \u003c amount) { log.warn(\"商品编号为{} 库存不足，当前库存:{}\", productId, stock); throw new RuntimeException(\"库存不足\"); } log.info(\"开始扣减商品编号为 {} 库存,单价商品价格为{}\", productId, product.getPrice()); // 扣减库存 int currentStock = stock - amount; product.setStock(currentStock); productMapper.updateById(product); double totalPrice = product.getPrice() * amount; log.info(\"扣减商品编号为 {} 库存成功,扣减后库存为{}, {} 件商品总价为 {} \", productId, currentStock, amount, totalPrice); log.info(\"=============PRODUCT END=================\"); return totalPrice; } } @Slf4j @Service @RequiredArgsConstructor public class AccountService { private final AccountMapper accountMapper; @DS(\"account\") public void reduceBalance(Long userId, Double price) { log.info(\"=============ACCOUNT START=================\"); log.info(\"当前 XID: {}\", TransactionContext.getXID()); Account account = accountMapper.selectById(userId); Assert.notNull(account, \"用户不存在\"); Double balance = account.getBalance(); log.info(\"下单用户{}余额为 {},商品总价为{}\", userId, balance, price); if (balance \u003c price) { log.warn(\"用户 {} 余额不足，当前余额:{}\", userId, balance); throw new RuntimeException(\"余额不足\"); } log.info(\"开始扣减用户 {} 余额\", userId); double currentBalance = account.getBalance() - price; account.setBalance(currentBalance); accountMapper.updateById(account); log.info(\"扣减用户 {} 余额成功,扣减后用户账户余额为{}\", userId, currentBalance); log.info(\"=============ACCOUNT END=================\"); } } 原理介绍 点我跳转\n核心原理就是代理connection，并根据不同数据库获取到一个connection放入ConnectionFactory。\n如果成功了整体提交，失败了整体回滚。\nseata事务 基础介绍 seata Github地址：点我跳转\nseata 文档：点我跳转\nseata 示例：点我跳转\nPS：一般需要分布式事务的场景大多数都是微服务化，个人并不建议在单体项目引入多数据源+分布式事务，有能力尽早拆开，可为过度方案。\n注意事项 dynamic-datasource-sring-boot-starter 组件内部开启seata后会自动使用DataSourceProxy来包装DataSource，所以需要以下方式来保持兼容。\n1、如果你引入的是seata-all,请不要使用@EnableAutoDataSourceProxy注解。\n2、如果你引入的是seata-spring-boot-starter 请关闭自动代理。\nseata: enable-auto-data-source-proxy: false 示例项目 点我跳转\n此工程为 多数据源+druid+seata+mybatisPlus的版本。\n模拟用户下单，扣商品库存，扣用户余额，初步可分为订单服务+商品服务+用户服务。\n环境准备 为了快速演示相关环境都采用docker部署，生产上线请参考seata官方文档使用。\n1、准备seata-server。\ndocker run --name seata-server -p 8091:8091 -d seataio/seata-server 2、准备mysql数据库，账户root密码123456。\ndocker run --name mysql -p 3306:3306 -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7 3、创建相关数据库。\n创建 seata-order seata-product seata-account 模拟连接不同的数据库。\nCREATE DATABASE IF NOT EXIST seata-order;\rCREATE DATABASE IF NOT EXIST seata-product;\rCREATE DATABASE IF NOT EXIST seata-account; 4、准备相关数据库脚本。\n每个数据库下脚本相关的表，seata需要undo_log来监测和回滚。\n相关的seata脚本可到seata官方获取，另外配合多数据源的自动执行脚本功能，应用启动后会自动执行。\n工程准备 1、引入相关依赖，seata+druid+MybatisPlus+dynamic-datasource+mysql+lombok。\nio.seata seata-spring-boot-starter 1.4.2 com.baomidou dynamic-datasource-spring-boot-starter 3.4.0 # 省略，查看示例项目 2、编写相关yaml配置。\nspring: application: name: dynamic datasource: dynamic: primary: order strict: true seata: true # 开启seata代理，开启后默认每个数据源都代理，如果某个不需要代理可单独关闭 seata-mode: AT # 支持XA及AT模式,默认AT datasource: order: username: root password: 123456 url: jdbc:mysql://192.168.56.101:3306/seata_order?useUnicode=true\u0026characterEncoding=utf8\u0026allowMultiQueries=true\u0026useSSL=false driver-class-name: com.mysql.cj.jdbc.Driver schema: classpath:db/schema-order.sql account: username: root password: 123456 url: jdbc:mysql://192.168.56.101:3306/seata_account?useUnicode=true\u0026characterEncoding=utf8\u0026allowMultiQueries=true\u0026useSSL=false driver-class-name: com.mysql.cj.jdbc.Driver schema: classpath:db/schema-account.sql product: username: root password: 123456 url: jdbc:mysql://192.168.56.101:3306/seata_product?useUnicode=true\u0026characterEncoding=utf8\u0026allowMultiQueries=true\u0026useSSL=false driver-class-name: com.mysql.cj.jdbc.Driver schema: classpath:db/schema-product.sql test: username: lijing password: \"\" url: jdbc:h2:mem:test driver-class-name: org.h2.Driver seata: false # 这个数据源不需要seata seata: enabled: true application-id: applicationName tx-service-group: my_test_tx_group enable-auto-data-source-proxy: false #一定要是false service: vgroup-mapping: my_test_tx_group: default # key与上面的tx-service-group的值对应 grouplist: default: 192.168.56.101:8091 # seata-server地址仅file注册中心需要 config: type: file registry: type: file 代码编写 参考工程下面的代码完成controller,service,maaper,entity,dto等。\n订单服务\n@Slf4j @Service public class OrderServiceImpl implements OrderService { @Resource private OrderDao orderDao; @Autowired private AccountService accountService; @Autowired private ProductService productService; @DS(\"order\")// 每一层都需要使用多数据源注解切换所选择的数据库 @Override @Transactional @GlobalTransactional // 重点 第一个开启事务的需要添加seata全局事务注解 public void placeOrder(PlaceOrderRequest request) { log.info(\"=============ORDER START=================\"); Long userId = request.getUserId(); Long productId = request.getProductId(); Integer amount = request.getAmount(); log.info(\"收到下单请求,用户:{}, 商品:{},数量:{}\", userId, productId, amount); log.info(\"当前 XID: {}\", RootContext.getXID()); Order order = Order.builder() .userId(userId) .productId(productId) .status(OrderStatus.INIT) .amount(amount) .build(); orderDao.insert(order); log.info(\"订单一阶段生成，等待扣库存付款中\"); // 扣减库存并计算总价 Double totalPrice = productService.reduceStock(productId, amount); // 扣减余额 accountService.reduceBalance(userId, totalPrice); order.setStatus(OrderStatus.SUCCESS); order.setTotalPrice(totalPrice); orderDao.updateById(order); log.info(\"订单已成功下单\"); log.info(\"=============ORDER END=================\"); } } 商品服务\n@Slf4j @Service public class ProductServiceImpl implements ProductService { @Resource private ProductDao productDao; /** * 事务传播特性设置为 REQUIRES_NEW 开启新的事务 重要！！！！一定要使用REQUIRES_NEW */ @DS(\"product\") @Transactional(propagation = Propagation.REQUIRES_NEW) @Override public Double reduceStock(Long productId, Integer amount) { log.info(\"=============PRODUCT START=================\"); log.info(\"当前 XID: {}\", RootContext.getXID()); // 检查库存 Product product = productDao.selectById(productId); Integer stock = product.getStock(); log.info(\"商品编号为 {} 的库存为{},订单商品数量为{}\", productId, stock, amount); if (stock \u003c amount) { log.warn(\"商品编号为{} 库存不足，当前库存:{}\", productId, stock); throw new RuntimeException(\"库存不足\"); } log.info(\"开始扣减商品编号为 {} 库存,单价商品价格为{}\", productId, product.getPrice()); // 扣减库存 int currentStock = stock - amount; product.setStock(currentStock); productDao.updateById(product); double totalPrice = product.getPrice() * amount; log.info(\"扣减商品编号为 {} 库存成功,扣减后库存为{}, {} 件商品总价为 {} \", productId, currentStock, amount, totalPrice); log.info(\"=============PRODUCT END=================\"); return totalPrice; } } 用户服务\n@Slf4j @Service public class AccountServiceImpl implements AccountService { @Resource private AccountDao accountDao; /** * 事务传播特性设置为 REQUIRES_NEW 开启新的事务 重要！！！！一定要使用REQUIRES_NEW */ @DS(\"account\") @Override @Transactional(propagation = Propagation.REQUIRES_NEW) public void reduceBalance(Long userId, Double price) { log.info(\"=============ACCOUNT START=================\"); log.info(\"当前 XID: {}\", RootContext.getXID()); Account account = accountDao.selectById(userId); Double balance = account.getBalance(); log.info(\"下单用户{}余额为 {},商品总价为{}\", userId, balance, price); if (balance \u003c price) { log.warn(\"用户 {} 余额不足，当前余额:{}\", userId, balance); throw new RuntimeException(\"余额不足\"); } log.info(\"开始扣减用户 {} 余额\", userId); double currentBalance = account.getBalance() - price; account.setBalance(currentBalance); accountDao.updateById(account); log.info(\"扣减用户 {} 余额成功,扣减后用户账户余额为{}\", userId, currentBalance); log.info(\"=============ACCOUNT END=================\"); } } 测试 自行编写接口测试，注意观察运行日志，至此分布式事务集成案例全流程完毕。\n事务常见问题 建议先阅读基础知识。\n核心知识： spring原生事务会保证在事务下整个线程后续拿到的都是同一个connection。\n核心知识： spring原生事务会保证在事务下整个线程后续拿到的都是同一个connection。\n核心知识： spring原生事务会保证在事务下整个线程后续拿到的都是同一个connection。\n原生Spring中@Transational能和@DS一起使用吗？ public class AService { @DS(\"a\") @Transational public void dosomething(){ // some code } } 可以的，其会先切换使用数据源a再开启事务，整个原生事务内部不管是注解切换还是手动调用代码切换都不能切换，会一直使用a数据源。\n所以确认整个事务下不再切换其他数据源，用原生 @Transational 是建议的，毕竟其更完善。\n本地事务和Spring原生事务不能混用是什么意思？ 场景一：先使用的Spring@Transational 内部方法调用了本地@DSTransactional。\npublic class AService { @DS(\"a\") @Transational public void dosomething(){ Bservice.dosomething(); // B是另外数据源，然后注解了@DS(\"b\")和@DSTransactional Cservice.dosomething(); // C是另外数据源，然后注解了@DS(\"c\")和@DSTransactional } } 基于核心知识： 事务下都是a数据源，内部无论做什么都改变不了使用a数据源。\n场景二： 先使用的本地@DSTransactional内部方法调用了Spring@Transational 。\npublic class AService { @DS(\"a\") @DSTransactional public void dosomething(){ Amapper.updateSomeThing(); Bservice.dosomething(); // B是另外数据源，然后注解了@DS(\"b\")和@Transational Cservice.dosomething(); // C是另外数据源，然后注解了@DS(\"c\")和@Transational } } B和C都是独立的事务。C发生错误B会回滚吗？不会B已经提交了。A会回滚吗？会。\n不建议混用，除非你确实非常理解事务，能随心所欲掌握你代码的执行流程。\n本地事务标准使用 public class AService { @DS(\"a\") @DSTransactional // 最外层开启即可 public void dosomething(){ Amapper.updateSomeThing(); Bservice.dosomething(); // B是另外数据源，然后注解了@DS(\"b\") Cservice.dosomething(); // C是另外数据源，然后注解了@DS(\"c\") } } 调试源码 1、开启动态数据源的debug日志。\nlogging: level: com.baomidou.dynamic: debug 检查日志输出是否正确。\n2、断点调试DynamicDataSourceAnnotationInterceptor。\npublic class DynamicDataSourceAnnotationInterceptor implements MethodInterceptor { private static final String DYNAMIC_PREFIX = \"#\"; private final DataSourceClassResolver dataSourceClassResolver; private final DsProcessor dsProcessor; public DynamicDataSourceAnnotationInterceptor(Boolean allowedPublicOnly, DsProcessor dsProcessor) { dataSourceClassResolver = new DataSourceClassResolver(allowedPublicOnly); this.dsProcessor = dsProcessor; } @Override public Object invoke(MethodInvocation invocation) throws Throwable { try { // 这里把获取到的数据源标识如master存入本地线程 String dsKey = determineDatasourceKey(invocation); ● DynamicDataSourceContextHolder.push(dsKey); return invocation.proceed(); } finally { DynamicDataSourceContextHolder.poll(); } } private String determineDatasourceKey(MethodInvocation invocation) { String key = dataSourceClassResolver.findDSKey(invocation.getMethod(), invocation.getThis()); return (!key.isEmpty() \u0026\u0026 key.startsWith(DYNAMIC_PREFIX)) ? dsProcessor.determineDatasource(invocation, key) : key; } } 3、断点调试DynamicRoutingDataSource。\npublic class DynamicRoutingDataSource extends AbstractRoutingDataSource { private Map\u003cString, DataSource\u003e dataSourceMap = new LinkedHashMap\u003c\u003e(); private Map\u003cString, DynamicGroupDataSource\u003e groupDataSources = new ConcurrentHashMap\u003c\u003e(); @Override public DataSource determineDataSource() { // 从本地线程获取key解析最终真实的数据源 ● String dsKey = DynamicDataSourceContextHolder.peek(); return getDataSource(dsKey); } private DataSource determinePrimaryDataSource() { log.debug(\"从默认数据源中返回数据\"); return groupDataSources.containsKey(primary) ? groupDataSources.get(primary).determineDataSource() : dataSourceMap.get(primary); } public DataSource getDataSource(String ds) { if (StringUtils.isEmpty(ds)) { return determinePrimaryDataSource(); } else if (!groupDataSources.isEmpty() \u0026\u0026 groupDataSources.containsKey(ds)) { log.debug(\"从 {} 组数据源中返回数据源\", ds); return groupDataSources.get(ds).determineDataSource(); } else if (dataSourceMap.containsKey(ds)) { log.debug(\"从 {} 单数据源中返回数据源\", ds); return dataSourceMap.get(ds); } return determinePrimaryDataSource(); } } 常见问题之-切换数据源失败 开启了spring的事务 原因： spring开启事务后会维护一个ConnectionHolder，保证在整个事务下，都是用同一个数据库连接。\n请检查整个调用链路涉及的类的方法和类本身还有继承的抽象类上是否有@Transactional注解。\n如强烈需要事务保证多个库同时执行成功或者失败，请查看事务专栏的解决办法。\n方法内部调用 查看以下示例\n外部调用 userservice.test1() 能在执行到 test2() 切换到second数据源吗？\npublic UserService { @DS(\"first\") public void test1() { // do something test2(); } @DS(\"second\") public void test2() { // do something } } 答案：！！！不能不能不能！！！数据源核心原理是基于aop代理实现切换，内部方法调用不会使用aop。\n解决方法:\n把test2()方法提到另外一个service，单独调用。\nPostConstruct初始化顺序 初始化包括: @PostConstruct 注解, InitializingBean接口, 自定义init-method\n@Component public class MyConfiguration { @Resource private UserMapper userMapper; @DS(\"slave\") @PostConstruct public void init(){ // 无法选择正确的数据源 userMapper.selectById(1); } } 解决方法：监听容器启动完成事件, 在容器完成后做初始化。\n@Component public class MyConfiguration { @DS(\"slave\") @EventListener public void onApplicationEvent(ContextRefreshedEvent event) { // 成功选择正确的数据源 userMapper.selectById(1); } } 相关spring源码 : org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#initializeBean\n在初始化完成后, bean 进入增强阶段, 所以这个阶段的任何AOP都是无效的。\nDruid版本过低 请升级druid1.1.22及以上版本，这个版本修复了在高并发下偶发的切换失效问题。\n@Async或者java8的ParallelStream并行流之类方法 这种情况都是新开了线程去异步处理，不受当前线程管控了。\n可以在新开的方法上加对应的DS注解解决。\n知识库 如何注入多数据源？ public class A{ @Autowired private DataSource dataSource; public void dosomething{ // 使用的时候需要强转 DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource; } } 如何获取当前线程数据源名称？ DynamicDataSourceContextHolder.peek() 如何获取当前线程数据源？ public void dosomething{ DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource; DataSource datasource=ds.determineDataSource(); } 本文参考至：https://www.xiaojingge.com/archives/ef008289-8ab8-485c-8019-2703267c7beb\n","wordCount":"18600","inLanguage":"zh-cn","datePublished":"2025-06-13T00:00:00Z","dateModified":"2025-06-13T00:00:00Z","author":{"@type":"Person","name":"Lesan"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://lesanouo.github.io/blog/posts/code/174974400001/"},"publisher":{"@type":"Organization","name":"Lesan's Blog","logo":{"@type":"ImageObject","url":"https://lesanouo.github.io/blog/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://lesanouo.github.io/blog/ accesskey=h title="Lesan's Blog (Alt + H)">Lesan's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://lesanouo.github.io/blog/archives title="📚 归档"><span>📚 归档</span></a></li><li><a href=https://lesanouo.github.io/blog/categories/ title="🗃️ 分类"><span>🗃️ 分类</span></a></li><li><a href=https://lesanouo.github.io/blog/tags/ title="🏷️ 标签"><span>🏷️ 标签</span></a></li><li><a href=https://lesanouo.github.io/blog/search/ title="🔎 搜索"><span>🔎 搜索</span></a></li><li><a href=https://lesanouo.github.io/blog/about/ title="👨‍💻 关于我"><span>👨‍💻 关于我</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://lesanouo.github.io/blog/>Home</a>&nbsp;»&nbsp;<a href=https://lesanouo.github.io/blog/posts/>📚 博客</a></div><h1 class="post-title entry-hint-parent">dynamic-datasource文档</h1><div class=post-meta><span title='2025-06-13 00:00:00 +0000 UTC'>2025-06-13</span>&nbsp;·&nbsp;38 min&nbsp;·&nbsp;Lesan</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e7%89%b9%e6%80%a7 aria-label=特性>特性</a></li><li><a href=#%e7%ba%a6%e5%ae%9a aria-label=约定>约定</a></li><li><a href=#%e4%bd%bf%e7%94%a8%e6%96%b9%e6%b3%95 aria-label=使用方法>使用方法</a></li><li><a href=#ds%e6%94%be%e5%9c%a8%e5%93%aa%e9%87%8c%e5%90%88%e9%80%82 aria-label=DS放在哪里合适>DS放在哪里合适</a></li><li><a href=#%e8%bf%9e%e6%8e%a5%e6%b1%a0%e9%9b%86%e6%88%90 aria-label=连接池集成>连接池集成</a><ul><li><a href=#%e8%bf%9e%e6%8e%a5%e6%b1%a0%e5%bf%85%e8%af%bb aria-label=连接池必读>连接池必读</a></li><li><a href=#%e9%9b%86%e6%88%90druid aria-label=集成Druid>集成Druid</a><ul><li><a href=#%e5%9f%ba%e7%a1%80%e4%bb%8b%e7%bb%8d aria-label=基础介绍>基础介绍</a></li><li><a href=#%e9%9b%86%e6%88%90%e6%ad%a5%e9%aa%a4 aria-label=集成步骤>集成步骤</a></li><li><a href=#%e7%a4%ba%e4%be%8b%e9%a1%b9%e7%9b%ae aria-label=示例项目>示例项目</a></li><li><a href=#%e6%a0%b8%e5%bf%83%e6%ba%90%e7%a0%81 aria-label=核心源码>核心源码</a></li></ul></li><li><a href=#%e9%9b%86%e6%88%90hikaricp aria-label=集成HikariCP>集成HikariCP</a><ul><li><a href=#%e5%9f%ba%e7%a1%80%e4%bb%8b%e7%bb%8d-1 aria-label=基础介绍>基础介绍</a></li><li><a href=#%e9%9b%86%e6%88%90%e6%ad%a5%e9%aa%a4-1 aria-label=集成步骤>集成步骤</a></li><li><a href=#%e5%b8%b8%e8%a7%81%e9%97%ae%e9%a2%98 aria-label=常见问题>常见问题</a></li><li><a href=#%e6%a0%b8%e5%bf%83%e6%ba%90%e7%a0%81-1 aria-label=核心源码>核心源码</a></li></ul></li></ul></li><li><a href=#%e7%ac%ac%e4%b8%89%e6%96%b9%e9%9b%86%e6%88%90 aria-label=第三方集成>第三方集成</a><ul><li><a href=#%e9%9b%86%e6%88%90mybatisplus aria-label=集成MybatisPlus>集成MybatisPlus</a><ul><li><a href=#%e5%9f%ba%e7%a1%80%e4%bb%8b%e7%bb%8d-2 aria-label=基础介绍>基础介绍</a></li><li><a href=#%e9%9b%86%e6%88%90%e6%ad%a5%e9%aa%a4-2 aria-label=集成步骤>集成步骤</a></li><li><a href=#%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9 aria-label=注意事项>注意事项</a></li><li><a href=#faq aria-label=FAQ>FAQ</a></li><li><a href=#%e7%a4%ba%e4%be%8b%e9%a1%b9%e7%9b%ae-1 aria-label=示例项目>示例项目</a></li></ul></li><li><a href=#%e5%85%b6%e4%bb%96%e9%9b%86%e6%88%90 aria-label=其他集成>其他集成</a></li></ul></li><li><a href=#%e8%bf%9b%e9%98%b6%e4%bd%bf%e7%94%a8 aria-label=进阶使用>进阶使用</a><ul><li><a href=#%e5%8a%a8%e6%80%81%e6%b7%bb%e5%8a%a0%e7%a7%bb%e9%99%a4%e6%95%b0%e6%8d%ae%e6%ba%90 aria-label=动态添加移除数据源>动态添加移除数据源</a><ul><li><a href=#%e5%9f%ba%e7%a1%80%e4%bb%8b%e7%bb%8d-3 aria-label=基础介绍>基础介绍</a></li><li><a href=#%e4%bd%bf%e7%94%a8%e6%ad%a5%e9%aa%a4 aria-label=使用步骤>使用步骤</a></li><li><a href=#%e7%a4%ba%e4%be%8b%e9%a1%b9%e7%9b%ae-2 aria-label=示例项目>示例项目</a></li><li><a href=#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90 aria-label=源码分析>源码分析</a></li></ul></li><li><a href=#%e5%8a%a8%e6%80%81%e8%a7%a3%e6%9e%90%e6%95%b0%e6%8d%ae%e6%ba%90 aria-label=动态解析数据源>动态解析数据源</a><ul><li><a href=#%e5%9f%ba%e7%a1%80%e4%bb%8b%e7%bb%8d-4 aria-label=基础介绍>基础介绍</a></li><li><a href=#%e5%a6%82%e4%bd%95%e6%89%a9%e5%b1%95 aria-label=如何扩展>如何扩展</a></li><li><a href=#%e6%b3%a8%e6%84%8f aria-label=注意>注意</a></li></ul></li><li><a href=#%e6%95%b0%e6%8d%ae%e5%ba%93%e5%8a%a0%e5%af%86 aria-label=数据库加密>数据库加密</a><ul><li><a href=#%e5%9f%ba%e7%a1%80%e4%bb%8b%e7%bb%8d-5 aria-label=基础介绍>基础介绍</a></li><li><a href=#%e5%85%b7%e4%bd%93%e4%bd%bf%e7%94%a8 aria-label=具体使用>具体使用</a></li><li><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e8%a7%a3%e5%af%86 aria-label=自定义解密>自定义解密</a></li><li><a href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e4%b8%8d%e6%98%af%e5%85%ac%e9%92%a5%e5%8a%a0%e5%af%86%e7%a7%81%e9%92%a5%e8%a7%a3%e5%af%86 aria-label=为什么不是公钥加密，私钥解密>为什么不是公钥加密，私钥解密</a></li></ul></li><li><a href=#%e5%90%af%e5%8a%a8%e5%88%9d%e5%a7%8b%e5%8c%96%e6%89%a7%e8%a1%8c%e8%84%9a%e6%9c%ac aria-label=启动初始化执行脚本>启动初始化执行脚本</a></li><li><a href=#%e6%87%92%e5%90%af%e5%8a%a8%e6%95%b0%e6%8d%ae%e6%ba%90 aria-label=懒启动数据源>懒启动数据源</a><ul><li><a href=#%e9%85%8d%e7%bd%ae%e4%bd%bf%e7%94%a8 aria-label=配置使用>配置使用</a></li></ul></li><li><a href=#%e6%97%a0%e6%95%b0%e6%8d%ae%e6%ba%90%e5%90%af%e5%8a%a8 aria-label=无数据源启动>无数据源启动</a><ul><li><a href=#%e5%9f%ba%e7%a1%80%e4%bb%8b%e7%bb%8d-6 aria-label=基础介绍>基础介绍</a></li><li><a href=#%e9%85%8d%e7%bd%ae%e6%96%b9%e5%bc%8f aria-label=配置方式>配置方式</a></li></ul></li><li><a href=#%e6%89%8b%e5%8a%a8%e5%88%87%e6%8d%a2%e6%95%b0%e6%8d%ae%e6%ba%90 aria-label=手动切换数据源>手动切换数据源</a></li><li><a href=#%e6%89%8b%e5%8a%a8%e6%b3%a8%e5%85%a5%e5%a4%9a%e6%95%b0%e6%8d%ae%e6%ba%90 aria-label=手动注入多数据源>手动注入多数据源</a></li></ul></li><li><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89 aria-label=自定义>自定义</a><ul><li><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e6%b3%a8%e8%a7%a3 aria-label=自定义注解>自定义注解</a><ul><li><a href=#%e5%9f%ba%e7%a1%80%e4%bb%8b%e7%bb%8d-7 aria-label=基础介绍>基础介绍</a></li><li><a href=#%e4%bd%bf%e7%94%a8%e6%96%b9%e6%b3%95-1 aria-label=使用方法>使用方法</a></li></ul></li><li><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e6%95%b0%e6%8d%ae%e6%ba%90%e6%9d%a5%e6%ba%90 aria-label=自定义数据源来源>自定义数据源来源</a><ul><li><a href=#%e5%9f%ba%e7%a1%80%e4%bb%8b%e7%bb%8d-8 aria-label=基础介绍>基础介绍</a></li><li><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e7%a4%ba%e4%be%8b aria-label=自定义示例>自定义示例</a></li></ul></li><li><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e7%ad%96%e7%95%a5 aria-label=自定义负载均衡策略>自定义负载均衡策略</a><ul><li><a href=#%e5%9f%ba%e7%a1%80%e4%bb%8b%e7%bb%8d-9 aria-label=基础介绍>基础介绍</a></li><li><a href=#%e5%a6%82%e4%bd%95%e8%87%aa%e5%ae%9a%e4%b9%89 aria-label=如何自定义>如何自定义</a></li></ul></li></ul></li><li><a href=#%e6%97%a0%e6%b3%a8%e8%a7%a3%e6%96%b9%e6%a1%88 aria-label=无注解方案>无注解方案</a><ul><li><a href=#filter%e5%88%87%e6%8d%a2%e6%95%b0%e6%8d%ae%e6%ba%90 aria-label=filter切换数据源>filter切换数据源</a></li><li><a href=#intercepror%e5%88%87%e6%8d%a2%e6%95%b0%e6%8d%ae%e6%ba%90 aria-label=intercepror切换数据源>intercepror切换数据源</a></li><li><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e5%88%87%e9%9d%a2 aria-label=自定义切面>自定义切面</a></li><li><a href=#mybatis%e4%b8%8b%e8%af%bb%e5%86%99%e5%88%86%e7%a6%bb aria-label=mybatis下读写分离>mybatis下读写分离</a></li></ul></li><li><a href=#%e4%ba%8b%e5%8a%a1%e4%b8%93%e6%a0%8f aria-label=事务专栏>事务专栏</a><ul><li><a href=#%e4%ba%8b%e5%8a%a1%e6%a6%82%e5%bf%b5 aria-label=事务概念>事务概念</a><ul><li><a href=#%e4%bb%80%e4%b9%88%e6%98%af%e4%ba%8b%e5%8a%a1 aria-label=什么是事务？>什么是事务？</a></li><li><a href=#%e5%8e%9f%e7%94%9fjdbc%e5%a4%84%e7%90%86%e4%ba%8b%e5%8a%a1 aria-label=原生JDBC处理事务>原生JDBC处理事务</a></li><li><a href=#spring%e5%a4%84%e7%90%86%e4%ba%8b%e5%8a%a1 aria-label=Spring处理事务>Spring处理事务</a></li></ul></li><li><a href=#%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86 aria-label=基础知识>基础知识</a></li><li><a href=#%e6%9c%ac%e5%9c%b0%e4%ba%8b%e5%8a%a1 aria-label=本地事务>本地事务</a><ul><li><a href=#%e8%83%8c%e6%99%af aria-label=背景>背景</a></li><li><a href=#%e5%9f%ba%e7%a1%80%e4%bb%8b%e7%bb%8d-10 aria-label=基础介绍>基础介绍</a></li><li><a href=#%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9-1 aria-label=注意事项>注意事项</a></li><li><a href=#%e4%bd%bf%e7%94%a8%e6%96%b9%e6%b3%95-2 aria-label=使用方法>使用方法</a></li><li><a href=#%e7%a4%ba%e4%be%8b%e9%a1%b9%e7%9b%ae-3 aria-label=示例项目>示例项目</a></li><li><a href=#%e5%8e%9f%e7%90%86%e4%bb%8b%e7%bb%8d aria-label=原理介绍>原理介绍</a></li></ul></li><li><a href=#seata%e4%ba%8b%e5%8a%a1 aria-label=seata事务>seata事务</a><ul><li><a href=#%e5%9f%ba%e7%a1%80%e4%bb%8b%e7%bb%8d-11 aria-label=基础介绍>基础介绍</a></li><li><a href=#%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9-2 aria-label=注意事项>注意事项</a></li><li><a href=#%e7%a4%ba%e4%be%8b%e9%a1%b9%e7%9b%ae-4 aria-label=示例项目>示例项目</a></li><li><a href=#%e7%8e%af%e5%a2%83%e5%87%86%e5%a4%87 aria-label=环境准备>环境准备</a></li><li><a href=#%e5%b7%a5%e7%a8%8b%e5%87%86%e5%a4%87 aria-label=工程准备>工程准备</a></li><li><a href=#%e4%bb%a3%e7%a0%81%e7%bc%96%e5%86%99 aria-label=代码编写>代码编写</a></li><li><a href=#%e6%b5%8b%e8%af%95 aria-label=测试>测试</a></li></ul></li><li><a href=#%e4%ba%8b%e5%8a%a1%e5%b8%b8%e8%a7%81%e9%97%ae%e9%a2%98 aria-label=事务常见问题>事务常见问题</a><ul><li><a href=#%e5%8e%9f%e7%94%9fspring%e4%b8%adtransational%e8%83%bd%e5%92%8cds%e4%b8%80%e8%b5%b7%e4%bd%bf%e7%94%a8%e5%90%97 aria-label=原生Spring中@Transational能和@DS一起使用吗？>原生Spring中@Transational能和@DS一起使用吗？</a></li><li><a href=#%e6%9c%ac%e5%9c%b0%e4%ba%8b%e5%8a%a1%e5%92%8cspring%e5%8e%9f%e7%94%9f%e4%ba%8b%e5%8a%a1%e4%b8%8d%e8%83%bd%e6%b7%b7%e7%94%a8%e6%98%af%e4%bb%80%e4%b9%88%e6%84%8f%e6%80%9d aria-label=本地事务和Spring原生事务不能混用是什么意思？>本地事务和Spring原生事务不能混用是什么意思？</a></li><li><a href=#%e6%9c%ac%e5%9c%b0%e4%ba%8b%e5%8a%a1%e6%a0%87%e5%87%86%e4%bd%bf%e7%94%a8 aria-label=本地事务标准使用>本地事务标准使用</a></li></ul></li></ul></li><li><a href=#%e8%b0%83%e8%af%95%e6%ba%90%e7%a0%81 aria-label=调试源码>调试源码</a></li><li><a href=#%e5%b8%b8%e8%a7%81%e9%97%ae%e9%a2%98%e4%b9%8b-%e5%88%87%e6%8d%a2%e6%95%b0%e6%8d%ae%e6%ba%90%e5%a4%b1%e8%b4%a5 aria-label=常见问题之-切换数据源失败>常见问题之-切换数据源失败</a><ul><li><a href=#%e5%bc%80%e5%90%af%e4%ba%86spring%e7%9a%84%e4%ba%8b%e5%8a%a1 aria-label=开启了spring的事务>开启了spring的事务</a></li><li><a href=#%e6%96%b9%e6%b3%95%e5%86%85%e9%83%a8%e8%b0%83%e7%94%a8 aria-label=方法内部调用>方法内部调用</a></li><li><a href=#postconstruct%e5%88%9d%e5%a7%8b%e5%8c%96%e9%a1%ba%e5%ba%8f aria-label=PostConstruct初始化顺序>PostConstruct初始化顺序</a></li><li><a href=#druid%e7%89%88%e6%9c%ac%e8%bf%87%e4%bd%8e aria-label=Druid版本过低>Druid版本过低</a></li><li><a href=#async%e6%88%96%e8%80%85java8%e7%9a%84parallelstream%e5%b9%b6%e8%a1%8c%e6%b5%81%e4%b9%8b%e7%b1%bb%e6%96%b9%e6%b3%95 aria-label=@Async或者java8的ParallelStream并行流之类方法>@Async或者java8的ParallelStream并行流之类方法</a></li></ul></li><li><a href=#%e7%9f%a5%e8%af%86%e5%ba%93 aria-label=知识库>知识库</a><ul><li><a href=#%e5%a6%82%e4%bd%95%e6%b3%a8%e5%85%a5%e5%a4%9a%e6%95%b0%e6%8d%ae%e6%ba%90 aria-label=如何注入多数据源？>如何注入多数据源？</a></li><li><a href=#%e5%a6%82%e4%bd%95%e8%8e%b7%e5%8f%96%e5%bd%93%e5%89%8d%e7%ba%bf%e7%a8%8b%e6%95%b0%e6%8d%ae%e6%ba%90%e5%90%8d%e7%a7%b0 aria-label=如何获取当前线程数据源名称？>如何获取当前线程数据源名称？</a></li><li><a href=#%e5%a6%82%e4%bd%95%e8%8e%b7%e5%8f%96%e5%bd%93%e5%89%8d%e7%ba%bf%e7%a8%8b%e6%95%b0%e6%8d%ae%e6%ba%90 aria-label=如何获取当前线程数据源？>如何获取当前线程数据源？</a></li></ul></li></ul></div></details></div><div class=post-content><p>本文为 <code>dynamic-datasource-spring-boot-starter</code> （基于SpringBoot的快速集成多数据源框架）的使用文档。</p><h1 id=特性>特性<a hidden class=anchor aria-hidden=true href=#特性>#</a></h1><ol><li>支持 <code>数据源分组</code> ，适用于多种场景，纯粹多库、读写分离、一主多从、混合模式。</li><li>支持数据库敏感配置信息 <code>加密(可自定义)</code> ENC()。</li><li>支持每个数据库独立初始化表结构schema和数据库database。</li><li>支持无数据源启动，支持 <code>懒加载数据源</code> （需要的时候再创建连接）。</li><li>支持 <code>自定义注解</code> ，需继承DS(3.2.0+)。</li><li>提供并简化对Druid，HikariCp，BeeCp，Dbcp2的快速集成。</li><li>提供对 <code>Mybatis-Plus</code> ，Quartz，ShardingJdbc，P6sy，Jndi等组件的集成方案。</li><li>提供 <code>自定义数据源来源</code> 方案（如全从数据库加载）。</li><li>提供项目启动后 <code>动态增加移除数据源</code> 方案。</li><li>提供Mybatis环境下的 <code>纯读写分离</code> 方案。</li><li>提供使用 <code>spel动态参数</code> 解析数据源方案。内置spel，session，header，支持自定义。</li><li>支持 <code>多层数据源嵌套切换</code> 。（ServiceA &#187;> ServiceB &#187;> ServiceC）。</li><li>提供 <code>基于seata的分布式事务方案</code> 。</li><li>提供 <code>本地多数据源事务方案</code> 。</li></ol><h1 id=约定>约定<a hidden class=anchor aria-hidden=true href=#约定>#</a></h1><ol><li>dynamic-datasource只做 <code>切换数据源</code> 这件核心的事情，并 <code>不限制你的具体操作</code> ，切换了数据源可以做任何CRUD。</li><li>配置文件所有以下划线 <code>_</code> 分割的数据源 <code>首部</code> 即为组的名称，相同组名称的数据源会放在一个组下。</li><li>切换数据源可以是组名，也可以是具体数据源名称。 <code>组名则切换时采用负载均衡算法切换</code> 。</li><li>默认的数据源名称为 <code>master</code> ，你可以通过 <code>spring.datasource.dynamic.primary</code> 修改。</li><li><code>方法上的注解优先于类上注解</code>。</li><li>DS支持继承抽象类上的DS，暂不支持继承接口上的DS。</li></ol><h1 id=使用方法>使用方法<a hidden class=anchor aria-hidden=true href=#使用方法>#</a></h1><ol><li>引入dynamic-datasource-spring-boot-starter</li></ol><p>spring-boot 1.5.x、2.x.x</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;groupId&gt;</span>com.baomidou<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;artifactId&gt;</span>dynamic-datasource-spring-boot-starter<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;version&gt;</span>${version}<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>spring-boot3及以上</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;groupId&gt;</span>com.baomidou<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;artifactId&gt;</span>dynamic-datasource-spring-boot3-starter<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;version&gt;</span>${version}<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div><ol start=2><li>配置数据源</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dynamic</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>primary</span><span class=p>:</span><span class=w> </span><span class=l>master</span><span class=w> </span><span class=c># 设置默认的数据源或者数据源组,默认值即为master</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>strict</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=c># 严格匹配数据源,默认false. true未匹配到指定数据源时抛异常,false使用默认数据源</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>master</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://xx.xx.xx.xx:3306/dynamic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w> </span><span class=c># 3.2.0开始支持SPI可省略此配置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>slave_1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://xx.xx.xx.xx:3307/dynamic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>slave_2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>ENC(xxxxx)</span><span class=w> </span><span class=c># 内置加密,使用请查看详细文档</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>ENC(xxxxx)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>ENC(xxxxx)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=c># ......省略</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=c># 以上会配置一个默认库master，一个组slave下有两个子库slave_1,slave_2</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 多主多从</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dynamic</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>master_1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>master_2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>slave_1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>slave_2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>slave_3</span><span class=p>:</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 纯粹多库（记得设置primary）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dynamic</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>mysql</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>oracle</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>sqlserver</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>postgresql</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>h2</span><span class=p>:</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 混合配置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dynamic</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>master</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>slave_1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>slave_2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>oracle_1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>oracle_2</span><span class=p>:</span><span class=w>
</span></span></span></code></pre></div><ol start=3><li>使用 <code>@DS</code> 切换数据源</li></ol><p><code>@DS</code> 可以注解在方法上或类上，同时存在 <code>就近原则</code>，<code>方法上注解</code> 优先于 <code>类上注解</code>。</p><table><thead><tr><th style=text-align:center>注解</th><th style=text-align:center>结果</th></tr></thead><tbody><tr><td style=text-align:center>没有@DS</td><td style=text-align:center>默认数据源</td></tr><tr><td style=text-align:center>@DS(&ldquo;dsName&rdquo;)</td><td style=text-align:center>dsName可以为组名也可以为具体某个库的名称，组名则切换时采用负载均衡算法切换</td></tr></tbody></table><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;slave&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UserServiceImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>UserService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=n>JdbcTemplate</span><span class=w> </span><span class=n>jdbcTemplate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c1>// 使用slave数据源</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=w> </span><span class=nf>selectAll</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w>  </span><span class=n>jdbcTemplate</span><span class=p>.</span><span class=na>queryForList</span><span class=p>(</span><span class=s>&#34;select * from user&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c1>// 使用slave_1数据源</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;slave_1&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=w> </span><span class=nf>selectByCondition</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w>  </span><span class=n>jdbcTemplate</span><span class=p>.</span><span class=na>queryForList</span><span class=p>(</span><span class=s>&#34;select * from user where age &gt;10&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h1 id=ds放在哪里合适>DS放在哪里合适<a hidden class=anchor aria-hidden=true href=#ds放在哪里合适>#</a></h1><p>DS作为切换数据源核心注解，我应该把他注解在哪里合适？</p><p>这其实是初次接触多数据源的人常问的问题。</p><p>这其实没有一定的要求，只是有一些经验之谈。</p><p>首先开发者要了解的基础知识是，DS注解是基于AOP的原理实现的，aop的常见失效场景应清楚，比如内部调用失效，shiro代理失效。</p><p><code>通常建议DS放在serviceImpl的方法上，如事务注解一样。</code></p><ul><li>注解在Controller的方法上或类上</li></ul><p>并不是不可以，作者并不建议的原因主要是controller主要作用是参数的检验等一些基础逻辑的处理，这部分操作常常并不涉及数据库。</p><ul><li>注解在service的实现类的方法或类上</li></ul><p>这是作者建议的方式，service主要是对业务的处理， 在复杂的场景涉及连续切换不同的数据库。</p><p>如果你的方法有通用性，其他service也会调用你的方法。 这样别人就不用重复处理切换数据源。</p><ul><li>注解在Mapper上</li></ul><p>通常如果你某个Mapper对应的表只在确定的一个库，也是可以的，但是建议只注解在Mapper的类上。</p><p>我之前出现多线程失效场景的时候，就是在Mapper上加了注解解决的。</p><ul><li>其他使用方式</li></ul><p><strong>继承抽象类上的DS</strong></p><p>比如我有一个抽象Service，我想实现继承我这个抽象Service下的子Service的所有方法除非重新指定，都用我抽象Service上注解的数据源。是否支持？</p><p>答：支持。</p><p><strong>继承接口上的DS</strong></p><p>3.4.1开始支持， 但是需要注意的是，一个类能实现多个接口，如果多个接口都有DS会如何？</p><p>不知道，别这么干。一般不会有人这么干吧，想一想都知道会出问题。</p><h1 id=连接池集成>连接池集成<a hidden class=anchor aria-hidden=true href=#连接池集成>#</a></h1><p>传统多数据源集成连接池如果需要配置的参数较多，则手动编码量大，编程复杂。</p><p>dynamic-datasource实现了常见数据源的参数配置，支持全局配置每个数据源继承。</p><p>通过本章您可以快速掌握不同连接池的集成配置方案和继承中可能遇见的问题。</p><h2 id=连接池必读>连接池必读<a hidden class=anchor aria-hidden=true href=#连接池必读>#</a></h2><ol><li><p>每个数据源都有一个type来指定连接池。</p></li><li><p>每个数据源甚至可以使用不同的连接池，如无特殊需要并不建议。</p></li><li><p>type 不是必填字段。</p></li></ol><p>在没有设置type的时候系统会自动按以下顺序查找并使用连接池：</p><p>Druid > HikariCp > BeeCp > DBCP2 > Spring Basic。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dynamic</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>primary</span><span class=p>:</span><span class=w> </span><span class=l>db1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>db1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://xx.xx.xx.xx:3306/dynamic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>com.zaxxer.hikari.HikariDataSource    </span><span class=w> </span><span class=c># 使用Hikaricp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>db2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://xx.xx.xx.xx:3307/dynamic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>com.alibaba.druid.pool.DruidDataSource</span><span class=w> </span><span class=c># 使用Druid</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>db3</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://xx.xx.xx.xx:3308/dynamic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>cn.beecp.BeeDataSource                </span><span class=w> </span><span class=c># 使用beecp</span><span class=w>
</span></span></span></code></pre></div><h2 id=集成druid>集成Druid<a hidden class=anchor aria-hidden=true href=#集成druid>#</a></h2><h3 id=基础介绍>基础介绍<a hidden class=anchor aria-hidden=true href=#基础介绍>#</a></h3><p>Druid Github：<a href=https://github.com/alibaba/druid>点我跳转</a></p><p>Druid 文档：<a href=https://github.com/alibaba/druid/wiki/%E9%A6%96%E9%A1%B5>点我跳转</a></p><p>dynamic-datasource能<code>简单高效</code>完成对Druid的集成并完成其参数的多元化配置。</p><p>各个库可以使用不同的数据库连接池，如 <code>master使用Druid，slave使用HikariCP</code>。</p><p>如果项目同时存在Druid和HikariCP并且未配置连接池type类型，<code>默认Druid优先于HikariCP</code>。</p><h3 id=集成步骤>集成步骤<a hidden class=anchor aria-hidden=true href=#集成步骤>#</a></h3><p>1、项目引入 <code>druid-spring-boot-starter</code> 依赖</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>com.alibaba<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>druid-spring-boot-starter<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>${version}<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>2、排除原生Druid的快速配置类</p><p>注意：<code>v3.3.3及以上</code> 版本不用排除了。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@SpringBootApplication</span><span class=p>(</span><span class=n>exclude</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DruidDataSourceAutoConfigure</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Application</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>SpringApplication</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>Application</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>args</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>某些SpringBoot的版本上面可能无法排除可用以下方式排除。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>autoconfigure</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>exclude</span><span class=p>:</span><span class=w> </span><span class=l>com.alibaba.druid.spring.boot.autoconfigure.DruidDataSourceAutoConfigure</span><span class=w>
</span></span></span></code></pre></div><p>3、参数配置</p><ol><li>如果参数都未配置，则保持原组件默认值。</li><li>如果配置了全局参数，则每一个数据源都会继承对应参数。</li><li>每一个数据源可以单独设置参数覆盖全局参数。</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>druid</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>stat-view-servlet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>loginUsername</span><span class=p>:</span><span class=w> </span><span class=l>admin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>loginPassword</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dynamic</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>druid</span><span class=p>:</span><span class=w> </span><span class=c># 以下是支持的全局默认值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>initial-size</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>max-active</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>min-idle</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>max-wait</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>time-between-eviction-runs-millis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>time-between-log-stats-millis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>stat-sqlmax-size</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>min-evictable-idle-time-millis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>max-evictable-idle-time-millis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>test-while-idle</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>test-on-borrow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>test-on-return</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>validation-query</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>validation-query-timeout</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>use-global-datasource-stat</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>async-init</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>clear-filters-enable</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>reset-stat-enable</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>not-full-timeout-retry-count</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>max-wait-thread-count</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>fail-fast</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>phyTimeout-millis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>keep-alive</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>pool-prepared-statements</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>init-variants</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>init-global-variants</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>use-unfair-lock</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>kill-when-socket-read-timeout</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>connection-properties</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>max-pool-prepared-statement-per-connection-size</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>init-connection-sqls</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>share-prepared-statements</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>connection-errorretry-attempts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>break-after-acquire-failure</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>filters</span><span class=p>:</span><span class=w> </span><span class=l>stat</span><span class=w> </span><span class=c># 注意这个值和druid原生不一致，默认启动了stat</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>wall</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>noneBaseStatementAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>callAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>selectAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>selectIntoAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>selectIntoOutfileAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>selectWhereAlwayTrueCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>selectHavingAlwayTrueCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>selectUnionCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>selectMinusCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>selectExceptCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>selectIntersectCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>createTableAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>dropTableAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>alterTableAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>renameTableAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>hintAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>lockTableAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>startTransactionAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>blockAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>conditionAndAlwayTrueAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>conditionAndAlwayFalseAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>conditionDoubleConstAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>conditionLikeTrueAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>selectAllColumnAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>deleteAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>deleteWhereAlwayTrueCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>deleteWhereNoneCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>updateAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>updateWhereAlayTrueCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>updateWhereNoneCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>insertAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>mergeAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>minusAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>intersectAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>replaceAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>setAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>commitAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>rollbackAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>useAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>multiStatementAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>truncateAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>commentAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>strictSyntaxCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>constArithmeticAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>limitZeroAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>describeAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>showAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>schemaCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>tableCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>functionCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>objectCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>variantCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>mustParameterized</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>doPrivilegedAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>dir</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>tenantTablePattern</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>tenantColumn</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>wrapAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>metadataAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>conditionOpXorAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>conditionOpBitwseAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>caseConditionConstAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>completeInsertValuesCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>insertValuesCheckSize</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>selectLimit</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>stat</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>merge-sql</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>log-slow-sql</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>slow-sql-millis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>master</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://xx.xx.xx.xx:3306/dynamic?characterEncoding=utf8&amp;useSSL=false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>druid</span><span class=p>:</span><span class=w> </span><span class=c># 以下是独立参数，每个库可以重新设置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>initial-size</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>validation-query</span><span class=p>:</span><span class=w> </span><span class=l>select 1 FROM DUAL</span><span class=w> </span><span class=c># 比如oracle就需要重新设置这个</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>public-key</span><span class=p>:</span><span class=w> </span><span class=c>#（非全局参数）设置即表示启用加密,底层会自动帮你配置相关的连接参数和filter，推荐使用本项目自带的加密方法。</span><span class=w>
</span></span></span></code></pre></div><p>以下是我曾经配置过的示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 数据源配置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 排除掉druid原生的自动配置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>autoconfigure</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>exclude</span><span class=p>:</span><span class=w> </span><span class=l>com.alibaba.druid.spring.boot.autoconfigure.DruidDataSourceAutoConfigure</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    	</span><span class=nt>druid</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c># 初始连接数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>initialSize</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c># 最小连接池数量</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>minIdle</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c># 最大连接池数量</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>maxActive</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c># 配置获取连接等待超时的时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>maxWait</span><span class=p>:</span><span class=w> </span><span class=m>60000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c># 配置连接超时时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>connectTimeout</span><span class=p>:</span><span class=w> </span><span class=m>30000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c># 配置网络超时时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>socketTimeout</span><span class=p>:</span><span class=w> </span><span class=m>60000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c># 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>timeBetweenEvictionRunsMillis</span><span class=p>:</span><span class=w> </span><span class=m>60000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c># 配置一个连接在池中最小生存的时间，单位是毫秒</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>minEvictableIdleTimeMillis</span><span class=p>:</span><span class=w> </span><span class=m>300000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c># 配置一个连接在池中最大生存的时间，单位是毫秒</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>maxEvictableIdleTimeMillis</span><span class=p>:</span><span class=w> </span><span class=m>900000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c># 配置检测连接是否有效</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>validationQuery</span><span class=p>:</span><span class=w> </span><span class=l>SELECT 1 FROM DUAL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>testWhileIdle</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>testOnBorrow</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>testOnReturn</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>webStatFilter</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>statViewServlet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=c># 设置白名单，不填则允许所有访问</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nt>allow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nt>url-pattern</span><span class=p>:</span><span class=w> </span><span class=l>/druid/*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=c># 控制台管理用户名和密码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nt>login-username</span><span class=p>:</span><span class=w> </span><span class=l>admin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nt>login-password</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>filter</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nt>stat</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=c># 慢SQL记录</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=nt>log-slow-sql</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=nt>slow-sql-millis</span><span class=p>:</span><span class=w> </span><span class=m>2000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=nt>merge-sql</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nt>wall</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>						</span><span class=nt>multi-statement-allow</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>dynamic</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>druid</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c># 初始连接数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>initial-size</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c># 最小连接池数量</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>min-idle</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c># 最大连接池数量</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>max-active</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c># 配置获取连接等待超时的时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>max-wait</span><span class=p>:</span><span class=w> </span><span class=m>60000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c># 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>time-between-eviction-runs-millis</span><span class=p>:</span><span class=w> </span><span class=m>60000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c># 配置一个连接在池中最小生存的时间，单位是毫秒</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>min-evictable-idle-time-millis</span><span class=p>:</span><span class=w> </span><span class=m>300000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c># 配置一个连接在池中最大生存的时间，单位是毫秒</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>max-evictable-idle-time-millis</span><span class=p>:</span><span class=w> </span><span class=m>900000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c># 配置检测连接是否有效</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>validation-query</span><span class=p>:</span><span class=w> </span><span class=l>SELECT 1 FROM DUAL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>test-while-idle</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>test-on-borrow</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>test-on-return</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c># 打开PSCache，并指定每个连接上PSCache的大小。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c># oracle设为true，mysql设为false。分库分表较多推荐设置为false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>pool-prepared-statements</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>max-pool-prepared-statement-per-connection-size</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>filters</span><span class=p>:</span><span class=w> </span><span class=l>stat</span><span class=w> </span><span class=c># 注意这个值和druid原生不一致，默认启动了stat</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>stat</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>merge-sql</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>log-slow-sql</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>slow-sql-millis</span><span class=p>:</span><span class=w> </span><span class=m>2000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>primary</span><span class=p>:</span><span class=w> </span><span class=l>master</span><span class=w> </span><span class=c># 设置默认的数据源或者数据源组</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>strict</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=c># 设置严格模式,默认false不启动,启动后在未匹配到指定数据源时候回抛出异常,不启动会使用默认数据源</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>master</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://192.168.56.101:3306/master?useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=true&amp;serverTimezone=GMT%2B8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>slave_1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://192.168.56.102:3306/slave_1?useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=true&amp;serverTimezone=GMT%2B8&amp;rewriteBatchedStatements=true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>slave_2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://192.168.56.103:3306/slave_2?useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=true&amp;serverTimezone=GMT%2B8&amp;rewriteBatchedStatements=true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>druid</span><span class=p>:</span><span class=w> </span><span class=c># 以下参数针对每个库可以重新设置druid参数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>initial-size</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>validation-query</span><span class=p>:</span><span class=w> </span><span class=l>select 1 FROM DUAL</span><span class=w> </span><span class=c># 比如oracle就需要重新设置这个</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>public-key</span><span class=p>:</span><span class=w> </span><span class=c>#（非全局参数）设置即表示启用加密,底层会自动帮你配置相关的连接参数和filter。</span><span class=w>
</span></span></span></code></pre></div><p>如上即可配置访问用户和密码，访问 <code>http://ip:端口/druid/index.html</code> 查看druid监控。</p><h3 id=示例项目>示例项目<a hidden class=anchor aria-hidden=true href=#示例项目>#</a></h3><p><a href=https://github.com/dynamic-datasource/dynamic-datasource-samples/tree/master/datasource-samples/druid-sample>点我跳转</a></p><h3 id=核心源码>核心源码<a hidden class=anchor aria-hidden=true href=#核心源码>#</a></h3><p><code>Druid数据源创建器</code>：<a href=https://github.com/baomidou/dynamic-datasource/blob/master/src/main/java/com/baomidou/dynamic/datasource/creator/DruidDataSourceCreator.java>点我跳转</a></p><p><code>Druid参数源码</code>：<a href=https://github.com/baomidou/dynamic-datasource/blob/master/src/main/java/com/baomidou/dynamic/datasource/spring/boot/autoconfigure/druid/DruidConfig.java>点我跳转</a></p><h2 id=集成hikaricp>集成HikariCP<a hidden class=anchor aria-hidden=true href=#集成hikaricp>#</a></h2><h3 id=基础介绍-1>基础介绍<a hidden class=anchor aria-hidden=true href=#基础介绍-1>#</a></h3><p><code>HikariCP Github</code>：<a href=https://github.com/brettwooldridge/HikariCP>点我跳转</a></p><p><code>HikariCP 文档</code>：<a href=https://github.com/brettwooldridge/HikariCP/wiki>点我跳转</a></p><h3 id=集成步骤-1>集成步骤<a hidden class=anchor aria-hidden=true href=#集成步骤-1>#</a></h3><p>1、项目引入 <code>HikariCP</code> 依赖</p><p><code>SpringBoot2.x.x</code>默认引入了HikariCP，除非对版本有要求无需再次引入。</p><p><code>SpringBoot 1.5.x</code>需手动引入，对应的版本请根据自己环境和HikariCP官方文档自行选择。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>com.zaxxer<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>HikariCP<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>${version}<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>2、参数配置</p><ol><li>如果参数都未配置，则保持原组件默认值。</li><li>如果配置了全局参数，则每一个数据源都会继承对应参数。</li><li>每一个数据源可以单独设置参数覆盖全局参数。</li></ol><p>特别注意，hikaricp原生设置某些字段名和dynamic-datasource不一致，dynamic-datasource是根据参数反射设置，而原生hikaricp字段名称和set名称不一致。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dynamic</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hikari</span><span class=p>:</span><span class=w>  </span><span class=c># 全局hikariCP参数，所有值和默认保持一致。(现已支持的参数如下,不清楚含义不要乱设置)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>catalog</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>connection-timeout</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>validation-timeout</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>idle-timeout</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>leak-detection-threshold</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>max-lifetime</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>max-pool-size</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>min-idle</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>initialization-fail-timeout</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>connection-init-sql</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>connection-test-query</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>dataSource-class-name</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>dataSource-jndi-name</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>schema</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>transaction-isolation-name</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>is-auto-commit</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>is-read-only</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>is-isolate-internal-queries</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>is-register-mbeans</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>is-allow-pool-suspension</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>data-source-properties</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>health-check-properties</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>master</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://xx.xx.xx.xx:3306/dynamic?characterEncoding=utf8&amp;useSSL=false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>hikari</span><span class=p>:</span><span class=w> </span><span class=c># 以下参数针对每个库可以重新设置hikari参数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>max-pool-size</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>idle-timeout</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#           ......</span><span class=w>
</span></span></span></code></pre></div><h3 id=常见问题>常见问题<a hidden class=anchor aria-hidden=true href=#常见问题>#</a></h3><p>Failed to validate connection com.mysql.jdbc.JDBC4Connection@xxxxx (No operations allowed after connection closed.)</p><p><a href=https://github.com/brettwooldridge/HikariCP/issues/1034>https://github.com/brettwooldridge/HikariCP/issues/1034</a></p><p>核心意思就是HikariCP要设置 connection-test-query 并且max-lifetime要小于mysql的默认时间。</p><h3 id=核心源码-1>核心源码<a hidden class=anchor aria-hidden=true href=#核心源码-1>#</a></h3><p><code>HikariCP数据源创建器</code>：<a href=https://github.com/baomidou/dynamic-datasource-spring-boot-starter/blob/master/src/main/java/com/baomidou/dynamic/datasource/creator/HikariDataSourceCreator.java>点我跳转</a></p><p><code>HikariCP参数配置类</code>：<a href=https://github.com/baomidou/dynamic-datasource/blob/master/src/main/java/com/baomidou/dynamic/datasource/spring/boot/autoconfigure/hikari/HikariCpConfig.java>点我跳转</a></p><h1 id=第三方集成>第三方集成<a hidden class=anchor aria-hidden=true href=#第三方集成>#</a></h1><p>通过本章您可以掌握数据源在集成MybatisPlus，Quartz，ShardingJdbc的方案。</p><h2 id=集成mybatisplus>集成MybatisPlus<a hidden class=anchor aria-hidden=true href=#集成mybatisplus>#</a></h2><h3 id=基础介绍-2>基础介绍<a hidden class=anchor aria-hidden=true href=#基础介绍-2>#</a></h3><p><code>MybatisPlus Github</code>：<a href=https://github.com/baomidou/mybatis-plus>点我跳转</a></p><p><code>MybatisPlus 文档</code>： <a href=https://mybatis.plus/>点我跳转</a></p><blockquote><p>只要引入了MybatisPlus相关jar包，项目自动集成，兼容MybatisPlus2.x和3.x的版本。</p></blockquote><h3 id=集成步骤-2>集成步骤<a hidden class=anchor aria-hidden=true href=#集成步骤-2>#</a></h3><p>1、项目引入 <code>Mybatis-Plus</code> 依赖</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>com.baomidou<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>mybatis-plus-boot-starter<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>${version}<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>2、使用<code>DS</code>注解进行切换数据源</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;mysql&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UserServiceImpl</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ServiceImpl</span><span class=o>&lt;</span><span class=n>UserMapper</span><span class=p>,</span><span class=w> </span><span class=n>User</span><span class=o>&gt;</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>UserService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;oracle&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>publid</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>addUser</span><span class=p>(</span><span class=n>User</span><span class=w> </span><span class=n>user</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//do something</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>baseMapper</span><span class=p>.</span><span class=na>insert</span><span class=p>(</span><span class=n>user</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>3、分页配置</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>MybatisPlusInterceptor</span><span class=w> </span><span class=nf>mybatisPlusInterceptor</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>MybatisPlusInterceptor</span><span class=w> </span><span class=n>interceptor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MybatisPlusInterceptor</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//如果是不同类型的库，请不要指定DbType，其会自动判断。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>interceptor</span><span class=p>.</span><span class=na>addInnerInterceptor</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>PaginationInnerInterceptor</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=c1>// interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>interceptor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=注意事项>注意事项<a hidden class=anchor aria-hidden=true href=#注意事项>#</a></h3><p>MybatisPlus内置的ServiceImpl在新增，更改，删除等一些方法上自带事物导致不能切换数据源。</p><p>解决方法：</p><p>方法1：复制ServiceImpl出来为自己的MyServiceImpl，并去掉所有事务注解。</p><p>方法2：创建一个新方法，并在此方法上加DS注解. 如上面的<code>addUser</code>方法。</p><h3 id=faq>FAQ<a hidden class=anchor aria-hidden=true href=#faq>#</a></h3><p>为什么要单独拿出来说和MybatisPlus的集成？</p><p>因为MybatisPlus重写了一些核心类，必须通过解析获得真实的代理对象。</p><p>如果自己写多数据源，则很难完成与mp的集成。</p><p>核心解析源码：<a href=https://github.com/baomidou/dynamic-datasource/blob/master/src/main/java/com/baomidou/dynamic/datasource/support/DataSourceClassResolver.java>点我跳转</a></p><h3 id=示例项目-1>示例项目<a hidden class=anchor aria-hidden=true href=#示例项目-1>#</a></h3><p><a href=https://github.com/dynamic-datasource/dynamic-datasource-samples/tree/master/orm-samples/mybatisplus3-sample>点我跳转</a></p><h2 id=其他集成>其他集成<a hidden class=anchor aria-hidden=true href=#其他集成>#</a></h2><p>集成P6spy、集成Quartz、集成ShardingJdbc</p><p>由于以上场景暂时没用到，文章中暂时不体现了，如有用到，后面会补充上。</p><h1 id=进阶使用>进阶使用<a hidden class=anchor aria-hidden=true href=#进阶使用>#</a></h1><p><code>动态添加移除数据源</code>：指在系统运行过程中动态的添加数据源，删除数据源，多使用于基于数据库的多租户系统。</p><p><code>动态解析数据源</code>：指数据源切换是不固定的，可以根据域名，根据header参数，根据session参数，根据方法变量等来动态切换。多使用于多租户系统，支持扩展。</p><p><code>数据库加密</code>：指数据库的url，username，password需要加密，长用于安全性较高系统，不让普通开发通过配置知道生产库的连接配置。</p><p><code>启动初始化脚本</code>：指数据源启动的时候可以执行schema和data的脚本来初始化结构和数据，dynamic-datasource组件支持每个数据源加载不同的schema和data。</p><p><code>自动读写分离</code>：适用于mybatis环境，基于mybatis插件实现无注解自动读写分离。</p><p><code>懒启动数据源</code>：指配置的数据源不立即启动，等需要建立连接的时候再真正初始化连接池。</p><p><code>无数据源启动</code>：指启动的时候不配置任何数据源，全靠后期系统动态添加。</p><p><code>手动切换数据源</code>：指某些情况无法根据注解切换，通过工具类手动切换数据源。</p><h2 id=动态添加移除数据源>动态添加移除数据源<a hidden class=anchor aria-hidden=true href=#动态添加移除数据源>#</a></h2><h3 id=基础介绍-3>基础介绍<a hidden class=anchor aria-hidden=true href=#基础介绍-3>#</a></h3><p>主要在多租户场景中，常常新的一个租户进来需要动态的添加一个数据源到库中，使得系统不用重启即可切换数据源。</p><h3 id=使用步骤>使用步骤<a hidden class=anchor aria-hidden=true href=#使用步骤>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>com.baomidou.dynamic.datasource.DynamicRoutingDataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.baomidou.dynamic.datasource.creator.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.baomidou.dynamic.datasource.spring.boot.autoconfigure.DataSourceProperty</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.baomidou.samples.ds.dto.DataSourceDTO</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>io.swagger.annotations.Api</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>io.swagger.annotations.ApiOperation</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.beans.BeanUtils</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.beans.factory.annotation.Autowired</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.validation.annotation.Validated</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.web.bind.annotation.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>javax.sql.DataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Set</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RestController</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RequestMapping</span><span class=p>(</span><span class=s>&#34;/datasources&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Api</span><span class=p>(</span><span class=n>tags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;添加删除数据源&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DataSourceController</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// private final DataSourceCreator dataSourceCreator;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 3.3.1及以下版本使用这个通用，强烈推荐sb2用户至少升级到3.5.2版本</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>DefaultDataSourceCreator</span><span class=w> </span><span class=n>dataSourceCreator</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>BasicDataSourceCreator</span><span class=w> </span><span class=n>basicDataSourceCreator</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>JndiDataSourceCreator</span><span class=w> </span><span class=n>jndiDataSourceCreator</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>DruidDataSourceCreator</span><span class=w> </span><span class=n>druidDataSourceCreator</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>HikariDataSourceCreator</span><span class=w> </span><span class=n>hikariDataSourceCreator</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>BeeCpDataSourceCreator</span><span class=w> </span><span class=n>beeCpDataSourceCreator</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Dbcp2DataSourceCreator</span><span class=w> </span><span class=n>dbcp2DataSourceCreator</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;获取当前所有数据源&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>now</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DynamicRoutingDataSource</span><span class=w> </span><span class=n>ds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>DynamicRoutingDataSource</span><span class=p>)</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ds</span><span class=p>.</span><span class=na>getDataSources</span><span class=p>().</span><span class=na>keySet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 通用数据源会根据maven中配置的连接池根据顺序依次选择。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 默认的顺序为druid&gt;hikaricp&gt;beecp&gt;dbcp&gt;spring basic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PostMapping</span><span class=p>(</span><span class=s>&#34;/add&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;通用添加数据源（推荐）&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>add</span><span class=p>(</span><span class=nd>@Validated</span><span class=w> </span><span class=nd>@RequestBody</span><span class=w> </span><span class=n>DataSourceDTO</span><span class=w> </span><span class=n>dto</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DataSourceProperty</span><span class=w> </span><span class=n>dataSourceProperty</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataSourceProperty</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BeanUtils</span><span class=p>.</span><span class=na>copyProperties</span><span class=p>(</span><span class=n>dto</span><span class=p>,</span><span class=w> </span><span class=n>dataSourceProperty</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DynamicRoutingDataSource</span><span class=w> </span><span class=n>ds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>DynamicRoutingDataSource</span><span class=p>)</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dataSourceCreator</span><span class=p>.</span><span class=na>createDataSource</span><span class=p>(</span><span class=n>dataSourceProperty</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ds</span><span class=p>.</span><span class=na>addDataSource</span><span class=p>(</span><span class=n>dto</span><span class=p>.</span><span class=na>getPoolName</span><span class=p>(),</span><span class=w> </span><span class=n>dataSource</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ds</span><span class=p>.</span><span class=na>getDataSources</span><span class=p>().</span><span class=na>keySet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PostMapping</span><span class=p>(</span><span class=s>&#34;/addBasic(强烈不推荐，除了用了马上移除)&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;添加基础数据源&#34;</span><span class=p>,</span><span class=w> </span><span class=n>notes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;调用Springboot内置方法创建数据源，兼容1,2&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>addBasic</span><span class=p>(</span><span class=nd>@Validated</span><span class=w> </span><span class=nd>@RequestBody</span><span class=w> </span><span class=n>DataSourceDTO</span><span class=w> </span><span class=n>dto</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DataSourceProperty</span><span class=w> </span><span class=n>dataSourceProperty</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataSourceProperty</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BeanUtils</span><span class=p>.</span><span class=na>copyProperties</span><span class=p>(</span><span class=n>dto</span><span class=p>,</span><span class=w> </span><span class=n>dataSourceProperty</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DynamicRoutingDataSource</span><span class=w> </span><span class=n>ds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>DynamicRoutingDataSource</span><span class=p>)</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>basicDataSourceCreator</span><span class=p>.</span><span class=na>createDataSource</span><span class=p>(</span><span class=n>dataSourceProperty</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ds</span><span class=p>.</span><span class=na>addDataSource</span><span class=p>(</span><span class=n>dto</span><span class=p>.</span><span class=na>getPoolName</span><span class=p>(),</span><span class=w> </span><span class=n>dataSource</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ds</span><span class=p>.</span><span class=na>getDataSources</span><span class=p>().</span><span class=na>keySet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PostMapping</span><span class=p>(</span><span class=s>&#34;/addJndi&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;添加JNDI数据源&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>addJndi</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>pollName</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>jndiName</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DynamicRoutingDataSource</span><span class=w> </span><span class=n>ds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>DynamicRoutingDataSource</span><span class=p>)</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jndiDataSourceCreator</span><span class=p>.</span><span class=na>createDataSource</span><span class=p>(</span><span class=n>jndiName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ds</span><span class=p>.</span><span class=na>addDataSource</span><span class=p>(</span><span class=n>poolName</span><span class=p>,</span><span class=w> </span><span class=n>dataSource</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ds</span><span class=p>.</span><span class=na>getDataSources</span><span class=p>().</span><span class=na>keySet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PostMapping</span><span class=p>(</span><span class=s>&#34;/addDruid&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;基础Druid数据源&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>addDruid</span><span class=p>(</span><span class=nd>@Validated</span><span class=w> </span><span class=nd>@RequestBody</span><span class=w> </span><span class=n>DataSourceDTO</span><span class=w> </span><span class=n>dto</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DataSourceProperty</span><span class=w> </span><span class=n>dataSourceProperty</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataSourceProperty</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BeanUtils</span><span class=p>.</span><span class=na>copyProperties</span><span class=p>(</span><span class=n>dto</span><span class=p>,</span><span class=w> </span><span class=n>dataSourceProperty</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>dataSourceProperty</span><span class=p>.</span><span class=na>setLazy</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DynamicRoutingDataSource</span><span class=w> </span><span class=n>ds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>DynamicRoutingDataSource</span><span class=p>)</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>druidDataSourceCreator</span><span class=p>.</span><span class=na>createDataSource</span><span class=p>(</span><span class=n>dataSourceProperty</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ds</span><span class=p>.</span><span class=na>addDataSource</span><span class=p>(</span><span class=n>dto</span><span class=p>.</span><span class=na>getPoolName</span><span class=p>(),</span><span class=w> </span><span class=n>dataSource</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ds</span><span class=p>.</span><span class=na>getDataSources</span><span class=p>().</span><span class=na>keySet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PostMapping</span><span class=p>(</span><span class=s>&#34;/addHikariCP&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;基础HikariCP数据源&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>addHikariCP</span><span class=p>(</span><span class=nd>@Validated</span><span class=w> </span><span class=nd>@RequestBody</span><span class=w> </span><span class=n>DataSourceDTO</span><span class=w> </span><span class=n>dto</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DataSourceProperty</span><span class=w> </span><span class=n>dataSourceProperty</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataSourceProperty</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BeanUtils</span><span class=p>.</span><span class=na>copyProperties</span><span class=p>(</span><span class=n>dto</span><span class=p>,</span><span class=w> </span><span class=n>dataSourceProperty</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>dataSourceProperty</span><span class=p>.</span><span class=na>setLazy</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w> </span><span class=c1>// 3.4.0版本以下如果有此属性，需手动设置，不然会空指针。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DynamicRoutingDataSource</span><span class=w> </span><span class=n>ds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>DynamicRoutingDataSource</span><span class=p>)</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>hikariDataSourceCreator</span><span class=p>.</span><span class=na>createDataSource</span><span class=p>(</span><span class=n>dataSourceProperty</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ds</span><span class=p>.</span><span class=na>addDataSource</span><span class=p>(</span><span class=n>dto</span><span class=p>.</span><span class=na>getPoolName</span><span class=p>(),</span><span class=w> </span><span class=n>dataSource</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ds</span><span class=p>.</span><span class=na>getDataSources</span><span class=p>().</span><span class=na>keySet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PostMapping</span><span class=p>(</span><span class=s>&#34;/addBeeCp&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;基础BeeCp数据源&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>addBeeCp</span><span class=p>(</span><span class=nd>@Validated</span><span class=w> </span><span class=nd>@RequestBody</span><span class=w> </span><span class=n>DataSourceDTO</span><span class=w> </span><span class=n>dto</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DataSourceProperty</span><span class=w> </span><span class=n>dataSourceProperty</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataSourceProperty</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BeanUtils</span><span class=p>.</span><span class=na>copyProperties</span><span class=p>(</span><span class=n>dto</span><span class=p>,</span><span class=w> </span><span class=n>dataSourceProperty</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>dataSourceProperty</span><span class=p>.</span><span class=na>setLazy</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w> </span><span class=c1>// 3.4.0版本以下如果有此属性，需手动设置，不然会空指针。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DynamicRoutingDataSource</span><span class=w> </span><span class=n>ds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>DynamicRoutingDataSource</span><span class=p>)</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>beeCpDataSourceCreator</span><span class=p>.</span><span class=na>createDataSource</span><span class=p>(</span><span class=n>dataSourceProperty</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ds</span><span class=p>.</span><span class=na>addDataSource</span><span class=p>(</span><span class=n>dto</span><span class=p>.</span><span class=na>getPoolName</span><span class=p>(),</span><span class=w> </span><span class=n>dataSource</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ds</span><span class=p>.</span><span class=na>getDataSources</span><span class=p>().</span><span class=na>keySet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PostMapping</span><span class=p>(</span><span class=s>&#34;/addDbcp&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;基础Dbcp数据源&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>addDbcp</span><span class=p>(</span><span class=nd>@Validated</span><span class=w> </span><span class=nd>@RequestBody</span><span class=w> </span><span class=n>DataSourceDTO</span><span class=w> </span><span class=n>dto</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DataSourceProperty</span><span class=w> </span><span class=n>dataSourceProperty</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataSourceProperty</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BeanUtils</span><span class=p>.</span><span class=na>copyProperties</span><span class=p>(</span><span class=n>dto</span><span class=p>,</span><span class=w> </span><span class=n>dataSourceProperty</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>dataSourceProperty</span><span class=p>.</span><span class=na>setLazy</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w> </span><span class=c1>// 3.4.0版本以下如果有此属性，需手动设置，不然会空指针。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DynamicRoutingDataSource</span><span class=w> </span><span class=n>ds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>DynamicRoutingDataSource</span><span class=p>)</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dbcp2DataSourceCreator</span><span class=p>.</span><span class=na>createDataSource</span><span class=p>(</span><span class=n>dataSourceProperty</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ds</span><span class=p>.</span><span class=na>addDataSource</span><span class=p>(</span><span class=n>dto</span><span class=p>.</span><span class=na>getPoolName</span><span class=p>(),</span><span class=w> </span><span class=n>dataSource</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ds</span><span class=p>.</span><span class=na>getDataSources</span><span class=p>().</span><span class=na>keySet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DeleteMapping</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;删除数据源&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>remove</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DynamicRoutingDataSource</span><span class=w> </span><span class=n>ds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>DynamicRoutingDataSource</span><span class=p>)</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ds</span><span class=p>.</span><span class=na>removeDataSource</span><span class=p>(</span><span class=n>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&#34;删除成功&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=示例项目-2>示例项目<a hidden class=anchor aria-hidden=true href=#示例项目-2>#</a></h3><p><a href=https://github.com/dynamic-datasource/dynamic-datasource-samples/tree/master/features-samples/add-remove-datasource-sample>点我跳转</a></p><h3 id=源码分析>源码分析<a hidden class=anchor aria-hidden=true href=#源码分析>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>DataSourceCreator</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 通过属性创建数据源
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param dataSourceProperty 数据源属性
</span></span></span><span class=line><span class=cl><span class=cm>     * @return 被创建的数据源
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DataSource</span><span class=w> </span><span class=nf>createDataSource</span><span class=p>(</span><span class=n>DataSourceProperty</span><span class=w> </span><span class=n>dataSourceProperty</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 当前创建器是否支持根据此属性创建
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param dataSourceProperty 数据源属性
</span></span></span><span class=line><span class=cl><span class=cm>     * @return 是否支持
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=nf>support</span><span class=p>(</span><span class=n>DataSourceProperty</span><span class=w> </span><span class=n>dataSourceProperty</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>DataSourceCreator是一个接口，定义了根据参数创建数据源的接口。</p><p>其他creator实现此接口，dynamic-datasource项目暂时实现了Druid和Hikaricp的等连接池的实现。</p><p>BasicDataSourceCreator 是调用Spring原生的创建方式，只支持最最原始的基础配置。</p><p>DefaultDataSourceCreator 是一个通用的创建器，其根据环境自动选择连接池。</p><h2 id=动态解析数据源>动态解析数据源<a hidden class=anchor aria-hidden=true href=#动态解析数据源>#</a></h2><h3 id=基础介绍-4>基础介绍<a hidden class=anchor aria-hidden=true href=#基础介绍-4>#</a></h3><p>默认有三个职责链来处理动态参数解析器 header -> session -> spel</p><p>所有以 <code>#</code> 开头的参数都会从参数中获取数据源</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;#session.tenantName&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>// 从session获取</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=w> </span><span class=nf>selectSpelBySession</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=n>userMapper</span><span class=p>.</span><span class=na>selectUsers</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;#header.tenantName&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>// 从header获取</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=w> </span><span class=nf>selectSpelByHeader</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=n>userMapper</span><span class=p>.</span><span class=na>selectUsers</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;#tenantName&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>// 使用spel从参数获取</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=w> </span><span class=nf>selectSpelByKey</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>tenantName</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=n>userMapper</span><span class=p>.</span><span class=na>selectUsers</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;#user.tenantName&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>// 使用spel从复杂参数获取</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=w> </span><span class=nf>selecSpelByTenant</span><span class=p>(</span><span class=n>User</span><span class=w> </span><span class=n>user</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=n>userMapper</span><span class=p>.</span><span class=na>selectUsers</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=如何扩展>如何扩展<a hidden class=anchor aria-hidden=true href=#如何扩展>#</a></h3><ol><li>我想从cookie中获取参数解析?</li><li>我想从其他环境属性中来计算?</li></ol><p>参考header解析器，继承DsProcessor，如果matches返回true则匹配成功，调用doDetermineDatasource返回匹配到的数据源，否则跳到下一个解析器。</p><p>1、自定义一个处理器</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DsHeaderProcessor</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>DsProcessor</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>HEADER_PREFIX</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;#header&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>matches</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>startsWith</span><span class=p>(</span><span class=n>HEADER_PREFIX</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>doDetermineDatasource</span><span class=p>(</span><span class=n>MethodInvocation</span><span class=w> </span><span class=n>invocation</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>ServletRequestAttributes</span><span class=p>)</span><span class=w> </span><span class=n>RequestContextHolder</span><span class=p>.</span><span class=na>getRequestAttributes</span><span class=p>()).</span><span class=na>getRequest</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getHeader</span><span class=p>(</span><span class=n>key</span><span class=p>.</span><span class=na>substring</span><span class=p>(</span><span class=n>8</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>2、重写完后重新注入一个根据自己解析顺序的解析处理器</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MyDynamicDataSourceConfig</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=kd>public</span><span class=w> </span><span class=n>DsProcessor</span><span class=w> </span><span class=nf>dsProcessor</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DsHeaderProcessor</span><span class=w> </span><span class=n>headerProcessor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DsHeaderProcessor</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DsSessionProcessor</span><span class=w> </span><span class=n>sessionProcessor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DsSessionProcessor</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DsSpelExpressionProcessor</span><span class=w> </span><span class=n>spelExpressionProcessor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DsSpelExpressionProcessor</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>headerProcessor</span><span class=p>.</span><span class=na>setNextProcessor</span><span class=p>(</span><span class=n>sessionProcessor</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sessionProcessor</span><span class=p>.</span><span class=na>setNextProcessor</span><span class=p>(</span><span class=n>spelExpressionProcessor</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>headerProcessor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=注意>注意<a hidden class=anchor aria-hidden=true href=#注意>#</a></h3><p>如果在Mapper接口下面的方法使用：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>UserMapper</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 前缀可以是p0,a0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;#p0.tenantName&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=w> </span><span class=nf>selecSpelByTenant</span><span class=p>(</span><span class=n>User</span><span class=w> </span><span class=n>user</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>对于在接口下面的使用, 由于编译器的默认配置没有将接口参数的元数据写入字节码文件中
所以spring el会无法识别参数名称, 只能用默认的参数命名方式</p><ol><li>第一个参数: p0，a0,(加入-parameters后，可以使用参数具体的名字，例如这里的#user)</li><li>第二个参数: p1，a1</li><li>第三个参数: P2,，a2</li></ol><p>可以通过修改maven配置和java编译配置将接口参数信息写入字节码文件</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl>    <span class=nt>&lt;plugin&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;groupId&gt;</span>org.apache.maven.plugins<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;artifactId&gt;</span>maven-compiler-plugin<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>        <span class=c>&lt;!-- 想启用  &lt;parameters&gt;true&lt;/parameters&gt; 的maven编译最低版本为:3.6.2 --&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;version&gt;</span>3.6.2<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;configuration&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;source&gt;</span>${java.version}<span class=nt>&lt;/source&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;target&gt;</span>${java.version}<span class=nt>&lt;/target&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;parameters&gt;</span>true<span class=nt>&lt;/parameters&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/configuration&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/plugin&gt;</span>
</span></span></code></pre></div><p>idea java编译配置: <code>-parameters</code></p><blockquote><p>java 支持-parameters的最低版本为 1.8</p></blockquote><h2 id=数据库加密>数据库加密<a hidden class=anchor aria-hidden=true href=#数据库加密>#</a></h2><h3 id=基础介绍-5>基础介绍<a hidden class=anchor aria-hidden=true href=#基础介绍-5>#</a></h3><p>在一些项目中，有对数据库关键字段加密的需求，大家熟悉的是Druid的加密方式。</p><p>在连接池集成中的Druid章节里有对应的加密方式，但是如果我不用Druid也想用加密呢？</p><p>所以作者copy了Druid的加密相关源码，嘿嘿。</p><p>dynamic-datasource项目也支持支持<code>url</code> , <code>username</code>, <code>password</code> 的加密。</p><p>使用的RAS加密，相关原理文章 <a href=https://www.cnblogs.com/pcheng/p/9629621.html>https://www.cnblogs.com/pcheng/p/9629621.html</a>。</p><p>简单来说就是生成两把钥匙，私钥加密，公钥解密。</p><p>公钥可以发布出去，解密也是用的公钥。</p><h3 id=具体使用>具体使用<a hidden class=anchor aria-hidden=true href=#具体使用>#</a></h3><p>1、获得加密字符串</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>com.baomidou.dynamic.datasource.toolkit.CryptoUtils</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Demo</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>password</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;123456&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 使用默认的publicKey ，建议还是使用下面的自定义</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>encodePassword</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>CryptoUtils</span><span class=p>.</span><span class=na>encrypt</span><span class=p>(</span><span class=n>password</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>encodePassword</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 自定义publicKey</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>arr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>CryptoUtils</span><span class=p>.</span><span class=na>genKeyPair</span><span class=p>(</span><span class=n>512</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;privateKey:  &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>arr</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;publicKey:  &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>arr</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;url:  &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>CryptoUtils</span><span class=p>.</span><span class=na>encrypt</span><span class=p>(</span><span class=n>arr</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>,</span><span class=w> </span><span class=s>&#34;jdbc:mysql://127.0.0.1:3306/order&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;username:  &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>CryptoUtils</span><span class=p>.</span><span class=na>encrypt</span><span class=p>(</span><span class=n>arr</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>,</span><span class=w> </span><span class=s>&#34;root&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;password:  &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>CryptoUtils</span><span class=p>.</span><span class=na>encrypt</span><span class=p>(</span><span class=n>arr</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>,</span><span class=w> </span><span class=s>&#34;123456&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>2、配置加密yml</p><p><code>ENC(xxx)</code> 中包裹的<code>xxx</code>即为使用上面加密方法后生成的字符串</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dynamic</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>public-key</span><span class=p>:</span><span class=w> </span><span class=c># 有默认值，强烈建议更换</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>master</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>ENC(xxx)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>ENC(xxx)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>ENC(xxx)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>public-key</span><span class=p>:</span><span class=w> </span><span class=c># 每个数据源可以独立设置，没有就继承上面的。</span><span class=w>
</span></span></span></code></pre></div><h3 id=自定义解密>自定义解密<a hidden class=anchor aria-hidden=true href=#自定义解密>#</a></h3><p>一些公司要求使用自己的方式加密，解密。</p><p>从3.5.0版本开始，扩展了一个event，用户自行实现注入即可。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>DataSourceInitEvent</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 连接池创建前执行（可用于参数解密）
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param dataSourceProperty 数据源基础信息
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>beforeCreate</span><span class=p>(</span><span class=n>DataSourceProperty</span><span class=w> </span><span class=n>dataSourceProperty</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 连接池创建后执行
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param dataSource 连接池
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>afterCreate</span><span class=p>(</span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>默认的实现是EncDataSourceInitEvent，即ENC方式的。</p><h3 id=为什么不是公钥加密私钥解密>为什么不是公钥加密，私钥解密<a hidden class=anchor aria-hidden=true href=#为什么不是公钥加密私钥解密>#</a></h3><p>根据RSA的设计，大部分人会认为应该是公钥加密，私钥解密。 为什么Druid设计相反？</p><p><code>建议更高的安全，可以把publicKey在启动时候传进去，或者配置中心配好，不让普通开发接触到就好。</code></p><p>查询了Druid的ISSUE和一些文章：</p><p>1、Druid作者wenshao自己的回答：<a href=https://github.com/alibaba/druid/issues/960>点我跳转</a></p><p>2、知乎一些文章片段</p><p><img loading=lazy src=/blog/posts/code/174974400001/images/1.png></p><h2 id=启动初始化执行脚本>启动初始化执行脚本<a hidden class=anchor aria-hidden=true href=#启动初始化执行脚本>#</a></h2><p>3.5.0 之前版本</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dynamic</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>primary</span><span class=p>:</span><span class=w> </span><span class=l>order</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>order</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># 基础配置省略...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>schema</span><span class=p>:</span><span class=w> </span><span class=l>db/order/schema.sql</span><span class=w> </span><span class=c># 配置则生效,自动初始化表结构</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>data</span><span class=p>:</span><span class=w> </span><span class=l>db/order/data.sql</span><span class=w> </span><span class=c># 配置则生效,自动初始化数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>continue-on-error</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w> </span><span class=c># 默认true,初始化失败是否继续</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>separator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;;&#34;</span><span class=w> </span><span class=c># sql默认分号分隔符，一般无需更改</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>product</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>schema</span><span class=p>:</span><span class=w> </span><span class=l>classpath*:db/product/schema.sql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>data</span><span class=p>:</span><span class=w> </span><span class=l>classpath*:db/product/data.sql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>user</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>schema</span><span class=p>:</span><span class=w> </span><span class=l>classpath*:db/user/schema/**/*.sql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>data</span><span class=p>:</span><span class=w> </span><span class=l>classpath*:db/user/data/**/*.sql</span><span class=w>
</span></span></span></code></pre></div><p>3.5.0（含） 之后版本 (层级多了一层init，保持和新版springboot一致)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dynamic</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>primary</span><span class=p>:</span><span class=w> </span><span class=l>order</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>order</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># 基础配置省略...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>init</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>schema</span><span class=p>:</span><span class=w> </span><span class=l>db/order/schema.sql</span><span class=w> </span><span class=c># 配置则生效,自动初始化表结构</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>data</span><span class=p>:</span><span class=w> </span><span class=l>db/order/data.sql</span><span class=w> </span><span class=c># 配置则生效,自动初始化数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>continue-on-error</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w> </span><span class=c># 默认true,初始化失败是否继续</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>separator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;;&#34;</span><span class=w> </span><span class=c># sql默认分号分隔符，一般无需更改</span><span class=w>
</span></span></span></code></pre></div><h2 id=懒启动数据源>懒启动数据源<a hidden class=anchor aria-hidden=true href=#懒启动数据源>#</a></h2><p>懒启动：连接池创建出来后并不会立即初始化连接池，等需要使用connection的时候再初始化。</p><p>暂时只支持Druid和HikariCp和BeeCp连接池。</p><p>主要场景可能适合于数据源很多，又不需要启动立即初始化的情况，可以减少系统启动时间。</p><p><code>缺点</code>在于，如果参数配置有误，则启动的时候不知道，初始化的时候失败，可能一直抛异常。</p><h3 id=配置使用>配置使用<a hidden class=anchor aria-hidden=true href=#配置使用>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dynamic</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>primary</span><span class=p>:</span><span class=w> </span><span class=l>master</span><span class=w> </span><span class=c># 设置默认的数据源或者数据源组,默认值即为master</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>strict</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=c># 设置严格模式,默认false不启动. 启动后在未匹配到指定数据源时候会抛出异常,不启动则使用默认数据源.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>lazy</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w> </span><span class=c># 默认false非懒启动，系统加载到数据源立即初始化连接池</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>master</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://xx.xx.xx.xx:3306/dynamic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>lazy</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w> </span><span class=c>#表示这个数据源懒启动</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>db1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://xx.xx.xx.xx:3307/dynamic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>db2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://xx.xx.xx.xx:3307/dynamic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span></code></pre></div><h2 id=无数据源启动>无数据源启动<a hidden class=anchor aria-hidden=true href=#无数据源启动>#</a></h2><h3 id=基础介绍-6>基础介绍<a hidden class=anchor aria-hidden=true href=#基础介绍-6>#</a></h3><p>场景：部分系统可能启动的时候完全不需要数据源，全靠启动后动态添加。</p><h3 id=配置方式>配置方式<a hidden class=anchor aria-hidden=true href=#配置方式>#</a></h3><p>即基本不需要配置，可能根据需要配置一些类似Druid和HikariCp全局参数。</p><p>如需配置Druid和HikariCp全局参数可参考对应章节文档。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dynamic</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>primary</span><span class=p>:</span><span class=w> </span><span class=l>master</span><span class=w> </span><span class=c># 设置默认的数据源或者数据源组,默认值即为master</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>strict</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=c># 设置严格模式,默认false不启动. 启动后在未匹配到指定数据源时候会抛出异常,不启动则使用默认数据源.</span><span class=w>
</span></span></span></code></pre></div><p>因为没有匹配的主数据源，启动的时候你会见到类似如下日志。</p><pre tabindex=0><code>dynamic-datasource initial loaded 0 datasource,Please add your primary datasource or check your configuration
</code></pre><h2 id=手动切换数据源>手动切换数据源<a hidden class=anchor aria-hidden=true href=#手动切换数据源>#</a></h2><p>在某些情况您可能需要手动切换数据源。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>com.baomidou.dynamic.datasource.toolkit.DynamicDataSourceContextHolder</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UserServiceImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>UserService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=n>JdbcTemplate</span><span class=w> </span><span class=n>jdbcTemplate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=w> </span><span class=nf>selectAll</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DynamicDataSourceContextHolder</span><span class=p>.</span><span class=na>push</span><span class=p>(</span><span class=s>&#34;slave&#34;</span><span class=p>);</span><span class=w> </span><span class=c1>// 手动切换</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w>  </span><span class=n>jdbcTemplate</span><span class=p>.</span><span class=na>queryForList</span><span class=p>(</span><span class=s>&#34;select * from user&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>需要注意的是手动切换的数据源，最好自己在合适的位置调用DynamicDataSourceContextHolder.clear()清空当前线程的数据源信息，防止内存泄漏，因为一层使用的是ThreadLocal</strong></p><p>如果你不太清楚什么时候调用，那么可以参考下面写一个拦截器，注册进spring里即可。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DynamicDatasourceClearInterceptor</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>HandlerInterceptor</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>preHandle</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>handler</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 入口处清空看个人，有的新人在异步里切了数据源但是忘记清除了，下一个请求遇到这个线程就会带进来。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// DynamicDataSourceContextHolder.clear();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>postHandle</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>handler</span><span class=p>,</span><span class=w> </span><span class=n>ModelAndView</span><span class=w> </span><span class=n>modelAndView</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>afterCompletion</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>handler</span><span class=p>,</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DynamicDataSourceContextHolder</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=手动注入多数据源>手动注入多数据源<a hidden class=anchor aria-hidden=true href=#手动注入多数据源>#</a></h2><p>什么时候需要手动注入多数据源？</p><p>绝大部分是因为您的系统需要和其他数据源共同存在使用。</p><p>如Quartz和ShardingJdbc等都需要使用独立的数据源。</p><p>dynamic-datasource 3.4.0及以上版本和老版本注入方式有一定差别，根据自己版本注入。</p><p><code>注意一定要让多数据源使用 @Primary ，让其成为主数据源。</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 3.4.0版本以下</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Primary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=nf>dataSource</span><span class=p>(</span><span class=n>DynamicDataSourceProvider</span><span class=w> </span><span class=n>dynamicDataSourceProvider</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DynamicRoutingDataSource</span><span class=w> </span><span class=n>dataSource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DynamicRoutingDataSource</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dataSource</span><span class=p>.</span><span class=na>setPrimary</span><span class=p>(</span><span class=n>properties</span><span class=p>.</span><span class=na>getPrimary</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dataSource</span><span class=p>.</span><span class=na>setStrict</span><span class=p>(</span><span class=n>properties</span><span class=p>.</span><span class=na>getStrict</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dataSource</span><span class=p>.</span><span class=na>setStrategy</span><span class=p>(</span><span class=n>properties</span><span class=p>.</span><span class=na>getStrategy</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dataSource</span><span class=p>.</span><span class=na>setProvider</span><span class=p>(</span><span class=n>dynamicDataSourceProvider</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dataSource</span><span class=p>.</span><span class=na>setP6spy</span><span class=p>(</span><span class=n>properties</span><span class=p>.</span><span class=na>getP6spy</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dataSource</span><span class=p>.</span><span class=na>setSeata</span><span class=p>(</span><span class=n>properties</span><span class=p>.</span><span class=na>getSeata</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 3.4.0版本及以上</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Primary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=nf>dataSource</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DynamicRoutingDataSource</span><span class=w> </span><span class=n>dataSource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DynamicRoutingDataSource</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dataSource</span><span class=p>.</span><span class=na>setPrimary</span><span class=p>(</span><span class=n>properties</span><span class=p>.</span><span class=na>getPrimary</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dataSource</span><span class=p>.</span><span class=na>setStrict</span><span class=p>(</span><span class=n>properties</span><span class=p>.</span><span class=na>getStrict</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dataSource</span><span class=p>.</span><span class=na>setStrategy</span><span class=p>(</span><span class=n>properties</span><span class=p>.</span><span class=na>getStrategy</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dataSource</span><span class=p>.</span><span class=na>setP6spy</span><span class=p>(</span><span class=n>properties</span><span class=p>.</span><span class=na>getP6spy</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dataSource</span><span class=p>.</span><span class=na>setSeata</span><span class=p>(</span><span class=n>properties</span><span class=p>.</span><span class=na>getSeata</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>主要变更是因为3.4.0支持了多个provider同时生效，采取了内部注入，<a href=https://github.com/baomidou/dynamic-datasource/commit/6e8d2954499f83269302d23b58f8832c31e07ef7>具体源码改动</a>。</p><h1 id=自定义>自定义<a hidden class=anchor aria-hidden=true href=#自定义>#</a></h1><p><code>自定义注解</code>：不满足于默认DS注解，希望自定义注解。</p><p><code>自定义数据源来源</code>：默认的数据源来源是基于yml或者properties配置来的，组件支持同时从多个地方来加载初始化数据源。常用于多租户系统，从一个租户信息库多加载不同租户的数据源。</p><p><code>自定义负载均衡策略</code>：常用的有轮询，随机。支持扩展。</p><p><code>自定义切面</code>：支持不使用注解，通过配置来切换数据源。如某个包下所有service方法以<code>select*</code>开头的都走slave库，以<code>add*</code>开头的都走master库。</p><h2 id=自定义注解>自定义注解<a hidden class=anchor aria-hidden=true href=#自定义注解>#</a></h2><h3 id=基础介绍-7>基础介绍<a hidden class=anchor aria-hidden=true href=#基础介绍-7>#</a></h3><p>如果你只有几个确定的库，可以尝试自定义注解替换掉<code>@DS</code>。</p><p>建议从3.2.1版本开始使用自定义注解，另外组件自带了<code>@Master</code>和<code>@Slave</code>注解。</p><h3 id=使用方法-1>使用方法<a hidden class=anchor aria-hidden=true href=#使用方法-1>#</a></h3><p>下面我们自定义一个产品库的注解，方便我们后面程序的使用。</p><p>1、需要自己定义一个注解并继承自DS</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>com.baomidou.dynamic.datasource.annotation.DS</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.annotation.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Target</span><span class=p>({</span><span class=n>ElementType</span><span class=p>.</span><span class=na>TYPE</span><span class=p>,</span><span class=w> </span><span class=n>ElementType</span><span class=p>.</span><span class=na>METHOD</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Retention</span><span class=p>(</span><span class=n>RetentionPolicy</span><span class=p>.</span><span class=na>RUNTIME</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Documented</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;product&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=nd>@interface</span><span class=w> </span><span class=n>Product</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>2、注解在需要切换数据源的方法上或类上</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Product</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ProductServiceImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>ProductService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Product</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=w> </span><span class=nf>selectAll</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w>  </span><span class=n>jdbcTemplate</span><span class=p>.</span><span class=na>queryForList</span><span class=p>(</span><span class=s>&#34;select * from products&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=自定义数据源来源>自定义数据源来源<a hidden class=anchor aria-hidden=true href=#自定义数据源来源>#</a></h2><h3 id=基础介绍-8>基础介绍<a hidden class=anchor aria-hidden=true href=#基础介绍-8>#</a></h3><p>数据源来源的默认实现是<code>YmlDynamicDataSourceProvider</code>，其从yaml或properties中读取信息并解析出所有数据源信息。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>DynamicDataSourceProvider</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 加载所有数据源
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @return 所有数据源，key为数据源名称
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>DataSource</span><span class=o>&gt;</span><span class=w> </span><span class=nf>loadDataSources</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=自定义示例>自定义示例<a hidden class=anchor aria-hidden=true href=#自定义示例>#</a></h3><p>可以参考 <code>AbstractJdbcDataSourceProvider</code> （仅供参考）来实现从JDBC数据库中获取数据库连接信息。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>DynamicDataSourceProvider</span><span class=w> </span><span class=nf>jdbcDynamicDataSourceProvider</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AbstractJdbcDataSourceProvider</span><span class=p>(</span><span class=s>&#34;com.mysql.cj.jdbc.Driver&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;jdbc:mysql://xx.xx.xx.xx:3306/dynamic&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;root&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;root&#34;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>protected</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>DataSourceProperty</span><span class=o>&gt;</span><span class=w> </span><span class=nf>executeStmt</span><span class=p>(</span><span class=n>Statement</span><span class=w> </span><span class=n>statement</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>SQLException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ResultSet</span><span class=w> </span><span class=n>rs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>statement</span><span class=p>.</span><span class=na>executeQuery</span><span class=p>(</span><span class=s>&#34;select * from DB&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>rs</span><span class=p>.</span><span class=na>next</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rs</span><span class=p>.</span><span class=na>getString</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rs</span><span class=p>.</span><span class=na>getString</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>password</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rs</span><span class=p>.</span><span class=na>getString</span><span class=p>(</span><span class=s>&#34;password&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>url</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rs</span><span class=p>.</span><span class=na>getString</span><span class=p>(</span><span class=s>&#34;url&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>driver</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rs</span><span class=p>.</span><span class=na>getString</span><span class=p>(</span><span class=s>&#34;driver&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>DataSourceProperty</span><span class=w> </span><span class=n>property</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataSourceProperty</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>property</span><span class=p>.</span><span class=na>setUsername</span><span class=p>(</span><span class=n>username</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>property</span><span class=p>.</span><span class=na>setPassword</span><span class=p>(</span><span class=n>password</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>property</span><span class=p>.</span><span class=na>setUrl</span><span class=p>(</span><span class=n>url</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>property</span><span class=p>.</span><span class=na>setDriverClassName</span><span class=p>(</span><span class=n>driver</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>property</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>map</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><blockquote><p>PS: 从3.4.0开始，可以注入多个DynamicDataSourceProvider的Bean以实现同时从多个不同来源加载数据源，注意同名会被覆盖。</p></blockquote><h2 id=自定义负载均衡策略>自定义负载均衡策略<a hidden class=anchor aria-hidden=true href=#自定义负载均衡策略>#</a></h2><h3 id=基础介绍-9>基础介绍<a hidden class=anchor aria-hidden=true href=#基础介绍-9>#</a></h3><p>如下<code>slave</code>组下有三个数据源，当用户使用<code>slave</code>切换数据源时会使用负载均衡算法。</p><p>系统自带了两个负载均衡算法:</p><ul><li><code>LoadBalanceDynamicDataSourceStrategy</code> 轮询,是默认的。</li><li><code>RandomDynamicDataSourceStrategy</code> 随机的。</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dynamic</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>master</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://xx.xx.xx.xx:3306/dynamic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>schema</span><span class=p>:</span><span class=w> </span><span class=l>db/schema.sql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>slave_1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://xx.xx.xx.xx:3307/dynamic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>slave_2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://xx.xx.xx.xx:3308/dynamic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>slave_3</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://xx.xx.xx.xx:3309/dynamic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>strategy</span><span class=p>:</span><span class=w> </span><span class=l>com.baomidou.dynamic.datasource.strategy.LoadBalanceDynamicDataSourceStrategy</span><span class=w>
</span></span></span></code></pre></div><h3 id=如何自定义>如何自定义<a hidden class=anchor aria-hidden=true href=#如何自定义>#</a></h3><p>如果默认的两个都不能满足要求，可以参考源码自定义，暂时只能全局更改。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.util.List</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.ThreadLocalRandom</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>javax.sql.DataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>RandomDynamicDataSourceStrategy</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>DynamicDataSourceStrategy</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>RandomDynamicDataSourceStrategy</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=nf>determineDataSource</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>DataSource</span><span class=o>&gt;</span><span class=w> </span><span class=n>dataSources</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>DataSource</span><span class=p>)</span><span class=n>dataSources</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>ThreadLocalRandom</span><span class=p>.</span><span class=na>current</span><span class=p>().</span><span class=na>nextInt</span><span class=p>(</span><span class=n>dataSources</span><span class=p>.</span><span class=na>size</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h1 id=无注解方案>无注解方案<a hidden class=anchor aria-hidden=true href=#无注解方案>#</a></h1><p>不管是出于注解侵入性还是代码整洁等理由，我们都有需求不想使用注解的需求。</p><p>但是需要理解多数据源实现的核心。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DynamicRoutingDataSource</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=nf>determineDataSource</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 这里是核心，是从ThreadLocal中获取当前数据源。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>dsKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DynamicDataSourceContextHolder</span><span class=p>.</span><span class=na>peek</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>getDataSource</span><span class=p>(</span><span class=n>dsKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>所以我们就可以根据需求，选择合适的时机调用<code>DynamicDataSourceContextHolder.push("对应数据源")</code>。</p><p>默认的<code>@DS</code>注解来切换数据源是根据spring AOP的特性，在方法开启前设置数据源KEY，方法执行完成后移除对应数据源KEY。</p><h2 id=filter切换数据源>filter切换数据源<a hidden class=anchor aria-hidden=true href=#filter切换数据源>#</a></h2><p>目标：拦截以filter/**开头的所有请求，如果后面的方法以a开头就切换到db1，以b开头就切换到db2，其余使用默认数据源。</p><p>实现如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@WebFilter</span><span class=p>(</span><span class=n>filterName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;dsFilter&#34;</span><span class=p>,</span><span class=w> </span><span class=n>urlPatterns</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=s>&#34;/filter/*&#34;</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DynamicDatasourceFilter</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Filter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>init</span><span class=p>(</span><span class=n>FilterConfig</span><span class=w> </span><span class=n>filterConfig</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>ServletException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;loading filter {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>filterConfig</span><span class=p>.</span><span class=na>getFilterName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doFilter</span><span class=p>(</span><span class=n>ServletRequest</span><span class=w> </span><span class=n>servletRequest</span><span class=p>,</span><span class=w> </span><span class=n>ServletResponse</span><span class=w> </span><span class=n>servletResponse</span><span class=p>,</span><span class=w> </span><span class=n>FilterChain</span><span class=w> </span><span class=n>filterChain</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=p>,</span><span class=w> </span><span class=n>ServletException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=p>)</span><span class=w> </span><span class=n>servletRequest</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>HttpServletResponse</span><span class=p>)</span><span class=w> </span><span class=n>servletResponse</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>requestURI</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getRequestURI</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;经过多数据源filter,当前路径是{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>requestURI</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        String headerDs = request.getHeader(&#34;ds&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        Object sessionDs = request.getSession().getAttribute(&#34;ds&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>requestURI</span><span class=p>.</span><span class=na>replaceFirst</span><span class=p>(</span><span class=s>&#34;/filter/&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>dsKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;master&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>s</span><span class=p>.</span><span class=na>startsWith</span><span class=p>(</span><span class=s>&#34;a&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>dsKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;db1&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>s</span><span class=p>.</span><span class=na>startsWith</span><span class=p>(</span><span class=s>&#34;b&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>dsKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;db2&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 执行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>DynamicDataSourceContextHolder</span><span class=p>.</span><span class=na>push</span><span class=p>(</span><span class=n>dsKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>filterChain</span><span class=p>.</span><span class=na>doFilter</span><span class=p>(</span><span class=n>servletRequest</span><span class=p>,</span><span class=w> </span><span class=n>servletResponse</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>DynamicDataSourceContextHolder</span><span class=p>.</span><span class=na>poll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>destroy</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@SpringBootApplication</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@ServletComponentScan</span><span class=w> </span><span class=c1>// filter必须使用这个</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@MapperScan</span><span class=p>(</span><span class=s>&#34;com.baomidou.samples.ds.mapper&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AllDataSourceApplication</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SpringApplication</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>AllDataSourceApplication</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>args</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><blockquote><p>扩展：从request中还能获取到很多东西，如header和session，同理可以根据自己业务需求根据header值和session里对应的用户来动态设置和切换数据源。</p></blockquote><h2 id=intercepror切换数据源>intercepror切换数据源<a hidden class=anchor aria-hidden=true href=#intercepror切换数据源>#</a></h2><p>目标：拦截以interceptor/**开头的所有请求，如果后面的方法以a开头就切换到db1，以b开头就切换到db2，其余使用默认数据源。</p><p>实现如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>com.baomidou.dynamic.datasource.toolkit.DynamicDataSourceContextHolder</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.extern.slf4j.Slf4j</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.web.servlet.HandlerInterceptor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.web.servlet.ModelAndView</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>javax.servlet.http.HttpServletRequest</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>javax.servlet.http.HttpServletResponse</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DynamicDatasourceInterceptor</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>HandlerInterceptor</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 在请求处理之前进行调用（Controller方法调用之前）
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>preHandle</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>handler</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>requestURI</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getRequestURI</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;经过多数据源Interceptor,当前路径是{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>requestURI</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        String headerDs = request.getHeader(&#34;ds&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        Object sessionDs = request.getSession().getAttribute(&#34;ds&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>requestURI</span><span class=p>.</span><span class=na>replaceFirst</span><span class=p>(</span><span class=s>&#34;/interceptor/&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>dsKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;master&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>s</span><span class=p>.</span><span class=na>startsWith</span><span class=p>(</span><span class=s>&#34;a&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>dsKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;db1&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>s</span><span class=p>.</span><span class=na>startsWith</span><span class=p>(</span><span class=s>&#34;b&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>dsKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;db2&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DynamicDataSourceContextHolder</span><span class=p>.</span><span class=na>push</span><span class=p>(</span><span class=n>dsKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 请求处理之后进行调用，但是在视图被渲染之前（Controller方法调用之后）
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>postHandle</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>handler</span><span class=p>,</span><span class=w> </span><span class=n>ModelAndView</span><span class=w> </span><span class=n>modelAndView</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 在整个请求结束之后被调用，也就是在DispatcherServlet渲染了对应的视图之后执行（主要是用于进行资源清理工作）
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>afterCompletion</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>handler</span><span class=p>,</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DynamicDataSourceContextHolder</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.context.annotation.Configuration</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.web.servlet.config.annotation.InterceptorRegistry</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.web.servlet.config.annotation.WebMvcConfigurer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MyWebAutoConfig</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>WebMvcConfigurer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>addInterceptors</span><span class=p>(</span><span class=n>InterceptorRegistry</span><span class=w> </span><span class=n>registry</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>registry</span><span class=p>.</span><span class=na>addInterceptor</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>DynamicDatasourceInterceptor</span><span class=p>()).</span><span class=na>addPathPatterns</span><span class=p>(</span><span class=s>&#34;/interceptor/**&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=自定义切面>自定义切面<a hidden class=anchor aria-hidden=true href=#自定义切面>#</a></h2><p>从3.4.0开始支持自定义切面。</p><ol><li>使用这个方式，原注解方式并不会失效。</li><li>注意：不要在同一个切面同时使用注解又使用自定义切面。</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MyConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>DynamicDatasourceNamedInterceptor</span><span class=w> </span><span class=nf>dsAdvice</span><span class=p>(</span><span class=n>DsProcessor</span><span class=w> </span><span class=n>dsProcessor</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DynamicDatasourceNamedInterceptor</span><span class=w> </span><span class=n>interceptor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DynamicDatasourceNamedInterceptor</span><span class=p>(</span><span class=n>dsProcessor</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>patternMap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>patternMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;select*&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;slave&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>patternMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;add*&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;master&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>patternMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;update*&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;master&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>patternMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;delete*&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;master&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>interceptor</span><span class=p>.</span><span class=na>addPatternMap</span><span class=p>(</span><span class=n>patternMap</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>interceptor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Advisor</span><span class=w> </span><span class=nf>dsAdviceAdvisor</span><span class=p>(</span><span class=n>DynamicDatasourceNamedInterceptor</span><span class=w> </span><span class=n>dsAdvice</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AspectJExpressionPointcut</span><span class=w> </span><span class=n>pointcut</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AspectJExpressionPointcut</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>pointcut</span><span class=p>.</span><span class=na>setExpression</span><span class=p>(</span><span class=s>&#34;execution (* com.baomidou.samples.pattern..service.*.*(..))&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DefaultPointcutAdvisor</span><span class=p>(</span><span class=n>pointcut</span><span class=p>,</span><span class=w> </span><span class=n>dsAdvice</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>以上实现com.baomidou.samples.pattern包service下所有类的add/update/delete开头的方法使用master数据源，select使用slave数据源。</p><p>更复杂的切点表达式语法需自行学习。</p><h2 id=mybatis下读写分离>mybatis下读写分离<a hidden class=anchor aria-hidden=true href=#mybatis下读写分离>#</a></h2><p>场景：</p><ol><li>在纯的读写分离环境，写操作全部是master，读操作全部是slave。</li><li>不想通过注解配置完成以上功能。</li></ol><p>答：在mybatis环境下可以基于mybatis插件结合dynamic-datasource完成以上功能。</p><p>手动注入插件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>MasterSlaveAutoRoutingPlugin</span><span class=w> </span><span class=nf>masterSlaveAutoRoutingPlugin</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MasterSlaveAutoRoutingPlugin</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>默认主库名称master，从库名称slave。</p><p>暂不支持更多，源码简单可参考重写。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Intercepts</span><span class=p>({</span><span class=nd>@Signature</span><span class=p>(</span><span class=n>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executor</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;query&#34;</span><span class=p>,</span><span class=w> </span><span class=n>args</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=n>MappedStatement</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>RowBounds</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>ResultHandler</span><span class=p>.</span><span class=na>class</span><span class=p>}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Signature</span><span class=p>(</span><span class=n>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executor</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;update&#34;</span><span class=p>,</span><span class=w> </span><span class=n>args</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=n>MappedStatement</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=p>.</span><span class=na>class</span><span class=p>})})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MasterSlaveAutoRoutingPlugin</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Interceptor</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>MASTER</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;master&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>SLAVE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;slave&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>intercept</span><span class=p>(</span><span class=n>Invocation</span><span class=w> </span><span class=n>invocation</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>invocation</span><span class=p>.</span><span class=na>getArgs</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>MappedStatement</span><span class=w> </span><span class=n>ms</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>MappedStatement</span><span class=p>)</span><span class=w> </span><span class=n>args</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>DynamicDataSourceContextHolder</span><span class=p>.</span><span class=na>push</span><span class=p>(</span><span class=n>SqlCommandType</span><span class=p>.</span><span class=na>SELECT</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>ms</span><span class=p>.</span><span class=na>getSqlCommandType</span><span class=p>()</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>SLAVE</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>MASTER</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>invocation</span><span class=p>.</span><span class=na>proceed</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>DynamicDataSourceContextHolder</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>plugin</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>target</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>target</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>Executor</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>Plugin</span><span class=p>.</span><span class=na>wrap</span><span class=p>(</span><span class=n>target</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>target</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setProperties</span><span class=p>(</span><span class=n>Properties</span><span class=w> </span><span class=n>properties</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h1 id=事务专栏>事务专栏<a hidden class=anchor aria-hidden=true href=#事务专栏>#</a></h1><p>使用多数据源的你一定会遇到事务问题：</p><ol><li>为什么使用了事务就切换不了数据源了啊？</li><li>有没有什么解决方案啊？</li><li>有没有使用案例和注意事项啊。</li></ol><p>以上问题都能在本章节得到解答。</p><p>方案一：dynamic-datasource集成了alibaba分布式事务组件seata。</p><p>方案二：dynamic-datasource提供了无需外部组件的本地多数据源事务。</p><p>各有各的优劣，总有一款适合你。</p><h2 id=事务概念>事务概念<a hidden class=anchor aria-hidden=true href=#事务概念>#</a></h2><h3 id=什么是事务>什么是事务？<a hidden class=anchor aria-hidden=true href=#什么是事务>#</a></h3><p><code>事务</code>：是数据库操作的最小工作单元，是作为单个逻辑工作单元执行的一系列操作；这些操作作为一个整体一起向系统提交，要么都执行、要么都不执行；事务是一组不可再分割的操作集合（工作逻辑单元）。</p><p><strong>事务的四大特性：</strong></p><ul><li>原子性</li></ul><p>事务是数据库的逻辑工作单位，事务中包含的各操作要么都做，要么都不做 。</p><ul><li>一致性</li></ul><p>事务执行的结果必须是使数据库从一个一致性状态变到另一个一致性状态。因此当数据库只包含成功事务提交的结果时，就说数据库处于一致性状态。如果数据库系统 运行中发生故障，有些事务尚未完成就被迫中断，这些未完成事务对数据库所做的修改有一部分已写入物理数据库，这时数据库就处于一种不正确的状态，或者说是 不一致的状态。</p><ul><li>隔离性</li></ul><p>一个事务的执行不能其它事务干扰。即一个事务内部的操作及使用的数据对其它并发事务是隔离的，并发执行的各个事务之间不能互相干扰。</p><ul><li>持续性</li></ul><p>也称永久性，指一个事务一旦提交，它对数据库中的数据的改变就应该是永久性的。接下来的其它操作或故障不应该对其执行结果有任何影响。</p><h3 id=原生jdbc处理事务>原生JDBC处理事务<a hidden class=anchor aria-hidden=true href=#原生jdbc处理事务>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>connection</span><span class=p>.</span><span class=na>setAutoCommit</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 这里用connection对数据库做了一系列操作，CRUD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>connection</span><span class=p>.</span><span class=na>commit</span><span class=p>();</span><span class=w> </span><span class=c1>// 没有异常就提交</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>ex</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>connection</span><span class=p>.</span><span class=na>rollback</span><span class=p>();</span><span class=w>  </span><span class=c1>// 异常回滚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>connection</span><span class=p>.</span><span class=na>setAutoCommit</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>以上是事务的核心，所有操作要一起成功，只要出错就回滚。</p><h3 id=spring处理事务>Spring处理事务<a hidden class=anchor aria-hidden=true href=#spring处理事务>#</a></h3><p>spring开启事务很简单，在需要事务的方法和类上添加<code>@Transactional</code>注解。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Transactional</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>Aservice</span><span class=p>.</span><span class=na>dosometing</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>Bservice</span><span class=p>.</span><span class=na>dosometing</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>使用了<code>@Transactional</code>，<code>spring会保证整个事务下都复用同一个connection</code>。</p><p>在默认配置下，只要事务中发生<code>RuntimeException</code>，就会回滚。</p><h2 id=基础知识>基础知识<a hidden class=anchor aria-hidden=true href=#基础知识>#</a></h2><p>问：使用了事务如@Transational无法切换数据源？</p><p>答： 是的，本组件是基于springAop的方案来进行多数据源的管理和切换的，要想保证多个库的整体事务则需要分布式事务。</p><p>问：为什么使用了事务如@Transational就无法切换数据源？</p><p>答：开启了事务后，spring事务管理器会保证在事务下整个线程后续拿到的都是同一个connection。</p><p>问：事务下无法切换数据源我知道了，那我单库的事务的可以用吗？</p><p>答：完全可以的。只要事务下不切换数据源就OK。</p><p>问：我的业务必须要保证事务，还有什么解决办法？</p><p>方案一：seata就是解决此问题，本组件已完成和seata的自动集成。</p><p>方案二：本组件从3.3.0开始支持本地多数据源事务，无需第三方。</p><h2 id=本地事务>本地事务<a hidden class=anchor aria-hidden=true href=#本地事务>#</a></h2><h3 id=背景>背景<a hidden class=anchor aria-hidden=true href=#背景>#</a></h3><p>多数据源事务方案一直是一个难题，通常的解决方案有以下二种。</p><ol><li><p>利用atomiks手动构建多数据源事务，适合数据源较少，配置的参数也不太多,性能要求不高的项目。难点就是手动配置量大，需要耗费一定时间。</p></li><li><p>用seata类似的分布式事务解决方案，难点就是需要搭建维护如seata-server的统一管理中心。
每一种方案都有其适用场景。你可能遇到最多的问题就是：</p></li><li><p>为什么我加了事务注解，切换数据源失败？</p></li><li><p>我了解涉及了分布式事务了，但我不想用seata，我场景简单，有没有不依赖第三方的方案？</p></li></ol><h3 id=基础介绍-10>基础介绍<a hidden class=anchor aria-hidden=true href=#基础介绍-10>#</a></h3><p>自从3.3.0开始，由seata的核心贡献者 <a href=https://github.com/a364176773>https://github.com/a364176773</a> 贡献了基于connection代理的方案。</p><p>建议从3.4.0版本开始使用，其修复了一个功能，老版本不加<code>@DS</code>只加<code>@DSTransactional</code>会报错。</p><h3 id=注意事项-1>注意事项<a hidden class=anchor aria-hidden=true href=#注意事项-1>#</a></h3><p>本地事务实现很简单，就是循环提交，发生错误，循环回滚。</p><p>我们默认的前提是数据库本身不会异常，比如宕机。</p><p>如数据在回滚的过程突然宕机，本地事务就会有问题。如果你需要完整分布式方案请使用seata方案。</p><ol><li>不支持spring原生事务，不支持spring事务，不支持spring事务，可分别使用，<code>千万不能混用</code>。</li><li>再次强调不支持spring事务注解，可理解成独立写了一套事务方案。</li><li>只适合简单本地多数据源场景， 如果涉及异步和微服务等完整事务场景，请使用seata方案。</li><li>暂时不支持更多配置，如只读，如spring的传播特性。 后续会根据反馈考虑支持。</li></ol><h3 id=使用方法-2>使用方法<a hidden class=anchor aria-hidden=true href=#使用方法-2>#</a></h3><p>在最外层的方法添加 <code>@DSTransactional</code>，底下调用的各个类该切数据源就正常使用<code>DS</code>切换数据源即可，就是这么简单。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 如AService调用BService和CService的方法，A,B,C分别对应不同数据源。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;a&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>// 如果a是默认数据源则不需要DS注解。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DSTransactional</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>dosomething</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BService</span><span class=p>.</span><span class=na>dosomething</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CService</span><span class=p>.</span><span class=na>dosomething</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>BService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;b&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>dosomething</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// dosomething</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;c&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>dosomething</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// dosomething</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>只要<code>@DSTransactional</code>注解下任一环节发生异常，则全局多数据源事务回滚。</p><p>如果BC上也有<code>@DSTransactional</code>会有影响吗？答：没有影响的。</p><h3 id=示例项目-3>示例项目<a hidden class=anchor aria-hidden=true href=#示例项目-3>#</a></h3><p><a href=https://github.com/dynamic-datasource/dynamic-datasource-samples/tree/master/tx-samples/tx-local-sample>点我跳转</a></p><p>完整示例项目，数据库都已准备好，可以直接运行测试。</p><p>示例项目A,B,C分别对应OrderService,ProductService，AccountService，分别是独立的数据库。</p><p>用户下单分别调用产品库扣库存，账户库扣余额。</p><p>如果库存不足，或用户余额不足都抛出RuntimeException，触发整体回滚。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@AllArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>OrderService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>OrderMapper</span><span class=w> </span><span class=n>orderMapper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>AccountService</span><span class=w> </span><span class=n>accountService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ProductService</span><span class=w> </span><span class=n>productService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// @DS(&#34;order&#34;) 这里不需要，因为order是默认库，如果开启事务的不是默认库则必须加</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DSTransactional</span><span class=w> </span><span class=c1>// 注意这里开启事务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>placeOrder</span><span class=p>(</span><span class=n>PlaceOrderRequest</span><span class=w> </span><span class=n>request</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;=============ORDER START=================&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getUserId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Long</span><span class=w> </span><span class=n>productId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getProductId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Integer</span><span class=w> </span><span class=n>amount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getAmount</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;收到下单请求,用户:{}, 商品:{},数量:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>productId</span><span class=p>,</span><span class=w> </span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;当前 XID: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>TransactionContext</span><span class=p>.</span><span class=na>getXID</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Order</span><span class=w> </span><span class=n>order</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Order</span><span class=p>.</span><span class=na>builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>userId</span><span class=p>(</span><span class=n>userId</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>productId</span><span class=p>(</span><span class=n>productId</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>status</span><span class=p>(</span><span class=n>OrderStatus</span><span class=p>.</span><span class=na>INIT</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>amount</span><span class=p>(</span><span class=n>amount</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>insert</span><span class=p>(</span><span class=n>order</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;订单一阶段生成，等待扣库存付款中&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 扣减库存并计算总价</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Double</span><span class=w> </span><span class=n>totalPrice</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>productService</span><span class=p>.</span><span class=na>reduceStock</span><span class=p>(</span><span class=n>productId</span><span class=p>,</span><span class=w> </span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 扣减余额</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>accountService</span><span class=p>.</span><span class=na>reduceBalance</span><span class=p>(</span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>totalPrice</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>order</span><span class=p>.</span><span class=na>setStatus</span><span class=p>(</span><span class=n>OrderStatus</span><span class=p>.</span><span class=na>SUCCESS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>order</span><span class=p>.</span><span class=na>setTotalPrice</span><span class=p>(</span><span class=n>totalPrice</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>updateById</span><span class=p>(</span><span class=n>order</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;订单已成功下单&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;=============ORDER END=================&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RequiredArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ProductService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ProductMapper</span><span class=w> </span><span class=n>productMapper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;product&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Double</span><span class=w> </span><span class=nf>reduceStock</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>productId</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;=============PRODUCT START=================&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;当前 XID: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>TransactionContext</span><span class=p>.</span><span class=na>getXID</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 检查库存</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Product</span><span class=w> </span><span class=n>product</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>productMapper</span><span class=p>.</span><span class=na>selectById</span><span class=p>(</span><span class=n>productId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Assert</span><span class=p>.</span><span class=na>notNull</span><span class=p>(</span><span class=n>product</span><span class=p>,</span><span class=w> </span><span class=s>&#34;商品不存在&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Integer</span><span class=w> </span><span class=n>stock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>product</span><span class=p>.</span><span class=na>getStock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;商品编号为 {} 的库存为{},订单商品数量为{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>productId</span><span class=p>,</span><span class=w> </span><span class=n>stock</span><span class=p>,</span><span class=w> </span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>stock</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&#34;商品编号为{} 库存不足，当前库存:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>productId</span><span class=p>,</span><span class=w> </span><span class=n>stock</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=s>&#34;库存不足&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;开始扣减商品编号为 {} 库存,单价商品价格为{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>productId</span><span class=p>,</span><span class=w> </span><span class=n>product</span><span class=p>.</span><span class=na>getPrice</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 扣减库存</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>currentStock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>stock</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>amount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>product</span><span class=p>.</span><span class=na>setStock</span><span class=p>(</span><span class=n>currentStock</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>productMapper</span><span class=p>.</span><span class=na>updateById</span><span class=p>(</span><span class=n>product</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>double</span><span class=w> </span><span class=n>totalPrice</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>product</span><span class=p>.</span><span class=na>getPrice</span><span class=p>()</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>amount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;扣减商品编号为 {} 库存成功,扣减后库存为{}, {} 件商品总价为 {} &#34;</span><span class=p>,</span><span class=w> </span><span class=n>productId</span><span class=p>,</span><span class=w> </span><span class=n>currentStock</span><span class=p>,</span><span class=w> </span><span class=n>amount</span><span class=p>,</span><span class=w> </span><span class=n>totalPrice</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;=============PRODUCT END=================&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>totalPrice</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RequiredArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AccountService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>AccountMapper</span><span class=w> </span><span class=n>accountMapper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;account&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>reduceBalance</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>Double</span><span class=w> </span><span class=n>price</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;=============ACCOUNT START=================&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;当前 XID: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>TransactionContext</span><span class=p>.</span><span class=na>getXID</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Account</span><span class=w> </span><span class=n>account</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>accountMapper</span><span class=p>.</span><span class=na>selectById</span><span class=p>(</span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Assert</span><span class=p>.</span><span class=na>notNull</span><span class=p>(</span><span class=n>account</span><span class=p>,</span><span class=w> </span><span class=s>&#34;用户不存在&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Double</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>account</span><span class=p>.</span><span class=na>getBalance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;下单用户{}余额为 {},商品总价为{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>balance</span><span class=p>,</span><span class=w> </span><span class=n>price</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>balance</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>price</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&#34;用户 {} 余额不足，当前余额:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>balance</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=s>&#34;余额不足&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;开始扣减用户 {} 余额&#34;</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>double</span><span class=w> </span><span class=n>currentBalance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>account</span><span class=p>.</span><span class=na>getBalance</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>price</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>account</span><span class=p>.</span><span class=na>setBalance</span><span class=p>(</span><span class=n>currentBalance</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>accountMapper</span><span class=p>.</span><span class=na>updateById</span><span class=p>(</span><span class=n>account</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;扣减用户 {} 余额成功,扣减后用户账户余额为{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>currentBalance</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;=============ACCOUNT END=================&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=原理介绍>原理介绍<a hidden class=anchor aria-hidden=true href=#原理介绍>#</a></h3><p><a href=https://github.com/baomidou/dynamic-datasource-spring-boot-starter/commit/f0cbad193528296eeb64faa76c79743afbdd811d>点我跳转</a></p><p>核心原理就是代理connection，并根据不同数据库获取到一个connection放入ConnectionFactory。</p><p>如果成功了整体提交，失败了整体回滚。</p><h2 id=seata事务>seata事务<a hidden class=anchor aria-hidden=true href=#seata事务>#</a></h2><h3 id=基础介绍-11>基础介绍<a hidden class=anchor aria-hidden=true href=#基础介绍-11>#</a></h3><p>seata Github地址：<a href=https://github.com/apache/incubator-seata>点我跳转</a></p><p>seata 文档：<a href=https://seata.io/zh-cn/docs/overview/what-is-seata.html>点我跳转</a></p><p>seata 示例：<a href=https://github.com/apache/incubator-seata-samples>点我跳转</a></p><blockquote><p>PS：一般需要分布式事务的场景大多数都是微服务化，个人并不建议在单体项目引入多数据源+分布式事务，有能力尽早拆开，可为过度方案。</p></blockquote><h3 id=注意事项-2>注意事项<a hidden class=anchor aria-hidden=true href=#注意事项-2>#</a></h3><p><code>dynamic-datasource-sring-boot-starter</code> 组件内部开启seata后会自动使用DataSourceProxy来包装DataSource，所以需要以下方式来保持兼容。</p><p>1、如果你引入的是seata-all,请不要使用@EnableAutoDataSourceProxy注解。</p><p>2、如果你引入的是seata-spring-boot-starter 请关闭自动代理。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>seata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enable-auto-data-source-proxy</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span></code></pre></div><h3 id=示例项目-4>示例项目<a hidden class=anchor aria-hidden=true href=#示例项目-4>#</a></h3><p><a href=https://github.com/dynamic-datasource/dynamic-datasource-samples/tree/master/tx-samples/tx-seata-sample>点我跳转</a></p><p>此工程为 多数据源+druid+seata+mybatisPlus的版本。</p><p>模拟用户下单，扣商品库存，扣用户余额，初步可分为订单服务+商品服务+用户服务。</p><h3 id=环境准备>环境准备<a hidden class=anchor aria-hidden=true href=#环境准备>#</a></h3><p>为了快速演示相关环境都采用docker部署，生产上线请参考seata官方文档使用。</p><p>1、准备seata-server。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run --name seata-server -p 8091:8091 -d seataio/seata-server
</span></span></code></pre></div><p>2、准备mysql数据库，账户root密码123456。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run --name mysql -p 3306:3306 -e <span class=nv>MYSQL_ROOT_PASSWORD</span><span class=o>=</span><span class=m>123456</span> -d mysql:5.7
</span></span></code></pre></div><p>3、创建相关数据库。</p><p>创建 <code>seata-order</code> <code>seata-product</code> <code>seata-account</code> 模拟连接不同的数据库。</p><pre tabindex=0><code>CREATE DATABASE IF NOT EXIST seata-order;
CREATE DATABASE IF NOT EXIST seata-product;
CREATE DATABASE IF NOT EXIST seata-account;
</code></pre><p>4、准备相关数据库脚本。</p><p>每个数据库下脚本相关的表，seata需要undo_log来监测和回滚。</p><p>相关的seata脚本可到seata官方获取，另外配合多数据源的自动执行脚本功能，应用启动后会自动执行。</p><h3 id=工程准备>工程准备<a hidden class=anchor aria-hidden=true href=#工程准备>#</a></h3><p>1、引入相关依赖，seata+druid+MybatisPlus+dynamic-datasource+mysql+lombok。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>io.seata<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>seata-spring-boot-starter<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>1.4.2<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>com.baomidou<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>dynamic-datasource-spring-boot-starter<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>3.4.0<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl># 省略，查看示例项目
</span></span></code></pre></div><p>2、编写相关yaml配置。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>application</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dynamic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dynamic</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>primary</span><span class=p>:</span><span class=w> </span><span class=l>order</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>strict</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>seata</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>    </span><span class=c># 开启seata代理，开启后默认每个数据源都代理，如果某个不需要代理可单独关闭</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>seata-mode</span><span class=p>:</span><span class=w> </span><span class=l>AT</span><span class=w> </span><span class=c># 支持XA及AT模式,默认AT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>order</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://192.168.56.101:3306/seata_order?useUnicode=true&amp;characterEncoding=utf8&amp;allowMultiQueries=true&amp;useSSL=false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>schema</span><span class=p>:</span><span class=w> </span><span class=l>classpath:db/schema-order.sql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>account</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://192.168.56.101:3306/seata_account?useUnicode=true&amp;characterEncoding=utf8&amp;allowMultiQueries=true&amp;useSSL=false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>schema</span><span class=p>:</span><span class=w> </span><span class=l>classpath:db/schema-account.sql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>product</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://192.168.56.101:3306/seata_product?useUnicode=true&amp;characterEncoding=utf8&amp;allowMultiQueries=true&amp;useSSL=false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>schema</span><span class=p>:</span><span class=w> </span><span class=l>classpath:db/schema-product.sql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>test</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>lijing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:h2:mem:test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>org.h2.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>seata</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=c># 这个数据源不需要seata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>seata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>application-id</span><span class=p>:</span><span class=w> </span><span class=l>applicationName</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tx-service-group</span><span class=p>:</span><span class=w> </span><span class=l>my_test_tx_group</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enable-auto-data-source-proxy</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>   </span><span class=c>#一定要是false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vgroup-mapping</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>my_test_tx_group</span><span class=p>:</span><span class=w> </span><span class=l>default </span><span class=w> </span><span class=c># key与上面的tx-service-group的值对应</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>grouplist</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>default</span><span class=p>:</span><span class=w> </span><span class=m>192.168.56.101</span><span class=p>:</span><span class=m>8091</span><span class=w> </span><span class=c># seata-server地址仅file注册中心需要</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>file</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>registry</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>file</span><span class=w>
</span></span></span></code></pre></div><h3 id=代码编写>代码编写<a hidden class=anchor aria-hidden=true href=#代码编写>#</a></h3><p>参考工程下面的代码完成controller,service,maaper,entity,dto等。</p><p>订单服务</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>OrderServiceImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>OrderService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=n>OrderDao</span><span class=w> </span><span class=n>orderDao</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=n>AccountService</span><span class=w> </span><span class=n>accountService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=n>ProductService</span><span class=w> </span><span class=n>productService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;order&#34;</span><span class=p>)</span><span class=c1>// 每一层都需要使用多数据源注解切换所选择的数据库</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Transactional</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@GlobalTransactional</span><span class=w> </span><span class=c1>// 重点 第一个开启事务的需要添加seata全局事务注解</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>placeOrder</span><span class=p>(</span><span class=n>PlaceOrderRequest</span><span class=w> </span><span class=n>request</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;=============ORDER START=================&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getUserId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Long</span><span class=w> </span><span class=n>productId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getProductId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Integer</span><span class=w> </span><span class=n>amount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getAmount</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;收到下单请求,用户:{}, 商品:{},数量:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>productId</span><span class=p>,</span><span class=w> </span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;当前 XID: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>RootContext</span><span class=p>.</span><span class=na>getXID</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Order</span><span class=w> </span><span class=n>order</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Order</span><span class=p>.</span><span class=na>builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>userId</span><span class=p>(</span><span class=n>userId</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>productId</span><span class=p>(</span><span class=n>productId</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>status</span><span class=p>(</span><span class=n>OrderStatus</span><span class=p>.</span><span class=na>INIT</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>amount</span><span class=p>(</span><span class=n>amount</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>orderDao</span><span class=p>.</span><span class=na>insert</span><span class=p>(</span><span class=n>order</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;订单一阶段生成，等待扣库存付款中&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 扣减库存并计算总价</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Double</span><span class=w> </span><span class=n>totalPrice</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>productService</span><span class=p>.</span><span class=na>reduceStock</span><span class=p>(</span><span class=n>productId</span><span class=p>,</span><span class=w> </span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 扣减余额</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>accountService</span><span class=p>.</span><span class=na>reduceBalance</span><span class=p>(</span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>totalPrice</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>order</span><span class=p>.</span><span class=na>setStatus</span><span class=p>(</span><span class=n>OrderStatus</span><span class=p>.</span><span class=na>SUCCESS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>order</span><span class=p>.</span><span class=na>setTotalPrice</span><span class=p>(</span><span class=n>totalPrice</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>orderDao</span><span class=p>.</span><span class=na>updateById</span><span class=p>(</span><span class=n>order</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;订单已成功下单&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;=============ORDER END=================&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>商品服务</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ProductServiceImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>ProductService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=n>ProductDao</span><span class=w> </span><span class=n>productDao</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 事务传播特性设置为 REQUIRES_NEW 开启新的事务  重要！！！！一定要使用REQUIRES_NEW
</span></span></span><span class=line><span class=cl><span class=cm>   */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;product&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Transactional</span><span class=p>(</span><span class=n>propagation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Propagation</span><span class=p>.</span><span class=na>REQUIRES_NEW</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=n>Double</span><span class=w> </span><span class=nf>reduceStock</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>productId</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;=============PRODUCT START=================&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;当前 XID: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>RootContext</span><span class=p>.</span><span class=na>getXID</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 检查库存</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Product</span><span class=w> </span><span class=n>product</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>productDao</span><span class=p>.</span><span class=na>selectById</span><span class=p>(</span><span class=n>productId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Integer</span><span class=w> </span><span class=n>stock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>product</span><span class=p>.</span><span class=na>getStock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;商品编号为 {} 的库存为{},订单商品数量为{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>productId</span><span class=p>,</span><span class=w> </span><span class=n>stock</span><span class=p>,</span><span class=w> </span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>stock</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>log</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&#34;商品编号为{} 库存不足，当前库存:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>productId</span><span class=p>,</span><span class=w> </span><span class=n>stock</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=s>&#34;库存不足&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;开始扣减商品编号为 {} 库存,单价商品价格为{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>productId</span><span class=p>,</span><span class=w> </span><span class=n>product</span><span class=p>.</span><span class=na>getPrice</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 扣减库存</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>currentStock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>stock</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>amount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>product</span><span class=p>.</span><span class=na>setStock</span><span class=p>(</span><span class=n>currentStock</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>productDao</span><span class=p>.</span><span class=na>updateById</span><span class=p>(</span><span class=n>product</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>double</span><span class=w> </span><span class=n>totalPrice</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>product</span><span class=p>.</span><span class=na>getPrice</span><span class=p>()</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>amount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;扣减商品编号为 {} 库存成功,扣减后库存为{}, {} 件商品总价为 {} &#34;</span><span class=p>,</span><span class=w> </span><span class=n>productId</span><span class=p>,</span><span class=w> </span><span class=n>currentStock</span><span class=p>,</span><span class=w> </span><span class=n>amount</span><span class=p>,</span><span class=w> </span><span class=n>totalPrice</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;=============PRODUCT END=================&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>totalPrice</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>用户服务</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AccountServiceImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>AccountService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=n>AccountDao</span><span class=w> </span><span class=n>accountDao</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 事务传播特性设置为 REQUIRES_NEW 开启新的事务    重要！！！！一定要使用REQUIRES_NEW
</span></span></span><span class=line><span class=cl><span class=cm>   */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;account&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Transactional</span><span class=p>(</span><span class=n>propagation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Propagation</span><span class=p>.</span><span class=na>REQUIRES_NEW</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>reduceBalance</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>Double</span><span class=w> </span><span class=n>price</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;=============ACCOUNT START=================&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;当前 XID: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>RootContext</span><span class=p>.</span><span class=na>getXID</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Account</span><span class=w> </span><span class=n>account</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>accountDao</span><span class=p>.</span><span class=na>selectById</span><span class=p>(</span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Double</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>account</span><span class=p>.</span><span class=na>getBalance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;下单用户{}余额为 {},商品总价为{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>balance</span><span class=p>,</span><span class=w> </span><span class=n>price</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>balance</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>price</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>log</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&#34;用户 {} 余额不足，当前余额:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>balance</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=s>&#34;余额不足&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;开始扣减用户 {} 余额&#34;</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>double</span><span class=w> </span><span class=n>currentBalance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>account</span><span class=p>.</span><span class=na>getBalance</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>price</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>account</span><span class=p>.</span><span class=na>setBalance</span><span class=p>(</span><span class=n>currentBalance</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>accountDao</span><span class=p>.</span><span class=na>updateById</span><span class=p>(</span><span class=n>account</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;扣减用户 {} 余额成功,扣减后用户账户余额为{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>currentBalance</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;=============ACCOUNT END=================&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=测试>测试<a hidden class=anchor aria-hidden=true href=#测试>#</a></h3><p>自行编写接口测试，注意观察运行日志，至此分布式事务集成案例全流程完毕。</p><h2 id=事务常见问题>事务常见问题<a hidden class=anchor aria-hidden=true href=#事务常见问题>#</a></h2><p>建议先阅读基础知识。</p><p>核心知识： <code>spring原生事务会保证在事务下整个线程后续拿到的都是同一个connection。</code></p><p>核心知识： <code>spring原生事务会保证在事务下整个线程后续拿到的都是同一个connection。</code></p><p>核心知识： <code>spring原生事务会保证在事务下整个线程后续拿到的都是同一个connection。</code></p><h3 id=原生spring中transational能和ds一起使用吗>原生Spring中@Transational能和@DS一起使用吗？<a hidden class=anchor aria-hidden=true href=#原生spring中transational能和ds一起使用吗>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;a&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Transational</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>dosomething</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=c1>// some code</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>可以的，其会先切换使用数据源a再开启事务，整个原生事务内部不管是注解切换还是手动调用代码切换都不能切换，会一直使用a数据源。</p><p>所以确认整个事务下不再切换其他数据源，用原生 <code>@Transational</code> 是建议的，毕竟其更完善。</p><h3 id=本地事务和spring原生事务不能混用是什么意思>本地事务和Spring原生事务不能混用是什么意思？<a hidden class=anchor aria-hidden=true href=#本地事务和spring原生事务不能混用是什么意思>#</a></h3><p>场景一：先使用的Spring<code>@Transational</code> 内部方法调用了本地<code>@DSTransactional</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;a&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Transational</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>dosomething</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Bservice</span><span class=p>.</span><span class=na>dosomething</span><span class=p>();</span><span class=w> </span><span class=c1>// B是另外数据源，然后注解了@DS(&#34;b&#34;)和@DSTransactional</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Cservice</span><span class=p>.</span><span class=na>dosomething</span><span class=p>();</span><span class=w> </span><span class=c1>// C是另外数据源，然后注解了@DS(&#34;c&#34;)和@DSTransactional</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>基于核心知识： 事务下都是a数据源，内部无论做什么都改变不了使用a数据源。</p><p>场景二： 先使用的本地<code>@DSTransactional</code>内部方法调用了Spring<code>@Transational</code> 。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;a&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DSTransactional</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>dosomething</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Amapper</span><span class=p>.</span><span class=na>updateSomeThing</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Bservice</span><span class=p>.</span><span class=na>dosomething</span><span class=p>();</span><span class=w> </span><span class=c1>// B是另外数据源，然后注解了@DS(&#34;b&#34;)和@Transational</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Cservice</span><span class=p>.</span><span class=na>dosomething</span><span class=p>();</span><span class=w> </span><span class=c1>// C是另外数据源，然后注解了@DS(&#34;c&#34;)和@Transational</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>B和C都是独立的事务。C发生错误B会回滚吗？不会B已经提交了。A会回滚吗？会。</p><p>不建议混用，除非你确实非常理解事务，能随心所欲掌握你代码的执行流程。</p><h3 id=本地事务标准使用>本地事务标准使用<a hidden class=anchor aria-hidden=true href=#本地事务标准使用>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;a&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DSTransactional</span><span class=w> </span><span class=c1>// 最外层开启即可</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>dosomething</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Amapper</span><span class=p>.</span><span class=na>updateSomeThing</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Bservice</span><span class=p>.</span><span class=na>dosomething</span><span class=p>();</span><span class=w> </span><span class=c1>// B是另外数据源，然后注解了@DS(&#34;b&#34;)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Cservice</span><span class=p>.</span><span class=na>dosomething</span><span class=p>();</span><span class=w> </span><span class=c1>// C是另外数据源，然后注解了@DS(&#34;c&#34;)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h1 id=调试源码>调试源码<a hidden class=anchor aria-hidden=true href=#调试源码>#</a></h1><p>1、开启动态数据源的debug日志。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>logging</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>level</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>com.baomidou.dynamic</span><span class=p>:</span><span class=w> </span><span class=l>debug</span><span class=w>
</span></span></span></code></pre></div><p>检查日志输出是否正确。</p><p>2、断点调试DynamicDataSourceAnnotationInterceptor。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DynamicDataSourceAnnotationInterceptor</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>MethodInterceptor</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>DYNAMIC_PREFIX</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;#&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>DataSourceClassResolver</span><span class=w> </span><span class=n>dataSourceClassResolver</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>DsProcessor</span><span class=w> </span><span class=n>dsProcessor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>DynamicDataSourceAnnotationInterceptor</span><span class=p>(</span><span class=n>Boolean</span><span class=w> </span><span class=n>allowedPublicOnly</span><span class=p>,</span><span class=w> </span><span class=n>DsProcessor</span><span class=w> </span><span class=n>dsProcessor</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>dataSourceClassResolver</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataSourceClassResolver</span><span class=p>(</span><span class=n>allowedPublicOnly</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>dsProcessor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dsProcessor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>invoke</span><span class=p>(</span><span class=n>MethodInvocation</span><span class=w> </span><span class=n>invocation</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 这里把获取到的数据源标识如master存入本地线程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>dsKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>determineDatasourceKey</span><span class=p>(</span><span class=n>invocation</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=err>●</span><span class=w>  </span><span class=n>DynamicDataSourceContextHolder</span><span class=p>.</span><span class=na>push</span><span class=p>(</span><span class=n>dsKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>invocation</span><span class=p>.</span><span class=na>proceed</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>DynamicDataSourceContextHolder</span><span class=p>.</span><span class=na>poll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>determineDatasourceKey</span><span class=p>(</span><span class=n>MethodInvocation</span><span class=w> </span><span class=n>invocation</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dataSourceClassResolver</span><span class=p>.</span><span class=na>findDSKey</span><span class=p>(</span><span class=n>invocation</span><span class=p>.</span><span class=na>getMethod</span><span class=p>(),</span><span class=w> </span><span class=n>invocation</span><span class=p>.</span><span class=na>getThis</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>key</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>startsWith</span><span class=p>(</span><span class=n>DYNAMIC_PREFIX</span><span class=p>))</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>dsProcessor</span><span class=p>.</span><span class=na>determineDatasource</span><span class=p>(</span><span class=n>invocation</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>key</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>3、断点调试DynamicRoutingDataSource。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DynamicRoutingDataSource</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AbstractRoutingDataSource</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>DataSource</span><span class=o>&gt;</span><span class=w> </span><span class=n>dataSourceMap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LinkedHashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>DynamicGroupDataSource</span><span class=o>&gt;</span><span class=w> </span><span class=n>groupDataSources</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConcurrentHashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=nf>determineDataSource</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 从本地线程获取key解析最终真实的数据源</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=err>●</span><span class=w>  </span><span class=n>String</span><span class=w> </span><span class=n>dsKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DynamicDataSourceContextHolder</span><span class=p>.</span><span class=na>peek</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>getDataSource</span><span class=p>(</span><span class=n>dsKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=nf>determinePrimaryDataSource</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;从默认数据源中返回数据&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>groupDataSources</span><span class=p>.</span><span class=na>containsKey</span><span class=p>(</span><span class=n>primary</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>groupDataSources</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>primary</span><span class=p>).</span><span class=na>determineDataSource</span><span class=p>()</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>dataSourceMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>primary</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=nf>getDataSource</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>ds</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>StringUtils</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>(</span><span class=n>ds</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>determinePrimaryDataSource</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>groupDataSources</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>groupDataSources</span><span class=p>.</span><span class=na>containsKey</span><span class=p>(</span><span class=n>ds</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;从 {} 组数据源中返回数据源&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ds</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>groupDataSources</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>ds</span><span class=p>).</span><span class=na>determineDataSource</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>dataSourceMap</span><span class=p>.</span><span class=na>containsKey</span><span class=p>(</span><span class=n>ds</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;从 {} 单数据源中返回数据源&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ds</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>dataSourceMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>ds</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>determinePrimaryDataSource</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h1 id=常见问题之-切换数据源失败>常见问题之-切换数据源失败<a hidden class=anchor aria-hidden=true href=#常见问题之-切换数据源失败>#</a></h1><h2 id=开启了spring的事务>开启了spring的事务<a hidden class=anchor aria-hidden=true href=#开启了spring的事务>#</a></h2><p>原因： spring开启事务后会维护一个ConnectionHolder，保证在整个事务下，都是用同一个数据库连接。</p><p>请检查整个调用链路涉及的类的方法和类本身还有继承的抽象类上是否有<code>@Transactional</code>注解。</p><p>如强烈需要事务保证多个库同时执行成功或者失败，请查看事务专栏的解决办法。</p><h2 id=方法内部调用>方法内部调用<a hidden class=anchor aria-hidden=true href=#方法内部调用>#</a></h2><p>查看以下示例</p><p>外部调用 <code>userservice.test1()</code> 能在执行到 <code>test2()</code> 切换到second数据源吗？</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>UserService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;first&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test1</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// do something</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>test2</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;second&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test2</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// do something</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>答案：<code>！！！不能不能不能！！！</code>数据源核心原理是基于aop代理实现切换，内部方法调用不会使用aop。</p><p>解决方法:</p><p>把test2()方法提到另外一个service，单独调用。</p><h2 id=postconstruct初始化顺序>PostConstruct初始化顺序<a hidden class=anchor aria-hidden=true href=#postconstruct初始化顺序>#</a></h2><p>初始化包括: @PostConstruct 注解, InitializingBean接口, 自定义init-method</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MyConfiguration</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>UserMapper</span><span class=w> </span><span class=n>userMapper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;slave&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PostConstruct</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>init</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 无法选择正确的数据源</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>userMapper</span><span class=p>.</span><span class=na>selectById</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>解决方法：监听容器启动完成事件, 在容器完成后做初始化。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MyConfiguration</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;slave&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@EventListener</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onApplicationEvent</span><span class=p>(</span><span class=n>ContextRefreshedEvent</span><span class=w> </span><span class=n>event</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 成功选择正确的数据源</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>userMapper</span><span class=p>.</span><span class=na>selectById</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>相关spring源码 : <code>org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#initializeBean</code></p><p>在初始化完成后, bean 进入增强阶段, 所以这个阶段的任何AOP都是无效的。</p><h2 id=druid版本过低>Druid版本过低<a hidden class=anchor aria-hidden=true href=#druid版本过低>#</a></h2><p>请升级druid1.1.22及以上版本，这个版本修复了在高并发下偶发的切换失效问题。</p><h2 id=async或者java8的parallelstream并行流之类方法>@Async或者java8的ParallelStream并行流之类方法<a hidden class=anchor aria-hidden=true href=#async或者java8的parallelstream并行流之类方法>#</a></h2><p>这种情况都是新开了线程去异步处理，不受当前线程管控了。</p><p>可以在新开的方法上加对应的DS注解解决。</p><h1 id=知识库>知识库<a hidden class=anchor aria-hidden=true href=#知识库>#</a></h1><h2 id=如何注入多数据源>如何注入多数据源？<a hidden class=anchor aria-hidden=true href=#如何注入多数据源>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>A</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=n>dosomething</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=c1>// 使用的时候需要强转</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DynamicRoutingDataSource</span><span class=w> </span><span class=n>ds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>DynamicRoutingDataSource</span><span class=p>)</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=如何获取当前线程数据源名称>如何获取当前线程数据源名称？<a hidden class=anchor aria-hidden=true href=#如何获取当前线程数据源名称>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>DynamicDataSourceContextHolder</span><span class=p>.</span><span class=na>peek</span><span class=p>()</span><span class=w>
</span></span></span></code></pre></div><h2 id=如何获取当前线程数据源>如何获取当前线程数据源？<a hidden class=anchor aria-hidden=true href=#如何获取当前线程数据源>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=n>dosomething</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DynamicRoutingDataSource</span><span class=w> </span><span class=n>ds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>DynamicRoutingDataSource</span><span class=p>)</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DataSource</span><span class=w> </span><span class=n>datasource</span><span class=o>=</span><span class=n>ds</span><span class=p>.</span><span class=na>determineDataSource</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><blockquote><p>本文参考至：https://www.xiaojingge.com/archives/ef008289-8ab8-485c-8019-2703267c7beb</p></blockquote></div><footer class=post-footer><ul class=post-tags><li><a href=https://lesanouo.github.io/blog/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/>数据库</a></li></ul><nav class=paginav><a class=prev href=https://lesanouo.github.io/blog/posts/code/175000320001/><span class=title>«</span><br><span>npm中windows-build-tools下载问题</span>
</a><a class=next href=https://lesanouo.github.io/blog/posts/code/174931200001/><span class=title>»</span><br><span>MySQL创建用户与授权</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://lesanouo.github.io/blog/>Lesan's Blog</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>