<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>dynamic-datasourceæ–‡æ¡£ | Lesan's Blog</title><meta name=keywords content="æ•°æ®åº“"><meta name=description content="æœ¬æ–‡ä¸º dynamic-datasource-spring-boot-starter ï¼ˆåŸºäºSpringBootçš„å¿«é€Ÿé›†æˆå¤šæ•°æ®æºæ¡†æ¶ï¼‰çš„ä½¿ç”¨æ–‡æ¡£ã€‚
ç‰¹æ€§

æ”¯æŒ æ•°æ®æºåˆ†ç»„ ï¼Œé€‚ç”¨äºå¤šç§åœºæ™¯ï¼Œçº¯ç²¹å¤šåº“ã€è¯»å†™åˆ†ç¦»ã€ä¸€ä¸»å¤šä»ã€æ··åˆæ¨¡å¼ã€‚
æ”¯æŒæ•°æ®åº“æ•æ„Ÿé…ç½®ä¿¡æ¯ åŠ å¯†(å¯è‡ªå®šä¹‰) ENC()ã€‚
æ”¯æŒæ¯ä¸ªæ•°æ®åº“ç‹¬ç«‹åˆå§‹åŒ–è¡¨ç»“æ„schemaå’Œæ•°æ®åº“databaseã€‚
æ”¯æŒæ— æ•°æ®æºå¯åŠ¨ï¼Œæ”¯æŒ æ‡’åŠ è½½æ•°æ®æº ï¼ˆéœ€è¦çš„æ—¶å€™å†åˆ›å»ºè¿æ¥ï¼‰ã€‚
æ”¯æŒ è‡ªå®šä¹‰æ³¨è§£ ï¼Œéœ€ç»§æ‰¿DS(3.2.0+)ã€‚
æä¾›å¹¶ç®€åŒ–å¯¹Druidï¼ŒHikariCpï¼ŒBeeCpï¼ŒDbcp2çš„å¿«é€Ÿé›†æˆã€‚
æä¾›å¯¹ Mybatis-Plus ï¼ŒQuartzï¼ŒShardingJdbcï¼ŒP6syï¼ŒJndiç­‰ç»„ä»¶çš„é›†æˆæ–¹æ¡ˆã€‚
æä¾› è‡ªå®šä¹‰æ•°æ®æºæ¥æº æ–¹æ¡ˆï¼ˆå¦‚å…¨ä»æ•°æ®åº“åŠ è½½ï¼‰ã€‚
æä¾›é¡¹ç›®å¯åŠ¨å åŠ¨æ€å¢åŠ ç§»é™¤æ•°æ®æº æ–¹æ¡ˆã€‚
æä¾›Mybatisç¯å¢ƒä¸‹çš„ çº¯è¯»å†™åˆ†ç¦» æ–¹æ¡ˆã€‚
æä¾›ä½¿ç”¨ spelåŠ¨æ€å‚æ•° è§£ææ•°æ®æºæ–¹æ¡ˆã€‚å†…ç½®spelï¼Œsessionï¼Œheaderï¼Œæ”¯æŒè‡ªå®šä¹‰ã€‚
æ”¯æŒ å¤šå±‚æ•°æ®æºåµŒå¥—åˆ‡æ¢ ã€‚ï¼ˆServiceA &#187;> ServiceB &#187;> ServiceCï¼‰ã€‚
æä¾› åŸºäºseataçš„åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆ ã€‚
æä¾› æœ¬åœ°å¤šæ•°æ®æºäº‹åŠ¡æ–¹æ¡ˆ ã€‚

çº¦å®š

dynamic-datasourceåªåš åˆ‡æ¢æ•°æ®æº è¿™ä»¶æ ¸å¿ƒçš„äº‹æƒ…ï¼Œå¹¶ ä¸é™åˆ¶ä½ çš„å…·ä½“æ“ä½œ ï¼Œåˆ‡æ¢äº†æ•°æ®æºå¯ä»¥åšä»»ä½•CRUDã€‚
é…ç½®æ–‡ä»¶æ‰€æœ‰ä»¥ä¸‹åˆ’çº¿ _ åˆ†å‰²çš„æ•°æ®æº é¦–éƒ¨ å³ä¸ºç»„çš„åç§°ï¼Œç›¸åŒç»„åç§°çš„æ•°æ®æºä¼šæ”¾åœ¨ä¸€ä¸ªç»„ä¸‹ã€‚
åˆ‡æ¢æ•°æ®æºå¯ä»¥æ˜¯ç»„åï¼Œä¹Ÿå¯ä»¥æ˜¯å…·ä½“æ•°æ®æºåç§°ã€‚ ç»„ååˆ™åˆ‡æ¢æ—¶é‡‡ç”¨è´Ÿè½½å‡è¡¡ç®—æ³•åˆ‡æ¢ ã€‚
é»˜è®¤çš„æ•°æ®æºåç§°ä¸º master ï¼Œä½ å¯ä»¥é€šè¿‡ spring.datasource.dynamic.primary ä¿®æ”¹ã€‚
æ–¹æ³•ä¸Šçš„æ³¨è§£ä¼˜å…ˆäºç±»ä¸Šæ³¨è§£ã€‚
DSæ”¯æŒç»§æ‰¿æŠ½è±¡ç±»ä¸Šçš„DSï¼Œæš‚ä¸æ”¯æŒç»§æ‰¿æ¥å£ä¸Šçš„DSã€‚

ä½¿ç”¨æ–¹æ³•

å¼•å…¥dynamic-datasource-spring-boot-starter

spring-boot 1.5.xã€2.x.x"><meta name=author content="Lesan"><link rel=canonical href=https://lesanouo.github.io/blog/posts/code/174974400001/><link crossorigin=anonymous href=/blog/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://lesanouo.github.io/blog/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://lesanouo.github.io/blog/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://lesanouo.github.io/blog/favicon.ico><link rel=apple-touch-icon href=https://lesanouo.github.io/blog/favicon.ico><link rel=mask-icon href=https://lesanouo.github.io/blog/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-cn href=https://lesanouo.github.io/blog/posts/code/174974400001/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:url" content="https://lesanouo.github.io/blog/posts/code/174974400001/"><meta property="og:site_name" content="Lesan's Blog"><meta property="og:title" content="dynamic-datasourceæ–‡æ¡£"><meta property="og:description" content="æœ¬æ–‡ä¸º dynamic-datasource-spring-boot-starter ï¼ˆåŸºäºSpringBootçš„å¿«é€Ÿé›†æˆå¤šæ•°æ®æºæ¡†æ¶ï¼‰çš„ä½¿ç”¨æ–‡æ¡£ã€‚
ç‰¹æ€§ æ”¯æŒ æ•°æ®æºåˆ†ç»„ ï¼Œé€‚ç”¨äºå¤šç§åœºæ™¯ï¼Œçº¯ç²¹å¤šåº“ã€è¯»å†™åˆ†ç¦»ã€ä¸€ä¸»å¤šä»ã€æ··åˆæ¨¡å¼ã€‚ æ”¯æŒæ•°æ®åº“æ•æ„Ÿé…ç½®ä¿¡æ¯ åŠ å¯†(å¯è‡ªå®šä¹‰) ENC()ã€‚ æ”¯æŒæ¯ä¸ªæ•°æ®åº“ç‹¬ç«‹åˆå§‹åŒ–è¡¨ç»“æ„schemaå’Œæ•°æ®åº“databaseã€‚ æ”¯æŒæ— æ•°æ®æºå¯åŠ¨ï¼Œæ”¯æŒ æ‡’åŠ è½½æ•°æ®æº ï¼ˆéœ€è¦çš„æ—¶å€™å†åˆ›å»ºè¿æ¥ï¼‰ã€‚ æ”¯æŒ è‡ªå®šä¹‰æ³¨è§£ ï¼Œéœ€ç»§æ‰¿DS(3.2.0+)ã€‚ æä¾›å¹¶ç®€åŒ–å¯¹Druidï¼ŒHikariCpï¼ŒBeeCpï¼ŒDbcp2çš„å¿«é€Ÿé›†æˆã€‚ æä¾›å¯¹ Mybatis-Plus ï¼ŒQuartzï¼ŒShardingJdbcï¼ŒP6syï¼ŒJndiç­‰ç»„ä»¶çš„é›†æˆæ–¹æ¡ˆã€‚ æä¾› è‡ªå®šä¹‰æ•°æ®æºæ¥æº æ–¹æ¡ˆï¼ˆå¦‚å…¨ä»æ•°æ®åº“åŠ è½½ï¼‰ã€‚ æä¾›é¡¹ç›®å¯åŠ¨å åŠ¨æ€å¢åŠ ç§»é™¤æ•°æ®æº æ–¹æ¡ˆã€‚ æä¾›Mybatisç¯å¢ƒä¸‹çš„ çº¯è¯»å†™åˆ†ç¦» æ–¹æ¡ˆã€‚ æä¾›ä½¿ç”¨ spelåŠ¨æ€å‚æ•° è§£ææ•°æ®æºæ–¹æ¡ˆã€‚å†…ç½®spelï¼Œsessionï¼Œheaderï¼Œæ”¯æŒè‡ªå®šä¹‰ã€‚ æ”¯æŒ å¤šå±‚æ•°æ®æºåµŒå¥—åˆ‡æ¢ ã€‚ï¼ˆServiceA Â»> ServiceB Â»> ServiceCï¼‰ã€‚ æä¾› åŸºäºseataçš„åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆ ã€‚ æä¾› æœ¬åœ°å¤šæ•°æ®æºäº‹åŠ¡æ–¹æ¡ˆ ã€‚ çº¦å®š dynamic-datasourceåªåš åˆ‡æ¢æ•°æ®æº è¿™ä»¶æ ¸å¿ƒçš„äº‹æƒ…ï¼Œå¹¶ ä¸é™åˆ¶ä½ çš„å…·ä½“æ“ä½œ ï¼Œåˆ‡æ¢äº†æ•°æ®æºå¯ä»¥åšä»»ä½•CRUDã€‚ é…ç½®æ–‡ä»¶æ‰€æœ‰ä»¥ä¸‹åˆ’çº¿ _ åˆ†å‰²çš„æ•°æ®æº é¦–éƒ¨ å³ä¸ºç»„çš„åç§°ï¼Œç›¸åŒç»„åç§°çš„æ•°æ®æºä¼šæ”¾åœ¨ä¸€ä¸ªç»„ä¸‹ã€‚ åˆ‡æ¢æ•°æ®æºå¯ä»¥æ˜¯ç»„åï¼Œä¹Ÿå¯ä»¥æ˜¯å…·ä½“æ•°æ®æºåç§°ã€‚ ç»„ååˆ™åˆ‡æ¢æ—¶é‡‡ç”¨è´Ÿè½½å‡è¡¡ç®—æ³•åˆ‡æ¢ ã€‚ é»˜è®¤çš„æ•°æ®æºåç§°ä¸º master ï¼Œä½ å¯ä»¥é€šè¿‡ spring.datasource.dynamic.primary ä¿®æ”¹ã€‚ æ–¹æ³•ä¸Šçš„æ³¨è§£ä¼˜å…ˆäºç±»ä¸Šæ³¨è§£ã€‚ DSæ”¯æŒç»§æ‰¿æŠ½è±¡ç±»ä¸Šçš„DSï¼Œæš‚ä¸æ”¯æŒç»§æ‰¿æ¥å£ä¸Šçš„DSã€‚ ä½¿ç”¨æ–¹æ³• å¼•å…¥dynamic-datasource-spring-boot-starter spring-boot 1.5.xã€2.x.x"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-06-13T00:00:00+00:00"><meta property="article:modified_time" content="2025-06-13T00:00:00+00:00"><meta property="article:tag" content="æ•°æ®åº“"><meta name=twitter:card content="summary"><meta name=twitter:title content="dynamic-datasourceæ–‡æ¡£"><meta name=twitter:description content="æœ¬æ–‡ä¸º dynamic-datasource-spring-boot-starter ï¼ˆåŸºäºSpringBootçš„å¿«é€Ÿé›†æˆå¤šæ•°æ®æºæ¡†æ¶ï¼‰çš„ä½¿ç”¨æ–‡æ¡£ã€‚
ç‰¹æ€§

æ”¯æŒ æ•°æ®æºåˆ†ç»„ ï¼Œé€‚ç”¨äºå¤šç§åœºæ™¯ï¼Œçº¯ç²¹å¤šåº“ã€è¯»å†™åˆ†ç¦»ã€ä¸€ä¸»å¤šä»ã€æ··åˆæ¨¡å¼ã€‚
æ”¯æŒæ•°æ®åº“æ•æ„Ÿé…ç½®ä¿¡æ¯ åŠ å¯†(å¯è‡ªå®šä¹‰) ENC()ã€‚
æ”¯æŒæ¯ä¸ªæ•°æ®åº“ç‹¬ç«‹åˆå§‹åŒ–è¡¨ç»“æ„schemaå’Œæ•°æ®åº“databaseã€‚
æ”¯æŒæ— æ•°æ®æºå¯åŠ¨ï¼Œæ”¯æŒ æ‡’åŠ è½½æ•°æ®æº ï¼ˆéœ€è¦çš„æ—¶å€™å†åˆ›å»ºè¿æ¥ï¼‰ã€‚
æ”¯æŒ è‡ªå®šä¹‰æ³¨è§£ ï¼Œéœ€ç»§æ‰¿DS(3.2.0+)ã€‚
æä¾›å¹¶ç®€åŒ–å¯¹Druidï¼ŒHikariCpï¼ŒBeeCpï¼ŒDbcp2çš„å¿«é€Ÿé›†æˆã€‚
æä¾›å¯¹ Mybatis-Plus ï¼ŒQuartzï¼ŒShardingJdbcï¼ŒP6syï¼ŒJndiç­‰ç»„ä»¶çš„é›†æˆæ–¹æ¡ˆã€‚
æä¾› è‡ªå®šä¹‰æ•°æ®æºæ¥æº æ–¹æ¡ˆï¼ˆå¦‚å…¨ä»æ•°æ®åº“åŠ è½½ï¼‰ã€‚
æä¾›é¡¹ç›®å¯åŠ¨å åŠ¨æ€å¢åŠ ç§»é™¤æ•°æ®æº æ–¹æ¡ˆã€‚
æä¾›Mybatisç¯å¢ƒä¸‹çš„ çº¯è¯»å†™åˆ†ç¦» æ–¹æ¡ˆã€‚
æä¾›ä½¿ç”¨ spelåŠ¨æ€å‚æ•° è§£ææ•°æ®æºæ–¹æ¡ˆã€‚å†…ç½®spelï¼Œsessionï¼Œheaderï¼Œæ”¯æŒè‡ªå®šä¹‰ã€‚
æ”¯æŒ å¤šå±‚æ•°æ®æºåµŒå¥—åˆ‡æ¢ ã€‚ï¼ˆServiceA &#187;> ServiceB &#187;> ServiceCï¼‰ã€‚
æä¾› åŸºäºseataçš„åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆ ã€‚
æä¾› æœ¬åœ°å¤šæ•°æ®æºäº‹åŠ¡æ–¹æ¡ˆ ã€‚

çº¦å®š

dynamic-datasourceåªåš åˆ‡æ¢æ•°æ®æº è¿™ä»¶æ ¸å¿ƒçš„äº‹æƒ…ï¼Œå¹¶ ä¸é™åˆ¶ä½ çš„å…·ä½“æ“ä½œ ï¼Œåˆ‡æ¢äº†æ•°æ®æºå¯ä»¥åšä»»ä½•CRUDã€‚
é…ç½®æ–‡ä»¶æ‰€æœ‰ä»¥ä¸‹åˆ’çº¿ _ åˆ†å‰²çš„æ•°æ®æº é¦–éƒ¨ å³ä¸ºç»„çš„åç§°ï¼Œç›¸åŒç»„åç§°çš„æ•°æ®æºä¼šæ”¾åœ¨ä¸€ä¸ªç»„ä¸‹ã€‚
åˆ‡æ¢æ•°æ®æºå¯ä»¥æ˜¯ç»„åï¼Œä¹Ÿå¯ä»¥æ˜¯å…·ä½“æ•°æ®æºåç§°ã€‚ ç»„ååˆ™åˆ‡æ¢æ—¶é‡‡ç”¨è´Ÿè½½å‡è¡¡ç®—æ³•åˆ‡æ¢ ã€‚
é»˜è®¤çš„æ•°æ®æºåç§°ä¸º master ï¼Œä½ å¯ä»¥é€šè¿‡ spring.datasource.dynamic.primary ä¿®æ”¹ã€‚
æ–¹æ³•ä¸Šçš„æ³¨è§£ä¼˜å…ˆäºç±»ä¸Šæ³¨è§£ã€‚
DSæ”¯æŒç»§æ‰¿æŠ½è±¡ç±»ä¸Šçš„DSï¼Œæš‚ä¸æ”¯æŒç»§æ‰¿æ¥å£ä¸Šçš„DSã€‚

ä½¿ç”¨æ–¹æ³•

å¼•å…¥dynamic-datasource-spring-boot-starter

spring-boot 1.5.xã€2.x.x"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"ğŸ“š åšå®¢","item":"https://lesanouo.github.io/blog/posts/"},{"@type":"ListItem","position":2,"name":"dynamic-datasourceæ–‡æ¡£","item":"https://lesanouo.github.io/blog/posts/code/174974400001/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"dynamic-datasourceæ–‡æ¡£","name":"dynamic-datasourceæ–‡æ¡£","description":"æœ¬æ–‡ä¸º dynamic-datasource-spring-boot-starter ï¼ˆåŸºäºSpringBootçš„å¿«é€Ÿé›†æˆå¤šæ•°æ®æºæ¡†æ¶ï¼‰çš„ä½¿ç”¨æ–‡æ¡£ã€‚\nç‰¹æ€§ æ”¯æŒ æ•°æ®æºåˆ†ç»„ ï¼Œé€‚ç”¨äºå¤šç§åœºæ™¯ï¼Œçº¯ç²¹å¤šåº“ã€è¯»å†™åˆ†ç¦»ã€ä¸€ä¸»å¤šä»ã€æ··åˆæ¨¡å¼ã€‚ æ”¯æŒæ•°æ®åº“æ•æ„Ÿé…ç½®ä¿¡æ¯ åŠ å¯†(å¯è‡ªå®šä¹‰) ENC()ã€‚ æ”¯æŒæ¯ä¸ªæ•°æ®åº“ç‹¬ç«‹åˆå§‹åŒ–è¡¨ç»“æ„schemaå’Œæ•°æ®åº“databaseã€‚ æ”¯æŒæ— æ•°æ®æºå¯åŠ¨ï¼Œæ”¯æŒ æ‡’åŠ è½½æ•°æ®æº ï¼ˆéœ€è¦çš„æ—¶å€™å†åˆ›å»ºè¿æ¥ï¼‰ã€‚ æ”¯æŒ è‡ªå®šä¹‰æ³¨è§£ ï¼Œéœ€ç»§æ‰¿DS(3.2.0+)ã€‚ æä¾›å¹¶ç®€åŒ–å¯¹Druidï¼ŒHikariCpï¼ŒBeeCpï¼ŒDbcp2çš„å¿«é€Ÿé›†æˆã€‚ æä¾›å¯¹ Mybatis-Plus ï¼ŒQuartzï¼ŒShardingJdbcï¼ŒP6syï¼ŒJndiç­‰ç»„ä»¶çš„é›†æˆæ–¹æ¡ˆã€‚ æä¾› è‡ªå®šä¹‰æ•°æ®æºæ¥æº æ–¹æ¡ˆï¼ˆå¦‚å…¨ä»æ•°æ®åº“åŠ è½½ï¼‰ã€‚ æä¾›é¡¹ç›®å¯åŠ¨å åŠ¨æ€å¢åŠ ç§»é™¤æ•°æ®æº æ–¹æ¡ˆã€‚ æä¾›Mybatisç¯å¢ƒä¸‹çš„ çº¯è¯»å†™åˆ†ç¦» æ–¹æ¡ˆã€‚ æä¾›ä½¿ç”¨ spelåŠ¨æ€å‚æ•° è§£ææ•°æ®æºæ–¹æ¡ˆã€‚å†…ç½®spelï¼Œsessionï¼Œheaderï¼Œæ”¯æŒè‡ªå®šä¹‰ã€‚ æ”¯æŒ å¤šå±‚æ•°æ®æºåµŒå¥—åˆ‡æ¢ ã€‚ï¼ˆServiceA \u0026raquo;\u0026gt; ServiceB \u0026raquo;\u0026gt; ServiceCï¼‰ã€‚ æä¾› åŸºäºseataçš„åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆ ã€‚ æä¾› æœ¬åœ°å¤šæ•°æ®æºäº‹åŠ¡æ–¹æ¡ˆ ã€‚ çº¦å®š dynamic-datasourceåªåš åˆ‡æ¢æ•°æ®æº è¿™ä»¶æ ¸å¿ƒçš„äº‹æƒ…ï¼Œå¹¶ ä¸é™åˆ¶ä½ çš„å…·ä½“æ“ä½œ ï¼Œåˆ‡æ¢äº†æ•°æ®æºå¯ä»¥åšä»»ä½•CRUDã€‚ é…ç½®æ–‡ä»¶æ‰€æœ‰ä»¥ä¸‹åˆ’çº¿ _ åˆ†å‰²çš„æ•°æ®æº é¦–éƒ¨ å³ä¸ºç»„çš„åç§°ï¼Œç›¸åŒç»„åç§°çš„æ•°æ®æºä¼šæ”¾åœ¨ä¸€ä¸ªç»„ä¸‹ã€‚ åˆ‡æ¢æ•°æ®æºå¯ä»¥æ˜¯ç»„åï¼Œä¹Ÿå¯ä»¥æ˜¯å…·ä½“æ•°æ®æºåç§°ã€‚ ç»„ååˆ™åˆ‡æ¢æ—¶é‡‡ç”¨è´Ÿè½½å‡è¡¡ç®—æ³•åˆ‡æ¢ ã€‚ é»˜è®¤çš„æ•°æ®æºåç§°ä¸º master ï¼Œä½ å¯ä»¥é€šè¿‡ spring.datasource.dynamic.primary ä¿®æ”¹ã€‚ æ–¹æ³•ä¸Šçš„æ³¨è§£ä¼˜å…ˆäºç±»ä¸Šæ³¨è§£ã€‚ DSæ”¯æŒç»§æ‰¿æŠ½è±¡ç±»ä¸Šçš„DSï¼Œæš‚ä¸æ”¯æŒç»§æ‰¿æ¥å£ä¸Šçš„DSã€‚ ä½¿ç”¨æ–¹æ³• å¼•å…¥dynamic-datasource-spring-boot-starter spring-boot 1.5.xã€2.x.x\n","keywords":["æ•°æ®åº“"],"articleBody":"æœ¬æ–‡ä¸º dynamic-datasource-spring-boot-starter ï¼ˆåŸºäºSpringBootçš„å¿«é€Ÿé›†æˆå¤šæ•°æ®æºæ¡†æ¶ï¼‰çš„ä½¿ç”¨æ–‡æ¡£ã€‚\nç‰¹æ€§ æ”¯æŒ æ•°æ®æºåˆ†ç»„ ï¼Œé€‚ç”¨äºå¤šç§åœºæ™¯ï¼Œçº¯ç²¹å¤šåº“ã€è¯»å†™åˆ†ç¦»ã€ä¸€ä¸»å¤šä»ã€æ··åˆæ¨¡å¼ã€‚ æ”¯æŒæ•°æ®åº“æ•æ„Ÿé…ç½®ä¿¡æ¯ åŠ å¯†(å¯è‡ªå®šä¹‰) ENC()ã€‚ æ”¯æŒæ¯ä¸ªæ•°æ®åº“ç‹¬ç«‹åˆå§‹åŒ–è¡¨ç»“æ„schemaå’Œæ•°æ®åº“databaseã€‚ æ”¯æŒæ— æ•°æ®æºå¯åŠ¨ï¼Œæ”¯æŒ æ‡’åŠ è½½æ•°æ®æº ï¼ˆéœ€è¦çš„æ—¶å€™å†åˆ›å»ºè¿æ¥ï¼‰ã€‚ æ”¯æŒ è‡ªå®šä¹‰æ³¨è§£ ï¼Œéœ€ç»§æ‰¿DS(3.2.0+)ã€‚ æä¾›å¹¶ç®€åŒ–å¯¹Druidï¼ŒHikariCpï¼ŒBeeCpï¼ŒDbcp2çš„å¿«é€Ÿé›†æˆã€‚ æä¾›å¯¹ Mybatis-Plus ï¼ŒQuartzï¼ŒShardingJdbcï¼ŒP6syï¼ŒJndiç­‰ç»„ä»¶çš„é›†æˆæ–¹æ¡ˆã€‚ æä¾› è‡ªå®šä¹‰æ•°æ®æºæ¥æº æ–¹æ¡ˆï¼ˆå¦‚å…¨ä»æ•°æ®åº“åŠ è½½ï¼‰ã€‚ æä¾›é¡¹ç›®å¯åŠ¨å åŠ¨æ€å¢åŠ ç§»é™¤æ•°æ®æº æ–¹æ¡ˆã€‚ æä¾›Mybatisç¯å¢ƒä¸‹çš„ çº¯è¯»å†™åˆ†ç¦» æ–¹æ¡ˆã€‚ æä¾›ä½¿ç”¨ spelåŠ¨æ€å‚æ•° è§£ææ•°æ®æºæ–¹æ¡ˆã€‚å†…ç½®spelï¼Œsessionï¼Œheaderï¼Œæ”¯æŒè‡ªå®šä¹‰ã€‚ æ”¯æŒ å¤šå±‚æ•°æ®æºåµŒå¥—åˆ‡æ¢ ã€‚ï¼ˆServiceA Â»\u003e ServiceB Â»\u003e ServiceCï¼‰ã€‚ æä¾› åŸºäºseataçš„åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆ ã€‚ æä¾› æœ¬åœ°å¤šæ•°æ®æºäº‹åŠ¡æ–¹æ¡ˆ ã€‚ çº¦å®š dynamic-datasourceåªåš åˆ‡æ¢æ•°æ®æº è¿™ä»¶æ ¸å¿ƒçš„äº‹æƒ…ï¼Œå¹¶ ä¸é™åˆ¶ä½ çš„å…·ä½“æ“ä½œ ï¼Œåˆ‡æ¢äº†æ•°æ®æºå¯ä»¥åšä»»ä½•CRUDã€‚ é…ç½®æ–‡ä»¶æ‰€æœ‰ä»¥ä¸‹åˆ’çº¿ _ åˆ†å‰²çš„æ•°æ®æº é¦–éƒ¨ å³ä¸ºç»„çš„åç§°ï¼Œç›¸åŒç»„åç§°çš„æ•°æ®æºä¼šæ”¾åœ¨ä¸€ä¸ªç»„ä¸‹ã€‚ åˆ‡æ¢æ•°æ®æºå¯ä»¥æ˜¯ç»„åï¼Œä¹Ÿå¯ä»¥æ˜¯å…·ä½“æ•°æ®æºåç§°ã€‚ ç»„ååˆ™åˆ‡æ¢æ—¶é‡‡ç”¨è´Ÿè½½å‡è¡¡ç®—æ³•åˆ‡æ¢ ã€‚ é»˜è®¤çš„æ•°æ®æºåç§°ä¸º master ï¼Œä½ å¯ä»¥é€šè¿‡ spring.datasource.dynamic.primary ä¿®æ”¹ã€‚ æ–¹æ³•ä¸Šçš„æ³¨è§£ä¼˜å…ˆäºç±»ä¸Šæ³¨è§£ã€‚ DSæ”¯æŒç»§æ‰¿æŠ½è±¡ç±»ä¸Šçš„DSï¼Œæš‚ä¸æ”¯æŒç»§æ‰¿æ¥å£ä¸Šçš„DSã€‚ ä½¿ç”¨æ–¹æ³• å¼•å…¥dynamic-datasource-spring-boot-starter spring-boot 1.5.xã€2.x.x\ncom.baomidou dynamic-datasource-spring-boot-starter ${version} spring-boot3åŠä»¥ä¸Š\ncom.baomidou dynamic-datasource-spring-boot3-starter ${version} é…ç½®æ•°æ®æº spring: datasource: dynamic: primary: master # è®¾ç½®é»˜è®¤çš„æ•°æ®æºæˆ–è€…æ•°æ®æºç»„,é»˜è®¤å€¼å³ä¸ºmaster strict: false # ä¸¥æ ¼åŒ¹é…æ•°æ®æº,é»˜è®¤false. trueæœªåŒ¹é…åˆ°æŒ‡å®šæ•°æ®æºæ—¶æŠ›å¼‚å¸¸,falseä½¿ç”¨é»˜è®¤æ•°æ®æº datasource: master: url: jdbc:mysql://xx.xx.xx.xx:3306/dynamic username: root password: 123456 driver-class-name: com.mysql.cj.jdbc.Driver # 3.2.0å¼€å§‹æ”¯æŒSPIå¯çœç•¥æ­¤é…ç½® slave_1: url: jdbc:mysql://xx.xx.xx.xx:3307/dynamic username: root password: 123456 driver-class-name: com.mysql.cj.jdbc.Driver slave_2: url: ENC(xxxxx) # å†…ç½®åŠ å¯†,ä½¿ç”¨è¯·æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£ username: ENC(xxxxx) password: ENC(xxxxx) driver-class-name: com.mysql.cj.jdbc.Driver # ......çœç•¥ # ä»¥ä¸Šä¼šé…ç½®ä¸€ä¸ªé»˜è®¤åº“masterï¼Œä¸€ä¸ªç»„slaveä¸‹æœ‰ä¸¤ä¸ªå­åº“slave_1,slave_2 # å¤šä¸»å¤šä» spring: datasource: dynamic: datasource: master_1: master_2: slave_1: slave_2: slave_3: # çº¯ç²¹å¤šåº“ï¼ˆè®°å¾—è®¾ç½®primaryï¼‰ spring: datasource: dynamic: datasource: mysql: oracle: sqlserver: postgresql: h2: # æ··åˆé…ç½® spring: datasource: dynamic: datasource: master: slave_1: slave_2: oracle_1: oracle_2: ä½¿ç”¨ @DS åˆ‡æ¢æ•°æ®æº @DS å¯ä»¥æ³¨è§£åœ¨æ–¹æ³•ä¸Šæˆ–ç±»ä¸Šï¼ŒåŒæ—¶å­˜åœ¨ å°±è¿‘åŸåˆ™ï¼Œæ–¹æ³•ä¸Šæ³¨è§£ ä¼˜å…ˆäº ç±»ä¸Šæ³¨è§£ã€‚\næ³¨è§£ ç»“æœ æ²¡æœ‰@DS é»˜è®¤æ•°æ®æº @DS(â€œdsNameâ€) dsNameå¯ä»¥ä¸ºç»„åä¹Ÿå¯ä»¥ä¸ºå…·ä½“æŸä¸ªåº“çš„åç§°ï¼Œç»„ååˆ™åˆ‡æ¢æ—¶é‡‡ç”¨è´Ÿè½½å‡è¡¡ç®—æ³•åˆ‡æ¢ @Service @DS(\"slave\") public class UserServiceImpl implements UserService { @Autowired private JdbcTemplate jdbcTemplate; // ä½¿ç”¨slaveæ•°æ®æº public List selectAll() { return jdbcTemplate.queryForList(\"select * from user\"); } // ä½¿ç”¨slave_1æ•°æ®æº @Override @DS(\"slave_1\") public List selectByCondition() { return jdbcTemplate.queryForList(\"select * from user where age \u003e10\"); } } DSæ”¾åœ¨å“ªé‡Œåˆé€‚ DSä½œä¸ºåˆ‡æ¢æ•°æ®æºæ ¸å¿ƒæ³¨è§£ï¼Œæˆ‘åº”è¯¥æŠŠä»–æ³¨è§£åœ¨å“ªé‡Œåˆé€‚ï¼Ÿ\nè¿™å…¶å®æ˜¯åˆæ¬¡æ¥è§¦å¤šæ•°æ®æºçš„äººå¸¸é—®çš„é—®é¢˜ã€‚\nè¿™å…¶å®æ²¡æœ‰ä¸€å®šçš„è¦æ±‚ï¼Œåªæ˜¯æœ‰ä¸€äº›ç»éªŒä¹‹è°ˆã€‚\né¦–å…ˆå¼€å‘è€…è¦äº†è§£çš„åŸºç¡€çŸ¥è¯†æ˜¯ï¼ŒDSæ³¨è§£æ˜¯åŸºäºAOPçš„åŸç†å®ç°çš„ï¼Œaopçš„å¸¸è§å¤±æ•ˆåœºæ™¯åº”æ¸…æ¥šï¼Œæ¯”å¦‚å†…éƒ¨è°ƒç”¨å¤±æ•ˆï¼Œshiroä»£ç†å¤±æ•ˆã€‚\né€šå¸¸å»ºè®®DSæ”¾åœ¨serviceImplçš„æ–¹æ³•ä¸Šï¼Œå¦‚äº‹åŠ¡æ³¨è§£ä¸€æ ·ã€‚\næ³¨è§£åœ¨Controllerçš„æ–¹æ³•ä¸Šæˆ–ç±»ä¸Š å¹¶ä¸æ˜¯ä¸å¯ä»¥ï¼Œä½œè€…å¹¶ä¸å»ºè®®çš„åŸå› ä¸»è¦æ˜¯controllerä¸»è¦ä½œç”¨æ˜¯å‚æ•°çš„æ£€éªŒç­‰ä¸€äº›åŸºç¡€é€»è¾‘çš„å¤„ç†ï¼Œè¿™éƒ¨åˆ†æ“ä½œå¸¸å¸¸å¹¶ä¸æ¶‰åŠæ•°æ®åº“ã€‚\næ³¨è§£åœ¨serviceçš„å®ç°ç±»çš„æ–¹æ³•æˆ–ç±»ä¸Š è¿™æ˜¯ä½œè€…å»ºè®®çš„æ–¹å¼ï¼Œserviceä¸»è¦æ˜¯å¯¹ä¸šåŠ¡çš„å¤„ç†ï¼Œ åœ¨å¤æ‚çš„åœºæ™¯æ¶‰åŠè¿ç»­åˆ‡æ¢ä¸åŒçš„æ•°æ®åº“ã€‚\nå¦‚æœä½ çš„æ–¹æ³•æœ‰é€šç”¨æ€§ï¼Œå…¶ä»–serviceä¹Ÿä¼šè°ƒç”¨ä½ çš„æ–¹æ³•ã€‚ è¿™æ ·åˆ«äººå°±ä¸ç”¨é‡å¤å¤„ç†åˆ‡æ¢æ•°æ®æºã€‚\næ³¨è§£åœ¨Mapperä¸Š é€šå¸¸å¦‚æœä½ æŸä¸ªMapperå¯¹åº”çš„è¡¨åªåœ¨ç¡®å®šçš„ä¸€ä¸ªåº“ï¼Œä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯å»ºè®®åªæ³¨è§£åœ¨Mapperçš„ç±»ä¸Šã€‚\næˆ‘ä¹‹å‰å‡ºç°å¤šçº¿ç¨‹å¤±æ•ˆåœºæ™¯çš„æ—¶å€™ï¼Œå°±æ˜¯åœ¨Mapperä¸ŠåŠ äº†æ³¨è§£è§£å†³çš„ã€‚\nå…¶ä»–ä½¿ç”¨æ–¹å¼ ç»§æ‰¿æŠ½è±¡ç±»ä¸Šçš„DS\næ¯”å¦‚æˆ‘æœ‰ä¸€ä¸ªæŠ½è±¡Serviceï¼Œæˆ‘æƒ³å®ç°ç»§æ‰¿æˆ‘è¿™ä¸ªæŠ½è±¡Serviceä¸‹çš„å­Serviceçš„æ‰€æœ‰æ–¹æ³•é™¤éé‡æ–°æŒ‡å®šï¼Œéƒ½ç”¨æˆ‘æŠ½è±¡Serviceä¸Šæ³¨è§£çš„æ•°æ®æºã€‚æ˜¯å¦æ”¯æŒï¼Ÿ\nç­”ï¼šæ”¯æŒã€‚\nç»§æ‰¿æ¥å£ä¸Šçš„DS\n3.4.1å¼€å§‹æ”¯æŒï¼Œ ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸€ä¸ªç±»èƒ½å®ç°å¤šä¸ªæ¥å£ï¼Œå¦‚æœå¤šä¸ªæ¥å£éƒ½æœ‰DSä¼šå¦‚ä½•ï¼Ÿ\nä¸çŸ¥é“ï¼Œåˆ«è¿™ä¹ˆå¹²ã€‚ä¸€èˆ¬ä¸ä¼šæœ‰äººè¿™ä¹ˆå¹²å§ï¼Œæƒ³ä¸€æƒ³éƒ½çŸ¥é“ä¼šå‡ºé—®é¢˜ã€‚\nè¿æ¥æ± é›†æˆ ä¼ ç»Ÿå¤šæ•°æ®æºé›†æˆè¿æ¥æ± å¦‚æœéœ€è¦é…ç½®çš„å‚æ•°è¾ƒå¤šï¼Œåˆ™æ‰‹åŠ¨ç¼–ç é‡å¤§ï¼Œç¼–ç¨‹å¤æ‚ã€‚\ndynamic-datasourceå®ç°äº†å¸¸è§æ•°æ®æºçš„å‚æ•°é…ç½®ï¼Œæ”¯æŒå…¨å±€é…ç½®æ¯ä¸ªæ•°æ®æºç»§æ‰¿ã€‚\né€šè¿‡æœ¬ç« æ‚¨å¯ä»¥å¿«é€ŸæŒæ¡ä¸åŒè¿æ¥æ± çš„é›†æˆé…ç½®æ–¹æ¡ˆå’Œç»§æ‰¿ä¸­å¯èƒ½é‡è§çš„é—®é¢˜ã€‚\nè¿æ¥æ± å¿…è¯» æ¯ä¸ªæ•°æ®æºéƒ½æœ‰ä¸€ä¸ªtypeæ¥æŒ‡å®šè¿æ¥æ± ã€‚\næ¯ä¸ªæ•°æ®æºç”šè‡³å¯ä»¥ä½¿ç”¨ä¸åŒçš„è¿æ¥æ± ï¼Œå¦‚æ— ç‰¹æ®Šéœ€è¦å¹¶ä¸å»ºè®®ã€‚\ntype ä¸æ˜¯å¿…å¡«å­—æ®µã€‚\nåœ¨æ²¡æœ‰è®¾ç½®typeçš„æ—¶å€™ç³»ç»Ÿä¼šè‡ªåŠ¨æŒ‰ä»¥ä¸‹é¡ºåºæŸ¥æ‰¾å¹¶ä½¿ç”¨è¿æ¥æ± ï¼š\nDruid \u003e HikariCp \u003e BeeCp \u003e DBCP2 \u003e Spring Basicã€‚\nspring: datasource: dynamic: primary: db1 datasource: db1: url: jdbc:mysql://xx.xx.xx.xx:3306/dynamic username: root password: 123456 driver-class-name: com.mysql.cj.jdbc.Driver type: com.zaxxer.hikari.HikariDataSource # ä½¿ç”¨Hikaricp db2: url: jdbc:mysql://xx.xx.xx.xx:3307/dynamic username: root password: 123456 driver-class-name: com.mysql.cj.jdbc.Driver type: com.alibaba.druid.pool.DruidDataSource # ä½¿ç”¨Druid db3: url: jdbc:mysql://xx.xx.xx.xx:3308/dynamic username: root password: 123456 driver-class-name: com.mysql.cj.jdbc.Driver type: cn.beecp.BeeDataSource # ä½¿ç”¨beecp é›†æˆDruid åŸºç¡€ä»‹ç» Druid Githubï¼šç‚¹æˆ‘è·³è½¬\nDruid æ–‡æ¡£ï¼šç‚¹æˆ‘è·³è½¬\ndynamic-datasourceèƒ½ç®€å•é«˜æ•ˆå®Œæˆå¯¹Druidçš„é›†æˆå¹¶å®Œæˆå…¶å‚æ•°çš„å¤šå…ƒåŒ–é…ç½®ã€‚\nå„ä¸ªåº“å¯ä»¥ä½¿ç”¨ä¸åŒçš„æ•°æ®åº“è¿æ¥æ± ï¼Œå¦‚ masterä½¿ç”¨Druidï¼Œslaveä½¿ç”¨HikariCPã€‚\nå¦‚æœé¡¹ç›®åŒæ—¶å­˜åœ¨Druidå’ŒHikariCPå¹¶ä¸”æœªé…ç½®è¿æ¥æ± typeç±»å‹ï¼Œé»˜è®¤Druidä¼˜å…ˆäºHikariCPã€‚\né›†æˆæ­¥éª¤ 1ã€é¡¹ç›®å¼•å…¥ druid-spring-boot-starter ä¾èµ–\ncom.alibaba druid-spring-boot-starter ${version} 2ã€æ’é™¤åŸç”ŸDruidçš„å¿«é€Ÿé…ç½®ç±»\næ³¨æ„ï¼šv3.3.3åŠä»¥ä¸Š ç‰ˆæœ¬ä¸ç”¨æ’é™¤äº†ã€‚\n@SpringBootApplication(exclude = DruidDataSourceAutoConfigure.class) public class Application { public static void main(String[] args) { SpringApplication.run(Application.class, args); } } æŸäº›SpringBootçš„ç‰ˆæœ¬ä¸Šé¢å¯èƒ½æ— æ³•æ’é™¤å¯ç”¨ä»¥ä¸‹æ–¹å¼æ’é™¤ã€‚\nspring: autoconfigure: exclude: com.alibaba.druid.spring.boot.autoconfigure.DruidDataSourceAutoConfigure 3ã€å‚æ•°é…ç½®\nå¦‚æœå‚æ•°éƒ½æœªé…ç½®ï¼Œåˆ™ä¿æŒåŸç»„ä»¶é»˜è®¤å€¼ã€‚ å¦‚æœé…ç½®äº†å…¨å±€å‚æ•°ï¼Œåˆ™æ¯ä¸€ä¸ªæ•°æ®æºéƒ½ä¼šç»§æ‰¿å¯¹åº”å‚æ•°ã€‚ æ¯ä¸€ä¸ªæ•°æ®æºå¯ä»¥å•ç‹¬è®¾ç½®å‚æ•°è¦†ç›–å…¨å±€å‚æ•°ã€‚ spring: datasource: druid: stat-view-servlet: enabled: true loginUsername: admin loginPassword: 123456 dynamic: druid: # ä»¥ä¸‹æ˜¯æ”¯æŒçš„å…¨å±€é»˜è®¤å€¼ initial-size: max-active: min-idle: max-wait: time-between-eviction-runs-millis: time-between-log-stats-millis: stat-sqlmax-size: min-evictable-idle-time-millis: max-evictable-idle-time-millis: test-while-idle: test-on-borrow: test-on-return: validation-query: validation-query-timeout: use-global-datasource-stat: async-init: clear-filters-enable: reset-stat-enable: not-full-timeout-retry-count: max-wait-thread-count: fail-fast: phyTimeout-millis: keep-alive: pool-prepared-statements: init-variants: init-global-variants: use-unfair-lock: kill-when-socket-read-timeout: connection-properties: max-pool-prepared-statement-per-connection-size: init-connection-sqls: share-prepared-statements: connection-errorretry-attempts: break-after-acquire-failure: filters: stat # æ³¨æ„è¿™ä¸ªå€¼å’ŒdruidåŸç”Ÿä¸ä¸€è‡´ï¼Œé»˜è®¤å¯åŠ¨äº†stat wall: noneBaseStatementAllow: callAllow: selectAllow: selectIntoAllow: selectIntoOutfileAllow: selectWhereAlwayTrueCheck: selectHavingAlwayTrueCheck: selectUnionCheck: selectMinusCheck: selectExceptCheck: selectIntersectCheck: createTableAllow: dropTableAllow: alterTableAllow: renameTableAllow: hintAllow: lockTableAllow: startTransactionAllow: blockAllow: conditionAndAlwayTrueAllow: conditionAndAlwayFalseAllow: conditionDoubleConstAllow: conditionLikeTrueAllow: selectAllColumnAllow: deleteAllow: deleteWhereAlwayTrueCheck: deleteWhereNoneCheck: updateAllow: updateWhereAlayTrueCheck: updateWhereNoneCheck: insertAllow: mergeAllow: minusAllow: intersectAllow: replaceAllow: setAllow: commitAllow: rollbackAllow: useAllow: multiStatementAllow: truncateAllow: commentAllow: strictSyntaxCheck: constArithmeticAllow: limitZeroAllow: describeAllow: showAllow: schemaCheck: tableCheck: functionCheck: objectCheck: variantCheck: mustParameterized: doPrivilegedAllow: dir: tenantTablePattern: tenantColumn: wrapAllow: metadataAllow: conditionOpXorAllow: conditionOpBitwseAllow: caseConditionConstAllow: completeInsertValuesCheck: insertValuesCheckSize: selectLimit: stat: merge-sql: log-slow-sql: slow-sql-millis: datasource: master: username: root password: 123456 driver-class-name: com.mysql.cj.jdbc.Driver url: jdbc:mysql://xx.xx.xx.xx:3306/dynamic?characterEncoding=utf8\u0026useSSL=false druid: # ä»¥ä¸‹æ˜¯ç‹¬ç«‹å‚æ•°ï¼Œæ¯ä¸ªåº“å¯ä»¥é‡æ–°è®¾ç½® initial-size: 20 validation-query: select 1 FROM DUAL # æ¯”å¦‚oracleå°±éœ€è¦é‡æ–°è®¾ç½®è¿™ä¸ª public-key: #ï¼ˆéå…¨å±€å‚æ•°ï¼‰è®¾ç½®å³è¡¨ç¤ºå¯ç”¨åŠ å¯†,åº•å±‚ä¼šè‡ªåŠ¨å¸®ä½ é…ç½®ç›¸å…³çš„è¿æ¥å‚æ•°å’Œfilterï¼Œæ¨èä½¿ç”¨æœ¬é¡¹ç›®è‡ªå¸¦çš„åŠ å¯†æ–¹æ³•ã€‚ ä»¥ä¸‹æ˜¯æˆ‘æ›¾ç»é…ç½®è¿‡çš„ç¤ºä¾‹ï¼š\n# æ•°æ®æºé…ç½® spring: # æ’é™¤æ‰druidåŸç”Ÿçš„è‡ªåŠ¨é…ç½® autoconfigure: exclude: com.alibaba.druid.spring.boot.autoconfigure.DruidDataSourceAutoConfigure datasource: druid: # åˆå§‹è¿æ¥æ•° initialSize: 5 # æœ€å°è¿æ¥æ± æ•°é‡ minIdle: 10 # æœ€å¤§è¿æ¥æ± æ•°é‡ maxActive: 20 # é…ç½®è·å–è¿æ¥ç­‰å¾…è¶…æ—¶çš„æ—¶é—´ maxWait: 60000 # é…ç½®è¿æ¥è¶…æ—¶æ—¶é—´ connectTimeout: 30000 # é…ç½®ç½‘ç»œè¶…æ—¶æ—¶é—´ socketTimeout: 60000 # é…ç½®é—´éš”å¤šä¹…æ‰è¿›è¡Œä¸€æ¬¡æ£€æµ‹ï¼Œæ£€æµ‹éœ€è¦å…³é—­çš„ç©ºé—²è¿æ¥ï¼Œå•ä½æ˜¯æ¯«ç§’ timeBetweenEvictionRunsMillis: 60000 # é…ç½®ä¸€ä¸ªè¿æ¥åœ¨æ± ä¸­æœ€å°ç”Ÿå­˜çš„æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’ minEvictableIdleTimeMillis: 300000 # é…ç½®ä¸€ä¸ªè¿æ¥åœ¨æ± ä¸­æœ€å¤§ç”Ÿå­˜çš„æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’ maxEvictableIdleTimeMillis: 900000 # é…ç½®æ£€æµ‹è¿æ¥æ˜¯å¦æœ‰æ•ˆ validationQuery: SELECT 1 FROM DUAL testWhileIdle: true testOnBorrow: false testOnReturn: false webStatFilter: enabled: true statViewServlet: enabled: true # è®¾ç½®ç™½åå•ï¼Œä¸å¡«åˆ™å…è®¸æ‰€æœ‰è®¿é—® allow: url-pattern: /druid/* # æ§åˆ¶å°ç®¡ç†ç”¨æˆ·åå’Œå¯†ç  login-username: admin login-password: 123456 filter: stat: enabled: true # æ…¢SQLè®°å½• log-slow-sql: true slow-sql-millis: 2000 merge-sql: true wall: config: multi-statement-allow: true dynamic: druid: # åˆå§‹è¿æ¥æ•° initial-size: 5 # æœ€å°è¿æ¥æ± æ•°é‡ min-idle: 10 # æœ€å¤§è¿æ¥æ± æ•°é‡ max-active: 20 # é…ç½®è·å–è¿æ¥ç­‰å¾…è¶…æ—¶çš„æ—¶é—´ max-wait: 60000 # é…ç½®é—´éš”å¤šä¹…æ‰è¿›è¡Œä¸€æ¬¡æ£€æµ‹ï¼Œæ£€æµ‹éœ€è¦å…³é—­çš„ç©ºé—²è¿æ¥ï¼Œå•ä½æ˜¯æ¯«ç§’ time-between-eviction-runs-millis: 60000 # é…ç½®ä¸€ä¸ªè¿æ¥åœ¨æ± ä¸­æœ€å°ç”Ÿå­˜çš„æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’ min-evictable-idle-time-millis: 300000 # é…ç½®ä¸€ä¸ªè¿æ¥åœ¨æ± ä¸­æœ€å¤§ç”Ÿå­˜çš„æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’ max-evictable-idle-time-millis: 900000 # é…ç½®æ£€æµ‹è¿æ¥æ˜¯å¦æœ‰æ•ˆ validation-query: SELECT 1 FROM DUAL test-while-idle: true test-on-borrow: false test-on-return: false # æ‰“å¼€PSCacheï¼Œå¹¶æŒ‡å®šæ¯ä¸ªè¿æ¥ä¸ŠPSCacheçš„å¤§å°ã€‚ # oracleè®¾ä¸ºtrueï¼Œmysqlè®¾ä¸ºfalseã€‚åˆ†åº“åˆ†è¡¨è¾ƒå¤šæ¨èè®¾ç½®ä¸ºfalse pool-prepared-statements: false max-pool-prepared-statement-per-connection-size: 20 filters: stat # æ³¨æ„è¿™ä¸ªå€¼å’ŒdruidåŸç”Ÿä¸ä¸€è‡´ï¼Œé»˜è®¤å¯åŠ¨äº†stat stat: merge-sql: true log-slow-sql: true slow-sql-millis: 2000 primary: master # è®¾ç½®é»˜è®¤çš„æ•°æ®æºæˆ–è€…æ•°æ®æºç»„ strict: false # è®¾ç½®ä¸¥æ ¼æ¨¡å¼,é»˜è®¤falseä¸å¯åŠ¨,å¯åŠ¨ååœ¨æœªåŒ¹é…åˆ°æŒ‡å®šæ•°æ®æºæ—¶å€™å›æŠ›å‡ºå¼‚å¸¸,ä¸å¯åŠ¨ä¼šä½¿ç”¨é»˜è®¤æ•°æ®æº datasource: master: url: jdbc:mysql://192.168.56.101:3306/master?useUnicode=true\u0026characterEncoding=utf8\u0026zeroDateTimeBehavior=convertToNull\u0026useSSL=true\u0026serverTimezone=GMT%2B8 username: root password: root driver-class-name: com.mysql.cj.jdbc.Driver slave_1: url: jdbc:mysql://192.168.56.102:3306/slave_1?useUnicode=true\u0026characterEncoding=utf8\u0026zeroDateTimeBehavior=convertToNull\u0026useSSL=true\u0026serverTimezone=GMT%2B8\u0026rewriteBatchedStatements=true username: root password: root driver-class-name: com.mysql.cj.jdbc.Driver slave_2: url: jdbc:mysql://192.168.56.103:3306/slave_2?useUnicode=true\u0026characterEncoding=utf8\u0026zeroDateTimeBehavior=convertToNull\u0026useSSL=true\u0026serverTimezone=GMT%2B8\u0026rewriteBatchedStatements=true username: root password: root driver-class-name: com.mysql.cj.jdbc.Driver druid: # ä»¥ä¸‹å‚æ•°é’ˆå¯¹æ¯ä¸ªåº“å¯ä»¥é‡æ–°è®¾ç½®druidå‚æ•° initial-size: validation-query: select 1 FROM DUAL # æ¯”å¦‚oracleå°±éœ€è¦é‡æ–°è®¾ç½®è¿™ä¸ª public-key: #ï¼ˆéå…¨å±€å‚æ•°ï¼‰è®¾ç½®å³è¡¨ç¤ºå¯ç”¨åŠ å¯†,åº•å±‚ä¼šè‡ªåŠ¨å¸®ä½ é…ç½®ç›¸å…³çš„è¿æ¥å‚æ•°å’Œfilterã€‚ å¦‚ä¸Šå³å¯é…ç½®è®¿é—®ç”¨æˆ·å’Œå¯†ç ï¼Œè®¿é—® http://ip:ç«¯å£/druid/index.html æŸ¥çœ‹druidç›‘æ§ã€‚\nç¤ºä¾‹é¡¹ç›® ç‚¹æˆ‘è·³è½¬\næ ¸å¿ƒæºç  Druidæ•°æ®æºåˆ›å»ºå™¨ï¼šç‚¹æˆ‘è·³è½¬\nDruidå‚æ•°æºç ï¼šç‚¹æˆ‘è·³è½¬\né›†æˆHikariCP åŸºç¡€ä»‹ç» HikariCP Githubï¼šç‚¹æˆ‘è·³è½¬\nHikariCP æ–‡æ¡£ï¼šç‚¹æˆ‘è·³è½¬\né›†æˆæ­¥éª¤ 1ã€é¡¹ç›®å¼•å…¥ HikariCP ä¾èµ–\nSpringBoot2.x.xé»˜è®¤å¼•å…¥äº†HikariCPï¼Œé™¤éå¯¹ç‰ˆæœ¬æœ‰è¦æ±‚æ— éœ€å†æ¬¡å¼•å…¥ã€‚\nSpringBoot 1.5.xéœ€æ‰‹åŠ¨å¼•å…¥ï¼Œå¯¹åº”çš„ç‰ˆæœ¬è¯·æ ¹æ®è‡ªå·±ç¯å¢ƒå’ŒHikariCPå®˜æ–¹æ–‡æ¡£è‡ªè¡Œé€‰æ‹©ã€‚\ncom.zaxxer HikariCP ${version} 2ã€å‚æ•°é…ç½®\nå¦‚æœå‚æ•°éƒ½æœªé…ç½®ï¼Œåˆ™ä¿æŒåŸç»„ä»¶é»˜è®¤å€¼ã€‚ å¦‚æœé…ç½®äº†å…¨å±€å‚æ•°ï¼Œåˆ™æ¯ä¸€ä¸ªæ•°æ®æºéƒ½ä¼šç»§æ‰¿å¯¹åº”å‚æ•°ã€‚ æ¯ä¸€ä¸ªæ•°æ®æºå¯ä»¥å•ç‹¬è®¾ç½®å‚æ•°è¦†ç›–å…¨å±€å‚æ•°ã€‚ ç‰¹åˆ«æ³¨æ„ï¼ŒhikaricpåŸç”Ÿè®¾ç½®æŸäº›å­—æ®µåå’Œdynamic-datasourceä¸ä¸€è‡´ï¼Œdynamic-datasourceæ˜¯æ ¹æ®å‚æ•°åå°„è®¾ç½®ï¼Œè€ŒåŸç”Ÿhikaricpå­—æ®µåç§°å’Œsetåç§°ä¸ä¸€è‡´ã€‚\nspring: datasource: dynamic: hikari: # å…¨å±€hikariCPå‚æ•°ï¼Œæ‰€æœ‰å€¼å’Œé»˜è®¤ä¿æŒä¸€è‡´ã€‚(ç°å·²æ”¯æŒçš„å‚æ•°å¦‚ä¸‹,ä¸æ¸…æ¥šå«ä¹‰ä¸è¦ä¹±è®¾ç½®) catalog: connection-timeout: validation-timeout: idle-timeout: leak-detection-threshold: max-lifetime: max-pool-size: min-idle: initialization-fail-timeout: connection-init-sql: connection-test-query: dataSource-class-name: dataSource-jndi-name: schema: transaction-isolation-name: is-auto-commit: is-read-only: is-isolate-internal-queries: is-register-mbeans: is-allow-pool-suspension: data-source-properties: health-check-properties: datasource: master: username: root password: 123456 driver-class-name: com.mysql.cj.jdbc.Driver url: jdbc:mysql://xx.xx.xx.xx:3306/dynamic?characterEncoding=utf8\u0026useSSL=false hikari: # ä»¥ä¸‹å‚æ•°é’ˆå¯¹æ¯ä¸ªåº“å¯ä»¥é‡æ–°è®¾ç½®hikariå‚æ•° max-pool-size: idle-timeout: # ...... å¸¸è§é—®é¢˜ Failed to validate connection com.mysql.jdbc.JDBC4Connection@xxxxx (No operations allowed after connection closed.)\nhttps://github.com/brettwooldridge/HikariCP/issues/1034\næ ¸å¿ƒæ„æ€å°±æ˜¯HikariCPè¦è®¾ç½® connection-test-query å¹¶ä¸”max-lifetimeè¦å°äºmysqlçš„é»˜è®¤æ—¶é—´ã€‚\næ ¸å¿ƒæºç  HikariCPæ•°æ®æºåˆ›å»ºå™¨ï¼šç‚¹æˆ‘è·³è½¬\nHikariCPå‚æ•°é…ç½®ç±»ï¼šç‚¹æˆ‘è·³è½¬\nç¬¬ä¸‰æ–¹é›†æˆ é€šè¿‡æœ¬ç« æ‚¨å¯ä»¥æŒæ¡æ•°æ®æºåœ¨é›†æˆMybatisPlusï¼ŒQuartzï¼ŒShardingJdbcçš„æ–¹æ¡ˆã€‚\né›†æˆMybatisPlus åŸºç¡€ä»‹ç» MybatisPlus Githubï¼šç‚¹æˆ‘è·³è½¬\nMybatisPlus æ–‡æ¡£ï¼š ç‚¹æˆ‘è·³è½¬\nåªè¦å¼•å…¥äº†MybatisPlusç›¸å…³jaråŒ…ï¼Œé¡¹ç›®è‡ªåŠ¨é›†æˆï¼Œå…¼å®¹MybatisPlus2.xå’Œ3.xçš„ç‰ˆæœ¬ã€‚\né›†æˆæ­¥éª¤ 1ã€é¡¹ç›®å¼•å…¥ Mybatis-Plus ä¾èµ–\ncom.baomidou mybatis-plus-boot-starter ${version} 2ã€ä½¿ç”¨DSæ³¨è§£è¿›è¡Œåˆ‡æ¢æ•°æ®æº\n@Service @DS(\"mysql\") public class UserServiceImpl extends ServiceImpl\u003cUserMapper, User\u003e implements UserService { @DS(\"oracle\") publid void addUser(User user){ //do something baseMapper.insert(user); } } 3ã€åˆ†é¡µé…ç½®\n@Bean public MybatisPlusInterceptor mybatisPlusInterceptor() { MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor(); //å¦‚æœæ˜¯ä¸åŒç±»å‹çš„åº“ï¼Œè¯·ä¸è¦æŒ‡å®šDbTypeï¼Œå…¶ä¼šè‡ªåŠ¨åˆ¤æ–­ã€‚ interceptor.addInnerInterceptor(new PaginationInnerInterceptor()); // interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL)); return interceptor; } æ³¨æ„äº‹é¡¹ MybatisPluså†…ç½®çš„ServiceImplåœ¨æ–°å¢ï¼Œæ›´æ”¹ï¼Œåˆ é™¤ç­‰ä¸€äº›æ–¹æ³•ä¸Šè‡ªå¸¦äº‹ç‰©å¯¼è‡´ä¸èƒ½åˆ‡æ¢æ•°æ®æºã€‚\nè§£å†³æ–¹æ³•ï¼š\næ–¹æ³•1ï¼šå¤åˆ¶ServiceImplå‡ºæ¥ä¸ºè‡ªå·±çš„MyServiceImplï¼Œå¹¶å»æ‰æ‰€æœ‰äº‹åŠ¡æ³¨è§£ã€‚\næ–¹æ³•2ï¼šåˆ›å»ºä¸€ä¸ªæ–°æ–¹æ³•ï¼Œå¹¶åœ¨æ­¤æ–¹æ³•ä¸ŠåŠ DSæ³¨è§£. å¦‚ä¸Šé¢çš„addUseræ–¹æ³•ã€‚\nFAQ ä¸ºä»€ä¹ˆè¦å•ç‹¬æ‹¿å‡ºæ¥è¯´å’ŒMybatisPlusçš„é›†æˆï¼Ÿ\nå› ä¸ºMybatisPlusé‡å†™äº†ä¸€äº›æ ¸å¿ƒç±»ï¼Œå¿…é¡»é€šè¿‡è§£æè·å¾—çœŸå®çš„ä»£ç†å¯¹è±¡ã€‚\nå¦‚æœè‡ªå·±å†™å¤šæ•°æ®æºï¼Œåˆ™å¾ˆéš¾å®Œæˆä¸mpçš„é›†æˆã€‚\næ ¸å¿ƒè§£ææºç ï¼šç‚¹æˆ‘è·³è½¬\nç¤ºä¾‹é¡¹ç›® ç‚¹æˆ‘è·³è½¬\nå…¶ä»–é›†æˆ é›†æˆP6spyã€é›†æˆQuartzã€é›†æˆShardingJdbc\nç”±äºä»¥ä¸Šåœºæ™¯æš‚æ—¶æ²¡ç”¨åˆ°ï¼Œæ–‡ç« ä¸­æš‚æ—¶ä¸ä½“ç°äº†ï¼Œå¦‚æœ‰ç”¨åˆ°ï¼Œåé¢ä¼šè¡¥å……ä¸Šã€‚\nè¿›é˜¶ä½¿ç”¨ åŠ¨æ€æ·»åŠ ç§»é™¤æ•°æ®æºï¼šæŒ‡åœ¨ç³»ç»Ÿè¿è¡Œè¿‡ç¨‹ä¸­åŠ¨æ€çš„æ·»åŠ æ•°æ®æºï¼Œåˆ é™¤æ•°æ®æºï¼Œå¤šä½¿ç”¨äºåŸºäºæ•°æ®åº“çš„å¤šç§Ÿæˆ·ç³»ç»Ÿã€‚\nåŠ¨æ€è§£ææ•°æ®æºï¼šæŒ‡æ•°æ®æºåˆ‡æ¢æ˜¯ä¸å›ºå®šçš„ï¼Œå¯ä»¥æ ¹æ®åŸŸåï¼Œæ ¹æ®headerå‚æ•°ï¼Œæ ¹æ®sessionå‚æ•°ï¼Œæ ¹æ®æ–¹æ³•å˜é‡ç­‰æ¥åŠ¨æ€åˆ‡æ¢ã€‚å¤šä½¿ç”¨äºå¤šç§Ÿæˆ·ç³»ç»Ÿï¼Œæ”¯æŒæ‰©å±•ã€‚\næ•°æ®åº“åŠ å¯†ï¼šæŒ‡æ•°æ®åº“çš„urlï¼Œusernameï¼Œpasswordéœ€è¦åŠ å¯†ï¼Œé•¿ç”¨äºå®‰å…¨æ€§è¾ƒé«˜ç³»ç»Ÿï¼Œä¸è®©æ™®é€šå¼€å‘é€šè¿‡é…ç½®çŸ¥é“ç”Ÿäº§åº“çš„è¿æ¥é…ç½®ã€‚\nå¯åŠ¨åˆå§‹åŒ–è„šæœ¬ï¼šæŒ‡æ•°æ®æºå¯åŠ¨çš„æ—¶å€™å¯ä»¥æ‰§è¡Œschemaå’Œdataçš„è„šæœ¬æ¥åˆå§‹åŒ–ç»“æ„å’Œæ•°æ®ï¼Œdynamic-datasourceç»„ä»¶æ”¯æŒæ¯ä¸ªæ•°æ®æºåŠ è½½ä¸åŒçš„schemaå’Œdataã€‚\nè‡ªåŠ¨è¯»å†™åˆ†ç¦»ï¼šé€‚ç”¨äºmybatisç¯å¢ƒï¼ŒåŸºäºmybatisæ’ä»¶å®ç°æ— æ³¨è§£è‡ªåŠ¨è¯»å†™åˆ†ç¦»ã€‚\næ‡’å¯åŠ¨æ•°æ®æºï¼šæŒ‡é…ç½®çš„æ•°æ®æºä¸ç«‹å³å¯åŠ¨ï¼Œç­‰éœ€è¦å»ºç«‹è¿æ¥çš„æ—¶å€™å†çœŸæ­£åˆå§‹åŒ–è¿æ¥æ± ã€‚\næ— æ•°æ®æºå¯åŠ¨ï¼šæŒ‡å¯åŠ¨çš„æ—¶å€™ä¸é…ç½®ä»»ä½•æ•°æ®æºï¼Œå…¨é åæœŸç³»ç»ŸåŠ¨æ€æ·»åŠ ã€‚\næ‰‹åŠ¨åˆ‡æ¢æ•°æ®æºï¼šæŒ‡æŸäº›æƒ…å†µæ— æ³•æ ¹æ®æ³¨è§£åˆ‡æ¢ï¼Œé€šè¿‡å·¥å…·ç±»æ‰‹åŠ¨åˆ‡æ¢æ•°æ®æºã€‚\nåŠ¨æ€æ·»åŠ ç§»é™¤æ•°æ®æº åŸºç¡€ä»‹ç» ä¸»è¦åœ¨å¤šç§Ÿæˆ·åœºæ™¯ä¸­ï¼Œå¸¸å¸¸æ–°çš„ä¸€ä¸ªç§Ÿæˆ·è¿›æ¥éœ€è¦åŠ¨æ€çš„æ·»åŠ ä¸€ä¸ªæ•°æ®æºåˆ°åº“ä¸­ï¼Œä½¿å¾—ç³»ç»Ÿä¸ç”¨é‡å¯å³å¯åˆ‡æ¢æ•°æ®æºã€‚\nä½¿ç”¨æ­¥éª¤ import com.baomidou.dynamic.datasource.DynamicRoutingDataSource; import com.baomidou.dynamic.datasource.creator.*; import com.baomidou.dynamic.datasource.spring.boot.autoconfigure.DataSourceProperty; import com.baomidou.samples.ds.dto.DataSourceDTO; import io.swagger.annotations.Api; import io.swagger.annotations.ApiOperation; import org.springframework.beans.BeanUtils; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.validation.annotation.Validated; import org.springframework.web.bind.annotation.*; import javax.sql.DataSource; import java.util.Set; @RestController @RequestMapping(\"/datasources\") @Api(tags = \"æ·»åŠ åˆ é™¤æ•°æ®æº\") public class DataSourceController { @Autowired private DataSource dataSource; // private final DataSourceCreator dataSourceCreator; // 3.3.1åŠä»¥ä¸‹ç‰ˆæœ¬ä½¿ç”¨è¿™ä¸ªé€šç”¨ï¼Œå¼ºçƒˆæ¨èsb2ç”¨æˆ·è‡³å°‘å‡çº§åˆ°3.5.2ç‰ˆæœ¬ @Autowired private DefaultDataSourceCreator dataSourceCreator; @Autowired private BasicDataSourceCreator basicDataSourceCreator; @Autowired private JndiDataSourceCreator jndiDataSourceCreator; @Autowired private DruidDataSourceCreator druidDataSourceCreator; @Autowired private HikariDataSourceCreator hikariDataSourceCreator; @Autowired private BeeCpDataSourceCreator beeCpDataSourceCreator; @Autowired private Dbcp2DataSourceCreator dbcp2DataSourceCreator; @GetMapping @ApiOperation(\"è·å–å½“å‰æ‰€æœ‰æ•°æ®æº\") public Set\u003cString\u003e now() { DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource; return ds.getDataSources().keySet(); } // é€šç”¨æ•°æ®æºä¼šæ ¹æ®mavenä¸­é…ç½®çš„è¿æ¥æ± æ ¹æ®é¡ºåºä¾æ¬¡é€‰æ‹©ã€‚ // é»˜è®¤çš„é¡ºåºä¸ºdruid\u003ehikaricp\u003ebeecp\u003edbcp\u003espring basic @PostMapping(\"/add\") @ApiOperation(\"é€šç”¨æ·»åŠ æ•°æ®æºï¼ˆæ¨èï¼‰\") public Set\u003cString\u003e add(@Validated @RequestBody DataSourceDTO dto) { DataSourceProperty dataSourceProperty = new DataSourceProperty(); BeanUtils.copyProperties(dto, dataSourceProperty); DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource; DataSource dataSource = dataSourceCreator.createDataSource(dataSourceProperty); ds.addDataSource(dto.getPoolName(), dataSource); return ds.getDataSources().keySet(); } @PostMapping(\"/addBasic(å¼ºçƒˆä¸æ¨èï¼Œé™¤äº†ç”¨äº†é©¬ä¸Šç§»é™¤)\") @ApiOperation(value = \"æ·»åŠ åŸºç¡€æ•°æ®æº\", notes = \"è°ƒç”¨Springbootå†…ç½®æ–¹æ³•åˆ›å»ºæ•°æ®æºï¼Œå…¼å®¹1,2\") public Set\u003cString\u003e addBasic(@Validated @RequestBody DataSourceDTO dto) { DataSourceProperty dataSourceProperty = new DataSourceProperty(); BeanUtils.copyProperties(dto, dataSourceProperty); DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource; DataSource dataSource = basicDataSourceCreator.createDataSource(dataSourceProperty); ds.addDataSource(dto.getPoolName(), dataSource); return ds.getDataSources().keySet(); } @PostMapping(\"/addJndi\") @ApiOperation(\"æ·»åŠ JNDIæ•°æ®æº\") public Set\u003cString\u003e addJndi(String pollName, String jndiName) { DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource; DataSource dataSource = jndiDataSourceCreator.createDataSource(jndiName); ds.addDataSource(poolName, dataSource); return ds.getDataSources().keySet(); } @PostMapping(\"/addDruid\") @ApiOperation(\"åŸºç¡€Druidæ•°æ®æº\") public Set\u003cString\u003e addDruid(@Validated @RequestBody DataSourceDTO dto) { DataSourceProperty dataSourceProperty = new DataSourceProperty(); BeanUtils.copyProperties(dto, dataSourceProperty); dataSourceProperty.setLazy(true); DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource; DataSource dataSource = druidDataSourceCreator.createDataSource(dataSourceProperty); ds.addDataSource(dto.getPoolName(), dataSource); return ds.getDataSources().keySet(); } @PostMapping(\"/addHikariCP\") @ApiOperation(\"åŸºç¡€HikariCPæ•°æ®æº\") public Set\u003cString\u003e addHikariCP(@Validated @RequestBody DataSourceDTO dto) { DataSourceProperty dataSourceProperty = new DataSourceProperty(); BeanUtils.copyProperties(dto, dataSourceProperty); dataSourceProperty.setLazy(true); // 3.4.0ç‰ˆæœ¬ä»¥ä¸‹å¦‚æœæœ‰æ­¤å±æ€§ï¼Œéœ€æ‰‹åŠ¨è®¾ç½®ï¼Œä¸ç„¶ä¼šç©ºæŒ‡é’ˆã€‚ DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource; DataSource dataSource = hikariDataSourceCreator.createDataSource(dataSourceProperty); ds.addDataSource(dto.getPoolName(), dataSource); return ds.getDataSources().keySet(); } @PostMapping(\"/addBeeCp\") @ApiOperation(\"åŸºç¡€BeeCpæ•°æ®æº\") public Set\u003cString\u003e addBeeCp(@Validated @RequestBody DataSourceDTO dto) { DataSourceProperty dataSourceProperty = new DataSourceProperty(); BeanUtils.copyProperties(dto, dataSourceProperty); dataSourceProperty.setLazy(true); // 3.4.0ç‰ˆæœ¬ä»¥ä¸‹å¦‚æœæœ‰æ­¤å±æ€§ï¼Œéœ€æ‰‹åŠ¨è®¾ç½®ï¼Œä¸ç„¶ä¼šç©ºæŒ‡é’ˆã€‚ DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource; DataSource dataSource = beeCpDataSourceCreator.createDataSource(dataSourceProperty); ds.addDataSource(dto.getPoolName(), dataSource); return ds.getDataSources().keySet(); } @PostMapping(\"/addDbcp\") @ApiOperation(\"åŸºç¡€Dbcpæ•°æ®æº\") public Set\u003cString\u003e addDbcp(@Validated @RequestBody DataSourceDTO dto) { DataSourceProperty dataSourceProperty = new DataSourceProperty(); BeanUtils.copyProperties(dto, dataSourceProperty); dataSourceProperty.setLazy(true); // 3.4.0ç‰ˆæœ¬ä»¥ä¸‹å¦‚æœæœ‰æ­¤å±æ€§ï¼Œéœ€æ‰‹åŠ¨è®¾ç½®ï¼Œä¸ç„¶ä¼šç©ºæŒ‡é’ˆã€‚ DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource; DataSource dataSource = dbcp2DataSourceCreator.createDataSource(dataSourceProperty); ds.addDataSource(dto.getPoolName(), dataSource); return ds.getDataSources().keySet(); } @DeleteMapping @ApiOperation(\"åˆ é™¤æ•°æ®æº\") public String remove(String name) { DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource; ds.removeDataSource(name); return \"åˆ é™¤æˆåŠŸ\"; } } ç¤ºä¾‹é¡¹ç›® ç‚¹æˆ‘è·³è½¬\næºç åˆ†æ public interface DataSourceCreator { /** * é€šè¿‡å±æ€§åˆ›å»ºæ•°æ®æº * * @param dataSourceProperty æ•°æ®æºå±æ€§ * @return è¢«åˆ›å»ºçš„æ•°æ®æº */ DataSource createDataSource(DataSourceProperty dataSourceProperty); /** * å½“å‰åˆ›å»ºå™¨æ˜¯å¦æ”¯æŒæ ¹æ®æ­¤å±æ€§åˆ›å»º * * @param dataSourceProperty æ•°æ®æºå±æ€§ * @return æ˜¯å¦æ”¯æŒ */ boolean support(DataSourceProperty dataSourceProperty); } DataSourceCreatoræ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®šä¹‰äº†æ ¹æ®å‚æ•°åˆ›å»ºæ•°æ®æºçš„æ¥å£ã€‚\nå…¶ä»–creatorå®ç°æ­¤æ¥å£ï¼Œdynamic-datasourceé¡¹ç›®æš‚æ—¶å®ç°äº†Druidå’ŒHikaricpçš„ç­‰è¿æ¥æ± çš„å®ç°ã€‚\nBasicDataSourceCreator æ˜¯è°ƒç”¨SpringåŸç”Ÿçš„åˆ›å»ºæ–¹å¼ï¼Œåªæ”¯æŒæœ€æœ€åŸå§‹çš„åŸºç¡€é…ç½®ã€‚\nDefaultDataSourceCreator æ˜¯ä¸€ä¸ªé€šç”¨çš„åˆ›å»ºå™¨ï¼Œå…¶æ ¹æ®ç¯å¢ƒè‡ªåŠ¨é€‰æ‹©è¿æ¥æ± ã€‚\nåŠ¨æ€è§£ææ•°æ®æº åŸºç¡€ä»‹ç» é»˜è®¤æœ‰ä¸‰ä¸ªèŒè´£é“¾æ¥å¤„ç†åŠ¨æ€å‚æ•°è§£æå™¨ header -\u003e session -\u003e spel\næ‰€æœ‰ä»¥ # å¼€å¤´çš„å‚æ•°éƒ½ä¼šä»å‚æ•°ä¸­è·å–æ•°æ®æº\n@DS(\"#session.tenantName\") // ä»sessionè·å– public List selectSpelBySession() { return userMapper.selectUsers(); } @DS(\"#header.tenantName\") // ä»headerè·å– public List selectSpelByHeader() { return userMapper.selectUsers(); } @DS(\"#tenantName\") // ä½¿ç”¨spelä»å‚æ•°è·å– public List selectSpelByKey(String tenantName) { return userMapper.selectUsers(); } @DS(\"#user.tenantName\") // ä½¿ç”¨spelä»å¤æ‚å‚æ•°è·å– public List selecSpelByTenant(User user) { return userMapper.selectUsers(); } å¦‚ä½•æ‰©å±• æˆ‘æƒ³ä»cookieä¸­è·å–å‚æ•°è§£æ? æˆ‘æƒ³ä»å…¶ä»–ç¯å¢ƒå±æ€§ä¸­æ¥è®¡ç®—? å‚è€ƒheaderè§£æå™¨ï¼Œç»§æ‰¿DsProcessorï¼Œå¦‚æœmatchesè¿”å›trueåˆ™åŒ¹é…æˆåŠŸï¼Œè°ƒç”¨doDetermineDatasourceè¿”å›åŒ¹é…åˆ°çš„æ•°æ®æºï¼Œå¦åˆ™è·³åˆ°ä¸‹ä¸€ä¸ªè§£æå™¨ã€‚\n1ã€è‡ªå®šä¹‰ä¸€ä¸ªå¤„ç†å™¨\npublic class DsHeaderProcessor extends DsProcessor { private static final String HEADER_PREFIX = \"#header\"; @Override public boolean matches(String key) { return key.startsWith(HEADER_PREFIX); } @Override public String doDetermineDatasource(MethodInvocation invocation, String key) { HttpServletRequest request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest(); return request.getHeader(key.substring(8)); } } 2ã€é‡å†™å®Œåé‡æ–°æ³¨å…¥ä¸€ä¸ªæ ¹æ®è‡ªå·±è§£æé¡ºåºçš„è§£æå¤„ç†å™¨\n@Configuration public class MyDynamicDataSourceConfig{ @Bean public DsProcessor dsProcessor() { DsHeaderProcessor headerProcessor = new DsHeaderProcessor(); DsSessionProcessor sessionProcessor = new DsSessionProcessor(); DsSpelExpressionProcessor spelExpressionProcessor = new DsSpelExpressionProcessor(); headerProcessor.setNextProcessor(sessionProcessor); sessionProcessor.setNextProcessor(spelExpressionProcessor); return headerProcessor; } } æ³¨æ„ å¦‚æœåœ¨Mapperæ¥å£ä¸‹é¢çš„æ–¹æ³•ä½¿ç”¨ï¼š\npublic interface UserMapper{ // å‰ç¼€å¯ä»¥æ˜¯p0,a0 @DS(\"#p0.tenantName\") public List selecSpelByTenant(User user); } å¯¹äºåœ¨æ¥å£ä¸‹é¢çš„ä½¿ç”¨, ç”±äºç¼–è¯‘å™¨çš„é»˜è®¤é…ç½®æ²¡æœ‰å°†æ¥å£å‚æ•°çš„å…ƒæ•°æ®å†™å…¥å­—èŠ‚ç æ–‡ä»¶ä¸­ æ‰€ä»¥spring elä¼šæ— æ³•è¯†åˆ«å‚æ•°åç§°, åªèƒ½ç”¨é»˜è®¤çš„å‚æ•°å‘½åæ–¹å¼\nç¬¬ä¸€ä¸ªå‚æ•°: p0ï¼Œa0,(åŠ å…¥-parametersåï¼Œå¯ä»¥ä½¿ç”¨å‚æ•°å…·ä½“çš„åå­—ï¼Œä¾‹å¦‚è¿™é‡Œçš„#user) ç¬¬äºŒä¸ªå‚æ•°: p1ï¼Œa1 ç¬¬ä¸‰ä¸ªå‚æ•°: P2,ï¼Œa2 å¯ä»¥é€šè¿‡ä¿®æ”¹mavené…ç½®å’Œjavaç¼–è¯‘é…ç½®å°†æ¥å£å‚æ•°ä¿¡æ¯å†™å…¥å­—èŠ‚ç æ–‡ä»¶\norg.apache.maven.plugins maven-compiler-plugin 3.6.2 ${java.version} ${java.version} true idea javaç¼–è¯‘é…ç½®: -parameters\njava æ”¯æŒ-parametersçš„æœ€ä½ç‰ˆæœ¬ä¸º 1.8\næ•°æ®åº“åŠ å¯† åŸºç¡€ä»‹ç» åœ¨ä¸€äº›é¡¹ç›®ä¸­ï¼Œæœ‰å¯¹æ•°æ®åº“å…³é”®å­—æ®µåŠ å¯†çš„éœ€æ±‚ï¼Œå¤§å®¶ç†Ÿæ‚‰çš„æ˜¯Druidçš„åŠ å¯†æ–¹å¼ã€‚\nåœ¨è¿æ¥æ± é›†æˆä¸­çš„Druidç« èŠ‚é‡Œæœ‰å¯¹åº”çš„åŠ å¯†æ–¹å¼ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä¸ç”¨Druidä¹Ÿæƒ³ç”¨åŠ å¯†å‘¢ï¼Ÿ\næ‰€ä»¥ä½œè€…copyäº†Druidçš„åŠ å¯†ç›¸å…³æºç ï¼Œå˜¿å˜¿ã€‚\ndynamic-datasourceé¡¹ç›®ä¹Ÿæ”¯æŒæ”¯æŒurl , username, password çš„åŠ å¯†ã€‚\nä½¿ç”¨çš„RASåŠ å¯†ï¼Œç›¸å…³åŸç†æ–‡ç«  https://www.cnblogs.com/pcheng/p/9629621.htmlã€‚\nç®€å•æ¥è¯´å°±æ˜¯ç”Ÿæˆä¸¤æŠŠé’¥åŒ™ï¼Œç§é’¥åŠ å¯†ï¼Œå…¬é’¥è§£å¯†ã€‚\nå…¬é’¥å¯ä»¥å‘å¸ƒå‡ºå»ï¼Œè§£å¯†ä¹Ÿæ˜¯ç”¨çš„å…¬é’¥ã€‚\nå…·ä½“ä½¿ç”¨ 1ã€è·å¾—åŠ å¯†å­—ç¬¦ä¸²\nimport com.baomidou.dynamic.datasource.toolkit.CryptoUtils; public class Demo { public static void main(String[] args) throws Exception { String password = \"123456\"; // ä½¿ç”¨é»˜è®¤çš„publicKey ï¼Œå»ºè®®è¿˜æ˜¯ä½¿ç”¨ä¸‹é¢çš„è‡ªå®šä¹‰ String encodePassword = CryptoUtils.encrypt(password); System.out.println(encodePassword); } // è‡ªå®šä¹‰publicKey public static void main(String[] args) throws Exception { String[] arr = CryptoUtils.genKeyPair(512); System.out.println(\"privateKey: \" + arr[0]); System.out.println(\"publicKey: \" + arr[1]); System.out.println(\"url: \" + CryptoUtils.encrypt(arr[0], \"jdbc:mysql://127.0.0.1:3306/order\")); System.out.println(\"username: \" + CryptoUtils.encrypt(arr[0], \"root\")); System.out.println(\"password: \" + CryptoUtils.encrypt(arr[0], \"123456\")); } } 2ã€é…ç½®åŠ å¯†yml\nENC(xxx) ä¸­åŒ…è£¹çš„xxxå³ä¸ºä½¿ç”¨ä¸Šé¢åŠ å¯†æ–¹æ³•åç”Ÿæˆçš„å­—ç¬¦ä¸²\nspring: datasource: dynamic: public-key: # æœ‰é»˜è®¤å€¼ï¼Œå¼ºçƒˆå»ºè®®æ›´æ¢ datasource: master: url: ENC(xxx) username: ENC(xxx) password: ENC(xxx) driver-class-name: com.mysql.cj.jdbc.Driver public-key: # æ¯ä¸ªæ•°æ®æºå¯ä»¥ç‹¬ç«‹è®¾ç½®ï¼Œæ²¡æœ‰å°±ç»§æ‰¿ä¸Šé¢çš„ã€‚ è‡ªå®šä¹‰è§£å¯† ä¸€äº›å…¬å¸è¦æ±‚ä½¿ç”¨è‡ªå·±çš„æ–¹å¼åŠ å¯†ï¼Œè§£å¯†ã€‚\nä»3.5.0ç‰ˆæœ¬å¼€å§‹ï¼Œæ‰©å±•äº†ä¸€ä¸ªeventï¼Œç”¨æˆ·è‡ªè¡Œå®ç°æ³¨å…¥å³å¯ã€‚\npublic interface DataSourceInitEvent { /** * è¿æ¥æ± åˆ›å»ºå‰æ‰§è¡Œï¼ˆå¯ç”¨äºå‚æ•°è§£å¯†ï¼‰ * * @param dataSourceProperty æ•°æ®æºåŸºç¡€ä¿¡æ¯ */ void beforeCreate(DataSourceProperty dataSourceProperty); /** * è¿æ¥æ± åˆ›å»ºåæ‰§è¡Œ * * @param dataSource è¿æ¥æ±  */ void afterCreate(DataSource dataSource); } é»˜è®¤çš„å®ç°æ˜¯EncDataSourceInitEventï¼Œå³ENCæ–¹å¼çš„ã€‚\nä¸ºä»€ä¹ˆä¸æ˜¯å…¬é’¥åŠ å¯†ï¼Œç§é’¥è§£å¯† æ ¹æ®RSAçš„è®¾è®¡ï¼Œå¤§éƒ¨åˆ†äººä¼šè®¤ä¸ºåº”è¯¥æ˜¯å…¬é’¥åŠ å¯†ï¼Œç§é’¥è§£å¯†ã€‚ ä¸ºä»€ä¹ˆDruidè®¾è®¡ç›¸åï¼Ÿ\nå»ºè®®æ›´é«˜çš„å®‰å…¨ï¼Œå¯ä»¥æŠŠpublicKeyåœ¨å¯åŠ¨æ—¶å€™ä¼ è¿›å»ï¼Œæˆ–è€…é…ç½®ä¸­å¿ƒé…å¥½ï¼Œä¸è®©æ™®é€šå¼€å‘æ¥è§¦åˆ°å°±å¥½ã€‚\næŸ¥è¯¢äº†Druidçš„ISSUEå’Œä¸€äº›æ–‡ç« ï¼š\n1ã€Druidä½œè€…wenshaoè‡ªå·±çš„å›ç­”ï¼šç‚¹æˆ‘è·³è½¬\n2ã€çŸ¥ä¹ä¸€äº›æ–‡ç« ç‰‡æ®µ\nå¯åŠ¨åˆå§‹åŒ–æ‰§è¡Œè„šæœ¬ 3.5.0 ä¹‹å‰ç‰ˆæœ¬\nspring: datasource: dynamic: primary: order datasource: order: # åŸºç¡€é…ç½®çœç•¥... schema: db/order/schema.sql # é…ç½®åˆ™ç”Ÿæ•ˆ,è‡ªåŠ¨åˆå§‹åŒ–è¡¨ç»“æ„ data: db/order/data.sql # é…ç½®åˆ™ç”Ÿæ•ˆ,è‡ªåŠ¨åˆå§‹åŒ–æ•°æ® continue-on-error: true # é»˜è®¤true,åˆå§‹åŒ–å¤±è´¥æ˜¯å¦ç»§ç»­ separator: \";\" # sqlé»˜è®¤åˆ†å·åˆ†éš”ç¬¦ï¼Œä¸€èˆ¬æ— éœ€æ›´æ”¹ product: schema: classpath*:db/product/schema.sql data: classpath*:db/product/data.sql user: schema: classpath*:db/user/schema/**/*.sql data: classpath*:db/user/data/**/*.sql 3.5.0ï¼ˆå«ï¼‰ ä¹‹åç‰ˆæœ¬ (å±‚çº§å¤šäº†ä¸€å±‚initï¼Œä¿æŒå’Œæ–°ç‰ˆspringbootä¸€è‡´)\nspring: datasource: dynamic: primary: order datasource: order: # åŸºç¡€é…ç½®çœç•¥... init: schema: db/order/schema.sql # é…ç½®åˆ™ç”Ÿæ•ˆ,è‡ªåŠ¨åˆå§‹åŒ–è¡¨ç»“æ„ data: db/order/data.sql # é…ç½®åˆ™ç”Ÿæ•ˆ,è‡ªåŠ¨åˆå§‹åŒ–æ•°æ® continue-on-error: true # é»˜è®¤true,åˆå§‹åŒ–å¤±è´¥æ˜¯å¦ç»§ç»­ separator: \";\" # sqlé»˜è®¤åˆ†å·åˆ†éš”ç¬¦ï¼Œä¸€èˆ¬æ— éœ€æ›´æ”¹ æ‡’å¯åŠ¨æ•°æ®æº æ‡’å¯åŠ¨ï¼šè¿æ¥æ± åˆ›å»ºå‡ºæ¥åå¹¶ä¸ä¼šç«‹å³åˆå§‹åŒ–è¿æ¥æ± ï¼Œç­‰éœ€è¦ä½¿ç”¨connectionçš„æ—¶å€™å†åˆå§‹åŒ–ã€‚\næš‚æ—¶åªæ”¯æŒDruidå’ŒHikariCpå’ŒBeeCpè¿æ¥æ± ã€‚\nä¸»è¦åœºæ™¯å¯èƒ½é€‚åˆäºæ•°æ®æºå¾ˆå¤šï¼Œåˆä¸éœ€è¦å¯åŠ¨ç«‹å³åˆå§‹åŒ–çš„æƒ…å†µï¼Œå¯ä»¥å‡å°‘ç³»ç»Ÿå¯åŠ¨æ—¶é—´ã€‚\nç¼ºç‚¹åœ¨äºï¼Œå¦‚æœå‚æ•°é…ç½®æœ‰è¯¯ï¼Œåˆ™å¯åŠ¨çš„æ—¶å€™ä¸çŸ¥é“ï¼Œåˆå§‹åŒ–çš„æ—¶å€™å¤±è´¥ï¼Œå¯èƒ½ä¸€ç›´æŠ›å¼‚å¸¸ã€‚\né…ç½®ä½¿ç”¨ spring: datasource: dynamic: primary: master # è®¾ç½®é»˜è®¤çš„æ•°æ®æºæˆ–è€…æ•°æ®æºç»„,é»˜è®¤å€¼å³ä¸ºmaster strict: false # è®¾ç½®ä¸¥æ ¼æ¨¡å¼,é»˜è®¤falseä¸å¯åŠ¨. å¯åŠ¨ååœ¨æœªåŒ¹é…åˆ°æŒ‡å®šæ•°æ®æºæ—¶å€™ä¼šæŠ›å‡ºå¼‚å¸¸,ä¸å¯åŠ¨åˆ™ä½¿ç”¨é»˜è®¤æ•°æ®æº. lazy: true # é»˜è®¤falseéæ‡’å¯åŠ¨ï¼Œç³»ç»ŸåŠ è½½åˆ°æ•°æ®æºç«‹å³åˆå§‹åŒ–è¿æ¥æ±  datasource: master: url: jdbc:mysql://xx.xx.xx.xx:3306/dynamic username: root password: 123456 driver-class-name: com.mysql.cj.jdbc.Driver lazy: true #è¡¨ç¤ºè¿™ä¸ªæ•°æ®æºæ‡’å¯åŠ¨ db1: url: jdbc:mysql://xx.xx.xx.xx:3307/dynamic username: root password: 123456 driver-class-name: com.mysql.cj.jdbc.Driver db2: url: jdbc:mysql://xx.xx.xx.xx:3307/dynamic username: root password: 123456 driver-class-name: com.mysql.cj.jdbc.Driver æ— æ•°æ®æºå¯åŠ¨ åŸºç¡€ä»‹ç» åœºæ™¯ï¼šéƒ¨åˆ†ç³»ç»Ÿå¯èƒ½å¯åŠ¨çš„æ—¶å€™å®Œå…¨ä¸éœ€è¦æ•°æ®æºï¼Œå…¨é å¯åŠ¨ååŠ¨æ€æ·»åŠ ã€‚\né…ç½®æ–¹å¼ å³åŸºæœ¬ä¸éœ€è¦é…ç½®ï¼Œå¯èƒ½æ ¹æ®éœ€è¦é…ç½®ä¸€äº›ç±»ä¼¼Druidå’ŒHikariCpå…¨å±€å‚æ•°ã€‚\nå¦‚éœ€é…ç½®Druidå’ŒHikariCpå…¨å±€å‚æ•°å¯å‚è€ƒå¯¹åº”ç« èŠ‚æ–‡æ¡£ã€‚\nspring: datasource: dynamic: primary: master # è®¾ç½®é»˜è®¤çš„æ•°æ®æºæˆ–è€…æ•°æ®æºç»„,é»˜è®¤å€¼å³ä¸ºmaster strict: false # è®¾ç½®ä¸¥æ ¼æ¨¡å¼,é»˜è®¤falseä¸å¯åŠ¨. å¯åŠ¨ååœ¨æœªåŒ¹é…åˆ°æŒ‡å®šæ•°æ®æºæ—¶å€™ä¼šæŠ›å‡ºå¼‚å¸¸,ä¸å¯åŠ¨åˆ™ä½¿ç”¨é»˜è®¤æ•°æ®æº. å› ä¸ºæ²¡æœ‰åŒ¹é…çš„ä¸»æ•°æ®æºï¼Œå¯åŠ¨çš„æ—¶å€™ä½ ä¼šè§åˆ°ç±»ä¼¼å¦‚ä¸‹æ—¥å¿—ã€‚\ndynamic-datasource initial loaded 0 datasource,Please add your primary datasource or check your configuration æ‰‹åŠ¨åˆ‡æ¢æ•°æ®æº åœ¨æŸäº›æƒ…å†µæ‚¨å¯èƒ½éœ€è¦æ‰‹åŠ¨åˆ‡æ¢æ•°æ®æºã€‚\nimport com.baomidou.dynamic.datasource.toolkit.DynamicDataSourceContextHolder; @Service public class UserServiceImpl implements UserService { @Autowired private JdbcTemplate jdbcTemplate; public List selectAll() { DynamicDataSourceContextHolder.push(\"slave\"); // æ‰‹åŠ¨åˆ‡æ¢ return jdbcTemplate.queryForList(\"select * from user\"); } } éœ€è¦æ³¨æ„çš„æ˜¯æ‰‹åŠ¨åˆ‡æ¢çš„æ•°æ®æºï¼Œæœ€å¥½è‡ªå·±åœ¨åˆé€‚çš„ä½ç½®è°ƒç”¨DynamicDataSourceContextHolder.clear()æ¸…ç©ºå½“å‰çº¿ç¨‹çš„æ•°æ®æºä¿¡æ¯ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ï¼Œå› ä¸ºä¸€å±‚ä½¿ç”¨çš„æ˜¯ThreadLocal\nå¦‚æœä½ ä¸å¤ªæ¸…æ¥šä»€ä¹ˆæ—¶å€™è°ƒç”¨ï¼Œé‚£ä¹ˆå¯ä»¥å‚è€ƒä¸‹é¢å†™ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œæ³¨å†Œè¿›springé‡Œå³å¯ã€‚\n@Slf4j public class DynamicDatasourceClearInterceptor implements HandlerInterceptor { @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) { // å…¥å£å¤„æ¸…ç©ºçœ‹ä¸ªäººï¼Œæœ‰çš„æ–°äººåœ¨å¼‚æ­¥é‡Œåˆ‡äº†æ•°æ®æºä½†æ˜¯å¿˜è®°æ¸…é™¤äº†ï¼Œä¸‹ä¸€ä¸ªè¯·æ±‚é‡åˆ°è¿™ä¸ªçº¿ç¨‹å°±ä¼šå¸¦è¿›æ¥ã€‚ // DynamicDataSourceContextHolder.clear(); return true; } @Override public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) { } @Override public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) { DynamicDataSourceContextHolder.clear(); } } æ‰‹åŠ¨æ³¨å…¥å¤šæ•°æ®æº ä»€ä¹ˆæ—¶å€™éœ€è¦æ‰‹åŠ¨æ³¨å…¥å¤šæ•°æ®æºï¼Ÿ\nç»å¤§éƒ¨åˆ†æ˜¯å› ä¸ºæ‚¨çš„ç³»ç»Ÿéœ€è¦å’Œå…¶ä»–æ•°æ®æºå…±åŒå­˜åœ¨ä½¿ç”¨ã€‚\nå¦‚Quartzå’ŒShardingJdbcç­‰éƒ½éœ€è¦ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®æºã€‚\ndynamic-datasource 3.4.0åŠä»¥ä¸Šç‰ˆæœ¬å’Œè€ç‰ˆæœ¬æ³¨å…¥æ–¹å¼æœ‰ä¸€å®šå·®åˆ«ï¼Œæ ¹æ®è‡ªå·±ç‰ˆæœ¬æ³¨å…¥ã€‚\næ³¨æ„ä¸€å®šè¦è®©å¤šæ•°æ®æºä½¿ç”¨ @Primary ï¼Œè®©å…¶æˆä¸ºä¸»æ•°æ®æºã€‚\n// 3.4.0ç‰ˆæœ¬ä»¥ä¸‹ @Primary @Bean public DataSource dataSource(DynamicDataSourceProvider dynamicDataSourceProvider) { DynamicRoutingDataSource dataSource = new DynamicRoutingDataSource(); dataSource.setPrimary(properties.getPrimary()); dataSource.setStrict(properties.getStrict()); dataSource.setStrategy(properties.getStrategy()); dataSource.setProvider(dynamicDataSourceProvider); dataSource.setP6spy(properties.getP6spy()); dataSource.setSeata(properties.getSeata()); return dataSource; } // 3.4.0ç‰ˆæœ¬åŠä»¥ä¸Š @Primary @Bean public DataSource dataSource() { DynamicRoutingDataSource dataSource = new DynamicRoutingDataSource(); dataSource.setPrimary(properties.getPrimary()); dataSource.setStrict(properties.getStrict()); dataSource.setStrategy(properties.getStrategy()); dataSource.setP6spy(properties.getP6spy()); dataSource.setSeata(properties.getSeata()); return dataSource; } ä¸»è¦å˜æ›´æ˜¯å› ä¸º3.4.0æ”¯æŒäº†å¤šä¸ªprovideråŒæ—¶ç”Ÿæ•ˆï¼Œé‡‡å–äº†å†…éƒ¨æ³¨å…¥ï¼Œå…·ä½“æºç æ”¹åŠ¨ã€‚\nè‡ªå®šä¹‰ è‡ªå®šä¹‰æ³¨è§£ï¼šä¸æ»¡è¶³äºé»˜è®¤DSæ³¨è§£ï¼Œå¸Œæœ›è‡ªå®šä¹‰æ³¨è§£ã€‚\nè‡ªå®šä¹‰æ•°æ®æºæ¥æºï¼šé»˜è®¤çš„æ•°æ®æºæ¥æºæ˜¯åŸºäºymlæˆ–è€…propertiesé…ç½®æ¥çš„ï¼Œç»„ä»¶æ”¯æŒåŒæ—¶ä»å¤šä¸ªåœ°æ–¹æ¥åŠ è½½åˆå§‹åŒ–æ•°æ®æºã€‚å¸¸ç”¨äºå¤šç§Ÿæˆ·ç³»ç»Ÿï¼Œä»ä¸€ä¸ªç§Ÿæˆ·ä¿¡æ¯åº“å¤šåŠ è½½ä¸åŒç§Ÿæˆ·çš„æ•°æ®æºã€‚\nè‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼šå¸¸ç”¨çš„æœ‰è½®è¯¢ï¼Œéšæœºã€‚æ”¯æŒæ‰©å±•ã€‚\nè‡ªå®šä¹‰åˆ‡é¢ï¼šæ”¯æŒä¸ä½¿ç”¨æ³¨è§£ï¼Œé€šè¿‡é…ç½®æ¥åˆ‡æ¢æ•°æ®æºã€‚å¦‚æŸä¸ªåŒ…ä¸‹æ‰€æœ‰serviceæ–¹æ³•ä»¥select*å¼€å¤´çš„éƒ½èµ°slaveåº“ï¼Œä»¥add*å¼€å¤´çš„éƒ½èµ°masteråº“ã€‚\nè‡ªå®šä¹‰æ³¨è§£ åŸºç¡€ä»‹ç» å¦‚æœä½ åªæœ‰å‡ ä¸ªç¡®å®šçš„åº“ï¼Œå¯ä»¥å°è¯•è‡ªå®šä¹‰æ³¨è§£æ›¿æ¢æ‰@DSã€‚\nå»ºè®®ä»3.2.1ç‰ˆæœ¬å¼€å§‹ä½¿ç”¨è‡ªå®šä¹‰æ³¨è§£ï¼Œå¦å¤–ç»„ä»¶è‡ªå¸¦äº†@Masterå’Œ@Slaveæ³¨è§£ã€‚\nä½¿ç”¨æ–¹æ³• ä¸‹é¢æˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªäº§å“åº“çš„æ³¨è§£ï¼Œæ–¹ä¾¿æˆ‘ä»¬åé¢ç¨‹åºçš„ä½¿ç”¨ã€‚\n1ã€éœ€è¦è‡ªå·±å®šä¹‰ä¸€ä¸ªæ³¨è§£å¹¶ç»§æ‰¿è‡ªDS\nimport com.baomidou.dynamic.datasource.annotation.DS; import java.lang.annotation.*; @Target({ElementType.TYPE, ElementType.METHOD}) @Retention(RetentionPolicy.RUNTIME) @Documented @DS(\"product\") public @interface Product { } 2ã€æ³¨è§£åœ¨éœ€è¦åˆ‡æ¢æ•°æ®æºçš„æ–¹æ³•ä¸Šæˆ–ç±»ä¸Š\n@Service @Product public class ProductServiceImpl implements ProductService { @Product public List selectAll() { return jdbcTemplate.queryForList(\"select * from products\"); } } è‡ªå®šä¹‰æ•°æ®æºæ¥æº åŸºç¡€ä»‹ç» æ•°æ®æºæ¥æºçš„é»˜è®¤å®ç°æ˜¯YmlDynamicDataSourceProviderï¼Œå…¶ä»yamlæˆ–propertiesä¸­è¯»å–ä¿¡æ¯å¹¶è§£æå‡ºæ‰€æœ‰æ•°æ®æºä¿¡æ¯ã€‚\npublic interface DynamicDataSourceProvider { /** * åŠ è½½æ‰€æœ‰æ•°æ®æº * * @return æ‰€æœ‰æ•°æ®æºï¼Œkeyä¸ºæ•°æ®æºåç§° */ Map\u003cString, DataSource\u003e loadDataSources(); } è‡ªå®šä¹‰ç¤ºä¾‹ å¯ä»¥å‚è€ƒ AbstractJdbcDataSourceProvider ï¼ˆä»…ä¾›å‚è€ƒï¼‰æ¥å®ç°ä»JDBCæ•°æ®åº“ä¸­è·å–æ•°æ®åº“è¿æ¥ä¿¡æ¯ã€‚\n@Bean public DynamicDataSourceProvider jdbcDynamicDataSourceProvider() { return new AbstractJdbcDataSourceProvider(\"com.mysql.cj.jdbc.Driver\", \"jdbc:mysql://xx.xx.xx.xx:3306/dynamic\", \"root\", \"root\") { @Override protected Map\u003cString, DataSourceProperty\u003e executeStmt(Statement statement) throws SQLException { ResultSet rs = statement.executeQuery(\"select * from DB\"); while (rs.next()) { String name = rs.getString(\"name\"); String username = rs.getString(\"username\"); String password = rs.getString(\"password\"); String url = rs.getString(\"url\"); String driver = rs.getString(\"driver\"); DataSourceProperty property = new DataSourceProperty(); property.setUsername(username); property.setPassword(password); property.setUrl(url); property.setDriverClassName(driver); map.put(name, property); } return map; } }; } PS: ä»3.4.0å¼€å§‹ï¼Œå¯ä»¥æ³¨å…¥å¤šä¸ªDynamicDataSourceProviderçš„Beanä»¥å®ç°åŒæ—¶ä»å¤šä¸ªä¸åŒæ¥æºåŠ è½½æ•°æ®æºï¼Œæ³¨æ„åŒåä¼šè¢«è¦†ç›–ã€‚\nè‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥ åŸºç¡€ä»‹ç» å¦‚ä¸‹slaveç»„ä¸‹æœ‰ä¸‰ä¸ªæ•°æ®æºï¼Œå½“ç”¨æˆ·ä½¿ç”¨slaveåˆ‡æ¢æ•°æ®æºæ—¶ä¼šä½¿ç”¨è´Ÿè½½å‡è¡¡ç®—æ³•ã€‚\nç³»ç»Ÿè‡ªå¸¦äº†ä¸¤ä¸ªè´Ÿè½½å‡è¡¡ç®—æ³•:\nLoadBalanceDynamicDataSourceStrategy è½®è¯¢,æ˜¯é»˜è®¤çš„ã€‚ RandomDynamicDataSourceStrategy éšæœºçš„ã€‚ spring: datasource: dynamic: datasource: master: username: root password: root url: jdbc:mysql://xx.xx.xx.xx:3306/dynamic driver-class-name: com.mysql.cj.jdbc.Driver schema: db/schema.sql slave_1: username: root password: root url: jdbc:mysql://xx.xx.xx.xx:3307/dynamic driver-class-name: com.mysql.cj.jdbc.Driver slave_2: username: root password: root url: jdbc:mysql://xx.xx.xx.xx:3308/dynamic driver-class-name: com.mysql.cj.jdbc.Driver slave_3: username: root password: root url: jdbc:mysql://xx.xx.xx.xx:3309/dynamic driver-class-name: com.mysql.cj.jdbc.Driver strategy: com.baomidou.dynamic.datasource.strategy.LoadBalanceDynamicDataSourceStrategy å¦‚ä½•è‡ªå®šä¹‰ å¦‚æœé»˜è®¤çš„ä¸¤ä¸ªéƒ½ä¸èƒ½æ»¡è¶³è¦æ±‚ï¼Œå¯ä»¥å‚è€ƒæºç è‡ªå®šä¹‰ï¼Œæš‚æ—¶åªèƒ½å…¨å±€æ›´æ”¹ã€‚\nimport java.util.List; import java.util.concurrent.ThreadLocalRandom; import javax.sql.DataSource; public class RandomDynamicDataSourceStrategy implements DynamicDataSourceStrategy { public RandomDynamicDataSourceStrategy() { } public DataSource determineDataSource(List\u003cDataSource\u003e dataSources) { return (DataSource)dataSources.get(ThreadLocalRandom.current().nextInt(dataSources.size())); } } æ— æ³¨è§£æ–¹æ¡ˆ ä¸ç®¡æ˜¯å‡ºäºæ³¨è§£ä¾µå…¥æ€§è¿˜æ˜¯ä»£ç æ•´æ´ç­‰ç†ç”±ï¼Œæˆ‘ä»¬éƒ½æœ‰éœ€æ±‚ä¸æƒ³ä½¿ç”¨æ³¨è§£çš„éœ€æ±‚ã€‚\nä½†æ˜¯éœ€è¦ç†è§£å¤šæ•°æ®æºå®ç°çš„æ ¸å¿ƒã€‚\npublic class DynamicRoutingDataSource { @Override public DataSource determineDataSource() { // è¿™é‡Œæ˜¯æ ¸å¿ƒï¼Œæ˜¯ä»ThreadLocalä¸­è·å–å½“å‰æ•°æ®æºã€‚ String dsKey = DynamicDataSourceContextHolder.peek(); return getDataSource(dsKey); } æ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥æ ¹æ®éœ€æ±‚ï¼Œé€‰æ‹©åˆé€‚çš„æ—¶æœºè°ƒç”¨DynamicDataSourceContextHolder.push(\"å¯¹åº”æ•°æ®æº\")ã€‚\né»˜è®¤çš„@DSæ³¨è§£æ¥åˆ‡æ¢æ•°æ®æºæ˜¯æ ¹æ®spring AOPçš„ç‰¹æ€§ï¼Œåœ¨æ–¹æ³•å¼€å¯å‰è®¾ç½®æ•°æ®æºKEYï¼Œæ–¹æ³•æ‰§è¡Œå®Œæˆåç§»é™¤å¯¹åº”æ•°æ®æºKEYã€‚\nfilteråˆ‡æ¢æ•°æ®æº ç›®æ ‡ï¼šæ‹¦æˆªä»¥filter/**å¼€å¤´çš„æ‰€æœ‰è¯·æ±‚ï¼Œå¦‚æœåé¢çš„æ–¹æ³•ä»¥aå¼€å¤´å°±åˆ‡æ¢åˆ°db1ï¼Œä»¥bå¼€å¤´å°±åˆ‡æ¢åˆ°db2ï¼Œå…¶ä½™ä½¿ç”¨é»˜è®¤æ•°æ®æºã€‚\nå®ç°å¦‚ä¸‹ï¼š\n@Slf4j @WebFilter(filterName = \"dsFilter\", urlPatterns = {\"/filter/*\"}) public class DynamicDatasourceFilter implements Filter { @Override public void init(FilterConfig filterConfig) throws ServletException { log.info(\"loading filter {}\", filterConfig.getFilterName()); } @Override public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException { HttpServletRequest request = (HttpServletRequest) servletRequest; HttpServletResponse response = (HttpServletResponse) servletResponse; String requestURI = request.getRequestURI(); log.info(\"ç»è¿‡å¤šæ•°æ®æºfilter,å½“å‰è·¯å¾„æ˜¯{}\", requestURI); // String headerDs = request.getHeader(\"ds\"); // Object sessionDs = request.getSession().getAttribute(\"ds\"); String s = requestURI.replaceFirst(\"/filter/\", \"\"); String dsKey = \"master\"; if (s.startsWith(\"a\")) { dsKey = \"db1\"; } else if (s.startsWith(\"b\")) { dsKey = \"db2\"; } else { } // æ‰§è¡Œ try { DynamicDataSourceContextHolder.push(dsKey); filterChain.doFilter(servletRequest, servletResponse); } finally { DynamicDataSourceContextHolder.poll(); } } @Override public void destroy() { } } @SpringBootApplication @ServletComponentScan // filterå¿…é¡»ä½¿ç”¨è¿™ä¸ª @MapperScan(\"com.baomidou.samples.ds.mapper\") public class AllDataSourceApplication { public static void main(String[] args) { SpringApplication.run(AllDataSourceApplication.class, args); } } æ‰©å±•ï¼šä»requestä¸­è¿˜èƒ½è·å–åˆ°å¾ˆå¤šä¸œè¥¿ï¼Œå¦‚headerå’Œsessionï¼ŒåŒç†å¯ä»¥æ ¹æ®è‡ªå·±ä¸šåŠ¡éœ€æ±‚æ ¹æ®headerå€¼å’Œsessioné‡Œå¯¹åº”çš„ç”¨æˆ·æ¥åŠ¨æ€è®¾ç½®å’Œåˆ‡æ¢æ•°æ®æºã€‚\ninterceproråˆ‡æ¢æ•°æ®æº ç›®æ ‡ï¼šæ‹¦æˆªä»¥interceptor/**å¼€å¤´çš„æ‰€æœ‰è¯·æ±‚ï¼Œå¦‚æœåé¢çš„æ–¹æ³•ä»¥aå¼€å¤´å°±åˆ‡æ¢åˆ°db1ï¼Œä»¥bå¼€å¤´å°±åˆ‡æ¢åˆ°db2ï¼Œå…¶ä½™ä½¿ç”¨é»˜è®¤æ•°æ®æºã€‚\nå®ç°å¦‚ä¸‹ï¼š\nimport com.baomidou.dynamic.datasource.toolkit.DynamicDataSourceContextHolder; import lombok.extern.slf4j.Slf4j; import org.springframework.web.servlet.HandlerInterceptor; import org.springframework.web.servlet.ModelAndView; import javax.servlet.http.HttpServletRequest; import javax.servlet.http.HttpServletResponse; @Slf4j public class DynamicDatasourceInterceptor implements HandlerInterceptor { /** * åœ¨è¯·æ±‚å¤„ç†ä¹‹å‰è¿›è¡Œè°ƒç”¨ï¼ˆControlleræ–¹æ³•è°ƒç”¨ä¹‹å‰ï¼‰ */ @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) { String requestURI = request.getRequestURI(); log.info(\"ç»è¿‡å¤šæ•°æ®æºInterceptor,å½“å‰è·¯å¾„æ˜¯{}\", requestURI); // String headerDs = request.getHeader(\"ds\"); // Object sessionDs = request.getSession().getAttribute(\"ds\"); String s = requestURI.replaceFirst(\"/interceptor/\", \"\"); String dsKey = \"master\"; if (s.startsWith(\"a\")) { dsKey = \"db1\"; } else if (s.startsWith(\"b\")) { dsKey = \"db2\"; } else { } DynamicDataSourceContextHolder.push(dsKey); return true; } /** * è¯·æ±‚å¤„ç†ä¹‹åè¿›è¡Œè°ƒç”¨ï¼Œä½†æ˜¯åœ¨è§†å›¾è¢«æ¸²æŸ“ä¹‹å‰ï¼ˆControlleræ–¹æ³•è°ƒç”¨ä¹‹åï¼‰ */ @Override public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) { } /** * åœ¨æ•´ä¸ªè¯·æ±‚ç»“æŸä¹‹åè¢«è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯åœ¨DispatcherServletæ¸²æŸ“äº†å¯¹åº”çš„è§†å›¾ä¹‹åæ‰§è¡Œï¼ˆä¸»è¦æ˜¯ç”¨äºè¿›è¡Œèµ„æºæ¸…ç†å·¥ä½œï¼‰ */ @Override public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) { DynamicDataSourceContextHolder.clear(); } } import org.springframework.context.annotation.Configuration; import org.springframework.web.servlet.config.annotation.InterceptorRegistry; import org.springframework.web.servlet.config.annotation.WebMvcConfigurer; @Configuration public class MyWebAutoConfig implements WebMvcConfigurer { @Override public void addInterceptors(InterceptorRegistry registry) { registry.addInterceptor(new DynamicDatasourceInterceptor()).addPathPatterns(\"/interceptor/**\"); } } è‡ªå®šä¹‰åˆ‡é¢ ä»3.4.0å¼€å§‹æ”¯æŒè‡ªå®šä¹‰åˆ‡é¢ã€‚\nä½¿ç”¨è¿™ä¸ªæ–¹å¼ï¼ŒåŸæ³¨è§£æ–¹å¼å¹¶ä¸ä¼šå¤±æ•ˆã€‚ æ³¨æ„ï¼šä¸è¦åœ¨åŒä¸€ä¸ªåˆ‡é¢åŒæ—¶ä½¿ç”¨æ³¨è§£åˆä½¿ç”¨è‡ªå®šä¹‰åˆ‡é¢ã€‚ @Configuration public class MyConfig { @Bean public DynamicDatasourceNamedInterceptor dsAdvice(DsProcessor dsProcessor) { DynamicDatasourceNamedInterceptor interceptor = new DynamicDatasourceNamedInterceptor(dsProcessor); Map\u003cString, String\u003e patternMap = new HashMap\u003c\u003e(); patternMap.put(\"select*\", \"slave\"); patternMap.put(\"add*\", \"master\"); patternMap.put(\"update*\", \"master\"); patternMap.put(\"delete*\", \"master\"); interceptor.addPatternMap(patternMap); return interceptor; } @Bean public Advisor dsAdviceAdvisor(DynamicDatasourceNamedInterceptor dsAdvice) { AspectJExpressionPointcut pointcut = new AspectJExpressionPointcut(); pointcut.setExpression(\"execution (* com.baomidou.samples.pattern..service.*.*(..))\"); return new DefaultPointcutAdvisor(pointcut, dsAdvice); } } ä»¥ä¸Šå®ç°com.baomidou.samples.patternåŒ…serviceä¸‹æ‰€æœ‰ç±»çš„add/update/deleteå¼€å¤´çš„æ–¹æ³•ä½¿ç”¨masteræ•°æ®æºï¼Œselectä½¿ç”¨slaveæ•°æ®æºã€‚\næ›´å¤æ‚çš„åˆ‡ç‚¹è¡¨è¾¾å¼è¯­æ³•éœ€è‡ªè¡Œå­¦ä¹ ã€‚\nmybatisä¸‹è¯»å†™åˆ†ç¦» åœºæ™¯ï¼š\nåœ¨çº¯çš„è¯»å†™åˆ†ç¦»ç¯å¢ƒï¼Œå†™æ“ä½œå…¨éƒ¨æ˜¯masterï¼Œè¯»æ“ä½œå…¨éƒ¨æ˜¯slaveã€‚ ä¸æƒ³é€šè¿‡æ³¨è§£é…ç½®å®Œæˆä»¥ä¸ŠåŠŸèƒ½ã€‚ ç­”ï¼šåœ¨mybatisç¯å¢ƒä¸‹å¯ä»¥åŸºäºmybatisæ’ä»¶ç»“åˆdynamic-datasourceå®Œæˆä»¥ä¸ŠåŠŸèƒ½ã€‚\næ‰‹åŠ¨æ³¨å…¥æ’ä»¶ï¼š\n@Bean public MasterSlaveAutoRoutingPlugin masterSlaveAutoRoutingPlugin(){ return new MasterSlaveAutoRoutingPlugin(); } é»˜è®¤ä¸»åº“åç§°masterï¼Œä»åº“åç§°slaveã€‚\næš‚ä¸æ”¯æŒæ›´å¤šï¼Œæºç ç®€å•å¯å‚è€ƒé‡å†™ã€‚\n@Intercepts({@Signature(type = Executor.class, method = \"query\", args = {MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class}), @Signature(type = Executor.class, method = \"update\", args = {MappedStatement.class, Object.class})}) @Slf4j public class MasterSlaveAutoRoutingPlugin implements Interceptor { private static final String MASTER = \"master\"; private static final String SLAVE = \"slave\"; @Override public Object intercept(Invocation invocation) throws Throwable { Object[] args = invocation.getArgs(); MappedStatement ms = (MappedStatement) args[0]; try { DynamicDataSourceContextHolder.push(SqlCommandType.SELECT == ms.getSqlCommandType() ? SLAVE : MASTER); return invocation.proceed(); } finally { DynamicDataSourceContextHolder.clear(); } } @Override public Object plugin(Object target) { return target instanceof Executor ? Plugin.wrap(target, this) : target; } @Override public void setProperties(Properties properties) { } } äº‹åŠ¡ä¸“æ  ä½¿ç”¨å¤šæ•°æ®æºçš„ä½ ä¸€å®šä¼šé‡åˆ°äº‹åŠ¡é—®é¢˜ï¼š\nä¸ºä»€ä¹ˆä½¿ç”¨äº†äº‹åŠ¡å°±åˆ‡æ¢ä¸äº†æ•°æ®æºäº†å•Šï¼Ÿ æœ‰æ²¡æœ‰ä»€ä¹ˆè§£å†³æ–¹æ¡ˆå•Šï¼Ÿ æœ‰æ²¡æœ‰ä½¿ç”¨æ¡ˆä¾‹å’Œæ³¨æ„äº‹é¡¹å•Šã€‚ ä»¥ä¸Šé—®é¢˜éƒ½èƒ½åœ¨æœ¬ç« èŠ‚å¾—åˆ°è§£ç­”ã€‚\næ–¹æ¡ˆä¸€ï¼šdynamic-datasourceé›†æˆäº†alibabaåˆ†å¸ƒå¼äº‹åŠ¡ç»„ä»¶seataã€‚\næ–¹æ¡ˆäºŒï¼šdynamic-datasourceæä¾›äº†æ— éœ€å¤–éƒ¨ç»„ä»¶çš„æœ¬åœ°å¤šæ•°æ®æºäº‹åŠ¡ã€‚\nå„æœ‰å„çš„ä¼˜åŠ£ï¼Œæ€»æœ‰ä¸€æ¬¾é€‚åˆä½ ã€‚\näº‹åŠ¡æ¦‚å¿µ ä»€ä¹ˆæ˜¯äº‹åŠ¡ï¼Ÿ äº‹åŠ¡ï¼šæ˜¯æ•°æ®åº“æ“ä½œçš„æœ€å°å·¥ä½œå•å…ƒï¼Œæ˜¯ä½œä¸ºå•ä¸ªé€»è¾‘å·¥ä½œå•å…ƒæ‰§è¡Œçš„ä¸€ç³»åˆ—æ“ä½œï¼›è¿™äº›æ“ä½œä½œä¸ºä¸€ä¸ªæ•´ä½“ä¸€èµ·å‘ç³»ç»Ÿæäº¤ï¼Œè¦ä¹ˆéƒ½æ‰§è¡Œã€è¦ä¹ˆéƒ½ä¸æ‰§è¡Œï¼›äº‹åŠ¡æ˜¯ä¸€ç»„ä¸å¯å†åˆ†å‰²çš„æ“ä½œé›†åˆï¼ˆå·¥ä½œé€»è¾‘å•å…ƒï¼‰ã€‚\näº‹åŠ¡çš„å››å¤§ç‰¹æ€§ï¼š\nåŸå­æ€§ äº‹åŠ¡æ˜¯æ•°æ®åº“çš„é€»è¾‘å·¥ä½œå•ä½ï¼Œäº‹åŠ¡ä¸­åŒ…å«çš„å„æ“ä½œè¦ä¹ˆéƒ½åšï¼Œè¦ä¹ˆéƒ½ä¸åš ã€‚\nä¸€è‡´æ€§ äº‹åŠ¡æ‰§è¡Œçš„ç»“æœå¿…é¡»æ˜¯ä½¿æ•°æ®åº“ä»ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€å˜åˆ°å¦ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€ã€‚å› æ­¤å½“æ•°æ®åº“åªåŒ…å«æˆåŠŸäº‹åŠ¡æäº¤çš„ç»“æœæ—¶ï¼Œå°±è¯´æ•°æ®åº“å¤„äºä¸€è‡´æ€§çŠ¶æ€ã€‚å¦‚æœæ•°æ®åº“ç³»ç»Ÿ è¿è¡Œä¸­å‘ç”Ÿæ•…éšœï¼Œæœ‰äº›äº‹åŠ¡å°šæœªå®Œæˆå°±è¢«è¿«ä¸­æ–­ï¼Œè¿™äº›æœªå®Œæˆäº‹åŠ¡å¯¹æ•°æ®åº“æ‰€åšçš„ä¿®æ”¹æœ‰ä¸€éƒ¨åˆ†å·²å†™å…¥ç‰©ç†æ•°æ®åº“ï¼Œè¿™æ—¶æ•°æ®åº“å°±å¤„äºä¸€ç§ä¸æ­£ç¡®çš„çŠ¶æ€ï¼Œæˆ–è€…è¯´æ˜¯ ä¸ä¸€è‡´çš„çŠ¶æ€ã€‚\néš”ç¦»æ€§ ä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œä¸èƒ½å…¶å®ƒäº‹åŠ¡å¹²æ‰°ã€‚å³ä¸€ä¸ªäº‹åŠ¡å†…éƒ¨çš„æ“ä½œåŠä½¿ç”¨çš„æ•°æ®å¯¹å…¶å®ƒå¹¶å‘äº‹åŠ¡æ˜¯éš”ç¦»çš„ï¼Œå¹¶å‘æ‰§è¡Œçš„å„ä¸ªäº‹åŠ¡ä¹‹é—´ä¸èƒ½äº’ç›¸å¹²æ‰°ã€‚\næŒç»­æ€§ ä¹Ÿç§°æ°¸ä¹…æ€§ï¼ŒæŒ‡ä¸€ä¸ªäº‹åŠ¡ä¸€æ—¦æäº¤ï¼Œå®ƒå¯¹æ•°æ®åº“ä¸­çš„æ•°æ®çš„æ”¹å˜å°±åº”è¯¥æ˜¯æ°¸ä¹…æ€§çš„ã€‚æ¥ä¸‹æ¥çš„å…¶å®ƒæ“ä½œæˆ–æ•…éšœä¸åº”è¯¥å¯¹å…¶æ‰§è¡Œç»“æœæœ‰ä»»ä½•å½±å“ã€‚\nåŸç”ŸJDBCå¤„ç†äº‹åŠ¡ try { connection.setAutoCommit(false); // è¿™é‡Œç”¨connectionå¯¹æ•°æ®åº“åšäº†ä¸€ç³»åˆ—æ“ä½œï¼ŒCRUD connection.commit(); // æ²¡æœ‰å¼‚å¸¸å°±æäº¤ } catch(Exception ex){ connection.rollback(); // å¼‚å¸¸å›æ»š } finally { connection.setAutoCommit(true); } ä»¥ä¸Šæ˜¯äº‹åŠ¡çš„æ ¸å¿ƒï¼Œæ‰€æœ‰æ“ä½œè¦ä¸€èµ·æˆåŠŸï¼Œåªè¦å‡ºé”™å°±å›æ»šã€‚\nSpringå¤„ç†äº‹åŠ¡ springå¼€å¯äº‹åŠ¡å¾ˆç®€å•ï¼Œåœ¨éœ€è¦äº‹åŠ¡çš„æ–¹æ³•å’Œç±»ä¸Šæ·»åŠ @Transactionalæ³¨è§£ã€‚\n@Transactional public void test() { Aservice.dosometing(); Bservice.dosometing(); } ä½¿ç”¨äº†@Transactionalï¼Œspringä¼šä¿è¯æ•´ä¸ªäº‹åŠ¡ä¸‹éƒ½å¤ç”¨åŒä¸€ä¸ªconnectionã€‚\nåœ¨é»˜è®¤é…ç½®ä¸‹ï¼Œåªè¦äº‹åŠ¡ä¸­å‘ç”ŸRuntimeExceptionï¼Œå°±ä¼šå›æ»šã€‚\nåŸºç¡€çŸ¥è¯† é—®ï¼šä½¿ç”¨äº†äº‹åŠ¡å¦‚@Transationalæ— æ³•åˆ‡æ¢æ•°æ®æºï¼Ÿ\nç­”ï¼š æ˜¯çš„ï¼Œæœ¬ç»„ä»¶æ˜¯åŸºäºspringAopçš„æ–¹æ¡ˆæ¥è¿›è¡Œå¤šæ•°æ®æºçš„ç®¡ç†å’Œåˆ‡æ¢çš„ï¼Œè¦æƒ³ä¿è¯å¤šä¸ªåº“çš„æ•´ä½“äº‹åŠ¡åˆ™éœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡ã€‚\né—®ï¼šä¸ºä»€ä¹ˆä½¿ç”¨äº†äº‹åŠ¡å¦‚@Transationalå°±æ— æ³•åˆ‡æ¢æ•°æ®æºï¼Ÿ\nç­”ï¼šå¼€å¯äº†äº‹åŠ¡åï¼Œspringäº‹åŠ¡ç®¡ç†å™¨ä¼šä¿è¯åœ¨äº‹åŠ¡ä¸‹æ•´ä¸ªçº¿ç¨‹åç»­æ‹¿åˆ°çš„éƒ½æ˜¯åŒä¸€ä¸ªconnectionã€‚\né—®ï¼šäº‹åŠ¡ä¸‹æ— æ³•åˆ‡æ¢æ•°æ®æºæˆ‘çŸ¥é“äº†ï¼Œé‚£æˆ‘å•åº“çš„äº‹åŠ¡çš„å¯ä»¥ç”¨å—ï¼Ÿ\nç­”ï¼šå®Œå…¨å¯ä»¥çš„ã€‚åªè¦äº‹åŠ¡ä¸‹ä¸åˆ‡æ¢æ•°æ®æºå°±OKã€‚\né—®ï¼šæˆ‘çš„ä¸šåŠ¡å¿…é¡»è¦ä¿è¯äº‹åŠ¡ï¼Œè¿˜æœ‰ä»€ä¹ˆè§£å†³åŠæ³•ï¼Ÿ\næ–¹æ¡ˆä¸€ï¼šseataå°±æ˜¯è§£å†³æ­¤é—®é¢˜ï¼Œæœ¬ç»„ä»¶å·²å®Œæˆå’Œseataçš„è‡ªåŠ¨é›†æˆã€‚\næ–¹æ¡ˆäºŒï¼šæœ¬ç»„ä»¶ä»3.3.0å¼€å§‹æ”¯æŒæœ¬åœ°å¤šæ•°æ®æºäº‹åŠ¡ï¼Œæ— éœ€ç¬¬ä¸‰æ–¹ã€‚\næœ¬åœ°äº‹åŠ¡ èƒŒæ™¯ å¤šæ•°æ®æºäº‹åŠ¡æ–¹æ¡ˆä¸€ç›´æ˜¯ä¸€ä¸ªéš¾é¢˜ï¼Œé€šå¸¸çš„è§£å†³æ–¹æ¡ˆæœ‰ä»¥ä¸‹äºŒç§ã€‚\nåˆ©ç”¨atomiksæ‰‹åŠ¨æ„å»ºå¤šæ•°æ®æºäº‹åŠ¡ï¼Œé€‚åˆæ•°æ®æºè¾ƒå°‘ï¼Œé…ç½®çš„å‚æ•°ä¹Ÿä¸å¤ªå¤š,æ€§èƒ½è¦æ±‚ä¸é«˜çš„é¡¹ç›®ã€‚éš¾ç‚¹å°±æ˜¯æ‰‹åŠ¨é…ç½®é‡å¤§ï¼Œéœ€è¦è€—è´¹ä¸€å®šæ—¶é—´ã€‚\nç”¨seataç±»ä¼¼çš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œéš¾ç‚¹å°±æ˜¯éœ€è¦æ­å»ºç»´æŠ¤å¦‚seata-serverçš„ç»Ÿä¸€ç®¡ç†ä¸­å¿ƒã€‚ æ¯ä¸€ç§æ–¹æ¡ˆéƒ½æœ‰å…¶é€‚ç”¨åœºæ™¯ã€‚ä½ å¯èƒ½é‡åˆ°æœ€å¤šçš„é—®é¢˜å°±æ˜¯ï¼š\nä¸ºä»€ä¹ˆæˆ‘åŠ äº†äº‹åŠ¡æ³¨è§£ï¼Œåˆ‡æ¢æ•°æ®æºå¤±è´¥ï¼Ÿ\næˆ‘äº†è§£æ¶‰åŠäº†åˆ†å¸ƒå¼äº‹åŠ¡äº†ï¼Œä½†æˆ‘ä¸æƒ³ç”¨seataï¼Œæˆ‘åœºæ™¯ç®€å•ï¼Œæœ‰æ²¡æœ‰ä¸ä¾èµ–ç¬¬ä¸‰æ–¹çš„æ–¹æ¡ˆï¼Ÿ\nåŸºç¡€ä»‹ç» è‡ªä»3.3.0å¼€å§‹ï¼Œç”±seataçš„æ ¸å¿ƒè´¡çŒ®è€… https://github.com/a364176773 è´¡çŒ®äº†åŸºäºconnectionä»£ç†çš„æ–¹æ¡ˆã€‚\nå»ºè®®ä»3.4.0ç‰ˆæœ¬å¼€å§‹ä½¿ç”¨ï¼Œå…¶ä¿®å¤äº†ä¸€ä¸ªåŠŸèƒ½ï¼Œè€ç‰ˆæœ¬ä¸åŠ @DSåªåŠ @DSTransactionalä¼šæŠ¥é”™ã€‚\næ³¨æ„äº‹é¡¹ æœ¬åœ°äº‹åŠ¡å®ç°å¾ˆç®€å•ï¼Œå°±æ˜¯å¾ªç¯æäº¤ï¼Œå‘ç”Ÿé”™è¯¯ï¼Œå¾ªç¯å›æ»šã€‚\næˆ‘ä»¬é»˜è®¤çš„å‰ææ˜¯æ•°æ®åº“æœ¬èº«ä¸ä¼šå¼‚å¸¸ï¼Œæ¯”å¦‚å®•æœºã€‚\nå¦‚æ•°æ®åœ¨å›æ»šçš„è¿‡ç¨‹çªç„¶å®•æœºï¼Œæœ¬åœ°äº‹åŠ¡å°±ä¼šæœ‰é—®é¢˜ã€‚å¦‚æœä½ éœ€è¦å®Œæ•´åˆ†å¸ƒå¼æ–¹æ¡ˆè¯·ä½¿ç”¨seataæ–¹æ¡ˆã€‚\nä¸æ”¯æŒspringåŸç”Ÿäº‹åŠ¡ï¼Œä¸æ”¯æŒspringäº‹åŠ¡ï¼Œä¸æ”¯æŒspringäº‹åŠ¡ï¼Œå¯åˆ†åˆ«ä½¿ç”¨ï¼Œåƒä¸‡ä¸èƒ½æ··ç”¨ã€‚ å†æ¬¡å¼ºè°ƒä¸æ”¯æŒspringäº‹åŠ¡æ³¨è§£ï¼Œå¯ç†è§£æˆç‹¬ç«‹å†™äº†ä¸€å¥—äº‹åŠ¡æ–¹æ¡ˆã€‚ åªé€‚åˆç®€å•æœ¬åœ°å¤šæ•°æ®æºåœºæ™¯ï¼Œ å¦‚æœæ¶‰åŠå¼‚æ­¥å’Œå¾®æœåŠ¡ç­‰å®Œæ•´äº‹åŠ¡åœºæ™¯ï¼Œè¯·ä½¿ç”¨seataæ–¹æ¡ˆã€‚ æš‚æ—¶ä¸æ”¯æŒæ›´å¤šé…ç½®ï¼Œå¦‚åªè¯»ï¼Œå¦‚springçš„ä¼ æ’­ç‰¹æ€§ã€‚ åç»­ä¼šæ ¹æ®åé¦ˆè€ƒè™‘æ”¯æŒã€‚ ä½¿ç”¨æ–¹æ³• åœ¨æœ€å¤–å±‚çš„æ–¹æ³•æ·»åŠ  @DSTransactionalï¼Œåº•ä¸‹è°ƒç”¨çš„å„ä¸ªç±»è¯¥åˆ‡æ•°æ®æºå°±æ­£å¸¸ä½¿ç”¨DSåˆ‡æ¢æ•°æ®æºå³å¯ï¼Œå°±æ˜¯è¿™ä¹ˆç®€å•ã€‚\n// å¦‚AServiceè°ƒç”¨BServiceå’ŒCServiceçš„æ–¹æ³•ï¼ŒA,B,Cåˆ†åˆ«å¯¹åº”ä¸åŒæ•°æ®æºã€‚ @Service public class AService { @DS(\"a\") // å¦‚æœaæ˜¯é»˜è®¤æ•°æ®æºåˆ™ä¸éœ€è¦DSæ³¨è§£ã€‚ @DSTransactional public void dosomething(){ BService.dosomething(); CService.dosomething(); } } @Service public class BService { @DS(\"b\") public void dosomething(){ // dosomething } } @Service public class CService { @DS(\"c\") public void dosomething(){ // dosomething } } åªè¦@DSTransactionalæ³¨è§£ä¸‹ä»»ä¸€ç¯èŠ‚å‘ç”Ÿå¼‚å¸¸ï¼Œåˆ™å…¨å±€å¤šæ•°æ®æºäº‹åŠ¡å›æ»šã€‚\nå¦‚æœBCä¸Šä¹Ÿæœ‰@DSTransactionalä¼šæœ‰å½±å“å—ï¼Ÿç­”ï¼šæ²¡æœ‰å½±å“çš„ã€‚\nç¤ºä¾‹é¡¹ç›® ç‚¹æˆ‘è·³è½¬\nå®Œæ•´ç¤ºä¾‹é¡¹ç›®ï¼Œæ•°æ®åº“éƒ½å·²å‡†å¤‡å¥½ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œæµ‹è¯•ã€‚\nç¤ºä¾‹é¡¹ç›®A,B,Cåˆ†åˆ«å¯¹åº”OrderService,ProductServiceï¼ŒAccountServiceï¼Œåˆ†åˆ«æ˜¯ç‹¬ç«‹çš„æ•°æ®åº“ã€‚\nç”¨æˆ·ä¸‹å•åˆ†åˆ«è°ƒç”¨äº§å“åº“æ‰£åº“å­˜ï¼Œè´¦æˆ·åº“æ‰£ä½™é¢ã€‚\nå¦‚æœåº“å­˜ä¸è¶³ï¼Œæˆ–ç”¨æˆ·ä½™é¢ä¸è¶³éƒ½æŠ›å‡ºRuntimeExceptionï¼Œè§¦å‘æ•´ä½“å›æ»šã€‚\n@Slf4j @Service @AllArgsConstructor public class OrderService { private final OrderMapper orderMapper; private final AccountService accountService; private final ProductService productService; // @DS(\"order\") è¿™é‡Œä¸éœ€è¦ï¼Œå› ä¸ºorderæ˜¯é»˜è®¤åº“ï¼Œå¦‚æœå¼€å¯äº‹åŠ¡çš„ä¸æ˜¯é»˜è®¤åº“åˆ™å¿…é¡»åŠ  @DSTransactional // æ³¨æ„è¿™é‡Œå¼€å¯äº‹åŠ¡ public void placeOrder(PlaceOrderRequest request) { log.info(\"=============ORDER START=================\"); Long userId = request.getUserId(); Long productId = request.getProductId(); Integer amount = request.getAmount(); log.info(\"æ”¶åˆ°ä¸‹å•è¯·æ±‚,ç”¨æˆ·:{}, å•†å“:{},æ•°é‡:{}\", userId, productId, amount); log.info(\"å½“å‰ XID: {}\", TransactionContext.getXID()); Order order = Order.builder() .userId(userId) .productId(productId) .status(OrderStatus.INIT) .amount(amount) .build(); orderMapper.insert(order); log.info(\"è®¢å•ä¸€é˜¶æ®µç”Ÿæˆï¼Œç­‰å¾…æ‰£åº“å­˜ä»˜æ¬¾ä¸­\"); // æ‰£å‡åº“å­˜å¹¶è®¡ç®—æ€»ä»· Double totalPrice = productService.reduceStock(productId, amount); // æ‰£å‡ä½™é¢ accountService.reduceBalance(userId, totalPrice); order.setStatus(OrderStatus.SUCCESS); order.setTotalPrice(totalPrice); orderMapper.updateById(order); log.info(\"è®¢å•å·²æˆåŠŸä¸‹å•\"); log.info(\"=============ORDER END=================\"); } } @Slf4j @Service @RequiredArgsConstructor public class ProductService { private final ProductMapper productMapper; @DS(\"product\") public Double reduceStock(Long productId, Integer amount) { log.info(\"=============PRODUCT START=================\"); log.info(\"å½“å‰ XID: {}\", TransactionContext.getXID()); // æ£€æŸ¥åº“å­˜ Product product = productMapper.selectById(productId); Assert.notNull(product, \"å•†å“ä¸å­˜åœ¨\"); Integer stock = product.getStock(); log.info(\"å•†å“ç¼–å·ä¸º {} çš„åº“å­˜ä¸º{},è®¢å•å•†å“æ•°é‡ä¸º{}\", productId, stock, amount); if (stock \u003c amount) { log.warn(\"å•†å“ç¼–å·ä¸º{} åº“å­˜ä¸è¶³ï¼Œå½“å‰åº“å­˜:{}\", productId, stock); throw new RuntimeException(\"åº“å­˜ä¸è¶³\"); } log.info(\"å¼€å§‹æ‰£å‡å•†å“ç¼–å·ä¸º {} åº“å­˜,å•ä»·å•†å“ä»·æ ¼ä¸º{}\", productId, product.getPrice()); // æ‰£å‡åº“å­˜ int currentStock = stock - amount; product.setStock(currentStock); productMapper.updateById(product); double totalPrice = product.getPrice() * amount; log.info(\"æ‰£å‡å•†å“ç¼–å·ä¸º {} åº“å­˜æˆåŠŸ,æ‰£å‡ååº“å­˜ä¸º{}, {} ä»¶å•†å“æ€»ä»·ä¸º {} \", productId, currentStock, amount, totalPrice); log.info(\"=============PRODUCT END=================\"); return totalPrice; } } @Slf4j @Service @RequiredArgsConstructor public class AccountService { private final AccountMapper accountMapper; @DS(\"account\") public void reduceBalance(Long userId, Double price) { log.info(\"=============ACCOUNT START=================\"); log.info(\"å½“å‰ XID: {}\", TransactionContext.getXID()); Account account = accountMapper.selectById(userId); Assert.notNull(account, \"ç”¨æˆ·ä¸å­˜åœ¨\"); Double balance = account.getBalance(); log.info(\"ä¸‹å•ç”¨æˆ·{}ä½™é¢ä¸º {},å•†å“æ€»ä»·ä¸º{}\", userId, balance, price); if (balance \u003c price) { log.warn(\"ç”¨æˆ· {} ä½™é¢ä¸è¶³ï¼Œå½“å‰ä½™é¢:{}\", userId, balance); throw new RuntimeException(\"ä½™é¢ä¸è¶³\"); } log.info(\"å¼€å§‹æ‰£å‡ç”¨æˆ· {} ä½™é¢\", userId); double currentBalance = account.getBalance() - price; account.setBalance(currentBalance); accountMapper.updateById(account); log.info(\"æ‰£å‡ç”¨æˆ· {} ä½™é¢æˆåŠŸ,æ‰£å‡åç”¨æˆ·è´¦æˆ·ä½™é¢ä¸º{}\", userId, currentBalance); log.info(\"=============ACCOUNT END=================\"); } } åŸç†ä»‹ç» ç‚¹æˆ‘è·³è½¬\næ ¸å¿ƒåŸç†å°±æ˜¯ä»£ç†connectionï¼Œå¹¶æ ¹æ®ä¸åŒæ•°æ®åº“è·å–åˆ°ä¸€ä¸ªconnectionæ”¾å…¥ConnectionFactoryã€‚\nå¦‚æœæˆåŠŸäº†æ•´ä½“æäº¤ï¼Œå¤±è´¥äº†æ•´ä½“å›æ»šã€‚\nseataäº‹åŠ¡ åŸºç¡€ä»‹ç» seata Githubåœ°å€ï¼šç‚¹æˆ‘è·³è½¬\nseata æ–‡æ¡£ï¼šç‚¹æˆ‘è·³è½¬\nseata ç¤ºä¾‹ï¼šç‚¹æˆ‘è·³è½¬\nPSï¼šä¸€èˆ¬éœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡çš„åœºæ™¯å¤§å¤šæ•°éƒ½æ˜¯å¾®æœåŠ¡åŒ–ï¼Œä¸ªäººå¹¶ä¸å»ºè®®åœ¨å•ä½“é¡¹ç›®å¼•å…¥å¤šæ•°æ®æº+åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œæœ‰èƒ½åŠ›å°½æ—©æ‹†å¼€ï¼Œå¯ä¸ºè¿‡åº¦æ–¹æ¡ˆã€‚\næ³¨æ„äº‹é¡¹ dynamic-datasource-sring-boot-starter ç»„ä»¶å†…éƒ¨å¼€å¯seataåä¼šè‡ªåŠ¨ä½¿ç”¨DataSourceProxyæ¥åŒ…è£…DataSourceï¼Œæ‰€ä»¥éœ€è¦ä»¥ä¸‹æ–¹å¼æ¥ä¿æŒå…¼å®¹ã€‚\n1ã€å¦‚æœä½ å¼•å…¥çš„æ˜¯seata-all,è¯·ä¸è¦ä½¿ç”¨@EnableAutoDataSourceProxyæ³¨è§£ã€‚\n2ã€å¦‚æœä½ å¼•å…¥çš„æ˜¯seata-spring-boot-starter è¯·å…³é—­è‡ªåŠ¨ä»£ç†ã€‚\nseata: enable-auto-data-source-proxy: false ç¤ºä¾‹é¡¹ç›® ç‚¹æˆ‘è·³è½¬\næ­¤å·¥ç¨‹ä¸º å¤šæ•°æ®æº+druid+seata+mybatisPlusçš„ç‰ˆæœ¬ã€‚\næ¨¡æ‹Ÿç”¨æˆ·ä¸‹å•ï¼Œæ‰£å•†å“åº“å­˜ï¼Œæ‰£ç”¨æˆ·ä½™é¢ï¼Œåˆæ­¥å¯åˆ†ä¸ºè®¢å•æœåŠ¡+å•†å“æœåŠ¡+ç”¨æˆ·æœåŠ¡ã€‚\nç¯å¢ƒå‡†å¤‡ ä¸ºäº†å¿«é€Ÿæ¼”ç¤ºç›¸å…³ç¯å¢ƒéƒ½é‡‡ç”¨dockeréƒ¨ç½²ï¼Œç”Ÿäº§ä¸Šçº¿è¯·å‚è€ƒseataå®˜æ–¹æ–‡æ¡£ä½¿ç”¨ã€‚\n1ã€å‡†å¤‡seata-serverã€‚\ndocker run --name seata-server -p 8091:8091 -d seataio/seata-server 2ã€å‡†å¤‡mysqlæ•°æ®åº“ï¼Œè´¦æˆ·rootå¯†ç 123456ã€‚\ndocker run --name mysql -p 3306:3306 -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7 3ã€åˆ›å»ºç›¸å…³æ•°æ®åº“ã€‚\nåˆ›å»º seata-order seata-product seata-account æ¨¡æ‹Ÿè¿æ¥ä¸åŒçš„æ•°æ®åº“ã€‚\nCREATE DATABASE IF NOT EXIST seata-order;\rCREATE DATABASE IF NOT EXIST seata-product;\rCREATE DATABASE IF NOT EXIST seata-account; 4ã€å‡†å¤‡ç›¸å…³æ•°æ®åº“è„šæœ¬ã€‚\næ¯ä¸ªæ•°æ®åº“ä¸‹è„šæœ¬ç›¸å…³çš„è¡¨ï¼Œseataéœ€è¦undo_logæ¥ç›‘æµ‹å’Œå›æ»šã€‚\nç›¸å…³çš„seataè„šæœ¬å¯åˆ°seataå®˜æ–¹è·å–ï¼Œå¦å¤–é…åˆå¤šæ•°æ®æºçš„è‡ªåŠ¨æ‰§è¡Œè„šæœ¬åŠŸèƒ½ï¼Œåº”ç”¨å¯åŠ¨åä¼šè‡ªåŠ¨æ‰§è¡Œã€‚\nå·¥ç¨‹å‡†å¤‡ 1ã€å¼•å…¥ç›¸å…³ä¾èµ–ï¼Œseata+druid+MybatisPlus+dynamic-datasource+mysql+lombokã€‚\nio.seata seata-spring-boot-starter 1.4.2 com.baomidou dynamic-datasource-spring-boot-starter 3.4.0 # çœç•¥ï¼ŒæŸ¥çœ‹ç¤ºä¾‹é¡¹ç›® 2ã€ç¼–å†™ç›¸å…³yamlé…ç½®ã€‚\nspring: application: name: dynamic datasource: dynamic: primary: order strict: true seata: true # å¼€å¯seataä»£ç†ï¼Œå¼€å¯åé»˜è®¤æ¯ä¸ªæ•°æ®æºéƒ½ä»£ç†ï¼Œå¦‚æœæŸä¸ªä¸éœ€è¦ä»£ç†å¯å•ç‹¬å…³é—­ seata-mode: AT # æ”¯æŒXAåŠATæ¨¡å¼,é»˜è®¤AT datasource: order: username: root password: 123456 url: jdbc:mysql://192.168.56.101:3306/seata_order?useUnicode=true\u0026characterEncoding=utf8\u0026allowMultiQueries=true\u0026useSSL=false driver-class-name: com.mysql.cj.jdbc.Driver schema: classpath:db/schema-order.sql account: username: root password: 123456 url: jdbc:mysql://192.168.56.101:3306/seata_account?useUnicode=true\u0026characterEncoding=utf8\u0026allowMultiQueries=true\u0026useSSL=false driver-class-name: com.mysql.cj.jdbc.Driver schema: classpath:db/schema-account.sql product: username: root password: 123456 url: jdbc:mysql://192.168.56.101:3306/seata_product?useUnicode=true\u0026characterEncoding=utf8\u0026allowMultiQueries=true\u0026useSSL=false driver-class-name: com.mysql.cj.jdbc.Driver schema: classpath:db/schema-product.sql test: username: lijing password: \"\" url: jdbc:h2:mem:test driver-class-name: org.h2.Driver seata: false # è¿™ä¸ªæ•°æ®æºä¸éœ€è¦seata seata: enabled: true application-id: applicationName tx-service-group: my_test_tx_group enable-auto-data-source-proxy: false #ä¸€å®šè¦æ˜¯false service: vgroup-mapping: my_test_tx_group: default # keyä¸ä¸Šé¢çš„tx-service-groupçš„å€¼å¯¹åº” grouplist: default: 192.168.56.101:8091 # seata-serveråœ°å€ä»…fileæ³¨å†Œä¸­å¿ƒéœ€è¦ config: type: file registry: type: file ä»£ç ç¼–å†™ å‚è€ƒå·¥ç¨‹ä¸‹é¢çš„ä»£ç å®Œæˆcontroller,service,maaper,entity,dtoç­‰ã€‚\nè®¢å•æœåŠ¡\n@Slf4j @Service public class OrderServiceImpl implements OrderService { @Resource private OrderDao orderDao; @Autowired private AccountService accountService; @Autowired private ProductService productService; @DS(\"order\")// æ¯ä¸€å±‚éƒ½éœ€è¦ä½¿ç”¨å¤šæ•°æ®æºæ³¨è§£åˆ‡æ¢æ‰€é€‰æ‹©çš„æ•°æ®åº“ @Override @Transactional @GlobalTransactional // é‡ç‚¹ ç¬¬ä¸€ä¸ªå¼€å¯äº‹åŠ¡çš„éœ€è¦æ·»åŠ seataå…¨å±€äº‹åŠ¡æ³¨è§£ public void placeOrder(PlaceOrderRequest request) { log.info(\"=============ORDER START=================\"); Long userId = request.getUserId(); Long productId = request.getProductId(); Integer amount = request.getAmount(); log.info(\"æ”¶åˆ°ä¸‹å•è¯·æ±‚,ç”¨æˆ·:{}, å•†å“:{},æ•°é‡:{}\", userId, productId, amount); log.info(\"å½“å‰ XID: {}\", RootContext.getXID()); Order order = Order.builder() .userId(userId) .productId(productId) .status(OrderStatus.INIT) .amount(amount) .build(); orderDao.insert(order); log.info(\"è®¢å•ä¸€é˜¶æ®µç”Ÿæˆï¼Œç­‰å¾…æ‰£åº“å­˜ä»˜æ¬¾ä¸­\"); // æ‰£å‡åº“å­˜å¹¶è®¡ç®—æ€»ä»· Double totalPrice = productService.reduceStock(productId, amount); // æ‰£å‡ä½™é¢ accountService.reduceBalance(userId, totalPrice); order.setStatus(OrderStatus.SUCCESS); order.setTotalPrice(totalPrice); orderDao.updateById(order); log.info(\"è®¢å•å·²æˆåŠŸä¸‹å•\"); log.info(\"=============ORDER END=================\"); } } å•†å“æœåŠ¡\n@Slf4j @Service public class ProductServiceImpl implements ProductService { @Resource private ProductDao productDao; /** * äº‹åŠ¡ä¼ æ’­ç‰¹æ€§è®¾ç½®ä¸º REQUIRES_NEW å¼€å¯æ–°çš„äº‹åŠ¡ é‡è¦ï¼ï¼ï¼ï¼ä¸€å®šè¦ä½¿ç”¨REQUIRES_NEW */ @DS(\"product\") @Transactional(propagation = Propagation.REQUIRES_NEW) @Override public Double reduceStock(Long productId, Integer amount) { log.info(\"=============PRODUCT START=================\"); log.info(\"å½“å‰ XID: {}\", RootContext.getXID()); // æ£€æŸ¥åº“å­˜ Product product = productDao.selectById(productId); Integer stock = product.getStock(); log.info(\"å•†å“ç¼–å·ä¸º {} çš„åº“å­˜ä¸º{},è®¢å•å•†å“æ•°é‡ä¸º{}\", productId, stock, amount); if (stock \u003c amount) { log.warn(\"å•†å“ç¼–å·ä¸º{} åº“å­˜ä¸è¶³ï¼Œå½“å‰åº“å­˜:{}\", productId, stock); throw new RuntimeException(\"åº“å­˜ä¸è¶³\"); } log.info(\"å¼€å§‹æ‰£å‡å•†å“ç¼–å·ä¸º {} åº“å­˜,å•ä»·å•†å“ä»·æ ¼ä¸º{}\", productId, product.getPrice()); // æ‰£å‡åº“å­˜ int currentStock = stock - amount; product.setStock(currentStock); productDao.updateById(product); double totalPrice = product.getPrice() * amount; log.info(\"æ‰£å‡å•†å“ç¼–å·ä¸º {} åº“å­˜æˆåŠŸ,æ‰£å‡ååº“å­˜ä¸º{}, {} ä»¶å•†å“æ€»ä»·ä¸º {} \", productId, currentStock, amount, totalPrice); log.info(\"=============PRODUCT END=================\"); return totalPrice; } } ç”¨æˆ·æœåŠ¡\n@Slf4j @Service public class AccountServiceImpl implements AccountService { @Resource private AccountDao accountDao; /** * äº‹åŠ¡ä¼ æ’­ç‰¹æ€§è®¾ç½®ä¸º REQUIRES_NEW å¼€å¯æ–°çš„äº‹åŠ¡ é‡è¦ï¼ï¼ï¼ï¼ä¸€å®šè¦ä½¿ç”¨REQUIRES_NEW */ @DS(\"account\") @Override @Transactional(propagation = Propagation.REQUIRES_NEW) public void reduceBalance(Long userId, Double price) { log.info(\"=============ACCOUNT START=================\"); log.info(\"å½“å‰ XID: {}\", RootContext.getXID()); Account account = accountDao.selectById(userId); Double balance = account.getBalance(); log.info(\"ä¸‹å•ç”¨æˆ·{}ä½™é¢ä¸º {},å•†å“æ€»ä»·ä¸º{}\", userId, balance, price); if (balance \u003c price) { log.warn(\"ç”¨æˆ· {} ä½™é¢ä¸è¶³ï¼Œå½“å‰ä½™é¢:{}\", userId, balance); throw new RuntimeException(\"ä½™é¢ä¸è¶³\"); } log.info(\"å¼€å§‹æ‰£å‡ç”¨æˆ· {} ä½™é¢\", userId); double currentBalance = account.getBalance() - price; account.setBalance(currentBalance); accountDao.updateById(account); log.info(\"æ‰£å‡ç”¨æˆ· {} ä½™é¢æˆåŠŸ,æ‰£å‡åç”¨æˆ·è´¦æˆ·ä½™é¢ä¸º{}\", userId, currentBalance); log.info(\"=============ACCOUNT END=================\"); } } æµ‹è¯• è‡ªè¡Œç¼–å†™æ¥å£æµ‹è¯•ï¼Œæ³¨æ„è§‚å¯Ÿè¿è¡Œæ—¥å¿—ï¼Œè‡³æ­¤åˆ†å¸ƒå¼äº‹åŠ¡é›†æˆæ¡ˆä¾‹å…¨æµç¨‹å®Œæ¯•ã€‚\näº‹åŠ¡å¸¸è§é—®é¢˜ å»ºè®®å…ˆé˜…è¯»åŸºç¡€çŸ¥è¯†ã€‚\næ ¸å¿ƒçŸ¥è¯†ï¼š springåŸç”Ÿäº‹åŠ¡ä¼šä¿è¯åœ¨äº‹åŠ¡ä¸‹æ•´ä¸ªçº¿ç¨‹åç»­æ‹¿åˆ°çš„éƒ½æ˜¯åŒä¸€ä¸ªconnectionã€‚\næ ¸å¿ƒçŸ¥è¯†ï¼š springåŸç”Ÿäº‹åŠ¡ä¼šä¿è¯åœ¨äº‹åŠ¡ä¸‹æ•´ä¸ªçº¿ç¨‹åç»­æ‹¿åˆ°çš„éƒ½æ˜¯åŒä¸€ä¸ªconnectionã€‚\næ ¸å¿ƒçŸ¥è¯†ï¼š springåŸç”Ÿäº‹åŠ¡ä¼šä¿è¯åœ¨äº‹åŠ¡ä¸‹æ•´ä¸ªçº¿ç¨‹åç»­æ‹¿åˆ°çš„éƒ½æ˜¯åŒä¸€ä¸ªconnectionã€‚\nåŸç”ŸSpringä¸­@Transationalèƒ½å’Œ@DSä¸€èµ·ä½¿ç”¨å—ï¼Ÿ public class AService { @DS(\"a\") @Transational public void dosomething(){ // some code } } å¯ä»¥çš„ï¼Œå…¶ä¼šå…ˆåˆ‡æ¢ä½¿ç”¨æ•°æ®æºaå†å¼€å¯äº‹åŠ¡ï¼Œæ•´ä¸ªåŸç”Ÿäº‹åŠ¡å†…éƒ¨ä¸ç®¡æ˜¯æ³¨è§£åˆ‡æ¢è¿˜æ˜¯æ‰‹åŠ¨è°ƒç”¨ä»£ç åˆ‡æ¢éƒ½ä¸èƒ½åˆ‡æ¢ï¼Œä¼šä¸€ç›´ä½¿ç”¨aæ•°æ®æºã€‚\næ‰€ä»¥ç¡®è®¤æ•´ä¸ªäº‹åŠ¡ä¸‹ä¸å†åˆ‡æ¢å…¶ä»–æ•°æ®æºï¼Œç”¨åŸç”Ÿ @Transational æ˜¯å»ºè®®çš„ï¼Œæ¯•ç«Ÿå…¶æ›´å®Œå–„ã€‚\næœ¬åœ°äº‹åŠ¡å’ŒSpringåŸç”Ÿäº‹åŠ¡ä¸èƒ½æ··ç”¨æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ åœºæ™¯ä¸€ï¼šå…ˆä½¿ç”¨çš„Spring@Transational å†…éƒ¨æ–¹æ³•è°ƒç”¨äº†æœ¬åœ°@DSTransactionalã€‚\npublic class AService { @DS(\"a\") @Transational public void dosomething(){ Bservice.dosomething(); // Bæ˜¯å¦å¤–æ•°æ®æºï¼Œç„¶åæ³¨è§£äº†@DS(\"b\")å’Œ@DSTransactional Cservice.dosomething(); // Cæ˜¯å¦å¤–æ•°æ®æºï¼Œç„¶åæ³¨è§£äº†@DS(\"c\")å’Œ@DSTransactional } } åŸºäºæ ¸å¿ƒçŸ¥è¯†ï¼š äº‹åŠ¡ä¸‹éƒ½æ˜¯aæ•°æ®æºï¼Œå†…éƒ¨æ— è®ºåšä»€ä¹ˆéƒ½æ”¹å˜ä¸äº†ä½¿ç”¨aæ•°æ®æºã€‚\nåœºæ™¯äºŒï¼š å…ˆä½¿ç”¨çš„æœ¬åœ°@DSTransactionalå†…éƒ¨æ–¹æ³•è°ƒç”¨äº†Spring@Transational ã€‚\npublic class AService { @DS(\"a\") @DSTransactional public void dosomething(){ Amapper.updateSomeThing(); Bservice.dosomething(); // Bæ˜¯å¦å¤–æ•°æ®æºï¼Œç„¶åæ³¨è§£äº†@DS(\"b\")å’Œ@Transational Cservice.dosomething(); // Cæ˜¯å¦å¤–æ•°æ®æºï¼Œç„¶åæ³¨è§£äº†@DS(\"c\")å’Œ@Transational } } Bå’ŒCéƒ½æ˜¯ç‹¬ç«‹çš„äº‹åŠ¡ã€‚Cå‘ç”Ÿé”™è¯¯Bä¼šå›æ»šå—ï¼Ÿä¸ä¼šBå·²ç»æäº¤äº†ã€‚Aä¼šå›æ»šå—ï¼Ÿä¼šã€‚\nä¸å»ºè®®æ··ç”¨ï¼Œé™¤éä½ ç¡®å®éå¸¸ç†è§£äº‹åŠ¡ï¼Œèƒ½éšå¿ƒæ‰€æ¬²æŒæ¡ä½ ä»£ç çš„æ‰§è¡Œæµç¨‹ã€‚\næœ¬åœ°äº‹åŠ¡æ ‡å‡†ä½¿ç”¨ public class AService { @DS(\"a\") @DSTransactional // æœ€å¤–å±‚å¼€å¯å³å¯ public void dosomething(){ Amapper.updateSomeThing(); Bservice.dosomething(); // Bæ˜¯å¦å¤–æ•°æ®æºï¼Œç„¶åæ³¨è§£äº†@DS(\"b\") Cservice.dosomething(); // Cæ˜¯å¦å¤–æ•°æ®æºï¼Œç„¶åæ³¨è§£äº†@DS(\"c\") } } è°ƒè¯•æºç  1ã€å¼€å¯åŠ¨æ€æ•°æ®æºçš„debugæ—¥å¿—ã€‚\nlogging: level: com.baomidou.dynamic: debug æ£€æŸ¥æ—¥å¿—è¾“å‡ºæ˜¯å¦æ­£ç¡®ã€‚\n2ã€æ–­ç‚¹è°ƒè¯•DynamicDataSourceAnnotationInterceptorã€‚\npublic class DynamicDataSourceAnnotationInterceptor implements MethodInterceptor { private static final String DYNAMIC_PREFIX = \"#\"; private final DataSourceClassResolver dataSourceClassResolver; private final DsProcessor dsProcessor; public DynamicDataSourceAnnotationInterceptor(Boolean allowedPublicOnly, DsProcessor dsProcessor) { dataSourceClassResolver = new DataSourceClassResolver(allowedPublicOnly); this.dsProcessor = dsProcessor; } @Override public Object invoke(MethodInvocation invocation) throws Throwable { try { // è¿™é‡ŒæŠŠè·å–åˆ°çš„æ•°æ®æºæ ‡è¯†å¦‚masterå­˜å…¥æœ¬åœ°çº¿ç¨‹ String dsKey = determineDatasourceKey(invocation); â— DynamicDataSourceContextHolder.push(dsKey); return invocation.proceed(); } finally { DynamicDataSourceContextHolder.poll(); } } private String determineDatasourceKey(MethodInvocation invocation) { String key = dataSourceClassResolver.findDSKey(invocation.getMethod(), invocation.getThis()); return (!key.isEmpty() \u0026\u0026 key.startsWith(DYNAMIC_PREFIX)) ? dsProcessor.determineDatasource(invocation, key) : key; } } 3ã€æ–­ç‚¹è°ƒè¯•DynamicRoutingDataSourceã€‚\npublic class DynamicRoutingDataSource extends AbstractRoutingDataSource { private Map\u003cString, DataSource\u003e dataSourceMap = new LinkedHashMap\u003c\u003e(); private Map\u003cString, DynamicGroupDataSource\u003e groupDataSources = new ConcurrentHashMap\u003c\u003e(); @Override public DataSource determineDataSource() { // ä»æœ¬åœ°çº¿ç¨‹è·å–keyè§£ææœ€ç»ˆçœŸå®çš„æ•°æ®æº â— String dsKey = DynamicDataSourceContextHolder.peek(); return getDataSource(dsKey); } private DataSource determinePrimaryDataSource() { log.debug(\"ä»é»˜è®¤æ•°æ®æºä¸­è¿”å›æ•°æ®\"); return groupDataSources.containsKey(primary) ? groupDataSources.get(primary).determineDataSource() : dataSourceMap.get(primary); } public DataSource getDataSource(String ds) { if (StringUtils.isEmpty(ds)) { return determinePrimaryDataSource(); } else if (!groupDataSources.isEmpty() \u0026\u0026 groupDataSources.containsKey(ds)) { log.debug(\"ä» {} ç»„æ•°æ®æºä¸­è¿”å›æ•°æ®æº\", ds); return groupDataSources.get(ds).determineDataSource(); } else if (dataSourceMap.containsKey(ds)) { log.debug(\"ä» {} å•æ•°æ®æºä¸­è¿”å›æ•°æ®æº\", ds); return dataSourceMap.get(ds); } return determinePrimaryDataSource(); } } å¸¸è§é—®é¢˜ä¹‹-åˆ‡æ¢æ•°æ®æºå¤±è´¥ å¼€å¯äº†springçš„äº‹åŠ¡ åŸå› ï¼š springå¼€å¯äº‹åŠ¡åä¼šç»´æŠ¤ä¸€ä¸ªConnectionHolderï¼Œä¿è¯åœ¨æ•´ä¸ªäº‹åŠ¡ä¸‹ï¼Œéƒ½æ˜¯ç”¨åŒä¸€ä¸ªæ•°æ®åº“è¿æ¥ã€‚\nè¯·æ£€æŸ¥æ•´ä¸ªè°ƒç”¨é“¾è·¯æ¶‰åŠçš„ç±»çš„æ–¹æ³•å’Œç±»æœ¬èº«è¿˜æœ‰ç»§æ‰¿çš„æŠ½è±¡ç±»ä¸Šæ˜¯å¦æœ‰@Transactionalæ³¨è§£ã€‚\nå¦‚å¼ºçƒˆéœ€è¦äº‹åŠ¡ä¿è¯å¤šä¸ªåº“åŒæ—¶æ‰§è¡ŒæˆåŠŸæˆ–è€…å¤±è´¥ï¼Œè¯·æŸ¥çœ‹äº‹åŠ¡ä¸“æ çš„è§£å†³åŠæ³•ã€‚\næ–¹æ³•å†…éƒ¨è°ƒç”¨ æŸ¥çœ‹ä»¥ä¸‹ç¤ºä¾‹\nå¤–éƒ¨è°ƒç”¨ userservice.test1() èƒ½åœ¨æ‰§è¡Œåˆ° test2() åˆ‡æ¢åˆ°secondæ•°æ®æºå—ï¼Ÿ\npublic UserService { @DS(\"first\") public void test1() { // do something test2(); } @DS(\"second\") public void test2() { // do something } } ç­”æ¡ˆï¼šï¼ï¼ï¼ä¸èƒ½ä¸èƒ½ä¸èƒ½ï¼ï¼ï¼æ•°æ®æºæ ¸å¿ƒåŸç†æ˜¯åŸºäºaopä»£ç†å®ç°åˆ‡æ¢ï¼Œå†…éƒ¨æ–¹æ³•è°ƒç”¨ä¸ä¼šä½¿ç”¨aopã€‚\nè§£å†³æ–¹æ³•:\næŠŠtest2()æ–¹æ³•æåˆ°å¦å¤–ä¸€ä¸ªserviceï¼Œå•ç‹¬è°ƒç”¨ã€‚\nPostConstructåˆå§‹åŒ–é¡ºåº åˆå§‹åŒ–åŒ…æ‹¬: @PostConstruct æ³¨è§£, InitializingBeanæ¥å£, è‡ªå®šä¹‰init-method\n@Component public class MyConfiguration { @Resource private UserMapper userMapper; @DS(\"slave\") @PostConstruct public void init(){ // æ— æ³•é€‰æ‹©æ­£ç¡®çš„æ•°æ®æº userMapper.selectById(1); } } è§£å†³æ–¹æ³•ï¼šç›‘å¬å®¹å™¨å¯åŠ¨å®Œæˆäº‹ä»¶, åœ¨å®¹å™¨å®Œæˆååšåˆå§‹åŒ–ã€‚\n@Component public class MyConfiguration { @DS(\"slave\") @EventListener public void onApplicationEvent(ContextRefreshedEvent event) { // æˆåŠŸé€‰æ‹©æ­£ç¡®çš„æ•°æ®æº userMapper.selectById(1); } } ç›¸å…³springæºç  : org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#initializeBean\nåœ¨åˆå§‹åŒ–å®Œæˆå, bean è¿›å…¥å¢å¼ºé˜¶æ®µ, æ‰€ä»¥è¿™ä¸ªé˜¶æ®µçš„ä»»ä½•AOPéƒ½æ˜¯æ— æ•ˆçš„ã€‚\nDruidç‰ˆæœ¬è¿‡ä½ è¯·å‡çº§druid1.1.22åŠä»¥ä¸Šç‰ˆæœ¬ï¼Œè¿™ä¸ªç‰ˆæœ¬ä¿®å¤äº†åœ¨é«˜å¹¶å‘ä¸‹å¶å‘çš„åˆ‡æ¢å¤±æ•ˆé—®é¢˜ã€‚\n@Asyncæˆ–è€…java8çš„ParallelStreamå¹¶è¡Œæµä¹‹ç±»æ–¹æ³• è¿™ç§æƒ…å†µéƒ½æ˜¯æ–°å¼€äº†çº¿ç¨‹å»å¼‚æ­¥å¤„ç†ï¼Œä¸å—å½“å‰çº¿ç¨‹ç®¡æ§äº†ã€‚\nå¯ä»¥åœ¨æ–°å¼€çš„æ–¹æ³•ä¸ŠåŠ å¯¹åº”çš„DSæ³¨è§£è§£å†³ã€‚\nçŸ¥è¯†åº“ å¦‚ä½•æ³¨å…¥å¤šæ•°æ®æºï¼Ÿ public class A{ @Autowired private DataSource dataSource; public void dosomething{ // ä½¿ç”¨çš„æ—¶å€™éœ€è¦å¼ºè½¬ DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource; } } å¦‚ä½•è·å–å½“å‰çº¿ç¨‹æ•°æ®æºåç§°ï¼Ÿ DynamicDataSourceContextHolder.peek() å¦‚ä½•è·å–å½“å‰çº¿ç¨‹æ•°æ®æºï¼Ÿ public void dosomething{ DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource; DataSource datasource=ds.determineDataSource(); } æœ¬æ–‡å‚è€ƒè‡³ï¼šhttps://www.xiaojingge.com/archives/ef008289-8ab8-485c-8019-2703267c7beb\n","wordCount":"18600","inLanguage":"zh-cn","datePublished":"2025-06-13T00:00:00Z","dateModified":"2025-06-13T00:00:00Z","author":{"@type":"Person","name":"Lesan"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://lesanouo.github.io/blog/posts/code/174974400001/"},"publisher":{"@type":"Organization","name":"Lesan's Blog","logo":{"@type":"ImageObject","url":"https://lesanouo.github.io/blog/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://lesanouo.github.io/blog/ accesskey=h title="Lesan's Blog (Alt + H)">Lesan's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://lesanouo.github.io/blog/archives title="ğŸ“š å½’æ¡£"><span>ğŸ“š å½’æ¡£</span></a></li><li><a href=https://lesanouo.github.io/blog/categories/ title="ğŸ—ƒï¸ åˆ†ç±»"><span>ğŸ—ƒï¸ åˆ†ç±»</span></a></li><li><a href=https://lesanouo.github.io/blog/tags/ title="ğŸ·ï¸ æ ‡ç­¾"><span>ğŸ·ï¸ æ ‡ç­¾</span></a></li><li><a href=https://lesanouo.github.io/blog/search/ title="ğŸ” æœç´¢"><span>ğŸ” æœç´¢</span></a></li><li><a href=https://lesanouo.github.io/blog/about/ title="ğŸ‘¨â€ğŸ’» å…³äºæˆ‘"><span>ğŸ‘¨â€ğŸ’» å…³äºæˆ‘</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://lesanouo.github.io/blog/>Home</a>&nbsp;Â»&nbsp;<a href=https://lesanouo.github.io/blog/posts/>ğŸ“š åšå®¢</a></div><h1 class="post-title entry-hint-parent">dynamic-datasourceæ–‡æ¡£</h1><div class=post-meta><span title='2025-06-13 00:00:00 +0000 UTC'>2025-06-13</span>&nbsp;Â·&nbsp;38 min&nbsp;Â·&nbsp;Lesan</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e7%89%b9%e6%80%a7 aria-label=ç‰¹æ€§>ç‰¹æ€§</a></li><li><a href=#%e7%ba%a6%e5%ae%9a aria-label=çº¦å®š>çº¦å®š</a></li><li><a href=#%e4%bd%bf%e7%94%a8%e6%96%b9%e6%b3%95 aria-label=ä½¿ç”¨æ–¹æ³•>ä½¿ç”¨æ–¹æ³•</a></li><li><a href=#ds%e6%94%be%e5%9c%a8%e5%93%aa%e9%87%8c%e5%90%88%e9%80%82 aria-label=DSæ”¾åœ¨å“ªé‡Œåˆé€‚>DSæ”¾åœ¨å“ªé‡Œåˆé€‚</a></li><li><a href=#%e8%bf%9e%e6%8e%a5%e6%b1%a0%e9%9b%86%e6%88%90 aria-label=è¿æ¥æ± é›†æˆ>è¿æ¥æ± é›†æˆ</a><ul><li><a href=#%e8%bf%9e%e6%8e%a5%e6%b1%a0%e5%bf%85%e8%af%bb aria-label=è¿æ¥æ± å¿…è¯»>è¿æ¥æ± å¿…è¯»</a></li><li><a href=#%e9%9b%86%e6%88%90druid aria-label=é›†æˆDruid>é›†æˆDruid</a><ul><li><a href=#%e5%9f%ba%e7%a1%80%e4%bb%8b%e7%bb%8d aria-label=åŸºç¡€ä»‹ç»>åŸºç¡€ä»‹ç»</a></li><li><a href=#%e9%9b%86%e6%88%90%e6%ad%a5%e9%aa%a4 aria-label=é›†æˆæ­¥éª¤>é›†æˆæ­¥éª¤</a></li><li><a href=#%e7%a4%ba%e4%be%8b%e9%a1%b9%e7%9b%ae aria-label=ç¤ºä¾‹é¡¹ç›®>ç¤ºä¾‹é¡¹ç›®</a></li><li><a href=#%e6%a0%b8%e5%bf%83%e6%ba%90%e7%a0%81 aria-label=æ ¸å¿ƒæºç >æ ¸å¿ƒæºç </a></li></ul></li><li><a href=#%e9%9b%86%e6%88%90hikaricp aria-label=é›†æˆHikariCP>é›†æˆHikariCP</a><ul><li><a href=#%e5%9f%ba%e7%a1%80%e4%bb%8b%e7%bb%8d-1 aria-label=åŸºç¡€ä»‹ç»>åŸºç¡€ä»‹ç»</a></li><li><a href=#%e9%9b%86%e6%88%90%e6%ad%a5%e9%aa%a4-1 aria-label=é›†æˆæ­¥éª¤>é›†æˆæ­¥éª¤</a></li><li><a href=#%e5%b8%b8%e8%a7%81%e9%97%ae%e9%a2%98 aria-label=å¸¸è§é—®é¢˜>å¸¸è§é—®é¢˜</a></li><li><a href=#%e6%a0%b8%e5%bf%83%e6%ba%90%e7%a0%81-1 aria-label=æ ¸å¿ƒæºç >æ ¸å¿ƒæºç </a></li></ul></li></ul></li><li><a href=#%e7%ac%ac%e4%b8%89%e6%96%b9%e9%9b%86%e6%88%90 aria-label=ç¬¬ä¸‰æ–¹é›†æˆ>ç¬¬ä¸‰æ–¹é›†æˆ</a><ul><li><a href=#%e9%9b%86%e6%88%90mybatisplus aria-label=é›†æˆMybatisPlus>é›†æˆMybatisPlus</a><ul><li><a href=#%e5%9f%ba%e7%a1%80%e4%bb%8b%e7%bb%8d-2 aria-label=åŸºç¡€ä»‹ç»>åŸºç¡€ä»‹ç»</a></li><li><a href=#%e9%9b%86%e6%88%90%e6%ad%a5%e9%aa%a4-2 aria-label=é›†æˆæ­¥éª¤>é›†æˆæ­¥éª¤</a></li><li><a href=#%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9 aria-label=æ³¨æ„äº‹é¡¹>æ³¨æ„äº‹é¡¹</a></li><li><a href=#faq aria-label=FAQ>FAQ</a></li><li><a href=#%e7%a4%ba%e4%be%8b%e9%a1%b9%e7%9b%ae-1 aria-label=ç¤ºä¾‹é¡¹ç›®>ç¤ºä¾‹é¡¹ç›®</a></li></ul></li><li><a href=#%e5%85%b6%e4%bb%96%e9%9b%86%e6%88%90 aria-label=å…¶ä»–é›†æˆ>å…¶ä»–é›†æˆ</a></li></ul></li><li><a href=#%e8%bf%9b%e9%98%b6%e4%bd%bf%e7%94%a8 aria-label=è¿›é˜¶ä½¿ç”¨>è¿›é˜¶ä½¿ç”¨</a><ul><li><a href=#%e5%8a%a8%e6%80%81%e6%b7%bb%e5%8a%a0%e7%a7%bb%e9%99%a4%e6%95%b0%e6%8d%ae%e6%ba%90 aria-label=åŠ¨æ€æ·»åŠ ç§»é™¤æ•°æ®æº>åŠ¨æ€æ·»åŠ ç§»é™¤æ•°æ®æº</a><ul><li><a href=#%e5%9f%ba%e7%a1%80%e4%bb%8b%e7%bb%8d-3 aria-label=åŸºç¡€ä»‹ç»>åŸºç¡€ä»‹ç»</a></li><li><a href=#%e4%bd%bf%e7%94%a8%e6%ad%a5%e9%aa%a4 aria-label=ä½¿ç”¨æ­¥éª¤>ä½¿ç”¨æ­¥éª¤</a></li><li><a href=#%e7%a4%ba%e4%be%8b%e9%a1%b9%e7%9b%ae-2 aria-label=ç¤ºä¾‹é¡¹ç›®>ç¤ºä¾‹é¡¹ç›®</a></li><li><a href=#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90 aria-label=æºç åˆ†æ>æºç åˆ†æ</a></li></ul></li><li><a href=#%e5%8a%a8%e6%80%81%e8%a7%a3%e6%9e%90%e6%95%b0%e6%8d%ae%e6%ba%90 aria-label=åŠ¨æ€è§£ææ•°æ®æº>åŠ¨æ€è§£ææ•°æ®æº</a><ul><li><a href=#%e5%9f%ba%e7%a1%80%e4%bb%8b%e7%bb%8d-4 aria-label=åŸºç¡€ä»‹ç»>åŸºç¡€ä»‹ç»</a></li><li><a href=#%e5%a6%82%e4%bd%95%e6%89%a9%e5%b1%95 aria-label=å¦‚ä½•æ‰©å±•>å¦‚ä½•æ‰©å±•</a></li><li><a href=#%e6%b3%a8%e6%84%8f aria-label=æ³¨æ„>æ³¨æ„</a></li></ul></li><li><a href=#%e6%95%b0%e6%8d%ae%e5%ba%93%e5%8a%a0%e5%af%86 aria-label=æ•°æ®åº“åŠ å¯†>æ•°æ®åº“åŠ å¯†</a><ul><li><a href=#%e5%9f%ba%e7%a1%80%e4%bb%8b%e7%bb%8d-5 aria-label=åŸºç¡€ä»‹ç»>åŸºç¡€ä»‹ç»</a></li><li><a href=#%e5%85%b7%e4%bd%93%e4%bd%bf%e7%94%a8 aria-label=å…·ä½“ä½¿ç”¨>å…·ä½“ä½¿ç”¨</a></li><li><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e8%a7%a3%e5%af%86 aria-label=è‡ªå®šä¹‰è§£å¯†>è‡ªå®šä¹‰è§£å¯†</a></li><li><a href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e4%b8%8d%e6%98%af%e5%85%ac%e9%92%a5%e5%8a%a0%e5%af%86%e7%a7%81%e9%92%a5%e8%a7%a3%e5%af%86 aria-label=ä¸ºä»€ä¹ˆä¸æ˜¯å…¬é’¥åŠ å¯†ï¼Œç§é’¥è§£å¯†>ä¸ºä»€ä¹ˆä¸æ˜¯å…¬é’¥åŠ å¯†ï¼Œç§é’¥è§£å¯†</a></li></ul></li><li><a href=#%e5%90%af%e5%8a%a8%e5%88%9d%e5%a7%8b%e5%8c%96%e6%89%a7%e8%a1%8c%e8%84%9a%e6%9c%ac aria-label=å¯åŠ¨åˆå§‹åŒ–æ‰§è¡Œè„šæœ¬>å¯åŠ¨åˆå§‹åŒ–æ‰§è¡Œè„šæœ¬</a></li><li><a href=#%e6%87%92%e5%90%af%e5%8a%a8%e6%95%b0%e6%8d%ae%e6%ba%90 aria-label=æ‡’å¯åŠ¨æ•°æ®æº>æ‡’å¯åŠ¨æ•°æ®æº</a><ul><li><a href=#%e9%85%8d%e7%bd%ae%e4%bd%bf%e7%94%a8 aria-label=é…ç½®ä½¿ç”¨>é…ç½®ä½¿ç”¨</a></li></ul></li><li><a href=#%e6%97%a0%e6%95%b0%e6%8d%ae%e6%ba%90%e5%90%af%e5%8a%a8 aria-label=æ— æ•°æ®æºå¯åŠ¨>æ— æ•°æ®æºå¯åŠ¨</a><ul><li><a href=#%e5%9f%ba%e7%a1%80%e4%bb%8b%e7%bb%8d-6 aria-label=åŸºç¡€ä»‹ç»>åŸºç¡€ä»‹ç»</a></li><li><a href=#%e9%85%8d%e7%bd%ae%e6%96%b9%e5%bc%8f aria-label=é…ç½®æ–¹å¼>é…ç½®æ–¹å¼</a></li></ul></li><li><a href=#%e6%89%8b%e5%8a%a8%e5%88%87%e6%8d%a2%e6%95%b0%e6%8d%ae%e6%ba%90 aria-label=æ‰‹åŠ¨åˆ‡æ¢æ•°æ®æº>æ‰‹åŠ¨åˆ‡æ¢æ•°æ®æº</a></li><li><a href=#%e6%89%8b%e5%8a%a8%e6%b3%a8%e5%85%a5%e5%a4%9a%e6%95%b0%e6%8d%ae%e6%ba%90 aria-label=æ‰‹åŠ¨æ³¨å…¥å¤šæ•°æ®æº>æ‰‹åŠ¨æ³¨å…¥å¤šæ•°æ®æº</a></li></ul></li><li><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89 aria-label=è‡ªå®šä¹‰>è‡ªå®šä¹‰</a><ul><li><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e6%b3%a8%e8%a7%a3 aria-label=è‡ªå®šä¹‰æ³¨è§£>è‡ªå®šä¹‰æ³¨è§£</a><ul><li><a href=#%e5%9f%ba%e7%a1%80%e4%bb%8b%e7%bb%8d-7 aria-label=åŸºç¡€ä»‹ç»>åŸºç¡€ä»‹ç»</a></li><li><a href=#%e4%bd%bf%e7%94%a8%e6%96%b9%e6%b3%95-1 aria-label=ä½¿ç”¨æ–¹æ³•>ä½¿ç”¨æ–¹æ³•</a></li></ul></li><li><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e6%95%b0%e6%8d%ae%e6%ba%90%e6%9d%a5%e6%ba%90 aria-label=è‡ªå®šä¹‰æ•°æ®æºæ¥æº>è‡ªå®šä¹‰æ•°æ®æºæ¥æº</a><ul><li><a href=#%e5%9f%ba%e7%a1%80%e4%bb%8b%e7%bb%8d-8 aria-label=åŸºç¡€ä»‹ç»>åŸºç¡€ä»‹ç»</a></li><li><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e7%a4%ba%e4%be%8b aria-label=è‡ªå®šä¹‰ç¤ºä¾‹>è‡ªå®šä¹‰ç¤ºä¾‹</a></li></ul></li><li><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e7%ad%96%e7%95%a5 aria-label=è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥>è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥</a><ul><li><a href=#%e5%9f%ba%e7%a1%80%e4%bb%8b%e7%bb%8d-9 aria-label=åŸºç¡€ä»‹ç»>åŸºç¡€ä»‹ç»</a></li><li><a href=#%e5%a6%82%e4%bd%95%e8%87%aa%e5%ae%9a%e4%b9%89 aria-label=å¦‚ä½•è‡ªå®šä¹‰>å¦‚ä½•è‡ªå®šä¹‰</a></li></ul></li></ul></li><li><a href=#%e6%97%a0%e6%b3%a8%e8%a7%a3%e6%96%b9%e6%a1%88 aria-label=æ— æ³¨è§£æ–¹æ¡ˆ>æ— æ³¨è§£æ–¹æ¡ˆ</a><ul><li><a href=#filter%e5%88%87%e6%8d%a2%e6%95%b0%e6%8d%ae%e6%ba%90 aria-label=filteråˆ‡æ¢æ•°æ®æº>filteråˆ‡æ¢æ•°æ®æº</a></li><li><a href=#intercepror%e5%88%87%e6%8d%a2%e6%95%b0%e6%8d%ae%e6%ba%90 aria-label=interceproråˆ‡æ¢æ•°æ®æº>interceproråˆ‡æ¢æ•°æ®æº</a></li><li><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e5%88%87%e9%9d%a2 aria-label=è‡ªå®šä¹‰åˆ‡é¢>è‡ªå®šä¹‰åˆ‡é¢</a></li><li><a href=#mybatis%e4%b8%8b%e8%af%bb%e5%86%99%e5%88%86%e7%a6%bb aria-label=mybatisä¸‹è¯»å†™åˆ†ç¦»>mybatisä¸‹è¯»å†™åˆ†ç¦»</a></li></ul></li><li><a href=#%e4%ba%8b%e5%8a%a1%e4%b8%93%e6%a0%8f aria-label=äº‹åŠ¡ä¸“æ >äº‹åŠ¡ä¸“æ </a><ul><li><a href=#%e4%ba%8b%e5%8a%a1%e6%a6%82%e5%bf%b5 aria-label=äº‹åŠ¡æ¦‚å¿µ>äº‹åŠ¡æ¦‚å¿µ</a><ul><li><a href=#%e4%bb%80%e4%b9%88%e6%98%af%e4%ba%8b%e5%8a%a1 aria-label=ä»€ä¹ˆæ˜¯äº‹åŠ¡ï¼Ÿ>ä»€ä¹ˆæ˜¯äº‹åŠ¡ï¼Ÿ</a></li><li><a href=#%e5%8e%9f%e7%94%9fjdbc%e5%a4%84%e7%90%86%e4%ba%8b%e5%8a%a1 aria-label=åŸç”ŸJDBCå¤„ç†äº‹åŠ¡>åŸç”ŸJDBCå¤„ç†äº‹åŠ¡</a></li><li><a href=#spring%e5%a4%84%e7%90%86%e4%ba%8b%e5%8a%a1 aria-label=Springå¤„ç†äº‹åŠ¡>Springå¤„ç†äº‹åŠ¡</a></li></ul></li><li><a href=#%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86 aria-label=åŸºç¡€çŸ¥è¯†>åŸºç¡€çŸ¥è¯†</a></li><li><a href=#%e6%9c%ac%e5%9c%b0%e4%ba%8b%e5%8a%a1 aria-label=æœ¬åœ°äº‹åŠ¡>æœ¬åœ°äº‹åŠ¡</a><ul><li><a href=#%e8%83%8c%e6%99%af aria-label=èƒŒæ™¯>èƒŒæ™¯</a></li><li><a href=#%e5%9f%ba%e7%a1%80%e4%bb%8b%e7%bb%8d-10 aria-label=åŸºç¡€ä»‹ç»>åŸºç¡€ä»‹ç»</a></li><li><a href=#%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9-1 aria-label=æ³¨æ„äº‹é¡¹>æ³¨æ„äº‹é¡¹</a></li><li><a href=#%e4%bd%bf%e7%94%a8%e6%96%b9%e6%b3%95-2 aria-label=ä½¿ç”¨æ–¹æ³•>ä½¿ç”¨æ–¹æ³•</a></li><li><a href=#%e7%a4%ba%e4%be%8b%e9%a1%b9%e7%9b%ae-3 aria-label=ç¤ºä¾‹é¡¹ç›®>ç¤ºä¾‹é¡¹ç›®</a></li><li><a href=#%e5%8e%9f%e7%90%86%e4%bb%8b%e7%bb%8d aria-label=åŸç†ä»‹ç»>åŸç†ä»‹ç»</a></li></ul></li><li><a href=#seata%e4%ba%8b%e5%8a%a1 aria-label=seataäº‹åŠ¡>seataäº‹åŠ¡</a><ul><li><a href=#%e5%9f%ba%e7%a1%80%e4%bb%8b%e7%bb%8d-11 aria-label=åŸºç¡€ä»‹ç»>åŸºç¡€ä»‹ç»</a></li><li><a href=#%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9-2 aria-label=æ³¨æ„äº‹é¡¹>æ³¨æ„äº‹é¡¹</a></li><li><a href=#%e7%a4%ba%e4%be%8b%e9%a1%b9%e7%9b%ae-4 aria-label=ç¤ºä¾‹é¡¹ç›®>ç¤ºä¾‹é¡¹ç›®</a></li><li><a href=#%e7%8e%af%e5%a2%83%e5%87%86%e5%a4%87 aria-label=ç¯å¢ƒå‡†å¤‡>ç¯å¢ƒå‡†å¤‡</a></li><li><a href=#%e5%b7%a5%e7%a8%8b%e5%87%86%e5%a4%87 aria-label=å·¥ç¨‹å‡†å¤‡>å·¥ç¨‹å‡†å¤‡</a></li><li><a href=#%e4%bb%a3%e7%a0%81%e7%bc%96%e5%86%99 aria-label=ä»£ç ç¼–å†™>ä»£ç ç¼–å†™</a></li><li><a href=#%e6%b5%8b%e8%af%95 aria-label=æµ‹è¯•>æµ‹è¯•</a></li></ul></li><li><a href=#%e4%ba%8b%e5%8a%a1%e5%b8%b8%e8%a7%81%e9%97%ae%e9%a2%98 aria-label=äº‹åŠ¡å¸¸è§é—®é¢˜>äº‹åŠ¡å¸¸è§é—®é¢˜</a><ul><li><a href=#%e5%8e%9f%e7%94%9fspring%e4%b8%adtransational%e8%83%bd%e5%92%8cds%e4%b8%80%e8%b5%b7%e4%bd%bf%e7%94%a8%e5%90%97 aria-label=åŸç”ŸSpringä¸­@Transationalèƒ½å’Œ@DSä¸€èµ·ä½¿ç”¨å—ï¼Ÿ>åŸç”ŸSpringä¸­@Transationalèƒ½å’Œ@DSä¸€èµ·ä½¿ç”¨å—ï¼Ÿ</a></li><li><a href=#%e6%9c%ac%e5%9c%b0%e4%ba%8b%e5%8a%a1%e5%92%8cspring%e5%8e%9f%e7%94%9f%e4%ba%8b%e5%8a%a1%e4%b8%8d%e8%83%bd%e6%b7%b7%e7%94%a8%e6%98%af%e4%bb%80%e4%b9%88%e6%84%8f%e6%80%9d aria-label=æœ¬åœ°äº‹åŠ¡å’ŒSpringåŸç”Ÿäº‹åŠ¡ä¸èƒ½æ··ç”¨æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ>æœ¬åœ°äº‹åŠ¡å’ŒSpringåŸç”Ÿäº‹åŠ¡ä¸èƒ½æ··ç”¨æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ</a></li><li><a href=#%e6%9c%ac%e5%9c%b0%e4%ba%8b%e5%8a%a1%e6%a0%87%e5%87%86%e4%bd%bf%e7%94%a8 aria-label=æœ¬åœ°äº‹åŠ¡æ ‡å‡†ä½¿ç”¨>æœ¬åœ°äº‹åŠ¡æ ‡å‡†ä½¿ç”¨</a></li></ul></li></ul></li><li><a href=#%e8%b0%83%e8%af%95%e6%ba%90%e7%a0%81 aria-label=è°ƒè¯•æºç >è°ƒè¯•æºç </a></li><li><a href=#%e5%b8%b8%e8%a7%81%e9%97%ae%e9%a2%98%e4%b9%8b-%e5%88%87%e6%8d%a2%e6%95%b0%e6%8d%ae%e6%ba%90%e5%a4%b1%e8%b4%a5 aria-label=å¸¸è§é—®é¢˜ä¹‹-åˆ‡æ¢æ•°æ®æºå¤±è´¥>å¸¸è§é—®é¢˜ä¹‹-åˆ‡æ¢æ•°æ®æºå¤±è´¥</a><ul><li><a href=#%e5%bc%80%e5%90%af%e4%ba%86spring%e7%9a%84%e4%ba%8b%e5%8a%a1 aria-label=å¼€å¯äº†springçš„äº‹åŠ¡>å¼€å¯äº†springçš„äº‹åŠ¡</a></li><li><a href=#%e6%96%b9%e6%b3%95%e5%86%85%e9%83%a8%e8%b0%83%e7%94%a8 aria-label=æ–¹æ³•å†…éƒ¨è°ƒç”¨>æ–¹æ³•å†…éƒ¨è°ƒç”¨</a></li><li><a href=#postconstruct%e5%88%9d%e5%a7%8b%e5%8c%96%e9%a1%ba%e5%ba%8f aria-label=PostConstructåˆå§‹åŒ–é¡ºåº>PostConstructåˆå§‹åŒ–é¡ºåº</a></li><li><a href=#druid%e7%89%88%e6%9c%ac%e8%bf%87%e4%bd%8e aria-label=Druidç‰ˆæœ¬è¿‡ä½>Druidç‰ˆæœ¬è¿‡ä½</a></li><li><a href=#async%e6%88%96%e8%80%85java8%e7%9a%84parallelstream%e5%b9%b6%e8%a1%8c%e6%b5%81%e4%b9%8b%e7%b1%bb%e6%96%b9%e6%b3%95 aria-label=@Asyncæˆ–è€…java8çš„ParallelStreamå¹¶è¡Œæµä¹‹ç±»æ–¹æ³•>@Asyncæˆ–è€…java8çš„ParallelStreamå¹¶è¡Œæµä¹‹ç±»æ–¹æ³•</a></li></ul></li><li><a href=#%e7%9f%a5%e8%af%86%e5%ba%93 aria-label=çŸ¥è¯†åº“>çŸ¥è¯†åº“</a><ul><li><a href=#%e5%a6%82%e4%bd%95%e6%b3%a8%e5%85%a5%e5%a4%9a%e6%95%b0%e6%8d%ae%e6%ba%90 aria-label=å¦‚ä½•æ³¨å…¥å¤šæ•°æ®æºï¼Ÿ>å¦‚ä½•æ³¨å…¥å¤šæ•°æ®æºï¼Ÿ</a></li><li><a href=#%e5%a6%82%e4%bd%95%e8%8e%b7%e5%8f%96%e5%bd%93%e5%89%8d%e7%ba%bf%e7%a8%8b%e6%95%b0%e6%8d%ae%e6%ba%90%e5%90%8d%e7%a7%b0 aria-label=å¦‚ä½•è·å–å½“å‰çº¿ç¨‹æ•°æ®æºåç§°ï¼Ÿ>å¦‚ä½•è·å–å½“å‰çº¿ç¨‹æ•°æ®æºåç§°ï¼Ÿ</a></li><li><a href=#%e5%a6%82%e4%bd%95%e8%8e%b7%e5%8f%96%e5%bd%93%e5%89%8d%e7%ba%bf%e7%a8%8b%e6%95%b0%e6%8d%ae%e6%ba%90 aria-label=å¦‚ä½•è·å–å½“å‰çº¿ç¨‹æ•°æ®æºï¼Ÿ>å¦‚ä½•è·å–å½“å‰çº¿ç¨‹æ•°æ®æºï¼Ÿ</a></li></ul></li></ul></div></details></div><div class=post-content><p>æœ¬æ–‡ä¸º <code>dynamic-datasource-spring-boot-starter</code> ï¼ˆåŸºäºSpringBootçš„å¿«é€Ÿé›†æˆå¤šæ•°æ®æºæ¡†æ¶ï¼‰çš„ä½¿ç”¨æ–‡æ¡£ã€‚</p><h1 id=ç‰¹æ€§>ç‰¹æ€§<a hidden class=anchor aria-hidden=true href=#ç‰¹æ€§>#</a></h1><ol><li>æ”¯æŒ <code>æ•°æ®æºåˆ†ç»„</code> ï¼Œé€‚ç”¨äºå¤šç§åœºæ™¯ï¼Œçº¯ç²¹å¤šåº“ã€è¯»å†™åˆ†ç¦»ã€ä¸€ä¸»å¤šä»ã€æ··åˆæ¨¡å¼ã€‚</li><li>æ”¯æŒæ•°æ®åº“æ•æ„Ÿé…ç½®ä¿¡æ¯ <code>åŠ å¯†(å¯è‡ªå®šä¹‰)</code> ENC()ã€‚</li><li>æ”¯æŒæ¯ä¸ªæ•°æ®åº“ç‹¬ç«‹åˆå§‹åŒ–è¡¨ç»“æ„schemaå’Œæ•°æ®åº“databaseã€‚</li><li>æ”¯æŒæ— æ•°æ®æºå¯åŠ¨ï¼Œæ”¯æŒ <code>æ‡’åŠ è½½æ•°æ®æº</code> ï¼ˆéœ€è¦çš„æ—¶å€™å†åˆ›å»ºè¿æ¥ï¼‰ã€‚</li><li>æ”¯æŒ <code>è‡ªå®šä¹‰æ³¨è§£</code> ï¼Œéœ€ç»§æ‰¿DS(3.2.0+)ã€‚</li><li>æä¾›å¹¶ç®€åŒ–å¯¹Druidï¼ŒHikariCpï¼ŒBeeCpï¼ŒDbcp2çš„å¿«é€Ÿé›†æˆã€‚</li><li>æä¾›å¯¹ <code>Mybatis-Plus</code> ï¼ŒQuartzï¼ŒShardingJdbcï¼ŒP6syï¼ŒJndiç­‰ç»„ä»¶çš„é›†æˆæ–¹æ¡ˆã€‚</li><li>æä¾› <code>è‡ªå®šä¹‰æ•°æ®æºæ¥æº</code> æ–¹æ¡ˆï¼ˆå¦‚å…¨ä»æ•°æ®åº“åŠ è½½ï¼‰ã€‚</li><li>æä¾›é¡¹ç›®å¯åŠ¨å <code>åŠ¨æ€å¢åŠ ç§»é™¤æ•°æ®æº</code> æ–¹æ¡ˆã€‚</li><li>æä¾›Mybatisç¯å¢ƒä¸‹çš„ <code>çº¯è¯»å†™åˆ†ç¦»</code> æ–¹æ¡ˆã€‚</li><li>æä¾›ä½¿ç”¨ <code>spelåŠ¨æ€å‚æ•°</code> è§£ææ•°æ®æºæ–¹æ¡ˆã€‚å†…ç½®spelï¼Œsessionï¼Œheaderï¼Œæ”¯æŒè‡ªå®šä¹‰ã€‚</li><li>æ”¯æŒ <code>å¤šå±‚æ•°æ®æºåµŒå¥—åˆ‡æ¢</code> ã€‚ï¼ˆServiceA &#187;> ServiceB &#187;> ServiceCï¼‰ã€‚</li><li>æä¾› <code>åŸºäºseataçš„åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆ</code> ã€‚</li><li>æä¾› <code>æœ¬åœ°å¤šæ•°æ®æºäº‹åŠ¡æ–¹æ¡ˆ</code> ã€‚</li></ol><h1 id=çº¦å®š>çº¦å®š<a hidden class=anchor aria-hidden=true href=#çº¦å®š>#</a></h1><ol><li>dynamic-datasourceåªåš <code>åˆ‡æ¢æ•°æ®æº</code> è¿™ä»¶æ ¸å¿ƒçš„äº‹æƒ…ï¼Œå¹¶ <code>ä¸é™åˆ¶ä½ çš„å…·ä½“æ“ä½œ</code> ï¼Œåˆ‡æ¢äº†æ•°æ®æºå¯ä»¥åšä»»ä½•CRUDã€‚</li><li>é…ç½®æ–‡ä»¶æ‰€æœ‰ä»¥ä¸‹åˆ’çº¿ <code>_</code> åˆ†å‰²çš„æ•°æ®æº <code>é¦–éƒ¨</code> å³ä¸ºç»„çš„åç§°ï¼Œç›¸åŒç»„åç§°çš„æ•°æ®æºä¼šæ”¾åœ¨ä¸€ä¸ªç»„ä¸‹ã€‚</li><li>åˆ‡æ¢æ•°æ®æºå¯ä»¥æ˜¯ç»„åï¼Œä¹Ÿå¯ä»¥æ˜¯å…·ä½“æ•°æ®æºåç§°ã€‚ <code>ç»„ååˆ™åˆ‡æ¢æ—¶é‡‡ç”¨è´Ÿè½½å‡è¡¡ç®—æ³•åˆ‡æ¢</code> ã€‚</li><li>é»˜è®¤çš„æ•°æ®æºåç§°ä¸º <code>master</code> ï¼Œä½ å¯ä»¥é€šè¿‡ <code>spring.datasource.dynamic.primary</code> ä¿®æ”¹ã€‚</li><li><code>æ–¹æ³•ä¸Šçš„æ³¨è§£ä¼˜å…ˆäºç±»ä¸Šæ³¨è§£</code>ã€‚</li><li>DSæ”¯æŒç»§æ‰¿æŠ½è±¡ç±»ä¸Šçš„DSï¼Œæš‚ä¸æ”¯æŒç»§æ‰¿æ¥å£ä¸Šçš„DSã€‚</li></ol><h1 id=ä½¿ç”¨æ–¹æ³•>ä½¿ç”¨æ–¹æ³•<a hidden class=anchor aria-hidden=true href=#ä½¿ç”¨æ–¹æ³•>#</a></h1><ol><li>å¼•å…¥dynamic-datasource-spring-boot-starter</li></ol><p>spring-boot 1.5.xã€2.x.x</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;groupId&gt;</span>com.baomidou<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;artifactId&gt;</span>dynamic-datasource-spring-boot-starter<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;version&gt;</span>${version}<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>spring-boot3åŠä»¥ä¸Š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;groupId&gt;</span>com.baomidou<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;artifactId&gt;</span>dynamic-datasource-spring-boot3-starter<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;version&gt;</span>${version}<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div><ol start=2><li>é…ç½®æ•°æ®æº</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dynamic</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>primary</span><span class=p>:</span><span class=w> </span><span class=l>master</span><span class=w> </span><span class=c># è®¾ç½®é»˜è®¤çš„æ•°æ®æºæˆ–è€…æ•°æ®æºç»„,é»˜è®¤å€¼å³ä¸ºmaster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>strict</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=c># ä¸¥æ ¼åŒ¹é…æ•°æ®æº,é»˜è®¤false. trueæœªåŒ¹é…åˆ°æŒ‡å®šæ•°æ®æºæ—¶æŠ›å¼‚å¸¸,falseä½¿ç”¨é»˜è®¤æ•°æ®æº</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>master</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://xx.xx.xx.xx:3306/dynamic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w> </span><span class=c># 3.2.0å¼€å§‹æ”¯æŒSPIå¯çœç•¥æ­¤é…ç½®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>slave_1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://xx.xx.xx.xx:3307/dynamic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>slave_2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>ENC(xxxxx)</span><span class=w> </span><span class=c># å†…ç½®åŠ å¯†,ä½¿ç”¨è¯·æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>ENC(xxxxx)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>ENC(xxxxx)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=c># ......çœç•¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=c># ä»¥ä¸Šä¼šé…ç½®ä¸€ä¸ªé»˜è®¤åº“masterï¼Œä¸€ä¸ªç»„slaveä¸‹æœ‰ä¸¤ä¸ªå­åº“slave_1,slave_2</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># å¤šä¸»å¤šä»</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dynamic</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>master_1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>master_2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>slave_1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>slave_2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>slave_3</span><span class=p>:</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># çº¯ç²¹å¤šåº“ï¼ˆè®°å¾—è®¾ç½®primaryï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dynamic</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>mysql</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>oracle</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>sqlserver</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>postgresql</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>h2</span><span class=p>:</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># æ··åˆé…ç½®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dynamic</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>master</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>slave_1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>slave_2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>oracle_1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>oracle_2</span><span class=p>:</span><span class=w>
</span></span></span></code></pre></div><ol start=3><li>ä½¿ç”¨ <code>@DS</code> åˆ‡æ¢æ•°æ®æº</li></ol><p><code>@DS</code> å¯ä»¥æ³¨è§£åœ¨æ–¹æ³•ä¸Šæˆ–ç±»ä¸Šï¼ŒåŒæ—¶å­˜åœ¨ <code>å°±è¿‘åŸåˆ™</code>ï¼Œ<code>æ–¹æ³•ä¸Šæ³¨è§£</code> ä¼˜å…ˆäº <code>ç±»ä¸Šæ³¨è§£</code>ã€‚</p><table><thead><tr><th style=text-align:center>æ³¨è§£</th><th style=text-align:center>ç»“æœ</th></tr></thead><tbody><tr><td style=text-align:center>æ²¡æœ‰@DS</td><td style=text-align:center>é»˜è®¤æ•°æ®æº</td></tr><tr><td style=text-align:center>@DS(&ldquo;dsName&rdquo;)</td><td style=text-align:center>dsNameå¯ä»¥ä¸ºç»„åä¹Ÿå¯ä»¥ä¸ºå…·ä½“æŸä¸ªåº“çš„åç§°ï¼Œç»„ååˆ™åˆ‡æ¢æ—¶é‡‡ç”¨è´Ÿè½½å‡è¡¡ç®—æ³•åˆ‡æ¢</td></tr></tbody></table><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;slave&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UserServiceImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>UserService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=n>JdbcTemplate</span><span class=w> </span><span class=n>jdbcTemplate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c1>// ä½¿ç”¨slaveæ•°æ®æº</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=w> </span><span class=nf>selectAll</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w>  </span><span class=n>jdbcTemplate</span><span class=p>.</span><span class=na>queryForList</span><span class=p>(</span><span class=s>&#34;select * from user&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c1>// ä½¿ç”¨slave_1æ•°æ®æº</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;slave_1&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=w> </span><span class=nf>selectByCondition</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w>  </span><span class=n>jdbcTemplate</span><span class=p>.</span><span class=na>queryForList</span><span class=p>(</span><span class=s>&#34;select * from user where age &gt;10&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h1 id=dsæ”¾åœ¨å“ªé‡Œåˆé€‚>DSæ”¾åœ¨å“ªé‡Œåˆé€‚<a hidden class=anchor aria-hidden=true href=#dsæ”¾åœ¨å“ªé‡Œåˆé€‚>#</a></h1><p>DSä½œä¸ºåˆ‡æ¢æ•°æ®æºæ ¸å¿ƒæ³¨è§£ï¼Œæˆ‘åº”è¯¥æŠŠä»–æ³¨è§£åœ¨å“ªé‡Œåˆé€‚ï¼Ÿ</p><p>è¿™å…¶å®æ˜¯åˆæ¬¡æ¥è§¦å¤šæ•°æ®æºçš„äººå¸¸é—®çš„é—®é¢˜ã€‚</p><p>è¿™å…¶å®æ²¡æœ‰ä¸€å®šçš„è¦æ±‚ï¼Œåªæ˜¯æœ‰ä¸€äº›ç»éªŒä¹‹è°ˆã€‚</p><p>é¦–å…ˆå¼€å‘è€…è¦äº†è§£çš„åŸºç¡€çŸ¥è¯†æ˜¯ï¼ŒDSæ³¨è§£æ˜¯åŸºäºAOPçš„åŸç†å®ç°çš„ï¼Œaopçš„å¸¸è§å¤±æ•ˆåœºæ™¯åº”æ¸…æ¥šï¼Œæ¯”å¦‚å†…éƒ¨è°ƒç”¨å¤±æ•ˆï¼Œshiroä»£ç†å¤±æ•ˆã€‚</p><p><code>é€šå¸¸å»ºè®®DSæ”¾åœ¨serviceImplçš„æ–¹æ³•ä¸Šï¼Œå¦‚äº‹åŠ¡æ³¨è§£ä¸€æ ·ã€‚</code></p><ul><li>æ³¨è§£åœ¨Controllerçš„æ–¹æ³•ä¸Šæˆ–ç±»ä¸Š</li></ul><p>å¹¶ä¸æ˜¯ä¸å¯ä»¥ï¼Œä½œè€…å¹¶ä¸å»ºè®®çš„åŸå› ä¸»è¦æ˜¯controllerä¸»è¦ä½œç”¨æ˜¯å‚æ•°çš„æ£€éªŒç­‰ä¸€äº›åŸºç¡€é€»è¾‘çš„å¤„ç†ï¼Œè¿™éƒ¨åˆ†æ“ä½œå¸¸å¸¸å¹¶ä¸æ¶‰åŠæ•°æ®åº“ã€‚</p><ul><li>æ³¨è§£åœ¨serviceçš„å®ç°ç±»çš„æ–¹æ³•æˆ–ç±»ä¸Š</li></ul><p>è¿™æ˜¯ä½œè€…å»ºè®®çš„æ–¹å¼ï¼Œserviceä¸»è¦æ˜¯å¯¹ä¸šåŠ¡çš„å¤„ç†ï¼Œ åœ¨å¤æ‚çš„åœºæ™¯æ¶‰åŠè¿ç»­åˆ‡æ¢ä¸åŒçš„æ•°æ®åº“ã€‚</p><p>å¦‚æœä½ çš„æ–¹æ³•æœ‰é€šç”¨æ€§ï¼Œå…¶ä»–serviceä¹Ÿä¼šè°ƒç”¨ä½ çš„æ–¹æ³•ã€‚ è¿™æ ·åˆ«äººå°±ä¸ç”¨é‡å¤å¤„ç†åˆ‡æ¢æ•°æ®æºã€‚</p><ul><li>æ³¨è§£åœ¨Mapperä¸Š</li></ul><p>é€šå¸¸å¦‚æœä½ æŸä¸ªMapperå¯¹åº”çš„è¡¨åªåœ¨ç¡®å®šçš„ä¸€ä¸ªåº“ï¼Œä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯å»ºè®®åªæ³¨è§£åœ¨Mapperçš„ç±»ä¸Šã€‚</p><p>æˆ‘ä¹‹å‰å‡ºç°å¤šçº¿ç¨‹å¤±æ•ˆåœºæ™¯çš„æ—¶å€™ï¼Œå°±æ˜¯åœ¨Mapperä¸ŠåŠ äº†æ³¨è§£è§£å†³çš„ã€‚</p><ul><li>å…¶ä»–ä½¿ç”¨æ–¹å¼</li></ul><p><strong>ç»§æ‰¿æŠ½è±¡ç±»ä¸Šçš„DS</strong></p><p>æ¯”å¦‚æˆ‘æœ‰ä¸€ä¸ªæŠ½è±¡Serviceï¼Œæˆ‘æƒ³å®ç°ç»§æ‰¿æˆ‘è¿™ä¸ªæŠ½è±¡Serviceä¸‹çš„å­Serviceçš„æ‰€æœ‰æ–¹æ³•é™¤éé‡æ–°æŒ‡å®šï¼Œéƒ½ç”¨æˆ‘æŠ½è±¡Serviceä¸Šæ³¨è§£çš„æ•°æ®æºã€‚æ˜¯å¦æ”¯æŒï¼Ÿ</p><p>ç­”ï¼šæ”¯æŒã€‚</p><p><strong>ç»§æ‰¿æ¥å£ä¸Šçš„DS</strong></p><p>3.4.1å¼€å§‹æ”¯æŒï¼Œ ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸€ä¸ªç±»èƒ½å®ç°å¤šä¸ªæ¥å£ï¼Œå¦‚æœå¤šä¸ªæ¥å£éƒ½æœ‰DSä¼šå¦‚ä½•ï¼Ÿ</p><p>ä¸çŸ¥é“ï¼Œåˆ«è¿™ä¹ˆå¹²ã€‚ä¸€èˆ¬ä¸ä¼šæœ‰äººè¿™ä¹ˆå¹²å§ï¼Œæƒ³ä¸€æƒ³éƒ½çŸ¥é“ä¼šå‡ºé—®é¢˜ã€‚</p><h1 id=è¿æ¥æ± é›†æˆ>è¿æ¥æ± é›†æˆ<a hidden class=anchor aria-hidden=true href=#è¿æ¥æ± é›†æˆ>#</a></h1><p>ä¼ ç»Ÿå¤šæ•°æ®æºé›†æˆè¿æ¥æ± å¦‚æœéœ€è¦é…ç½®çš„å‚æ•°è¾ƒå¤šï¼Œåˆ™æ‰‹åŠ¨ç¼–ç é‡å¤§ï¼Œç¼–ç¨‹å¤æ‚ã€‚</p><p>dynamic-datasourceå®ç°äº†å¸¸è§æ•°æ®æºçš„å‚æ•°é…ç½®ï¼Œæ”¯æŒå…¨å±€é…ç½®æ¯ä¸ªæ•°æ®æºç»§æ‰¿ã€‚</p><p>é€šè¿‡æœ¬ç« æ‚¨å¯ä»¥å¿«é€ŸæŒæ¡ä¸åŒè¿æ¥æ± çš„é›†æˆé…ç½®æ–¹æ¡ˆå’Œç»§æ‰¿ä¸­å¯èƒ½é‡è§çš„é—®é¢˜ã€‚</p><h2 id=è¿æ¥æ± å¿…è¯»>è¿æ¥æ± å¿…è¯»<a hidden class=anchor aria-hidden=true href=#è¿æ¥æ± å¿…è¯»>#</a></h2><ol><li><p>æ¯ä¸ªæ•°æ®æºéƒ½æœ‰ä¸€ä¸ªtypeæ¥æŒ‡å®šè¿æ¥æ± ã€‚</p></li><li><p>æ¯ä¸ªæ•°æ®æºç”šè‡³å¯ä»¥ä½¿ç”¨ä¸åŒçš„è¿æ¥æ± ï¼Œå¦‚æ— ç‰¹æ®Šéœ€è¦å¹¶ä¸å»ºè®®ã€‚</p></li><li><p>type ä¸æ˜¯å¿…å¡«å­—æ®µã€‚</p></li></ol><p>åœ¨æ²¡æœ‰è®¾ç½®typeçš„æ—¶å€™ç³»ç»Ÿä¼šè‡ªåŠ¨æŒ‰ä»¥ä¸‹é¡ºåºæŸ¥æ‰¾å¹¶ä½¿ç”¨è¿æ¥æ± ï¼š</p><p>Druid > HikariCp > BeeCp > DBCP2 > Spring Basicã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dynamic</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>primary</span><span class=p>:</span><span class=w> </span><span class=l>db1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>db1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://xx.xx.xx.xx:3306/dynamic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>com.zaxxer.hikari.HikariDataSource    </span><span class=w> </span><span class=c># ä½¿ç”¨Hikaricp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>db2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://xx.xx.xx.xx:3307/dynamic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>com.alibaba.druid.pool.DruidDataSource</span><span class=w> </span><span class=c># ä½¿ç”¨Druid</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>db3</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://xx.xx.xx.xx:3308/dynamic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>cn.beecp.BeeDataSource                </span><span class=w> </span><span class=c># ä½¿ç”¨beecp</span><span class=w>
</span></span></span></code></pre></div><h2 id=é›†æˆdruid>é›†æˆDruid<a hidden class=anchor aria-hidden=true href=#é›†æˆdruid>#</a></h2><h3 id=åŸºç¡€ä»‹ç»>åŸºç¡€ä»‹ç»<a hidden class=anchor aria-hidden=true href=#åŸºç¡€ä»‹ç»>#</a></h3><p>Druid Githubï¼š<a href=https://github.com/alibaba/druid>ç‚¹æˆ‘è·³è½¬</a></p><p>Druid æ–‡æ¡£ï¼š<a href=https://github.com/alibaba/druid/wiki/%E9%A6%96%E9%A1%B5>ç‚¹æˆ‘è·³è½¬</a></p><p>dynamic-datasourceèƒ½<code>ç®€å•é«˜æ•ˆ</code>å®Œæˆå¯¹Druidçš„é›†æˆå¹¶å®Œæˆå…¶å‚æ•°çš„å¤šå…ƒåŒ–é…ç½®ã€‚</p><p>å„ä¸ªåº“å¯ä»¥ä½¿ç”¨ä¸åŒçš„æ•°æ®åº“è¿æ¥æ± ï¼Œå¦‚ <code>masterä½¿ç”¨Druidï¼Œslaveä½¿ç”¨HikariCP</code>ã€‚</p><p>å¦‚æœé¡¹ç›®åŒæ—¶å­˜åœ¨Druidå’ŒHikariCPå¹¶ä¸”æœªé…ç½®è¿æ¥æ± typeç±»å‹ï¼Œ<code>é»˜è®¤Druidä¼˜å…ˆäºHikariCP</code>ã€‚</p><h3 id=é›†æˆæ­¥éª¤>é›†æˆæ­¥éª¤<a hidden class=anchor aria-hidden=true href=#é›†æˆæ­¥éª¤>#</a></h3><p>1ã€é¡¹ç›®å¼•å…¥ <code>druid-spring-boot-starter</code> ä¾èµ–</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>com.alibaba<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>druid-spring-boot-starter<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>${version}<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>2ã€æ’é™¤åŸç”ŸDruidçš„å¿«é€Ÿé…ç½®ç±»</p><p>æ³¨æ„ï¼š<code>v3.3.3åŠä»¥ä¸Š</code> ç‰ˆæœ¬ä¸ç”¨æ’é™¤äº†ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@SpringBootApplication</span><span class=p>(</span><span class=n>exclude</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DruidDataSourceAutoConfigure</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Application</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>SpringApplication</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>Application</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>args</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>æŸäº›SpringBootçš„ç‰ˆæœ¬ä¸Šé¢å¯èƒ½æ— æ³•æ’é™¤å¯ç”¨ä»¥ä¸‹æ–¹å¼æ’é™¤ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>autoconfigure</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>exclude</span><span class=p>:</span><span class=w> </span><span class=l>com.alibaba.druid.spring.boot.autoconfigure.DruidDataSourceAutoConfigure</span><span class=w>
</span></span></span></code></pre></div><p>3ã€å‚æ•°é…ç½®</p><ol><li>å¦‚æœå‚æ•°éƒ½æœªé…ç½®ï¼Œåˆ™ä¿æŒåŸç»„ä»¶é»˜è®¤å€¼ã€‚</li><li>å¦‚æœé…ç½®äº†å…¨å±€å‚æ•°ï¼Œåˆ™æ¯ä¸€ä¸ªæ•°æ®æºéƒ½ä¼šç»§æ‰¿å¯¹åº”å‚æ•°ã€‚</li><li>æ¯ä¸€ä¸ªæ•°æ®æºå¯ä»¥å•ç‹¬è®¾ç½®å‚æ•°è¦†ç›–å…¨å±€å‚æ•°ã€‚</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>druid</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>stat-view-servlet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>loginUsername</span><span class=p>:</span><span class=w> </span><span class=l>admin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>loginPassword</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dynamic</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>druid</span><span class=p>:</span><span class=w> </span><span class=c># ä»¥ä¸‹æ˜¯æ”¯æŒçš„å…¨å±€é»˜è®¤å€¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>initial-size</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>max-active</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>min-idle</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>max-wait</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>time-between-eviction-runs-millis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>time-between-log-stats-millis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>stat-sqlmax-size</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>min-evictable-idle-time-millis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>max-evictable-idle-time-millis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>test-while-idle</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>test-on-borrow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>test-on-return</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>validation-query</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>validation-query-timeout</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>use-global-datasource-stat</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>async-init</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>clear-filters-enable</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>reset-stat-enable</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>not-full-timeout-retry-count</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>max-wait-thread-count</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>fail-fast</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>phyTimeout-millis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>keep-alive</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>pool-prepared-statements</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>init-variants</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>init-global-variants</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>use-unfair-lock</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>kill-when-socket-read-timeout</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>connection-properties</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>max-pool-prepared-statement-per-connection-size</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>init-connection-sqls</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>share-prepared-statements</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>connection-errorretry-attempts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>break-after-acquire-failure</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>filters</span><span class=p>:</span><span class=w> </span><span class=l>stat</span><span class=w> </span><span class=c># æ³¨æ„è¿™ä¸ªå€¼å’ŒdruidåŸç”Ÿä¸ä¸€è‡´ï¼Œé»˜è®¤å¯åŠ¨äº†stat</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>wall</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>noneBaseStatementAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>callAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>selectAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>selectIntoAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>selectIntoOutfileAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>selectWhereAlwayTrueCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>selectHavingAlwayTrueCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>selectUnionCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>selectMinusCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>selectExceptCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>selectIntersectCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>createTableAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>dropTableAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>alterTableAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>renameTableAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>hintAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>lockTableAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>startTransactionAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>blockAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>conditionAndAlwayTrueAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>conditionAndAlwayFalseAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>conditionDoubleConstAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>conditionLikeTrueAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>selectAllColumnAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>deleteAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>deleteWhereAlwayTrueCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>deleteWhereNoneCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>updateAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>updateWhereAlayTrueCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>updateWhereNoneCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>insertAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>mergeAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>minusAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>intersectAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>replaceAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>setAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>commitAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>rollbackAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>useAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>multiStatementAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>truncateAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>commentAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>strictSyntaxCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>constArithmeticAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>limitZeroAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>describeAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>showAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>schemaCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>tableCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>functionCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>objectCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>variantCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>mustParameterized</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>doPrivilegedAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>dir</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>tenantTablePattern</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>tenantColumn</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>wrapAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>metadataAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>conditionOpXorAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>conditionOpBitwseAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>caseConditionConstAllow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>completeInsertValuesCheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>insertValuesCheckSize</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>selectLimit</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>stat</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>merge-sql</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>log-slow-sql</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>slow-sql-millis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>master</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://xx.xx.xx.xx:3306/dynamic?characterEncoding=utf8&amp;useSSL=false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>druid</span><span class=p>:</span><span class=w> </span><span class=c># ä»¥ä¸‹æ˜¯ç‹¬ç«‹å‚æ•°ï¼Œæ¯ä¸ªåº“å¯ä»¥é‡æ–°è®¾ç½®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>initial-size</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>validation-query</span><span class=p>:</span><span class=w> </span><span class=l>select 1 FROM DUAL</span><span class=w> </span><span class=c># æ¯”å¦‚oracleå°±éœ€è¦é‡æ–°è®¾ç½®è¿™ä¸ª</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>public-key</span><span class=p>:</span><span class=w> </span><span class=c>#ï¼ˆéå…¨å±€å‚æ•°ï¼‰è®¾ç½®å³è¡¨ç¤ºå¯ç”¨åŠ å¯†,åº•å±‚ä¼šè‡ªåŠ¨å¸®ä½ é…ç½®ç›¸å…³çš„è¿æ¥å‚æ•°å’Œfilterï¼Œæ¨èä½¿ç”¨æœ¬é¡¹ç›®è‡ªå¸¦çš„åŠ å¯†æ–¹æ³•ã€‚</span><span class=w>
</span></span></span></code></pre></div><p>ä»¥ä¸‹æ˜¯æˆ‘æ›¾ç»é…ç½®è¿‡çš„ç¤ºä¾‹ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># æ•°æ®æºé…ç½®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># æ’é™¤æ‰druidåŸç”Ÿçš„è‡ªåŠ¨é…ç½®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>autoconfigure</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>exclude</span><span class=p>:</span><span class=w> </span><span class=l>com.alibaba.druid.spring.boot.autoconfigure.DruidDataSourceAutoConfigure</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    	</span><span class=nt>druid</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c># åˆå§‹è¿æ¥æ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>initialSize</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c># æœ€å°è¿æ¥æ± æ•°é‡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>minIdle</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c># æœ€å¤§è¿æ¥æ± æ•°é‡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>maxActive</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c># é…ç½®è·å–è¿æ¥ç­‰å¾…è¶…æ—¶çš„æ—¶é—´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>maxWait</span><span class=p>:</span><span class=w> </span><span class=m>60000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c># é…ç½®è¿æ¥è¶…æ—¶æ—¶é—´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>connectTimeout</span><span class=p>:</span><span class=w> </span><span class=m>30000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c># é…ç½®ç½‘ç»œè¶…æ—¶æ—¶é—´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>socketTimeout</span><span class=p>:</span><span class=w> </span><span class=m>60000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c># é…ç½®é—´éš”å¤šä¹…æ‰è¿›è¡Œä¸€æ¬¡æ£€æµ‹ï¼Œæ£€æµ‹éœ€è¦å…³é—­çš„ç©ºé—²è¿æ¥ï¼Œå•ä½æ˜¯æ¯«ç§’</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>timeBetweenEvictionRunsMillis</span><span class=p>:</span><span class=w> </span><span class=m>60000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c># é…ç½®ä¸€ä¸ªè¿æ¥åœ¨æ± ä¸­æœ€å°ç”Ÿå­˜çš„æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>minEvictableIdleTimeMillis</span><span class=p>:</span><span class=w> </span><span class=m>300000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c># é…ç½®ä¸€ä¸ªè¿æ¥åœ¨æ± ä¸­æœ€å¤§ç”Ÿå­˜çš„æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>maxEvictableIdleTimeMillis</span><span class=p>:</span><span class=w> </span><span class=m>900000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c># é…ç½®æ£€æµ‹è¿æ¥æ˜¯å¦æœ‰æ•ˆ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>validationQuery</span><span class=p>:</span><span class=w> </span><span class=l>SELECT 1 FROM DUAL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>testWhileIdle</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>testOnBorrow</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>testOnReturn</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>webStatFilter</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>statViewServlet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=c># è®¾ç½®ç™½åå•ï¼Œä¸å¡«åˆ™å…è®¸æ‰€æœ‰è®¿é—®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nt>allow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nt>url-pattern</span><span class=p>:</span><span class=w> </span><span class=l>/druid/*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=c># æ§åˆ¶å°ç®¡ç†ç”¨æˆ·åå’Œå¯†ç </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nt>login-username</span><span class=p>:</span><span class=w> </span><span class=l>admin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nt>login-password</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>filter</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nt>stat</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=c># æ…¢SQLè®°å½•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=nt>log-slow-sql</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=nt>slow-sql-millis</span><span class=p>:</span><span class=w> </span><span class=m>2000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=nt>merge-sql</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nt>wall</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>						</span><span class=nt>multi-statement-allow</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>dynamic</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>druid</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c># åˆå§‹è¿æ¥æ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>initial-size</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c># æœ€å°è¿æ¥æ± æ•°é‡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>min-idle</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c># æœ€å¤§è¿æ¥æ± æ•°é‡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>max-active</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c># é…ç½®è·å–è¿æ¥ç­‰å¾…è¶…æ—¶çš„æ—¶é—´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>max-wait</span><span class=p>:</span><span class=w> </span><span class=m>60000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c># é…ç½®é—´éš”å¤šä¹…æ‰è¿›è¡Œä¸€æ¬¡æ£€æµ‹ï¼Œæ£€æµ‹éœ€è¦å…³é—­çš„ç©ºé—²è¿æ¥ï¼Œå•ä½æ˜¯æ¯«ç§’</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>time-between-eviction-runs-millis</span><span class=p>:</span><span class=w> </span><span class=m>60000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c># é…ç½®ä¸€ä¸ªè¿æ¥åœ¨æ± ä¸­æœ€å°ç”Ÿå­˜çš„æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>min-evictable-idle-time-millis</span><span class=p>:</span><span class=w> </span><span class=m>300000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c># é…ç½®ä¸€ä¸ªè¿æ¥åœ¨æ± ä¸­æœ€å¤§ç”Ÿå­˜çš„æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>max-evictable-idle-time-millis</span><span class=p>:</span><span class=w> </span><span class=m>900000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c># é…ç½®æ£€æµ‹è¿æ¥æ˜¯å¦æœ‰æ•ˆ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>validation-query</span><span class=p>:</span><span class=w> </span><span class=l>SELECT 1 FROM DUAL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>test-while-idle</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>test-on-borrow</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>test-on-return</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c># æ‰“å¼€PSCacheï¼Œå¹¶æŒ‡å®šæ¯ä¸ªè¿æ¥ä¸ŠPSCacheçš„å¤§å°ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c># oracleè®¾ä¸ºtrueï¼Œmysqlè®¾ä¸ºfalseã€‚åˆ†åº“åˆ†è¡¨è¾ƒå¤šæ¨èè®¾ç½®ä¸ºfalse</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>pool-prepared-statements</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>max-pool-prepared-statement-per-connection-size</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>filters</span><span class=p>:</span><span class=w> </span><span class=l>stat</span><span class=w> </span><span class=c># æ³¨æ„è¿™ä¸ªå€¼å’ŒdruidåŸç”Ÿä¸ä¸€è‡´ï¼Œé»˜è®¤å¯åŠ¨äº†stat</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>stat</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>merge-sql</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>log-slow-sql</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>slow-sql-millis</span><span class=p>:</span><span class=w> </span><span class=m>2000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>primary</span><span class=p>:</span><span class=w> </span><span class=l>master</span><span class=w> </span><span class=c># è®¾ç½®é»˜è®¤çš„æ•°æ®æºæˆ–è€…æ•°æ®æºç»„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>strict</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=c># è®¾ç½®ä¸¥æ ¼æ¨¡å¼,é»˜è®¤falseä¸å¯åŠ¨,å¯åŠ¨ååœ¨æœªåŒ¹é…åˆ°æŒ‡å®šæ•°æ®æºæ—¶å€™å›æŠ›å‡ºå¼‚å¸¸,ä¸å¯åŠ¨ä¼šä½¿ç”¨é»˜è®¤æ•°æ®æº</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>master</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://192.168.56.101:3306/master?useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=true&amp;serverTimezone=GMT%2B8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>slave_1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://192.168.56.102:3306/slave_1?useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=true&amp;serverTimezone=GMT%2B8&amp;rewriteBatchedStatements=true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>slave_2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://192.168.56.103:3306/slave_2?useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=true&amp;serverTimezone=GMT%2B8&amp;rewriteBatchedStatements=true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>druid</span><span class=p>:</span><span class=w> </span><span class=c># ä»¥ä¸‹å‚æ•°é’ˆå¯¹æ¯ä¸ªåº“å¯ä»¥é‡æ–°è®¾ç½®druidå‚æ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>initial-size</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>validation-query</span><span class=p>:</span><span class=w> </span><span class=l>select 1 FROM DUAL</span><span class=w> </span><span class=c># æ¯”å¦‚oracleå°±éœ€è¦é‡æ–°è®¾ç½®è¿™ä¸ª</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>public-key</span><span class=p>:</span><span class=w> </span><span class=c>#ï¼ˆéå…¨å±€å‚æ•°ï¼‰è®¾ç½®å³è¡¨ç¤ºå¯ç”¨åŠ å¯†,åº•å±‚ä¼šè‡ªåŠ¨å¸®ä½ é…ç½®ç›¸å…³çš„è¿æ¥å‚æ•°å’Œfilterã€‚</span><span class=w>
</span></span></span></code></pre></div><p>å¦‚ä¸Šå³å¯é…ç½®è®¿é—®ç”¨æˆ·å’Œå¯†ç ï¼Œè®¿é—® <code>http://ip:ç«¯å£/druid/index.html</code> æŸ¥çœ‹druidç›‘æ§ã€‚</p><h3 id=ç¤ºä¾‹é¡¹ç›®>ç¤ºä¾‹é¡¹ç›®<a hidden class=anchor aria-hidden=true href=#ç¤ºä¾‹é¡¹ç›®>#</a></h3><p><a href=https://github.com/dynamic-datasource/dynamic-datasource-samples/tree/master/datasource-samples/druid-sample>ç‚¹æˆ‘è·³è½¬</a></p><h3 id=æ ¸å¿ƒæºç >æ ¸å¿ƒæºç <a hidden class=anchor aria-hidden=true href=#æ ¸å¿ƒæºç >#</a></h3><p><code>Druidæ•°æ®æºåˆ›å»ºå™¨</code>ï¼š<a href=https://github.com/baomidou/dynamic-datasource/blob/master/src/main/java/com/baomidou/dynamic/datasource/creator/DruidDataSourceCreator.java>ç‚¹æˆ‘è·³è½¬</a></p><p><code>Druidå‚æ•°æºç </code>ï¼š<a href=https://github.com/baomidou/dynamic-datasource/blob/master/src/main/java/com/baomidou/dynamic/datasource/spring/boot/autoconfigure/druid/DruidConfig.java>ç‚¹æˆ‘è·³è½¬</a></p><h2 id=é›†æˆhikaricp>é›†æˆHikariCP<a hidden class=anchor aria-hidden=true href=#é›†æˆhikaricp>#</a></h2><h3 id=åŸºç¡€ä»‹ç»-1>åŸºç¡€ä»‹ç»<a hidden class=anchor aria-hidden=true href=#åŸºç¡€ä»‹ç»-1>#</a></h3><p><code>HikariCP Github</code>ï¼š<a href=https://github.com/brettwooldridge/HikariCP>ç‚¹æˆ‘è·³è½¬</a></p><p><code>HikariCP æ–‡æ¡£</code>ï¼š<a href=https://github.com/brettwooldridge/HikariCP/wiki>ç‚¹æˆ‘è·³è½¬</a></p><h3 id=é›†æˆæ­¥éª¤-1>é›†æˆæ­¥éª¤<a hidden class=anchor aria-hidden=true href=#é›†æˆæ­¥éª¤-1>#</a></h3><p>1ã€é¡¹ç›®å¼•å…¥ <code>HikariCP</code> ä¾èµ–</p><p><code>SpringBoot2.x.x</code>é»˜è®¤å¼•å…¥äº†HikariCPï¼Œé™¤éå¯¹ç‰ˆæœ¬æœ‰è¦æ±‚æ— éœ€å†æ¬¡å¼•å…¥ã€‚</p><p><code>SpringBoot 1.5.x</code>éœ€æ‰‹åŠ¨å¼•å…¥ï¼Œå¯¹åº”çš„ç‰ˆæœ¬è¯·æ ¹æ®è‡ªå·±ç¯å¢ƒå’ŒHikariCPå®˜æ–¹æ–‡æ¡£è‡ªè¡Œé€‰æ‹©ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>com.zaxxer<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>HikariCP<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>${version}<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>2ã€å‚æ•°é…ç½®</p><ol><li>å¦‚æœå‚æ•°éƒ½æœªé…ç½®ï¼Œåˆ™ä¿æŒåŸç»„ä»¶é»˜è®¤å€¼ã€‚</li><li>å¦‚æœé…ç½®äº†å…¨å±€å‚æ•°ï¼Œåˆ™æ¯ä¸€ä¸ªæ•°æ®æºéƒ½ä¼šç»§æ‰¿å¯¹åº”å‚æ•°ã€‚</li><li>æ¯ä¸€ä¸ªæ•°æ®æºå¯ä»¥å•ç‹¬è®¾ç½®å‚æ•°è¦†ç›–å…¨å±€å‚æ•°ã€‚</li></ol><p>ç‰¹åˆ«æ³¨æ„ï¼ŒhikaricpåŸç”Ÿè®¾ç½®æŸäº›å­—æ®µåå’Œdynamic-datasourceä¸ä¸€è‡´ï¼Œdynamic-datasourceæ˜¯æ ¹æ®å‚æ•°åå°„è®¾ç½®ï¼Œè€ŒåŸç”Ÿhikaricpå­—æ®µåç§°å’Œsetåç§°ä¸ä¸€è‡´ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dynamic</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hikari</span><span class=p>:</span><span class=w>  </span><span class=c># å…¨å±€hikariCPå‚æ•°ï¼Œæ‰€æœ‰å€¼å’Œé»˜è®¤ä¿æŒä¸€è‡´ã€‚(ç°å·²æ”¯æŒçš„å‚æ•°å¦‚ä¸‹,ä¸æ¸…æ¥šå«ä¹‰ä¸è¦ä¹±è®¾ç½®)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>catalog</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>connection-timeout</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>validation-timeout</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>idle-timeout</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>leak-detection-threshold</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>max-lifetime</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>max-pool-size</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>min-idle</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>initialization-fail-timeout</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>connection-init-sql</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>connection-test-query</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>dataSource-class-name</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>dataSource-jndi-name</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>schema</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>transaction-isolation-name</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>is-auto-commit</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>is-read-only</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>is-isolate-internal-queries</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>is-register-mbeans</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>is-allow-pool-suspension</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>data-source-properties</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>health-check-properties</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>master</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://xx.xx.xx.xx:3306/dynamic?characterEncoding=utf8&amp;useSSL=false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>hikari</span><span class=p>:</span><span class=w> </span><span class=c># ä»¥ä¸‹å‚æ•°é’ˆå¯¹æ¯ä¸ªåº“å¯ä»¥é‡æ–°è®¾ç½®hikariå‚æ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>max-pool-size</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>idle-timeout</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#           ......</span><span class=w>
</span></span></span></code></pre></div><h3 id=å¸¸è§é—®é¢˜>å¸¸è§é—®é¢˜<a hidden class=anchor aria-hidden=true href=#å¸¸è§é—®é¢˜>#</a></h3><p>Failed to validate connection com.mysql.jdbc.JDBC4Connection@xxxxx (No operations allowed after connection closed.)</p><p><a href=https://github.com/brettwooldridge/HikariCP/issues/1034>https://github.com/brettwooldridge/HikariCP/issues/1034</a></p><p>æ ¸å¿ƒæ„æ€å°±æ˜¯HikariCPè¦è®¾ç½® connection-test-query å¹¶ä¸”max-lifetimeè¦å°äºmysqlçš„é»˜è®¤æ—¶é—´ã€‚</p><h3 id=æ ¸å¿ƒæºç -1>æ ¸å¿ƒæºç <a hidden class=anchor aria-hidden=true href=#æ ¸å¿ƒæºç -1>#</a></h3><p><code>HikariCPæ•°æ®æºåˆ›å»ºå™¨</code>ï¼š<a href=https://github.com/baomidou/dynamic-datasource-spring-boot-starter/blob/master/src/main/java/com/baomidou/dynamic/datasource/creator/HikariDataSourceCreator.java>ç‚¹æˆ‘è·³è½¬</a></p><p><code>HikariCPå‚æ•°é…ç½®ç±»</code>ï¼š<a href=https://github.com/baomidou/dynamic-datasource/blob/master/src/main/java/com/baomidou/dynamic/datasource/spring/boot/autoconfigure/hikari/HikariCpConfig.java>ç‚¹æˆ‘è·³è½¬</a></p><h1 id=ç¬¬ä¸‰æ–¹é›†æˆ>ç¬¬ä¸‰æ–¹é›†æˆ<a hidden class=anchor aria-hidden=true href=#ç¬¬ä¸‰æ–¹é›†æˆ>#</a></h1><p>é€šè¿‡æœ¬ç« æ‚¨å¯ä»¥æŒæ¡æ•°æ®æºåœ¨é›†æˆMybatisPlusï¼ŒQuartzï¼ŒShardingJdbcçš„æ–¹æ¡ˆã€‚</p><h2 id=é›†æˆmybatisplus>é›†æˆMybatisPlus<a hidden class=anchor aria-hidden=true href=#é›†æˆmybatisplus>#</a></h2><h3 id=åŸºç¡€ä»‹ç»-2>åŸºç¡€ä»‹ç»<a hidden class=anchor aria-hidden=true href=#åŸºç¡€ä»‹ç»-2>#</a></h3><p><code>MybatisPlus Github</code>ï¼š<a href=https://github.com/baomidou/mybatis-plus>ç‚¹æˆ‘è·³è½¬</a></p><p><code>MybatisPlus æ–‡æ¡£</code>ï¼š <a href=https://mybatis.plus/>ç‚¹æˆ‘è·³è½¬</a></p><blockquote><p>åªè¦å¼•å…¥äº†MybatisPlusç›¸å…³jaråŒ…ï¼Œé¡¹ç›®è‡ªåŠ¨é›†æˆï¼Œå…¼å®¹MybatisPlus2.xå’Œ3.xçš„ç‰ˆæœ¬ã€‚</p></blockquote><h3 id=é›†æˆæ­¥éª¤-2>é›†æˆæ­¥éª¤<a hidden class=anchor aria-hidden=true href=#é›†æˆæ­¥éª¤-2>#</a></h3><p>1ã€é¡¹ç›®å¼•å…¥ <code>Mybatis-Plus</code> ä¾èµ–</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>com.baomidou<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>mybatis-plus-boot-starter<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>${version}<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>2ã€ä½¿ç”¨<code>DS</code>æ³¨è§£è¿›è¡Œåˆ‡æ¢æ•°æ®æº</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;mysql&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UserServiceImpl</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ServiceImpl</span><span class=o>&lt;</span><span class=n>UserMapper</span><span class=p>,</span><span class=w> </span><span class=n>User</span><span class=o>&gt;</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>UserService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;oracle&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>publid</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>addUser</span><span class=p>(</span><span class=n>User</span><span class=w> </span><span class=n>user</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//do something</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>baseMapper</span><span class=p>.</span><span class=na>insert</span><span class=p>(</span><span class=n>user</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>3ã€åˆ†é¡µé…ç½®</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>MybatisPlusInterceptor</span><span class=w> </span><span class=nf>mybatisPlusInterceptor</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>MybatisPlusInterceptor</span><span class=w> </span><span class=n>interceptor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MybatisPlusInterceptor</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//å¦‚æœæ˜¯ä¸åŒç±»å‹çš„åº“ï¼Œè¯·ä¸è¦æŒ‡å®šDbTypeï¼Œå…¶ä¼šè‡ªåŠ¨åˆ¤æ–­ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>interceptor</span><span class=p>.</span><span class=na>addInnerInterceptor</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>PaginationInnerInterceptor</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=c1>// interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>interceptor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=æ³¨æ„äº‹é¡¹>æ³¨æ„äº‹é¡¹<a hidden class=anchor aria-hidden=true href=#æ³¨æ„äº‹é¡¹>#</a></h3><p>MybatisPluså†…ç½®çš„ServiceImplåœ¨æ–°å¢ï¼Œæ›´æ”¹ï¼Œåˆ é™¤ç­‰ä¸€äº›æ–¹æ³•ä¸Šè‡ªå¸¦äº‹ç‰©å¯¼è‡´ä¸èƒ½åˆ‡æ¢æ•°æ®æºã€‚</p><p>è§£å†³æ–¹æ³•ï¼š</p><p>æ–¹æ³•1ï¼šå¤åˆ¶ServiceImplå‡ºæ¥ä¸ºè‡ªå·±çš„MyServiceImplï¼Œå¹¶å»æ‰æ‰€æœ‰äº‹åŠ¡æ³¨è§£ã€‚</p><p>æ–¹æ³•2ï¼šåˆ›å»ºä¸€ä¸ªæ–°æ–¹æ³•ï¼Œå¹¶åœ¨æ­¤æ–¹æ³•ä¸ŠåŠ DSæ³¨è§£. å¦‚ä¸Šé¢çš„<code>addUser</code>æ–¹æ³•ã€‚</p><h3 id=faq>FAQ<a hidden class=anchor aria-hidden=true href=#faq>#</a></h3><p>ä¸ºä»€ä¹ˆè¦å•ç‹¬æ‹¿å‡ºæ¥è¯´å’ŒMybatisPlusçš„é›†æˆï¼Ÿ</p><p>å› ä¸ºMybatisPlusé‡å†™äº†ä¸€äº›æ ¸å¿ƒç±»ï¼Œå¿…é¡»é€šè¿‡è§£æè·å¾—çœŸå®çš„ä»£ç†å¯¹è±¡ã€‚</p><p>å¦‚æœè‡ªå·±å†™å¤šæ•°æ®æºï¼Œåˆ™å¾ˆéš¾å®Œæˆä¸mpçš„é›†æˆã€‚</p><p>æ ¸å¿ƒè§£ææºç ï¼š<a href=https://github.com/baomidou/dynamic-datasource/blob/master/src/main/java/com/baomidou/dynamic/datasource/support/DataSourceClassResolver.java>ç‚¹æˆ‘è·³è½¬</a></p><h3 id=ç¤ºä¾‹é¡¹ç›®-1>ç¤ºä¾‹é¡¹ç›®<a hidden class=anchor aria-hidden=true href=#ç¤ºä¾‹é¡¹ç›®-1>#</a></h3><p><a href=https://github.com/dynamic-datasource/dynamic-datasource-samples/tree/master/orm-samples/mybatisplus3-sample>ç‚¹æˆ‘è·³è½¬</a></p><h2 id=å…¶ä»–é›†æˆ>å…¶ä»–é›†æˆ<a hidden class=anchor aria-hidden=true href=#å…¶ä»–é›†æˆ>#</a></h2><p>é›†æˆP6spyã€é›†æˆQuartzã€é›†æˆShardingJdbc</p><p>ç”±äºä»¥ä¸Šåœºæ™¯æš‚æ—¶æ²¡ç”¨åˆ°ï¼Œæ–‡ç« ä¸­æš‚æ—¶ä¸ä½“ç°äº†ï¼Œå¦‚æœ‰ç”¨åˆ°ï¼Œåé¢ä¼šè¡¥å……ä¸Šã€‚</p><h1 id=è¿›é˜¶ä½¿ç”¨>è¿›é˜¶ä½¿ç”¨<a hidden class=anchor aria-hidden=true href=#è¿›é˜¶ä½¿ç”¨>#</a></h1><p><code>åŠ¨æ€æ·»åŠ ç§»é™¤æ•°æ®æº</code>ï¼šæŒ‡åœ¨ç³»ç»Ÿè¿è¡Œè¿‡ç¨‹ä¸­åŠ¨æ€çš„æ·»åŠ æ•°æ®æºï¼Œåˆ é™¤æ•°æ®æºï¼Œå¤šä½¿ç”¨äºåŸºäºæ•°æ®åº“çš„å¤šç§Ÿæˆ·ç³»ç»Ÿã€‚</p><p><code>åŠ¨æ€è§£ææ•°æ®æº</code>ï¼šæŒ‡æ•°æ®æºåˆ‡æ¢æ˜¯ä¸å›ºå®šçš„ï¼Œå¯ä»¥æ ¹æ®åŸŸåï¼Œæ ¹æ®headerå‚æ•°ï¼Œæ ¹æ®sessionå‚æ•°ï¼Œæ ¹æ®æ–¹æ³•å˜é‡ç­‰æ¥åŠ¨æ€åˆ‡æ¢ã€‚å¤šä½¿ç”¨äºå¤šç§Ÿæˆ·ç³»ç»Ÿï¼Œæ”¯æŒæ‰©å±•ã€‚</p><p><code>æ•°æ®åº“åŠ å¯†</code>ï¼šæŒ‡æ•°æ®åº“çš„urlï¼Œusernameï¼Œpasswordéœ€è¦åŠ å¯†ï¼Œé•¿ç”¨äºå®‰å…¨æ€§è¾ƒé«˜ç³»ç»Ÿï¼Œä¸è®©æ™®é€šå¼€å‘é€šè¿‡é…ç½®çŸ¥é“ç”Ÿäº§åº“çš„è¿æ¥é…ç½®ã€‚</p><p><code>å¯åŠ¨åˆå§‹åŒ–è„šæœ¬</code>ï¼šæŒ‡æ•°æ®æºå¯åŠ¨çš„æ—¶å€™å¯ä»¥æ‰§è¡Œschemaå’Œdataçš„è„šæœ¬æ¥åˆå§‹åŒ–ç»“æ„å’Œæ•°æ®ï¼Œdynamic-datasourceç»„ä»¶æ”¯æŒæ¯ä¸ªæ•°æ®æºåŠ è½½ä¸åŒçš„schemaå’Œdataã€‚</p><p><code>è‡ªåŠ¨è¯»å†™åˆ†ç¦»</code>ï¼šé€‚ç”¨äºmybatisç¯å¢ƒï¼ŒåŸºäºmybatisæ’ä»¶å®ç°æ— æ³¨è§£è‡ªåŠ¨è¯»å†™åˆ†ç¦»ã€‚</p><p><code>æ‡’å¯åŠ¨æ•°æ®æº</code>ï¼šæŒ‡é…ç½®çš„æ•°æ®æºä¸ç«‹å³å¯åŠ¨ï¼Œç­‰éœ€è¦å»ºç«‹è¿æ¥çš„æ—¶å€™å†çœŸæ­£åˆå§‹åŒ–è¿æ¥æ± ã€‚</p><p><code>æ— æ•°æ®æºå¯åŠ¨</code>ï¼šæŒ‡å¯åŠ¨çš„æ—¶å€™ä¸é…ç½®ä»»ä½•æ•°æ®æºï¼Œå…¨é åæœŸç³»ç»ŸåŠ¨æ€æ·»åŠ ã€‚</p><p><code>æ‰‹åŠ¨åˆ‡æ¢æ•°æ®æº</code>ï¼šæŒ‡æŸäº›æƒ…å†µæ— æ³•æ ¹æ®æ³¨è§£åˆ‡æ¢ï¼Œé€šè¿‡å·¥å…·ç±»æ‰‹åŠ¨åˆ‡æ¢æ•°æ®æºã€‚</p><h2 id=åŠ¨æ€æ·»åŠ ç§»é™¤æ•°æ®æº>åŠ¨æ€æ·»åŠ ç§»é™¤æ•°æ®æº<a hidden class=anchor aria-hidden=true href=#åŠ¨æ€æ·»åŠ ç§»é™¤æ•°æ®æº>#</a></h2><h3 id=åŸºç¡€ä»‹ç»-3>åŸºç¡€ä»‹ç»<a hidden class=anchor aria-hidden=true href=#åŸºç¡€ä»‹ç»-3>#</a></h3><p>ä¸»è¦åœ¨å¤šç§Ÿæˆ·åœºæ™¯ä¸­ï¼Œå¸¸å¸¸æ–°çš„ä¸€ä¸ªç§Ÿæˆ·è¿›æ¥éœ€è¦åŠ¨æ€çš„æ·»åŠ ä¸€ä¸ªæ•°æ®æºåˆ°åº“ä¸­ï¼Œä½¿å¾—ç³»ç»Ÿä¸ç”¨é‡å¯å³å¯åˆ‡æ¢æ•°æ®æºã€‚</p><h3 id=ä½¿ç”¨æ­¥éª¤>ä½¿ç”¨æ­¥éª¤<a hidden class=anchor aria-hidden=true href=#ä½¿ç”¨æ­¥éª¤>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>com.baomidou.dynamic.datasource.DynamicRoutingDataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.baomidou.dynamic.datasource.creator.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.baomidou.dynamic.datasource.spring.boot.autoconfigure.DataSourceProperty</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.baomidou.samples.ds.dto.DataSourceDTO</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>io.swagger.annotations.Api</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>io.swagger.annotations.ApiOperation</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.beans.BeanUtils</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.beans.factory.annotation.Autowired</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.validation.annotation.Validated</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.web.bind.annotation.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>javax.sql.DataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Set</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RestController</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RequestMapping</span><span class=p>(</span><span class=s>&#34;/datasources&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Api</span><span class=p>(</span><span class=n>tags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;æ·»åŠ åˆ é™¤æ•°æ®æº&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DataSourceController</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// private final DataSourceCreator dataSourceCreator;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 3.3.1åŠä»¥ä¸‹ç‰ˆæœ¬ä½¿ç”¨è¿™ä¸ªé€šç”¨ï¼Œå¼ºçƒˆæ¨èsb2ç”¨æˆ·è‡³å°‘å‡çº§åˆ°3.5.2ç‰ˆæœ¬</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>DefaultDataSourceCreator</span><span class=w> </span><span class=n>dataSourceCreator</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>BasicDataSourceCreator</span><span class=w> </span><span class=n>basicDataSourceCreator</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>JndiDataSourceCreator</span><span class=w> </span><span class=n>jndiDataSourceCreator</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>DruidDataSourceCreator</span><span class=w> </span><span class=n>druidDataSourceCreator</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>HikariDataSourceCreator</span><span class=w> </span><span class=n>hikariDataSourceCreator</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>BeeCpDataSourceCreator</span><span class=w> </span><span class=n>beeCpDataSourceCreator</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Dbcp2DataSourceCreator</span><span class=w> </span><span class=n>dbcp2DataSourceCreator</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;è·å–å½“å‰æ‰€æœ‰æ•°æ®æº&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>now</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DynamicRoutingDataSource</span><span class=w> </span><span class=n>ds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>DynamicRoutingDataSource</span><span class=p>)</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ds</span><span class=p>.</span><span class=na>getDataSources</span><span class=p>().</span><span class=na>keySet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// é€šç”¨æ•°æ®æºä¼šæ ¹æ®mavenä¸­é…ç½®çš„è¿æ¥æ± æ ¹æ®é¡ºåºä¾æ¬¡é€‰æ‹©ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// é»˜è®¤çš„é¡ºåºä¸ºdruid&gt;hikaricp&gt;beecp&gt;dbcp&gt;spring basic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PostMapping</span><span class=p>(</span><span class=s>&#34;/add&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;é€šç”¨æ·»åŠ æ•°æ®æºï¼ˆæ¨èï¼‰&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>add</span><span class=p>(</span><span class=nd>@Validated</span><span class=w> </span><span class=nd>@RequestBody</span><span class=w> </span><span class=n>DataSourceDTO</span><span class=w> </span><span class=n>dto</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DataSourceProperty</span><span class=w> </span><span class=n>dataSourceProperty</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataSourceProperty</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BeanUtils</span><span class=p>.</span><span class=na>copyProperties</span><span class=p>(</span><span class=n>dto</span><span class=p>,</span><span class=w> </span><span class=n>dataSourceProperty</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DynamicRoutingDataSource</span><span class=w> </span><span class=n>ds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>DynamicRoutingDataSource</span><span class=p>)</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dataSourceCreator</span><span class=p>.</span><span class=na>createDataSource</span><span class=p>(</span><span class=n>dataSourceProperty</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ds</span><span class=p>.</span><span class=na>addDataSource</span><span class=p>(</span><span class=n>dto</span><span class=p>.</span><span class=na>getPoolName</span><span class=p>(),</span><span class=w> </span><span class=n>dataSource</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ds</span><span class=p>.</span><span class=na>getDataSources</span><span class=p>().</span><span class=na>keySet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PostMapping</span><span class=p>(</span><span class=s>&#34;/addBasic(å¼ºçƒˆä¸æ¨èï¼Œé™¤äº†ç”¨äº†é©¬ä¸Šç§»é™¤)&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;æ·»åŠ åŸºç¡€æ•°æ®æº&#34;</span><span class=p>,</span><span class=w> </span><span class=n>notes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;è°ƒç”¨Springbootå†…ç½®æ–¹æ³•åˆ›å»ºæ•°æ®æºï¼Œå…¼å®¹1,2&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>addBasic</span><span class=p>(</span><span class=nd>@Validated</span><span class=w> </span><span class=nd>@RequestBody</span><span class=w> </span><span class=n>DataSourceDTO</span><span class=w> </span><span class=n>dto</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DataSourceProperty</span><span class=w> </span><span class=n>dataSourceProperty</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataSourceProperty</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BeanUtils</span><span class=p>.</span><span class=na>copyProperties</span><span class=p>(</span><span class=n>dto</span><span class=p>,</span><span class=w> </span><span class=n>dataSourceProperty</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DynamicRoutingDataSource</span><span class=w> </span><span class=n>ds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>DynamicRoutingDataSource</span><span class=p>)</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>basicDataSourceCreator</span><span class=p>.</span><span class=na>createDataSource</span><span class=p>(</span><span class=n>dataSourceProperty</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ds</span><span class=p>.</span><span class=na>addDataSource</span><span class=p>(</span><span class=n>dto</span><span class=p>.</span><span class=na>getPoolName</span><span class=p>(),</span><span class=w> </span><span class=n>dataSource</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ds</span><span class=p>.</span><span class=na>getDataSources</span><span class=p>().</span><span class=na>keySet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PostMapping</span><span class=p>(</span><span class=s>&#34;/addJndi&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;æ·»åŠ JNDIæ•°æ®æº&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>addJndi</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>pollName</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>jndiName</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DynamicRoutingDataSource</span><span class=w> </span><span class=n>ds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>DynamicRoutingDataSource</span><span class=p>)</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jndiDataSourceCreator</span><span class=p>.</span><span class=na>createDataSource</span><span class=p>(</span><span class=n>jndiName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ds</span><span class=p>.</span><span class=na>addDataSource</span><span class=p>(</span><span class=n>poolName</span><span class=p>,</span><span class=w> </span><span class=n>dataSource</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ds</span><span class=p>.</span><span class=na>getDataSources</span><span class=p>().</span><span class=na>keySet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PostMapping</span><span class=p>(</span><span class=s>&#34;/addDruid&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;åŸºç¡€Druidæ•°æ®æº&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>addDruid</span><span class=p>(</span><span class=nd>@Validated</span><span class=w> </span><span class=nd>@RequestBody</span><span class=w> </span><span class=n>DataSourceDTO</span><span class=w> </span><span class=n>dto</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DataSourceProperty</span><span class=w> </span><span class=n>dataSourceProperty</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataSourceProperty</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BeanUtils</span><span class=p>.</span><span class=na>copyProperties</span><span class=p>(</span><span class=n>dto</span><span class=p>,</span><span class=w> </span><span class=n>dataSourceProperty</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>dataSourceProperty</span><span class=p>.</span><span class=na>setLazy</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DynamicRoutingDataSource</span><span class=w> </span><span class=n>ds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>DynamicRoutingDataSource</span><span class=p>)</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>druidDataSourceCreator</span><span class=p>.</span><span class=na>createDataSource</span><span class=p>(</span><span class=n>dataSourceProperty</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ds</span><span class=p>.</span><span class=na>addDataSource</span><span class=p>(</span><span class=n>dto</span><span class=p>.</span><span class=na>getPoolName</span><span class=p>(),</span><span class=w> </span><span class=n>dataSource</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ds</span><span class=p>.</span><span class=na>getDataSources</span><span class=p>().</span><span class=na>keySet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PostMapping</span><span class=p>(</span><span class=s>&#34;/addHikariCP&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;åŸºç¡€HikariCPæ•°æ®æº&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>addHikariCP</span><span class=p>(</span><span class=nd>@Validated</span><span class=w> </span><span class=nd>@RequestBody</span><span class=w> </span><span class=n>DataSourceDTO</span><span class=w> </span><span class=n>dto</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DataSourceProperty</span><span class=w> </span><span class=n>dataSourceProperty</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataSourceProperty</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BeanUtils</span><span class=p>.</span><span class=na>copyProperties</span><span class=p>(</span><span class=n>dto</span><span class=p>,</span><span class=w> </span><span class=n>dataSourceProperty</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>dataSourceProperty</span><span class=p>.</span><span class=na>setLazy</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w> </span><span class=c1>// 3.4.0ç‰ˆæœ¬ä»¥ä¸‹å¦‚æœæœ‰æ­¤å±æ€§ï¼Œéœ€æ‰‹åŠ¨è®¾ç½®ï¼Œä¸ç„¶ä¼šç©ºæŒ‡é’ˆã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DynamicRoutingDataSource</span><span class=w> </span><span class=n>ds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>DynamicRoutingDataSource</span><span class=p>)</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>hikariDataSourceCreator</span><span class=p>.</span><span class=na>createDataSource</span><span class=p>(</span><span class=n>dataSourceProperty</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ds</span><span class=p>.</span><span class=na>addDataSource</span><span class=p>(</span><span class=n>dto</span><span class=p>.</span><span class=na>getPoolName</span><span class=p>(),</span><span class=w> </span><span class=n>dataSource</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ds</span><span class=p>.</span><span class=na>getDataSources</span><span class=p>().</span><span class=na>keySet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PostMapping</span><span class=p>(</span><span class=s>&#34;/addBeeCp&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;åŸºç¡€BeeCpæ•°æ®æº&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>addBeeCp</span><span class=p>(</span><span class=nd>@Validated</span><span class=w> </span><span class=nd>@RequestBody</span><span class=w> </span><span class=n>DataSourceDTO</span><span class=w> </span><span class=n>dto</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DataSourceProperty</span><span class=w> </span><span class=n>dataSourceProperty</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataSourceProperty</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BeanUtils</span><span class=p>.</span><span class=na>copyProperties</span><span class=p>(</span><span class=n>dto</span><span class=p>,</span><span class=w> </span><span class=n>dataSourceProperty</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>dataSourceProperty</span><span class=p>.</span><span class=na>setLazy</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w> </span><span class=c1>// 3.4.0ç‰ˆæœ¬ä»¥ä¸‹å¦‚æœæœ‰æ­¤å±æ€§ï¼Œéœ€æ‰‹åŠ¨è®¾ç½®ï¼Œä¸ç„¶ä¼šç©ºæŒ‡é’ˆã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DynamicRoutingDataSource</span><span class=w> </span><span class=n>ds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>DynamicRoutingDataSource</span><span class=p>)</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>beeCpDataSourceCreator</span><span class=p>.</span><span class=na>createDataSource</span><span class=p>(</span><span class=n>dataSourceProperty</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ds</span><span class=p>.</span><span class=na>addDataSource</span><span class=p>(</span><span class=n>dto</span><span class=p>.</span><span class=na>getPoolName</span><span class=p>(),</span><span class=w> </span><span class=n>dataSource</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ds</span><span class=p>.</span><span class=na>getDataSources</span><span class=p>().</span><span class=na>keySet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PostMapping</span><span class=p>(</span><span class=s>&#34;/addDbcp&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;åŸºç¡€Dbcpæ•°æ®æº&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>addDbcp</span><span class=p>(</span><span class=nd>@Validated</span><span class=w> </span><span class=nd>@RequestBody</span><span class=w> </span><span class=n>DataSourceDTO</span><span class=w> </span><span class=n>dto</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DataSourceProperty</span><span class=w> </span><span class=n>dataSourceProperty</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataSourceProperty</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BeanUtils</span><span class=p>.</span><span class=na>copyProperties</span><span class=p>(</span><span class=n>dto</span><span class=p>,</span><span class=w> </span><span class=n>dataSourceProperty</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>dataSourceProperty</span><span class=p>.</span><span class=na>setLazy</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w> </span><span class=c1>// 3.4.0ç‰ˆæœ¬ä»¥ä¸‹å¦‚æœæœ‰æ­¤å±æ€§ï¼Œéœ€æ‰‹åŠ¨è®¾ç½®ï¼Œä¸ç„¶ä¼šç©ºæŒ‡é’ˆã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DynamicRoutingDataSource</span><span class=w> </span><span class=n>ds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>DynamicRoutingDataSource</span><span class=p>)</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dbcp2DataSourceCreator</span><span class=p>.</span><span class=na>createDataSource</span><span class=p>(</span><span class=n>dataSourceProperty</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ds</span><span class=p>.</span><span class=na>addDataSource</span><span class=p>(</span><span class=n>dto</span><span class=p>.</span><span class=na>getPoolName</span><span class=p>(),</span><span class=w> </span><span class=n>dataSource</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ds</span><span class=p>.</span><span class=na>getDataSources</span><span class=p>().</span><span class=na>keySet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DeleteMapping</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;åˆ é™¤æ•°æ®æº&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>remove</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DynamicRoutingDataSource</span><span class=w> </span><span class=n>ds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>DynamicRoutingDataSource</span><span class=p>)</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ds</span><span class=p>.</span><span class=na>removeDataSource</span><span class=p>(</span><span class=n>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&#34;åˆ é™¤æˆåŠŸ&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=ç¤ºä¾‹é¡¹ç›®-2>ç¤ºä¾‹é¡¹ç›®<a hidden class=anchor aria-hidden=true href=#ç¤ºä¾‹é¡¹ç›®-2>#</a></h3><p><a href=https://github.com/dynamic-datasource/dynamic-datasource-samples/tree/master/features-samples/add-remove-datasource-sample>ç‚¹æˆ‘è·³è½¬</a></p><h3 id=æºç åˆ†æ>æºç åˆ†æ<a hidden class=anchor aria-hidden=true href=#æºç åˆ†æ>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>DataSourceCreator</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * é€šè¿‡å±æ€§åˆ›å»ºæ•°æ®æº
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param dataSourceProperty æ•°æ®æºå±æ€§
</span></span></span><span class=line><span class=cl><span class=cm>     * @return è¢«åˆ›å»ºçš„æ•°æ®æº
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DataSource</span><span class=w> </span><span class=nf>createDataSource</span><span class=p>(</span><span class=n>DataSourceProperty</span><span class=w> </span><span class=n>dataSourceProperty</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * å½“å‰åˆ›å»ºå™¨æ˜¯å¦æ”¯æŒæ ¹æ®æ­¤å±æ€§åˆ›å»º
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param dataSourceProperty æ•°æ®æºå±æ€§
</span></span></span><span class=line><span class=cl><span class=cm>     * @return æ˜¯å¦æ”¯æŒ
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=nf>support</span><span class=p>(</span><span class=n>DataSourceProperty</span><span class=w> </span><span class=n>dataSourceProperty</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>DataSourceCreatoræ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®šä¹‰äº†æ ¹æ®å‚æ•°åˆ›å»ºæ•°æ®æºçš„æ¥å£ã€‚</p><p>å…¶ä»–creatorå®ç°æ­¤æ¥å£ï¼Œdynamic-datasourceé¡¹ç›®æš‚æ—¶å®ç°äº†Druidå’ŒHikaricpçš„ç­‰è¿æ¥æ± çš„å®ç°ã€‚</p><p>BasicDataSourceCreator æ˜¯è°ƒç”¨SpringåŸç”Ÿçš„åˆ›å»ºæ–¹å¼ï¼Œåªæ”¯æŒæœ€æœ€åŸå§‹çš„åŸºç¡€é…ç½®ã€‚</p><p>DefaultDataSourceCreator æ˜¯ä¸€ä¸ªé€šç”¨çš„åˆ›å»ºå™¨ï¼Œå…¶æ ¹æ®ç¯å¢ƒè‡ªåŠ¨é€‰æ‹©è¿æ¥æ± ã€‚</p><h2 id=åŠ¨æ€è§£ææ•°æ®æº>åŠ¨æ€è§£ææ•°æ®æº<a hidden class=anchor aria-hidden=true href=#åŠ¨æ€è§£ææ•°æ®æº>#</a></h2><h3 id=åŸºç¡€ä»‹ç»-4>åŸºç¡€ä»‹ç»<a hidden class=anchor aria-hidden=true href=#åŸºç¡€ä»‹ç»-4>#</a></h3><p>é»˜è®¤æœ‰ä¸‰ä¸ªèŒè´£é“¾æ¥å¤„ç†åŠ¨æ€å‚æ•°è§£æå™¨ header -> session -> spel</p><p>æ‰€æœ‰ä»¥ <code>#</code> å¼€å¤´çš„å‚æ•°éƒ½ä¼šä»å‚æ•°ä¸­è·å–æ•°æ®æº</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;#session.tenantName&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>// ä»sessionè·å–</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=w> </span><span class=nf>selectSpelBySession</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=n>userMapper</span><span class=p>.</span><span class=na>selectUsers</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;#header.tenantName&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>// ä»headerè·å–</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=w> </span><span class=nf>selectSpelByHeader</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=n>userMapper</span><span class=p>.</span><span class=na>selectUsers</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;#tenantName&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>// ä½¿ç”¨spelä»å‚æ•°è·å–</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=w> </span><span class=nf>selectSpelByKey</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>tenantName</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=n>userMapper</span><span class=p>.</span><span class=na>selectUsers</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;#user.tenantName&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>// ä½¿ç”¨spelä»å¤æ‚å‚æ•°è·å–</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=w> </span><span class=nf>selecSpelByTenant</span><span class=p>(</span><span class=n>User</span><span class=w> </span><span class=n>user</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=n>userMapper</span><span class=p>.</span><span class=na>selectUsers</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=å¦‚ä½•æ‰©å±•>å¦‚ä½•æ‰©å±•<a hidden class=anchor aria-hidden=true href=#å¦‚ä½•æ‰©å±•>#</a></h3><ol><li>æˆ‘æƒ³ä»cookieä¸­è·å–å‚æ•°è§£æ?</li><li>æˆ‘æƒ³ä»å…¶ä»–ç¯å¢ƒå±æ€§ä¸­æ¥è®¡ç®—?</li></ol><p>å‚è€ƒheaderè§£æå™¨ï¼Œç»§æ‰¿DsProcessorï¼Œå¦‚æœmatchesè¿”å›trueåˆ™åŒ¹é…æˆåŠŸï¼Œè°ƒç”¨doDetermineDatasourceè¿”å›åŒ¹é…åˆ°çš„æ•°æ®æºï¼Œå¦åˆ™è·³åˆ°ä¸‹ä¸€ä¸ªè§£æå™¨ã€‚</p><p>1ã€è‡ªå®šä¹‰ä¸€ä¸ªå¤„ç†å™¨</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DsHeaderProcessor</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>DsProcessor</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>HEADER_PREFIX</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;#header&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>matches</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>startsWith</span><span class=p>(</span><span class=n>HEADER_PREFIX</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>doDetermineDatasource</span><span class=p>(</span><span class=n>MethodInvocation</span><span class=w> </span><span class=n>invocation</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>ServletRequestAttributes</span><span class=p>)</span><span class=w> </span><span class=n>RequestContextHolder</span><span class=p>.</span><span class=na>getRequestAttributes</span><span class=p>()).</span><span class=na>getRequest</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getHeader</span><span class=p>(</span><span class=n>key</span><span class=p>.</span><span class=na>substring</span><span class=p>(</span><span class=n>8</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>2ã€é‡å†™å®Œåé‡æ–°æ³¨å…¥ä¸€ä¸ªæ ¹æ®è‡ªå·±è§£æé¡ºåºçš„è§£æå¤„ç†å™¨</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MyDynamicDataSourceConfig</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=kd>public</span><span class=w> </span><span class=n>DsProcessor</span><span class=w> </span><span class=nf>dsProcessor</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DsHeaderProcessor</span><span class=w> </span><span class=n>headerProcessor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DsHeaderProcessor</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DsSessionProcessor</span><span class=w> </span><span class=n>sessionProcessor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DsSessionProcessor</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DsSpelExpressionProcessor</span><span class=w> </span><span class=n>spelExpressionProcessor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DsSpelExpressionProcessor</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>headerProcessor</span><span class=p>.</span><span class=na>setNextProcessor</span><span class=p>(</span><span class=n>sessionProcessor</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sessionProcessor</span><span class=p>.</span><span class=na>setNextProcessor</span><span class=p>(</span><span class=n>spelExpressionProcessor</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>headerProcessor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=æ³¨æ„>æ³¨æ„<a hidden class=anchor aria-hidden=true href=#æ³¨æ„>#</a></h3><p>å¦‚æœåœ¨Mapperæ¥å£ä¸‹é¢çš„æ–¹æ³•ä½¿ç”¨ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>UserMapper</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å‰ç¼€å¯ä»¥æ˜¯p0,a0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;#p0.tenantName&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=w> </span><span class=nf>selecSpelByTenant</span><span class=p>(</span><span class=n>User</span><span class=w> </span><span class=n>user</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>å¯¹äºåœ¨æ¥å£ä¸‹é¢çš„ä½¿ç”¨, ç”±äºç¼–è¯‘å™¨çš„é»˜è®¤é…ç½®æ²¡æœ‰å°†æ¥å£å‚æ•°çš„å…ƒæ•°æ®å†™å…¥å­—èŠ‚ç æ–‡ä»¶ä¸­
æ‰€ä»¥spring elä¼šæ— æ³•è¯†åˆ«å‚æ•°åç§°, åªèƒ½ç”¨é»˜è®¤çš„å‚æ•°å‘½åæ–¹å¼</p><ol><li>ç¬¬ä¸€ä¸ªå‚æ•°: p0ï¼Œa0,(åŠ å…¥-parametersåï¼Œå¯ä»¥ä½¿ç”¨å‚æ•°å…·ä½“çš„åå­—ï¼Œä¾‹å¦‚è¿™é‡Œçš„#user)</li><li>ç¬¬äºŒä¸ªå‚æ•°: p1ï¼Œa1</li><li>ç¬¬ä¸‰ä¸ªå‚æ•°: P2,ï¼Œa2</li></ol><p>å¯ä»¥é€šè¿‡ä¿®æ”¹mavené…ç½®å’Œjavaç¼–è¯‘é…ç½®å°†æ¥å£å‚æ•°ä¿¡æ¯å†™å…¥å­—èŠ‚ç æ–‡ä»¶</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl>    <span class=nt>&lt;plugin&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;groupId&gt;</span>org.apache.maven.plugins<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;artifactId&gt;</span>maven-compiler-plugin<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>        <span class=c>&lt;!-- æƒ³å¯ç”¨  &lt;parameters&gt;true&lt;/parameters&gt; çš„mavenç¼–è¯‘æœ€ä½ç‰ˆæœ¬ä¸º:3.6.2 --&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;version&gt;</span>3.6.2<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;configuration&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;source&gt;</span>${java.version}<span class=nt>&lt;/source&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;target&gt;</span>${java.version}<span class=nt>&lt;/target&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;parameters&gt;</span>true<span class=nt>&lt;/parameters&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/configuration&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/plugin&gt;</span>
</span></span></code></pre></div><p>idea javaç¼–è¯‘é…ç½®: <code>-parameters</code></p><blockquote><p>java æ”¯æŒ-parametersçš„æœ€ä½ç‰ˆæœ¬ä¸º 1.8</p></blockquote><h2 id=æ•°æ®åº“åŠ å¯†>æ•°æ®åº“åŠ å¯†<a hidden class=anchor aria-hidden=true href=#æ•°æ®åº“åŠ å¯†>#</a></h2><h3 id=åŸºç¡€ä»‹ç»-5>åŸºç¡€ä»‹ç»<a hidden class=anchor aria-hidden=true href=#åŸºç¡€ä»‹ç»-5>#</a></h3><p>åœ¨ä¸€äº›é¡¹ç›®ä¸­ï¼Œæœ‰å¯¹æ•°æ®åº“å…³é”®å­—æ®µåŠ å¯†çš„éœ€æ±‚ï¼Œå¤§å®¶ç†Ÿæ‚‰çš„æ˜¯Druidçš„åŠ å¯†æ–¹å¼ã€‚</p><p>åœ¨è¿æ¥æ± é›†æˆä¸­çš„Druidç« èŠ‚é‡Œæœ‰å¯¹åº”çš„åŠ å¯†æ–¹å¼ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä¸ç”¨Druidä¹Ÿæƒ³ç”¨åŠ å¯†å‘¢ï¼Ÿ</p><p>æ‰€ä»¥ä½œè€…copyäº†Druidçš„åŠ å¯†ç›¸å…³æºç ï¼Œå˜¿å˜¿ã€‚</p><p>dynamic-datasourceé¡¹ç›®ä¹Ÿæ”¯æŒæ”¯æŒ<code>url</code> , <code>username</code>, <code>password</code> çš„åŠ å¯†ã€‚</p><p>ä½¿ç”¨çš„RASåŠ å¯†ï¼Œç›¸å…³åŸç†æ–‡ç«  <a href=https://www.cnblogs.com/pcheng/p/9629621.html>https://www.cnblogs.com/pcheng/p/9629621.html</a>ã€‚</p><p>ç®€å•æ¥è¯´å°±æ˜¯ç”Ÿæˆä¸¤æŠŠé’¥åŒ™ï¼Œç§é’¥åŠ å¯†ï¼Œå…¬é’¥è§£å¯†ã€‚</p><p>å…¬é’¥å¯ä»¥å‘å¸ƒå‡ºå»ï¼Œè§£å¯†ä¹Ÿæ˜¯ç”¨çš„å…¬é’¥ã€‚</p><h3 id=å…·ä½“ä½¿ç”¨>å…·ä½“ä½¿ç”¨<a hidden class=anchor aria-hidden=true href=#å…·ä½“ä½¿ç”¨>#</a></h3><p>1ã€è·å¾—åŠ å¯†å­—ç¬¦ä¸²</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>com.baomidou.dynamic.datasource.toolkit.CryptoUtils</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Demo</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>password</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;123456&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ä½¿ç”¨é»˜è®¤çš„publicKey ï¼Œå»ºè®®è¿˜æ˜¯ä½¿ç”¨ä¸‹é¢çš„è‡ªå®šä¹‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>encodePassword</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>CryptoUtils</span><span class=p>.</span><span class=na>encrypt</span><span class=p>(</span><span class=n>password</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>encodePassword</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è‡ªå®šä¹‰publicKey</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>arr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>CryptoUtils</span><span class=p>.</span><span class=na>genKeyPair</span><span class=p>(</span><span class=n>512</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;privateKey:  &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>arr</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;publicKey:  &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>arr</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;url:  &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>CryptoUtils</span><span class=p>.</span><span class=na>encrypt</span><span class=p>(</span><span class=n>arr</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>,</span><span class=w> </span><span class=s>&#34;jdbc:mysql://127.0.0.1:3306/order&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;username:  &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>CryptoUtils</span><span class=p>.</span><span class=na>encrypt</span><span class=p>(</span><span class=n>arr</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>,</span><span class=w> </span><span class=s>&#34;root&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;password:  &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>CryptoUtils</span><span class=p>.</span><span class=na>encrypt</span><span class=p>(</span><span class=n>arr</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>,</span><span class=w> </span><span class=s>&#34;123456&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>2ã€é…ç½®åŠ å¯†yml</p><p><code>ENC(xxx)</code> ä¸­åŒ…è£¹çš„<code>xxx</code>å³ä¸ºä½¿ç”¨ä¸Šé¢åŠ å¯†æ–¹æ³•åç”Ÿæˆçš„å­—ç¬¦ä¸²</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dynamic</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>public-key</span><span class=p>:</span><span class=w> </span><span class=c># æœ‰é»˜è®¤å€¼ï¼Œå¼ºçƒˆå»ºè®®æ›´æ¢</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>master</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>ENC(xxx)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>ENC(xxx)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>ENC(xxx)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>public-key</span><span class=p>:</span><span class=w> </span><span class=c># æ¯ä¸ªæ•°æ®æºå¯ä»¥ç‹¬ç«‹è®¾ç½®ï¼Œæ²¡æœ‰å°±ç»§æ‰¿ä¸Šé¢çš„ã€‚</span><span class=w>
</span></span></span></code></pre></div><h3 id=è‡ªå®šä¹‰è§£å¯†>è‡ªå®šä¹‰è§£å¯†<a hidden class=anchor aria-hidden=true href=#è‡ªå®šä¹‰è§£å¯†>#</a></h3><p>ä¸€äº›å…¬å¸è¦æ±‚ä½¿ç”¨è‡ªå·±çš„æ–¹å¼åŠ å¯†ï¼Œè§£å¯†ã€‚</p><p>ä»3.5.0ç‰ˆæœ¬å¼€å§‹ï¼Œæ‰©å±•äº†ä¸€ä¸ªeventï¼Œç”¨æˆ·è‡ªè¡Œå®ç°æ³¨å…¥å³å¯ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>DataSourceInitEvent</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è¿æ¥æ± åˆ›å»ºå‰æ‰§è¡Œï¼ˆå¯ç”¨äºå‚æ•°è§£å¯†ï¼‰
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param dataSourceProperty æ•°æ®æºåŸºç¡€ä¿¡æ¯
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>beforeCreate</span><span class=p>(</span><span class=n>DataSourceProperty</span><span class=w> </span><span class=n>dataSourceProperty</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è¿æ¥æ± åˆ›å»ºåæ‰§è¡Œ
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param dataSource è¿æ¥æ± 
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>afterCreate</span><span class=p>(</span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>é»˜è®¤çš„å®ç°æ˜¯EncDataSourceInitEventï¼Œå³ENCæ–¹å¼çš„ã€‚</p><h3 id=ä¸ºä»€ä¹ˆä¸æ˜¯å…¬é’¥åŠ å¯†ç§é’¥è§£å¯†>ä¸ºä»€ä¹ˆä¸æ˜¯å…¬é’¥åŠ å¯†ï¼Œç§é’¥è§£å¯†<a hidden class=anchor aria-hidden=true href=#ä¸ºä»€ä¹ˆä¸æ˜¯å…¬é’¥åŠ å¯†ç§é’¥è§£å¯†>#</a></h3><p>æ ¹æ®RSAçš„è®¾è®¡ï¼Œå¤§éƒ¨åˆ†äººä¼šè®¤ä¸ºåº”è¯¥æ˜¯å…¬é’¥åŠ å¯†ï¼Œç§é’¥è§£å¯†ã€‚ ä¸ºä»€ä¹ˆDruidè®¾è®¡ç›¸åï¼Ÿ</p><p><code>å»ºè®®æ›´é«˜çš„å®‰å…¨ï¼Œå¯ä»¥æŠŠpublicKeyåœ¨å¯åŠ¨æ—¶å€™ä¼ è¿›å»ï¼Œæˆ–è€…é…ç½®ä¸­å¿ƒé…å¥½ï¼Œä¸è®©æ™®é€šå¼€å‘æ¥è§¦åˆ°å°±å¥½ã€‚</code></p><p>æŸ¥è¯¢äº†Druidçš„ISSUEå’Œä¸€äº›æ–‡ç« ï¼š</p><p>1ã€Druidä½œè€…wenshaoè‡ªå·±çš„å›ç­”ï¼š<a href=https://github.com/alibaba/druid/issues/960>ç‚¹æˆ‘è·³è½¬</a></p><p>2ã€çŸ¥ä¹ä¸€äº›æ–‡ç« ç‰‡æ®µ</p><p><img loading=lazy src=/blog/posts/code/174974400001/images/1.png></p><h2 id=å¯åŠ¨åˆå§‹åŒ–æ‰§è¡Œè„šæœ¬>å¯åŠ¨åˆå§‹åŒ–æ‰§è¡Œè„šæœ¬<a hidden class=anchor aria-hidden=true href=#å¯åŠ¨åˆå§‹åŒ–æ‰§è¡Œè„šæœ¬>#</a></h2><p>3.5.0 ä¹‹å‰ç‰ˆæœ¬</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dynamic</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>primary</span><span class=p>:</span><span class=w> </span><span class=l>order</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>order</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># åŸºç¡€é…ç½®çœç•¥...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>schema</span><span class=p>:</span><span class=w> </span><span class=l>db/order/schema.sql</span><span class=w> </span><span class=c># é…ç½®åˆ™ç”Ÿæ•ˆ,è‡ªåŠ¨åˆå§‹åŒ–è¡¨ç»“æ„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>data</span><span class=p>:</span><span class=w> </span><span class=l>db/order/data.sql</span><span class=w> </span><span class=c># é…ç½®åˆ™ç”Ÿæ•ˆ,è‡ªåŠ¨åˆå§‹åŒ–æ•°æ®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>continue-on-error</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w> </span><span class=c># é»˜è®¤true,åˆå§‹åŒ–å¤±è´¥æ˜¯å¦ç»§ç»­</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>separator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;;&#34;</span><span class=w> </span><span class=c># sqlé»˜è®¤åˆ†å·åˆ†éš”ç¬¦ï¼Œä¸€èˆ¬æ— éœ€æ›´æ”¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>product</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>schema</span><span class=p>:</span><span class=w> </span><span class=l>classpath*:db/product/schema.sql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>data</span><span class=p>:</span><span class=w> </span><span class=l>classpath*:db/product/data.sql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>user</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>schema</span><span class=p>:</span><span class=w> </span><span class=l>classpath*:db/user/schema/**/*.sql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>data</span><span class=p>:</span><span class=w> </span><span class=l>classpath*:db/user/data/**/*.sql</span><span class=w>
</span></span></span></code></pre></div><p>3.5.0ï¼ˆå«ï¼‰ ä¹‹åç‰ˆæœ¬ (å±‚çº§å¤šäº†ä¸€å±‚initï¼Œä¿æŒå’Œæ–°ç‰ˆspringbootä¸€è‡´)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dynamic</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>primary</span><span class=p>:</span><span class=w> </span><span class=l>order</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>order</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># åŸºç¡€é…ç½®çœç•¥...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>init</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>schema</span><span class=p>:</span><span class=w> </span><span class=l>db/order/schema.sql</span><span class=w> </span><span class=c># é…ç½®åˆ™ç”Ÿæ•ˆ,è‡ªåŠ¨åˆå§‹åŒ–è¡¨ç»“æ„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>data</span><span class=p>:</span><span class=w> </span><span class=l>db/order/data.sql</span><span class=w> </span><span class=c># é…ç½®åˆ™ç”Ÿæ•ˆ,è‡ªåŠ¨åˆå§‹åŒ–æ•°æ®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>continue-on-error</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w> </span><span class=c># é»˜è®¤true,åˆå§‹åŒ–å¤±è´¥æ˜¯å¦ç»§ç»­</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>separator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;;&#34;</span><span class=w> </span><span class=c># sqlé»˜è®¤åˆ†å·åˆ†éš”ç¬¦ï¼Œä¸€èˆ¬æ— éœ€æ›´æ”¹</span><span class=w>
</span></span></span></code></pre></div><h2 id=æ‡’å¯åŠ¨æ•°æ®æº>æ‡’å¯åŠ¨æ•°æ®æº<a hidden class=anchor aria-hidden=true href=#æ‡’å¯åŠ¨æ•°æ®æº>#</a></h2><p>æ‡’å¯åŠ¨ï¼šè¿æ¥æ± åˆ›å»ºå‡ºæ¥åå¹¶ä¸ä¼šç«‹å³åˆå§‹åŒ–è¿æ¥æ± ï¼Œç­‰éœ€è¦ä½¿ç”¨connectionçš„æ—¶å€™å†åˆå§‹åŒ–ã€‚</p><p>æš‚æ—¶åªæ”¯æŒDruidå’ŒHikariCpå’ŒBeeCpè¿æ¥æ± ã€‚</p><p>ä¸»è¦åœºæ™¯å¯èƒ½é€‚åˆäºæ•°æ®æºå¾ˆå¤šï¼Œåˆä¸éœ€è¦å¯åŠ¨ç«‹å³åˆå§‹åŒ–çš„æƒ…å†µï¼Œå¯ä»¥å‡å°‘ç³»ç»Ÿå¯åŠ¨æ—¶é—´ã€‚</p><p><code>ç¼ºç‚¹</code>åœ¨äºï¼Œå¦‚æœå‚æ•°é…ç½®æœ‰è¯¯ï¼Œåˆ™å¯åŠ¨çš„æ—¶å€™ä¸çŸ¥é“ï¼Œåˆå§‹åŒ–çš„æ—¶å€™å¤±è´¥ï¼Œå¯èƒ½ä¸€ç›´æŠ›å¼‚å¸¸ã€‚</p><h3 id=é…ç½®ä½¿ç”¨>é…ç½®ä½¿ç”¨<a hidden class=anchor aria-hidden=true href=#é…ç½®ä½¿ç”¨>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dynamic</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>primary</span><span class=p>:</span><span class=w> </span><span class=l>master</span><span class=w> </span><span class=c># è®¾ç½®é»˜è®¤çš„æ•°æ®æºæˆ–è€…æ•°æ®æºç»„,é»˜è®¤å€¼å³ä¸ºmaster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>strict</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=c># è®¾ç½®ä¸¥æ ¼æ¨¡å¼,é»˜è®¤falseä¸å¯åŠ¨. å¯åŠ¨ååœ¨æœªåŒ¹é…åˆ°æŒ‡å®šæ•°æ®æºæ—¶å€™ä¼šæŠ›å‡ºå¼‚å¸¸,ä¸å¯åŠ¨åˆ™ä½¿ç”¨é»˜è®¤æ•°æ®æº.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>lazy</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w> </span><span class=c># é»˜è®¤falseéæ‡’å¯åŠ¨ï¼Œç³»ç»ŸåŠ è½½åˆ°æ•°æ®æºç«‹å³åˆå§‹åŒ–è¿æ¥æ± </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>master</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://xx.xx.xx.xx:3306/dynamic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>lazy</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w> </span><span class=c>#è¡¨ç¤ºè¿™ä¸ªæ•°æ®æºæ‡’å¯åŠ¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>db1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://xx.xx.xx.xx:3307/dynamic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>db2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://xx.xx.xx.xx:3307/dynamic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span></code></pre></div><h2 id=æ— æ•°æ®æºå¯åŠ¨>æ— æ•°æ®æºå¯åŠ¨<a hidden class=anchor aria-hidden=true href=#æ— æ•°æ®æºå¯åŠ¨>#</a></h2><h3 id=åŸºç¡€ä»‹ç»-6>åŸºç¡€ä»‹ç»<a hidden class=anchor aria-hidden=true href=#åŸºç¡€ä»‹ç»-6>#</a></h3><p>åœºæ™¯ï¼šéƒ¨åˆ†ç³»ç»Ÿå¯èƒ½å¯åŠ¨çš„æ—¶å€™å®Œå…¨ä¸éœ€è¦æ•°æ®æºï¼Œå…¨é å¯åŠ¨ååŠ¨æ€æ·»åŠ ã€‚</p><h3 id=é…ç½®æ–¹å¼>é…ç½®æ–¹å¼<a hidden class=anchor aria-hidden=true href=#é…ç½®æ–¹å¼>#</a></h3><p>å³åŸºæœ¬ä¸éœ€è¦é…ç½®ï¼Œå¯èƒ½æ ¹æ®éœ€è¦é…ç½®ä¸€äº›ç±»ä¼¼Druidå’ŒHikariCpå…¨å±€å‚æ•°ã€‚</p><p>å¦‚éœ€é…ç½®Druidå’ŒHikariCpå…¨å±€å‚æ•°å¯å‚è€ƒå¯¹åº”ç« èŠ‚æ–‡æ¡£ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dynamic</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>primary</span><span class=p>:</span><span class=w> </span><span class=l>master</span><span class=w> </span><span class=c># è®¾ç½®é»˜è®¤çš„æ•°æ®æºæˆ–è€…æ•°æ®æºç»„,é»˜è®¤å€¼å³ä¸ºmaster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>strict</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=c># è®¾ç½®ä¸¥æ ¼æ¨¡å¼,é»˜è®¤falseä¸å¯åŠ¨. å¯åŠ¨ååœ¨æœªåŒ¹é…åˆ°æŒ‡å®šæ•°æ®æºæ—¶å€™ä¼šæŠ›å‡ºå¼‚å¸¸,ä¸å¯åŠ¨åˆ™ä½¿ç”¨é»˜è®¤æ•°æ®æº.</span><span class=w>
</span></span></span></code></pre></div><p>å› ä¸ºæ²¡æœ‰åŒ¹é…çš„ä¸»æ•°æ®æºï¼Œå¯åŠ¨çš„æ—¶å€™ä½ ä¼šè§åˆ°ç±»ä¼¼å¦‚ä¸‹æ—¥å¿—ã€‚</p><pre tabindex=0><code>dynamic-datasource initial loaded 0 datasource,Please add your primary datasource or check your configuration
</code></pre><h2 id=æ‰‹åŠ¨åˆ‡æ¢æ•°æ®æº>æ‰‹åŠ¨åˆ‡æ¢æ•°æ®æº<a hidden class=anchor aria-hidden=true href=#æ‰‹åŠ¨åˆ‡æ¢æ•°æ®æº>#</a></h2><p>åœ¨æŸäº›æƒ…å†µæ‚¨å¯èƒ½éœ€è¦æ‰‹åŠ¨åˆ‡æ¢æ•°æ®æºã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>com.baomidou.dynamic.datasource.toolkit.DynamicDataSourceContextHolder</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UserServiceImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>UserService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=n>JdbcTemplate</span><span class=w> </span><span class=n>jdbcTemplate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=w> </span><span class=nf>selectAll</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DynamicDataSourceContextHolder</span><span class=p>.</span><span class=na>push</span><span class=p>(</span><span class=s>&#34;slave&#34;</span><span class=p>);</span><span class=w> </span><span class=c1>// æ‰‹åŠ¨åˆ‡æ¢</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w>  </span><span class=n>jdbcTemplate</span><span class=p>.</span><span class=na>queryForList</span><span class=p>(</span><span class=s>&#34;select * from user&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>éœ€è¦æ³¨æ„çš„æ˜¯æ‰‹åŠ¨åˆ‡æ¢çš„æ•°æ®æºï¼Œæœ€å¥½è‡ªå·±åœ¨åˆé€‚çš„ä½ç½®è°ƒç”¨DynamicDataSourceContextHolder.clear()æ¸…ç©ºå½“å‰çº¿ç¨‹çš„æ•°æ®æºä¿¡æ¯ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ï¼Œå› ä¸ºä¸€å±‚ä½¿ç”¨çš„æ˜¯ThreadLocal</strong></p><p>å¦‚æœä½ ä¸å¤ªæ¸…æ¥šä»€ä¹ˆæ—¶å€™è°ƒç”¨ï¼Œé‚£ä¹ˆå¯ä»¥å‚è€ƒä¸‹é¢å†™ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œæ³¨å†Œè¿›springé‡Œå³å¯ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DynamicDatasourceClearInterceptor</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>HandlerInterceptor</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>preHandle</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>handler</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å…¥å£å¤„æ¸…ç©ºçœ‹ä¸ªäººï¼Œæœ‰çš„æ–°äººåœ¨å¼‚æ­¥é‡Œåˆ‡äº†æ•°æ®æºä½†æ˜¯å¿˜è®°æ¸…é™¤äº†ï¼Œä¸‹ä¸€ä¸ªè¯·æ±‚é‡åˆ°è¿™ä¸ªçº¿ç¨‹å°±ä¼šå¸¦è¿›æ¥ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// DynamicDataSourceContextHolder.clear();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>postHandle</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>handler</span><span class=p>,</span><span class=w> </span><span class=n>ModelAndView</span><span class=w> </span><span class=n>modelAndView</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>afterCompletion</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>handler</span><span class=p>,</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DynamicDataSourceContextHolder</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=æ‰‹åŠ¨æ³¨å…¥å¤šæ•°æ®æº>æ‰‹åŠ¨æ³¨å…¥å¤šæ•°æ®æº<a hidden class=anchor aria-hidden=true href=#æ‰‹åŠ¨æ³¨å…¥å¤šæ•°æ®æº>#</a></h2><p>ä»€ä¹ˆæ—¶å€™éœ€è¦æ‰‹åŠ¨æ³¨å…¥å¤šæ•°æ®æºï¼Ÿ</p><p>ç»å¤§éƒ¨åˆ†æ˜¯å› ä¸ºæ‚¨çš„ç³»ç»Ÿéœ€è¦å’Œå…¶ä»–æ•°æ®æºå…±åŒå­˜åœ¨ä½¿ç”¨ã€‚</p><p>å¦‚Quartzå’ŒShardingJdbcç­‰éƒ½éœ€è¦ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®æºã€‚</p><p>dynamic-datasource 3.4.0åŠä»¥ä¸Šç‰ˆæœ¬å’Œè€ç‰ˆæœ¬æ³¨å…¥æ–¹å¼æœ‰ä¸€å®šå·®åˆ«ï¼Œæ ¹æ®è‡ªå·±ç‰ˆæœ¬æ³¨å…¥ã€‚</p><p><code>æ³¨æ„ä¸€å®šè¦è®©å¤šæ•°æ®æºä½¿ç”¨ @Primary ï¼Œè®©å…¶æˆä¸ºä¸»æ•°æ®æºã€‚</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 3.4.0ç‰ˆæœ¬ä»¥ä¸‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Primary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=nf>dataSource</span><span class=p>(</span><span class=n>DynamicDataSourceProvider</span><span class=w> </span><span class=n>dynamicDataSourceProvider</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DynamicRoutingDataSource</span><span class=w> </span><span class=n>dataSource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DynamicRoutingDataSource</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dataSource</span><span class=p>.</span><span class=na>setPrimary</span><span class=p>(</span><span class=n>properties</span><span class=p>.</span><span class=na>getPrimary</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dataSource</span><span class=p>.</span><span class=na>setStrict</span><span class=p>(</span><span class=n>properties</span><span class=p>.</span><span class=na>getStrict</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dataSource</span><span class=p>.</span><span class=na>setStrategy</span><span class=p>(</span><span class=n>properties</span><span class=p>.</span><span class=na>getStrategy</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dataSource</span><span class=p>.</span><span class=na>setProvider</span><span class=p>(</span><span class=n>dynamicDataSourceProvider</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dataSource</span><span class=p>.</span><span class=na>setP6spy</span><span class=p>(</span><span class=n>properties</span><span class=p>.</span><span class=na>getP6spy</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dataSource</span><span class=p>.</span><span class=na>setSeata</span><span class=p>(</span><span class=n>properties</span><span class=p>.</span><span class=na>getSeata</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 3.4.0ç‰ˆæœ¬åŠä»¥ä¸Š</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Primary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=nf>dataSource</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DynamicRoutingDataSource</span><span class=w> </span><span class=n>dataSource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DynamicRoutingDataSource</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dataSource</span><span class=p>.</span><span class=na>setPrimary</span><span class=p>(</span><span class=n>properties</span><span class=p>.</span><span class=na>getPrimary</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dataSource</span><span class=p>.</span><span class=na>setStrict</span><span class=p>(</span><span class=n>properties</span><span class=p>.</span><span class=na>getStrict</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dataSource</span><span class=p>.</span><span class=na>setStrategy</span><span class=p>(</span><span class=n>properties</span><span class=p>.</span><span class=na>getStrategy</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dataSource</span><span class=p>.</span><span class=na>setP6spy</span><span class=p>(</span><span class=n>properties</span><span class=p>.</span><span class=na>getP6spy</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dataSource</span><span class=p>.</span><span class=na>setSeata</span><span class=p>(</span><span class=n>properties</span><span class=p>.</span><span class=na>getSeata</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>ä¸»è¦å˜æ›´æ˜¯å› ä¸º3.4.0æ”¯æŒäº†å¤šä¸ªprovideråŒæ—¶ç”Ÿæ•ˆï¼Œé‡‡å–äº†å†…éƒ¨æ³¨å…¥ï¼Œ<a href=https://github.com/baomidou/dynamic-datasource/commit/6e8d2954499f83269302d23b58f8832c31e07ef7>å…·ä½“æºç æ”¹åŠ¨</a>ã€‚</p><h1 id=è‡ªå®šä¹‰>è‡ªå®šä¹‰<a hidden class=anchor aria-hidden=true href=#è‡ªå®šä¹‰>#</a></h1><p><code>è‡ªå®šä¹‰æ³¨è§£</code>ï¼šä¸æ»¡è¶³äºé»˜è®¤DSæ³¨è§£ï¼Œå¸Œæœ›è‡ªå®šä¹‰æ³¨è§£ã€‚</p><p><code>è‡ªå®šä¹‰æ•°æ®æºæ¥æº</code>ï¼šé»˜è®¤çš„æ•°æ®æºæ¥æºæ˜¯åŸºäºymlæˆ–è€…propertiesé…ç½®æ¥çš„ï¼Œç»„ä»¶æ”¯æŒåŒæ—¶ä»å¤šä¸ªåœ°æ–¹æ¥åŠ è½½åˆå§‹åŒ–æ•°æ®æºã€‚å¸¸ç”¨äºå¤šç§Ÿæˆ·ç³»ç»Ÿï¼Œä»ä¸€ä¸ªç§Ÿæˆ·ä¿¡æ¯åº“å¤šåŠ è½½ä¸åŒç§Ÿæˆ·çš„æ•°æ®æºã€‚</p><p><code>è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥</code>ï¼šå¸¸ç”¨çš„æœ‰è½®è¯¢ï¼Œéšæœºã€‚æ”¯æŒæ‰©å±•ã€‚</p><p><code>è‡ªå®šä¹‰åˆ‡é¢</code>ï¼šæ”¯æŒä¸ä½¿ç”¨æ³¨è§£ï¼Œé€šè¿‡é…ç½®æ¥åˆ‡æ¢æ•°æ®æºã€‚å¦‚æŸä¸ªåŒ…ä¸‹æ‰€æœ‰serviceæ–¹æ³•ä»¥<code>select*</code>å¼€å¤´çš„éƒ½èµ°slaveåº“ï¼Œä»¥<code>add*</code>å¼€å¤´çš„éƒ½èµ°masteråº“ã€‚</p><h2 id=è‡ªå®šä¹‰æ³¨è§£>è‡ªå®šä¹‰æ³¨è§£<a hidden class=anchor aria-hidden=true href=#è‡ªå®šä¹‰æ³¨è§£>#</a></h2><h3 id=åŸºç¡€ä»‹ç»-7>åŸºç¡€ä»‹ç»<a hidden class=anchor aria-hidden=true href=#åŸºç¡€ä»‹ç»-7>#</a></h3><p>å¦‚æœä½ åªæœ‰å‡ ä¸ªç¡®å®šçš„åº“ï¼Œå¯ä»¥å°è¯•è‡ªå®šä¹‰æ³¨è§£æ›¿æ¢æ‰<code>@DS</code>ã€‚</p><p>å»ºè®®ä»3.2.1ç‰ˆæœ¬å¼€å§‹ä½¿ç”¨è‡ªå®šä¹‰æ³¨è§£ï¼Œå¦å¤–ç»„ä»¶è‡ªå¸¦äº†<code>@Master</code>å’Œ<code>@Slave</code>æ³¨è§£ã€‚</p><h3 id=ä½¿ç”¨æ–¹æ³•-1>ä½¿ç”¨æ–¹æ³•<a hidden class=anchor aria-hidden=true href=#ä½¿ç”¨æ–¹æ³•-1>#</a></h3><p>ä¸‹é¢æˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªäº§å“åº“çš„æ³¨è§£ï¼Œæ–¹ä¾¿æˆ‘ä»¬åé¢ç¨‹åºçš„ä½¿ç”¨ã€‚</p><p>1ã€éœ€è¦è‡ªå·±å®šä¹‰ä¸€ä¸ªæ³¨è§£å¹¶ç»§æ‰¿è‡ªDS</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>com.baomidou.dynamic.datasource.annotation.DS</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.annotation.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Target</span><span class=p>({</span><span class=n>ElementType</span><span class=p>.</span><span class=na>TYPE</span><span class=p>,</span><span class=w> </span><span class=n>ElementType</span><span class=p>.</span><span class=na>METHOD</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Retention</span><span class=p>(</span><span class=n>RetentionPolicy</span><span class=p>.</span><span class=na>RUNTIME</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Documented</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;product&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=nd>@interface</span><span class=w> </span><span class=n>Product</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>2ã€æ³¨è§£åœ¨éœ€è¦åˆ‡æ¢æ•°æ®æºçš„æ–¹æ³•ä¸Šæˆ–ç±»ä¸Š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Product</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ProductServiceImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>ProductService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Product</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=w> </span><span class=nf>selectAll</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w>  </span><span class=n>jdbcTemplate</span><span class=p>.</span><span class=na>queryForList</span><span class=p>(</span><span class=s>&#34;select * from products&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=è‡ªå®šä¹‰æ•°æ®æºæ¥æº>è‡ªå®šä¹‰æ•°æ®æºæ¥æº<a hidden class=anchor aria-hidden=true href=#è‡ªå®šä¹‰æ•°æ®æºæ¥æº>#</a></h2><h3 id=åŸºç¡€ä»‹ç»-8>åŸºç¡€ä»‹ç»<a hidden class=anchor aria-hidden=true href=#åŸºç¡€ä»‹ç»-8>#</a></h3><p>æ•°æ®æºæ¥æºçš„é»˜è®¤å®ç°æ˜¯<code>YmlDynamicDataSourceProvider</code>ï¼Œå…¶ä»yamlæˆ–propertiesä¸­è¯»å–ä¿¡æ¯å¹¶è§£æå‡ºæ‰€æœ‰æ•°æ®æºä¿¡æ¯ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>DynamicDataSourceProvider</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * åŠ è½½æ‰€æœ‰æ•°æ®æº
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @return æ‰€æœ‰æ•°æ®æºï¼Œkeyä¸ºæ•°æ®æºåç§°
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>DataSource</span><span class=o>&gt;</span><span class=w> </span><span class=nf>loadDataSources</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=è‡ªå®šä¹‰ç¤ºä¾‹>è‡ªå®šä¹‰ç¤ºä¾‹<a hidden class=anchor aria-hidden=true href=#è‡ªå®šä¹‰ç¤ºä¾‹>#</a></h3><p>å¯ä»¥å‚è€ƒ <code>AbstractJdbcDataSourceProvider</code> ï¼ˆä»…ä¾›å‚è€ƒï¼‰æ¥å®ç°ä»JDBCæ•°æ®åº“ä¸­è·å–æ•°æ®åº“è¿æ¥ä¿¡æ¯ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>DynamicDataSourceProvider</span><span class=w> </span><span class=nf>jdbcDynamicDataSourceProvider</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AbstractJdbcDataSourceProvider</span><span class=p>(</span><span class=s>&#34;com.mysql.cj.jdbc.Driver&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;jdbc:mysql://xx.xx.xx.xx:3306/dynamic&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;root&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;root&#34;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>protected</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>DataSourceProperty</span><span class=o>&gt;</span><span class=w> </span><span class=nf>executeStmt</span><span class=p>(</span><span class=n>Statement</span><span class=w> </span><span class=n>statement</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>SQLException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ResultSet</span><span class=w> </span><span class=n>rs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>statement</span><span class=p>.</span><span class=na>executeQuery</span><span class=p>(</span><span class=s>&#34;select * from DB&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>rs</span><span class=p>.</span><span class=na>next</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rs</span><span class=p>.</span><span class=na>getString</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rs</span><span class=p>.</span><span class=na>getString</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>password</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rs</span><span class=p>.</span><span class=na>getString</span><span class=p>(</span><span class=s>&#34;password&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>url</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rs</span><span class=p>.</span><span class=na>getString</span><span class=p>(</span><span class=s>&#34;url&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>driver</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rs</span><span class=p>.</span><span class=na>getString</span><span class=p>(</span><span class=s>&#34;driver&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>DataSourceProperty</span><span class=w> </span><span class=n>property</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataSourceProperty</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>property</span><span class=p>.</span><span class=na>setUsername</span><span class=p>(</span><span class=n>username</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>property</span><span class=p>.</span><span class=na>setPassword</span><span class=p>(</span><span class=n>password</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>property</span><span class=p>.</span><span class=na>setUrl</span><span class=p>(</span><span class=n>url</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>property</span><span class=p>.</span><span class=na>setDriverClassName</span><span class=p>(</span><span class=n>driver</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>property</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>map</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><blockquote><p>PS: ä»3.4.0å¼€å§‹ï¼Œå¯ä»¥æ³¨å…¥å¤šä¸ªDynamicDataSourceProviderçš„Beanä»¥å®ç°åŒæ—¶ä»å¤šä¸ªä¸åŒæ¥æºåŠ è½½æ•°æ®æºï¼Œæ³¨æ„åŒåä¼šè¢«è¦†ç›–ã€‚</p></blockquote><h2 id=è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥>è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥<a hidden class=anchor aria-hidden=true href=#è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥>#</a></h2><h3 id=åŸºç¡€ä»‹ç»-9>åŸºç¡€ä»‹ç»<a hidden class=anchor aria-hidden=true href=#åŸºç¡€ä»‹ç»-9>#</a></h3><p>å¦‚ä¸‹<code>slave</code>ç»„ä¸‹æœ‰ä¸‰ä¸ªæ•°æ®æºï¼Œå½“ç”¨æˆ·ä½¿ç”¨<code>slave</code>åˆ‡æ¢æ•°æ®æºæ—¶ä¼šä½¿ç”¨è´Ÿè½½å‡è¡¡ç®—æ³•ã€‚</p><p>ç³»ç»Ÿè‡ªå¸¦äº†ä¸¤ä¸ªè´Ÿè½½å‡è¡¡ç®—æ³•:</p><ul><li><code>LoadBalanceDynamicDataSourceStrategy</code> è½®è¯¢,æ˜¯é»˜è®¤çš„ã€‚</li><li><code>RandomDynamicDataSourceStrategy</code> éšæœºçš„ã€‚</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dynamic</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>master</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://xx.xx.xx.xx:3306/dynamic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>schema</span><span class=p>:</span><span class=w> </span><span class=l>db/schema.sql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>slave_1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://xx.xx.xx.xx:3307/dynamic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>slave_2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://xx.xx.xx.xx:3308/dynamic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>slave_3</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://xx.xx.xx.xx:3309/dynamic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>strategy</span><span class=p>:</span><span class=w> </span><span class=l>com.baomidou.dynamic.datasource.strategy.LoadBalanceDynamicDataSourceStrategy</span><span class=w>
</span></span></span></code></pre></div><h3 id=å¦‚ä½•è‡ªå®šä¹‰>å¦‚ä½•è‡ªå®šä¹‰<a hidden class=anchor aria-hidden=true href=#å¦‚ä½•è‡ªå®šä¹‰>#</a></h3><p>å¦‚æœé»˜è®¤çš„ä¸¤ä¸ªéƒ½ä¸èƒ½æ»¡è¶³è¦æ±‚ï¼Œå¯ä»¥å‚è€ƒæºç è‡ªå®šä¹‰ï¼Œæš‚æ—¶åªèƒ½å…¨å±€æ›´æ”¹ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.util.List</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.ThreadLocalRandom</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>javax.sql.DataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>RandomDynamicDataSourceStrategy</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>DynamicDataSourceStrategy</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>RandomDynamicDataSourceStrategy</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=nf>determineDataSource</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>DataSource</span><span class=o>&gt;</span><span class=w> </span><span class=n>dataSources</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>DataSource</span><span class=p>)</span><span class=n>dataSources</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>ThreadLocalRandom</span><span class=p>.</span><span class=na>current</span><span class=p>().</span><span class=na>nextInt</span><span class=p>(</span><span class=n>dataSources</span><span class=p>.</span><span class=na>size</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h1 id=æ— æ³¨è§£æ–¹æ¡ˆ>æ— æ³¨è§£æ–¹æ¡ˆ<a hidden class=anchor aria-hidden=true href=#æ— æ³¨è§£æ–¹æ¡ˆ>#</a></h1><p>ä¸ç®¡æ˜¯å‡ºäºæ³¨è§£ä¾µå…¥æ€§è¿˜æ˜¯ä»£ç æ•´æ´ç­‰ç†ç”±ï¼Œæˆ‘ä»¬éƒ½æœ‰éœ€æ±‚ä¸æƒ³ä½¿ç”¨æ³¨è§£çš„éœ€æ±‚ã€‚</p><p>ä½†æ˜¯éœ€è¦ç†è§£å¤šæ•°æ®æºå®ç°çš„æ ¸å¿ƒã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DynamicRoutingDataSource</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=nf>determineDataSource</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è¿™é‡Œæ˜¯æ ¸å¿ƒï¼Œæ˜¯ä»ThreadLocalä¸­è·å–å½“å‰æ•°æ®æºã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>dsKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DynamicDataSourceContextHolder</span><span class=p>.</span><span class=na>peek</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>getDataSource</span><span class=p>(</span><span class=n>dsKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>æ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥æ ¹æ®éœ€æ±‚ï¼Œé€‰æ‹©åˆé€‚çš„æ—¶æœºè°ƒç”¨<code>DynamicDataSourceContextHolder.push("å¯¹åº”æ•°æ®æº")</code>ã€‚</p><p>é»˜è®¤çš„<code>@DS</code>æ³¨è§£æ¥åˆ‡æ¢æ•°æ®æºæ˜¯æ ¹æ®spring AOPçš„ç‰¹æ€§ï¼Œåœ¨æ–¹æ³•å¼€å¯å‰è®¾ç½®æ•°æ®æºKEYï¼Œæ–¹æ³•æ‰§è¡Œå®Œæˆåç§»é™¤å¯¹åº”æ•°æ®æºKEYã€‚</p><h2 id=filteråˆ‡æ¢æ•°æ®æº>filteråˆ‡æ¢æ•°æ®æº<a hidden class=anchor aria-hidden=true href=#filteråˆ‡æ¢æ•°æ®æº>#</a></h2><p>ç›®æ ‡ï¼šæ‹¦æˆªä»¥filter/**å¼€å¤´çš„æ‰€æœ‰è¯·æ±‚ï¼Œå¦‚æœåé¢çš„æ–¹æ³•ä»¥aå¼€å¤´å°±åˆ‡æ¢åˆ°db1ï¼Œä»¥bå¼€å¤´å°±åˆ‡æ¢åˆ°db2ï¼Œå…¶ä½™ä½¿ç”¨é»˜è®¤æ•°æ®æºã€‚</p><p>å®ç°å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@WebFilter</span><span class=p>(</span><span class=n>filterName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;dsFilter&#34;</span><span class=p>,</span><span class=w> </span><span class=n>urlPatterns</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=s>&#34;/filter/*&#34;</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DynamicDatasourceFilter</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Filter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>init</span><span class=p>(</span><span class=n>FilterConfig</span><span class=w> </span><span class=n>filterConfig</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>ServletException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;loading filter {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>filterConfig</span><span class=p>.</span><span class=na>getFilterName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doFilter</span><span class=p>(</span><span class=n>ServletRequest</span><span class=w> </span><span class=n>servletRequest</span><span class=p>,</span><span class=w> </span><span class=n>ServletResponse</span><span class=w> </span><span class=n>servletResponse</span><span class=p>,</span><span class=w> </span><span class=n>FilterChain</span><span class=w> </span><span class=n>filterChain</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=p>,</span><span class=w> </span><span class=n>ServletException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=p>)</span><span class=w> </span><span class=n>servletRequest</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>HttpServletResponse</span><span class=p>)</span><span class=w> </span><span class=n>servletResponse</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>requestURI</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getRequestURI</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;ç»è¿‡å¤šæ•°æ®æºfilter,å½“å‰è·¯å¾„æ˜¯{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>requestURI</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        String headerDs = request.getHeader(&#34;ds&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        Object sessionDs = request.getSession().getAttribute(&#34;ds&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>requestURI</span><span class=p>.</span><span class=na>replaceFirst</span><span class=p>(</span><span class=s>&#34;/filter/&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>dsKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;master&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>s</span><span class=p>.</span><span class=na>startsWith</span><span class=p>(</span><span class=s>&#34;a&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>dsKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;db1&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>s</span><span class=p>.</span><span class=na>startsWith</span><span class=p>(</span><span class=s>&#34;b&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>dsKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;db2&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ‰§è¡Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>DynamicDataSourceContextHolder</span><span class=p>.</span><span class=na>push</span><span class=p>(</span><span class=n>dsKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>filterChain</span><span class=p>.</span><span class=na>doFilter</span><span class=p>(</span><span class=n>servletRequest</span><span class=p>,</span><span class=w> </span><span class=n>servletResponse</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>DynamicDataSourceContextHolder</span><span class=p>.</span><span class=na>poll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>destroy</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@SpringBootApplication</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@ServletComponentScan</span><span class=w> </span><span class=c1>// filterå¿…é¡»ä½¿ç”¨è¿™ä¸ª</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@MapperScan</span><span class=p>(</span><span class=s>&#34;com.baomidou.samples.ds.mapper&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AllDataSourceApplication</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SpringApplication</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>AllDataSourceApplication</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>args</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><blockquote><p>æ‰©å±•ï¼šä»requestä¸­è¿˜èƒ½è·å–åˆ°å¾ˆå¤šä¸œè¥¿ï¼Œå¦‚headerå’Œsessionï¼ŒåŒç†å¯ä»¥æ ¹æ®è‡ªå·±ä¸šåŠ¡éœ€æ±‚æ ¹æ®headerå€¼å’Œsessioné‡Œå¯¹åº”çš„ç”¨æˆ·æ¥åŠ¨æ€è®¾ç½®å’Œåˆ‡æ¢æ•°æ®æºã€‚</p></blockquote><h2 id=interceproråˆ‡æ¢æ•°æ®æº>interceproråˆ‡æ¢æ•°æ®æº<a hidden class=anchor aria-hidden=true href=#interceproråˆ‡æ¢æ•°æ®æº>#</a></h2><p>ç›®æ ‡ï¼šæ‹¦æˆªä»¥interceptor/**å¼€å¤´çš„æ‰€æœ‰è¯·æ±‚ï¼Œå¦‚æœåé¢çš„æ–¹æ³•ä»¥aå¼€å¤´å°±åˆ‡æ¢åˆ°db1ï¼Œä»¥bå¼€å¤´å°±åˆ‡æ¢åˆ°db2ï¼Œå…¶ä½™ä½¿ç”¨é»˜è®¤æ•°æ®æºã€‚</p><p>å®ç°å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>com.baomidou.dynamic.datasource.toolkit.DynamicDataSourceContextHolder</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.extern.slf4j.Slf4j</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.web.servlet.HandlerInterceptor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.web.servlet.ModelAndView</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>javax.servlet.http.HttpServletRequest</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>javax.servlet.http.HttpServletResponse</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DynamicDatasourceInterceptor</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>HandlerInterceptor</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * åœ¨è¯·æ±‚å¤„ç†ä¹‹å‰è¿›è¡Œè°ƒç”¨ï¼ˆControlleræ–¹æ³•è°ƒç”¨ä¹‹å‰ï¼‰
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>preHandle</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>handler</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>requestURI</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getRequestURI</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;ç»è¿‡å¤šæ•°æ®æºInterceptor,å½“å‰è·¯å¾„æ˜¯{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>requestURI</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        String headerDs = request.getHeader(&#34;ds&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        Object sessionDs = request.getSession().getAttribute(&#34;ds&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>requestURI</span><span class=p>.</span><span class=na>replaceFirst</span><span class=p>(</span><span class=s>&#34;/interceptor/&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>dsKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;master&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>s</span><span class=p>.</span><span class=na>startsWith</span><span class=p>(</span><span class=s>&#34;a&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>dsKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;db1&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>s</span><span class=p>.</span><span class=na>startsWith</span><span class=p>(</span><span class=s>&#34;b&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>dsKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;db2&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DynamicDataSourceContextHolder</span><span class=p>.</span><span class=na>push</span><span class=p>(</span><span class=n>dsKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è¯·æ±‚å¤„ç†ä¹‹åè¿›è¡Œè°ƒç”¨ï¼Œä½†æ˜¯åœ¨è§†å›¾è¢«æ¸²æŸ“ä¹‹å‰ï¼ˆControlleræ–¹æ³•è°ƒç”¨ä¹‹åï¼‰
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>postHandle</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>handler</span><span class=p>,</span><span class=w> </span><span class=n>ModelAndView</span><span class=w> </span><span class=n>modelAndView</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * åœ¨æ•´ä¸ªè¯·æ±‚ç»“æŸä¹‹åè¢«è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯åœ¨DispatcherServletæ¸²æŸ“äº†å¯¹åº”çš„è§†å›¾ä¹‹åæ‰§è¡Œï¼ˆä¸»è¦æ˜¯ç”¨äºè¿›è¡Œèµ„æºæ¸…ç†å·¥ä½œï¼‰
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>afterCompletion</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>handler</span><span class=p>,</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DynamicDataSourceContextHolder</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.context.annotation.Configuration</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.web.servlet.config.annotation.InterceptorRegistry</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.web.servlet.config.annotation.WebMvcConfigurer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MyWebAutoConfig</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>WebMvcConfigurer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>addInterceptors</span><span class=p>(</span><span class=n>InterceptorRegistry</span><span class=w> </span><span class=n>registry</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>registry</span><span class=p>.</span><span class=na>addInterceptor</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>DynamicDatasourceInterceptor</span><span class=p>()).</span><span class=na>addPathPatterns</span><span class=p>(</span><span class=s>&#34;/interceptor/**&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=è‡ªå®šä¹‰åˆ‡é¢>è‡ªå®šä¹‰åˆ‡é¢<a hidden class=anchor aria-hidden=true href=#è‡ªå®šä¹‰åˆ‡é¢>#</a></h2><p>ä»3.4.0å¼€å§‹æ”¯æŒè‡ªå®šä¹‰åˆ‡é¢ã€‚</p><ol><li>ä½¿ç”¨è¿™ä¸ªæ–¹å¼ï¼ŒåŸæ³¨è§£æ–¹å¼å¹¶ä¸ä¼šå¤±æ•ˆã€‚</li><li>æ³¨æ„ï¼šä¸è¦åœ¨åŒä¸€ä¸ªåˆ‡é¢åŒæ—¶ä½¿ç”¨æ³¨è§£åˆä½¿ç”¨è‡ªå®šä¹‰åˆ‡é¢ã€‚</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MyConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>DynamicDatasourceNamedInterceptor</span><span class=w> </span><span class=nf>dsAdvice</span><span class=p>(</span><span class=n>DsProcessor</span><span class=w> </span><span class=n>dsProcessor</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DynamicDatasourceNamedInterceptor</span><span class=w> </span><span class=n>interceptor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DynamicDatasourceNamedInterceptor</span><span class=p>(</span><span class=n>dsProcessor</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>patternMap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>patternMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;select*&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;slave&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>patternMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;add*&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;master&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>patternMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;update*&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;master&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>patternMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;delete*&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;master&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>interceptor</span><span class=p>.</span><span class=na>addPatternMap</span><span class=p>(</span><span class=n>patternMap</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>interceptor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Advisor</span><span class=w> </span><span class=nf>dsAdviceAdvisor</span><span class=p>(</span><span class=n>DynamicDatasourceNamedInterceptor</span><span class=w> </span><span class=n>dsAdvice</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AspectJExpressionPointcut</span><span class=w> </span><span class=n>pointcut</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AspectJExpressionPointcut</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>pointcut</span><span class=p>.</span><span class=na>setExpression</span><span class=p>(</span><span class=s>&#34;execution (* com.baomidou.samples.pattern..service.*.*(..))&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DefaultPointcutAdvisor</span><span class=p>(</span><span class=n>pointcut</span><span class=p>,</span><span class=w> </span><span class=n>dsAdvice</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>ä»¥ä¸Šå®ç°com.baomidou.samples.patternåŒ…serviceä¸‹æ‰€æœ‰ç±»çš„add/update/deleteå¼€å¤´çš„æ–¹æ³•ä½¿ç”¨masteræ•°æ®æºï¼Œselectä½¿ç”¨slaveæ•°æ®æºã€‚</p><p>æ›´å¤æ‚çš„åˆ‡ç‚¹è¡¨è¾¾å¼è¯­æ³•éœ€è‡ªè¡Œå­¦ä¹ ã€‚</p><h2 id=mybatisä¸‹è¯»å†™åˆ†ç¦»>mybatisä¸‹è¯»å†™åˆ†ç¦»<a hidden class=anchor aria-hidden=true href=#mybatisä¸‹è¯»å†™åˆ†ç¦»>#</a></h2><p>åœºæ™¯ï¼š</p><ol><li>åœ¨çº¯çš„è¯»å†™åˆ†ç¦»ç¯å¢ƒï¼Œå†™æ“ä½œå…¨éƒ¨æ˜¯masterï¼Œè¯»æ“ä½œå…¨éƒ¨æ˜¯slaveã€‚</li><li>ä¸æƒ³é€šè¿‡æ³¨è§£é…ç½®å®Œæˆä»¥ä¸ŠåŠŸèƒ½ã€‚</li></ol><p>ç­”ï¼šåœ¨mybatisç¯å¢ƒä¸‹å¯ä»¥åŸºäºmybatisæ’ä»¶ç»“åˆdynamic-datasourceå®Œæˆä»¥ä¸ŠåŠŸèƒ½ã€‚</p><p>æ‰‹åŠ¨æ³¨å…¥æ’ä»¶ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>MasterSlaveAutoRoutingPlugin</span><span class=w> </span><span class=nf>masterSlaveAutoRoutingPlugin</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MasterSlaveAutoRoutingPlugin</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>é»˜è®¤ä¸»åº“åç§°masterï¼Œä»åº“åç§°slaveã€‚</p><p>æš‚ä¸æ”¯æŒæ›´å¤šï¼Œæºç ç®€å•å¯å‚è€ƒé‡å†™ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Intercepts</span><span class=p>({</span><span class=nd>@Signature</span><span class=p>(</span><span class=n>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executor</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;query&#34;</span><span class=p>,</span><span class=w> </span><span class=n>args</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=n>MappedStatement</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>RowBounds</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>ResultHandler</span><span class=p>.</span><span class=na>class</span><span class=p>}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Signature</span><span class=p>(</span><span class=n>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executor</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;update&#34;</span><span class=p>,</span><span class=w> </span><span class=n>args</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=n>MappedStatement</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=p>.</span><span class=na>class</span><span class=p>})})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MasterSlaveAutoRoutingPlugin</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Interceptor</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>MASTER</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;master&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>SLAVE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;slave&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>intercept</span><span class=p>(</span><span class=n>Invocation</span><span class=w> </span><span class=n>invocation</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>invocation</span><span class=p>.</span><span class=na>getArgs</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>MappedStatement</span><span class=w> </span><span class=n>ms</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>MappedStatement</span><span class=p>)</span><span class=w> </span><span class=n>args</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>DynamicDataSourceContextHolder</span><span class=p>.</span><span class=na>push</span><span class=p>(</span><span class=n>SqlCommandType</span><span class=p>.</span><span class=na>SELECT</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>ms</span><span class=p>.</span><span class=na>getSqlCommandType</span><span class=p>()</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>SLAVE</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>MASTER</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>invocation</span><span class=p>.</span><span class=na>proceed</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>DynamicDataSourceContextHolder</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>plugin</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>target</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>target</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>Executor</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>Plugin</span><span class=p>.</span><span class=na>wrap</span><span class=p>(</span><span class=n>target</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>target</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setProperties</span><span class=p>(</span><span class=n>Properties</span><span class=w> </span><span class=n>properties</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h1 id=äº‹åŠ¡ä¸“æ >äº‹åŠ¡ä¸“æ <a hidden class=anchor aria-hidden=true href=#äº‹åŠ¡ä¸“æ >#</a></h1><p>ä½¿ç”¨å¤šæ•°æ®æºçš„ä½ ä¸€å®šä¼šé‡åˆ°äº‹åŠ¡é—®é¢˜ï¼š</p><ol><li>ä¸ºä»€ä¹ˆä½¿ç”¨äº†äº‹åŠ¡å°±åˆ‡æ¢ä¸äº†æ•°æ®æºäº†å•Šï¼Ÿ</li><li>æœ‰æ²¡æœ‰ä»€ä¹ˆè§£å†³æ–¹æ¡ˆå•Šï¼Ÿ</li><li>æœ‰æ²¡æœ‰ä½¿ç”¨æ¡ˆä¾‹å’Œæ³¨æ„äº‹é¡¹å•Šã€‚</li></ol><p>ä»¥ä¸Šé—®é¢˜éƒ½èƒ½åœ¨æœ¬ç« èŠ‚å¾—åˆ°è§£ç­”ã€‚</p><p>æ–¹æ¡ˆä¸€ï¼šdynamic-datasourceé›†æˆäº†alibabaåˆ†å¸ƒå¼äº‹åŠ¡ç»„ä»¶seataã€‚</p><p>æ–¹æ¡ˆäºŒï¼šdynamic-datasourceæä¾›äº†æ— éœ€å¤–éƒ¨ç»„ä»¶çš„æœ¬åœ°å¤šæ•°æ®æºäº‹åŠ¡ã€‚</p><p>å„æœ‰å„çš„ä¼˜åŠ£ï¼Œæ€»æœ‰ä¸€æ¬¾é€‚åˆä½ ã€‚</p><h2 id=äº‹åŠ¡æ¦‚å¿µ>äº‹åŠ¡æ¦‚å¿µ<a hidden class=anchor aria-hidden=true href=#äº‹åŠ¡æ¦‚å¿µ>#</a></h2><h3 id=ä»€ä¹ˆæ˜¯äº‹åŠ¡>ä»€ä¹ˆæ˜¯äº‹åŠ¡ï¼Ÿ<a hidden class=anchor aria-hidden=true href=#ä»€ä¹ˆæ˜¯äº‹åŠ¡>#</a></h3><p><code>äº‹åŠ¡</code>ï¼šæ˜¯æ•°æ®åº“æ“ä½œçš„æœ€å°å·¥ä½œå•å…ƒï¼Œæ˜¯ä½œä¸ºå•ä¸ªé€»è¾‘å·¥ä½œå•å…ƒæ‰§è¡Œçš„ä¸€ç³»åˆ—æ“ä½œï¼›è¿™äº›æ“ä½œä½œä¸ºä¸€ä¸ªæ•´ä½“ä¸€èµ·å‘ç³»ç»Ÿæäº¤ï¼Œè¦ä¹ˆéƒ½æ‰§è¡Œã€è¦ä¹ˆéƒ½ä¸æ‰§è¡Œï¼›äº‹åŠ¡æ˜¯ä¸€ç»„ä¸å¯å†åˆ†å‰²çš„æ“ä½œé›†åˆï¼ˆå·¥ä½œé€»è¾‘å•å…ƒï¼‰ã€‚</p><p><strong>äº‹åŠ¡çš„å››å¤§ç‰¹æ€§ï¼š</strong></p><ul><li>åŸå­æ€§</li></ul><p>äº‹åŠ¡æ˜¯æ•°æ®åº“çš„é€»è¾‘å·¥ä½œå•ä½ï¼Œäº‹åŠ¡ä¸­åŒ…å«çš„å„æ“ä½œè¦ä¹ˆéƒ½åšï¼Œè¦ä¹ˆéƒ½ä¸åš ã€‚</p><ul><li>ä¸€è‡´æ€§</li></ul><p>äº‹åŠ¡æ‰§è¡Œçš„ç»“æœå¿…é¡»æ˜¯ä½¿æ•°æ®åº“ä»ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€å˜åˆ°å¦ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€ã€‚å› æ­¤å½“æ•°æ®åº“åªåŒ…å«æˆåŠŸäº‹åŠ¡æäº¤çš„ç»“æœæ—¶ï¼Œå°±è¯´æ•°æ®åº“å¤„äºä¸€è‡´æ€§çŠ¶æ€ã€‚å¦‚æœæ•°æ®åº“ç³»ç»Ÿ è¿è¡Œä¸­å‘ç”Ÿæ•…éšœï¼Œæœ‰äº›äº‹åŠ¡å°šæœªå®Œæˆå°±è¢«è¿«ä¸­æ–­ï¼Œè¿™äº›æœªå®Œæˆäº‹åŠ¡å¯¹æ•°æ®åº“æ‰€åšçš„ä¿®æ”¹æœ‰ä¸€éƒ¨åˆ†å·²å†™å…¥ç‰©ç†æ•°æ®åº“ï¼Œè¿™æ—¶æ•°æ®åº“å°±å¤„äºä¸€ç§ä¸æ­£ç¡®çš„çŠ¶æ€ï¼Œæˆ–è€…è¯´æ˜¯ ä¸ä¸€è‡´çš„çŠ¶æ€ã€‚</p><ul><li>éš”ç¦»æ€§</li></ul><p>ä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œä¸èƒ½å…¶å®ƒäº‹åŠ¡å¹²æ‰°ã€‚å³ä¸€ä¸ªäº‹åŠ¡å†…éƒ¨çš„æ“ä½œåŠä½¿ç”¨çš„æ•°æ®å¯¹å…¶å®ƒå¹¶å‘äº‹åŠ¡æ˜¯éš”ç¦»çš„ï¼Œå¹¶å‘æ‰§è¡Œçš„å„ä¸ªäº‹åŠ¡ä¹‹é—´ä¸èƒ½äº’ç›¸å¹²æ‰°ã€‚</p><ul><li>æŒç»­æ€§</li></ul><p>ä¹Ÿç§°æ°¸ä¹…æ€§ï¼ŒæŒ‡ä¸€ä¸ªäº‹åŠ¡ä¸€æ—¦æäº¤ï¼Œå®ƒå¯¹æ•°æ®åº“ä¸­çš„æ•°æ®çš„æ”¹å˜å°±åº”è¯¥æ˜¯æ°¸ä¹…æ€§çš„ã€‚æ¥ä¸‹æ¥çš„å…¶å®ƒæ“ä½œæˆ–æ•…éšœä¸åº”è¯¥å¯¹å…¶æ‰§è¡Œç»“æœæœ‰ä»»ä½•å½±å“ã€‚</p><h3 id=åŸç”Ÿjdbcå¤„ç†äº‹åŠ¡>åŸç”ŸJDBCå¤„ç†äº‹åŠ¡<a hidden class=anchor aria-hidden=true href=#åŸç”Ÿjdbcå¤„ç†äº‹åŠ¡>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>connection</span><span class=p>.</span><span class=na>setAutoCommit</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è¿™é‡Œç”¨connectionå¯¹æ•°æ®åº“åšäº†ä¸€ç³»åˆ—æ“ä½œï¼ŒCRUD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>connection</span><span class=p>.</span><span class=na>commit</span><span class=p>();</span><span class=w> </span><span class=c1>// æ²¡æœ‰å¼‚å¸¸å°±æäº¤</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>ex</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>connection</span><span class=p>.</span><span class=na>rollback</span><span class=p>();</span><span class=w>  </span><span class=c1>// å¼‚å¸¸å›æ»š</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>connection</span><span class=p>.</span><span class=na>setAutoCommit</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>ä»¥ä¸Šæ˜¯äº‹åŠ¡çš„æ ¸å¿ƒï¼Œæ‰€æœ‰æ“ä½œè¦ä¸€èµ·æˆåŠŸï¼Œåªè¦å‡ºé”™å°±å›æ»šã€‚</p><h3 id=springå¤„ç†äº‹åŠ¡>Springå¤„ç†äº‹åŠ¡<a hidden class=anchor aria-hidden=true href=#springå¤„ç†äº‹åŠ¡>#</a></h3><p>springå¼€å¯äº‹åŠ¡å¾ˆç®€å•ï¼Œåœ¨éœ€è¦äº‹åŠ¡çš„æ–¹æ³•å’Œç±»ä¸Šæ·»åŠ <code>@Transactional</code>æ³¨è§£ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Transactional</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>Aservice</span><span class=p>.</span><span class=na>dosometing</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>Bservice</span><span class=p>.</span><span class=na>dosometing</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>ä½¿ç”¨äº†<code>@Transactional</code>ï¼Œ<code>springä¼šä¿è¯æ•´ä¸ªäº‹åŠ¡ä¸‹éƒ½å¤ç”¨åŒä¸€ä¸ªconnection</code>ã€‚</p><p>åœ¨é»˜è®¤é…ç½®ä¸‹ï¼Œåªè¦äº‹åŠ¡ä¸­å‘ç”Ÿ<code>RuntimeException</code>ï¼Œå°±ä¼šå›æ»šã€‚</p><h2 id=åŸºç¡€çŸ¥è¯†>åŸºç¡€çŸ¥è¯†<a hidden class=anchor aria-hidden=true href=#åŸºç¡€çŸ¥è¯†>#</a></h2><p>é—®ï¼šä½¿ç”¨äº†äº‹åŠ¡å¦‚@Transationalæ— æ³•åˆ‡æ¢æ•°æ®æºï¼Ÿ</p><p>ç­”ï¼š æ˜¯çš„ï¼Œæœ¬ç»„ä»¶æ˜¯åŸºäºspringAopçš„æ–¹æ¡ˆæ¥è¿›è¡Œå¤šæ•°æ®æºçš„ç®¡ç†å’Œåˆ‡æ¢çš„ï¼Œè¦æƒ³ä¿è¯å¤šä¸ªåº“çš„æ•´ä½“äº‹åŠ¡åˆ™éœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡ã€‚</p><p>é—®ï¼šä¸ºä»€ä¹ˆä½¿ç”¨äº†äº‹åŠ¡å¦‚@Transationalå°±æ— æ³•åˆ‡æ¢æ•°æ®æºï¼Ÿ</p><p>ç­”ï¼šå¼€å¯äº†äº‹åŠ¡åï¼Œspringäº‹åŠ¡ç®¡ç†å™¨ä¼šä¿è¯åœ¨äº‹åŠ¡ä¸‹æ•´ä¸ªçº¿ç¨‹åç»­æ‹¿åˆ°çš„éƒ½æ˜¯åŒä¸€ä¸ªconnectionã€‚</p><p>é—®ï¼šäº‹åŠ¡ä¸‹æ— æ³•åˆ‡æ¢æ•°æ®æºæˆ‘çŸ¥é“äº†ï¼Œé‚£æˆ‘å•åº“çš„äº‹åŠ¡çš„å¯ä»¥ç”¨å—ï¼Ÿ</p><p>ç­”ï¼šå®Œå…¨å¯ä»¥çš„ã€‚åªè¦äº‹åŠ¡ä¸‹ä¸åˆ‡æ¢æ•°æ®æºå°±OKã€‚</p><p>é—®ï¼šæˆ‘çš„ä¸šåŠ¡å¿…é¡»è¦ä¿è¯äº‹åŠ¡ï¼Œè¿˜æœ‰ä»€ä¹ˆè§£å†³åŠæ³•ï¼Ÿ</p><p>æ–¹æ¡ˆä¸€ï¼šseataå°±æ˜¯è§£å†³æ­¤é—®é¢˜ï¼Œæœ¬ç»„ä»¶å·²å®Œæˆå’Œseataçš„è‡ªåŠ¨é›†æˆã€‚</p><p>æ–¹æ¡ˆäºŒï¼šæœ¬ç»„ä»¶ä»3.3.0å¼€å§‹æ”¯æŒæœ¬åœ°å¤šæ•°æ®æºäº‹åŠ¡ï¼Œæ— éœ€ç¬¬ä¸‰æ–¹ã€‚</p><h2 id=æœ¬åœ°äº‹åŠ¡>æœ¬åœ°äº‹åŠ¡<a hidden class=anchor aria-hidden=true href=#æœ¬åœ°äº‹åŠ¡>#</a></h2><h3 id=èƒŒæ™¯>èƒŒæ™¯<a hidden class=anchor aria-hidden=true href=#èƒŒæ™¯>#</a></h3><p>å¤šæ•°æ®æºäº‹åŠ¡æ–¹æ¡ˆä¸€ç›´æ˜¯ä¸€ä¸ªéš¾é¢˜ï¼Œé€šå¸¸çš„è§£å†³æ–¹æ¡ˆæœ‰ä»¥ä¸‹äºŒç§ã€‚</p><ol><li><p>åˆ©ç”¨atomiksæ‰‹åŠ¨æ„å»ºå¤šæ•°æ®æºäº‹åŠ¡ï¼Œé€‚åˆæ•°æ®æºè¾ƒå°‘ï¼Œé…ç½®çš„å‚æ•°ä¹Ÿä¸å¤ªå¤š,æ€§èƒ½è¦æ±‚ä¸é«˜çš„é¡¹ç›®ã€‚éš¾ç‚¹å°±æ˜¯æ‰‹åŠ¨é…ç½®é‡å¤§ï¼Œéœ€è¦è€—è´¹ä¸€å®šæ—¶é—´ã€‚</p></li><li><p>ç”¨seataç±»ä¼¼çš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œéš¾ç‚¹å°±æ˜¯éœ€è¦æ­å»ºç»´æŠ¤å¦‚seata-serverçš„ç»Ÿä¸€ç®¡ç†ä¸­å¿ƒã€‚
æ¯ä¸€ç§æ–¹æ¡ˆéƒ½æœ‰å…¶é€‚ç”¨åœºæ™¯ã€‚ä½ å¯èƒ½é‡åˆ°æœ€å¤šçš„é—®é¢˜å°±æ˜¯ï¼š</p></li><li><p>ä¸ºä»€ä¹ˆæˆ‘åŠ äº†äº‹åŠ¡æ³¨è§£ï¼Œåˆ‡æ¢æ•°æ®æºå¤±è´¥ï¼Ÿ</p></li><li><p>æˆ‘äº†è§£æ¶‰åŠäº†åˆ†å¸ƒå¼äº‹åŠ¡äº†ï¼Œä½†æˆ‘ä¸æƒ³ç”¨seataï¼Œæˆ‘åœºæ™¯ç®€å•ï¼Œæœ‰æ²¡æœ‰ä¸ä¾èµ–ç¬¬ä¸‰æ–¹çš„æ–¹æ¡ˆï¼Ÿ</p></li></ol><h3 id=åŸºç¡€ä»‹ç»-10>åŸºç¡€ä»‹ç»<a hidden class=anchor aria-hidden=true href=#åŸºç¡€ä»‹ç»-10>#</a></h3><p>è‡ªä»3.3.0å¼€å§‹ï¼Œç”±seataçš„æ ¸å¿ƒè´¡çŒ®è€… <a href=https://github.com/a364176773>https://github.com/a364176773</a> è´¡çŒ®äº†åŸºäºconnectionä»£ç†çš„æ–¹æ¡ˆã€‚</p><p>å»ºè®®ä»3.4.0ç‰ˆæœ¬å¼€å§‹ä½¿ç”¨ï¼Œå…¶ä¿®å¤äº†ä¸€ä¸ªåŠŸèƒ½ï¼Œè€ç‰ˆæœ¬ä¸åŠ <code>@DS</code>åªåŠ <code>@DSTransactional</code>ä¼šæŠ¥é”™ã€‚</p><h3 id=æ³¨æ„äº‹é¡¹-1>æ³¨æ„äº‹é¡¹<a hidden class=anchor aria-hidden=true href=#æ³¨æ„äº‹é¡¹-1>#</a></h3><p>æœ¬åœ°äº‹åŠ¡å®ç°å¾ˆç®€å•ï¼Œå°±æ˜¯å¾ªç¯æäº¤ï¼Œå‘ç”Ÿé”™è¯¯ï¼Œå¾ªç¯å›æ»šã€‚</p><p>æˆ‘ä»¬é»˜è®¤çš„å‰ææ˜¯æ•°æ®åº“æœ¬èº«ä¸ä¼šå¼‚å¸¸ï¼Œæ¯”å¦‚å®•æœºã€‚</p><p>å¦‚æ•°æ®åœ¨å›æ»šçš„è¿‡ç¨‹çªç„¶å®•æœºï¼Œæœ¬åœ°äº‹åŠ¡å°±ä¼šæœ‰é—®é¢˜ã€‚å¦‚æœä½ éœ€è¦å®Œæ•´åˆ†å¸ƒå¼æ–¹æ¡ˆè¯·ä½¿ç”¨seataæ–¹æ¡ˆã€‚</p><ol><li>ä¸æ”¯æŒspringåŸç”Ÿäº‹åŠ¡ï¼Œä¸æ”¯æŒspringäº‹åŠ¡ï¼Œä¸æ”¯æŒspringäº‹åŠ¡ï¼Œå¯åˆ†åˆ«ä½¿ç”¨ï¼Œ<code>åƒä¸‡ä¸èƒ½æ··ç”¨</code>ã€‚</li><li>å†æ¬¡å¼ºè°ƒä¸æ”¯æŒspringäº‹åŠ¡æ³¨è§£ï¼Œå¯ç†è§£æˆç‹¬ç«‹å†™äº†ä¸€å¥—äº‹åŠ¡æ–¹æ¡ˆã€‚</li><li>åªé€‚åˆç®€å•æœ¬åœ°å¤šæ•°æ®æºåœºæ™¯ï¼Œ å¦‚æœæ¶‰åŠå¼‚æ­¥å’Œå¾®æœåŠ¡ç­‰å®Œæ•´äº‹åŠ¡åœºæ™¯ï¼Œè¯·ä½¿ç”¨seataæ–¹æ¡ˆã€‚</li><li>æš‚æ—¶ä¸æ”¯æŒæ›´å¤šé…ç½®ï¼Œå¦‚åªè¯»ï¼Œå¦‚springçš„ä¼ æ’­ç‰¹æ€§ã€‚ åç»­ä¼šæ ¹æ®åé¦ˆè€ƒè™‘æ”¯æŒã€‚</li></ol><h3 id=ä½¿ç”¨æ–¹æ³•-2>ä½¿ç”¨æ–¹æ³•<a hidden class=anchor aria-hidden=true href=#ä½¿ç”¨æ–¹æ³•-2>#</a></h3><p>åœ¨æœ€å¤–å±‚çš„æ–¹æ³•æ·»åŠ  <code>@DSTransactional</code>ï¼Œåº•ä¸‹è°ƒç”¨çš„å„ä¸ªç±»è¯¥åˆ‡æ•°æ®æºå°±æ­£å¸¸ä½¿ç”¨<code>DS</code>åˆ‡æ¢æ•°æ®æºå³å¯ï¼Œå°±æ˜¯è¿™ä¹ˆç®€å•ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// å¦‚AServiceè°ƒç”¨BServiceå’ŒCServiceçš„æ–¹æ³•ï¼ŒA,B,Cåˆ†åˆ«å¯¹åº”ä¸åŒæ•°æ®æºã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;a&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>// å¦‚æœaæ˜¯é»˜è®¤æ•°æ®æºåˆ™ä¸éœ€è¦DSæ³¨è§£ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DSTransactional</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>dosomething</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BService</span><span class=p>.</span><span class=na>dosomething</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CService</span><span class=p>.</span><span class=na>dosomething</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>BService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;b&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>dosomething</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// dosomething</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;c&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>dosomething</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// dosomething</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>åªè¦<code>@DSTransactional</code>æ³¨è§£ä¸‹ä»»ä¸€ç¯èŠ‚å‘ç”Ÿå¼‚å¸¸ï¼Œåˆ™å…¨å±€å¤šæ•°æ®æºäº‹åŠ¡å›æ»šã€‚</p><p>å¦‚æœBCä¸Šä¹Ÿæœ‰<code>@DSTransactional</code>ä¼šæœ‰å½±å“å—ï¼Ÿç­”ï¼šæ²¡æœ‰å½±å“çš„ã€‚</p><h3 id=ç¤ºä¾‹é¡¹ç›®-3>ç¤ºä¾‹é¡¹ç›®<a hidden class=anchor aria-hidden=true href=#ç¤ºä¾‹é¡¹ç›®-3>#</a></h3><p><a href=https://github.com/dynamic-datasource/dynamic-datasource-samples/tree/master/tx-samples/tx-local-sample>ç‚¹æˆ‘è·³è½¬</a></p><p>å®Œæ•´ç¤ºä¾‹é¡¹ç›®ï¼Œæ•°æ®åº“éƒ½å·²å‡†å¤‡å¥½ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œæµ‹è¯•ã€‚</p><p>ç¤ºä¾‹é¡¹ç›®A,B,Cåˆ†åˆ«å¯¹åº”OrderService,ProductServiceï¼ŒAccountServiceï¼Œåˆ†åˆ«æ˜¯ç‹¬ç«‹çš„æ•°æ®åº“ã€‚</p><p>ç”¨æˆ·ä¸‹å•åˆ†åˆ«è°ƒç”¨äº§å“åº“æ‰£åº“å­˜ï¼Œè´¦æˆ·åº“æ‰£ä½™é¢ã€‚</p><p>å¦‚æœåº“å­˜ä¸è¶³ï¼Œæˆ–ç”¨æˆ·ä½™é¢ä¸è¶³éƒ½æŠ›å‡ºRuntimeExceptionï¼Œè§¦å‘æ•´ä½“å›æ»šã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@AllArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>OrderService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>OrderMapper</span><span class=w> </span><span class=n>orderMapper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>AccountService</span><span class=w> </span><span class=n>accountService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ProductService</span><span class=w> </span><span class=n>productService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// @DS(&#34;order&#34;) è¿™é‡Œä¸éœ€è¦ï¼Œå› ä¸ºorderæ˜¯é»˜è®¤åº“ï¼Œå¦‚æœå¼€å¯äº‹åŠ¡çš„ä¸æ˜¯é»˜è®¤åº“åˆ™å¿…é¡»åŠ </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DSTransactional</span><span class=w> </span><span class=c1>// æ³¨æ„è¿™é‡Œå¼€å¯äº‹åŠ¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>placeOrder</span><span class=p>(</span><span class=n>PlaceOrderRequest</span><span class=w> </span><span class=n>request</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;=============ORDER START=================&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getUserId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Long</span><span class=w> </span><span class=n>productId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getProductId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Integer</span><span class=w> </span><span class=n>amount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getAmount</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;æ”¶åˆ°ä¸‹å•è¯·æ±‚,ç”¨æˆ·:{}, å•†å“:{},æ•°é‡:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>productId</span><span class=p>,</span><span class=w> </span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;å½“å‰ XID: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>TransactionContext</span><span class=p>.</span><span class=na>getXID</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Order</span><span class=w> </span><span class=n>order</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Order</span><span class=p>.</span><span class=na>builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>userId</span><span class=p>(</span><span class=n>userId</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>productId</span><span class=p>(</span><span class=n>productId</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>status</span><span class=p>(</span><span class=n>OrderStatus</span><span class=p>.</span><span class=na>INIT</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>amount</span><span class=p>(</span><span class=n>amount</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>insert</span><span class=p>(</span><span class=n>order</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;è®¢å•ä¸€é˜¶æ®µç”Ÿæˆï¼Œç­‰å¾…æ‰£åº“å­˜ä»˜æ¬¾ä¸­&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ‰£å‡åº“å­˜å¹¶è®¡ç®—æ€»ä»·</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Double</span><span class=w> </span><span class=n>totalPrice</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>productService</span><span class=p>.</span><span class=na>reduceStock</span><span class=p>(</span><span class=n>productId</span><span class=p>,</span><span class=w> </span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ‰£å‡ä½™é¢</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>accountService</span><span class=p>.</span><span class=na>reduceBalance</span><span class=p>(</span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>totalPrice</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>order</span><span class=p>.</span><span class=na>setStatus</span><span class=p>(</span><span class=n>OrderStatus</span><span class=p>.</span><span class=na>SUCCESS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>order</span><span class=p>.</span><span class=na>setTotalPrice</span><span class=p>(</span><span class=n>totalPrice</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>updateById</span><span class=p>(</span><span class=n>order</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;è®¢å•å·²æˆåŠŸä¸‹å•&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;=============ORDER END=================&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RequiredArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ProductService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ProductMapper</span><span class=w> </span><span class=n>productMapper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;product&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Double</span><span class=w> </span><span class=nf>reduceStock</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>productId</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;=============PRODUCT START=================&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;å½“å‰ XID: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>TransactionContext</span><span class=p>.</span><span class=na>getXID</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ£€æŸ¥åº“å­˜</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Product</span><span class=w> </span><span class=n>product</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>productMapper</span><span class=p>.</span><span class=na>selectById</span><span class=p>(</span><span class=n>productId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Assert</span><span class=p>.</span><span class=na>notNull</span><span class=p>(</span><span class=n>product</span><span class=p>,</span><span class=w> </span><span class=s>&#34;å•†å“ä¸å­˜åœ¨&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Integer</span><span class=w> </span><span class=n>stock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>product</span><span class=p>.</span><span class=na>getStock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;å•†å“ç¼–å·ä¸º {} çš„åº“å­˜ä¸º{},è®¢å•å•†å“æ•°é‡ä¸º{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>productId</span><span class=p>,</span><span class=w> </span><span class=n>stock</span><span class=p>,</span><span class=w> </span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>stock</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&#34;å•†å“ç¼–å·ä¸º{} åº“å­˜ä¸è¶³ï¼Œå½“å‰åº“å­˜:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>productId</span><span class=p>,</span><span class=w> </span><span class=n>stock</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=s>&#34;åº“å­˜ä¸è¶³&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;å¼€å§‹æ‰£å‡å•†å“ç¼–å·ä¸º {} åº“å­˜,å•ä»·å•†å“ä»·æ ¼ä¸º{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>productId</span><span class=p>,</span><span class=w> </span><span class=n>product</span><span class=p>.</span><span class=na>getPrice</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ‰£å‡åº“å­˜</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>currentStock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>stock</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>amount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>product</span><span class=p>.</span><span class=na>setStock</span><span class=p>(</span><span class=n>currentStock</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>productMapper</span><span class=p>.</span><span class=na>updateById</span><span class=p>(</span><span class=n>product</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>double</span><span class=w> </span><span class=n>totalPrice</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>product</span><span class=p>.</span><span class=na>getPrice</span><span class=p>()</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>amount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;æ‰£å‡å•†å“ç¼–å·ä¸º {} åº“å­˜æˆåŠŸ,æ‰£å‡ååº“å­˜ä¸º{}, {} ä»¶å•†å“æ€»ä»·ä¸º {} &#34;</span><span class=p>,</span><span class=w> </span><span class=n>productId</span><span class=p>,</span><span class=w> </span><span class=n>currentStock</span><span class=p>,</span><span class=w> </span><span class=n>amount</span><span class=p>,</span><span class=w> </span><span class=n>totalPrice</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;=============PRODUCT END=================&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>totalPrice</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RequiredArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AccountService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>AccountMapper</span><span class=w> </span><span class=n>accountMapper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;account&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>reduceBalance</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>Double</span><span class=w> </span><span class=n>price</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;=============ACCOUNT START=================&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;å½“å‰ XID: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>TransactionContext</span><span class=p>.</span><span class=na>getXID</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Account</span><span class=w> </span><span class=n>account</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>accountMapper</span><span class=p>.</span><span class=na>selectById</span><span class=p>(</span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Assert</span><span class=p>.</span><span class=na>notNull</span><span class=p>(</span><span class=n>account</span><span class=p>,</span><span class=w> </span><span class=s>&#34;ç”¨æˆ·ä¸å­˜åœ¨&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Double</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>account</span><span class=p>.</span><span class=na>getBalance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;ä¸‹å•ç”¨æˆ·{}ä½™é¢ä¸º {},å•†å“æ€»ä»·ä¸º{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>balance</span><span class=p>,</span><span class=w> </span><span class=n>price</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>balance</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>price</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&#34;ç”¨æˆ· {} ä½™é¢ä¸è¶³ï¼Œå½“å‰ä½™é¢:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>balance</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=s>&#34;ä½™é¢ä¸è¶³&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;å¼€å§‹æ‰£å‡ç”¨æˆ· {} ä½™é¢&#34;</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>double</span><span class=w> </span><span class=n>currentBalance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>account</span><span class=p>.</span><span class=na>getBalance</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>price</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>account</span><span class=p>.</span><span class=na>setBalance</span><span class=p>(</span><span class=n>currentBalance</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>accountMapper</span><span class=p>.</span><span class=na>updateById</span><span class=p>(</span><span class=n>account</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;æ‰£å‡ç”¨æˆ· {} ä½™é¢æˆåŠŸ,æ‰£å‡åç”¨æˆ·è´¦æˆ·ä½™é¢ä¸º{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>currentBalance</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;=============ACCOUNT END=================&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=åŸç†ä»‹ç»>åŸç†ä»‹ç»<a hidden class=anchor aria-hidden=true href=#åŸç†ä»‹ç»>#</a></h3><p><a href=https://github.com/baomidou/dynamic-datasource-spring-boot-starter/commit/f0cbad193528296eeb64faa76c79743afbdd811d>ç‚¹æˆ‘è·³è½¬</a></p><p>æ ¸å¿ƒåŸç†å°±æ˜¯ä»£ç†connectionï¼Œå¹¶æ ¹æ®ä¸åŒæ•°æ®åº“è·å–åˆ°ä¸€ä¸ªconnectionæ”¾å…¥ConnectionFactoryã€‚</p><p>å¦‚æœæˆåŠŸäº†æ•´ä½“æäº¤ï¼Œå¤±è´¥äº†æ•´ä½“å›æ»šã€‚</p><h2 id=seataäº‹åŠ¡>seataäº‹åŠ¡<a hidden class=anchor aria-hidden=true href=#seataäº‹åŠ¡>#</a></h2><h3 id=åŸºç¡€ä»‹ç»-11>åŸºç¡€ä»‹ç»<a hidden class=anchor aria-hidden=true href=#åŸºç¡€ä»‹ç»-11>#</a></h3><p>seata Githubåœ°å€ï¼š<a href=https://github.com/apache/incubator-seata>ç‚¹æˆ‘è·³è½¬</a></p><p>seata æ–‡æ¡£ï¼š<a href=https://seata.io/zh-cn/docs/overview/what-is-seata.html>ç‚¹æˆ‘è·³è½¬</a></p><p>seata ç¤ºä¾‹ï¼š<a href=https://github.com/apache/incubator-seata-samples>ç‚¹æˆ‘è·³è½¬</a></p><blockquote><p>PSï¼šä¸€èˆ¬éœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡çš„åœºæ™¯å¤§å¤šæ•°éƒ½æ˜¯å¾®æœåŠ¡åŒ–ï¼Œä¸ªäººå¹¶ä¸å»ºè®®åœ¨å•ä½“é¡¹ç›®å¼•å…¥å¤šæ•°æ®æº+åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œæœ‰èƒ½åŠ›å°½æ—©æ‹†å¼€ï¼Œå¯ä¸ºè¿‡åº¦æ–¹æ¡ˆã€‚</p></blockquote><h3 id=æ³¨æ„äº‹é¡¹-2>æ³¨æ„äº‹é¡¹<a hidden class=anchor aria-hidden=true href=#æ³¨æ„äº‹é¡¹-2>#</a></h3><p><code>dynamic-datasource-sring-boot-starter</code> ç»„ä»¶å†…éƒ¨å¼€å¯seataåä¼šè‡ªåŠ¨ä½¿ç”¨DataSourceProxyæ¥åŒ…è£…DataSourceï¼Œæ‰€ä»¥éœ€è¦ä»¥ä¸‹æ–¹å¼æ¥ä¿æŒå…¼å®¹ã€‚</p><p>1ã€å¦‚æœä½ å¼•å…¥çš„æ˜¯seata-all,è¯·ä¸è¦ä½¿ç”¨@EnableAutoDataSourceProxyæ³¨è§£ã€‚</p><p>2ã€å¦‚æœä½ å¼•å…¥çš„æ˜¯seata-spring-boot-starter è¯·å…³é—­è‡ªåŠ¨ä»£ç†ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>seata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enable-auto-data-source-proxy</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span></code></pre></div><h3 id=ç¤ºä¾‹é¡¹ç›®-4>ç¤ºä¾‹é¡¹ç›®<a hidden class=anchor aria-hidden=true href=#ç¤ºä¾‹é¡¹ç›®-4>#</a></h3><p><a href=https://github.com/dynamic-datasource/dynamic-datasource-samples/tree/master/tx-samples/tx-seata-sample>ç‚¹æˆ‘è·³è½¬</a></p><p>æ­¤å·¥ç¨‹ä¸º å¤šæ•°æ®æº+druid+seata+mybatisPlusçš„ç‰ˆæœ¬ã€‚</p><p>æ¨¡æ‹Ÿç”¨æˆ·ä¸‹å•ï¼Œæ‰£å•†å“åº“å­˜ï¼Œæ‰£ç”¨æˆ·ä½™é¢ï¼Œåˆæ­¥å¯åˆ†ä¸ºè®¢å•æœåŠ¡+å•†å“æœåŠ¡+ç”¨æˆ·æœåŠ¡ã€‚</p><h3 id=ç¯å¢ƒå‡†å¤‡>ç¯å¢ƒå‡†å¤‡<a hidden class=anchor aria-hidden=true href=#ç¯å¢ƒå‡†å¤‡>#</a></h3><p>ä¸ºäº†å¿«é€Ÿæ¼”ç¤ºç›¸å…³ç¯å¢ƒéƒ½é‡‡ç”¨dockeréƒ¨ç½²ï¼Œç”Ÿäº§ä¸Šçº¿è¯·å‚è€ƒseataå®˜æ–¹æ–‡æ¡£ä½¿ç”¨ã€‚</p><p>1ã€å‡†å¤‡seata-serverã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run --name seata-server -p 8091:8091 -d seataio/seata-server
</span></span></code></pre></div><p>2ã€å‡†å¤‡mysqlæ•°æ®åº“ï¼Œè´¦æˆ·rootå¯†ç 123456ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run --name mysql -p 3306:3306 -e <span class=nv>MYSQL_ROOT_PASSWORD</span><span class=o>=</span><span class=m>123456</span> -d mysql:5.7
</span></span></code></pre></div><p>3ã€åˆ›å»ºç›¸å…³æ•°æ®åº“ã€‚</p><p>åˆ›å»º <code>seata-order</code> <code>seata-product</code> <code>seata-account</code> æ¨¡æ‹Ÿè¿æ¥ä¸åŒçš„æ•°æ®åº“ã€‚</p><pre tabindex=0><code>CREATE DATABASE IF NOT EXIST seata-order;
CREATE DATABASE IF NOT EXIST seata-product;
CREATE DATABASE IF NOT EXIST seata-account;
</code></pre><p>4ã€å‡†å¤‡ç›¸å…³æ•°æ®åº“è„šæœ¬ã€‚</p><p>æ¯ä¸ªæ•°æ®åº“ä¸‹è„šæœ¬ç›¸å…³çš„è¡¨ï¼Œseataéœ€è¦undo_logæ¥ç›‘æµ‹å’Œå›æ»šã€‚</p><p>ç›¸å…³çš„seataè„šæœ¬å¯åˆ°seataå®˜æ–¹è·å–ï¼Œå¦å¤–é…åˆå¤šæ•°æ®æºçš„è‡ªåŠ¨æ‰§è¡Œè„šæœ¬åŠŸèƒ½ï¼Œåº”ç”¨å¯åŠ¨åä¼šè‡ªåŠ¨æ‰§è¡Œã€‚</p><h3 id=å·¥ç¨‹å‡†å¤‡>å·¥ç¨‹å‡†å¤‡<a hidden class=anchor aria-hidden=true href=#å·¥ç¨‹å‡†å¤‡>#</a></h3><p>1ã€å¼•å…¥ç›¸å…³ä¾èµ–ï¼Œseata+druid+MybatisPlus+dynamic-datasource+mysql+lombokã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>io.seata<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>seata-spring-boot-starter<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>1.4.2<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>com.baomidou<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>dynamic-datasource-spring-boot-starter<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>3.4.0<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl># çœç•¥ï¼ŒæŸ¥çœ‹ç¤ºä¾‹é¡¹ç›®
</span></span></code></pre></div><p>2ã€ç¼–å†™ç›¸å…³yamlé…ç½®ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>application</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dynamic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dynamic</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>primary</span><span class=p>:</span><span class=w> </span><span class=l>order</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>strict</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>seata</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>    </span><span class=c># å¼€å¯seataä»£ç†ï¼Œå¼€å¯åé»˜è®¤æ¯ä¸ªæ•°æ®æºéƒ½ä»£ç†ï¼Œå¦‚æœæŸä¸ªä¸éœ€è¦ä»£ç†å¯å•ç‹¬å…³é—­</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>seata-mode</span><span class=p>:</span><span class=w> </span><span class=l>AT</span><span class=w> </span><span class=c># æ”¯æŒXAåŠATæ¨¡å¼,é»˜è®¤AT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>datasource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>order</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://192.168.56.101:3306/seata_order?useUnicode=true&amp;characterEncoding=utf8&amp;allowMultiQueries=true&amp;useSSL=false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>schema</span><span class=p>:</span><span class=w> </span><span class=l>classpath:db/schema-order.sql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>account</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://192.168.56.101:3306/seata_account?useUnicode=true&amp;characterEncoding=utf8&amp;allowMultiQueries=true&amp;useSSL=false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>schema</span><span class=p>:</span><span class=w> </span><span class=l>classpath:db/schema-account.sql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>product</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=m>123456</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:mysql://192.168.56.101:3306/seata_product?useUnicode=true&amp;characterEncoding=utf8&amp;allowMultiQueries=true&amp;useSSL=false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>com.mysql.cj.jdbc.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>schema</span><span class=p>:</span><span class=w> </span><span class=l>classpath:db/schema-product.sql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>test</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>lijing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>jdbc:h2:mem:test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>driver-class-name</span><span class=p>:</span><span class=w> </span><span class=l>org.h2.Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>seata</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=c># è¿™ä¸ªæ•°æ®æºä¸éœ€è¦seata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>seata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>application-id</span><span class=p>:</span><span class=w> </span><span class=l>applicationName</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tx-service-group</span><span class=p>:</span><span class=w> </span><span class=l>my_test_tx_group</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enable-auto-data-source-proxy</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>   </span><span class=c>#ä¸€å®šè¦æ˜¯false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vgroup-mapping</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>my_test_tx_group</span><span class=p>:</span><span class=w> </span><span class=l>default </span><span class=w> </span><span class=c># keyä¸ä¸Šé¢çš„tx-service-groupçš„å€¼å¯¹åº”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>grouplist</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>default</span><span class=p>:</span><span class=w> </span><span class=m>192.168.56.101</span><span class=p>:</span><span class=m>8091</span><span class=w> </span><span class=c># seata-serveråœ°å€ä»…fileæ³¨å†Œä¸­å¿ƒéœ€è¦</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>file</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>registry</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>file</span><span class=w>
</span></span></span></code></pre></div><h3 id=ä»£ç ç¼–å†™>ä»£ç ç¼–å†™<a hidden class=anchor aria-hidden=true href=#ä»£ç ç¼–å†™>#</a></h3><p>å‚è€ƒå·¥ç¨‹ä¸‹é¢çš„ä»£ç å®Œæˆcontroller,service,maaper,entity,dtoç­‰ã€‚</p><p>è®¢å•æœåŠ¡</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>OrderServiceImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>OrderService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=n>OrderDao</span><span class=w> </span><span class=n>orderDao</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=n>AccountService</span><span class=w> </span><span class=n>accountService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=n>ProductService</span><span class=w> </span><span class=n>productService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;order&#34;</span><span class=p>)</span><span class=c1>// æ¯ä¸€å±‚éƒ½éœ€è¦ä½¿ç”¨å¤šæ•°æ®æºæ³¨è§£åˆ‡æ¢æ‰€é€‰æ‹©çš„æ•°æ®åº“</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Transactional</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@GlobalTransactional</span><span class=w> </span><span class=c1>// é‡ç‚¹ ç¬¬ä¸€ä¸ªå¼€å¯äº‹åŠ¡çš„éœ€è¦æ·»åŠ seataå…¨å±€äº‹åŠ¡æ³¨è§£</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>placeOrder</span><span class=p>(</span><span class=n>PlaceOrderRequest</span><span class=w> </span><span class=n>request</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;=============ORDER START=================&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getUserId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Long</span><span class=w> </span><span class=n>productId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getProductId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Integer</span><span class=w> </span><span class=n>amount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getAmount</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;æ”¶åˆ°ä¸‹å•è¯·æ±‚,ç”¨æˆ·:{}, å•†å“:{},æ•°é‡:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>productId</span><span class=p>,</span><span class=w> </span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;å½“å‰ XID: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>RootContext</span><span class=p>.</span><span class=na>getXID</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Order</span><span class=w> </span><span class=n>order</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Order</span><span class=p>.</span><span class=na>builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>userId</span><span class=p>(</span><span class=n>userId</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>productId</span><span class=p>(</span><span class=n>productId</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>status</span><span class=p>(</span><span class=n>OrderStatus</span><span class=p>.</span><span class=na>INIT</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>amount</span><span class=p>(</span><span class=n>amount</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>orderDao</span><span class=p>.</span><span class=na>insert</span><span class=p>(</span><span class=n>order</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;è®¢å•ä¸€é˜¶æ®µç”Ÿæˆï¼Œç­‰å¾…æ‰£åº“å­˜ä»˜æ¬¾ä¸­&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ‰£å‡åº“å­˜å¹¶è®¡ç®—æ€»ä»·</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Double</span><span class=w> </span><span class=n>totalPrice</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>productService</span><span class=p>.</span><span class=na>reduceStock</span><span class=p>(</span><span class=n>productId</span><span class=p>,</span><span class=w> </span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ‰£å‡ä½™é¢</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>accountService</span><span class=p>.</span><span class=na>reduceBalance</span><span class=p>(</span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>totalPrice</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>order</span><span class=p>.</span><span class=na>setStatus</span><span class=p>(</span><span class=n>OrderStatus</span><span class=p>.</span><span class=na>SUCCESS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>order</span><span class=p>.</span><span class=na>setTotalPrice</span><span class=p>(</span><span class=n>totalPrice</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>orderDao</span><span class=p>.</span><span class=na>updateById</span><span class=p>(</span><span class=n>order</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;è®¢å•å·²æˆåŠŸä¸‹å•&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;=============ORDER END=================&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>å•†å“æœåŠ¡</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ProductServiceImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>ProductService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=n>ProductDao</span><span class=w> </span><span class=n>productDao</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * äº‹åŠ¡ä¼ æ’­ç‰¹æ€§è®¾ç½®ä¸º REQUIRES_NEW å¼€å¯æ–°çš„äº‹åŠ¡  é‡è¦ï¼ï¼ï¼ï¼ä¸€å®šè¦ä½¿ç”¨REQUIRES_NEW
</span></span></span><span class=line><span class=cl><span class=cm>   */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;product&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Transactional</span><span class=p>(</span><span class=n>propagation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Propagation</span><span class=p>.</span><span class=na>REQUIRES_NEW</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=n>Double</span><span class=w> </span><span class=nf>reduceStock</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>productId</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;=============PRODUCT START=================&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;å½“å‰ XID: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>RootContext</span><span class=p>.</span><span class=na>getXID</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ£€æŸ¥åº“å­˜</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Product</span><span class=w> </span><span class=n>product</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>productDao</span><span class=p>.</span><span class=na>selectById</span><span class=p>(</span><span class=n>productId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Integer</span><span class=w> </span><span class=n>stock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>product</span><span class=p>.</span><span class=na>getStock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;å•†å“ç¼–å·ä¸º {} çš„åº“å­˜ä¸º{},è®¢å•å•†å“æ•°é‡ä¸º{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>productId</span><span class=p>,</span><span class=w> </span><span class=n>stock</span><span class=p>,</span><span class=w> </span><span class=n>amount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>stock</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>log</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&#34;å•†å“ç¼–å·ä¸º{} åº“å­˜ä¸è¶³ï¼Œå½“å‰åº“å­˜:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>productId</span><span class=p>,</span><span class=w> </span><span class=n>stock</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=s>&#34;åº“å­˜ä¸è¶³&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;å¼€å§‹æ‰£å‡å•†å“ç¼–å·ä¸º {} åº“å­˜,å•ä»·å•†å“ä»·æ ¼ä¸º{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>productId</span><span class=p>,</span><span class=w> </span><span class=n>product</span><span class=p>.</span><span class=na>getPrice</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ‰£å‡åº“å­˜</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>currentStock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>stock</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>amount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>product</span><span class=p>.</span><span class=na>setStock</span><span class=p>(</span><span class=n>currentStock</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>productDao</span><span class=p>.</span><span class=na>updateById</span><span class=p>(</span><span class=n>product</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>double</span><span class=w> </span><span class=n>totalPrice</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>product</span><span class=p>.</span><span class=na>getPrice</span><span class=p>()</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>amount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;æ‰£å‡å•†å“ç¼–å·ä¸º {} åº“å­˜æˆåŠŸ,æ‰£å‡ååº“å­˜ä¸º{}, {} ä»¶å•†å“æ€»ä»·ä¸º {} &#34;</span><span class=p>,</span><span class=w> </span><span class=n>productId</span><span class=p>,</span><span class=w> </span><span class=n>currentStock</span><span class=p>,</span><span class=w> </span><span class=n>amount</span><span class=p>,</span><span class=w> </span><span class=n>totalPrice</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;=============PRODUCT END=================&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>totalPrice</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>ç”¨æˆ·æœåŠ¡</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AccountServiceImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>AccountService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=n>AccountDao</span><span class=w> </span><span class=n>accountDao</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * äº‹åŠ¡ä¼ æ’­ç‰¹æ€§è®¾ç½®ä¸º REQUIRES_NEW å¼€å¯æ–°çš„äº‹åŠ¡    é‡è¦ï¼ï¼ï¼ï¼ä¸€å®šè¦ä½¿ç”¨REQUIRES_NEW
</span></span></span><span class=line><span class=cl><span class=cm>   */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;account&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Transactional</span><span class=p>(</span><span class=n>propagation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Propagation</span><span class=p>.</span><span class=na>REQUIRES_NEW</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>reduceBalance</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>Double</span><span class=w> </span><span class=n>price</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;=============ACCOUNT START=================&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;å½“å‰ XID: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>RootContext</span><span class=p>.</span><span class=na>getXID</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Account</span><span class=w> </span><span class=n>account</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>accountDao</span><span class=p>.</span><span class=na>selectById</span><span class=p>(</span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Double</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>account</span><span class=p>.</span><span class=na>getBalance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;ä¸‹å•ç”¨æˆ·{}ä½™é¢ä¸º {},å•†å“æ€»ä»·ä¸º{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>balance</span><span class=p>,</span><span class=w> </span><span class=n>price</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>balance</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>price</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>log</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&#34;ç”¨æˆ· {} ä½™é¢ä¸è¶³ï¼Œå½“å‰ä½™é¢:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>balance</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=s>&#34;ä½™é¢ä¸è¶³&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;å¼€å§‹æ‰£å‡ç”¨æˆ· {} ä½™é¢&#34;</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>double</span><span class=w> </span><span class=n>currentBalance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>account</span><span class=p>.</span><span class=na>getBalance</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>price</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>account</span><span class=p>.</span><span class=na>setBalance</span><span class=p>(</span><span class=n>currentBalance</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>accountDao</span><span class=p>.</span><span class=na>updateById</span><span class=p>(</span><span class=n>account</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;æ‰£å‡ç”¨æˆ· {} ä½™é¢æˆåŠŸ,æ‰£å‡åç”¨æˆ·è´¦æˆ·ä½™é¢ä¸º{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>userId</span><span class=p>,</span><span class=w> </span><span class=n>currentBalance</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;=============ACCOUNT END=================&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=æµ‹è¯•>æµ‹è¯•<a hidden class=anchor aria-hidden=true href=#æµ‹è¯•>#</a></h3><p>è‡ªè¡Œç¼–å†™æ¥å£æµ‹è¯•ï¼Œæ³¨æ„è§‚å¯Ÿè¿è¡Œæ—¥å¿—ï¼Œè‡³æ­¤åˆ†å¸ƒå¼äº‹åŠ¡é›†æˆæ¡ˆä¾‹å…¨æµç¨‹å®Œæ¯•ã€‚</p><h2 id=äº‹åŠ¡å¸¸è§é—®é¢˜>äº‹åŠ¡å¸¸è§é—®é¢˜<a hidden class=anchor aria-hidden=true href=#äº‹åŠ¡å¸¸è§é—®é¢˜>#</a></h2><p>å»ºè®®å…ˆé˜…è¯»åŸºç¡€çŸ¥è¯†ã€‚</p><p>æ ¸å¿ƒçŸ¥è¯†ï¼š <code>springåŸç”Ÿäº‹åŠ¡ä¼šä¿è¯åœ¨äº‹åŠ¡ä¸‹æ•´ä¸ªçº¿ç¨‹åç»­æ‹¿åˆ°çš„éƒ½æ˜¯åŒä¸€ä¸ªconnectionã€‚</code></p><p>æ ¸å¿ƒçŸ¥è¯†ï¼š <code>springåŸç”Ÿäº‹åŠ¡ä¼šä¿è¯åœ¨äº‹åŠ¡ä¸‹æ•´ä¸ªçº¿ç¨‹åç»­æ‹¿åˆ°çš„éƒ½æ˜¯åŒä¸€ä¸ªconnectionã€‚</code></p><p>æ ¸å¿ƒçŸ¥è¯†ï¼š <code>springåŸç”Ÿäº‹åŠ¡ä¼šä¿è¯åœ¨äº‹åŠ¡ä¸‹æ•´ä¸ªçº¿ç¨‹åç»­æ‹¿åˆ°çš„éƒ½æ˜¯åŒä¸€ä¸ªconnectionã€‚</code></p><h3 id=åŸç”Ÿspringä¸­transationalèƒ½å’Œdsä¸€èµ·ä½¿ç”¨å—>åŸç”ŸSpringä¸­@Transationalèƒ½å’Œ@DSä¸€èµ·ä½¿ç”¨å—ï¼Ÿ<a hidden class=anchor aria-hidden=true href=#åŸç”Ÿspringä¸­transationalèƒ½å’Œdsä¸€èµ·ä½¿ç”¨å—>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;a&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Transational</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>dosomething</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=c1>// some code</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>å¯ä»¥çš„ï¼Œå…¶ä¼šå…ˆåˆ‡æ¢ä½¿ç”¨æ•°æ®æºaå†å¼€å¯äº‹åŠ¡ï¼Œæ•´ä¸ªåŸç”Ÿäº‹åŠ¡å†…éƒ¨ä¸ç®¡æ˜¯æ³¨è§£åˆ‡æ¢è¿˜æ˜¯æ‰‹åŠ¨è°ƒç”¨ä»£ç åˆ‡æ¢éƒ½ä¸èƒ½åˆ‡æ¢ï¼Œä¼šä¸€ç›´ä½¿ç”¨aæ•°æ®æºã€‚</p><p>æ‰€ä»¥ç¡®è®¤æ•´ä¸ªäº‹åŠ¡ä¸‹ä¸å†åˆ‡æ¢å…¶ä»–æ•°æ®æºï¼Œç”¨åŸç”Ÿ <code>@Transational</code> æ˜¯å»ºè®®çš„ï¼Œæ¯•ç«Ÿå…¶æ›´å®Œå–„ã€‚</p><h3 id=æœ¬åœ°äº‹åŠ¡å’ŒspringåŸç”Ÿäº‹åŠ¡ä¸èƒ½æ··ç”¨æ˜¯ä»€ä¹ˆæ„æ€>æœ¬åœ°äº‹åŠ¡å’ŒSpringåŸç”Ÿäº‹åŠ¡ä¸èƒ½æ··ç”¨æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ<a hidden class=anchor aria-hidden=true href=#æœ¬åœ°äº‹åŠ¡å’ŒspringåŸç”Ÿäº‹åŠ¡ä¸èƒ½æ··ç”¨æ˜¯ä»€ä¹ˆæ„æ€>#</a></h3><p>åœºæ™¯ä¸€ï¼šå…ˆä½¿ç”¨çš„Spring<code>@Transational</code> å†…éƒ¨æ–¹æ³•è°ƒç”¨äº†æœ¬åœ°<code>@DSTransactional</code>ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;a&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Transational</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>dosomething</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Bservice</span><span class=p>.</span><span class=na>dosomething</span><span class=p>();</span><span class=w> </span><span class=c1>// Bæ˜¯å¦å¤–æ•°æ®æºï¼Œç„¶åæ³¨è§£äº†@DS(&#34;b&#34;)å’Œ@DSTransactional</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Cservice</span><span class=p>.</span><span class=na>dosomething</span><span class=p>();</span><span class=w> </span><span class=c1>// Cæ˜¯å¦å¤–æ•°æ®æºï¼Œç„¶åæ³¨è§£äº†@DS(&#34;c&#34;)å’Œ@DSTransactional</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>åŸºäºæ ¸å¿ƒçŸ¥è¯†ï¼š äº‹åŠ¡ä¸‹éƒ½æ˜¯aæ•°æ®æºï¼Œå†…éƒ¨æ— è®ºåšä»€ä¹ˆéƒ½æ”¹å˜ä¸äº†ä½¿ç”¨aæ•°æ®æºã€‚</p><p>åœºæ™¯äºŒï¼š å…ˆä½¿ç”¨çš„æœ¬åœ°<code>@DSTransactional</code>å†…éƒ¨æ–¹æ³•è°ƒç”¨äº†Spring<code>@Transational</code> ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;a&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DSTransactional</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>dosomething</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Amapper</span><span class=p>.</span><span class=na>updateSomeThing</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Bservice</span><span class=p>.</span><span class=na>dosomething</span><span class=p>();</span><span class=w> </span><span class=c1>// Bæ˜¯å¦å¤–æ•°æ®æºï¼Œç„¶åæ³¨è§£äº†@DS(&#34;b&#34;)å’Œ@Transational</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Cservice</span><span class=p>.</span><span class=na>dosomething</span><span class=p>();</span><span class=w> </span><span class=c1>// Cæ˜¯å¦å¤–æ•°æ®æºï¼Œç„¶åæ³¨è§£äº†@DS(&#34;c&#34;)å’Œ@Transational</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Bå’ŒCéƒ½æ˜¯ç‹¬ç«‹çš„äº‹åŠ¡ã€‚Cå‘ç”Ÿé”™è¯¯Bä¼šå›æ»šå—ï¼Ÿä¸ä¼šBå·²ç»æäº¤äº†ã€‚Aä¼šå›æ»šå—ï¼Ÿä¼šã€‚</p><p>ä¸å»ºè®®æ··ç”¨ï¼Œé™¤éä½ ç¡®å®éå¸¸ç†è§£äº‹åŠ¡ï¼Œèƒ½éšå¿ƒæ‰€æ¬²æŒæ¡ä½ ä»£ç çš„æ‰§è¡Œæµç¨‹ã€‚</p><h3 id=æœ¬åœ°äº‹åŠ¡æ ‡å‡†ä½¿ç”¨>æœ¬åœ°äº‹åŠ¡æ ‡å‡†ä½¿ç”¨<a hidden class=anchor aria-hidden=true href=#æœ¬åœ°äº‹åŠ¡æ ‡å‡†ä½¿ç”¨>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;a&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DSTransactional</span><span class=w> </span><span class=c1>// æœ€å¤–å±‚å¼€å¯å³å¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>dosomething</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Amapper</span><span class=p>.</span><span class=na>updateSomeThing</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Bservice</span><span class=p>.</span><span class=na>dosomething</span><span class=p>();</span><span class=w> </span><span class=c1>// Bæ˜¯å¦å¤–æ•°æ®æºï¼Œç„¶åæ³¨è§£äº†@DS(&#34;b&#34;)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Cservice</span><span class=p>.</span><span class=na>dosomething</span><span class=p>();</span><span class=w> </span><span class=c1>// Cæ˜¯å¦å¤–æ•°æ®æºï¼Œç„¶åæ³¨è§£äº†@DS(&#34;c&#34;)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h1 id=è°ƒè¯•æºç >è°ƒè¯•æºç <a hidden class=anchor aria-hidden=true href=#è°ƒè¯•æºç >#</a></h1><p>1ã€å¼€å¯åŠ¨æ€æ•°æ®æºçš„debugæ—¥å¿—ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>logging</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>level</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>com.baomidou.dynamic</span><span class=p>:</span><span class=w> </span><span class=l>debug</span><span class=w>
</span></span></span></code></pre></div><p>æ£€æŸ¥æ—¥å¿—è¾“å‡ºæ˜¯å¦æ­£ç¡®ã€‚</p><p>2ã€æ–­ç‚¹è°ƒè¯•DynamicDataSourceAnnotationInterceptorã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DynamicDataSourceAnnotationInterceptor</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>MethodInterceptor</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>DYNAMIC_PREFIX</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;#&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>DataSourceClassResolver</span><span class=w> </span><span class=n>dataSourceClassResolver</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>DsProcessor</span><span class=w> </span><span class=n>dsProcessor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>DynamicDataSourceAnnotationInterceptor</span><span class=p>(</span><span class=n>Boolean</span><span class=w> </span><span class=n>allowedPublicOnly</span><span class=p>,</span><span class=w> </span><span class=n>DsProcessor</span><span class=w> </span><span class=n>dsProcessor</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>dataSourceClassResolver</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataSourceClassResolver</span><span class=p>(</span><span class=n>allowedPublicOnly</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>dsProcessor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dsProcessor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>invoke</span><span class=p>(</span><span class=n>MethodInvocation</span><span class=w> </span><span class=n>invocation</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// è¿™é‡ŒæŠŠè·å–åˆ°çš„æ•°æ®æºæ ‡è¯†å¦‚masterå­˜å…¥æœ¬åœ°çº¿ç¨‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>dsKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>determineDatasourceKey</span><span class=p>(</span><span class=n>invocation</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=err>â—</span><span class=w>  </span><span class=n>DynamicDataSourceContextHolder</span><span class=p>.</span><span class=na>push</span><span class=p>(</span><span class=n>dsKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>invocation</span><span class=p>.</span><span class=na>proceed</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>DynamicDataSourceContextHolder</span><span class=p>.</span><span class=na>poll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>determineDatasourceKey</span><span class=p>(</span><span class=n>MethodInvocation</span><span class=w> </span><span class=n>invocation</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dataSourceClassResolver</span><span class=p>.</span><span class=na>findDSKey</span><span class=p>(</span><span class=n>invocation</span><span class=p>.</span><span class=na>getMethod</span><span class=p>(),</span><span class=w> </span><span class=n>invocation</span><span class=p>.</span><span class=na>getThis</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>key</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>startsWith</span><span class=p>(</span><span class=n>DYNAMIC_PREFIX</span><span class=p>))</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>dsProcessor</span><span class=p>.</span><span class=na>determineDatasource</span><span class=p>(</span><span class=n>invocation</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>key</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>3ã€æ–­ç‚¹è°ƒè¯•DynamicRoutingDataSourceã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DynamicRoutingDataSource</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AbstractRoutingDataSource</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>DataSource</span><span class=o>&gt;</span><span class=w> </span><span class=n>dataSourceMap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LinkedHashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>DynamicGroupDataSource</span><span class=o>&gt;</span><span class=w> </span><span class=n>groupDataSources</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConcurrentHashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=nf>determineDataSource</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ä»æœ¬åœ°çº¿ç¨‹è·å–keyè§£ææœ€ç»ˆçœŸå®çš„æ•°æ®æº</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=err>â—</span><span class=w>  </span><span class=n>String</span><span class=w> </span><span class=n>dsKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DynamicDataSourceContextHolder</span><span class=p>.</span><span class=na>peek</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>getDataSource</span><span class=p>(</span><span class=n>dsKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=nf>determinePrimaryDataSource</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;ä»é»˜è®¤æ•°æ®æºä¸­è¿”å›æ•°æ®&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>groupDataSources</span><span class=p>.</span><span class=na>containsKey</span><span class=p>(</span><span class=n>primary</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>groupDataSources</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>primary</span><span class=p>).</span><span class=na>determineDataSource</span><span class=p>()</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>dataSourceMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>primary</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=nf>getDataSource</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>ds</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>StringUtils</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>(</span><span class=n>ds</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>determinePrimaryDataSource</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>groupDataSources</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>groupDataSources</span><span class=p>.</span><span class=na>containsKey</span><span class=p>(</span><span class=n>ds</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;ä» {} ç»„æ•°æ®æºä¸­è¿”å›æ•°æ®æº&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ds</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>groupDataSources</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>ds</span><span class=p>).</span><span class=na>determineDataSource</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>dataSourceMap</span><span class=p>.</span><span class=na>containsKey</span><span class=p>(</span><span class=n>ds</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;ä» {} å•æ•°æ®æºä¸­è¿”å›æ•°æ®æº&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ds</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>dataSourceMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>ds</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>determinePrimaryDataSource</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h1 id=å¸¸è§é—®é¢˜ä¹‹-åˆ‡æ¢æ•°æ®æºå¤±è´¥>å¸¸è§é—®é¢˜ä¹‹-åˆ‡æ¢æ•°æ®æºå¤±è´¥<a hidden class=anchor aria-hidden=true href=#å¸¸è§é—®é¢˜ä¹‹-åˆ‡æ¢æ•°æ®æºå¤±è´¥>#</a></h1><h2 id=å¼€å¯äº†springçš„äº‹åŠ¡>å¼€å¯äº†springçš„äº‹åŠ¡<a hidden class=anchor aria-hidden=true href=#å¼€å¯äº†springçš„äº‹åŠ¡>#</a></h2><p>åŸå› ï¼š springå¼€å¯äº‹åŠ¡åä¼šç»´æŠ¤ä¸€ä¸ªConnectionHolderï¼Œä¿è¯åœ¨æ•´ä¸ªäº‹åŠ¡ä¸‹ï¼Œéƒ½æ˜¯ç”¨åŒä¸€ä¸ªæ•°æ®åº“è¿æ¥ã€‚</p><p>è¯·æ£€æŸ¥æ•´ä¸ªè°ƒç”¨é“¾è·¯æ¶‰åŠçš„ç±»çš„æ–¹æ³•å’Œç±»æœ¬èº«è¿˜æœ‰ç»§æ‰¿çš„æŠ½è±¡ç±»ä¸Šæ˜¯å¦æœ‰<code>@Transactional</code>æ³¨è§£ã€‚</p><p>å¦‚å¼ºçƒˆéœ€è¦äº‹åŠ¡ä¿è¯å¤šä¸ªåº“åŒæ—¶æ‰§è¡ŒæˆåŠŸæˆ–è€…å¤±è´¥ï¼Œè¯·æŸ¥çœ‹äº‹åŠ¡ä¸“æ çš„è§£å†³åŠæ³•ã€‚</p><h2 id=æ–¹æ³•å†…éƒ¨è°ƒç”¨>æ–¹æ³•å†…éƒ¨è°ƒç”¨<a hidden class=anchor aria-hidden=true href=#æ–¹æ³•å†…éƒ¨è°ƒç”¨>#</a></h2><p>æŸ¥çœ‹ä»¥ä¸‹ç¤ºä¾‹</p><p>å¤–éƒ¨è°ƒç”¨ <code>userservice.test1()</code> èƒ½åœ¨æ‰§è¡Œåˆ° <code>test2()</code> åˆ‡æ¢åˆ°secondæ•°æ®æºå—ï¼Ÿ</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>UserService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;first&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test1</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// do something</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>test2</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;second&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>test2</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// do something</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>ç­”æ¡ˆï¼š<code>ï¼ï¼ï¼ä¸èƒ½ä¸èƒ½ä¸èƒ½ï¼ï¼ï¼</code>æ•°æ®æºæ ¸å¿ƒåŸç†æ˜¯åŸºäºaopä»£ç†å®ç°åˆ‡æ¢ï¼Œå†…éƒ¨æ–¹æ³•è°ƒç”¨ä¸ä¼šä½¿ç”¨aopã€‚</p><p>è§£å†³æ–¹æ³•:</p><p>æŠŠtest2()æ–¹æ³•æåˆ°å¦å¤–ä¸€ä¸ªserviceï¼Œå•ç‹¬è°ƒç”¨ã€‚</p><h2 id=postconstructåˆå§‹åŒ–é¡ºåº>PostConstructåˆå§‹åŒ–é¡ºåº<a hidden class=anchor aria-hidden=true href=#postconstructåˆå§‹åŒ–é¡ºåº>#</a></h2><p>åˆå§‹åŒ–åŒ…æ‹¬: @PostConstruct æ³¨è§£, InitializingBeanæ¥å£, è‡ªå®šä¹‰init-method</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MyConfiguration</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>UserMapper</span><span class=w> </span><span class=n>userMapper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;slave&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PostConstruct</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>init</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ— æ³•é€‰æ‹©æ­£ç¡®çš„æ•°æ®æº</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>userMapper</span><span class=p>.</span><span class=na>selectById</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>è§£å†³æ–¹æ³•ï¼šç›‘å¬å®¹å™¨å¯åŠ¨å®Œæˆäº‹ä»¶, åœ¨å®¹å™¨å®Œæˆååšåˆå§‹åŒ–ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MyConfiguration</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DS</span><span class=p>(</span><span class=s>&#34;slave&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@EventListener</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onApplicationEvent</span><span class=p>(</span><span class=n>ContextRefreshedEvent</span><span class=w> </span><span class=n>event</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æˆåŠŸé€‰æ‹©æ­£ç¡®çš„æ•°æ®æº</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>userMapper</span><span class=p>.</span><span class=na>selectById</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>ç›¸å…³springæºç  : <code>org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#initializeBean</code></p><p>åœ¨åˆå§‹åŒ–å®Œæˆå, bean è¿›å…¥å¢å¼ºé˜¶æ®µ, æ‰€ä»¥è¿™ä¸ªé˜¶æ®µçš„ä»»ä½•AOPéƒ½æ˜¯æ— æ•ˆçš„ã€‚</p><h2 id=druidç‰ˆæœ¬è¿‡ä½>Druidç‰ˆæœ¬è¿‡ä½<a hidden class=anchor aria-hidden=true href=#druidç‰ˆæœ¬è¿‡ä½>#</a></h2><p>è¯·å‡çº§druid1.1.22åŠä»¥ä¸Šç‰ˆæœ¬ï¼Œè¿™ä¸ªç‰ˆæœ¬ä¿®å¤äº†åœ¨é«˜å¹¶å‘ä¸‹å¶å‘çš„åˆ‡æ¢å¤±æ•ˆé—®é¢˜ã€‚</p><h2 id=asyncæˆ–è€…java8çš„parallelstreamå¹¶è¡Œæµä¹‹ç±»æ–¹æ³•>@Asyncæˆ–è€…java8çš„ParallelStreamå¹¶è¡Œæµä¹‹ç±»æ–¹æ³•<a hidden class=anchor aria-hidden=true href=#asyncæˆ–è€…java8çš„parallelstreamå¹¶è¡Œæµä¹‹ç±»æ–¹æ³•>#</a></h2><p>è¿™ç§æƒ…å†µéƒ½æ˜¯æ–°å¼€äº†çº¿ç¨‹å»å¼‚æ­¥å¤„ç†ï¼Œä¸å—å½“å‰çº¿ç¨‹ç®¡æ§äº†ã€‚</p><p>å¯ä»¥åœ¨æ–°å¼€çš„æ–¹æ³•ä¸ŠåŠ å¯¹åº”çš„DSæ³¨è§£è§£å†³ã€‚</p><h1 id=çŸ¥è¯†åº“>çŸ¥è¯†åº“<a hidden class=anchor aria-hidden=true href=#çŸ¥è¯†åº“>#</a></h1><h2 id=å¦‚ä½•æ³¨å…¥å¤šæ•°æ®æº>å¦‚ä½•æ³¨å…¥å¤šæ•°æ®æºï¼Ÿ<a hidden class=anchor aria-hidden=true href=#å¦‚ä½•æ³¨å…¥å¤šæ•°æ®æº>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>A</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=n>dosomething</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=c1>// ä½¿ç”¨çš„æ—¶å€™éœ€è¦å¼ºè½¬</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DynamicRoutingDataSource</span><span class=w> </span><span class=n>ds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>DynamicRoutingDataSource</span><span class=p>)</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=å¦‚ä½•è·å–å½“å‰çº¿ç¨‹æ•°æ®æºåç§°>å¦‚ä½•è·å–å½“å‰çº¿ç¨‹æ•°æ®æºåç§°ï¼Ÿ<a hidden class=anchor aria-hidden=true href=#å¦‚ä½•è·å–å½“å‰çº¿ç¨‹æ•°æ®æºåç§°>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>DynamicDataSourceContextHolder</span><span class=p>.</span><span class=na>peek</span><span class=p>()</span><span class=w>
</span></span></span></code></pre></div><h2 id=å¦‚ä½•è·å–å½“å‰çº¿ç¨‹æ•°æ®æº>å¦‚ä½•è·å–å½“å‰çº¿ç¨‹æ•°æ®æºï¼Ÿ<a hidden class=anchor aria-hidden=true href=#å¦‚ä½•è·å–å½“å‰çº¿ç¨‹æ•°æ®æº>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=n>dosomething</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DynamicRoutingDataSource</span><span class=w> </span><span class=n>ds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>DynamicRoutingDataSource</span><span class=p>)</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DataSource</span><span class=w> </span><span class=n>datasource</span><span class=o>=</span><span class=n>ds</span><span class=p>.</span><span class=na>determineDataSource</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><blockquote><p>æœ¬æ–‡å‚è€ƒè‡³ï¼šhttps://www.xiaojingge.com/archives/ef008289-8ab8-485c-8019-2703267c7beb</p></blockquote></div><footer class=post-footer><ul class=post-tags><li><a href=https://lesanouo.github.io/blog/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/>æ•°æ®åº“</a></li></ul><nav class=paginav><a class=prev href=https://lesanouo.github.io/blog/posts/code/175000320001/><span class=title>Â«</span><br><span>npmä¸­windows-build-toolsä¸‹è½½é—®é¢˜</span>
</a><a class=next href=https://lesanouo.github.io/blog/posts/code/174931200001/><span class=title>Â»</span><br><span>MySQLåˆ›å»ºç”¨æˆ·ä¸æˆæƒ</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://lesanouo.github.io/blog/>Lesan's Blog</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>