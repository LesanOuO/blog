<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>SpringBootå®ç°å¤§æ–‡ä»¶ä¸Šä¼  | Lesan's Blog</title><meta name=keywords content="SpringBoot"><meta name=description content="å¤§æ–‡ä»¶ä¸Šä¼ æ˜¯æé«˜ç”¨æˆ·ä½“éªŒæ„Ÿçš„é‡è¦åŠŸèƒ½ï¼Œåƒç™¾åº¦ç½‘ç›˜ã€é˜¿é‡Œç½‘ç›˜ç­‰ç­‰éƒ½æ”¯æŒæ–­ç‚¹ç»­ä¼ å’Œæ–‡ä»¶ç§’ä¼ åŠŸèƒ½ï¼Œå‡å°‘äº†ç½‘ç»œæ³¢åŠ¨å’Œç½‘ç»œå¸¦å®½å¯¹æ–‡ä»¶çš„é™åˆ¶ã€‚

ã€Œæ–‡ä»¶åˆ†å—ã€ï¼šå°†å¤§æ–‡ä»¶æ‹†åˆ†æˆå°æ–‡ä»¶ï¼Œå°†å°æ–‡ä»¶ä¸Šä¼ \ä¸‹è½½ï¼Œæœ€åå†å°†å°æ–‡ä»¶ç»„è£…æˆå¤§æ–‡ä»¶ï¼›
ã€Œæ–­ç‚¹ç»­ä¼ ã€ï¼šåœ¨æ–‡ä»¶åˆ†å—çš„åŸºç¡€ä¸Šï¼Œå°†æ¯ä¸ªå°æ–‡ä»¶é‡‡ç”¨å•ç‹¬çš„çº¿ç¨‹è¿›è¡Œä¸Šä¼ \ä¸‹è½½ï¼Œå¦‚æœç¢°åˆ°ç½‘ç»œæ•…éšœï¼Œå¯ä»¥ä»å·²ç»ä¸Šä¼ \ä¸‹è½½çš„éƒ¨åˆ†å¼€å§‹ç»§ç»­ä¸Šä¼ \ä¸‹è½½æœªå®Œæˆçš„éƒ¨åˆ†ï¼Œè€Œæ²¡æœ‰å¿…è¦ä»å¤´å¼€å§‹ä¸Šä¼ \ä¸‹è½½ï¼›
ã€Œæ–‡ä»¶ç§’ä¼ ã€ï¼šèµ„æºæœåŠ¡å™¨ä¸­å·²ç»å­˜åœ¨è¯¥æ–‡ä»¶ï¼Œå…¶ä»–äººä¸Šä¼ æ—¶ç›´æ¥è¿”å›è¯¥æ–‡ä»¶çš„URIã€‚

æœ¬æ–‡å°†ä»‹ç»SpringBootä¸­å®ç°å¤§æ–‡ä»¶ä¸Šä¼ çš„ä¸»è¦ä»£ç ï¼š"><meta name=author content="Lesan"><link rel=canonical href=https://lesanouo.github.io/blog/posts/code/168831360001/><link crossorigin=anonymous href=/blog/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://lesanouo.github.io/blog/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://lesanouo.github.io/blog/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://lesanouo.github.io/blog/favicon.ico><link rel=apple-touch-icon href=https://lesanouo.github.io/blog/favicon.ico><link rel=mask-icon href=https://lesanouo.github.io/blog/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-cn href=https://lesanouo.github.io/blog/posts/code/168831360001/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:url" content="https://lesanouo.github.io/blog/posts/code/168831360001/"><meta property="og:site_name" content="Lesan's Blog"><meta property="og:title" content="SpringBootå®ç°å¤§æ–‡ä»¶ä¸Šä¼ "><meta property="og:description" content="å¤§æ–‡ä»¶ä¸Šä¼ æ˜¯æé«˜ç”¨æˆ·ä½“éªŒæ„Ÿçš„é‡è¦åŠŸèƒ½ï¼Œåƒç™¾åº¦ç½‘ç›˜ã€é˜¿é‡Œç½‘ç›˜ç­‰ç­‰éƒ½æ”¯æŒæ–­ç‚¹ç»­ä¼ å’Œæ–‡ä»¶ç§’ä¼ åŠŸèƒ½ï¼Œå‡å°‘äº†ç½‘ç»œæ³¢åŠ¨å’Œç½‘ç»œå¸¦å®½å¯¹æ–‡ä»¶çš„é™åˆ¶ã€‚
ã€Œæ–‡ä»¶åˆ†å—ã€ï¼šå°†å¤§æ–‡ä»¶æ‹†åˆ†æˆå°æ–‡ä»¶ï¼Œå°†å°æ–‡ä»¶ä¸Šä¼ \ä¸‹è½½ï¼Œæœ€åå†å°†å°æ–‡ä»¶ç»„è£…æˆå¤§æ–‡ä»¶ï¼› ã€Œæ–­ç‚¹ç»­ä¼ ã€ï¼šåœ¨æ–‡ä»¶åˆ†å—çš„åŸºç¡€ä¸Šï¼Œå°†æ¯ä¸ªå°æ–‡ä»¶é‡‡ç”¨å•ç‹¬çš„çº¿ç¨‹è¿›è¡Œä¸Šä¼ \ä¸‹è½½ï¼Œå¦‚æœç¢°åˆ°ç½‘ç»œæ•…éšœï¼Œå¯ä»¥ä»å·²ç»ä¸Šä¼ \ä¸‹è½½çš„éƒ¨åˆ†å¼€å§‹ç»§ç»­ä¸Šä¼ \ä¸‹è½½æœªå®Œæˆçš„éƒ¨åˆ†ï¼Œè€Œæ²¡æœ‰å¿…è¦ä»å¤´å¼€å§‹ä¸Šä¼ \ä¸‹è½½ï¼› ã€Œæ–‡ä»¶ç§’ä¼ ã€ï¼šèµ„æºæœåŠ¡å™¨ä¸­å·²ç»å­˜åœ¨è¯¥æ–‡ä»¶ï¼Œå…¶ä»–äººä¸Šä¼ æ—¶ç›´æ¥è¿”å›è¯¥æ–‡ä»¶çš„URIã€‚ æœ¬æ–‡å°†ä»‹ç»SpringBootä¸­å®ç°å¤§æ–‡ä»¶ä¸Šä¼ çš„ä¸»è¦ä»£ç ï¼š"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-07-03T00:00:00+00:00"><meta property="article:modified_time" content="2023-07-03T00:00:00+00:00"><meta property="article:tag" content="SpringBoot"><meta name=twitter:card content="summary"><meta name=twitter:title content="SpringBootå®ç°å¤§æ–‡ä»¶ä¸Šä¼ "><meta name=twitter:description content="å¤§æ–‡ä»¶ä¸Šä¼ æ˜¯æé«˜ç”¨æˆ·ä½“éªŒæ„Ÿçš„é‡è¦åŠŸèƒ½ï¼Œåƒç™¾åº¦ç½‘ç›˜ã€é˜¿é‡Œç½‘ç›˜ç­‰ç­‰éƒ½æ”¯æŒæ–­ç‚¹ç»­ä¼ å’Œæ–‡ä»¶ç§’ä¼ åŠŸèƒ½ï¼Œå‡å°‘äº†ç½‘ç»œæ³¢åŠ¨å’Œç½‘ç»œå¸¦å®½å¯¹æ–‡ä»¶çš„é™åˆ¶ã€‚

ã€Œæ–‡ä»¶åˆ†å—ã€ï¼šå°†å¤§æ–‡ä»¶æ‹†åˆ†æˆå°æ–‡ä»¶ï¼Œå°†å°æ–‡ä»¶ä¸Šä¼ \ä¸‹è½½ï¼Œæœ€åå†å°†å°æ–‡ä»¶ç»„è£…æˆå¤§æ–‡ä»¶ï¼›
ã€Œæ–­ç‚¹ç»­ä¼ ã€ï¼šåœ¨æ–‡ä»¶åˆ†å—çš„åŸºç¡€ä¸Šï¼Œå°†æ¯ä¸ªå°æ–‡ä»¶é‡‡ç”¨å•ç‹¬çš„çº¿ç¨‹è¿›è¡Œä¸Šä¼ \ä¸‹è½½ï¼Œå¦‚æœç¢°åˆ°ç½‘ç»œæ•…éšœï¼Œå¯ä»¥ä»å·²ç»ä¸Šä¼ \ä¸‹è½½çš„éƒ¨åˆ†å¼€å§‹ç»§ç»­ä¸Šä¼ \ä¸‹è½½æœªå®Œæˆçš„éƒ¨åˆ†ï¼Œè€Œæ²¡æœ‰å¿…è¦ä»å¤´å¼€å§‹ä¸Šä¼ \ä¸‹è½½ï¼›
ã€Œæ–‡ä»¶ç§’ä¼ ã€ï¼šèµ„æºæœåŠ¡å™¨ä¸­å·²ç»å­˜åœ¨è¯¥æ–‡ä»¶ï¼Œå…¶ä»–äººä¸Šä¼ æ—¶ç›´æ¥è¿”å›è¯¥æ–‡ä»¶çš„URIã€‚

æœ¬æ–‡å°†ä»‹ç»SpringBootä¸­å®ç°å¤§æ–‡ä»¶ä¸Šä¼ çš„ä¸»è¦ä»£ç ï¼š"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"ğŸ“š åšå®¢","item":"https://lesanouo.github.io/blog/posts/"},{"@type":"ListItem","position":2,"name":"SpringBootå®ç°å¤§æ–‡ä»¶ä¸Šä¼ ","item":"https://lesanouo.github.io/blog/posts/code/168831360001/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"SpringBootå®ç°å¤§æ–‡ä»¶ä¸Šä¼ ","name":"SpringBootå®ç°å¤§æ–‡ä»¶ä¸Šä¼ ","description":"å¤§æ–‡ä»¶ä¸Šä¼ æ˜¯æé«˜ç”¨æˆ·ä½“éªŒæ„Ÿçš„é‡è¦åŠŸèƒ½ï¼Œåƒç™¾åº¦ç½‘ç›˜ã€é˜¿é‡Œç½‘ç›˜ç­‰ç­‰éƒ½æ”¯æŒæ–­ç‚¹ç»­ä¼ å’Œæ–‡ä»¶ç§’ä¼ åŠŸèƒ½ï¼Œå‡å°‘äº†ç½‘ç»œæ³¢åŠ¨å’Œç½‘ç»œå¸¦å®½å¯¹æ–‡ä»¶çš„é™åˆ¶ã€‚\nã€Œæ–‡ä»¶åˆ†å—ã€ï¼šå°†å¤§æ–‡ä»¶æ‹†åˆ†æˆå°æ–‡ä»¶ï¼Œå°†å°æ–‡ä»¶ä¸Šä¼ \\ä¸‹è½½ï¼Œæœ€åå†å°†å°æ–‡ä»¶ç»„è£…æˆå¤§æ–‡ä»¶ï¼› ã€Œæ–­ç‚¹ç»­ä¼ ã€ï¼šåœ¨æ–‡ä»¶åˆ†å—çš„åŸºç¡€ä¸Šï¼Œå°†æ¯ä¸ªå°æ–‡ä»¶é‡‡ç”¨å•ç‹¬çš„çº¿ç¨‹è¿›è¡Œä¸Šä¼ \\ä¸‹è½½ï¼Œå¦‚æœç¢°åˆ°ç½‘ç»œæ•…éšœï¼Œå¯ä»¥ä»å·²ç»ä¸Šä¼ \\ä¸‹è½½çš„éƒ¨åˆ†å¼€å§‹ç»§ç»­ä¸Šä¼ \\ä¸‹è½½æœªå®Œæˆçš„éƒ¨åˆ†ï¼Œè€Œæ²¡æœ‰å¿…è¦ä»å¤´å¼€å§‹ä¸Šä¼ \\ä¸‹è½½ï¼› ã€Œæ–‡ä»¶ç§’ä¼ ã€ï¼šèµ„æºæœåŠ¡å™¨ä¸­å·²ç»å­˜åœ¨è¯¥æ–‡ä»¶ï¼Œå…¶ä»–äººä¸Šä¼ æ—¶ç›´æ¥è¿”å›è¯¥æ–‡ä»¶çš„URIã€‚ æœ¬æ–‡å°†ä»‹ç»SpringBootä¸­å®ç°å¤§æ–‡ä»¶ä¸Šä¼ çš„ä¸»è¦ä»£ç ï¼š\n","keywords":["SpringBoot"],"articleBody":"å¤§æ–‡ä»¶ä¸Šä¼ æ˜¯æé«˜ç”¨æˆ·ä½“éªŒæ„Ÿçš„é‡è¦åŠŸèƒ½ï¼Œåƒç™¾åº¦ç½‘ç›˜ã€é˜¿é‡Œç½‘ç›˜ç­‰ç­‰éƒ½æ”¯æŒæ–­ç‚¹ç»­ä¼ å’Œæ–‡ä»¶ç§’ä¼ åŠŸèƒ½ï¼Œå‡å°‘äº†ç½‘ç»œæ³¢åŠ¨å’Œç½‘ç»œå¸¦å®½å¯¹æ–‡ä»¶çš„é™åˆ¶ã€‚\nã€Œæ–‡ä»¶åˆ†å—ã€ï¼šå°†å¤§æ–‡ä»¶æ‹†åˆ†æˆå°æ–‡ä»¶ï¼Œå°†å°æ–‡ä»¶ä¸Šä¼ \\ä¸‹è½½ï¼Œæœ€åå†å°†å°æ–‡ä»¶ç»„è£…æˆå¤§æ–‡ä»¶ï¼› ã€Œæ–­ç‚¹ç»­ä¼ ã€ï¼šåœ¨æ–‡ä»¶åˆ†å—çš„åŸºç¡€ä¸Šï¼Œå°†æ¯ä¸ªå°æ–‡ä»¶é‡‡ç”¨å•ç‹¬çš„çº¿ç¨‹è¿›è¡Œä¸Šä¼ \\ä¸‹è½½ï¼Œå¦‚æœç¢°åˆ°ç½‘ç»œæ•…éšœï¼Œå¯ä»¥ä»å·²ç»ä¸Šä¼ \\ä¸‹è½½çš„éƒ¨åˆ†å¼€å§‹ç»§ç»­ä¸Šä¼ \\ä¸‹è½½æœªå®Œæˆçš„éƒ¨åˆ†ï¼Œè€Œæ²¡æœ‰å¿…è¦ä»å¤´å¼€å§‹ä¸Šä¼ \\ä¸‹è½½ï¼› ã€Œæ–‡ä»¶ç§’ä¼ ã€ï¼šèµ„æºæœåŠ¡å™¨ä¸­å·²ç»å­˜åœ¨è¯¥æ–‡ä»¶ï¼Œå…¶ä»–äººä¸Šä¼ æ—¶ç›´æ¥è¿”å›è¯¥æ–‡ä»¶çš„URIã€‚ æœ¬æ–‡å°†ä»‹ç»SpringBootä¸­å®ç°å¤§æ–‡ä»¶ä¸Šä¼ çš„ä¸»è¦ä»£ç ï¼š\næ–‡ä»¶åˆ†å— æ–‡ä»¶åˆ†å—éœ€è¦åœ¨å‰ç«¯å¤„ç†ï¼Œå‰ç«¯é€šè¿‡è·å–æ–‡ä»¶çš„å”¯ä¸€md5çš„å€¼æ¥åŒºåˆ†ä¸åŒæ–‡ä»¶ï¼Œé€šè¿‡ç¡®å®šæ–‡ä»¶åˆ†å—çš„å¤§å°å’Œåˆ†å—çš„æ•°é‡ï¼Œä¸ºæ¯ä¸€ä¸ªåˆ†å—æŒ‡å®šä¸€ä¸ªç´¢å¼•å€¼åä¸Šä¼ ä¸åŒå—æ–‡ä»¶ã€‚\né€šè¿‡md5ä¹Ÿå¯ä»¥ç”¨æ¥æ ¡éªŒæœåŠ¡å™¨ä¸Šæ˜¯å¦å­˜åœ¨è¯¥æ–‡ä»¶ä»¥åŠæ–‡ä»¶çš„ä¸Šä¼ çŠ¶æ€ã€‚\nå¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œç›´æ¥è¿”å›æ–‡ä»¶åœ°å€ï¼› å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½†æ˜¯æœ‰ä¸Šä¼ çŠ¶æ€ï¼Œå³éƒ¨åˆ†åˆ†å—ä¸Šä¼ æˆåŠŸï¼Œåˆ™è¿”å›æœªä¸Šä¼ çš„åˆ†å—ç´¢å¼•æ•°ç»„ï¼› å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¸”ä¸Šä¼ çŠ¶æ€ä¸ºç©ºï¼Œåˆ™æ‰€æœ‰åˆ†å—å‡éœ€è¦ä¸Šä¼ ã€‚ const readFileMD5 = () =\u003e { let fileReader = new FileReader(); fileReader.readAsBinaryString(file) fileReader.addEventListener(\"load\", (e) =\u003e { let fileBlob = e.target.result fileMD5 = md5(fileBlob) const formData = new FormData(); formData.append(\"md5\", fileMD5) axios .post(\"http://localhost:9191/fileUpload/checkFileMd5\", formData) .then((res) =\u003e { if (res.data.message == \"æ–‡ä»¶å·²å­˜åœ¨\") { //æ–‡ä»¶å·²å­˜åœ¨ä¸èµ°åé¢åˆ†ç‰‡äº†ï¼Œç›´æ¥è¿”å›æ–‡ä»¶åœ°å€åˆ°å‰å°é¡µé¢ console.log(res.data) } else { //æ–‡ä»¶ä¸å­˜åœ¨å­˜åœ¨ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯è¿”å›dataï¼šnullä»£è¡¨æœªä¸Šä¼ è¿‡ ä¸€ç§æ˜¯data:[xxï¼Œxx] è¿˜æœ‰å“ªå‡ ç‰‡æœªä¸Šä¼  if (res.data.data != null) { //è¿˜æœ‰å‡ ç‰‡æœªä¸Šä¼ æƒ…å†µï¼Œæ–­ç‚¹ç»­ä¼  chunkArr = res.data.data; } readChunkMD5(); } }) .catch((e) =\u003e { }) }) } é€šè¿‡sliceæ–¹æ³•æ¥å–å‡ºç´¢å¼•åœ¨æ–‡ä»¶ä¸­å¯¹åº”ä½ç½®çš„åˆ†å—ã€‚\nconst getChunkInfo = (file, currentChunk, chunkSize) =\u003e { let start = currentChunk * chunkSize let end = Math.min(file.size, start + chunkSize) let chunk = file.slice(start, end) return {start, end, chunk} } æ–­ç‚¹ç»­ä¼ ã€æ–‡ä»¶ç§’ä¼  é€šè¿‡redisæ¥å­˜å‚¨ä¸Šä¼ æ–‡ä»¶çš„çŠ¶æ€å’Œä¸Šä¼ æ–‡ä»¶çš„åœ°å€ã€‚\nå¦‚æœæ–‡ä»¶å®Œæ•´ä¸Šä¼ ï¼Œè¿”å›æ–‡ä»¶è·¯å¾„ï¼›å¦‚æœéƒ¨åˆ†ä¸Šä¼ åˆ™è¿”å›æœªä¸Šä¼ çš„åˆ†å—æ•°ç»„ï¼›å¦‚æœæœªä¸Šä¼ è¿‡è¿”å›æç¤ºä¿¡æ¯ã€‚\nNote: åœ¨ä¸Šä¼ åˆ†å—æ—¶ä¼šäº§ç”Ÿä¸¤ä¸ªæ–‡ä»¶ï¼Œä¸€ä¸ªæ˜¯æ–‡ä»¶ä¸»ä½“ï¼Œä¸€ä¸ªæ˜¯ä¸´æ—¶æ–‡ä»¶ã€‚ä¸´æ—¶æ–‡ä»¶å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªæ•°ç»„æ–‡ä»¶ï¼Œä¸ºæ¯ä¸€ä¸ªåˆ†å—åˆ†é…ä¸€ä¸ªå€¼ä¸º127çš„å­—èŠ‚ã€‚\næ ¡éªŒMD5å€¼æ—¶ä¼šç”¨åˆ°ä¸¤ä¸ªå€¼ï¼š\næ–‡ä»¶ä¸Šä¼ çŠ¶æ€ï¼šåªè¦è¯¥æ–‡ä»¶ä¸Šä¼ è¿‡å°±ä¸ä¸ºç©ºï¼Œå¦‚æœå®Œæ•´ä¸Šä¼ åˆ™ä¸ºtrueï¼Œéƒ¨åˆ†ä¸Šä¼ è¿”å›falseï¼› æ–‡ä»¶ä¸Šä¼ åœ°å€ï¼šå¦‚æœæ–‡ä»¶å®Œæ•´ä¸Šä¼ ï¼Œè¿”å›æ–‡ä»¶è·¯å¾„ï¼›éƒ¨åˆ†ä¸Šä¼ è¿”å›ä¸´æ—¶æ–‡ä»¶è·¯å¾„ã€‚ @PostMapping(\"/checkFileMd5\") @ResponseBody public Result checkFileMd5(String md5) throws IOException { Object processingObj = stringRedisTemplate.opsForHash().get(UploadConstants.FILE_UPLOAD_STATUS, md5); if (processingObj == null) { return Result.ok(\"è¯¥æ–‡ä»¶æ²¡æœ‰ä¸Šä¼ è¿‡\"); } boolean processing = Boolean.parseBoolean(processingObj.toString()); String value = stringRedisTemplate.opsForValue().get(UploadConstants.FILE_MD5_KEY + md5); if (processing) { return Result.ok(value, \"æ–‡ä»¶å·²å­˜åœ¨\"); } else { File confFile = new File(value); byte[] completeList = FileUtil.readBytes(confFile); List\u003cInteger\u003e missChunkList = new LinkedList\u003c\u003e(); for (int i = 0; i \u003c completeList.length; i++) { if (completeList[i] != Byte.MAX_VALUE) { missChunkList.add(i); } } return Result.ok(missChunkList, \"è¯¥æ–‡ä»¶ä¸Šä¼ äº†ä¸€éƒ¨åˆ†\"); } } åˆ†å—ä¸Šä¼ ã€æ–‡ä»¶åˆå¹¶ ä¸Šé¢åˆ©ç”¨æ–‡ä»¶çš„md5å€¼æ¥ç»´æŠ¤åˆ†å—å’Œæ–‡ä»¶çš„å…³ç³»ï¼Œå› æ­¤æˆ‘ä»¬ä¼šå°†å…·æœ‰ç›¸åŒmd5å€¼çš„åˆ†å—è¿›è¡Œåˆå¹¶ï¼Œç”±äºæ¯ä¸ªåˆ†å—éƒ½æœ‰è‡ªå·±çš„ç´¢å¼•å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šå°†åˆ†å—æŒ‰ç´¢å¼•åƒæ’å…¥æ•°ç»„ä¸€æ ·åˆ†åˆ«æ’å…¥æ–‡ä»¶ä¸­ï¼Œå½¢æˆå®Œæ•´çš„æ–‡ä»¶ã€‚\nåˆ†å—ä¸Šä¼ æ—¶ï¼Œè¦å’Œå‰ç«¯çš„åˆ†å—å¤§å°ã€åˆ†å—æ•°é‡ã€å½“å‰åˆ†å—ç´¢å¼•ç­‰å¯¹åº”å¥½ï¼Œä»¥å¤‡æ–‡ä»¶åˆå¹¶æ—¶ä½¿ç”¨ï¼Œæ­¤å¤„æˆ‘ä»¬é‡‡ç”¨çš„æ˜¯ç£ç›˜æ˜ å°„çš„æ–¹å¼æ¥åˆå¹¶æ–‡ä»¶ã€‚\npublic boolean uploadFileByMappedByteBuffer(MultipartFileDTO multipartFileDTO) throws IOException { // è·¯å¾„ï¼šæœåŠ¡å™¨å­˜å‚¨åœ°å€/md5å­—ç¬¦ä¸² String uploadDirPath = finalDirPath + multipartFileDTO.getMd5(); File tmpDir = new File(uploadDirPath); if (!tmpDir.exists()) { tmpDir.mkdirs(); } String fileName = multipartFileDTO.getName(); // ä¸´æ—¶æ–‡ä»¶å String tempFileName = fileName + \"_tmp\"; File tmpFile = new File(uploadDirPath, tempFileName); // è¯»æ“ä½œå’Œå†™æ“ä½œéƒ½æ˜¯å…è®¸çš„ RandomAccessFile tempRaf = new RandomAccessFile(tmpFile, \"rw\"); //å®ƒè¿”å›çš„å°±æ˜¯nioé€šä¿¡ä¸­çš„fileçš„å”¯ä¸€channel FileChannel fileChannel = tempRaf.getChannel(); // å†™å…¥è¯¥åˆ†ç‰‡æ•°æ® åˆ†ç‰‡å¤§å° * ç¬¬å‡ å—åˆ†ç‰‡è·å–åç§»é‡ long offset = CHUNK_SIZE * multipartFileDTO.getChunk(); // åˆ†ç‰‡æ–‡ä»¶å¤§å° byte[] fileData = multipartFileDTO.getFile().getBytes(); // å°†æ–‡ä»¶çš„åŒºåŸŸç›´æ¥æ˜ å°„åˆ°å†…å­˜ MappedByteBuffer mappedByteBuffer = fileChannel.map(FileChannel.MapMode.READ_WRITE, offset, fileData.length); mappedByteBuffer.put(fileData); // é‡Šæ”¾ FileMD5Util.freedMappedByteBuffer(mappedByteBuffer); fileChannel.close(); boolean isOk = checkAndSetUploadProgress(multipartFileDTO, uploadDirPath); if (isOk) { boolean flag = renameFile(tmpFile, fileName); System.out.println(\"upload complete !!\" + flag + \" name=\" + fileName); return flag; } return false; } public boolean renameFile(File toBeRenamed, String toFileNewName) { // æ£€æŸ¥è¦é‡å‘½åçš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œæ˜¯å¦æ˜¯æ–‡ä»¶ if (!toBeRenamed.exists() || toBeRenamed.isDirectory()) { log.info(\"File does not exist: \" + toBeRenamed.getName()); return false; } String p = toBeRenamed.getParent(); File newFile = new File(p + File.separatorChar + toFileNewName); // ä¿®æ”¹æ–‡ä»¶å return toBeRenamed.renameTo(newFile); } æ¯å½“å®Œæˆä¸€æ¬¡åˆ†å—çš„ä¸Šä¼ ï¼Œè¿˜éœ€è¦å»æ£€æŸ¥æ–‡ä»¶çš„ä¸Šä¼ è¿›åº¦ï¼Œçœ‹æ–‡ä»¶æ˜¯å¦ä¸Šä¼ å®Œæˆã€‚\nprivate boolean checkAndSetUploadProgress(MultipartFileDTO multipartFileDTO, String uploadDirPath) throws IOException { String fileName = multipartFileDTO.getName(); // è·¯å¾„/filename.conf File confFile = new File(uploadDirPath, fileName + \".conf\"); RandomAccessFile accessConfFile = new RandomAccessFile(confFile, \"rw\"); // æŠŠè¯¥åˆ†æ®µæ ‡è®°ä¸º true è¡¨ç¤ºå®Œæˆ System.out.println(\"set part \" + multipartFileDTO.getChunk() + \" complete\"); accessConfFile.setLength(multipartFileDTO.getChunks()); accessConfFile.seek(multipartFileDTO.getChunk()); accessConfFile.write(Byte.MAX_VALUE); // completeList æ£€æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆ,å¦‚æœæ•°ç»„é‡Œæ˜¯å¦å…¨éƒ¨éƒ½æ˜¯(å…¨éƒ¨åˆ†ç‰‡éƒ½æˆåŠŸä¸Šä¼ ) byte[] completeList = FileUtil.readBytes(confFile); byte isComplete = Byte.MAX_VALUE; for (int i = 0; i \u003c completeList.length \u0026\u0026 isComplete == Byte.MAX_VALUE; i++) { //ä¸è¿ç®—, å¦‚æœæœ‰éƒ¨åˆ†æ²¡æœ‰å®Œæˆåˆ™ isComplete ä¸æ˜¯ Byte.MAX_VALUE isComplete = (byte) (isComplete \u0026 completeList[i]); System.out.println(\"check part \" + i + \" complete?:\" + completeList[i]); } accessConfFile.close(); // æ›´æ–°redisä¸­çš„çŠ¶æ€ï¼šå¦‚æœæ˜¯trueçš„è¯è¯æ˜æ˜¯å·²ç»è¯¥å¤§æ–‡ä»¶å…¨éƒ¨ä¸Šä¼ å®Œæˆ if (isComplete == Byte.MAX_VALUE) { stringRedisTemplate.opsForHash().put(UploadConstants.FILE_UPLOAD_STATUS, multipartFileDTO.getMd5(), \"true\"); stringRedisTemplate.opsForValue().set(UploadConstants.FILE_MD5_KEY + multipartFileDTO.getMd5(), uploadDirPath + \"/\" + fileName); return true; } else { if (!stringRedisTemplate.opsForHash().hasKey(UploadConstants.FILE_UPLOAD_STATUS, multipartFileDTO.getMd5())) { stringRedisTemplate.opsForHash().put(UploadConstants.FILE_UPLOAD_STATUS, multipartFileDTO.getMd5(), \"false\"); } if (!stringRedisTemplate.hasKey(UploadConstants.FILE_MD5_KEY + multipartFileDTO.getMd5())) { stringRedisTemplate.opsForValue().set(UploadConstants.FILE_MD5_KEY + multipartFileDTO.getMd5(), uploadDirPath + \"/\" + fileName + \".conf\"); } return false; } } åœ¨MappedByteBufferé‡Šæ”¾åå†å¯¹å®ƒè¿›è¡Œè¯»æ“ä½œçš„è¯å°±ä¼šå¼•å‘jvm crashï¼Œåœ¨å¹¶å‘æƒ…å†µä¸‹å¾ˆå®¹æ˜“å‘ç”Ÿæ­£åœ¨é‡Šæ”¾æ—¶å¦ä¸€ä¸ªçº¿ç¨‹æ­£å¼€å§‹è¯»å–ï¼Œäºæ˜¯crashå°±å‘ç”Ÿäº†ã€‚æ‰€ä»¥ä¸ºäº†ç³»ç»Ÿç¨³å®šæ€§é‡Šæ”¾å‰ä¸€èˆ¬éœ€è¦æ£€æŸ¥æ˜¯å¦è¿˜æœ‰çº¿ç¨‹åœ¨è¯»æˆ–å†™ã€‚\npublic static void freedMappedByteBuffer(final MappedByteBuffer mappedByteBuffer) { try { if (mappedByteBuffer == null) { return; } mappedByteBuffer.force(); AccessController.doPrivileged(new PrivilegedAction\u003cObject\u003e() { @Override public Object run() { try { Method getCleanerMethod = mappedByteBuffer.getClass().getMethod(\"cleaner\", new Class[0]); getCleanerMethod.setAccessible(true); sun.misc.Cleaner cleaner = (sun.misc.Cleaner) getCleanerMethod.invoke(mappedByteBuffer, new Object[0]); cleaner.clean(); } catch (Exception e) { log.error(\"clean MappedByteBuffer error!!!\", e); } log.info(\"clean MappedByteBuffer completed!!!\"); return null; } }); } catch (Exception e) { e.printStackTrace(); } } æŠ€æœ¯ç‚¹ RandomAccessFile RandomAccessFileç›¸å½“äºæ˜¯FileInputStreamä¸FileOutputStreamçš„å°è£…ç»“åˆï¼Œå³å¯ä»¥è¯»ä¹Ÿå¯ä»¥å†™ï¼Œå¹¶ä¸”RandomAccessFileæ”¯æŒç§»åŠ¨åˆ°æ–‡ä»¶æŒ‡å®šä½ç½®å¤„å¼€å§‹è¯»æˆ–å†™ã€‚\nMappedByteBuffer MappedByteBufferæ˜¯Javaæä¾›çš„åŸºäºæ“ä½œç³»ç»Ÿè™šæ‹Ÿå†…å­˜æ˜ å°„ï¼ˆMMAPï¼‰æŠ€æœ¯çš„æ–‡ä»¶è¯»å†™APIï¼Œåº•å±‚ä¸å†é€šè¿‡readã€writeã€seekç­‰ç³»ç»Ÿè°ƒç”¨å®ç°æ–‡ä»¶çš„è¯»å†™ã€‚\nAccessController.doPrivileged() AccessController.doPrivilegedæ˜¯ä¸€ä¸ªåœ¨AccessControllerç±»ä¸­çš„é™æ€æ–¹æ³•ï¼Œå…è®¸åœ¨ä¸€ä¸ªç±»å®ä¾‹ä¸­çš„ä»£ç é€šçŸ¥è¿™ä¸ªAccessControllerï¼šå®ƒçš„ä»£ç ä¸»ä½“æ˜¯äº«å—\"privileged(ç‰¹æƒçš„)\"ï¼Œå®ƒå•ç‹¬è´Ÿè´£å¯¹å®ƒçš„å¯å¾—çš„èµ„æºçš„è®¿é—®è¯·æ±‚ï¼Œè€Œä¸ç®¡è¿™ä¸ªè¯·æ±‚æ˜¯ç”±ä»€ä¹ˆä»£ç æ‰€å¼•å‘çš„ã€‚ è¿™å°±æ˜¯è¯´ï¼Œä¸€ä¸ªè°ƒç”¨è€…åœ¨è°ƒç”¨doPrivilegedæ–¹æ³•æ—¶ï¼Œå¯è¢«æ ‡è¯†ä¸º â€œç‰¹æƒâ€ã€‚åœ¨åšè®¿é—®æ§åˆ¶å†³ç­–æ—¶ï¼Œå¦‚æœcheckPermissionæ–¹æ³•é‡åˆ°ä¸€ä¸ªé€šè¿‡doPrivilegedè°ƒç”¨è€Œè¢«è¡¨ç¤ºä¸º â€œç‰¹æƒ\"çš„è°ƒç”¨è€…ï¼Œå¹¶ä¸”æ²¡æœ‰ä¸Šä¸‹æ–‡è‡ªå˜é‡ï¼ŒcheckPermissionæ–¹æ³•åˆ™å°†ç»ˆæ­¢æ£€æŸ¥ã€‚å¦‚æœé‚£ä¸ªè°ƒç”¨è€…çš„åŸŸå…·æœ‰ç‰¹å®šçš„è®¸å¯ï¼Œåˆ™ä¸åšè¿›ä¸€æ­¥æ£€æŸ¥ï¼ŒcheckPermissionå®‰é™åœ°è¿”å›ï¼Œè¡¨ç¤ºé‚£ä¸ªè®¿é—®è¯·æ±‚æ˜¯è¢«å…è®¸çš„ï¼›å¦‚æœé‚£ä¸ªåŸŸæ²¡æœ‰ç‰¹å®šçš„è®¸å¯ï¼Œåˆ™è±¡é€šå¸¸ä¸€æ ·ï¼Œä¸€ä¸ªå¼‚å¸¸è¢«æŠ›å‡ºã€‚\næœ¬æ–‡å‚è€ƒè‡ªï¼š https://gitee.com/zhangxiaoQ/large-file-upload.git\n","wordCount":"2601","inLanguage":"zh-cn","datePublished":"2023-07-03T00:00:00Z","dateModified":"2023-07-03T00:00:00Z","author":{"@type":"Person","name":"Lesan"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://lesanouo.github.io/blog/posts/code/168831360001/"},"publisher":{"@type":"Organization","name":"Lesan's Blog","logo":{"@type":"ImageObject","url":"https://lesanouo.github.io/blog/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://lesanouo.github.io/blog/ accesskey=h title="Lesan's Blog (Alt + H)">Lesan's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://lesanouo.github.io/blog/archives title="ğŸ“š å½’æ¡£"><span>ğŸ“š å½’æ¡£</span></a></li><li><a href=https://lesanouo.github.io/blog/categories/ title="ğŸ—ƒï¸ åˆ†ç±»"><span>ğŸ—ƒï¸ åˆ†ç±»</span></a></li><li><a href=https://lesanouo.github.io/blog/tags/ title="ğŸ·ï¸ æ ‡ç­¾"><span>ğŸ·ï¸ æ ‡ç­¾</span></a></li><li><a href=https://lesanouo.github.io/blog/search/ title="ğŸ” æœç´¢"><span>ğŸ” æœç´¢</span></a></li><li><a href=https://lesanouo.github.io/blog/about/ title="ğŸ‘¨â€ğŸ’» å…³äºæˆ‘"><span>ğŸ‘¨â€ğŸ’» å…³äºæˆ‘</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://lesanouo.github.io/blog/>Home</a>&nbsp;Â»&nbsp;<a href=https://lesanouo.github.io/blog/posts/>ğŸ“š åšå®¢</a></div><h1 class="post-title entry-hint-parent">SpringBootå®ç°å¤§æ–‡ä»¶ä¸Šä¼ </h1><div class=post-meta><span title='2023-07-03 00:00:00 +0000 UTC'>2023-07-03</span>&nbsp;Â·&nbsp;6 min&nbsp;Â·&nbsp;Lesan</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e6%96%87%e4%bb%b6%e5%88%86%e5%9d%97 aria-label=æ–‡ä»¶åˆ†å—>æ–‡ä»¶åˆ†å—</a></li><li><a href=#%e6%96%ad%e7%82%b9%e7%bb%ad%e4%bc%a0%e6%96%87%e4%bb%b6%e7%a7%92%e4%bc%a0 aria-label=æ–­ç‚¹ç»­ä¼ ã€æ–‡ä»¶ç§’ä¼ >æ–­ç‚¹ç»­ä¼ ã€æ–‡ä»¶ç§’ä¼ </a></li><li><a href=#%e5%88%86%e5%9d%97%e4%b8%8a%e4%bc%a0%e6%96%87%e4%bb%b6%e5%90%88%e5%b9%b6 aria-label=åˆ†å—ä¸Šä¼ ã€æ–‡ä»¶åˆå¹¶>åˆ†å—ä¸Šä¼ ã€æ–‡ä»¶åˆå¹¶</a></li><li><a href=#%e6%8a%80%e6%9c%af%e7%82%b9 aria-label=æŠ€æœ¯ç‚¹>æŠ€æœ¯ç‚¹</a><ul><li><a href=#randomaccessfile aria-label=RandomAccessFile>RandomAccessFile</a></li><li><a href=#mappedbytebuffer aria-label=MappedByteBuffer>MappedByteBuffer</a></li><li><a href=#accesscontrollerdoprivileged aria-label=AccessController.doPrivileged()>AccessController.doPrivileged()</a></li></ul></li></ul></div></details></div><div class=post-content><p>å¤§æ–‡ä»¶ä¸Šä¼ æ˜¯æé«˜ç”¨æˆ·ä½“éªŒæ„Ÿçš„é‡è¦åŠŸèƒ½ï¼Œåƒç™¾åº¦ç½‘ç›˜ã€é˜¿é‡Œç½‘ç›˜ç­‰ç­‰éƒ½æ”¯æŒæ–­ç‚¹ç»­ä¼ å’Œæ–‡ä»¶ç§’ä¼ åŠŸèƒ½ï¼Œå‡å°‘äº†ç½‘ç»œæ³¢åŠ¨å’Œç½‘ç»œå¸¦å®½å¯¹æ–‡ä»¶çš„é™åˆ¶ã€‚</p><ul><li>ã€Œæ–‡ä»¶åˆ†å—ã€ï¼šå°†å¤§æ–‡ä»¶æ‹†åˆ†æˆå°æ–‡ä»¶ï¼Œå°†å°æ–‡ä»¶ä¸Šä¼ \ä¸‹è½½ï¼Œæœ€åå†å°†å°æ–‡ä»¶ç»„è£…æˆå¤§æ–‡ä»¶ï¼›</li><li>ã€Œæ–­ç‚¹ç»­ä¼ ã€ï¼šåœ¨æ–‡ä»¶åˆ†å—çš„åŸºç¡€ä¸Šï¼Œå°†æ¯ä¸ªå°æ–‡ä»¶é‡‡ç”¨å•ç‹¬çš„çº¿ç¨‹è¿›è¡Œä¸Šä¼ \ä¸‹è½½ï¼Œå¦‚æœç¢°åˆ°ç½‘ç»œæ•…éšœï¼Œå¯ä»¥ä»å·²ç»ä¸Šä¼ \ä¸‹è½½çš„éƒ¨åˆ†å¼€å§‹ç»§ç»­ä¸Šä¼ \ä¸‹è½½æœªå®Œæˆçš„éƒ¨åˆ†ï¼Œè€Œæ²¡æœ‰å¿…è¦ä»å¤´å¼€å§‹ä¸Šä¼ \ä¸‹è½½ï¼›</li><li>ã€Œæ–‡ä»¶ç§’ä¼ ã€ï¼šèµ„æºæœåŠ¡å™¨ä¸­å·²ç»å­˜åœ¨è¯¥æ–‡ä»¶ï¼Œå…¶ä»–äººä¸Šä¼ æ—¶ç›´æ¥è¿”å›è¯¥æ–‡ä»¶çš„URIã€‚</li></ul><p>æœ¬æ–‡å°†ä»‹ç»SpringBootä¸­å®ç°å¤§æ–‡ä»¶ä¸Šä¼ çš„ä¸»è¦ä»£ç ï¼š</p><h2 id=æ–‡ä»¶åˆ†å—>æ–‡ä»¶åˆ†å—<a hidden class=anchor aria-hidden=true href=#æ–‡ä»¶åˆ†å—>#</a></h2><p>æ–‡ä»¶åˆ†å—éœ€è¦åœ¨å‰ç«¯å¤„ç†ï¼Œå‰ç«¯é€šè¿‡è·å–æ–‡ä»¶çš„å”¯ä¸€<code>md5</code>çš„å€¼æ¥åŒºåˆ†ä¸åŒæ–‡ä»¶ï¼Œé€šè¿‡ç¡®å®šæ–‡ä»¶åˆ†å—çš„å¤§å°å’Œåˆ†å—çš„æ•°é‡ï¼Œä¸ºæ¯ä¸€ä¸ªåˆ†å—æŒ‡å®šä¸€ä¸ªç´¢å¼•å€¼åä¸Šä¼ ä¸åŒå—æ–‡ä»¶ã€‚</p><p>é€šè¿‡<code>md5</code>ä¹Ÿå¯ä»¥ç”¨æ¥æ ¡éªŒæœåŠ¡å™¨ä¸Šæ˜¯å¦å­˜åœ¨è¯¥æ–‡ä»¶ä»¥åŠæ–‡ä»¶çš„ä¸Šä¼ çŠ¶æ€ã€‚</p><ul><li>å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œç›´æ¥è¿”å›æ–‡ä»¶åœ°å€ï¼›</li><li>å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½†æ˜¯æœ‰ä¸Šä¼ çŠ¶æ€ï¼Œå³éƒ¨åˆ†åˆ†å—ä¸Šä¼ æˆåŠŸï¼Œåˆ™è¿”å›æœªä¸Šä¼ çš„åˆ†å—ç´¢å¼•æ•°ç»„ï¼›</li><li>å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¸”ä¸Šä¼ çŠ¶æ€ä¸ºç©ºï¼Œåˆ™æ‰€æœ‰åˆ†å—å‡éœ€è¦ä¸Šä¼ ã€‚</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>readFileMD5</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>fileReader</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>FileReader</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>fileReader</span><span class=p>.</span><span class=nx>readAsBinaryString</span><span class=p>(</span><span class=nx>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>fileReader</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s2>&#34;load&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>let</span> <span class=nx>fileBlob</span> <span class=o>=</span> <span class=nx>e</span><span class=p>.</span><span class=nx>target</span><span class=p>.</span><span class=nx>result</span>
</span></span><span class=line><span class=cl>        <span class=nx>fileMD5</span> <span class=o>=</span> <span class=nx>md5</span><span class=p>(</span><span class=nx>fileBlob</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>formData</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>FormData</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=nx>formData</span><span class=p>.</span><span class=nx>append</span><span class=p>(</span><span class=s2>&#34;md5&#34;</span><span class=p>,</span> <span class=nx>fileMD5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>axios</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s2>&#34;http://localhost:9191/fileUpload/checkFileMd5&#34;</span><span class=p>,</span> <span class=nx>formData</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>message</span> <span class=o>==</span> <span class=s2>&#34;æ–‡ä»¶å·²å­˜åœ¨&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>//æ–‡ä»¶å·²å­˜åœ¨ä¸èµ°åé¢åˆ†ç‰‡äº†ï¼Œç›´æ¥è¿”å›æ–‡ä»¶åœ°å€åˆ°å‰å°é¡µé¢
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>//æ–‡ä»¶ä¸å­˜åœ¨å­˜åœ¨ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯è¿”å›dataï¼šnullä»£è¡¨æœªä¸Šä¼ è¿‡ ä¸€ç§æ˜¯data:[xxï¼Œxx] è¿˜æœ‰å“ªå‡ ç‰‡æœªä¸Šä¼ 
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>if</span> <span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>data</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=c1>//è¿˜æœ‰å‡ ç‰‡æœªä¸Šä¼ æƒ…å†µï¼Œæ–­ç‚¹ç»­ä¼ 
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=nx>chunkArr</span> <span class=o>=</span> <span class=nx>res</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=nx>readChunkMD5</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=k>catch</span><span class=p>((</span><span class=nx>e</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>é€šè¿‡<code>slice</code>æ–¹æ³•æ¥å–å‡ºç´¢å¼•åœ¨æ–‡ä»¶ä¸­å¯¹åº”ä½ç½®çš„åˆ†å—ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>getChunkInfo</span> <span class=o>=</span> <span class=p>(</span><span class=nx>file</span><span class=p>,</span> <span class=nx>currentChunk</span><span class=p>,</span> <span class=nx>chunkSize</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>start</span> <span class=o>=</span> <span class=nx>currentChunk</span> <span class=o>*</span> <span class=nx>chunkSize</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>end</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>min</span><span class=p>(</span><span class=nx>file</span><span class=p>.</span><span class=nx>size</span><span class=p>,</span> <span class=nx>start</span> <span class=o>+</span> <span class=nx>chunkSize</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>chunk</span> <span class=o>=</span> <span class=nx>file</span><span class=p>.</span><span class=nx>slice</span><span class=p>(</span><span class=nx>start</span><span class=p>,</span> <span class=nx>end</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=nx>start</span><span class=p>,</span> <span class=nx>end</span><span class=p>,</span> <span class=nx>chunk</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=æ–­ç‚¹ç»­ä¼ æ–‡ä»¶ç§’ä¼ >æ–­ç‚¹ç»­ä¼ ã€æ–‡ä»¶ç§’ä¼ <a hidden class=anchor aria-hidden=true href=#æ–­ç‚¹ç»­ä¼ æ–‡ä»¶ç§’ä¼ >#</a></h2><p>é€šè¿‡<code>redis</code>æ¥å­˜å‚¨ä¸Šä¼ æ–‡ä»¶çš„çŠ¶æ€å’Œä¸Šä¼ æ–‡ä»¶çš„åœ°å€ã€‚</p><p>å¦‚æœæ–‡ä»¶å®Œæ•´ä¸Šä¼ ï¼Œè¿”å›æ–‡ä»¶è·¯å¾„ï¼›å¦‚æœéƒ¨åˆ†ä¸Šä¼ åˆ™è¿”å›æœªä¸Šä¼ çš„åˆ†å—æ•°ç»„ï¼›å¦‚æœæœªä¸Šä¼ è¿‡è¿”å›æç¤ºä¿¡æ¯ã€‚</p><blockquote><p>Note:
åœ¨ä¸Šä¼ åˆ†å—æ—¶ä¼šäº§ç”Ÿä¸¤ä¸ªæ–‡ä»¶ï¼Œä¸€ä¸ªæ˜¯æ–‡ä»¶ä¸»ä½“ï¼Œä¸€ä¸ªæ˜¯ä¸´æ—¶æ–‡ä»¶ã€‚ä¸´æ—¶æ–‡ä»¶å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªæ•°ç»„æ–‡ä»¶ï¼Œä¸ºæ¯ä¸€ä¸ªåˆ†å—åˆ†é…ä¸€ä¸ªå€¼ä¸º127çš„å­—èŠ‚ã€‚</p></blockquote><p>æ ¡éªŒMD5å€¼æ—¶ä¼šç”¨åˆ°ä¸¤ä¸ªå€¼ï¼š</p><ul><li>æ–‡ä»¶ä¸Šä¼ çŠ¶æ€ï¼šåªè¦è¯¥æ–‡ä»¶ä¸Šä¼ è¿‡å°±ä¸ä¸ºç©ºï¼Œå¦‚æœå®Œæ•´ä¸Šä¼ åˆ™ä¸ºtrueï¼Œéƒ¨åˆ†ä¸Šä¼ è¿”å›falseï¼›</li><li>æ–‡ä»¶ä¸Šä¼ åœ°å€ï¼šå¦‚æœæ–‡ä»¶å®Œæ•´ä¸Šä¼ ï¼Œè¿”å›æ–‡ä»¶è·¯å¾„ï¼›éƒ¨åˆ†ä¸Šä¼ è¿”å›ä¸´æ—¶æ–‡ä»¶è·¯å¾„ã€‚</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@PostMapping</span><span class=p>(</span><span class=s>&#34;/checkFileMd5&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@ResponseBody</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>Result</span><span class=w> </span><span class=nf>checkFileMd5</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>md5</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>processingObj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>stringRedisTemplate</span><span class=p>.</span><span class=na>opsForHash</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=n>UploadConstants</span><span class=p>.</span><span class=na>FILE_UPLOAD_STATUS</span><span class=p>,</span><span class=w> </span><span class=n>md5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>processingObj</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Result</span><span class=p>.</span><span class=na>ok</span><span class=p>(</span><span class=s>&#34;è¯¥æ–‡ä»¶æ²¡æœ‰ä¸Šä¼ è¿‡&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=n>processing</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Boolean</span><span class=p>.</span><span class=na>parseBoolean</span><span class=p>(</span><span class=n>processingObj</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>stringRedisTemplate</span><span class=p>.</span><span class=na>opsForValue</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=n>UploadConstants</span><span class=p>.</span><span class=na>FILE_MD5_KEY</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>md5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>processing</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Result</span><span class=p>.</span><span class=na>ok</span><span class=p>(</span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=s>&#34;æ–‡ä»¶å·²å­˜åœ¨&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>File</span><span class=w> </span><span class=n>confFile</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>File</span><span class=p>(</span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>completeList</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>FileUtil</span><span class=p>.</span><span class=na>readBytes</span><span class=p>(</span><span class=n>confFile</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>missChunkList</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LinkedList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>completeList</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>completeList</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>Byte</span><span class=p>.</span><span class=na>MAX_VALUE</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>missChunkList</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Result</span><span class=p>.</span><span class=na>ok</span><span class=p>(</span><span class=n>missChunkList</span><span class=p>,</span><span class=w> </span><span class=s>&#34;è¯¥æ–‡ä»¶ä¸Šä¼ äº†ä¸€éƒ¨åˆ†&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=åˆ†å—ä¸Šä¼ æ–‡ä»¶åˆå¹¶>åˆ†å—ä¸Šä¼ ã€æ–‡ä»¶åˆå¹¶<a hidden class=anchor aria-hidden=true href=#åˆ†å—ä¸Šä¼ æ–‡ä»¶åˆå¹¶>#</a></h2><p>ä¸Šé¢åˆ©ç”¨æ–‡ä»¶çš„<code>md5</code>å€¼æ¥ç»´æŠ¤åˆ†å—å’Œæ–‡ä»¶çš„å…³ç³»ï¼Œå› æ­¤æˆ‘ä»¬ä¼šå°†å…·æœ‰ç›¸åŒ<code>md5</code>å€¼çš„åˆ†å—è¿›è¡Œåˆå¹¶ï¼Œç”±äºæ¯ä¸ªåˆ†å—éƒ½æœ‰è‡ªå·±çš„ç´¢å¼•å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šå°†åˆ†å—æŒ‰ç´¢å¼•åƒæ’å…¥æ•°ç»„ä¸€æ ·åˆ†åˆ«æ’å…¥æ–‡ä»¶ä¸­ï¼Œå½¢æˆå®Œæ•´çš„æ–‡ä»¶ã€‚</p><p>åˆ†å—ä¸Šä¼ æ—¶ï¼Œè¦å’Œå‰ç«¯çš„åˆ†å—å¤§å°ã€åˆ†å—æ•°é‡ã€å½“å‰åˆ†å—ç´¢å¼•ç­‰å¯¹åº”å¥½ï¼Œä»¥å¤‡æ–‡ä»¶åˆå¹¶æ—¶ä½¿ç”¨ï¼Œæ­¤å¤„æˆ‘ä»¬é‡‡ç”¨çš„æ˜¯<strong>ç£ç›˜æ˜ å°„</strong>çš„æ–¹å¼æ¥åˆå¹¶æ–‡ä»¶ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>uploadFileByMappedByteBuffer</span><span class=p>(</span><span class=n>MultipartFileDTO</span><span class=w> </span><span class=n>multipartFileDTO</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è·¯å¾„ï¼šæœåŠ¡å™¨å­˜å‚¨åœ°å€/md5å­—ç¬¦ä¸²</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>uploadDirPath</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>finalDirPath</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>multipartFileDTO</span><span class=p>.</span><span class=na>getMd5</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>File</span><span class=w> </span><span class=n>tmpDir</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>File</span><span class=p>(</span><span class=n>uploadDirPath</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>tmpDir</span><span class=p>.</span><span class=na>exists</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>tmpDir</span><span class=p>.</span><span class=na>mkdirs</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>fileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>multipartFileDTO</span><span class=p>.</span><span class=na>getName</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ä¸´æ—¶æ–‡ä»¶å</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>tempFileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fileName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;_tmp&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>File</span><span class=w> </span><span class=n>tmpFile</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>File</span><span class=p>(</span><span class=n>uploadDirPath</span><span class=p>,</span><span class=w> </span><span class=n>tempFileName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è¯»æ“ä½œå’Œå†™æ“ä½œéƒ½æ˜¯å…è®¸çš„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>RandomAccessFile</span><span class=w> </span><span class=n>tempRaf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RandomAccessFile</span><span class=p>(</span><span class=n>tmpFile</span><span class=p>,</span><span class=w> </span><span class=s>&#34;rw&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//å®ƒè¿”å›çš„å°±æ˜¯nioé€šä¿¡ä¸­çš„fileçš„å”¯ä¸€channel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>FileChannel</span><span class=w> </span><span class=n>fileChannel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tempRaf</span><span class=p>.</span><span class=na>getChannel</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å†™å…¥è¯¥åˆ†ç‰‡æ•°æ®   åˆ†ç‰‡å¤§å° * ç¬¬å‡ å—åˆ†ç‰‡è·å–åç§»é‡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>offset</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>CHUNK_SIZE</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>multipartFileDTO</span><span class=p>.</span><span class=na>getChunk</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// åˆ†ç‰‡æ–‡ä»¶å¤§å°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>fileData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>multipartFileDTO</span><span class=p>.</span><span class=na>getFile</span><span class=p>().</span><span class=na>getBytes</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å°†æ–‡ä»¶çš„åŒºåŸŸç›´æ¥æ˜ å°„åˆ°å†…å­˜</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>MappedByteBuffer</span><span class=w> </span><span class=n>mappedByteBuffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fileChannel</span><span class=p>.</span><span class=na>map</span><span class=p>(</span><span class=n>FileChannel</span><span class=p>.</span><span class=na>MapMode</span><span class=p>.</span><span class=na>READ_WRITE</span><span class=p>,</span><span class=w> </span><span class=n>offset</span><span class=p>,</span><span class=w> </span><span class=n>fileData</span><span class=p>.</span><span class=na>length</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mappedByteBuffer</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>fileData</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// é‡Šæ”¾</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>FileMD5Util</span><span class=p>.</span><span class=na>freedMappedByteBuffer</span><span class=p>(</span><span class=n>mappedByteBuffer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>fileChannel</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=n>isOk</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>checkAndSetUploadProgress</span><span class=p>(</span><span class=n>multipartFileDTO</span><span class=p>,</span><span class=w> </span><span class=n>uploadDirPath</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isOk</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>flag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>renameFile</span><span class=p>(</span><span class=n>tmpFile</span><span class=p>,</span><span class=w> </span><span class=n>fileName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;upload complete !!&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>flag</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; name=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>fileName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>flag</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>renameFile</span><span class=p>(</span><span class=n>File</span><span class=w> </span><span class=n>toBeRenamed</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>toFileNewName</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ£€æŸ¥è¦é‡å‘½åçš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œæ˜¯å¦æ˜¯æ–‡ä»¶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>toBeRenamed</span><span class=p>.</span><span class=na>exists</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>toBeRenamed</span><span class=p>.</span><span class=na>isDirectory</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;File does not exist: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>toBeRenamed</span><span class=p>.</span><span class=na>getName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>toBeRenamed</span><span class=p>.</span><span class=na>getParent</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>File</span><span class=w> </span><span class=n>newFile</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>File</span><span class=p>(</span><span class=n>p</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>File</span><span class=p>.</span><span class=na>separatorChar</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>toFileNewName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ä¿®æ”¹æ–‡ä»¶å</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>toBeRenamed</span><span class=p>.</span><span class=na>renameTo</span><span class=p>(</span><span class=n>newFile</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>æ¯å½“å®Œæˆä¸€æ¬¡åˆ†å—çš„ä¸Šä¼ ï¼Œè¿˜éœ€è¦å»æ£€æŸ¥æ–‡ä»¶çš„ä¸Šä¼ è¿›åº¦ï¼Œçœ‹æ–‡ä»¶æ˜¯å¦ä¸Šä¼ å®Œæˆã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>checkAndSetUploadProgress</span><span class=p>(</span><span class=n>MultipartFileDTO</span><span class=w> </span><span class=n>multipartFileDTO</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>uploadDirPath</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>fileName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>multipartFileDTO</span><span class=p>.</span><span class=na>getName</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è·¯å¾„/filename.conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>File</span><span class=w> </span><span class=n>confFile</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>File</span><span class=p>(</span><span class=n>uploadDirPath</span><span class=p>,</span><span class=w> </span><span class=n>fileName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.conf&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>RandomAccessFile</span><span class=w> </span><span class=n>accessConfFile</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RandomAccessFile</span><span class=p>(</span><span class=n>confFile</span><span class=p>,</span><span class=w> </span><span class=s>&#34;rw&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æŠŠè¯¥åˆ†æ®µæ ‡è®°ä¸º true è¡¨ç¤ºå®Œæˆ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;set part &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>multipartFileDTO</span><span class=p>.</span><span class=na>getChunk</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; complete&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>accessConfFile</span><span class=p>.</span><span class=na>setLength</span><span class=p>(</span><span class=n>multipartFileDTO</span><span class=p>.</span><span class=na>getChunks</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>accessConfFile</span><span class=p>.</span><span class=na>seek</span><span class=p>(</span><span class=n>multipartFileDTO</span><span class=p>.</span><span class=na>getChunk</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>accessConfFile</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=n>Byte</span><span class=p>.</span><span class=na>MAX_VALUE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// completeList æ£€æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆ,å¦‚æœæ•°ç»„é‡Œæ˜¯å¦å…¨éƒ¨éƒ½æ˜¯(å…¨éƒ¨åˆ†ç‰‡éƒ½æˆåŠŸä¸Šä¼ )</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>completeList</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>FileUtil</span><span class=p>.</span><span class=na>readBytes</span><span class=p>(</span><span class=n>confFile</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>byte</span><span class=w> </span><span class=n>isComplete</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Byte</span><span class=p>.</span><span class=na>MAX_VALUE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>completeList</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>isComplete</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Byte</span><span class=p>.</span><span class=na>MAX_VALUE</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//ä¸è¿ç®—, å¦‚æœæœ‰éƒ¨åˆ†æ²¡æœ‰å®Œæˆåˆ™ isComplete ä¸æ˜¯ Byte.MAX_VALUE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>isComplete</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>byte</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>isComplete</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>completeList</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;check part &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; complete?:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>completeList</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>accessConfFile</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ›´æ–°redisä¸­çš„çŠ¶æ€ï¼šå¦‚æœæ˜¯trueçš„è¯è¯æ˜æ˜¯å·²ç»è¯¥å¤§æ–‡ä»¶å…¨éƒ¨ä¸Šä¼ å®Œæˆ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isComplete</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Byte</span><span class=p>.</span><span class=na>MAX_VALUE</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>stringRedisTemplate</span><span class=p>.</span><span class=na>opsForHash</span><span class=p>().</span><span class=na>put</span><span class=p>(</span><span class=n>UploadConstants</span><span class=p>.</span><span class=na>FILE_UPLOAD_STATUS</span><span class=p>,</span><span class=w> </span><span class=n>multipartFileDTO</span><span class=p>.</span><span class=na>getMd5</span><span class=p>(),</span><span class=w> </span><span class=s>&#34;true&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>stringRedisTemplate</span><span class=p>.</span><span class=na>opsForValue</span><span class=p>().</span><span class=na>set</span><span class=p>(</span><span class=n>UploadConstants</span><span class=p>.</span><span class=na>FILE_MD5_KEY</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>multipartFileDTO</span><span class=p>.</span><span class=na>getMd5</span><span class=p>(),</span><span class=w> </span><span class=n>uploadDirPath</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;/&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>fileName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>stringRedisTemplate</span><span class=p>.</span><span class=na>opsForHash</span><span class=p>().</span><span class=na>hasKey</span><span class=p>(</span><span class=n>UploadConstants</span><span class=p>.</span><span class=na>FILE_UPLOAD_STATUS</span><span class=p>,</span><span class=w> </span><span class=n>multipartFileDTO</span><span class=p>.</span><span class=na>getMd5</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>stringRedisTemplate</span><span class=p>.</span><span class=na>opsForHash</span><span class=p>().</span><span class=na>put</span><span class=p>(</span><span class=n>UploadConstants</span><span class=p>.</span><span class=na>FILE_UPLOAD_STATUS</span><span class=p>,</span><span class=w> </span><span class=n>multipartFileDTO</span><span class=p>.</span><span class=na>getMd5</span><span class=p>(),</span><span class=w> </span><span class=s>&#34;false&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>stringRedisTemplate</span><span class=p>.</span><span class=na>hasKey</span><span class=p>(</span><span class=n>UploadConstants</span><span class=p>.</span><span class=na>FILE_MD5_KEY</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>multipartFileDTO</span><span class=p>.</span><span class=na>getMd5</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>stringRedisTemplate</span><span class=p>.</span><span class=na>opsForValue</span><span class=p>().</span><span class=na>set</span><span class=p>(</span><span class=n>UploadConstants</span><span class=p>.</span><span class=na>FILE_MD5_KEY</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>multipartFileDTO</span><span class=p>.</span><span class=na>getMd5</span><span class=p>(),</span><span class=w> </span><span class=n>uploadDirPath</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;/&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>fileName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.conf&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>åœ¨MappedByteBufferé‡Šæ”¾åå†å¯¹å®ƒè¿›è¡Œè¯»æ“ä½œçš„è¯å°±ä¼šå¼•å‘jvm crashï¼Œåœ¨å¹¶å‘æƒ…å†µä¸‹å¾ˆå®¹æ˜“å‘ç”Ÿæ­£åœ¨é‡Šæ”¾æ—¶å¦ä¸€ä¸ªçº¿ç¨‹æ­£å¼€å§‹è¯»å–ï¼Œäºæ˜¯crashå°±å‘ç”Ÿäº†ã€‚æ‰€ä»¥ä¸ºäº†ç³»ç»Ÿç¨³å®šæ€§é‡Šæ”¾å‰ä¸€èˆ¬éœ€è¦æ£€æŸ¥æ˜¯å¦è¿˜æœ‰çº¿ç¨‹åœ¨è¯»æˆ–å†™ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>freedMappedByteBuffer</span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=n>MappedByteBuffer</span><span class=w> </span><span class=n>mappedByteBuffer</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mappedByteBuffer</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mappedByteBuffer</span><span class=p>.</span><span class=na>force</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AccessController</span><span class=p>.</span><span class=na>doPrivileged</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>PrivilegedAction</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Method</span><span class=w> </span><span class=n>getCleanerMethod</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mappedByteBuffer</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getMethod</span><span class=p>(</span><span class=s>&#34;cleaner&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>getCleanerMethod</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>sun</span><span class=p>.</span><span class=na>misc</span><span class=p>.</span><span class=na>Cleaner</span><span class=w> </span><span class=n>cleaner</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>sun</span><span class=p>.</span><span class=na>misc</span><span class=p>.</span><span class=na>Cleaner</span><span class=p>)</span><span class=w> </span><span class=n>getCleanerMethod</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=n>mappedByteBuffer</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>cleaner</span><span class=p>.</span><span class=na>clean</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;clean MappedByteBuffer error!!!&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;clean MappedByteBuffer completed!!!&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=æŠ€æœ¯ç‚¹>æŠ€æœ¯ç‚¹<a hidden class=anchor aria-hidden=true href=#æŠ€æœ¯ç‚¹>#</a></h2><h3 id=randomaccessfile>RandomAccessFile<a hidden class=anchor aria-hidden=true href=#randomaccessfile>#</a></h3><p>RandomAccessFileç›¸å½“äºæ˜¯FileInputStreamä¸FileOutputStreamçš„å°è£…ç»“åˆï¼Œå³å¯ä»¥è¯»ä¹Ÿå¯ä»¥å†™ï¼Œå¹¶ä¸”RandomAccessFileæ”¯æŒç§»åŠ¨åˆ°æ–‡ä»¶æŒ‡å®šä½ç½®å¤„å¼€å§‹è¯»æˆ–å†™ã€‚</p><h3 id=mappedbytebuffer>MappedByteBuffer<a hidden class=anchor aria-hidden=true href=#mappedbytebuffer>#</a></h3><p>MappedByteBufferæ˜¯Javaæä¾›çš„åŸºäºæ“ä½œç³»ç»Ÿè™šæ‹Ÿå†…å­˜æ˜ å°„ï¼ˆMMAPï¼‰æŠ€æœ¯çš„æ–‡ä»¶è¯»å†™APIï¼Œåº•å±‚ä¸å†é€šè¿‡readã€writeã€seekç­‰ç³»ç»Ÿè°ƒç”¨å®ç°æ–‡ä»¶çš„è¯»å†™ã€‚</p><h3 id=accesscontrollerdoprivileged>AccessController.doPrivileged()<a hidden class=anchor aria-hidden=true href=#accesscontrollerdoprivileged>#</a></h3><p><code>AccessController.doPrivileged</code>æ˜¯ä¸€ä¸ªåœ¨<code>AccessController</code>ç±»ä¸­çš„é™æ€æ–¹æ³•ï¼Œå…è®¸åœ¨ä¸€ä¸ªç±»å®ä¾‹ä¸­çš„ä»£ç é€šçŸ¥è¿™ä¸ª<code>AccessController</code>ï¼šå®ƒçš„ä»£ç ä¸»ä½“æ˜¯äº«å—"privileged(ç‰¹æƒçš„)"ï¼Œå®ƒå•ç‹¬è´Ÿè´£å¯¹å®ƒçš„å¯å¾—çš„èµ„æºçš„è®¿é—®è¯·æ±‚ï¼Œè€Œä¸ç®¡è¿™ä¸ªè¯·æ±‚æ˜¯ç”±ä»€ä¹ˆä»£ç æ‰€å¼•å‘çš„ã€‚
è¿™å°±æ˜¯è¯´ï¼Œä¸€ä¸ªè°ƒç”¨è€…åœ¨è°ƒç”¨<code>doPrivileged</code>æ–¹æ³•æ—¶ï¼Œå¯è¢«æ ‡è¯†ä¸º &ldquo;ç‰¹æƒ&rdquo;ã€‚åœ¨åšè®¿é—®æ§åˆ¶å†³ç­–æ—¶ï¼Œå¦‚æœ<code>checkPermission</code>æ–¹æ³•é‡åˆ°ä¸€ä¸ªé€šè¿‡<code>doPrivileged</code>è°ƒç”¨è€Œè¢«è¡¨ç¤ºä¸º &ldquo;ç‰¹æƒ"çš„è°ƒç”¨è€…ï¼Œå¹¶ä¸”æ²¡æœ‰ä¸Šä¸‹æ–‡è‡ªå˜é‡ï¼Œ<code>checkPermission</code>æ–¹æ³•åˆ™å°†ç»ˆæ­¢æ£€æŸ¥ã€‚å¦‚æœé‚£ä¸ªè°ƒç”¨è€…çš„åŸŸå…·æœ‰ç‰¹å®šçš„è®¸å¯ï¼Œåˆ™ä¸åšè¿›ä¸€æ­¥æ£€æŸ¥ï¼Œ<code>checkPermission</code>å®‰é™åœ°è¿”å›ï¼Œè¡¨ç¤ºé‚£ä¸ªè®¿é—®è¯·æ±‚æ˜¯è¢«å…è®¸çš„ï¼›å¦‚æœé‚£ä¸ªåŸŸæ²¡æœ‰ç‰¹å®šçš„è®¸å¯ï¼Œåˆ™è±¡é€šå¸¸ä¸€æ ·ï¼Œä¸€ä¸ªå¼‚å¸¸è¢«æŠ›å‡ºã€‚</p><blockquote><p>æœ¬æ–‡å‚è€ƒè‡ªï¼š
<a href=https://gitee.com/zhangxiaoQ/large-file-upload.git>https://gitee.com/zhangxiaoQ/large-file-upload.git</a></p></blockquote></div><footer class=post-footer><ul class=post-tags><li><a href=https://lesanouo.github.io/blog/tags/springboot/>SpringBoot</a></li></ul><nav class=paginav><a class=prev href=https://lesanouo.github.io/blog/posts/snippet/npm/><span class=title>Â«</span><br><span>NPM ä»£ç ç‰‡æ®µ</span>
</a><a class=next href=https://lesanouo.github.io/blog/posts/code/168814080001/><span class=title>Â»</span><br><span>SpringBoot+Redissonå®ç°å»¶è¿Ÿé˜Ÿåˆ—</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://lesanouo.github.io/blog/>Lesan's Blog</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>