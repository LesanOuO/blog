<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…é—®é¢˜ | Lesan's Blog</title><meta name=keywords content="å¤šçº¿ç¨‹"><meta name=description content="ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜ï¼ˆProducer-consumer problemï¼‰ï¼Œä¹Ÿç§°æœ‰é™ç¼“å†²é—®é¢˜ï¼ˆBounded-buffer problemï¼‰ï¼Œæ˜¯ä¸€ä¸ªå¤šçº¿ç¨‹åŒæ­¥é—®é¢˜çš„ç»å…¸æ¡ˆä¾‹ã€‚ç”Ÿäº§è€…ç”Ÿæˆä¸€å®šé‡çš„æ•°æ®æ”¾åˆ°ç¼“å†²åŒºä¸­ï¼Œç„¶åé‡å¤æ­¤è¿‡ç¨‹ï¼›ä¸æ­¤åŒæ—¶ï¼Œæ¶ˆè´¹è€…ä¹Ÿåœ¨ç¼“å†²åŒºæ¶ˆè€—è¿™äº›æ•°æ®ã€‚ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´å¿…é¡»ä¿æŒåŒæ­¥ï¼Œè¦ä¿è¯ç”Ÿäº§è€…ä¸ä¼šåœ¨ç¼“å†²åŒºæ»¡æ—¶æ”¾å…¥æ•°æ®ï¼Œæ¶ˆè´¹è€…ä¹Ÿä¸ä¼šåœ¨ç¼“å†²åŒºç©ºæ—¶æ¶ˆè€—æ•°æ®ã€‚ä¸å¤Ÿå®Œå–„çš„è§£å†³æ–¹æ³•å®¹æ˜“å‡ºç°æ­»é”çš„æƒ…å†µï¼Œæ­¤æ—¶è¿›ç¨‹éƒ½åœ¨ç­‰å¾…å”¤é†’ã€‚"><meta name=author content="Lesan"><link rel=canonical href=https://lesanouo.github.io/blog/posts/knowledge/%E7%94%9F%E4%BA%A7%E8%80%85%E4%B8%8E%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98/><link crossorigin=anonymous href=/blog/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://lesanouo.github.io/blog/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://lesanouo.github.io/blog/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://lesanouo.github.io/blog/favicon.ico><link rel=apple-touch-icon href=https://lesanouo.github.io/blog/favicon.ico><link rel=mask-icon href=https://lesanouo.github.io/blog/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-cn href=https://lesanouo.github.io/blog/posts/knowledge/%E7%94%9F%E4%BA%A7%E8%80%85%E4%B8%8E%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:url" content="https://lesanouo.github.io/blog/posts/knowledge/%E7%94%9F%E4%BA%A7%E8%80%85%E4%B8%8E%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98/"><meta property="og:site_name" content="Lesan's Blog"><meta property="og:title" content="ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…é—®é¢˜"><meta property="og:description" content="ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜ï¼ˆProducer-consumer problemï¼‰ï¼Œä¹Ÿç§°æœ‰é™ç¼“å†²é—®é¢˜ï¼ˆBounded-buffer problemï¼‰ï¼Œæ˜¯ä¸€ä¸ªå¤šçº¿ç¨‹åŒæ­¥é—®é¢˜çš„ç»å…¸æ¡ˆä¾‹ã€‚ç”Ÿäº§è€…ç”Ÿæˆä¸€å®šé‡çš„æ•°æ®æ”¾åˆ°ç¼“å†²åŒºä¸­ï¼Œç„¶åé‡å¤æ­¤è¿‡ç¨‹ï¼›ä¸æ­¤åŒæ—¶ï¼Œæ¶ˆè´¹è€…ä¹Ÿåœ¨ç¼“å†²åŒºæ¶ˆè€—è¿™äº›æ•°æ®ã€‚ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´å¿…é¡»ä¿æŒåŒæ­¥ï¼Œè¦ä¿è¯ç”Ÿäº§è€…ä¸ä¼šåœ¨ç¼“å†²åŒºæ»¡æ—¶æ”¾å…¥æ•°æ®ï¼Œæ¶ˆè´¹è€…ä¹Ÿä¸ä¼šåœ¨ç¼“å†²åŒºç©ºæ—¶æ¶ˆè€—æ•°æ®ã€‚ä¸å¤Ÿå®Œå–„çš„è§£å†³æ–¹æ³•å®¹æ˜“å‡ºç°æ­»é”çš„æƒ…å†µï¼Œæ­¤æ—¶è¿›ç¨‹éƒ½åœ¨ç­‰å¾…å”¤é†’ã€‚"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-05-08T00:00:00+00:00"><meta property="article:modified_time" content="2022-05-08T00:00:00+00:00"><meta property="article:tag" content="å¤šçº¿ç¨‹"><meta name=twitter:card content="summary"><meta name=twitter:title content="ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…é—®é¢˜"><meta name=twitter:description content="ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜ï¼ˆProducer-consumer problemï¼‰ï¼Œä¹Ÿç§°æœ‰é™ç¼“å†²é—®é¢˜ï¼ˆBounded-buffer problemï¼‰ï¼Œæ˜¯ä¸€ä¸ªå¤šçº¿ç¨‹åŒæ­¥é—®é¢˜çš„ç»å…¸æ¡ˆä¾‹ã€‚ç”Ÿäº§è€…ç”Ÿæˆä¸€å®šé‡çš„æ•°æ®æ”¾åˆ°ç¼“å†²åŒºä¸­ï¼Œç„¶åé‡å¤æ­¤è¿‡ç¨‹ï¼›ä¸æ­¤åŒæ—¶ï¼Œæ¶ˆè´¹è€…ä¹Ÿåœ¨ç¼“å†²åŒºæ¶ˆè€—è¿™äº›æ•°æ®ã€‚ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´å¿…é¡»ä¿æŒåŒæ­¥ï¼Œè¦ä¿è¯ç”Ÿäº§è€…ä¸ä¼šåœ¨ç¼“å†²åŒºæ»¡æ—¶æ”¾å…¥æ•°æ®ï¼Œæ¶ˆè´¹è€…ä¹Ÿä¸ä¼šåœ¨ç¼“å†²åŒºç©ºæ—¶æ¶ˆè€—æ•°æ®ã€‚ä¸å¤Ÿå®Œå–„çš„è§£å†³æ–¹æ³•å®¹æ˜“å‡ºç°æ­»é”çš„æƒ…å†µï¼Œæ­¤æ—¶è¿›ç¨‹éƒ½åœ¨ç­‰å¾…å”¤é†’ã€‚"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"ğŸ“š åšå®¢","item":"https://lesanouo.github.io/blog/posts/"},{"@type":"ListItem","position":2,"name":"ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…é—®é¢˜","item":"https://lesanouo.github.io/blog/posts/knowledge/%E7%94%9F%E4%BA%A7%E8%80%85%E4%B8%8E%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…é—®é¢˜","name":"ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…é—®é¢˜","description":"ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜ï¼ˆProducer-consumer problemï¼‰ï¼Œä¹Ÿç§°æœ‰é™ç¼“å†²é—®é¢˜ï¼ˆBounded-buffer problemï¼‰ï¼Œæ˜¯ä¸€ä¸ªå¤šçº¿ç¨‹åŒæ­¥é—®é¢˜çš„ç»å…¸æ¡ˆä¾‹ã€‚ç”Ÿäº§è€…ç”Ÿæˆä¸€å®šé‡çš„æ•°æ®æ”¾åˆ°ç¼“å†²åŒºä¸­ï¼Œç„¶åé‡å¤æ­¤è¿‡ç¨‹ï¼›ä¸æ­¤åŒæ—¶ï¼Œæ¶ˆè´¹è€…ä¹Ÿåœ¨ç¼“å†²åŒºæ¶ˆè€—è¿™äº›æ•°æ®ã€‚ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´å¿…é¡»ä¿æŒåŒæ­¥ï¼Œè¦ä¿è¯ç”Ÿäº§è€…ä¸ä¼šåœ¨ç¼“å†²åŒºæ»¡æ—¶æ”¾å…¥æ•°æ®ï¼Œæ¶ˆè´¹è€…ä¹Ÿä¸ä¼šåœ¨ç¼“å†²åŒºç©ºæ—¶æ¶ˆè€—æ•°æ®ã€‚ä¸å¤Ÿå®Œå–„çš„è§£å†³æ–¹æ³•å®¹æ˜“å‡ºç°æ­»é”çš„æƒ…å†µï¼Œæ­¤æ—¶è¿›ç¨‹éƒ½åœ¨ç­‰å¾…å”¤é†’ã€‚\n","keywords":["å¤šçº¿ç¨‹"],"articleBody":"ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜ï¼ˆProducer-consumer problemï¼‰ï¼Œä¹Ÿç§°æœ‰é™ç¼“å†²é—®é¢˜ï¼ˆBounded-buffer problemï¼‰ï¼Œæ˜¯ä¸€ä¸ªå¤šçº¿ç¨‹åŒæ­¥é—®é¢˜çš„ç»å…¸æ¡ˆä¾‹ã€‚ç”Ÿäº§è€…ç”Ÿæˆä¸€å®šé‡çš„æ•°æ®æ”¾åˆ°ç¼“å†²åŒºä¸­ï¼Œç„¶åé‡å¤æ­¤è¿‡ç¨‹ï¼›ä¸æ­¤åŒæ—¶ï¼Œæ¶ˆè´¹è€…ä¹Ÿåœ¨ç¼“å†²åŒºæ¶ˆè€—è¿™äº›æ•°æ®ã€‚ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´å¿…é¡»ä¿æŒåŒæ­¥ï¼Œè¦ä¿è¯ç”Ÿäº§è€…ä¸ä¼šåœ¨ç¼“å†²åŒºæ»¡æ—¶æ”¾å…¥æ•°æ®ï¼Œæ¶ˆè´¹è€…ä¹Ÿä¸ä¼šåœ¨ç¼“å†²åŒºç©ºæ—¶æ¶ˆè€—æ•°æ®ã€‚ä¸å¤Ÿå®Œå–„çš„è§£å†³æ–¹æ³•å®¹æ˜“å‡ºç°æ­»é”çš„æƒ…å†µï¼Œæ­¤æ—¶è¿›ç¨‹éƒ½åœ¨ç­‰å¾…å”¤é†’ã€‚\nä¸‹å›¾ä¸ºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„ç¤ºæ„å›¾ï¼š è§£å†³æ€æƒ³ ä¿è¯åŒä¸€èµ„æºè¢«å¤šä¸ªçº¿ç¨‹å¹¶å‘è®¿é—®æ—¶çš„å®Œæ•´æ€§ã€‚å¸¸ç”¨çš„åŒæ­¥æ–¹æ³•æ˜¯é‡‡ç”¨ä¿¡å·æˆ–åŠ é”æœºåˆ¶ï¼Œä¿è¯èµ„æºåœ¨ä»»æ„æ—¶åˆ»è‡³å¤šè¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®\nJavaå®ç°çš„å‡ ç§æ–¹å¼ wait() / notify() æ–¹æ³• await() / signal() æ–¹æ³•(å¯é‡å…¥é”ReentrantLock) BlockingQueue é˜»å¡é˜Ÿåˆ—æ–¹æ³• ä¿¡å·é‡æ–¹æ³• ç®¡é“æ–¹æ³• ä»£ç å®ç° wait() / notify() æ–¹æ³• é¦–å…ˆï¼Œå…ˆä»‹ç»ä¸€ä¸‹ Thread.sleep()å’Œ Object.wait()ã€Object.notify()çš„åŒºåˆ«ã€‚\nsleep()æ˜¯Threadç±»çš„æ–¹æ³•ï¼›è€Œ wait()ï¼Œnotify()ï¼ŒnotifyAll()æ˜¯Objectç±»ä¸­å®šä¹‰çš„æ–¹æ³•ï¼›å°½ç®¡è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½ä¼šå½±å“çº¿ç¨‹çš„æ‰§è¡Œè¡Œä¸ºï¼Œä½†æ˜¯æœ¬è´¨ä¸Šæ˜¯æœ‰åŒºåˆ«çš„ Thread.sleep()ä¸ä¼šå¯¼è‡´é”è¡Œä¸ºçš„æ”¹å˜ï¼Œå¦‚æœå½“å‰çº¿ç¨‹æ˜¯æ‹¥æœ‰é”çš„ï¼Œé‚£ä¹ˆ Thread.sleep()ä¸ä¼šè®©çº¿ç¨‹é‡Šæ”¾é”ã€‚å¦‚æœèƒ½å¤Ÿå¸®åŠ©ä½ è®°å¿†çš„è¯ï¼Œå¯ä»¥ç®€å•è®¤ä¸ºå’Œé”ç›¸å…³çš„æ–¹æ³•éƒ½å®šä¹‰åœ¨Objectç±»ä¸­ï¼Œå› æ­¤è°ƒç”¨ Thread.sleep()æ˜¯ä¸ä¼šå½±å“é”çš„ç›¸å…³è¡Œä¸º Thread.sleepå’Œ Object.waitéƒ½ä¼šæš‚åœå½“å‰çš„çº¿ç¨‹ï¼Œå¯¹äºCPUèµ„æºæ¥è¯´ï¼Œä¸ç®¡æ˜¯å“ªç§æ–¹å¼æš‚åœçš„çº¿ç¨‹ï¼Œéƒ½è¡¨ç¤ºå®ƒæš‚æ—¶ä¸å†éœ€è¦CPUçš„æ‰§è¡Œæ—¶é—´ã€‚OSä¼šå°†æ‰§è¡Œæ—¶é—´åˆ†é…ç»™å…¶å®ƒçº¿ç¨‹ã€‚åŒºåˆ«æ˜¯è°ƒç”¨waitåï¼Œéœ€è¦åˆ«çš„çº¿ç¨‹æ‰§è¡Œnotify/notifyAllæ‰èƒ½å¤Ÿé‡æ–°è·å¾—CPUæ‰§è¡Œæ—¶é—´ Thread.sleep()è®©çº¿ç¨‹ä» ã€runningã€‘ -\u003e ã€é˜»å¡æ€ã€‘ æ—¶é—´ç»“æŸ/interrupt -\u003e ã€runnableã€‘;Object.wait()è®©çº¿ç¨‹ä» ã€runningã€‘ -\u003e ã€ç­‰å¾…é˜Ÿåˆ—ã€‘notify -\u003e ã€é”æ± ã€‘ -\u003e ã€runnableã€‘ wait()å’Œnotify()æ–¹æ³•çš„å®ç°ï¼Œç¼“å†²åŒºæ»¡å’Œä¸ºç©ºæ—¶éƒ½è°ƒç”¨wait()æ–¹æ³•ç­‰å¾…ï¼Œå½“ç”Ÿäº§è€…ç”Ÿäº§äº†ä¸€ä¸ªæ•°æ®æˆ–è€…æ¶ˆè´¹è€…æ¶ˆè´¹äº†ä¸€ä¸ªæ•°æ®ä¹‹åä¼šé€šè¿‡notify()å”¤é†’æ‰€æœ‰çº¿ç¨‹ã€‚\nimport java.util.*; public class Test { // ç¼“å†²åŒºæœ€å¤§å®¹é‡ private static final int MAX_SIZE = 100; // è®¡æ•° private static int count = 0; // ç¼“å†²åŒº private static LinkedList\u003cInteger\u003e list = new LinkedList\u003cInteger\u003e(); public static void main(String[] args) { Thread producer = new Thread(new Producer()); Thread consumer = new Thread(new Consumer()); producer.start(); consumer.start(); } // ç”Ÿäº§è€… public static class Producer implements Runnable { @Override public void run() { while (true) { // ä¸ºlistä¸Šé” synchronized (list) { // ç¼“å†²åŒºæ»¡æ—¶ï¼Œç­‰å¾… while (list.size() == MAX_SIZE) { try { System.out.println(\"list is full, Producer waiting\"); list.wait(); } catch (InterruptedException e) { e.printStackTrace(); } } // ç”Ÿäº§æ•°æ® count++; System.out.println(\"Producer produce \" + count); list.add(count); // å”¤é†’æ¶ˆè´¹è€… list.notifyAll(); // ç­‰å¾…ä¸€æ®µæ—¶é—´å†ç”Ÿäº§ try { Thread.sleep(new Random().nextInt(1000)); } catch (InterruptedException e) { e.printStackTrace(); } } // å½“ç”Ÿäº§100ä¸ªæ•°å°±ç»“æŸ if (count == 100) { break; } } } } // æ¶ˆè´¹è€… public static class Consumer implements Runnable { @Override public void run() { while (true) { // ä¸ºlistä¸Šé” synchronized (list) { // ç¼“å†²åŒºç©ºæ—¶ï¼Œç­‰å¾… while (list.isEmpty()) { try { System.out.println(\"list is empty, Consumer waiting\"); list.wait(); } catch (InterruptedException e) { e.printStackTrace(); } } // æ¶ˆè´¹æ•°æ® int temp = list.poll(); System.out.println(\"Consumer consume \" + temp); // å”¤é†’ç”Ÿäº§è€… list.notifyAll(); } // å½“æ¶ˆè´¹100ä¸ªæ•°å°±ç»“æŸ if (count == 100 \u0026\u0026 list.isEmpty()) { break; } } } } } æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š æ³¨æ„ï¼š\nnotifyAll()æ–¹æ³•å¯ä½¿æ‰€æœ‰æ­£åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ç­‰å¾…åŒä¸€å…±äº«èµ„æºçš„â€œå…¨éƒ¨â€çº¿ç¨‹ä»ç­‰å¾…çŠ¶æ€é€€å‡ºï¼Œè¿›å…¥å¯è¿è¡ŒçŠ¶æ€ã€‚æ­¤æ—¶ï¼Œä¼˜å…ˆçº§æœ€é«˜çš„é‚£ä¸ªçº¿ç¨‹æœ€å…ˆæ‰§è¡Œï¼Œä½†ä¹Ÿæœ‰å¯èƒ½æ˜¯éšæœºæ‰§è¡Œçš„ï¼Œè¿™è¦å–å†³äºJVMè™šæ‹Ÿæœºçš„å®ç°ã€‚å³æœ€ç»ˆä¹Ÿåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è¢«è¿è¡Œï¼Œä¸Šè¿°çº¿ç¨‹ä¼˜å…ˆçº§éƒ½ç›¸åŒï¼Œæ¯æ¬¡è¿è¡Œçš„çº¿ç¨‹éƒ½ä¸ç¡®å®šæ˜¯å“ªä¸ªï¼Œåæ¥ç»™çº¿ç¨‹è®¾ç½®ä¼˜å…ˆçº§åä¹Ÿè·Ÿé¢„æœŸä¸ä¸€æ ·ï¼Œè¿˜æ˜¯è¦çœ‹JVMçš„å…·ä½“å®ç°å§ã€‚\nawait() / signal() æ–¹æ³•(å¯é‡å…¥é”ReentrantLock) åœ¨JDK5.0ä¹‹åï¼ŒJavaæä¾›äº†æ›´åŠ å¥å£®çš„çº¿ç¨‹å¤„ç†æœºåˆ¶ï¼ŒåŒ…æ‹¬åŒæ­¥ã€é”å®šã€çº¿ç¨‹æ± ç­‰ï¼Œå®ƒä»¬å¯ä»¥å®ç°æ›´ç»†ç²’åº¦çš„çº¿ç¨‹æ§åˆ¶ã€‚ç”¨ReentrantLockå’ŒConditionå¯ä»¥å®ç°ç­‰å¾…/é€šçŸ¥æ¨¡å‹ï¼Œå…·æœ‰æ›´å¤§çš„çµæ´»æ€§ã€‚é€šè¿‡åœ¨Lockå¯¹è±¡ä¸Šè°ƒç”¨newCondition()æ–¹æ³•ï¼Œå°†æ¡ä»¶å˜é‡å’Œä¸€ä¸ªé”å¯¹è±¡è¿›è¡Œç»‘å®šï¼Œè¿›è€Œæ§åˆ¶å¹¶å‘ç¨‹åºè®¿é—®ç«äº‰èµ„æºçš„å®‰å…¨ã€‚\nConditionæ¥å£çš„await()å’Œsignal()å°±æ˜¯å…¶ä¸­ç”¨æ¥åšåŒæ­¥çš„ä¸¤ç§æ–¹æ³•ï¼Œå®ƒä»¬çš„åŠŸèƒ½åŸºæœ¬ä¸Šå’ŒObjectçš„wait()/ nofity()ç›¸åŒï¼Œå®Œå…¨å¯ä»¥å–ä»£å®ƒä»¬ï¼Œä½†æ˜¯å®ƒä»¬å’Œæ–°å¼•å…¥çš„é”å®šæœºåˆ¶Lockç›´æ¥æŒ‚é’©ï¼Œå…·æœ‰æ›´å¤§çš„çµæ´»æ€§ã€‚é€šè¿‡åœ¨Lockå¯¹è±¡ä¸Šè°ƒç”¨newCondition()æ–¹æ³•ï¼Œå°†æ¡ä»¶å˜é‡å’Œä¸€ä¸ªé”å¯¹è±¡è¿›è¡Œç»‘å®šï¼Œè¿›è€Œæ§åˆ¶å¹¶å‘ç¨‹åºè®¿é—®ç«äº‰èµ„æºçš„å®‰å…¨ã€‚\nimport java.util.*; import java.util.concurrent.locks.*; public class Test1 { private static final int MAX_SIZE = 100; private static int count = 0; private static LinkedList\u003cInteger\u003e list = new LinkedList\u003cInteger\u003e(); // åˆ›å»ºé”åŠå…¶æ¡ä»¶ private static final Lock lock = new ReentrantLock(); private static final Condition fullCondition = lock.newCondition(); private static final Condition emptyCondition = lock.newCondition(); public static void main(String[] args) { Thread producer = new Thread(new Producer()); Thread consumer = new Thread(new Consumer()); producer.start(); consumer.start(); } public static class Producer implements Runnable { @Override public void run() { while (true) { // ä¸Šé” lock.lock(); try { // ç¼“å†²åŒºæ»¡æ—¶ï¼Œç­‰å¾… while (list.size() == MAX_SIZE) { try { System.out.println(\"list is full, Producer waiting\"); fullCondition.await(); } catch (InterruptedException e) { e.printStackTrace(); } } // ç”Ÿäº§æ•°æ® count++; System.out.println(\"Producer produce \" + count); list.add(count); // å”¤é†’æ¶ˆè´¹è€… emptyCondition.signalAll(); } finally { lock.unlock(); } try { Thread.sleep(new Random().nextInt(1000)); } catch (InterruptedException e) { e.printStackTrace(); } if (count == 100) { break; } } } } public static class Consumer implements Runnable { @Override public void run() { while (true) { // ä¸Šé” lock.lock(); try { // ç¼“å†²åŒºç©ºæ—¶ï¼Œç­‰å¾… while (list.isEmpty()) { try { System.out.println(\"list is empty, Consumer waiting\"); emptyCondition.await(); } catch (InterruptedException e) { e.printStackTrace(); } } // æ¶ˆè´¹æ•°æ® int temp = list.poll(); System.out.println(\"Consumer consume \" + temp); // å”¤é†’ç”Ÿäº§è€… fullCondition.signalAll(); } finally { lock.unlock(); } if (count == 100 \u0026\u0026 list.isEmpty()) { break; } } } } } è¿è¡Œç»“æœå¦‚ä¸‹ï¼šï¼ˆä¸ç¬¬ä¸€ç§æ–¹æ³•ç±»ä¼¼ï¼‰ BlockingQueue é˜»å¡é˜Ÿåˆ—æ–¹æ³• JDK 1.5 ä»¥åæ–°å¢çš„ java.util.concurrentåŒ…æ–°å¢äº† BlockingQueue æ¥å£ã€‚å¹¶æä¾›äº†å¦‚ä¸‹å‡ ç§é˜»å¡é˜Ÿåˆ—å®ç°ï¼š\njava.util.concurrent.ArrayBlockingQueue java.util.concurrent.LinkedBlockingQueue java.util.concurrent.SynchronousQueue java.util.concurrent.PriorityBlockingQueue å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ä½¿ç”¨ ArrayBlockingQueueæˆ–è€… LinkedBlockingQueueå³å¯ã€‚\næˆ‘ä»¬è¿™é‡Œä½¿ç”¨LinkedBlockingQueueï¼Œå®ƒæ˜¯ä¸€ä¸ªå·²ç»åœ¨å†…éƒ¨å®ç°äº†åŒæ­¥çš„é˜Ÿåˆ—ï¼Œå®ç°æ–¹å¼é‡‡ç”¨çš„æ˜¯æˆ‘ä»¬ç¬¬2ç§await()/ signal()æ–¹æ³•ã€‚å®ƒå¯ä»¥åœ¨ç”Ÿæˆå¯¹è±¡æ—¶æŒ‡å®šå®¹é‡å¤§å°ã€‚å®ƒç”¨äºé˜»å¡æ“ä½œçš„æ˜¯put()å’Œtake()æ–¹æ³•ã€‚\nput()æ–¹æ³•ï¼šç±»ä¼¼äºæˆ‘ä»¬ä¸Šé¢çš„ç”Ÿäº§è€…çº¿ç¨‹ï¼Œå®¹é‡è¾¾åˆ°æœ€å¤§æ—¶ï¼Œè‡ªåŠ¨é˜»å¡ã€‚ take()æ–¹æ³•ï¼šç±»ä¼¼äºæˆ‘ä»¬ä¸Šé¢çš„æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œå®¹é‡ä¸º0æ—¶ï¼Œè‡ªåŠ¨é˜»å¡ã€‚\nimport java.util.*; import java.util.concurrent.LinkedBlockingQueue; public class Test2 { private static final int MAX_SIZE = 100; private static int count = 0; // åˆ›å»ºé˜»å¡é˜Ÿåˆ— private static LinkedBlockingQueue\u003cInteger\u003e blockingQueue = new LinkedBlockingQueue\u003cInteger\u003e(MAX_SIZE); public static void main(String[] args) { Thread producer = new Thread(new Producer()); Thread consumer = new Thread(new Consumer()); producer.start(); consumer.start(); } public static class Producer implements Runnable { @Override public void run() { while (true) { try { count++; // ç”Ÿäº§æ•°æ®åˆ°é˜»å¡é˜Ÿåˆ— blockingQueue.put(count); System.out.println(\"Producer produce \" + count); } catch (InterruptedException e) { e.printStackTrace(); } try { Thread.sleep(new Random().nextInt(1000)); } catch (InterruptedException e) { e.printStackTrace(); } if (count == 100) { break; } } } } public static class Consumer implements Runnable { @Override public void run() { while (true) { try { // ä»é˜»å¡é˜Ÿåˆ—æ¶ˆè´¹æ•°æ® int value = blockingQueue.take(); System.out.println(\"Consumer consume \" + value); } catch (InterruptedException e) { e.printStackTrace(); } if (count == 100 \u0026\u0026 blockingQueue.isEmpty()) { break; } } } } } ä¿¡å·é‡æ–¹æ³• Semaphoreï¼ˆä¿¡å·é‡ï¼‰æ˜¯ç”¨æ¥æ§åˆ¶åŒæ—¶è®¿é—®ç‰¹å®šèµ„æºçš„çº¿ç¨‹æ•°é‡ï¼Œå®ƒé€šè¿‡åè°ƒå„ä¸ªçº¿ç¨‹ï¼Œä»¥ä¿è¯åˆç†çš„ä½¿ç”¨å…¬å…±èµ„æºï¼Œåœ¨æ“ä½œç³»ç»Ÿä¸­æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„é—®é¢˜ï¼Œå¯ä»¥ç”¨æ¥è§£å†³å“²å­¦å®¶å°±é¤é—®é¢˜ã€‚Javaä¸­çš„Semaphoreç»´æŠ¤äº†ä¸€ä¸ªè®¸å¯é›†ï¼Œä¸€å¼€å§‹å…ˆè®¾å®šè¿™ä¸ªè®¸å¯é›†çš„æ•°é‡ï¼Œå¯ä»¥ä½¿ç”¨acquire()æ–¹æ³•è·å¾—ä¸€ä¸ªè®¸å¯ï¼Œå½“è®¸å¯ä¸è¶³æ—¶ä¼šè¢«é˜»å¡ï¼Œrelease()æ·»åŠ ä¸€ä¸ªè®¸å¯ã€‚\nSemaphoreå¯ä»¥ç”¨æ¥æ„å»ºä¸€äº›å¯¹è±¡æ± ï¼Œèµ„æºæ± ä¹‹ç±»çš„ï¼Œæ¯”å¦‚æ•°æ®åº“è¿æ¥æ± ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ›å»ºè®¡æ•°ä¸º1çš„Semaphoreï¼Œå°†å…¶ä½œä¸ºä¸€ç§ç±»ä¼¼äº’æ–¥é”çš„æœºåˆ¶ï¼Œè¿™ä¹Ÿå«äºŒå…ƒä¿¡å·é‡ï¼Œè¡¨ç¤ºä¸¤ç§äº’æ–¥çŠ¶æ€ã€‚\nåœ¨ä¸‹åˆ—ä»£ç ä¸­ï¼Œè¿˜åŠ å…¥äº†å¦å¤–ä¸€ä¸ªmutexä¿¡å·é‡ï¼Œç»´æŠ¤ç”Ÿäº§è€…æ¶ˆè´¹è€…ä¹‹é—´çš„åŒæ­¥å…³ç³»ï¼Œä¿è¯ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´çš„äº¤æ›¿è¿›è¡Œ\nimport java.util.*; import java.util.concurrent.Semaphore; public class Test3 { private static final int MAX_SIZE = 100; private static int count = 0; private static LinkedList\u003cInteger\u003e list = new LinkedList\u003cInteger\u003e(); // åˆ›å»ºä¿¡å·é‡ final static Semaphore notFull = new Semaphore(MAX_SIZE); final static Semaphore notEmpty = new Semaphore(0); final static Semaphore mutex = new Semaphore(1); public static void main(String[] args) { Thread producer = new Thread(new Producer()); Thread consumer = new Thread(new Consumer()); producer.start(); consumer.start(); } public static class Producer implements Runnable { @Override public void run() { while (true) { try { // è·å–è®¸å¯ notFull.acquire(); mutex.acquire(); // ç”Ÿäº§æ•°æ® count++; list.add(count); System.out.println(\"Producer produce \" + count); } catch (InterruptedException e) { e.printStackTrace(); } finally { // é‡Šæ”¾è®¸å¯ mutex.release(); notEmpty.release(); } try { Thread.sleep(new Random().nextInt(1000)); } catch (InterruptedException e) { e.printStackTrace(); } if (count == 100) { break; } } } } public static class Consumer implements Runnable { @Override public void run() { while (true) { try { // è·å–è®¸å¯ notEmpty.acquire(); mutex.acquire(); // æ¶ˆè´¹æ•°æ® int value = list.poll(); System.out.println(\"Consumer consume \" + value); } catch (InterruptedException e) { e.printStackTrace(); } finally { // é‡Šæ”¾è®¸å¯ mutex.release(); notFull.release(); } if (count == 100 \u0026\u0026 list.isEmpty()) { break; } } } } } ç®¡é“æ–¹æ³• åœ¨javaçš„ioåŒ…ä¸‹ï¼ŒPipedOutputStreamå’ŒPipedInputStreamåˆ†åˆ«æ˜¯ç®¡é“è¾“å‡ºæµå’Œç®¡é“è¾“å…¥æµã€‚\nå®ƒä»¬çš„ä½œç”¨æ˜¯è®©å¤šçº¿ç¨‹å¯ä»¥é€šè¿‡ç®¡é“è¿›è¡Œçº¿ç¨‹é—´çš„é€šè®¯ã€‚åœ¨ä½¿ç”¨ç®¡é“é€šä¿¡æ—¶ï¼Œå¿…é¡»å°†PipedOutputStreamå’ŒPipedInputStreamé…å¥—ä½¿ç”¨ã€‚\nä½¿ç”¨æ–¹æ³•ï¼šå…ˆåˆ›å»ºä¸€ä¸ªç®¡é“è¾“å…¥æµå’Œç®¡é“è¾“å‡ºæµï¼Œç„¶åå°†è¾“å…¥æµå’Œè¾“å‡ºæµè¿›è¡Œè¿æ¥ï¼Œç”¨ç”Ÿäº§è€…çº¿ç¨‹å¾€ç®¡é“è¾“å‡ºæµä¸­å†™å…¥æ•°æ®ï¼Œæ¶ˆè´¹è€…åœ¨ç®¡é“è¾“å…¥æµä¸­è¯»å–æ•°æ®ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°äº†ä¸åŒçº¿ç¨‹é—´çš„ç›¸äº’é€šè®¯ã€‚\nä½†æ˜¯è¿™ç§æ–¹å¼åœ¨ç”Ÿäº§è€…å’Œç”Ÿäº§è€…ã€æ¶ˆè´¹è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´ä¸èƒ½ä¿è¯åŒæ­¥ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ä¸€ä¸ªç”Ÿäº§è€…å’Œä¸€ä¸ªæ¶ˆè´¹è€…çš„æƒ…å†µä¸‹æ˜¯å¯ä»¥ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´äº¤æ›¿è¿è¡Œçš„ï¼Œå¤šä¸ªç”Ÿæˆè€…å’Œå¤šä¸ªæ¶ˆè´¹è€…è€…ä¹‹é—´åˆ™ä¸è¡Œã€‚\nè¿™ç§æ–¹å¼åªé€‚ç”¨äºä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´é€šä¿¡ï¼Œä¸é€‚åˆå¤šä¸ªçº¿ç¨‹ä¹‹é—´é€šä¿¡ã€‚\nimport java.io.IOException; import java.io.PipedInputStream; import java.io.PipedOutputStream; import java.util.*; public class Test4 { // æ§åˆ¶ç”Ÿäº§å’Œæ¶ˆè´¹ä¸ª100æ¬¡ private static int countP = 0; private static int countS = 0; // åˆ›å»ºç®¡é“è¾“å…¥æµå’Œç®¡é“è¾“å‡ºæµ final static PipedInputStream pis = new PipedInputStream(); final static PipedOutputStream pos = new PipedOutputStream(); // å°†è¾“å…¥æµå’Œè¾“å‡ºæµè¿›è¡Œè¿æ¥ static { try { pis.connect(pos); } catch (IOException e) { e.printStackTrace(); } } public static void main(String[] args) { Thread producer = new Thread(new Producer()); Thread consumer = new Thread(new Consumer()); producer.start(); consumer.start(); } public static class Producer implements Runnable { @Override public void run() { try { while (true) { // å†™å…¥æ•°æ® countP++; pos.write(countP); pos.flush(); System.out.println(\"Producer produce \" + countP); Thread.sleep(new Random().nextInt(1000)); if (countP == 100) { break; } } } catch (Exception e) { e.printStackTrace(); } finally { try { // å…³é—­è¾“å‡ºæµ pos.close(); } catch (IOException e) { e.printStackTrace(); } } } } public static class Consumer implements Runnable { @Override public void run() { try { while (true) { // è¯»å–æ•°æ® countS++; int value = pis.read(); System.out.println(\"Consumer consume \" + value); if (countS == 100) { break; } } } catch (IOException e) { e.printStackTrace(); } finally { try { // å…³é—­è¾“å…¥æµ pis.close(); } catch (IOException e) { e.printStackTrace(); } } } } } ","wordCount":"3708","inLanguage":"zh-cn","datePublished":"2022-05-08T00:00:00Z","dateModified":"2022-05-08T00:00:00Z","author":{"@type":"Person","name":"Lesan"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://lesanouo.github.io/blog/posts/knowledge/%E7%94%9F%E4%BA%A7%E8%80%85%E4%B8%8E%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98/"},"publisher":{"@type":"Organization","name":"Lesan's Blog","logo":{"@type":"ImageObject","url":"https://lesanouo.github.io/blog/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://lesanouo.github.io/blog/ accesskey=h title="Lesan's Blog (Alt + H)">Lesan's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://lesanouo.github.io/blog/archives title="ğŸ“š å½’æ¡£"><span>ğŸ“š å½’æ¡£</span></a></li><li><a href=https://lesanouo.github.io/blog/categories/ title="ğŸ—ƒï¸ åˆ†ç±»"><span>ğŸ—ƒï¸ åˆ†ç±»</span></a></li><li><a href=https://lesanouo.github.io/blog/tags/ title="ğŸ·ï¸ æ ‡ç­¾"><span>ğŸ·ï¸ æ ‡ç­¾</span></a></li><li><a href=https://lesanouo.github.io/blog/search/ title="ğŸ” æœç´¢"><span>ğŸ” æœç´¢</span></a></li><li><a href=https://lesanouo.github.io/blog/about/ title="ğŸ‘¨â€ğŸ’» å…³äºæˆ‘"><span>ğŸ‘¨â€ğŸ’» å…³äºæˆ‘</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://lesanouo.github.io/blog/>Home</a>&nbsp;Â»&nbsp;<a href=https://lesanouo.github.io/blog/posts/>ğŸ“š åšå®¢</a></div><h1 class="post-title entry-hint-parent">ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…é—®é¢˜</h1><div class=post-meta><span title='2022-05-08 00:00:00 +0000 UTC'>2022-05-08</span>&nbsp;Â·&nbsp;8 min&nbsp;Â·&nbsp;Lesan</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e8%a7%a3%e5%86%b3%e6%80%9d%e6%83%b3 aria-label=è§£å†³æ€æƒ³>è§£å†³æ€æƒ³</a><ul><li><a href=#java%e5%ae%9e%e7%8e%b0%e7%9a%84%e5%87%a0%e7%a7%8d%e6%96%b9%e5%bc%8f aria-label=Javaå®ç°çš„å‡ ç§æ–¹å¼>Javaå®ç°çš„å‡ ç§æ–¹å¼</a></li></ul></li><li><a href=#%e4%bb%a3%e7%a0%81%e5%ae%9e%e7%8e%b0 aria-label=ä»£ç å®ç°>ä»£ç å®ç°</a><ul><li><a href=#wait--notify-%e6%96%b9%e6%b3%95 aria-label="wait() / notify() æ–¹æ³•">wait() / notify() æ–¹æ³•</a></li><li><a href=#await--signal-%e6%96%b9%e6%b3%95%e5%8f%af%e9%87%8d%e5%85%a5%e9%94%81reentrantlock aria-label="await() / signal() æ–¹æ³•(å¯é‡å…¥é”ReentrantLock)">await() / signal() æ–¹æ³•(å¯é‡å…¥é”ReentrantLock)</a></li><li><a href=#blockingqueue-%e9%98%bb%e5%a1%9e%e9%98%9f%e5%88%97%e6%96%b9%e6%b3%95 aria-label="BlockingQueue é˜»å¡é˜Ÿåˆ—æ–¹æ³•">BlockingQueue é˜»å¡é˜Ÿåˆ—æ–¹æ³•</a></li><li><a href=#%e4%bf%a1%e5%8f%b7%e9%87%8f%e6%96%b9%e6%b3%95 aria-label=ä¿¡å·é‡æ–¹æ³•>ä¿¡å·é‡æ–¹æ³•</a></li><li><a href=#%e7%ae%a1%e9%81%93%e6%96%b9%e6%b3%95 aria-label=ç®¡é“æ–¹æ³•>ç®¡é“æ–¹æ³•</a></li></ul></li></ul></div></details></div><div class=post-content><p>ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜ï¼ˆProducer-consumer problemï¼‰ï¼Œä¹Ÿç§°æœ‰é™ç¼“å†²é—®é¢˜ï¼ˆBounded-buffer problemï¼‰ï¼Œæ˜¯ä¸€ä¸ªå¤šçº¿ç¨‹åŒæ­¥é—®é¢˜çš„ç»å…¸æ¡ˆä¾‹ã€‚ç”Ÿäº§è€…ç”Ÿæˆä¸€å®šé‡çš„æ•°æ®æ”¾åˆ°ç¼“å†²åŒºä¸­ï¼Œç„¶åé‡å¤æ­¤è¿‡ç¨‹ï¼›ä¸æ­¤åŒæ—¶ï¼Œæ¶ˆè´¹è€…ä¹Ÿåœ¨ç¼“å†²åŒºæ¶ˆè€—è¿™äº›æ•°æ®ã€‚ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´å¿…é¡»ä¿æŒåŒæ­¥ï¼Œè¦ä¿è¯ç”Ÿäº§è€…ä¸ä¼šåœ¨ç¼“å†²åŒºæ»¡æ—¶æ”¾å…¥æ•°æ®ï¼Œæ¶ˆè´¹è€…ä¹Ÿä¸ä¼šåœ¨ç¼“å†²åŒºç©ºæ—¶æ¶ˆè€—æ•°æ®ã€‚ä¸å¤Ÿå®Œå–„çš„è§£å†³æ–¹æ³•å®¹æ˜“å‡ºç°æ­»é”çš„æƒ…å†µï¼Œæ­¤æ—¶è¿›ç¨‹éƒ½åœ¨ç­‰å¾…å”¤é†’ã€‚</p><p>ä¸‹å›¾ä¸ºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„ç¤ºæ„å›¾ï¼š
<img loading=lazy src=images/%E7%94%9F%E4%BA%A7%E8%80%85%E4%B8%8E%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%981.png></p><h2 id=è§£å†³æ€æƒ³>è§£å†³æ€æƒ³<a hidden class=anchor aria-hidden=true href=#è§£å†³æ€æƒ³>#</a></h2><p>ä¿è¯åŒä¸€èµ„æºè¢«å¤šä¸ªçº¿ç¨‹å¹¶å‘è®¿é—®æ—¶çš„å®Œæ•´æ€§ã€‚å¸¸ç”¨çš„åŒæ­¥æ–¹æ³•æ˜¯é‡‡ç”¨ä¿¡å·æˆ–åŠ é”æœºåˆ¶ï¼Œä¿è¯èµ„æºåœ¨ä»»æ„æ—¶åˆ»è‡³å¤šè¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®</p><h3 id=javaå®ç°çš„å‡ ç§æ–¹å¼>Javaå®ç°çš„å‡ ç§æ–¹å¼<a hidden class=anchor aria-hidden=true href=#javaå®ç°çš„å‡ ç§æ–¹å¼>#</a></h3><ul><li>wait() / notify() æ–¹æ³•</li><li>await() / signal() æ–¹æ³•(å¯é‡å…¥é”ReentrantLock)</li><li>BlockingQueue é˜»å¡é˜Ÿåˆ—æ–¹æ³•</li><li>ä¿¡å·é‡æ–¹æ³•</li><li>ç®¡é“æ–¹æ³•</li></ul><h2 id=ä»£ç å®ç°>ä»£ç å®ç°<a hidden class=anchor aria-hidden=true href=#ä»£ç å®ç°>#</a></h2><h3 id=wait--notify-æ–¹æ³•>wait() / notify() æ–¹æ³•<a hidden class=anchor aria-hidden=true href=#wait--notify-æ–¹æ³•>#</a></h3><p>é¦–å…ˆï¼Œå…ˆä»‹ç»ä¸€ä¸‹ <code>Thread.sleep()</code>å’Œ <code>Object.wait()ã€Object.notify()</code>çš„åŒºåˆ«ã€‚</p><ol><li><code>sleep()</code>æ˜¯Threadç±»çš„æ–¹æ³•ï¼›è€Œ <code>wait()</code>ï¼Œ<code>notify()</code>ï¼Œ<code>notifyAll()</code>æ˜¯Objectç±»ä¸­å®šä¹‰çš„æ–¹æ³•ï¼›å°½ç®¡è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½ä¼šå½±å“çº¿ç¨‹çš„æ‰§è¡Œè¡Œä¸ºï¼Œä½†æ˜¯æœ¬è´¨ä¸Šæ˜¯æœ‰åŒºåˆ«çš„</li><li><code>Thread.sleep()</code>ä¸ä¼šå¯¼è‡´é”è¡Œä¸ºçš„æ”¹å˜ï¼Œå¦‚æœå½“å‰çº¿ç¨‹æ˜¯æ‹¥æœ‰é”çš„ï¼Œé‚£ä¹ˆ <code>Thread.sleep()</code>ä¸ä¼šè®©çº¿ç¨‹é‡Šæ”¾é”ã€‚å¦‚æœèƒ½å¤Ÿå¸®åŠ©ä½ è®°å¿†çš„è¯ï¼Œå¯ä»¥ç®€å•è®¤ä¸ºå’Œé”ç›¸å…³çš„æ–¹æ³•éƒ½å®šä¹‰åœ¨Objectç±»ä¸­ï¼Œå› æ­¤è°ƒç”¨ <code>Thread.sleep()</code>æ˜¯ä¸ä¼šå½±å“é”çš„ç›¸å…³è¡Œä¸º</li><li><code>Thread.sleep</code>å’Œ <code>Object.wait</code>éƒ½ä¼šæš‚åœå½“å‰çš„çº¿ç¨‹ï¼Œå¯¹äºCPUèµ„æºæ¥è¯´ï¼Œä¸ç®¡æ˜¯å“ªç§æ–¹å¼æš‚åœçš„çº¿ç¨‹ï¼Œéƒ½è¡¨ç¤ºå®ƒæš‚æ—¶ä¸å†éœ€è¦CPUçš„æ‰§è¡Œæ—¶é—´ã€‚OSä¼šå°†æ‰§è¡Œæ—¶é—´åˆ†é…ç»™å…¶å®ƒçº¿ç¨‹ã€‚åŒºåˆ«æ˜¯è°ƒç”¨waitåï¼Œéœ€è¦åˆ«çš„çº¿ç¨‹æ‰§è¡Œnotify/notifyAllæ‰èƒ½å¤Ÿé‡æ–°è·å¾—CPUæ‰§è¡Œæ—¶é—´</li><li><code>Thread.sleep()</code>è®©çº¿ç¨‹ä» ã€runningã€‘ -> ã€é˜»å¡æ€ã€‘ æ—¶é—´ç»“æŸ/interrupt -> ã€runnableã€‘;<code>Object.wait()</code>è®©çº¿ç¨‹ä» ã€runningã€‘ -> ã€ç­‰å¾…é˜Ÿåˆ—ã€‘notify -> ã€é”æ± ã€‘ -> ã€runnableã€‘</li></ol><p>wait()å’Œnotify()æ–¹æ³•çš„å®ç°ï¼Œç¼“å†²åŒºæ»¡å’Œä¸ºç©ºæ—¶éƒ½è°ƒç”¨wait()æ–¹æ³•ç­‰å¾…ï¼Œå½“ç”Ÿäº§è€…ç”Ÿäº§äº†ä¸€ä¸ªæ•°æ®æˆ–è€…æ¶ˆè´¹è€…æ¶ˆè´¹äº†ä¸€ä¸ªæ•°æ®ä¹‹åä¼šé€šè¿‡notify()å”¤é†’æ‰€æœ‰çº¿ç¨‹ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.util.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Test</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ç¼“å†²åŒºæœ€å¤§å®¹é‡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>MAX_SIZE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>100</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è®¡æ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ç¼“å†²åŒº</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>LinkedList</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LinkedList</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>producer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Producer</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>consumer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Consumer</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>producer</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>consumer</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ç”Ÿäº§è€…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>Producer</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// ä¸ºlistä¸Šé”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>list</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// ç¼“å†²åŒºæ»¡æ—¶ï¼Œç­‰å¾…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>list</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>MAX_SIZE</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;list is full, Producer waiting&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>list</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// ç”Ÿäº§æ•°æ®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>count</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;Producer produce &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>count</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>list</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>count</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// å”¤é†’æ¶ˆè´¹è€…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>list</span><span class=p>.</span><span class=na>notifyAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// ç­‰å¾…ä¸€æ®µæ—¶é—´å†ç”Ÿäº§</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Random</span><span class=p>().</span><span class=na>nextInt</span><span class=p>(</span><span class=n>1000</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// å½“ç”Ÿäº§100ä¸ªæ•°å°±ç»“æŸ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>count</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>100</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ¶ˆè´¹è€…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>Consumer</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// ä¸ºlistä¸Šé”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>list</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// ç¼“å†²åŒºç©ºæ—¶ï¼Œç­‰å¾…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>list</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;list is empty, Consumer waiting&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>list</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// æ¶ˆè´¹æ•°æ®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>int</span><span class=w> </span><span class=n>temp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>list</span><span class=p>.</span><span class=na>poll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;Consumer consume &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>temp</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// å”¤é†’ç”Ÿäº§è€…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>list</span><span class=p>.</span><span class=na>notifyAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// å½“æ¶ˆè´¹100ä¸ªæ•°å°±ç»“æŸ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>count</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>100</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>list</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š
<img loading=lazy src=images/%E7%94%9F%E4%BA%A7%E8%80%85%E4%B8%8E%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%982.png></p><p><strong>æ³¨æ„ï¼š</strong></p><p>notifyAll()æ–¹æ³•å¯ä½¿æ‰€æœ‰æ­£åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ç­‰å¾…åŒä¸€å…±äº«èµ„æºçš„â€œå…¨éƒ¨â€çº¿ç¨‹ä»ç­‰å¾…çŠ¶æ€é€€å‡ºï¼Œè¿›å…¥å¯è¿è¡ŒçŠ¶æ€ã€‚æ­¤æ—¶ï¼Œä¼˜å…ˆçº§æœ€é«˜çš„é‚£ä¸ªçº¿ç¨‹æœ€å…ˆæ‰§è¡Œï¼Œä½†ä¹Ÿæœ‰å¯èƒ½æ˜¯éšæœºæ‰§è¡Œçš„ï¼Œè¿™è¦å–å†³äºJVMè™šæ‹Ÿæœºçš„å®ç°ã€‚å³æœ€ç»ˆä¹Ÿåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è¢«è¿è¡Œï¼Œä¸Šè¿°çº¿ç¨‹ä¼˜å…ˆçº§éƒ½ç›¸åŒï¼Œæ¯æ¬¡è¿è¡Œçš„çº¿ç¨‹éƒ½ä¸ç¡®å®šæ˜¯å“ªä¸ªï¼Œåæ¥ç»™çº¿ç¨‹è®¾ç½®ä¼˜å…ˆçº§åä¹Ÿè·Ÿé¢„æœŸä¸ä¸€æ ·ï¼Œè¿˜æ˜¯è¦çœ‹JVMçš„å…·ä½“å®ç°å§ã€‚</p><h3 id=await--signal-æ–¹æ³•å¯é‡å…¥é”reentrantlock>await() / signal() æ–¹æ³•(å¯é‡å…¥é”ReentrantLock)<a hidden class=anchor aria-hidden=true href=#await--signal-æ–¹æ³•å¯é‡å…¥é”reentrantlock>#</a></h3><p>åœ¨JDK5.0ä¹‹åï¼ŒJavaæä¾›äº†æ›´åŠ å¥å£®çš„çº¿ç¨‹å¤„ç†æœºåˆ¶ï¼ŒåŒ…æ‹¬åŒæ­¥ã€é”å®šã€çº¿ç¨‹æ± ç­‰ï¼Œå®ƒä»¬å¯ä»¥å®ç°æ›´ç»†ç²’åº¦çš„çº¿ç¨‹æ§åˆ¶ã€‚ç”¨ReentrantLockå’ŒConditionå¯ä»¥å®ç°ç­‰å¾…/é€šçŸ¥æ¨¡å‹ï¼Œå…·æœ‰æ›´å¤§çš„çµæ´»æ€§ã€‚é€šè¿‡åœ¨Lockå¯¹è±¡ä¸Šè°ƒç”¨newCondition()æ–¹æ³•ï¼Œå°†æ¡ä»¶å˜é‡å’Œä¸€ä¸ªé”å¯¹è±¡è¿›è¡Œç»‘å®šï¼Œè¿›è€Œæ§åˆ¶å¹¶å‘ç¨‹åºè®¿é—®ç«äº‰èµ„æºçš„å®‰å…¨ã€‚</p><p>Conditionæ¥å£çš„await()å’Œsignal()å°±æ˜¯å…¶ä¸­ç”¨æ¥åšåŒæ­¥çš„ä¸¤ç§æ–¹æ³•ï¼Œå®ƒä»¬çš„åŠŸèƒ½åŸºæœ¬ä¸Šå’ŒObjectçš„wait()/ nofity()ç›¸åŒï¼Œå®Œå…¨å¯ä»¥å–ä»£å®ƒä»¬ï¼Œä½†æ˜¯å®ƒä»¬å’Œæ–°å¼•å…¥çš„é”å®šæœºåˆ¶Lockç›´æ¥æŒ‚é’©ï¼Œå…·æœ‰æ›´å¤§çš„çµæ´»æ€§ã€‚é€šè¿‡åœ¨Lockå¯¹è±¡ä¸Šè°ƒç”¨newCondition()æ–¹æ³•ï¼Œå°†æ¡ä»¶å˜é‡å’Œä¸€ä¸ªé”å¯¹è±¡è¿›è¡Œç»‘å®šï¼Œè¿›è€Œæ§åˆ¶å¹¶å‘ç¨‹åºè®¿é—®ç«äº‰èµ„æºçš„å®‰å…¨ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.util.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.locks.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Test1</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>MAX_SIZE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>100</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>LinkedList</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LinkedList</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// åˆ›å»ºé”åŠå…¶æ¡ä»¶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Lock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Condition</span><span class=w> </span><span class=n>fullCondition</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=na>newCondition</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Condition</span><span class=w> </span><span class=n>emptyCondition</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=na>newCondition</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>producer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Producer</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>consumer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Consumer</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>producer</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>consumer</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>Producer</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// ä¸Šé”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// ç¼“å†²åŒºæ»¡æ—¶ï¼Œç­‰å¾…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>list</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>MAX_SIZE</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;list is full, Producer waiting&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>fullCondition</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// ç”Ÿäº§æ•°æ®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>count</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;Producer produce &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>count</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>list</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>count</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// å”¤é†’æ¶ˆè´¹è€…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>emptyCondition</span><span class=p>.</span><span class=na>signalAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Random</span><span class=p>().</span><span class=na>nextInt</span><span class=p>(</span><span class=n>1000</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>count</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>100</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>Consumer</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// ä¸Šé”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// ç¼“å†²åŒºç©ºæ—¶ï¼Œç­‰å¾…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>list</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;list is empty, Consumer waiting&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>emptyCondition</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// æ¶ˆè´¹æ•°æ®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>int</span><span class=w> </span><span class=n>temp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>list</span><span class=p>.</span><span class=na>poll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;Consumer consume &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>temp</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// å”¤é†’ç”Ÿäº§è€…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>fullCondition</span><span class=p>.</span><span class=na>signalAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>count</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>100</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>list</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼šï¼ˆä¸ç¬¬ä¸€ç§æ–¹æ³•ç±»ä¼¼ï¼‰
<img loading=lazy src=images/%E7%94%9F%E4%BA%A7%E8%80%85%E4%B8%8E%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%983.png></p><h3 id=blockingqueue-é˜»å¡é˜Ÿåˆ—æ–¹æ³•>BlockingQueue é˜»å¡é˜Ÿåˆ—æ–¹æ³•<a hidden class=anchor aria-hidden=true href=#blockingqueue-é˜»å¡é˜Ÿåˆ—æ–¹æ³•>#</a></h3><p>JDK 1.5 ä»¥åæ–°å¢çš„ java.util.concurrentåŒ…æ–°å¢äº† BlockingQueue æ¥å£ã€‚å¹¶æä¾›äº†å¦‚ä¸‹å‡ ç§é˜»å¡é˜Ÿåˆ—å®ç°ï¼š</p><ul><li>java.util.concurrent.ArrayBlockingQueue</li><li>java.util.concurrent.LinkedBlockingQueue</li><li>java.util.concurrent.SynchronousQueue</li><li>java.util.concurrent.PriorityBlockingQueue</li></ul><p>å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ä½¿ç”¨ ArrayBlockingQueueæˆ–è€… LinkedBlockingQueueå³å¯ã€‚</p><p>æˆ‘ä»¬è¿™é‡Œä½¿ç”¨LinkedBlockingQueueï¼Œå®ƒæ˜¯ä¸€ä¸ªå·²ç»åœ¨å†…éƒ¨å®ç°äº†åŒæ­¥çš„é˜Ÿåˆ—ï¼Œå®ç°æ–¹å¼é‡‡ç”¨çš„æ˜¯æˆ‘ä»¬ç¬¬2ç§await()/ signal()æ–¹æ³•ã€‚å®ƒå¯ä»¥åœ¨ç”Ÿæˆå¯¹è±¡æ—¶æŒ‡å®šå®¹é‡å¤§å°ã€‚å®ƒç”¨äºé˜»å¡æ“ä½œçš„æ˜¯put()å’Œtake()æ–¹æ³•ã€‚</p><p>put()æ–¹æ³•ï¼šç±»ä¼¼äºæˆ‘ä»¬ä¸Šé¢çš„ç”Ÿäº§è€…çº¿ç¨‹ï¼Œå®¹é‡è¾¾åˆ°æœ€å¤§æ—¶ï¼Œè‡ªåŠ¨é˜»å¡ã€‚
take()æ–¹æ³•ï¼šç±»ä¼¼äºæˆ‘ä»¬ä¸Šé¢çš„æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œå®¹é‡ä¸º0æ—¶ï¼Œè‡ªåŠ¨é˜»å¡ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.util.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.LinkedBlockingQueue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Test2</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>MAX_SIZE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>100</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// åˆ›å»ºé˜»å¡é˜Ÿåˆ—</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>LinkedBlockingQueue</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>blockingQueue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LinkedBlockingQueue</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=p>(</span><span class=n>MAX_SIZE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>producer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Producer</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>consumer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Consumer</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>producer</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>consumer</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>Producer</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>count</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// ç”Ÿäº§æ•°æ®åˆ°é˜»å¡é˜Ÿåˆ—</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>blockingQueue</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>count</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;Producer produce &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>count</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Random</span><span class=p>().</span><span class=na>nextInt</span><span class=p>(</span><span class=n>1000</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>count</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>100</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>Consumer</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// ä»é˜»å¡é˜Ÿåˆ—æ¶ˆè´¹æ•°æ®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>int</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>blockingQueue</span><span class=p>.</span><span class=na>take</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;Consumer consume &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>count</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>100</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>blockingQueue</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=ä¿¡å·é‡æ–¹æ³•>ä¿¡å·é‡æ–¹æ³•<a hidden class=anchor aria-hidden=true href=#ä¿¡å·é‡æ–¹æ³•>#</a></h3><p>Semaphoreï¼ˆä¿¡å·é‡ï¼‰æ˜¯ç”¨æ¥æ§åˆ¶åŒæ—¶è®¿é—®ç‰¹å®šèµ„æºçš„çº¿ç¨‹æ•°é‡ï¼Œå®ƒé€šè¿‡åè°ƒå„ä¸ªçº¿ç¨‹ï¼Œä»¥ä¿è¯åˆç†çš„ä½¿ç”¨å…¬å…±èµ„æºï¼Œåœ¨æ“ä½œç³»ç»Ÿä¸­æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„é—®é¢˜ï¼Œå¯ä»¥ç”¨æ¥è§£å†³å“²å­¦å®¶å°±é¤é—®é¢˜ã€‚Javaä¸­çš„Semaphoreç»´æŠ¤äº†ä¸€ä¸ªè®¸å¯é›†ï¼Œä¸€å¼€å§‹å…ˆè®¾å®šè¿™ä¸ªè®¸å¯é›†çš„æ•°é‡ï¼Œå¯ä»¥ä½¿ç”¨acquire()æ–¹æ³•è·å¾—ä¸€ä¸ªè®¸å¯ï¼Œå½“è®¸å¯ä¸è¶³æ—¶ä¼šè¢«é˜»å¡ï¼Œrelease()æ·»åŠ ä¸€ä¸ªè®¸å¯ã€‚</p><p>Semaphoreå¯ä»¥ç”¨æ¥æ„å»ºä¸€äº›å¯¹è±¡æ± ï¼Œèµ„æºæ± ä¹‹ç±»çš„ï¼Œæ¯”å¦‚æ•°æ®åº“è¿æ¥æ± ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ›å»ºè®¡æ•°ä¸º1çš„Semaphoreï¼Œå°†å…¶ä½œä¸ºä¸€ç§ç±»ä¼¼äº’æ–¥é”çš„æœºåˆ¶ï¼Œè¿™ä¹Ÿå«äºŒå…ƒä¿¡å·é‡ï¼Œè¡¨ç¤ºä¸¤ç§äº’æ–¥çŠ¶æ€ã€‚</p><p>åœ¨ä¸‹åˆ—ä»£ç ä¸­ï¼Œè¿˜åŠ å…¥äº†å¦å¤–ä¸€ä¸ªmutexä¿¡å·é‡ï¼Œç»´æŠ¤ç”Ÿäº§è€…æ¶ˆè´¹è€…ä¹‹é—´çš„åŒæ­¥å…³ç³»ï¼Œä¿è¯ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´çš„äº¤æ›¿è¿›è¡Œ</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.util.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.Semaphore</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Test3</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>MAX_SIZE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>100</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>LinkedList</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LinkedList</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// åˆ›å»ºä¿¡å·é‡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Semaphore</span><span class=w> </span><span class=n>notFull</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Semaphore</span><span class=p>(</span><span class=n>MAX_SIZE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Semaphore</span><span class=w> </span><span class=n>notEmpty</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Semaphore</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Semaphore</span><span class=w> </span><span class=n>mutex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Semaphore</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>producer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Producer</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>consumer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Consumer</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>producer</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>consumer</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>Producer</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// è·å–è®¸å¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>notFull</span><span class=p>.</span><span class=na>acquire</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mutex</span><span class=p>.</span><span class=na>acquire</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// ç”Ÿäº§æ•°æ®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>count</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>list</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>count</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;Producer produce &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>count</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// é‡Šæ”¾è®¸å¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mutex</span><span class=p>.</span><span class=na>release</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>notEmpty</span><span class=p>.</span><span class=na>release</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Random</span><span class=p>().</span><span class=na>nextInt</span><span class=p>(</span><span class=n>1000</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>count</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>100</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>Consumer</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// è·å–è®¸å¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>notEmpty</span><span class=p>.</span><span class=na>acquire</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mutex</span><span class=p>.</span><span class=na>acquire</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// æ¶ˆè´¹æ•°æ®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>int</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>list</span><span class=p>.</span><span class=na>poll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;Consumer consume &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// é‡Šæ”¾è®¸å¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mutex</span><span class=p>.</span><span class=na>release</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>notFull</span><span class=p>.</span><span class=na>release</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>count</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>100</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>list</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=ç®¡é“æ–¹æ³•>ç®¡é“æ–¹æ³•<a hidden class=anchor aria-hidden=true href=#ç®¡é“æ–¹æ³•>#</a></h3><p>åœ¨javaçš„ioåŒ…ä¸‹ï¼ŒPipedOutputStreamå’ŒPipedInputStreamåˆ†åˆ«æ˜¯ç®¡é“è¾“å‡ºæµå’Œç®¡é“è¾“å…¥æµã€‚</p><p>å®ƒä»¬çš„ä½œç”¨æ˜¯è®©å¤šçº¿ç¨‹å¯ä»¥é€šè¿‡ç®¡é“è¿›è¡Œçº¿ç¨‹é—´çš„é€šè®¯ã€‚åœ¨ä½¿ç”¨ç®¡é“é€šä¿¡æ—¶ï¼Œå¿…é¡»å°†PipedOutputStreamå’ŒPipedInputStreamé…å¥—ä½¿ç”¨ã€‚</p><p>ä½¿ç”¨æ–¹æ³•ï¼šå…ˆåˆ›å»ºä¸€ä¸ªç®¡é“è¾“å…¥æµå’Œç®¡é“è¾“å‡ºæµï¼Œç„¶åå°†è¾“å…¥æµå’Œè¾“å‡ºæµè¿›è¡Œè¿æ¥ï¼Œç”¨ç”Ÿäº§è€…çº¿ç¨‹å¾€ç®¡é“è¾“å‡ºæµä¸­å†™å…¥æ•°æ®ï¼Œæ¶ˆè´¹è€…åœ¨ç®¡é“è¾“å…¥æµä¸­è¯»å–æ•°æ®ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°äº†ä¸åŒçº¿ç¨‹é—´çš„ç›¸äº’é€šè®¯ã€‚</p><p>ä½†æ˜¯è¿™ç§æ–¹å¼åœ¨ç”Ÿäº§è€…å’Œç”Ÿäº§è€…ã€æ¶ˆè´¹è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´ä¸èƒ½ä¿è¯åŒæ­¥ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ä¸€ä¸ªç”Ÿäº§è€…å’Œä¸€ä¸ªæ¶ˆè´¹è€…çš„æƒ…å†µä¸‹æ˜¯å¯ä»¥ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´äº¤æ›¿è¿è¡Œçš„ï¼Œå¤šä¸ªç”Ÿæˆè€…å’Œå¤šä¸ªæ¶ˆè´¹è€…è€…ä¹‹é—´åˆ™ä¸è¡Œã€‚</p><p>è¿™ç§æ–¹å¼åªé€‚ç”¨äºä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´é€šä¿¡ï¼Œä¸é€‚åˆå¤šä¸ªçº¿ç¨‹ä¹‹é—´é€šä¿¡ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.io.IOException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.PipedInputStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.PipedOutputStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Test4</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ§åˆ¶ç”Ÿäº§å’Œæ¶ˆè´¹ä¸ª100æ¬¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>countP</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>countS</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// åˆ›å»ºç®¡é“è¾“å…¥æµå’Œç®¡é“è¾“å‡ºæµ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>PipedInputStream</span><span class=w> </span><span class=n>pis</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>PipedInputStream</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>PipedOutputStream</span><span class=w> </span><span class=n>pos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>PipedOutputStream</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å°†è¾“å…¥æµå’Œè¾“å‡ºæµè¿›è¡Œè¿æ¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>pis</span><span class=p>.</span><span class=na>connect</span><span class=p>(</span><span class=n>pos</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>producer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Producer</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=w> </span><span class=n>consumer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Consumer</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>producer</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>consumer</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>Producer</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// å†™å…¥æ•°æ®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>countP</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>pos</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=n>countP</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>pos</span><span class=p>.</span><span class=na>flush</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;Producer produce &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>countP</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Random</span><span class=p>().</span><span class=na>nextInt</span><span class=p>(</span><span class=n>1000</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>countP</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>100</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// å…³é—­è¾“å‡ºæµ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>pos</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>Consumer</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// è¯»å–æ•°æ®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>countS</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>int</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pis</span><span class=p>.</span><span class=na>read</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;Consumer consume &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>countS</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>100</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// å…³é—­è¾“å…¥æµ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>pis</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://lesanouo.github.io/blog/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/>å¤šçº¿ç¨‹</a></li></ul><nav class=paginav><a class=prev href=https://lesanouo.github.io/blog/posts/knowledge/redis%E7%AC%94%E8%AE%B0/><span class=title>Â«</span><br><span>Redisç¬”è®°</span>
</a><a class=next href=https://lesanouo.github.io/blog/posts/knowledge/java%E4%B8%ADstream%E5%AD%A6%E4%B9%A0/><span class=title>Â»</span><br><span>Javaä¸­Streamå­¦ä¹ </span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://lesanouo.github.io/blog/>Lesan's Blog</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>