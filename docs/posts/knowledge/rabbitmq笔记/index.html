<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>RabbitMQ笔记 | Lesan's Blog</title><meta name=keywords content="RabbitMQ,.NET"><meta name=description content="RabbitMQ简述
MQ全称为Message Queue, 消息队列（MQ）是一种应用程序对应用程序的通信方法。RabbitMQ是一个在AMQP基础上完整的，可复用的企业消息系统。他遵循Mozilla Public License开源协议。AMQP(高级消息队列协议) 是一个异步消息传递所使用的应用层协议规范，作为线路层协议，而不是API（例如JMS），AMQP 客户端能够无视消息的来源任意发送和接受信息。AMQP的原始用途只是为金融界提供一个可以彼此协作的消息协议，而现在的目标则是为通用消息队列架构提供通用构建工具。因此，面向消息的中间件 （MOM）系统，例如发布/订阅队列，没有作为基本元素实现。AMQP当中有四个概念非常重要（一个虚拟主机持有一组交换机、队列和绑定）："><meta name=author content="Lesan"><link rel=canonical href=https://lesanouo.github.io/blog/posts/knowledge/rabbitmq%E7%AC%94%E8%AE%B0/><link crossorigin=anonymous href=/blog/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://lesanouo.github.io/blog/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://lesanouo.github.io/blog/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://lesanouo.github.io/blog/favicon.ico><link rel=apple-touch-icon href=https://lesanouo.github.io/blog/favicon.ico><link rel=mask-icon href=https://lesanouo.github.io/blog/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-cn href=https://lesanouo.github.io/blog/posts/knowledge/rabbitmq%E7%AC%94%E8%AE%B0/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:url" content="https://lesanouo.github.io/blog/posts/knowledge/rabbitmq%E7%AC%94%E8%AE%B0/"><meta property="og:site_name" content="Lesan's Blog"><meta property="og:title" content="RabbitMQ笔记"><meta property="og:description" content="RabbitMQ简述 MQ全称为Message Queue, 消息队列（MQ）是一种应用程序对应用程序的通信方法。RabbitMQ是一个在AMQP基础上完整的，可复用的企业消息系统。他遵循Mozilla Public License开源协议。AMQP(高级消息队列协议) 是一个异步消息传递所使用的应用层协议规范，作为线路层协议，而不是API（例如JMS），AMQP 客户端能够无视消息的来源任意发送和接受信息。AMQP的原始用途只是为金融界提供一个可以彼此协作的消息协议，而现在的目标则是为通用消息队列架构提供通用构建工具。因此，面向消息的中间件 （MOM）系统，例如发布/订阅队列，没有作为基本元素实现。AMQP当中有四个概念非常重要（一个虚拟主机持有一组交换机、队列和绑定）："><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-02-17T00:00:00+00:00"><meta property="article:modified_time" content="2022-02-17T00:00:00+00:00"><meta property="article:tag" content="RabbitMQ"><meta property="article:tag" content=".NET"><meta name=twitter:card content="summary"><meta name=twitter:title content="RabbitMQ笔记"><meta name=twitter:description content="RabbitMQ简述
MQ全称为Message Queue, 消息队列（MQ）是一种应用程序对应用程序的通信方法。RabbitMQ是一个在AMQP基础上完整的，可复用的企业消息系统。他遵循Mozilla Public License开源协议。AMQP(高级消息队列协议) 是一个异步消息传递所使用的应用层协议规范，作为线路层协议，而不是API（例如JMS），AMQP 客户端能够无视消息的来源任意发送和接受信息。AMQP的原始用途只是为金融界提供一个可以彼此协作的消息协议，而现在的目标则是为通用消息队列架构提供通用构建工具。因此，面向消息的中间件 （MOM）系统，例如发布/订阅队列，没有作为基本元素实现。AMQP当中有四个概念非常重要（一个虚拟主机持有一组交换机、队列和绑定）："><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"📚 博客","item":"https://lesanouo.github.io/blog/posts/"},{"@type":"ListItem","position":2,"name":"RabbitMQ笔记","item":"https://lesanouo.github.io/blog/posts/knowledge/rabbitmq%E7%AC%94%E8%AE%B0/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"RabbitMQ笔记","name":"RabbitMQ笔记","description":"RabbitMQ简述 MQ全称为Message Queue, 消息队列（MQ）是一种应用程序对应用程序的通信方法。RabbitMQ是一个在AMQP基础上完整的，可复用的企业消息系统。他遵循Mozilla Public License开源协议。AMQP(高级消息队列协议) 是一个异步消息传递所使用的应用层协议规范，作为线路层协议，而不是API（例如JMS），AMQP 客户端能够无视消息的来源任意发送和接受信息。AMQP的原始用途只是为金融界提供一个可以彼此协作的消息协议，而现在的目标则是为通用消息队列架构提供通用构建工具。因此，面向消息的中间件 （MOM）系统，例如发布/订阅队列，没有作为基本元素实现。AMQP当中有四个概念非常重要（一个虚拟主机持有一组交换机、队列和绑定）：\n","keywords":["RabbitMQ",".NET"],"articleBody":"RabbitMQ简述 MQ全称为Message Queue, 消息队列（MQ）是一种应用程序对应用程序的通信方法。RabbitMQ是一个在AMQP基础上完整的，可复用的企业消息系统。他遵循Mozilla Public License开源协议。AMQP(高级消息队列协议) 是一个异步消息传递所使用的应用层协议规范，作为线路层协议，而不是API（例如JMS），AMQP 客户端能够无视消息的来源任意发送和接受信息。AMQP的原始用途只是为金融界提供一个可以彼此协作的消息协议，而现在的目标则是为通用消息队列架构提供通用构建工具。因此，面向消息的中间件 （MOM）系统，例如发布/订阅队列，没有作为基本元素实现。AMQP当中有四个概念非常重要（一个虚拟主机持有一组交换机、队列和绑定）：\nvirtual host，虚拟主机 exchange，交换机 queue，队列 binding，绑定 消息传递过程 上图为RabbitMQ中一些重要名词的概述，其中包括Connection、Channel、Exchange、Queue、Bind、Routing Key\n上图为消息从生产到消费的整个流程，其中Exchange，与Queue都是可以设置相关属性，队列的持久化，交换器类型制定\n这个过程走分三个部分，1、客户端（生产消息队列），2、RabbitMQ服务端（负责路由规则的绑定与消息的分发），3、客户端（消费消息队列中的消息）\n由图可以看出，一个消息可以走一次网络却被分发到不同的消息队列中，然后被多个的客户端消费，那么这个过程就是RabbitMQ的核心机制，RabbitMQ的路由类型与消费模式\nRabbitMQ中Exchange的类型 类型有4种，direct，fanout，topic，headers。其中headers不常用，本篇不做介绍，其他三种类型，会做详细介绍。\n那么这些类型是什么意思呢？就是Exchange与队列进行绑定后，消息根据exchang的类型，按照不同的绑定规则分发消息到消息队列中，可以是一个消息被分发给多个消息队列，也可以是一个消息分发到一个消息队列。具体请看下文。\n介绍之初还要说下RoutingKey，这是个什么玩意呢？他是exchange与消息队列绑定中的一个标识。有些路由类型会按照标识对应消息队列，有些路由类型忽略routingkey。具体看下文。\nExchange类型direct 根据交换器名称与routingkey来找队列的\nNote:消息从client发出，传送给交换器ChangeA，RoutingKey为routingkey.ZLH,那么不管你发送给Queue1，还是Queue2一个消息都会保存在Queue1，Queue2，Queue3，三个队列中。这就是交换器的direct类型的路由规则。只要找到路由器与routingkey绑定的队列，那么他有多少队列，他就分发给多少队列。\nExchange类型fanout 这个类型忽略Routingkey，他为广播模式\nNote:消息从客户端发出，只要queue与exchange有绑定，那么他不管你的Routingkey是什么他都会将消息分发给所有与该exchang绑定的队列中。\nExchange类型topic 这个类型的路由规则如果你掌握啦，那是相当的好用，与灵活。他是根据RoutingKey的设置，来做匹配的，其中这里还有两个通配符为：\n*，代表任意的一个词。例如topic.zlh.*，他能够匹配到，topic.zlh.one ,topic.zlh.two ,topic.zlh.abc, ….\n#，代表任意多个词。例如topic.#，他能够匹配到，topic.zlh.one ,topic.zlh.two ,topic.zlh.abc, ….\nNote：这个图看上去很乱，但是他是根据匹配符做匹配的，这里我建议你自己做下消息队列的具体操作。\n消息队列的消费与消息确认 消息队列的消费 Note:如果一个消息队列中有大量消息等待操作时，我们可以用多个客户端来处理消息，这里的分发机制是采用负载均衡算法中的轮询。第一个消息给A，下一个消息给B，下下一个消息给A，下下下一个消息给B……以此类推\n消息确认 保证消息的安全性，保证此消息被正确处理后才能在服务端的消息队列中删除。那么rabbitmq提供啦ack应答机制，来实现这一功能。\nack应答有两种方式：1、自动应答，2、手动应答\n使用例子 生产者 using RabbitMQ.Client; using System; using System.Text; namespace RabbitMQProduct { internal class Program { static void Main(string[] args) { Console.WriteLine(\"Welcome to RabbitMQ Product!\"); DirectExchangeSendMsg(); // TopicExchangeSendMsg(); Console.WriteLine(\"按任意值，退出程序\"); Console.ReadKey(); } /// /// 连接配置 /// private static readonly ConnectionFactory rabbitMqFactory = new ConnectionFactory() { UserName = \"guest\", Password = \"guest\", Port = 5672, //VirtualHost = \"LesanVirtualHost\" }; /// /// 路由名称 /// const string ExchangeName = \"Lesan.exchange\"; //队列名称 const string QueueName = \"Lesan.queue\"; /// /// 路由名称 /// const string TopExchangeName = \"topic.Lesan.exchange\"; //队列名称 const string TopQueueName = \"topic.Lesan.queue\"; /// /// 单点精确路由模式 /// public static void DirectExchangeSendMsg() { using (IConnection conn = rabbitMqFactory.CreateConnection()) { using (IModel channel = conn.CreateModel()) { //设置交换器的类型 channel.ExchangeDeclare(ExchangeName, ExchangeType.Direct, durable: true, autoDelete: false, arguments: null); //声明一个队列，设置队列是否持久化，排他性，与自动删除 channel.QueueDeclare(QueueName, durable: true, autoDelete: false, exclusive: false, arguments: null); //绑定消息队列，交换器，routingkey channel.QueueBind(QueueName, ExchangeName, routingKey: QueueName); var props = channel.CreateBasicProperties(); //队列持久化 props.Persistent = true; string vadata = Console.ReadLine(); while (vadata != \"exit\") { var msgBody = Encoding.UTF8.GetBytes(vadata); //发送信息 channel.BasicPublish(exchange: ExchangeName, routingKey: QueueName, basicProperties: props, body: msgBody); Console.WriteLine(string.Format(\"***发送时间:{0}，发送完成，输入exit退出消息发送\", DateTime.Now.ToString(\"yyyy-MM-dd HH:mm:ss\"))); vadata = Console.ReadLine(); } } } } /// /// topic 模糊匹配模式，符号“#”匹配一个或多个词，符号“*”匹配不多不少一个词。因此“log.#”能够匹配到“log.info.oa”，但是“log.*” 只会匹配到“log.error” /// public static void TopicExchangeSendMsg() { using (IConnection conn = rabbitMqFactory.CreateConnection()) { using (IModel channel = conn.CreateModel()) { channel.ExchangeDeclare(TopExchangeName, ExchangeType.Topic, durable: false, autoDelete: false, arguments: null); channel.QueueDeclare(TopQueueName, durable: false, autoDelete: false, exclusive: false, arguments: null); channel.QueueBind(TopQueueName, TopExchangeName, routingKey: TopQueueName); //var props = channel.CreateBasicProperties(); //props.Persistent = true; string vadata = Console.ReadLine(); while (vadata != \"exit\") { var msgBody = Encoding.UTF8.GetBytes(vadata); channel.BasicPublish(exchange: TopExchangeName, routingKey: TopQueueName, basicProperties: null, body: msgBody); Console.WriteLine(string.Format(\"***发送时间:{0}，发送完成，输入exit退出消息发送\", DateTime.Now.ToString(\"yyyy-MM-dd HH:mm:ss\"))); vadata = Console.ReadLine(); } } } } } } 消费者 using RabbitMQ.Client; using RabbitMQ.Client.Events; using System; using System.Text; namespace RabbitMQConsumer { internal class Program { static void Main(string[] args) { Console.WriteLine(\"Welcome to RabbitMQ Consumer!\"); //DirectAcceptExchange(); //DirectAcceptExchangeEvent(); DirectAcceptExchangeTask(); //TopicAcceptExchange(); Console.WriteLine(\"按任意值，退出程序\"); Console.ReadKey(); } /// /// 连接配置 /// private static readonly ConnectionFactory rabbitMqFactory = new ConnectionFactory() { UserName = \"guest\", Password = \"guest\", Port = 5672, //VirtualHost = \"LesanVirtualHost\" }; /// /// 路由名称 /// const string ExchangeName = \"Lesan.exchange\"; //队列名称 const string QueueName = \"Lesan.queue\"; /// /// 路由名称 /// const string TopExchangeName = \"topic.Lesan.exchange\"; //队列名称 const string TopQueueName = \"topic.Lesan.queue\"; /// /// 基于时间轮询的，每隔一段时间获取一次 /// public static void DirectAcceptExchange() { using (IConnection conn = rabbitMqFactory.CreateConnection()) { using (IModel channel = conn.CreateModel()) { //设置交换器的类型 channel.ExchangeDeclare(ExchangeName, ExchangeType.Direct, durable: true, autoDelete: false, arguments: null); //声明一个队列，设置队列是否持久化，排他性，与自动删除 channel.QueueDeclare(QueueName, durable: true, autoDelete: false, exclusive: false, arguments: null); //绑定消息队列，交换器，routingkey channel.QueueBind(QueueName, ExchangeName, routingKey: QueueName); while (true) { BasicGetResult msgResponse = channel.BasicGet(QueueName, true); if (msgResponse != null) { var msgBody = Encoding.UTF8.GetString(msgResponse.Body.ToArray()); Console.WriteLine(string.Format(\"***接收时间:{0}，消息内容：{1}\", DateTime.Now.ToString(\"yyyy-MM-dd HH:mm:ss\"), msgBody)); } System.Threading.Thread.Sleep(TimeSpan.FromSeconds(1)); } } } } /// /// 基于事件的，当消息到达时触发事件，获取数据 /// public static void DirectAcceptExchangeEvent() { using (IConnection conn = rabbitMqFactory.CreateConnection()) { using (IModel channel = conn.CreateModel()) { //channel.ExchangeDeclare(ExchangeName, \"direct\", durable: true, autoDelete: false, arguments: null); channel.QueueDeclare(QueueName, durable: true, autoDelete: false, exclusive: false, arguments: null); //channel.QueueBind(QueueName, ExchangeName, routingKey: QueueName); var consumer = new EventingBasicConsumer(channel); consumer.Received += (model, ea) =\u003e { var msgBody = Encoding.UTF8.GetString(ea.Body.ToArray()); Console.WriteLine(string.Format(\"***接收时间:{0}，消息内容：{1}\", DateTime.Now.ToString(\"yyyy-MM-dd HH:mm:ss\"), msgBody)); }; channel.BasicConsume(QueueName, true, consumer: consumer); Console.WriteLine(\"按任意值，退出程序\"); Console.ReadKey(); } } } /// /// 基于事件的，当消息到达时触发事件，获取数据 /// public static void DirectAcceptExchangeTask() { using (IConnection conn = rabbitMqFactory.CreateConnection()) { using (IModel channel = conn.CreateModel()) { //channel.ExchangeDeclare(ExchangeName, \"direct\", durable: true, autoDelete: false, arguments: null); channel.QueueDeclare(QueueName, durable: true, autoDelete: false, exclusive: false, arguments: null); channel.BasicQos(prefetchSize: 0, prefetchCount: 1, global: false);//告诉broker同一时间只处理一个消息 //channel.QueueBind(QueueName, ExchangeName, routingKey: QueueName); //定义这个队列的消费者 var consumer = new EventingBasicConsumer(channel); consumer.Received += (model, ea) =\u003e { var msgBody = Encoding.UTF8.GetString(ea.Body.ToArray()); Console.WriteLine(string.Format(\"***接收时间:{0}，消息内容：{1}\", DateTime.Now.ToString(\"yyyy-MM-dd HH:mm:ss\"), msgBody)); int dots = msgBody.Split('.').Length - 1; System.Threading.Thread.Sleep(dots * 1000); //处理完成，告诉Broker可以服务端可以删除消息，分配新的消息过来 channel.BasicAck(deliveryTag: ea.DeliveryTag, multiple: false); }; //noAck设置false,告诉broker，发送消息之后，消息暂时不要删除，等消费者处理完成再说 //false为手动应答，true为自动应答 channel.BasicConsume(QueueName, false, consumer: consumer); Console.WriteLine(\"按任意值，退出程序\"); Console.ReadKey(); } } } /// /// topic 模糊匹配模式，符号“#”匹配一个或多个词，符号“*”匹配不多不少一个词。因此“log.#”能够匹配到“log.info.oa”，但是“log.*” 只会匹配到“log.error” /// public static void TopicAcceptExchange() { using (IConnection conn = rabbitMqFactory.CreateConnection()) { using (IModel channel = conn.CreateModel()) { channel.ExchangeDeclare(TopExchangeName, ExchangeType.Topic, durable: false, autoDelete: false, arguments: null); channel.QueueDeclare(TopQueueName, durable: false, autoDelete: false, exclusive: false, arguments: null); channel.BasicQos(prefetchSize: 0, prefetchCount: 1, global: false); channel.QueueBind(TopQueueName, TopExchangeName, routingKey: TopQueueName); var consumer = new EventingBasicConsumer(channel); consumer.Received += (model, ea) =\u003e { var msgBody = Encoding.UTF8.GetString(ea.Body.ToArray()); Console.WriteLine(string.Format(\"***接收时间:{0}，消息内容：{1}\", DateTime.Now.ToString(\"yyyy-MM-dd HH:mm:ss\"), msgBody)); int dots = msgBody.Split('.').Length - 1; System.Threading.Thread.Sleep(dots * 1000); Console.WriteLine(\" [x] Done\"); channel.BasicAck(deliveryTag: ea.DeliveryTag, multiple: false); }; channel.BasicConsume(TopQueueName, false, consumer: consumer); Console.WriteLine(\"按任意值，退出程序\"); Console.ReadKey(); } } } } } 引用 以上笔记摘录自网络\nhttps://www.cnblogs.com/knowledgesea/p/5296008.html https://www.cnblogs.com/personblog/p/10681741.html\n","wordCount":"3582","inLanguage":"zh-cn","datePublished":"2022-02-17T00:00:00Z","dateModified":"2022-02-17T00:00:00Z","author":{"@type":"Person","name":"Lesan"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://lesanouo.github.io/blog/posts/knowledge/rabbitmq%E7%AC%94%E8%AE%B0/"},"publisher":{"@type":"Organization","name":"Lesan's Blog","logo":{"@type":"ImageObject","url":"https://lesanouo.github.io/blog/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://lesanouo.github.io/blog/ accesskey=h title="Lesan's Blog (Alt + H)">Lesan's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://lesanouo.github.io/blog/archives title="📚 归档"><span>📚 归档</span></a></li><li><a href=https://lesanouo.github.io/blog/categories/ title="🗃️ 分类"><span>🗃️ 分类</span></a></li><li><a href=https://lesanouo.github.io/blog/tags/ title="🏷️ 标签"><span>🏷️ 标签</span></a></li><li><a href=https://lesanouo.github.io/blog/search/ title="🔎 搜索"><span>🔎 搜索</span></a></li><li><a href=https://lesanouo.github.io/blog/about/ title="👨‍💻 关于我"><span>👨‍💻 关于我</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://lesanouo.github.io/blog/>Home</a>&nbsp;»&nbsp;<a href=https://lesanouo.github.io/blog/posts/>📚 博客</a></div><h1 class="post-title entry-hint-parent">RabbitMQ笔记</h1><div class=post-meta><span title='2022-02-17 00:00:00 +0000 UTC'>2022-02-17</span>&nbsp;·&nbsp;8 min&nbsp;·&nbsp;Lesan</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#rabbitmq%e7%ae%80%e8%bf%b0 aria-label=RabbitMQ简述>RabbitMQ简述</a></li><li><a href=#%e6%b6%88%e6%81%af%e4%bc%a0%e9%80%92%e8%bf%87%e7%a8%8b aria-label=消息传递过程>消息传递过程</a></li><li><a href=#rabbitmq%e4%b8%adexchange%e7%9a%84%e7%b1%bb%e5%9e%8b aria-label=RabbitMQ中Exchange的类型>RabbitMQ中Exchange的类型</a><ul><li><a href=#exchange%e7%b1%bb%e5%9e%8bdirect aria-label=Exchange类型direct>Exchange类型direct</a></li><li><a href=#exchange%e7%b1%bb%e5%9e%8bfanout aria-label=Exchange类型fanout>Exchange类型fanout</a></li><li><a href=#exchange%e7%b1%bb%e5%9e%8btopic aria-label=Exchange类型topic>Exchange类型topic</a></li></ul></li><li><a href=#%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e7%9a%84%e6%b6%88%e8%b4%b9%e4%b8%8e%e6%b6%88%e6%81%af%e7%a1%ae%e8%ae%a4 aria-label=消息队列的消费与消息确认>消息队列的消费与消息确认</a><ul><li><a href=#%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e7%9a%84%e6%b6%88%e8%b4%b9 aria-label=消息队列的消费>消息队列的消费</a></li><li><a href=#%e6%b6%88%e6%81%af%e7%a1%ae%e8%ae%a4 aria-label=消息确认>消息确认</a></li></ul></li><li><a href=#%e4%bd%bf%e7%94%a8%e4%be%8b%e5%ad%90 aria-label=使用例子>使用例子</a><ul><li><a href=#%e7%94%9f%e4%ba%a7%e8%80%85 aria-label=生产者>生产者</a></li><li><a href=#%e6%b6%88%e8%b4%b9%e8%80%85 aria-label=消费者>消费者</a></li></ul></li><li><a href=#%e5%bc%95%e7%94%a8 aria-label=引用>引用</a></li></ul></div></details></div><div class=post-content><h2 id=rabbitmq简述>RabbitMQ简述<a hidden class=anchor aria-hidden=true href=#rabbitmq简述>#</a></h2><p>MQ全称为Message Queue, 消息队列（MQ）是一种应用程序对应用程序的通信方法。RabbitMQ是一个在AMQP基础上完整的，可复用的企业消息系统。他遵循Mozilla Public License开源协议。AMQP(高级消息队列协议) 是一个异步消息传递所使用的应用层协议规范，作为线路层协议，而不是API（例如JMS），AMQP 客户端能够无视消息的来源任意发送和接受信息。AMQP的原始用途只是为金融界提供一个可以彼此协作的消息协议，而现在的目标则是为通用消息队列架构提供通用构建工具。因此，面向消息的中间件 （MOM）系统，例如发布/订阅队列，没有作为基本元素实现。AMQP当中有四个概念非常重要（一个虚拟主机持有一组交换机、队列和绑定）：</p><ol><li><code>virtual host</code>，虚拟主机</li><li><code>exchange</code>，交换机</li><li><code>queue</code>，队列</li><li><code>binding</code>，绑定</li></ol><h2 id=消息传递过程>消息传递过程<a hidden class=anchor aria-hidden=true href=#消息传递过程>#</a></h2><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/LesanOuO/images@master/img/rabbitmq1.jpg></p><p>上图为RabbitMQ中一些重要名词的概述，其中包括Connection、Channel、Exchange、Queue、Bind、Routing Key</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/LesanOuO/images@master/img/rabbitmq2.jpg></p><p>上图为消息从生产到消费的整个流程，其中Exchange，与Queue都是可以设置相关属性，队列的持久化，交换器类型制定</p><p>这个过程走分三个部分，1、客户端（生产消息队列），2、RabbitMQ服务端（负责路由规则的绑定与消息的分发），3、客户端（消费消息队列中的消息）</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/LesanOuO/images@master/img/rabbitmq3.jpg></p><p>由图可以看出，一个消息可以走一次网络却被分发到不同的消息队列中，然后被多个的客户端消费，那么这个过程就是RabbitMQ的核心机制，RabbitMQ的路由类型与消费模式</p><h2 id=rabbitmq中exchange的类型>RabbitMQ中Exchange的类型<a hidden class=anchor aria-hidden=true href=#rabbitmq中exchange的类型>#</a></h2><p>类型有4种，direct，fanout，topic，headers。其中headers不常用，本篇不做介绍，其他三种类型，会做详细介绍。</p><p>那么这些类型是什么意思呢？就是Exchange与队列进行绑定后，消息根据exchang的类型，按照不同的绑定规则分发消息到消息队列中，可以是一个消息被分发给多个消息队列，也可以是一个消息分发到一个消息队列。具体请看下文。</p><p>介绍之初还要说下RoutingKey，这是个什么玩意呢？他是exchange与消息队列绑定中的一个标识。有些路由类型会按照标识对应消息队列，有些路由类型忽略routingkey。具体看下文。</p><h3 id=exchange类型direct>Exchange类型direct<a hidden class=anchor aria-hidden=true href=#exchange类型direct>#</a></h3><p>根据交换器名称与routingkey来找队列的</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/LesanOuO/images@master/img/20220217105315.png></p><p>Note:消息从client发出，传送给交换器ChangeA，RoutingKey为routingkey.ZLH,那么不管你发送给Queue1，还是Queue2一个消息都会保存在Queue1，Queue2，Queue3，三个队列中。这就是交换器的direct类型的路由规则。只要找到路由器与routingkey绑定的队列，那么他有多少队列，他就分发给多少队列。</p><h3 id=exchange类型fanout>Exchange类型fanout<a hidden class=anchor aria-hidden=true href=#exchange类型fanout>#</a></h3><p>这个类型忽略Routingkey，他为广播模式</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/LesanOuO/images@master/img/20220217105352.png></p><p>Note:消息从客户端发出，只要queue与exchange有绑定，那么他不管你的Routingkey是什么他都会将消息分发给所有与该exchang绑定的队列中。</p><h3 id=exchange类型topic>Exchange类型topic<a hidden class=anchor aria-hidden=true href=#exchange类型topic>#</a></h3><p>这个类型的路由规则如果你掌握啦，那是相当的好用，与灵活。他是根据RoutingKey的设置，来做匹配的，其中这里还有两个通配符为：</p><p>*，代表任意的一个词。例如topic.zlh.*，他能够匹配到，topic.zlh.one ,topic.zlh.two ,topic.zlh.abc, &mldr;.</p><p>#，代表任意多个词。例如topic.#，他能够匹配到，topic.zlh.one ,topic.zlh.two ,topic.zlh.abc, &mldr;.</p><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/LesanOuO/images@master/img/20220217105423.png></p><p>Note：这个图看上去很乱，但是他是根据匹配符做匹配的，这里我建议你自己做下消息队列的具体操作。</p><h2 id=消息队列的消费与消息确认>消息队列的消费与消息确认<a hidden class=anchor aria-hidden=true href=#消息队列的消费与消息确认>#</a></h2><h3 id=消息队列的消费>消息队列的消费<a hidden class=anchor aria-hidden=true href=#消息队列的消费>#</a></h3><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/LesanOuO/images@master/img/20220217110443.png></p><p>Note:如果一个消息队列中有大量消息等待操作时，我们可以用多个客户端来处理消息，这里的分发机制是采用负载均衡算法中的轮询。第一个消息给A，下一个消息给B，下下一个消息给A，下下下一个消息给B&mldr;&mldr;以此类推</p><h3 id=消息确认>消息确认<a hidden class=anchor aria-hidden=true href=#消息确认>#</a></h3><p>保证消息的安全性，保证此消息被正确处理后才能在服务端的消息队列中删除。那么rabbitmq提供啦ack应答机制，来实现这一功能。</p><p>ack应答有两种方式：1、自动应答，2、手动应答</p><h2 id=使用例子>使用例子<a hidden class=anchor aria-hidden=true href=#使用例子>#</a></h2><h3 id=生产者>生产者<a hidden class=anchor aria-hidden=true href=#生产者>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=k>using</span> <span class=nn>RabbitMQ.Client</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.Text</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>namespace</span> <span class=nn>RabbitMQProduct</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>internal</span> <span class=k>class</span> <span class=nc>Program</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>static</span> <span class=k>void</span> <span class=n>Main</span><span class=p>(</span><span class=kt>string</span><span class=p>[]</span> <span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;Welcome to RabbitMQ Product!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>DirectExchangeSendMsg</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=c1>// TopicExchangeSendMsg();</span>
</span></span><span class=line><span class=cl>            <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;按任意值，退出程序&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>Console</span><span class=p>.</span><span class=n>ReadKey</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cs>/// &lt;summary&gt;</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// 连接配置</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// &lt;/summary&gt;</span>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kd>static</span> <span class=k>readonly</span> <span class=n>ConnectionFactory</span> <span class=n>rabbitMqFactory</span> <span class=p>=</span> <span class=k>new</span> <span class=n>ConnectionFactory</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>UserName</span> <span class=p>=</span> <span class=s>&#34;guest&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Password</span> <span class=p>=</span> <span class=s>&#34;guest&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Port</span> <span class=p>=</span> <span class=m>5672</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=c1>//VirtualHost = &#34;LesanVirtualHost&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// &lt;summary&gt;</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// 路由名称</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// &lt;/summary&gt;</span>
</span></span><span class=line><span class=cl>        <span class=kd>const</span> <span class=kt>string</span> <span class=n>ExchangeName</span> <span class=p>=</span> <span class=s>&#34;Lesan.exchange&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>//队列名称</span>
</span></span><span class=line><span class=cl>        <span class=kd>const</span> <span class=kt>string</span> <span class=n>QueueName</span> <span class=p>=</span> <span class=s>&#34;Lesan.queue&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cs>/// &lt;summary&gt;</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// 路由名称</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// &lt;/summary&gt;</span>
</span></span><span class=line><span class=cl>        <span class=kd>const</span> <span class=kt>string</span> <span class=n>TopExchangeName</span> <span class=p>=</span> <span class=s>&#34;topic.Lesan.exchange&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>//队列名称</span>
</span></span><span class=line><span class=cl>        <span class=kd>const</span> <span class=kt>string</span> <span class=n>TopQueueName</span> <span class=p>=</span> <span class=s>&#34;topic.Lesan.queue&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cs>/// &lt;summary&gt;</span>
</span></span><span class=line><span class=cl>        <span class=cs>///  单点精确路由模式</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// &lt;/summary&gt;</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kd>static</span> <span class=k>void</span> <span class=n>DirectExchangeSendMsg</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>using</span> <span class=p>(</span><span class=n>IConnection</span> <span class=n>conn</span> <span class=p>=</span> <span class=n>rabbitMqFactory</span><span class=p>.</span><span class=n>CreateConnection</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>using</span> <span class=p>(</span><span class=n>IModel</span> <span class=n>channel</span> <span class=p>=</span> <span class=n>conn</span><span class=p>.</span><span class=n>CreateModel</span><span class=p>())</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>//设置交换器的类型</span>
</span></span><span class=line><span class=cl>                    <span class=n>channel</span><span class=p>.</span><span class=n>ExchangeDeclare</span><span class=p>(</span><span class=n>ExchangeName</span><span class=p>,</span> <span class=n>ExchangeType</span><span class=p>.</span><span class=n>Direct</span><span class=p>,</span> <span class=n>durable</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span> <span class=n>autoDelete</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=c1>//声明一个队列，设置队列是否持久化，排他性，与自动删除</span>
</span></span><span class=line><span class=cl>                    <span class=n>channel</span><span class=p>.</span><span class=n>QueueDeclare</span><span class=p>(</span><span class=n>QueueName</span><span class=p>,</span> <span class=n>durable</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span> <span class=n>autoDelete</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span> <span class=n>exclusive</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=c1>//绑定消息队列，交换器，routingkey</span>
</span></span><span class=line><span class=cl>                    <span class=n>channel</span><span class=p>.</span><span class=n>QueueBind</span><span class=p>(</span><span class=n>QueueName</span><span class=p>,</span> <span class=n>ExchangeName</span><span class=p>,</span> <span class=n>routingKey</span><span class=p>:</span> <span class=n>QueueName</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=kt>var</span> <span class=n>props</span> <span class=p>=</span> <span class=n>channel</span><span class=p>.</span><span class=n>CreateBasicProperties</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                    <span class=c1>//队列持久化</span>
</span></span><span class=line><span class=cl>                    <span class=n>props</span><span class=p>.</span><span class=n>Persistent</span> <span class=p>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=kt>string</span> <span class=n>vadata</span> <span class=p>=</span> <span class=n>Console</span><span class=p>.</span><span class=n>ReadLine</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                    <span class=k>while</span> <span class=p>(</span><span class=n>vadata</span> <span class=p>!=</span> <span class=s>&#34;exit&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=kt>var</span> <span class=n>msgBody</span> <span class=p>=</span> <span class=n>Encoding</span><span class=p>.</span><span class=n>UTF8</span><span class=p>.</span><span class=n>GetBytes</span><span class=p>(</span><span class=n>vadata</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                        <span class=c1>//发送信息</span>
</span></span><span class=line><span class=cl>                        <span class=n>channel</span><span class=p>.</span><span class=n>BasicPublish</span><span class=p>(</span><span class=n>exchange</span><span class=p>:</span> <span class=n>ExchangeName</span><span class=p>,</span> <span class=n>routingKey</span><span class=p>:</span> <span class=n>QueueName</span><span class=p>,</span> <span class=n>basicProperties</span><span class=p>:</span> <span class=n>props</span><span class=p>,</span> <span class=n>body</span><span class=p>:</span> <span class=n>msgBody</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                        <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=kt>string</span><span class=p>.</span><span class=n>Format</span><span class=p>(</span><span class=s>&#34;***发送时间:{0}，发送完成，输入exit退出消息发送&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=n>DateTime</span><span class=p>.</span><span class=n>Now</span><span class=p>.</span><span class=n>ToString</span><span class=p>(</span><span class=s>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>                        <span class=n>vadata</span> <span class=p>=</span> <span class=n>Console</span><span class=p>.</span><span class=n>ReadLine</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// &lt;summary&gt;</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// topic 模糊匹配模式，符号“#”匹配一个或多个词，符号“*”匹配不多不少一个词。因此“log.#”能够匹配到“log.info.oa”，但是“log.*” 只会匹配到“log.error”</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// &lt;/summary&gt;</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kd>static</span> <span class=k>void</span> <span class=n>TopicExchangeSendMsg</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>using</span> <span class=p>(</span><span class=n>IConnection</span> <span class=n>conn</span> <span class=p>=</span> <span class=n>rabbitMqFactory</span><span class=p>.</span><span class=n>CreateConnection</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>using</span> <span class=p>(</span><span class=n>IModel</span> <span class=n>channel</span> <span class=p>=</span> <span class=n>conn</span><span class=p>.</span><span class=n>CreateModel</span><span class=p>())</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>channel</span><span class=p>.</span><span class=n>ExchangeDeclare</span><span class=p>(</span><span class=n>TopExchangeName</span><span class=p>,</span> <span class=n>ExchangeType</span><span class=p>.</span><span class=n>Topic</span><span class=p>,</span> <span class=n>durable</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span> <span class=n>autoDelete</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>channel</span><span class=p>.</span><span class=n>QueueDeclare</span><span class=p>(</span><span class=n>TopQueueName</span><span class=p>,</span> <span class=n>durable</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span> <span class=n>autoDelete</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span> <span class=n>exclusive</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>channel</span><span class=p>.</span><span class=n>QueueBind</span><span class=p>(</span><span class=n>TopQueueName</span><span class=p>,</span> <span class=n>TopExchangeName</span><span class=p>,</span> <span class=n>routingKey</span><span class=p>:</span> <span class=n>TopQueueName</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=c1>//var props = channel.CreateBasicProperties();</span>
</span></span><span class=line><span class=cl>                    <span class=c1>//props.Persistent = true;</span>
</span></span><span class=line><span class=cl>                    <span class=kt>string</span> <span class=n>vadata</span> <span class=p>=</span> <span class=n>Console</span><span class=p>.</span><span class=n>ReadLine</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                    <span class=k>while</span> <span class=p>(</span><span class=n>vadata</span> <span class=p>!=</span> <span class=s>&#34;exit&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=kt>var</span> <span class=n>msgBody</span> <span class=p>=</span> <span class=n>Encoding</span><span class=p>.</span><span class=n>UTF8</span><span class=p>.</span><span class=n>GetBytes</span><span class=p>(</span><span class=n>vadata</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                        <span class=n>channel</span><span class=p>.</span><span class=n>BasicPublish</span><span class=p>(</span><span class=n>exchange</span><span class=p>:</span> <span class=n>TopExchangeName</span><span class=p>,</span> <span class=n>routingKey</span><span class=p>:</span> <span class=n>TopQueueName</span><span class=p>,</span> <span class=n>basicProperties</span><span class=p>:</span> <span class=kc>null</span><span class=p>,</span> <span class=n>body</span><span class=p>:</span> <span class=n>msgBody</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                        <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=kt>string</span><span class=p>.</span><span class=n>Format</span><span class=p>(</span><span class=s>&#34;***发送时间:{0}，发送完成，输入exit退出消息发送&#34;</span><span class=p>,</span> <span class=n>DateTime</span><span class=p>.</span><span class=n>Now</span><span class=p>.</span><span class=n>ToString</span><span class=p>(</span><span class=s>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>                        <span class=n>vadata</span> <span class=p>=</span> <span class=n>Console</span><span class=p>.</span><span class=n>ReadLine</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=消费者>消费者<a hidden class=anchor aria-hidden=true href=#消费者>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=k>using</span> <span class=nn>RabbitMQ.Client</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>RabbitMQ.Client.Events</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.Text</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>namespace</span> <span class=nn>RabbitMQConsumer</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>internal</span> <span class=k>class</span> <span class=nc>Program</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>static</span> <span class=k>void</span> <span class=n>Main</span><span class=p>(</span><span class=kt>string</span><span class=p>[]</span> <span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;Welcome to RabbitMQ Consumer!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>//DirectAcceptExchange();</span>
</span></span><span class=line><span class=cl>            <span class=c1>//DirectAcceptExchangeEvent();</span>
</span></span><span class=line><span class=cl>            <span class=n>DirectAcceptExchangeTask</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=c1>//TopicAcceptExchange();</span>
</span></span><span class=line><span class=cl>            <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;按任意值，退出程序&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>Console</span><span class=p>.</span><span class=n>ReadKey</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cs>/// &lt;summary&gt;</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// 连接配置</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// &lt;/summary&gt;</span>
</span></span><span class=line><span class=cl>        <span class=kd>private</span> <span class=kd>static</span> <span class=k>readonly</span> <span class=n>ConnectionFactory</span> <span class=n>rabbitMqFactory</span> <span class=p>=</span> <span class=k>new</span> <span class=n>ConnectionFactory</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>UserName</span> <span class=p>=</span> <span class=s>&#34;guest&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Password</span> <span class=p>=</span> <span class=s>&#34;guest&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Port</span> <span class=p>=</span> <span class=m>5672</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=c1>//VirtualHost = &#34;LesanVirtualHost&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// &lt;summary&gt;</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// 路由名称</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// &lt;/summary&gt;</span>
</span></span><span class=line><span class=cl>        <span class=kd>const</span> <span class=kt>string</span> <span class=n>ExchangeName</span> <span class=p>=</span> <span class=s>&#34;Lesan.exchange&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>//队列名称</span>
</span></span><span class=line><span class=cl>        <span class=kd>const</span> <span class=kt>string</span> <span class=n>QueueName</span> <span class=p>=</span> <span class=s>&#34;Lesan.queue&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cs>/// &lt;summary&gt;</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// 路由名称</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// &lt;/summary&gt;</span>
</span></span><span class=line><span class=cl>        <span class=kd>const</span> <span class=kt>string</span> <span class=n>TopExchangeName</span> <span class=p>=</span> <span class=s>&#34;topic.Lesan.exchange&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>//队列名称</span>
</span></span><span class=line><span class=cl>        <span class=kd>const</span> <span class=kt>string</span> <span class=n>TopQueueName</span> <span class=p>=</span> <span class=s>&#34;topic.Lesan.queue&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cs>/// &lt;summary&gt;</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// 基于时间轮询的，每隔一段时间获取一次</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// &lt;/summary&gt;</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kd>static</span> <span class=k>void</span> <span class=n>DirectAcceptExchange</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>using</span> <span class=p>(</span><span class=n>IConnection</span> <span class=n>conn</span> <span class=p>=</span> <span class=n>rabbitMqFactory</span><span class=p>.</span><span class=n>CreateConnection</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>using</span> <span class=p>(</span><span class=n>IModel</span> <span class=n>channel</span> <span class=p>=</span> <span class=n>conn</span><span class=p>.</span><span class=n>CreateModel</span><span class=p>())</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>//设置交换器的类型</span>
</span></span><span class=line><span class=cl>                    <span class=n>channel</span><span class=p>.</span><span class=n>ExchangeDeclare</span><span class=p>(</span><span class=n>ExchangeName</span><span class=p>,</span> <span class=n>ExchangeType</span><span class=p>.</span><span class=n>Direct</span><span class=p>,</span> <span class=n>durable</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span> <span class=n>autoDelete</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=c1>//声明一个队列，设置队列是否持久化，排他性，与自动删除</span>
</span></span><span class=line><span class=cl>                    <span class=n>channel</span><span class=p>.</span><span class=n>QueueDeclare</span><span class=p>(</span><span class=n>QueueName</span><span class=p>,</span> <span class=n>durable</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span> <span class=n>autoDelete</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span> <span class=n>exclusive</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=c1>//绑定消息队列，交换器，routingkey</span>
</span></span><span class=line><span class=cl>                    <span class=n>channel</span><span class=p>.</span><span class=n>QueueBind</span><span class=p>(</span><span class=n>QueueName</span><span class=p>,</span> <span class=n>ExchangeName</span><span class=p>,</span> <span class=n>routingKey</span><span class=p>:</span> <span class=n>QueueName</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>while</span> <span class=p>(</span><span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>BasicGetResult</span> <span class=n>msgResponse</span> <span class=p>=</span> <span class=n>channel</span><span class=p>.</span><span class=n>BasicGet</span><span class=p>(</span><span class=n>QueueName</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=p>(</span><span class=n>msgResponse</span> <span class=p>!=</span> <span class=kc>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=kt>var</span> <span class=n>msgBody</span> <span class=p>=</span> <span class=n>Encoding</span><span class=p>.</span><span class=n>UTF8</span><span class=p>.</span><span class=n>GetString</span><span class=p>(</span><span class=n>msgResponse</span><span class=p>.</span><span class=n>Body</span><span class=p>.</span><span class=n>ToArray</span><span class=p>());</span>
</span></span><span class=line><span class=cl>                            <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=kt>string</span><span class=p>.</span><span class=n>Format</span><span class=p>(</span><span class=s>&#34;***接收时间:{0}，消息内容：{1}&#34;</span><span class=p>,</span> <span class=n>DateTime</span><span class=p>.</span><span class=n>Now</span><span class=p>.</span><span class=n>ToString</span><span class=p>(</span><span class=s>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span class=p>),</span> <span class=n>msgBody</span><span class=p>));</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                        <span class=n>System</span><span class=p>.</span><span class=n>Threading</span><span class=p>.</span><span class=n>Thread</span><span class=p>.</span><span class=n>Sleep</span><span class=p>(</span><span class=n>TimeSpan</span><span class=p>.</span><span class=n>FromSeconds</span><span class=p>(</span><span class=m>1</span><span class=p>));</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// &lt;summary&gt;</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// 基于事件的，当消息到达时触发事件，获取数据</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// &lt;/summary&gt;</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kd>static</span> <span class=k>void</span> <span class=n>DirectAcceptExchangeEvent</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>using</span> <span class=p>(</span><span class=n>IConnection</span> <span class=n>conn</span> <span class=p>=</span> <span class=n>rabbitMqFactory</span><span class=p>.</span><span class=n>CreateConnection</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>using</span> <span class=p>(</span><span class=n>IModel</span> <span class=n>channel</span> <span class=p>=</span> <span class=n>conn</span><span class=p>.</span><span class=n>CreateModel</span><span class=p>())</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>//channel.ExchangeDeclare(ExchangeName, &#34;direct&#34;, durable: true, autoDelete: false, arguments: null);</span>
</span></span><span class=line><span class=cl>                    <span class=n>channel</span><span class=p>.</span><span class=n>QueueDeclare</span><span class=p>(</span><span class=n>QueueName</span><span class=p>,</span> <span class=n>durable</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span> <span class=n>autoDelete</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span> <span class=n>exclusive</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=c1>//channel.QueueBind(QueueName, ExchangeName, routingKey: QueueName);</span>
</span></span><span class=line><span class=cl>                    <span class=kt>var</span> <span class=n>consumer</span> <span class=p>=</span> <span class=k>new</span> <span class=n>EventingBasicConsumer</span><span class=p>(</span><span class=n>channel</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>consumer</span><span class=p>.</span><span class=n>Received</span> <span class=p>+=</span> <span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>ea</span><span class=p>)</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=kt>var</span> <span class=n>msgBody</span> <span class=p>=</span> <span class=n>Encoding</span><span class=p>.</span><span class=n>UTF8</span><span class=p>.</span><span class=n>GetString</span><span class=p>(</span><span class=n>ea</span><span class=p>.</span><span class=n>Body</span><span class=p>.</span><span class=n>ToArray</span><span class=p>());</span>
</span></span><span class=line><span class=cl>                        <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=kt>string</span><span class=p>.</span><span class=n>Format</span><span class=p>(</span><span class=s>&#34;***接收时间:{0}，消息内容：{1}&#34;</span><span class=p>,</span> <span class=n>DateTime</span><span class=p>.</span><span class=n>Now</span><span class=p>.</span><span class=n>ToString</span><span class=p>(</span><span class=s>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span class=p>),</span> <span class=n>msgBody</span><span class=p>));</span>
</span></span><span class=line><span class=cl>                    <span class=p>};</span>
</span></span><span class=line><span class=cl>                    <span class=n>channel</span><span class=p>.</span><span class=n>BasicConsume</span><span class=p>(</span><span class=n>QueueName</span><span class=p>,</span> <span class=kc>true</span><span class=p>,</span> <span class=n>consumer</span><span class=p>:</span> <span class=n>consumer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;按任意值，退出程序&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>Console</span><span class=p>.</span><span class=n>ReadKey</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// &lt;summary&gt;</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// 基于事件的，当消息到达时触发事件，获取数据</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// &lt;/summary&gt;</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kd>static</span> <span class=k>void</span> <span class=n>DirectAcceptExchangeTask</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>using</span> <span class=p>(</span><span class=n>IConnection</span> <span class=n>conn</span> <span class=p>=</span> <span class=n>rabbitMqFactory</span><span class=p>.</span><span class=n>CreateConnection</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>using</span> <span class=p>(</span><span class=n>IModel</span> <span class=n>channel</span> <span class=p>=</span> <span class=n>conn</span><span class=p>.</span><span class=n>CreateModel</span><span class=p>())</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>//channel.ExchangeDeclare(ExchangeName, &#34;direct&#34;, durable: true, autoDelete: false, arguments: null);</span>
</span></span><span class=line><span class=cl>                    <span class=n>channel</span><span class=p>.</span><span class=n>QueueDeclare</span><span class=p>(</span><span class=n>QueueName</span><span class=p>,</span> <span class=n>durable</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span> <span class=n>autoDelete</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span> <span class=n>exclusive</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>channel</span><span class=p>.</span><span class=n>BasicQos</span><span class=p>(</span><span class=n>prefetchSize</span><span class=p>:</span> <span class=m>0</span><span class=p>,</span> <span class=n>prefetchCount</span><span class=p>:</span> <span class=m>1</span><span class=p>,</span> <span class=n>global</span><span class=p>:</span> <span class=kc>false</span><span class=p>);</span><span class=c1>//告诉broker同一时间只处理一个消息</span>
</span></span><span class=line><span class=cl>                    <span class=c1>//channel.QueueBind(QueueName, ExchangeName, routingKey: QueueName);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=c1>//定义这个队列的消费者</span>
</span></span><span class=line><span class=cl>                    <span class=kt>var</span> <span class=n>consumer</span> <span class=p>=</span> <span class=k>new</span> <span class=n>EventingBasicConsumer</span><span class=p>(</span><span class=n>channel</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>consumer</span><span class=p>.</span><span class=n>Received</span> <span class=p>+=</span> <span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>ea</span><span class=p>)</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=kt>var</span> <span class=n>msgBody</span> <span class=p>=</span> <span class=n>Encoding</span><span class=p>.</span><span class=n>UTF8</span><span class=p>.</span><span class=n>GetString</span><span class=p>(</span><span class=n>ea</span><span class=p>.</span><span class=n>Body</span><span class=p>.</span><span class=n>ToArray</span><span class=p>());</span>
</span></span><span class=line><span class=cl>                        <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=kt>string</span><span class=p>.</span><span class=n>Format</span><span class=p>(</span><span class=s>&#34;***接收时间:{0}，消息内容：{1}&#34;</span><span class=p>,</span> <span class=n>DateTime</span><span class=p>.</span><span class=n>Now</span><span class=p>.</span><span class=n>ToString</span><span class=p>(</span><span class=s>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span class=p>),</span> <span class=n>msgBody</span><span class=p>));</span>
</span></span><span class=line><span class=cl>                        <span class=kt>int</span> <span class=n>dots</span> <span class=p>=</span> <span class=n>msgBody</span><span class=p>.</span><span class=n>Split</span><span class=p>(</span><span class=sc>&#39;.&#39;</span><span class=p>).</span><span class=n>Length</span> <span class=p>-</span> <span class=m>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                        <span class=n>System</span><span class=p>.</span><span class=n>Threading</span><span class=p>.</span><span class=n>Thread</span><span class=p>.</span><span class=n>Sleep</span><span class=p>(</span><span class=n>dots</span> <span class=p>*</span> <span class=m>1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                        <span class=c1>//处理完成，告诉Broker可以服务端可以删除消息，分配新的消息过来</span>
</span></span><span class=line><span class=cl>                        <span class=n>channel</span><span class=p>.</span><span class=n>BasicAck</span><span class=p>(</span><span class=n>deliveryTag</span><span class=p>:</span> <span class=n>ea</span><span class=p>.</span><span class=n>DeliveryTag</span><span class=p>,</span> <span class=n>multiple</span><span class=p>:</span> <span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=p>};</span>
</span></span><span class=line><span class=cl>                    <span class=c1>//noAck设置false,告诉broker，发送消息之后，消息暂时不要删除，等消费者处理完成再说</span>
</span></span><span class=line><span class=cl>                    <span class=c1>//false为手动应答，true为自动应答</span>
</span></span><span class=line><span class=cl>                    <span class=n>channel</span><span class=p>.</span><span class=n>BasicConsume</span><span class=p>(</span><span class=n>QueueName</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=n>consumer</span><span class=p>:</span> <span class=n>consumer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;按任意值，退出程序&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>Console</span><span class=p>.</span><span class=n>ReadKey</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// &lt;summary&gt;</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// topic 模糊匹配模式，符号“#”匹配一个或多个词，符号“*”匹配不多不少一个词。因此“log.#”能够匹配到“log.info.oa”，但是“log.*” 只会匹配到“log.error”</span>
</span></span><span class=line><span class=cl>        <span class=cs>/// &lt;/summary&gt;</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kd>static</span> <span class=k>void</span> <span class=n>TopicAcceptExchange</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>using</span> <span class=p>(</span><span class=n>IConnection</span> <span class=n>conn</span> <span class=p>=</span> <span class=n>rabbitMqFactory</span><span class=p>.</span><span class=n>CreateConnection</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>using</span> <span class=p>(</span><span class=n>IModel</span> <span class=n>channel</span> <span class=p>=</span> <span class=n>conn</span><span class=p>.</span><span class=n>CreateModel</span><span class=p>())</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>channel</span><span class=p>.</span><span class=n>ExchangeDeclare</span><span class=p>(</span><span class=n>TopExchangeName</span><span class=p>,</span> <span class=n>ExchangeType</span><span class=p>.</span><span class=n>Topic</span><span class=p>,</span> <span class=n>durable</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span> <span class=n>autoDelete</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>channel</span><span class=p>.</span><span class=n>QueueDeclare</span><span class=p>(</span><span class=n>TopQueueName</span><span class=p>,</span> <span class=n>durable</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span> <span class=n>autoDelete</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span> <span class=n>exclusive</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>channel</span><span class=p>.</span><span class=n>BasicQos</span><span class=p>(</span><span class=n>prefetchSize</span><span class=p>:</span> <span class=m>0</span><span class=p>,</span> <span class=n>prefetchCount</span><span class=p>:</span> <span class=m>1</span><span class=p>,</span> <span class=n>global</span><span class=p>:</span> <span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>channel</span><span class=p>.</span><span class=n>QueueBind</span><span class=p>(</span><span class=n>TopQueueName</span><span class=p>,</span> <span class=n>TopExchangeName</span><span class=p>,</span> <span class=n>routingKey</span><span class=p>:</span> <span class=n>TopQueueName</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=kt>var</span> <span class=n>consumer</span> <span class=p>=</span> <span class=k>new</span> <span class=n>EventingBasicConsumer</span><span class=p>(</span><span class=n>channel</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>consumer</span><span class=p>.</span><span class=n>Received</span> <span class=p>+=</span> <span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>ea</span><span class=p>)</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=kt>var</span> <span class=n>msgBody</span> <span class=p>=</span> <span class=n>Encoding</span><span class=p>.</span><span class=n>UTF8</span><span class=p>.</span><span class=n>GetString</span><span class=p>(</span><span class=n>ea</span><span class=p>.</span><span class=n>Body</span><span class=p>.</span><span class=n>ToArray</span><span class=p>());</span>
</span></span><span class=line><span class=cl>                        <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=kt>string</span><span class=p>.</span><span class=n>Format</span><span class=p>(</span><span class=s>&#34;***接收时间:{0}，消息内容：{1}&#34;</span><span class=p>,</span> <span class=n>DateTime</span><span class=p>.</span><span class=n>Now</span><span class=p>.</span><span class=n>ToString</span><span class=p>(</span><span class=s>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span class=p>),</span> <span class=n>msgBody</span><span class=p>));</span>
</span></span><span class=line><span class=cl>                        <span class=kt>int</span> <span class=n>dots</span> <span class=p>=</span> <span class=n>msgBody</span><span class=p>.</span><span class=n>Split</span><span class=p>(</span><span class=sc>&#39;.&#39;</span><span class=p>).</span><span class=n>Length</span> <span class=p>-</span> <span class=m>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                        <span class=n>System</span><span class=p>.</span><span class=n>Threading</span><span class=p>.</span><span class=n>Thread</span><span class=p>.</span><span class=n>Sleep</span><span class=p>(</span><span class=n>dots</span> <span class=p>*</span> <span class=m>1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                        <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34; [x] Done&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                        <span class=n>channel</span><span class=p>.</span><span class=n>BasicAck</span><span class=p>(</span><span class=n>deliveryTag</span><span class=p>:</span> <span class=n>ea</span><span class=p>.</span><span class=n>DeliveryTag</span><span class=p>,</span> <span class=n>multiple</span><span class=p>:</span> <span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=p>};</span>
</span></span><span class=line><span class=cl>                    <span class=n>channel</span><span class=p>.</span><span class=n>BasicConsume</span><span class=p>(</span><span class=n>TopQueueName</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=n>consumer</span><span class=p>:</span> <span class=n>consumer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;按任意值，退出程序&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>Console</span><span class=p>.</span><span class=n>ReadKey</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=引用>引用<a hidden class=anchor aria-hidden=true href=#引用>#</a></h2><p>以上笔记摘录自网络</p><blockquote><p><a href=https://www.cnblogs.com/knowledgesea/p/5296008.html>https://www.cnblogs.com/knowledgesea/p/5296008.html</a>
<a href=https://www.cnblogs.com/personblog/p/10681741.html>https://www.cnblogs.com/personblog/p/10681741.html</a></p></blockquote></div><footer class=post-footer><ul class=post-tags><li><a href=https://lesanouo.github.io/blog/tags/rabbitmq/>RabbitMQ</a></li><li><a href=https://lesanouo.github.io/blog/tags/.net/>.NET</a></li></ul><nav class=paginav><a class=prev href=https://lesanouo.github.io/blog/posts/operation/%E5%9C%A8.net%E4%B8%AD%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E6%8E%A8%E9%80%81%E7%9A%84%E4%B8%89%E7%A7%8D%E6%96%B9%E5%BC%8F/><span class=title>«</span><br><span>在.NET中实现消息推送的三种方式</span>
</a><a class=next href=https://lesanouo.github.io/blog/posts/snippet/linux/><span class=title>»</span><br><span>Linux 代码片段</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://lesanouo.github.io/blog/>Lesan's Blog</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>